.----------------------------------------------------------------------
. Program       : PATWEB80
.
. Function      : XML Remote Scripting Code Validation Service
.
. Modifications : 
.------------------------------------------------------------------------------
.V12.00.09  05/09/2025  J.Tan          TSK 0963745
.           Mod SELHFT00 to return DTHFUCMX (Make CP)
.V12.00.08  05/08/2025  Zumin Yu       TSK 0964772
.           Mod VDAT9200 to fix error message
.V12.00.07  24/07/2025  J.Tan          TSK 0962500
.           Mod GTNBK000 to check for U/R number
.V12.00.06  08/07/2025  J.Tan          TSK 0963128
.           Fixed Private Practice outstanding amount to include Credit notes
.V12.00.05  03/06/2025  Ebon Clements  TSK 0955096
.           Set PVIBILL to ZEROVISN - VALVIS05
.V12.00.04  20/05/2025  Bella Turco    TSK 0925576
.           Fixed remote script displaying incorrect Future Action Type GETFA000
.V12.00.03  20.05.2025  DA Sarkies     TSK 0937594
.           Extended number of indicators returned for single Cat Code
.V12.00.02  19.05.2025  Jeni Tan       TSK 0955096
.           Updated file for Alpha-Numeric Visit Numbers
.V12.00.01  15/05/2025  Bella Turco    TSK 0925576
.           Fixed remote script displaying incorrect Future Action Type GETFA000
.           13/05/2025  Ebon Clements  TSK 0955096
.           Added alpanumeric visit number validation - VLDADM00
.V11.05.10  20.05.2025  DA Sarkies     TSK 0937594
.           Extended number of indicators returned for single Cat Code
.V11.05.09  15/05/2025  Bella Turco    TSK 0925576
.           Fixed remote script displaying incorrect Future Action Type GETFA00
.V11.05.08  01/05/2025  PJ Le Febour   TSK 0952536a
.           VALITM40 - replace TDESC with PTCDLDES(long description) 
.V11.05.07  15/04/2025  Bella Turco    TSK 0925576
.           Fixed remote script displaying incorrect Future Action Type GETFA00
.V11.05.06  04/04/2025  Ebon Clements  TSK 0955910
.           Added selection list long description option to SELCOD00 - SHOWLDSC
.V11.05.05  02/04/2025  Davin          TSK 0956210
.           Added DPT0DVX3 to VALDIA00 for ICD10 Ed.13 Diagnosis Code validation
.V11.05.04  21/03/2025  PJ Le Febour   TSK 0952536
.           VALITM40 - added PTITDESC TDESC    
.V11.05.03  13/03/2025  Ebon Clements  TSK 0958318
.           Fixed nurse code validation when the nurse code is longer than
.           six character - VALNUR00
.V11.05.02  06/02/2025  Ebon Clements  TSK 0956930
.           Recompiled for WEBGROUP - Clear grouper vars
.V11.05.01  03/02/2025  Bella Turco    TSK 0925576
.           Added new routine GETFA000 when validating invoice                  
.V11.04.15  20.05.2025  DA Sarkies     TSK 0937594
.           Extended number of indicators returned for single Cat Code
.V11.04.14  21/03/2025  PJ Le Febours  TSK 0952536a
.           VALITM40 - replace TDESC with PTCDLDES(long description)
.V11.04.13  21/03/2025  PJ Le Febours  TSK 0952536
.           VALITM40 - added PTITDESC  TDESC
.V11.04.12  13/03/2025  Ebon Clements  TSK 0958318
.           Fixed nurse code validation when the nurse code is longer than
.           six character - VALNUR00
.V11.04.11  06/02/2025  Ebon Clements  TSK 0956930
.           Recompiled for WEBGROUP - Clear grouper vars
.V11.04.10  25/09/2024  J.Tan          TSK 0942917
.           Added VALDTYP=5 for VALITM00 -Use Adm.Claim instead of Default Claim
.V11.04.09  05/09/2024  Bella Turco    TSK 0911922
.           Added PMPXPFSN (Preferred Surname) to Validate Patient UR VALPUR60
.V11.04.08  26/08/2024  Bella Turco    TSK 0911922
.           Added PMPXPFGN (Preferred Given Name) to Validate Patient UR
.           VALPUR60
.V11.04.07  10/07/2024  Ebon Clemenmts TSK 0948870
.           Fixed allied health service type department test - SELDPT00
.V11.04.06  09/04/2024  Thanh T        TSK 0940239
.           Change VALVAD00 for matching discharge destination type
.V11.04.05  25.03.2024   DA Sarkies     TSK 0943044
.           Moved code around to make sure that correct recurring admission
.           displayed
.V11.04.04  13/03/2024   J.Tan          TSK 0919335
.           Mod to check for HF history - to set TSRVDATE
.V11.04.03  05/03/2024  Thanh T        TSK 0923560
.           Changed VALNZM11 for hospital ID changes
.V11.04.02  29/01/2024   Jacob Jackson  TSK 0919335
.           Add new local variable and recompile for GETTFEES
.V11.04.01  22/11/2023   J.Tan          TSK  0939335
.           Added VALDTYP=3 validating Misc.item with Date (VALMSC00)
.V11.03.05  25.03.2024   DA Sarkies     TSK  0943044
.           Moved code around to make sure that correct recurring admission
.           displayed
.V11.03.04  22/11/2023   J.Tan          TSK  0939335
.           Added VALDTYP=3 validating Misc.item with Date (VALMSC00)
.V11.03.03  13/11/2023   J.Tan          TSK  0939447 
.           Commented out entering items one day after discharged date
.V11.03.02  26.09.2023   Bella Turco    TSK  0937980 
.           Added missing MATCH "1",PMHCHOSS in VALHCP00                   
.V11.03.01  20.03.2023   DA Sarkies     TSK  0909393 
.           Increased size of case keys
.V11.02.10  04/11/2022   J.Tan          TSK  0921085 
.           Added VALDTYPE=4 to VALNZM00 - adding item to Favourite items group
.V11.02.09  14.09.2022   DA Sarkies     TSK  0909756 
.           Changed KEY65 to KEY90 for the misc item code validation section
.V11.02.08  28/07/2022   Thanh T        TSK  0922488 
.           Changed VALPUR60 to fix the issue with Change patient not 
.           bringing back visit details for non recurring patient             
.V11.02.07  01/07/2022   Thanh T        TSK 0893159
.           Fixed issue with most recent matching correct not working
.V11.02.06  15/06/2022   Thanh T        TSK 0893159
.           Added RECATR00 to get the visit for recurring care 
.V11.02.05  25/5/2022   Thanh T        TSK 0893159
.           Added GETVIF00 to get the first visit for recurring care  
.V11.02.04  13/05/2022  J.Tan          Task 0904080
.           Mod VALITM9A to display the invalid Item code
.V11.02.03  04/05/2022  Jill Parkinson Task 0912792
.           Added check for alternate visit id search in VALVIS00
.V11.02.02  31/03/2022  Davin          TSK 0917793
.           Added DPT0DVX2 to VALDIA00 for ICD10 Ed.12 Diagnosis Code validation
.V11.02.01  15/03/2022  J.Tan           TSK 0902652
.           Mod VDAT0000 to set claim,health fund for patient event (CEVN0000)
.V11.01.02  16.11.2021  DA Sarkies     Task 0898168
.           Added extra variable to VALPUR60 to return unformated gender
.V11.01.01  27.10.2021  Peter Vela     Task 0902857
.           Added WebServices functionality for VALPAR00 VALPCP00
.V11.00.10  18/01/2021  J.Tan          Task 0897802
.           Added checking VALDFUND,VALDCEFF (Eff.date) to VALNZM00
.V11.00.09  25/11/2020  Jill Parkinson Task 0898168
.           Fixed gender length for reportno=8     
.V11.00.08  29/10/2020  Jill Parkinson Task 0898168
.           Increased length of FMTSEX from 8 to 20
.V11.00.07  05/10/2020  Tracey Nguyen  TSK 0871529
.           Added PTCDUDF3 to VALCOD00
.V11.00.06  02/09/2020  J.Tan          TSK 0838262
.           Mod VDAT3000 to set up CMCODE
.V11.00.05  15/05/2020  J.Tan          TSK 0890767
.           Fixed NZ Misc.items validation for Pack items (checking for Hosp.)
.V11.00.04  21/04/2020  J.Tan          TSK 0838262
.           Fixed error message for Inactive MBS item
.V11.00.03  24/03/2020  Ebon Clements  TSK
.           Populate OPCASEKY for attended OP visits - VALVIS00
.           16/03/2020  Peter Vela     TSK 0871644
.           Added multihospital validation in VALNZM00 when OPCNPTMC = 1
.V11.00.02  11/03/2020  Thanh T        TSK 0838262
.           Changed VALITM9A to show different error description 
.V11.00.01  24/02/2020  J.Tan          TSK 0838262
.           Added Effective from and to date to MBS Item file
.V10.15.04  03/01/2019  Peter Vela     TSK 0871644
.           Added item code to VALITM94
.V10.15.03  01/11/2019  Thanh T.       TSK 0879283
.           Added VALHC87A to return the duplicate HCP code with the same
.           provider number
.V10.15.02  15/10/2019  Peter Vela     TSK 0879217
.           Added default value checks in VALPRO00 for nz
.V10.15.01  08/10/2019  Peter Vela     TSK 0879217
.           Added nz message for Inactive/Invalid ESIS Code
.V10.14.05  28/08/2019  Ebon Clements  TSK 0814751
.           Added validate an outpatient clinic type - VALCTY00 - report 49
.V10.14.04  17/05/2019  Davin          TSK 0821139
.           Skip hospital check for ETS userid when validating doctor (VALDOC45)
.V10.14.03  28/03/2019  Don Nguyen     TSK 0869412
.           Added DPT0DVX1 to VALDIA00 for ICD10 Ed.11 Diagnosis Code validation
.V10.14.02  20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
.V10.14.01  19/02/2019  Davin             TSK 0866465
.           Added DPT0DVXC to VALDIA00 for ICD10v10 validation
.V10.13.07  29/01/2019  Ebon Clements     TSK 0862494
.           Added PTCNLPRA Don't default linked practice if multiple links 
.           exist to VALHCP83 - GHCPL000
.V10.13.06  18/01/2019  Don Nguyen     TSK 0863630
.           Modified VALICO00 (Validate ICD Procedure) to check for null
.           description (PT0ODSC2).
.V10.13.05  20/11/2018  Davin          TSK 0854372
.           Don't validate hcp on mlthcpaf if not multihospital (VALHCP00)
.V10.13.04  29/10/2018  Tracey Nguyen  TSK 0859743
.           Added VALDTYPE=4 in VALITM00 to validae MBS item code for Outpatient
.           visit
.V10.13.03  11/09/2018  Tracey Nguyen  TSK 0862471
.           Added check for alcaactv=2 (active - exclude from PRIMHD) in
.           VALCAS00 and SELCAS00
.V10.13.02  28/08/2018  Peter Vela       TSK 0859742
.           Added valdtype 5 in VLDINV00 for Eclipse STF
.V10.13.01  31/07/2018  J.Tan            TSK 0848506
.           Changed PP Doctor from DIM6 to DIM10
.V10.12.05  20/07/2018  J.Tan          TSK 0860609
.           Fixed validing NZ items
.V10.12.04  08/03/2018  Ebon Clements  TSK 0853861
.           Fixed merged U/R loop at VALVIS35
.V10.12.03  19/02/2018  Ebon Clements  TSK 0851366
.           Added RETURNID to return web user id from user name - VALSEC00
.V10.12.02  15/02/2018  Ken Bell       TSK 0851102
.           Modified validation of Inactive MBS code with correct error message
.V10.12.01  11/01/2018  Tracey Nguyen  TSK 0825792
.           Added VALHCP21 for Validate HCP Code option 20 - All Nurses 
.           for HCP Types 14/15 (Nurses/Nurses & Other)
.           Added all references to HCP Types 14/15
.V10.11.02  04/12/2017  Don Nguyen     TSK 0826935
.           Modified VALCAS00 to validate Case Team Member End Date against
.           Referral Date. Also checked Case Team active status (ALCAACTV).
.V10.11.01  22/11/2017  Ania P         TSK 0261630
.           Moved TFILNAME to CFNAMEDP in INIT0000
.V10.10.04  02/05/2017  Ebon Clements  TSK 0832472
.           Added using web user id for application authentication - VALSEC00
.V10.10.03  21/04/2017   J.Tan         TSK 0315207
.           Mod validating casemix code for Target LOS (VALCMC00)
.V10.10.02  21/03/2017   J.Tan         TSK 0315207
.           Mod validating casemix code (VALCMC00)
.V10.10.01  14/02/2017   J.Tan         TSK 0829089
.           Changed index on oprthiaf file
.V10.09.01  06/02/2017  Ebon Clements  TSK 0830491
.           Fixed hospital security test for bookings - VALVIS00 - CHKBOK00
.V10.08.06  19/10/2016  Ania P         CAR 0822868
.           Strip DOCNAM00 fields
.V10.08.05  23/08/2016  Peter McMullen  0823848
.           Add lower case login search to XMLRED00 
.V10.08.04  27/07/2016  J.Tan             CAR 0816861
.           Modified SELDCD00 - Checking for Hospital specific
.V10.08.03  07.07.2016  Davin             TSK 0315393
.           Added output of pmpxrper/pmpxrdat @ valpur00
.V10.08.02  20.06.2016  B.G.Ackland       TSK 0821135
.           Secuity fix for reads on WBSE7 index 
.V10.08.01  18/04/2016  Peter Vela        CAR 0294177
.           Changed read to prihdb to KEY27
.V10.07.04  18/02/2016  Don Nguyen        CAR 0324569
.           Modified SELCOD00 - Added other indicators to output
.V10.07.03  19/01/2016  Ebon Clements     TSK 0294154
.           Return OP casekeys for OP visit validation - VALVIS00
.V10.07.02  10/12/2015  Ebon Clements     TSK 0324058
.           Fixed recurring care admission time test - GETVIS15
.V10.07.01  11/11/2015  Don Nguyen        CAR 320393
.           Modified VALVAD00 - check FILTDTYP
.           Added FILTDTYP & DESTTYPE
.-----------------------------------------------------------------------------
.V10.06.02  14/08/2015  Peter Vela        CAR 316642
.           Added Assessor to VALHCP00
.V10.06.01  19/03/2015  Ebon Clements     CAR 268970
.           Change to use OUTCLIFD index 1 instead of index 2
.V10.05.06  06/02/2015  Don Nguyen        CAR 306757
.           Modified SELUNI00 and SELDCD00 to output other indicators and vars
.V10.05.05  23/12/2014  J.Tan             CAR 302629
.           Added VALDTYPE=4 to output Journal total to VLDINV00
.V10.05.04  19/12/2014  B.G.Ackland       CAR 310348
.           Recompiled for changes to IBAWEBCD
.V10.05.03  02/10/2014  Peter Vela        CAR 304212
.           Added to VALPUR00:
.           PFUNDH, Health Fund Description
.           PFUNDP, Health Fund Table Description
.           PFNDMM 
.V10.05.02  03/09/2014  J.Tan             CAR 304370
.           Fixed checking for invalid NZ Packed item
.V10.05.01  29/08/2014  J.Tan             CAR 298984
.           Changed VLDINV00 to return Patient Debt (patdetaf) fields
.V10.04.16  19/06/2014  Jill Parkinson    CAR 301814
.           Changed match DRSTAT=0 to DRSTAT=1 in VALDOC00 before GOTO VALDOC95
.V10.04.15  12/06/2014  Patrick Adair     CAR 301814
.           changed VALDOC00 to check for doctor status active outside
.V10.04.14  07/05/2014  J.Tan             CAR 300260
.           Mods checking previous record after finding NZ Inactive Item
.V10.04.13  02/05/2014  Ebon Clements     CAR 295504
.           Added return format 5 to VALHCP00 to return linked doctor code
.V10.04.12  22/04/2014  J.Tan             CAR 300260
.           Mods checking for Active/Inactive NZ Misc.items
.V10.04.11  08/04/2014  J.Tan             CAR 295681
.           Fixed VLDINV00 - Validating Private Practice invoice number
.V10.04.10  03/04/2014  Patrick Adair Car 297983
.           changed VALHCP00 to skip hospital check for show all active hcp
.V10.04.09  01/04/2014  J.Tan             CAR 299227
.           Fixed checking blank Effective todate for SX Misc.Items (GETNZM00)
.V10.04.08  27/03/2014  Ebon Clements     CAR 263127
.           Added active/inactive test to validate AXIS codes
.V10.04.07  20/04/2014  J.Tan             CAR 279251
.           Mods VALSEC00 to check VALDTYPE=1 for Generic User ID
.V10.04.06  17/03/2014   Peter McMullen   CAR 294083
.           Check user in websecaf using long name index wecseca7 
.V10.04.05  17/03/2014  Don Nguyen        CAR 298261
.           Added VALVIS81 for Zero U/R visit number validation
.V10.04.04  06/03/2014  J.Tan             CAR 295681
.           Added System to patdetaf file
.V10.04.03  04/03/2014  J.Tan             CAR 297922
.           Mods to PP Medical Practice selection
.V10.04.02  11/02/2014  Patrick Adair     CAR 273419
.           Modified VALICD00 and VALICOD00 to output PT0DDSC2/PT0ODSC2
.V10.04.01  31/01/2014  Peter Vela        CAR 292612/281167
.           Modified VALVIS80 and VALPUR60 to output EMVISITE
.V10.03.33  13/12/2013  J.Tan             CAR 294414
.           Mods GTNBK000 to check type of Register against visit type
.V10.03.32  02/10/2013  Patrick Adair     CAR 265798
.           Added ICDRDVER edition to VALDIA00 as it had not been done
.           as part of ICD Version 8 changes - picked up in testing by JP
.V10.03.31  17/09/2013  J.Tan             CAR 259879
.           Mods checking Effective date for Inactive SX Misc.Items (NZPMSC00)
.V10.03.30  16/09/2013  Peter Vela        CAR 290634
.           Added validation for PMHCSTTS (HCP Active/Inactive) in 
.           VALHCP02 if Admission Number is not present
.V10.03.29  10/09/2013  Patrick Adair     CAR 271085    
.           Only Display Active Case Team members in selection list - VALCHC00
.V10.03.28  03/09/2013  Patrick Adair     CAR 290789    
.           allow inactive doctors in VALDOC00 if required (VALDTYPE=99)      
.V10.03.27  26/06/2013  Peter McMullen    CAR 286727    
.           recompile for IBAWEBCD (allow "`" char  in passwords)       
.V10.03.26  18/06/2013  Ebon Clements     CAR 286907    
.           Fixed incorrect GOTO labels
.V10.03.25  12/06/2013  Peter McMullen    CAR 286727 
.           recompile for IBAWEBCD (allow $ sign in passwords)       
.V10.03.24  16/05/2013  J.Tan             CAR 276577
.           Mods GETINS00 - to have default if it found one code only
.V10.03.23  02/05/2013  Patrick Adair     CAR 281536
.           Modified clinic search to cater for Invalid Clinic Id.
.V10.03.22  26/02/2013  Peter McMullen CAR 271555
.           Redirect report 11 to new standard VFYUSR00 routine in IBAWEBCD
.V10.03.21  18/01/2013  Ebon Clements  CAR 262292
.           Added interpreter required to validate UR - VALPUR00
.V10.03.21  18/01/2013  Ebon Clements  CAR 262292
.           Added interpreter required to validate UR - VALPUR00
.V10.03.20  08/01/2013  J.Tan          CAR 237952
.           Added routine to validate Misc.item without checking Inactive & date
.V10.03.19  22/11/2012  Ebon Clements   CAR 274775
.           Added ignore hospital test to HCP validation - VALHCP00 - valdallh
.V10.03.18  21/11/2012  Don Nguyen      CAR 276754
.           Added IO trap around WRWBLUR1
.V10.03.17  05/09/2012  J.Tan           CAR 267784
.           Mods Checking for TCINDC19 Claim Code
.V10.03.16  17/08/2012  Jill Parkinson  CAR 271077
.           Added move of DOBAOUTN to DPVIBILL in VALVIS10 to fix next rdpmvx11
.V10.03.15  31/07/2012  J.Tan           CAR 269748
.           Mods to set CEFFDATE to RETURNDT for 'As At Eff.Date' Contract ID
.V10.03.14  15/06/2012  J.Tan           CAR 246555
.           Mods VLDPPI00 - to return Medical Practice Register of PP Invoice
.V10.03.13  22/05/2012  Peter McMullen    CAR 264222 
.           Pad out VALDCODE to prevent short comparisons
.V10.03.12  21/03/2012  Davin             CAR 250517
.           Validate Practice and Linked HCP if VALDDCTR populated (valhcg00)
.V10.03.11  16/03/2012  J.Tan             CAR 259879
.           Mods NZ Misc.charge checking for Active/Inactive flag/Eff.todate
.V10.03.10  07/03/2012  J.Tan             CAR 250477
.           Mods for Pack items
.V10.03.09  15/02/2012  Ebon Clements  CAR 255142 
.           Fixed - Added date/hospital validations for VALHCP00
.V10.03.08  14/02/2012  Jill Parkinson CAR 255142 
.           Added date/hospital validations for VALHCP00
.V10.03.07  12/02/2012  Jill Parkinson CAR 255142 
.           Added validations for PMHCHCST values 11,12 and 13 to VALHCP00
.V10.03.06  02/02/2012  J.Tan           CAR 246107
.           Mods checking for Inactive Cash drawers
.V10.03.05  03/01/2012  Mike Laming      CAR 252358
.           Added default MR Document Type to val.Hospital - GETHSP00 
.V10.03.04  07/12/2011  Ebon Clements    CAR 253924
.           Added recurring visit adm date/time to - GETVIS00 
.V10.03.03  15/11/2011  Ebon Clements    CAR 252358
.           Added default MR home location to validate hospital - GETHSP00
.V10.03.02  27.10.2011  J.Tan             CAR 235425
.           Mods to return SX item description to DIM65
.V10.03.01  09/11/2011 J.Tan           CAR 255042
.           Recompiled for GETTFEES-reset overnight HF type if daycase notfound
.V10.02.14  18/10/2011  Saroeun Soeur    CAR 253304
.           UREXIS00 - added patient name
.V10.02.13  06/10/2011  Mike Laming      CAR 240103
.           Rework HCP "Inactive" Date checks in VALHCP02 and VALDAT00
.V10.02.12  23/09/2011  Jill Parkinson CAR 248486  
.           Added use of PTCNUHSC in GETVIS00 and VALVIS00
.V10.02.11  09/09/2011  Jill Parkinson CAR 249155  
.           Mods to allow blank referring gp in CHKGP000
.V10.02.10  08.09.2011  Saroeun Soeur    CAR 243942
.            VALINS00 - validated inactive codes
.V10.02.09  02/09/2011  Mike Laming      CAR 240103
.           Added HCP "Inactive" Date checks in VALHCP00 (added VALDAT00)
.V10.02.08  29/08/2011  Jill Parkinson   CAR 248100
.           Mods to clear LASTVIST in MVIS0000 if no match found
.V10.02.07  25/08/2011  Mike Laming      CAR 241939
.           Added comment HCP VALDTYPE 14 = All Attending HCP
.V10.02.06  05/08/2011 Jill Parkinson    CAR 247834
.           Added output of WPRHAT
.V10.02.05  03/08/2011 Jill Parkinson    CAR 240712
.           Added VALPUR91 and VALPUR92 errors
.V10.02.04  18/05/2011  Peter Vela        CAR 239579
.           Added remote script for previous visit disaster code/id number
.V10.02.03  17/05/2011  Jill Parkinson    CAR 240712
.           Mods to getvis00 for recurring care
.V10.02.02  14/04/2011  Peter Vela        CAR 239537
.           Added tag for validating default expiry date for Mental Health legal
.           status
.V10.02.01  04/04/2011  Ebon Clements     CAR 239576
.           Fixed hard coded department test - VALSRD00
.V10.01.10  28/03/2011  J.Tan             CAR 240385
.           Fixed validating SX invoice number
.V10.01.09  16/03/2011  Peter Vela        CAR Billing Changes
.           Fixed goto @ VALMS190
.V10.01.08  01/03/2011  Davin             CAR 233033
.           Mods to VALCTR00 - added valdtype=1 (Returns effective to date)
.V10.01.07  03/02/2011  Mike Laming       CAR 233046
.           Remove PATMC1FD/IO and PATMC2FD/IO - old & new tables
.V10.01.06  12/01/2011  Peter Vela        CAR 233034
.           Add Remote Script for Contract ID
.           13/01/2011  J.Tan             CAR 233048
.           Mods PATTFEFD to use HF Table type
.           17/01/2011  J.Tan             CAR 233034
.           Mods PATBFEFD to use HF Table type
.V10.01.05  04/01/2011  Mike Laming       CAR 235635
.           Change "Last Access Date/Time" to "Last Login Date/Time" and removed
.           WEBSECaf update (now in WEBSEC01-WEBLOG00).
.V10.01.04  06/12/2010  Mike Laming   CAR 233046
.           Mods for "H/F Table Type" (PTMCHFTT) - replaces H/F Table MHFTAB 
.V10.01.03  23/11/2010  Mike Laming   CAR 233229
.           Added "Invoice Debt Ind." using "patdetaf" at VLDINV18 & INVDET00
.           removed all "patrasaf" stuff added for 233264
.V10.01.02  16/11/2010  Peter Vela    CAR 233257
.           Added patient portion to return from VALMSC00
.           18/11/2010  Davin             CAR 233700
.           Added branch on exit after XMLHED00 (valsrd00 & valsrf00)
.V10.01.01  15/11/2010  Mike Laming   CAR 233264     
.           Added PATRASFD/IO & test Invoice Status vs Debt Agency at VLDINV18
.V10.00.14  22/09/2010  J.Tan             CAR 222709
.           Added Medical practice selection for the U/R only
.V10.00.13  07/09/2010  Mike Laming       CAR 179365
.           Removed "Referring Doc & GP" from HCP Search selection of "Active
.           Attending" at PMSHKB10 (also removed in PATWEB99 at PMSHKB10)
.V10.00.12  17/08/2010  J.Tan         CAR 227348
.           Allows entering Items for deceased patient one day after discharged
.V10.00.11  13/08/2010  Ebon Clements CAR 228159
.           Added estimated OP time to validate procedure - VALPRO00
.V10.00.10  08/08/2010  Davin         CAR 221046
.           Added output of ptmckreb at VALMSC20                                
.V10.00.09  03/08/2010 Mike Laming    CAR 226826
.           Added ICD Date field to VALICD00                                    
.V10.00.08  27/07/2010 J.Tan          CAR 226462
.           Fixed searching for daycase per-diem theatre fee (default overnight)
.V10.00.07  19/07/2010 Sandra Barcham CAR 226513
.           Fix VALDIA to allow for icd7 disease code            
.V10.00.06  14/07/2010  J.Tan         CAR 226232
.           Fixed validating invoice for multi database hospital
.V10.00.05  02/07/2010  Ebon Clements CAR 225307
.           Fixed infinite loop in VALCLC55 encounter claim code 
.V10.00.04  16/06/2010  Saroeun Soeur CAR 186516
.           VALCAS00 and VALCHC00 - case team list and hcp list 
.V10.00.03  17/05/2010  Ebon Clements CAR 220289
.           Changed VALCLC00 to check encounter if referral has no claim code
.V10.00.02  30/04/2010  J.Tan     CAR 220887
.           Mods checking for Active/Inactive of Misc.charge
.V10.00.01  18/03/2010  J.Tan             CAR 206240
.           Mods to set Emergency health fund for Misc.item validation
.           Mods to val.item for emergency to set disc.date only if emrstat=3
. V9.12.23  12/03/2010  Ebon Clements     CAR 215805
.           Fixed population of visit type LASTVTYP in VALVIS00
. V9.12.22  18/02/2010  J.Tan             CAR 215866
.           Mods SX invoice validation - only invoices raised by the login hosp.
. V9.12.21  10/02/2010  Steve Armstrong   CAR 216022
.           Removed validation for hospital is on invoice search (VLDINV00)
. V9.12.20  15/01/2010  J.Tan         CAR  213974
.           Added validating Emergency for takeup outstanding
. V9.12.19  13/01/2010  J.Tan         CAR  213538
.           Mods checking for Eclipse claim
.           13/01/2010  Jill Parkinson CAR 214072
.           Changed VALITM00 to return PTITDESC instead of IDESC
. V9.12.18  13/01/2010  Ebon Clements CAR 176111
.           Added ICD go live date test to validate operation - VALICO00
. V9.12.17  17/12/2009  Ebon Clements CAR 209363
.           Fixed GOTO in VALVIS00 so visit date gets populated
. V9.12.16  13/11/2009  J.Tan          CAR 210044
.           Mods to set Casepayment theatre fee to zero if fees is not setup
. V9.12.15  10/11/2009  Peter McMullen CAR 202694 
.            convert doctor name formatting to newer standard DOCNM000
. V9.12.14  10/11/2009  Saroeun Soeur CAR 208102
.            added VALDCL00 subroutine - clinic effective date
.            remote script
. V9.12.13  12/10/2009  J.Tan         CAR 188108
.           Recompiled for CHKCMXPT - I*C on patcmxaf file
. V9.12.12  06/10/2009  Saroeun Soeur CAR 180729
.           fixed XML return
. V9.12.11  21/09/2009  J.Tan         CAR 205303
.           Mods for Casemix Contract ID
. V9.12.10  18/09/2009  Saroeun Soeur CAR 206464 
.           fixed spelling mistake in VALSRD00,VALSRF00
. V9.12.09  17/09/2009  Saroeun Soeur CAR 180729
.           added VALSRD00 and VALSRF00 subroutine
. V9.12.08  21/08/2009  WeeLee Koo    CAR 186107
.           Change key for VALDCODE (VLDINV10)
. V9.12.07  13/08/2009  Peter Vela    CAR 203723
.           Added functionality for Eclipse Participant in patfx1af
. V9.12.06  07/08/2009  Saroeun Soeur CAR 201067
.           fixed linked HCP to only appear if active
. V9.12.05  16/07/2009  Jill Habasque CAR 145706
.           Added output of GPACCESS in VALPUR00
. V9.12.04  13/07/2009  Wee Lee Koo   CAR 186107
.           Added validation. Return Invoices only if Invoice Hospital ID = User
.           Current Hospital ID (VLDINV10) 
. V9.12.03  20/05/2009  Peter Vela    CAR 183976
.           Added Remote Script: VALMS100 Validate patmchgf file
. V9.12.02  19/05/2009  Jill Habasque CAR 195396
.           Copied UPDLSTUR from PATMASTM and added call on validate UR
. V9.12.01  07/05/2009  Saroeun Soeur CAR 172830
.           Added VALACL00 - list clinics based on active field
. V9.11.05  17/04/2009  Saroeun Soeur CAR 193834
.           Created new cgi parameter REFRLSRC and subroutine to validate
.           referral src with transfer src on indicator 7
. V9.11.04  18/03/2009  Peter Vela        CAR 183976
.           Added Validate Eclipse Participant/Capability remote script
. V9.11.03  03/03/2009  Ebon Clements     CAR 191013
.           Added Expected LOS to casemix code validation - VALCMC00
. V9.11.02  29/01/2009  Ebon Clements     CAR 181421
.           Added mental health HCP type of VALHCP00
. V9.11.01  23/12/2008  Peter Vela        CAR 183976
.           Added remote script option 84 Eclipse Participants
. V9.10.02  26/08/2008  Mike Laming       CAR 174809
.           Changed ICD10 editing at VALDIA00 to check for valid Code
. V9.10.01  16/05/2008  J.Tan             CAR 168168
.           Fixed setting up Effective date for SX Misc.item
. V9.09.21  11/03/2008  Ebon Clements     CAR 160921
.           Added ICD10 Ed1 to Ed5 test to VALDIA00
. V9.09.20  07/03/2008  J.Tan             CAR 156964
.           Added Axis III validation 
. V9.09.19  20/02/2008  Peter Vela        CAR 162070
.           Check for ~ and change it to an & in VLDARD00
. V9.09.18  05/02/2008  Jill Habasque     CAR 160618
.           Added setting of admissno in VALVIS00
. V9.09.17  18/01/2008  Mike Laming       CAR 150425
.           Add SELCSD00 for RCP Cashier Drawers list by Hospital Id.
. V9.09.16  15/01/2008  J.Tan             CAR 159320
.           Fixed validating casemix theatre fees
. V9.09.15  04/01/2008  Mike Laming       CAR 150425
.           Add SELREG00 for RCP Registers list by Hospital Id.
. V9.09.14  10/10/2007  J.Tan             CAR 152158
.           Mods to check for discharged DRG for casemix flag
. V9.09.13  09/10/2007  Ebon Clements     CAR 140426
.           Added allow keyin of inactive HCP option to VALHCP00
. V9.09.12  05/10/2007  J.Tan             CAR 149570
.           Mods validate MBS to return daycase suggested classification
. V9.09.11  04/10/2007  Ebon Clements     CAR 150315
.           Added prompt for joint registry infor to - VALTIC00
. V9.09.10  26/09/2007  Ebon Clements     CAR 150704
.           Added returnfm=3 to VALPUR00
. V9.09.09  11/09/2007  J.Tan             CAR 116723
.           Fixed validating NZ bed fees
. V9.09.08  05/09/2007  Peter Vela        CAR 148954
.           Recompiled for PMSREGFD
. V9.09.07  20/08/2007  Peter Vela        CAR 147342
.           Added emhiupt.emrhisaf validation to VALDCT00
. V9.09.06  19/07/2007  Jill Habasque     CAR 141569
.           Changed VALVIS00 to check for bookings
. V9.09.05  10/07/2007  Steve Armstrong   CAR 144789
.           Recompiled for changes to PATMC1IO.
. V9.09.04  27/06/2007  Jill Habasque CAR 143232
.           Added valdtype=3 in VALITM00
. V9.09.03  19/06/2007  Ebon Clements CAR 143161
.           Added related provider type validation to VALHCP00
. V9.09.02  15/06/2007  J.Tan        CAR 142173
.           Mods to allow emergency events to use EMR Deposit register
. V9.09.01  12/06/2007  Mike Laming  CAR 119158
.           Use Misc.Item date when reading Misc.Item at GETMSC00 
. V9.08.14  08/06/2007  Peter Vela   CAR 142173
.           Added remote script for SJOG ED Billing Date and Time
. V9.08.13  25/05/2007  Ebon Clement CAR 140601
.           Fixed NZ Private allow update of misc charge description - NZPMSC80
. V9.08.12  22/05/2007  Ebon Clement CAR 140114
.           Added returnfm test to SELCOD00
. V9.08.11  08/05/2007  Mike Laming  CAR 137125 HDP 2007 DRG 5.2
.           Mods to PATDGWFD - Add field PTDWDRGV (add to Keys)
. V9.08.10  18/04/2007  Mike Laming   CAR 137970
.           Changed to test for NZ in error messages at VALCMC80 & VALCMC90
. V9.08.09  05/03/07 Peter Vela CAR 135233
.           Added remote script for OPRAVE.OPAVAVER
.           Operation Duration Average
. V9.08.08  14/02/07 Davin    CAR 128957
.           Changed VALNZM00 to use selected claim code (valdclmt)
. V9.08.07  08/02/07 J.Tan    CAR 120001
.           Mods for NZ Billing
. V9.08.06  31/01/2007  Peter Vela    CAR 127930
.           Recompled for MRTCONFD
. V9.08.05  19/01/2007  Janet George  CAR 122595
.           Included a PP Flag to restrict multihospital checks 
.           19/01/2007  Jill Habasque             
.           Mods to use VALDUNIQ if available in NZPMSC00        
. V9.08.04  03/01/2007 Jill Habasque CAR 120009
.           Mods to read nzpmchaf if cfeetyp=5 (nzprivate)
. V9.08.03  04/12/2006 Peter Vela    CAR 126013
.           Recompiled for PMSREGFD PMSREGIO
.           Added functionality for regime code input
. V9.08.02  17/11/2006 J.Tan         CAR 120000
.           Mods for validating NZP misc.charge 
.           23/11/2006  Davin         CAR 123200
.           Removed check that was disallowing ICD9 codes in valicd00
. V9.08.01  19/10/2006 Ebon Clements CAR 121413
.           Added validate outpatient site password
. V9.07.04  20/09/2006 J.Tan         CAR 119336
.           Added claim code to Suggested classification file
. V9.07.03  07/09/2006  J.Tan         CAR 103367
.           Added validation for Regime code
. V9.07.02  21/08/2006  J.Tan         CAR 107626
.           Mods Checking for Doctor Misc.charge code 
. V9.07.01  04/07/2006  J.Tan         CAR 103365
.           Mods Validation misc.global to use new misc.file
. V9.06.02  17/05/2006  Ebon Clements CAR 105287
.           Fixed multi hospital test in VALCOD00 if only validating category
. V9.06.01  28/04/2006  Ebon Clements CAR 103143
.           Added read on master extension file at VALPUR50
. V9.05.04  06/04/2006  J.Tan         CAR 101054
.           Mods to check parameter for G/L interface
. V9.05.03  21/03/2006  Jill Habasque CAR 78524
.           Added output of PMPXIHOS in VALPUR00
. V9.05.02  15/03/2006  Ebon Clements CAR 78533
.           Mods for Hospital specific category codes, Doctors and HCP codes
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B04 20/02/2006  Ebon Clements     CAR 76341
.           Added referral and encounter file audit
. V9.05.B03 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B02 10/01/2006   J.Tan         CAR 90040
.                        Added Case team for mental health
. V9.04.27  10/11/2005   J.Tan         CAR 55176
.                        Added validation to LGA and postcode
. V9.04.26  20/10/2005   J.Tan         CAR 58658
.                        Mods validate invoice to return with total paid amount
. V9.04.25  18/10/2005   J.Tan         CAR 52606
.                        Mods validating Misc.charge
. V9.04.24  20/09/2005   Ebon Clements CAR 76986
.                        Changed to use XMLRED00
. V9.04.23  12/09/2005   Ebon Clements CAR 51515
.                        Added active test to expensive items - VALEXI00
. V9.04.22  04/08/2005   J.Tan        CAR 62750 
.                        Mods not to use the redefined amount variables
. V9.04.21  02/08/2005   Jill Habasque  CAR 65506
.                        Mods to go past first inactive unit in valwat00
. V9.04.20  14/07/2005   Davin          CAR 67289
.                        Added option 70 - valhcg00 (validate hcp practice code)
. V9.04.19  07/06/2005   Peter Vela     CAR 62262
.                        Initialised ICDRDDTE to 0 in CLRPAR00
. V9.04.18  06/06/2005   Davin          CAR 62380
.                        Added return format 1 (return service provider number)
.                        to valdmp00
. V9.04.17  26/05/2005   Davin          CAR 22680
.                        Added return format 3 (validate provider number) 
.                        to valhcp00
. V9.04.16  24/05/2005   Jill Habasque  CAR 61939
.                        Added multi database option to VLDINV00
. V9.04.15  23/05/2005   Davin          CAR 22680
.                        Added return format 2 to valhcp00
. V9.04.14  05/05/2005   Ebon Clements  CAR 61122
.                        Added outpatient site check option to VALCLI00
. V9.04.13  22/04/2005   J.Tan CAR 60889
.                        Return payee provider no for validate privete practice 
. V9.04.12  31/03/2005   Jill Habasque CAR 55584
.                        Added output of DRTYPE
. V9.04.11  07/03/2005   Peter Vela CAR 57547
.                        Recompiled for PATVADFD and PATVADIO
.           17/02/2005   Lina Vo CAR 56404
.                        Changed VALITC00 to read item file with new KEY15.
.           04/02/2005   J.Tan   CAR 56665
.                        Mods validateHCP to return suburb and provider no.
. V9.04.10  12/01/2005   J.Tan   CAR 52336
.                        Fixed checking for adm.type excluded from auto admtype
. V9.04.09  11/01/2005   J.Tan   CAR 55717
.                        New tag to validating Attending and Referring HCP 
. V9.04.08  23/11/2004   J.Tan   CAR 52385
.                        Mods validating theatre mbs item 
. V9.04.07  22/11/2004   J.Tan   CAR 52336 
.                        Mods routine for validating item to check if item to
.                        be excluded from auto update admission type
. V9.04.06  25/10/2004   Jill Habasque CAR 54356
.                        Added check for N for PTCNLCLM
.           14/10/2004 - Guomin Fu   CAR 44068
.                        Recompiled for MEHAXIFD
.                        Added checking of MHCNUSE in VALAXI00,VALAX200
. V9.04.05  29/09/2004 - J.Tan    CAR 53909 
.                        Added report 69 - hospital id file
.           29/09/2004 - Lina Vo  CAR 53798 
.                        Changed VALBFE00, VALMSC00, VALITM00 GETMSC00 & 
.                        GETTFE60 to use PTHSDCLM for Multi Hospital instead 
.                        of PTCNDCLM.   
.                        Changed VLDADM00 to also return hospital id
. V9.04.04  21/09/2004 - Lina Vo  CAR 53660 
.                        Changed VALITM00 & GENTFE00 to use PTHSTFEE for 
.                        Multi Hospital instead of PTCNTFEE.   
.           17/09/2004 - Lina Vo  CAR 53054 
.                        Changed VLDINV00 (Report 51) and VLDPPI00 (Report 57)
.                        to validate Fully credited Invoice when VALDCRST=1
. V9.04.03  30/08/2004 - J.Tan  CAR 52997   
.                        Recompiled for CMGETTHR - use default claim code 
. V9.04.02  12/08/2004 - J.Tan  CAR 52504   
.                        Mods checking the register of payment receipts
. V9.04.01  10/08/2004 - Lina Vo   CAR 51011
.                        Changed VALBFE00 to use Default Claim Code rather 
.                        than zero.
.------------------------------------------------------------------------------
. V9.03.31  26/07/2004 - J.Tan CAR 51952
.                        Mods to display misc.charge not setup message
. V9.03.30  26/07/2004 - Jill Habasque CAR 51991
.                        Added pack with spaces for valdcatc
. V9.03.29  21/07/2004 - J.Tan  CAR 51777
.                        Recompiled for CHKSUGCL 
. V9.03.28  20/07/2004 - J.Tan  CAR 50220
.                        Fixed I*C patdgwaf
. V9.03.27  16/07/2004 - J.Tan  CAR 51688
.                        Fixed validating misc.item date
. V9.03.26  21/06/2004 - Lina Vo         CAR 50424
.                        Added Validate Booking Number - VALBOK00 (report 68) 
. V9.03.25  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.24  08/06/2004 - Sylvek Litewka  CAR 37097
.                        Mods to VALTIC00 to check for Inactive Implants.
. V9.03.23  28/05/2004 - Lina Vo         CAR 50273
.                        Mod VALVTP00 to fix validation of outpatient         
. V9.03.22  19/05/2004 - Lina Vo         CAR 49833
.                        Mod VALVTP00 to check for inpatient booking         
. V9.03.21  05/05/2004 - Lina Vo         CAR 49519
.                        Mod VALVTP00 & CHKINV00 to only pass warning flag if
.                        invoice already exists for a inpatient visit.
. V9.03.20  27/04/2004 - Sylvek Litewka  CAR 49241
.                        Modified procedure VALDMP00 to return doctor name in
.                        the standard format.
. V9.03.19  21/04/2004 - Lina Vo         CAR 49159
.                        Mods VLDINV00, VLDPPI00 & VLDARI00 to include
.                        non-banked total in outstanding balance.          
.                        Added GTNBK000 - get non-banked total for invoice
. V9.03.18  20/04/2004 - Lina Vo         CAR 49090
.                        Mods VLDARD00 to only display first name          
. V9.03.17  31/03/2004 - Lina Vo         CAR 47832
.                        Added GETSGC00 - Get suggested class              
.                        Added GETAHF00 - Get admission Health Fund        
.                        Mods VALITM00 to return suggest class
.           29/03/2004 - Lina Vo         CAR 44116
.                        Added VALPCN00 - Validate PP Credit Note number.
.           23/03/2004 - Ebonc Clements  CAR 18703
.                        Added active dates to VALVAD00
. V9.03.16  01/03/2004 - Lina Vo         CAR 47921
.                        Removed use of PRIDBTFD & IO. 
. V9.03.15  20/02/2004 - Lina Vo         CAR 47662
.                        Added VALBFE00 (option 64) - Validate Bed Fees 
.                        Mods VALITM00 to return GST Applicable & Code 
.           19/02/2004 - J.Tan      CAR 44109
.                        Added validate service doctor for a medical practice
. V9.03.14  20/01/2004 - Pat Dirito      CAR 44871
.                        Added VALUSR00 - Validate Security Code &
.                        VALPRI00 - Validate Private Practice Code
. V9.03.13  12/01/2004 - Lina Vo CAR 44073
.                        Changed VLDARI00 to not return scanflag.
. V9.03.12  05/01/2004 - Sylvek Litewka  CAR 46448
.                        Modified procedure VALCMC00 to check for inactive
.                        Casemix Codes.
.           12/12/2003 - Ebon Clements CAR 46231
.                        Open correct site prefix outpatient files
.                        Lina Vo  CAR 44073
.                        Added VALVTP00 (option 56) - Validate UR#, Visit# and 
.                        Visit Type
.                        Changed VLDINV00 (option 51) to return outstanding 
.                        amount.
.                        Added VLDPPI00 (option 57) - Validate Priv Prac Invoice
.                        Added VLDARI00 (option 58) - Validate A/C Rec. Invoice
.                        Added VLDPPD00 (option 59) - Validate Priv Prac Debtor
.                        Added VLDARD00 (option 60) - Validate A/C Rec. Debtor
. V9.03.11  11/12/2003 - Sylvek Litewka  CAR 20222
.                        Modified procedures VALICD00, VALDIA00 and VALICO00
.                        to use RDPTICD1 and RDPTICO1 when reading ICD files. 
. V9.03.10  11/12/2003 - J.Tan                    
.                        Mods to validate credit note 
. V9.03.09  30/10/2003 - J.Tan                    
.                        Recompiled for PATDTRFD - Changed record length
. V9.03.08  16/10/2003 - Lina Vo       CAR 36497
.                        Added VLDFMA00 (option 52) 
.                          - This remote script validates ledger accounts  
.                        Added GETACC00 (option 53) 
.                          - This remote script to get debtors & gst details
. V9.03.07  08/10/2003 - Pat Dirito    CAR 36492
.                        Added PTHFBCAT(Table Type) to HFNDTB00
. V9.03.06  01/10/2003 - Tracey Nguyen CAR 36510
.                        Added VLDADM00 (option 50)
.                          - This remote script validates an admission number 
.                            and does not return an error if not found.
.                        Added VLDINV00 (option 51)
.                          - This remote script validates an invoice number
. V9.03.05  22/09/2003 - Lina Vo       CAR 36486
.                        Added Misc charge code validation for global 
.                        maintenance in VLGMSC00. 
. V9.03.04  15/09/2003 - Tracey Nguyen CAR 42166
.                        Added VLDHFN00 - validate a health fund code to check
.                                         if it exists.
.                              VLDHFT00 - validate a health fund table code to
.                                         check if it exists.
.           01/09/2003 - Lina Vo       CAR 40497
.                        Changed index and read of patmchgf to include 
.                        effective date in VALMSC00.
.           22/08/2003 - J.Tan  CAR 36504
.                        Mods to validate items
. V9.03.03  18/07/2003 - Lina Vo       CAR 36528
.                        Added health fund band (HFBAND) to output in SELHFT00.
. V9.03.02  24/06/2003 - Davin         CAR 37388
.                        Added option 46 for Predefined Diagnosis Selection List
.           24/06/2003 - Lina Vo       CAR 36485
.                        Mods to VALITM00 to also validate newitemn when
.                        FILEFLAG=N.
. V9.03.01  17/06/2003 - Jill Habasque CAR 37705
.                        Added clear of tmotfrst and tmotnext
. V9.02.35  29/04/2003 - Jill Habasque   CAR 38335
.                        Added VALADM00 - Validate admission number        
.           23/04/2003 - Sylvek Litewka  CAR 38335
.                        Mods to SELDCD00 - Removed the limit on number of 
.                        codes returned.
. V9.02.34  14/02/2003 - J.Tan    SRF 20178
.                        Mods for default Claim details               
. V9.02.33  28.01.2003 - Jill Habasque
.                        Added type 6 to  valhcp25                    
. V9.02.32  30.12.2002 - Peter Vela       SRF 33563
.                        Added VALDIA00 - Validate MH Diagnosis Code
. V9.02.31  07.12.2002 - Peter Vela       SRF 18390/20178
.                        Transport Accident Defaults SRS
.                        Added VALCLC00 - Validate Claim Code
.                        Added VALTAC00 - Validate TAC Screen
.           05.12.2002 - Lina Vo          SRF 22709
.                        Added OPNOUT00 - Open outpatient files         
. V9.02.30  21.11.2002 - Peter Vela       SRF 33349
.                        Added VALMSC00 - Validate Misc Charge Item code
.                                         Remote script
. V9.02.29  18.10.2002 - Lina Vo    
.                        Added VALAXI00 - Validate Axis I Codes
.                        Added VALAX200 - Validate Axis II Codes
. V9.02.28  09.10.2002 - Dean Cramer                              
.                        Added VALTUD00 - VCheck if theatre file processed 
. V9.02.27  24.09.2002 - Pat Dirito              SRF 21510
.                        Added VALINS00 - Validate Insurance Codes         
. V9.02.26  12.08.2002 - Pat Dirito              SRF 18292
.                        Modified VALPUR00 added validation of merged U/R
.                        Checks if Merged U/R still has any Med Records.
. V9.02.25  09.08.2002 - Pat Dirito              SRF 18475
.                        Modified VALICD00 and VALICO00 to allow for ICD9 
.                        validation. 
. V9.02.24  23.05.2002 - Dean Cramer   
.                        Include Casemix Code validation               
. V9.02.23  22.04.2002 - Ebon Clements 
.                        Pack VALDCODE with SP70 in VALCLI00           
. V9.02.22  28.03.2002 - Bronko Sosic  
.                        Recompiled For EMRICDFD                       
. V9.02.21  28.02.2002 - Bronko Sosic  
.                        Added new variables in SETPAR00               
. V9.02.20  15.01.2002 - Jill Habasque 
.                        Added VALHCP75 - Active Attending validation  
. V9.02.19  03.01.2002 - Ebon Clements 
.                        Added Estimated length of stay to waiting list
.                        procedure validation
. V9.02.18  11.12.2001 - Bronko Sosic  
.                        Changes For St.V                                     
. V9.02.17  11.12.2001 - Ebon Clements 
.                        Added option to VALDOC00 to return doctor status flag
. V9.02.16  29.11.2001 - Ebon Clements 
.                        Added ur exists flag to VALPUR
. V9.02.15  22.11.2001 - B.G.Ackland
.                        Servlet Support
. V9.02.14  18.11.2001 - Ebon Clements  
.                        Added merg flag to validate ur function
. V9.02.13  17.11.2001 - Bronko Sosic
.                        Added option Active All to HCP Validation
. V9.02.12  12.11.2001 - Ebon Clements
.                        Added option Active All to HCP validation
. V9.02.11  07.11.2001 - Jill Habasque
.                        Added option 31, validate attending doctor
. V9.02.10  25.10.2001 - B.G.Ackland
.                        New HCP Validation Option.
. V9.02.09  24.10.2001 - Jill Habasque
.                        Added VALDUN00 to validate Unit/Doctor combination
. V9.02.08  18.10.2001 - Jill Habasque
.                        Mods to HFNDTB00 to validate Health fund/Table
. V9.02.07  10.10.2001 - B.G.Ackland
.                        Added Begin & Commit Instructions
. V9.02.06  24.09.2001 - Ebon Clements 
.                        Fixed invalid HCP error message
. V9.02.05  21.09.2001 - J.Tan
.                        Mods MR merge for UR (no longer req.) not to check for
.                        link U/R
. V9.02.04  21.09.2001 - Ebon Clements 
.                        Added new status checks to HCP validation         
. V9.02.03  14.09.2001 - Ebon Clements 
.                        Added cgi VALDTYPE for validation of a HCP status
. V9.02.02  10.09.2001 - Kuldeep - HPS
.                        Added CMBS validation for waiting list
. V9.02.01  07/09/2001 -  kuldeep HPS 
.                        Added Cansultant/unit validation for the Waiting List
.                        Added Clinic Id Validation for outpatient
. V9.01.01  13/08/2001 - Ebon Clements 
.                        Call DOCNAM00 to format name in HCP validation       
. V9.00.02  07/08/2001 - HPS
.                        Modification for Discharge Time & Validation for the
.                        U/R number.
. V9.00.01  03/08/2001 - HPS
.                       Modification for the Nurse & HCP code
.                       Added code for validation of
.                       Theatre Expensive Items,Theatre Implant Code,
.                       Surgical Table Item Code and Nurse Code
. V9.00.B01 28/5/2001 
.                  Created Program
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       ALLCONFD/INC
          INC       ALLPDIFD/INC
          INC       ALLENCFD/INC
          INC       ALLSERFD/INC 
          INC       ALLREFFD/INC
          INC       ALLCASFD/INC
          INC       ALLCTMFD/INC
          INC       BOKRC1FD/INC
          INC       DISPATFD/INC
          INC       DISPTLFD/INC
          INC       FMSAMAFD/INC            * Accounts
          INC       FMSCSAFD/INC            * control accounts
          INC       FMSLMAFD/INC            * Ledger
          INC       IBAALVFD/INC 
          INC       MLTHCPFD/INC
          INC       PATATRFD/INC
          INC       PATFMSFD/INC            * financial interface
          INC       PATCFAFD/INC
          INC       PATDHEAD/INC
          INC       PATCALAG/INC
          INC       PATCONFD/INC
          INC       MRTCONFD/INC
          INC       MEHCONFD/INC                  * I-44068
          INC       PATCT1FD/INC
          INC       PATCMCFD/INC
          INC       PATCTFFD/INC
          INC       PATCMXFD/INC
          INC       PATDGWFD/INC
          INC       PATDTRFD/INC
          INC       PATDO1FD/INC
          INC       PATLGAFD/INC
          INC       PMSECTFD/INC
          INC       PMSCNOFD/INC
          INC       PMSEVTFD/INC
          INC       PMSDUNFD/INC
          INC       PMSVX1FD/INC
          INC       PATBFEFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       PATHSPFD/INC
          INC       PATHOSFD/INC
          INC       PATMA1FD/INC
          INC       PMSPX2FD/INC
          INC       PATMI1FD/INC
          INC       PATDSCFD/INC
          INC       PATICDFD/INC
          INC       PATICOFD/INC
          INC       PATITMFD/INC
          INC       PATFACFD/INC
          INC       PATTFEFD/INC
          INC       PATDETFD/INC            * Invoice Debt Indicator Table
          INC       PATVADFD/INC
          INC       PATVISFD/INC
          INC       PATIN1FD/INC            * Patient Insurance File 
.         INC       PAT10DFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCLFD/INC
          INC       OPRCONFD/INC
          INC       OPRDEAFD/INC
          INC       OPRAVEFD/INC
          INC       OPREXPFD/INC            * Theatre Expensive Items
          INC       OPRTHIFD/INC            * Theatre Implants Table
          INC       OPRITEFD/INC            * Theatre Operating Rooms Item Table
          INC       OPRNURFD/INC            * Theatre Nurse
          INC       OPRUPLFD/INC            * Theatre upload history file
          INC       OUTSITFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       PMSCIDFD/INC
          INC       PATSGCFD/INC
          INC       PATTRNFD/INC            * Patient Transfer File
          INC       PATMCHFD/INC            * Misc Item File
          INC       NZPBFEFD/INC
          INC       NZPMCHFD/INC            * NZP Misc Item File
          INC       NZPMC1FD/INC            * NZP Misc Item File
          INC       NZPMXCFD/INC
          INC       NZPSPRFD/INC
          INC       PATWMAFD/INC            * TAC Details File
          INC       PATWC1FD/INC
          INC       PATPARFD/INC
          INC       PATPCPFD/INC
          INC       PMSWX1FD/INC
          INC       PMSREGFD/INC
          INC       WATVWLFD/INC            * Valid Wating List
          INC       OUTCLIFD/INC            * Valid Clinic Id
          INC       OUTCTYFD/INC       
          INC       WATPROFD/INC            * Patient Procedure
          INC       EMRICDFD/INC
          INC       EMRVISFD/INC
          INC       EMRHISFD/INC
          INC       MRTMASFD/INC
          INC       MEHAXIFD/INC            * Mental Health Axis Codes
.
          INC       WEBPARFD/INC
          INC       WEBPCPFD/INC
.
          INC       AAEDE1FD/INC
          INC       RCPBNKFD/INC
          INC       RCPCIDFD/INC            * Receipting - Cashier Id
          INC       RCPCONFD/INC
          INC       RCPDTEFD/INC
          INC       RCPREGFD/INC
          INC       PATINVFD/INC
          INC       PATIRNFD/INC
          INC       PRIALSFD/INC                 * Medical Prac.all user access
          INC       PRISECFD/INC                 * Medical Prac.security access
          INC       PRIHDBFD/INC
          INC       PRIHREFD/INC
          INC       PRICNOFD/INC                 * invoice file
          INC       PRIDOCFD/INC                 * PP Doctor file
          INC       PRIINVFD/INC                 * invoice file
          INC       PRIPRAFD/INC                 * Private Practice file
          INC       DEBDBTFD/INC                 * debtors file
          INC       DEBFTHFD/INC                 * Acc Rec debtors trns hdr file
          INC       DEBFDTFD/INC                 * Acc Rec debtors trns dtl file
          INC       MULTVISV/INC            * PATDPATH variables
          INC       PATDPTHV/INC            * PATDPATH variables
          INC       EMRUNKFD/INC            * Unknown Patient details
          INC       PATDDHFD/INC
          INC       TFILEVAR/INC
.
.
.  Enable Different Formats of Data for UR Validation
RETURNFM  FORM      1          * Return Format 0=Default
RETURNDT  DIM       8
RECCOUNT  FORM      5
.
ACTVONLY  DIM       1
ALSRMHD   DIM       4
ATRTYPE   DIM       3
CNTRCEFR  FORM      1
CASEKEYS  DIM       26
CASHTOT   FORM      12.2
CHECKSIT  DIM       6
CIDEDATE  DATE      8
CMDLINE   DIM       127
CMXFLAG   FORM      1
CURRDATE  DIM       8
DAYCASE   DIM       1
DIM2A     DIM       2
DIM2B     DIM       2
DIM3      DIM       3
DIM5      DIM       5
DIM6      DIM       6
DIM8      DIM       8
DIM36     DIM       36
DIM9      DIM       9
DIM10     DIM       10
DIM11     DIM       11
DIM11A    DIM       11
DIM12     DIM       12
DIM18     DIM       18
DIM18A    DIM       18
DIM37     DIM       37
DIM40     DIM       40
DESTTYPE  DIM       1                  * 'Destination Type'
DDSTTYPE  DIM       1                  * Discharge destination type
DOCTCODE  DIM       10
DOCTHOSP  FORM      1
FILTDTYP  DIM       1                  * Filter by 'Destination Type' (1-Yes)
FORM12P2  FORM      12.2
FORM2D    FORM      2
FORM3     FORM      3
FORM8     FORM      8
FILEFLAG  DIM       1                       * N=New File C=Current File
FILEOPEN  DIM       30
FMSAMA    INIT      "fmsamaaf"
FMSLMA    INIT      "fmslmaaf"
FMTAGE    DIM       10
FMTYRS    INIT      " yrs"
FMTMTHS   INIT      " mths"
FMTWKS    INIT      " wks"
FMTDAYS   INIT      " days"
FMTSEX    DIM       20
FRSTFLAG  FORM      1
FORM6     FORM      6
FORM12    FORM      12
GPACCESS  FORM      1
GPCODE    DIM       10
HLFNDDSC  DIM       40
HLFNTDSC  DIM       40
HFHIFUND  FORM      2
PRACTICE  DIM       10
PCFLAG    FORM      1
TDESC1    DIM       30
TDESC2    DIM       30
CONTRCID  DIM       6
MBSCONTR  DIM       6
MULTHOSP  DIM       3 
MERGEDFL  FORM      1                       * Merged patient flag
MULDHOSP  DIM       4
MSCHG001  DIM       3                       * claim code
MSCHG002  DIM       6                       * health fund
MSCHG003  DIM       8                       * health fund table
MSCHG004  DIM       9                       * misc charge code
MSCHG034  DIM       3                       * health fund table type
NODEFPRA  FORM      1
EXISTFLG  FORM      1                       * U/R exists flag
EXCLITM   FORM      1
KEY13A    DIM       13
KEY18A    DIM       18
KEY21A    DIM       21
KEY23A    DIM       23
KEY26A    DIM       26
KEY29A    DIM       29
PROSITM   FORM      1
PRACCODE  DIM       10
PRACNAME  DIM       80
PRACCNTR  DIM       2
PRACPRV1  DIM       10
PPACKITM  FORM      12.2
FPACKITM  FORM      12.2
ICD10DAT  DIM       8
INVALDAT  FORM      1                       * outside date range flag
INVALDFL  FORM      1
INVDETIN  DIM       1                       * Invoice Debt Indicator  *I-233229
ITMCHGE   FORM      1
ITCODE    DIM       9
LSEDDATE  DATE      8
XXASCII1  FILE      ASCII, FIXED=250
FUNDNAME  DIM       40
VALDALLH  DIM       1                       * Ignore multi hospital tests
VALDHLFN  DIM       6                       * Health Fund Code
VALDECCP  DIM       3                       * Eclipse Capability ID
VALDADMT  DIM       3                       * Admission Type Code
VALDBEDT  DIM       3                       * Bed Type Code
VALDCEFF  DIM       8                       * Contract Effective Date
VALDCLMT  DIM       3                       * Claim Type Code
VALDCODE  DIM       70                      * Validation Code
VALDHCPC  DIM       10                      * Validation HCP Code
VALBCODE  DIM       60                      * Barcode Code
DEPTCODE  DIM       3                       * SAC department code
VALDCATC  DIM       3                       * Validation Catergory Code
VALDCRST  FORM      1                       * Validation Fully Credited Invoice
VALDADAT  DIM       8
VALDEDAT  DIM       8
VALDDATE  DIM       8
VALDDOCT  DIM       6
VALDDCTR  DIM       10
VALDDEFV  DIM       1
VALDFUND  DIM       6
VALDHOSP  DIM       10
VALDURNO  DIM       8
VALDADNO  DIM       8
VALDRDAT  DIM       8
VALDRTIM  DIM       8
VALDTABL  DIM       8
VALDTYPE  FORM      2                       * Validataion Status
VALPTYPE  DIM       3  
VALDUNIQ  DIM       3                       * Validataion Status
VALDOPTN  FORM      2
VALDSPEC  DIM       3
VALDWARD  DIM       3
RETURNID  FORM      1
REGIMFLG  FORM      2
WARNFLAG  FORM      1                       * Warning Flag
CMBSFEE   FORM      1
CMIXFLAG  FORM      1
CFILEPRE  DIM       3                       * Site Prefix
CHECK001  DIM       10                      * User Name
CHECK002  DIM       10                      * Password
CMCODE    DIM       9
DIM60     DIM       60
VTYPFLAG  FORM      1          * Last Visit Type Required 1=Discharged Inpatient
LASTVIST  DIM       8
LASTVDAT  DIM       11
LASTVTYP  DIM       15
LASTADAT  DIM       11
LASTSTAT  DIM       15
INVOICEN  DIM       12
DOBDATE   DIM       11
USNGICD9  FORM      1
DISCHDTE  DIM       8
MEDIPRAC  DIM       6
MDPRAC    DIM       6[99]
CEFFDATE  DIM       8
TSRVDATE  DIM       8
TOTOUTS   FORM      12.2
TOTPAID   FORM      12.2
TRANDATE  DIM       8
PRIVPRAC  FORM      1                    *Flag for Private Practise
REFRLSRC  DIM       28         * referral src 
RPERDATE  DIM       11
RPERDESC  DIM       20
.
LSTEDATE  DIM       8         * last effective date
VALMBSIA  FORM      1         * Inactive MBS code
.
AT1       INIT      "Pre-admitted"
AT2       INIT      "Admitted"
AT3       INIT      "Discharged"
AT4       INIT      "On-leave"
AT5       INIT      "Cancelled"
.
CATrt     INIT      "rt"
CATw0     INIT      "w0"
.
VT1       INIT      "Emergency"
VT2       INIT      "Outpatient"
VT3       INIT      "Inpatient"
VT4       INIT      "Other Financial"
VT5       INIT      "Day Centre"
VT6       INIT      "Community"
VT7       INIT      "Ward Attendee"
VT8       INIT      "Adhoc Attendee"
VT9       INIT      "Event"
VT10      INIT      "Allied Health"
DZERO     INIT      "0"
.
SAVURNUM  DIM       8
SAVKEY20  DIM       20
SAVKEY37  DIM       37
SAVKEY24  DIM       24
SAVKEY19  DIM       19
SAVKEY9   DIM       9
SAVKEY4   DIM       4
SKEY18    DIM       18
SHOWLDSC  DIM       1
.
THCFLG    FORM      2
AMTFLAG   FORM      1
ADDFLAG   FORM      1                       * HPS Code Starts Here
ATTFLAG   FORM      1                       * Attending doctor only
MDRECFLG  FORM      1                       * Medical record still exists flag
MBSFLAG   FORM      1
MINADD    FORM      2
NOFEE     FORM      1
FORM4D    FORM      4
SFORM4D   FORM      4                       * HPS Code Ends Here
SP11      INIT      "           "
ZERO4     INIT      "0000"
ZERO8     INIT      "0000    "
INACTFLG  FORM      1
STADMNO   FORM      8
OPCASEKY  DIM       28
XLCNT     FORM      2
WSININDC  DIM       1
.
.------------------------------------------------------------
PRGID     INIT      "PATWEB80"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "XML Remote Code Validation Service"
.------------------------------------------------------------
.
          CALL      WEBINT00                * Initialise Fifo Etc.
          CALL      INIT0000                * Open Files
.
MAIN1000  CALL      XMLRED00       * Read Fifo WEBPID and USERID
.
          CALL      OUTFIL00                * Check Correct Site Files Are Open
          BRANCH    EXIT,MAIN1000
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD,SP10
          REP       " 0",CURRDATE
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:  * 10
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000:  * 20
                             MAIN3100,MAIN3200,MAIN3300,MAIN3400,MAIN3500:
                             MAIN3600,MAIN3700,MAIN3800,MAIN3900,MAIN4000:  * 30
                             MAIN4100,MAIN4200,MAIN4300,MAIN4400,MAIN4500:
                             MAIN4600,MAIN4700,MAIN4800,MAIN4900,MAIN5000:  * 40
                             MAIN5100,MAIN5200,MAIN5300,MAIN5400,MAIN5500:
                             MAIN5600,MAIN5700,MAIN5800,MAIN5900,MAIN6000:  * 50
                             MAIN6100,MAIN6200,MAIN6300,MAIN6400,MAIN6500:
                             MAIN6600,MAIN6700,MAIN6800,MAIN6900,MAIN7000:  * 60
                             MAIN7100,MAIN7200,MAIN7300,MAIN7400,MAIN7500:
                             MAIN7600,MAIN7700,MAIN7800,MAIN7900,MAIN8000:  * 70
                             MAIN8100,MAIN8200,MAIN8300,MAIN8400,MAIN8500:
                             MAIN8600,MAIN8700,MAIN8800,MAIN8900,MAIN9000:  * 80
                             MAIN9100,MAIN9200,MAIN9300,MAIN9400,MAIN9500:
                             MAIN9600,MAIN9700,MAIN9800,MAIN9900,MAIN99A0:  * 90
                             MAIN99B0,MAIN99C0,MAIN99D0,MAIN99E0,MAIN99F0:
                             MAIN99G0,MAIN99H0,MAIN99I0,MAIN99J0
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      CURDTM00   * Return Current Date DD MMM YYYY & Time
          GOTO      MAIN1000
.
MAIN1200  CALL      VALCOD00
          GOTO      MAIN1000
.
MAIN1300  CALL      VALDOC00
          GOTO      MAIN1000
.
MAIN1400  CALL      VALITM00
          GOTO      MAIN1000
.
MAIN1500  CALL      VALDRG00
          GOTO      MAIN1000
.
MAIN1600  CALL      VALICD00
          GOTO      MAIN1000
.
MAIN1700  CALL      VALICO00
          GOTO      MAIN1000
.
MAIN1800  MOVE      ZERO,VTYPFLAG
          CALL      VALPUR00
          GOTO      MAIN1000
.
MAIN1900  CALL      VALVAD00
          GOTO      MAIN1000
.
MAIN2000  CALL      VALFIL00
          GOTO      MAIN1000
.
MAIN2100  CALL      VALSEC00
          GOTO      MAIN1000
.
MAIN2200  CALL      VALVIS00                * Validate patien Visit Number
          GOTO      MAIN1000
.
MAIN2300  MOVE      ONE,VTYPFLAG
          CALL      VALPUR00
          GOTO      MAIN1000
.
MAIN2400  CALL      SELDPT00
          GOTO      MAIN1000
.
MAIN2500  CALL      SELCOD00
          GOTO      MAIN1000
.
MAIN2600  CALL      SELHFT00
          GOTO      MAIN1000
.-------HPS Code Starts---------
.
MAIN2700  CALL      VALNUR00                * Validate Nurse Code 
          GOTO      MAIN1000
.
MAIN2800  CALL      VALHCP00                * Validate HCP Code 
          GOTO      MAIN1000
.
MAIN2900  CALL      HEFUND00                * Health Fund Validation
          GOTO      MAIN1000
.
MAIN3000  CALL      HFNDTB00                * Health Fund Table Validation
          GOTO      MAIN1000
.
MAIN3100  CALL      VALEXI00
          GOTO      MAIN1000
.
MAIN3200  CALL      VALTIC00
          GOTO      MAIN1000
.
MAIN3300  CALL      VALITC00
          GOTO      MAIN1000
.
MAIN3400  CALL      DISDTM00
          GOTO      MAIN1000
.
MAIN3500  CALL      VALCLI00                * Validation for the clinic code 
          GOTO      MAIN1000
.
MAIN3600  CALL      VALWAT00                * Validation for consultant/unit 
          GOTO      MAIN1000
.
MAIN3700  CALL      VALPRO00                * Validation for Procedure code 
          GOTO      MAIN1000
.
MAIN3800  MOVE      TWO,VTYPFLAG            * validate U/R without checking link
          CALL      VALPUR00
          GOTO      MAIN1000
.
.------HPS Code Ends--------
MAIN3900  CALL      VALDUN00                * Validation for consultant/unit 
          GOTO      MAIN1000
.
MAIN4000  CALL      SELUNI00                * output valid units for consultant
          GOTO      MAIN1000
.
MAIN4100  MOVE      ONE,ATTFLAG
          CALL      VALDOC00                * output valid units for consultant
          GOTO      MAIN1000
.
MAIN4200  CALL      SELDCD00                * Category codes select with match
          GOTO      MAIN1000
.
MAIN4300  CALL      UREXIS00                * Return a flag if ur number exists
          GOTO      MAIN1000
.
MAIN4400  MOVE      ONE,INACTFLG
          CALL      VALDOC00                * Return a flag for inactive doctors
          GOTO      MAIN1000
.
MAIN4500  CALL      VALCMC00
          GOTO      MAIN1000
.
MAIN4600  CALL      VALINS00                * Validate Insurance Codes
          GOTO      MAIN1000
.
MAIN4700  CALL      VALTUD00                * Validate Theatre Upload Done  
          GOTO      MAIN1000
.
MAIN4800  CALL      VALAXI00                * Validate Axis I Codes         
          GOTO      MAIN1000
.
MAIN4900  CALL      VALAX200                * Validate Axis II Codes        
          GOTO      MAIN1000
.
MAIN5000  IF        VALDOPTN=1
            CALL      VALMIT00              * Validate Misc.Items (full key)
            GOTO      MAIN1000
          ENDIF
.
          IF        CFEETYP=5
            CALL      VALNZM00              * Validate NZ Misc Charge Items
          ELSE
            CALL      VALMSC00              * Validate Misc Charge Items
          ENDIF
          GOTO      MAIN1000                * I SRF 33349
.
MAIN5100  CALL      VALCLC00                * Validate Claim Code
          GOTO      MAIN1000                * I SRF 18390
.
MAIN5200  CALL      VALTAC00                * Validate TAC Screen 
          GOTO      MAIN1000                * I SRF 18390
.
MAIN5300  CALL      VALDIA00                * Validate MH Diagnosis Codes
          GOTO      MAIN1000                * I SRF 33563
.
MAIN5400  CALL      VALWCO00                * Validate TAC Screen 
          GOTO      MAIN1000                * I SRF 18390
.
MAIN5500  CALL      VALADM00                * Validate patien admission number
          GOTO      MAIN1000
.
MAIN5600  CALL      SELRDP00
          GOTO      MAIN1000
.
MAIN5700  CALL      VLDHFN00                * Validate a health fund code
          GOTO      MAIN1000                    
.
MAIN5800  CALL      VLDHFT00                * Validate a health fund table code
          GOTO      MAIN1000                    
.
MAIN5900  CALL      VALCTY00                * Validate a clinic type code 
          GOTO      MAIN1000                    
.
MAIN6000  CALL      VLDADM00                * Validate admissno - no error if
          GOTO      MAIN1000                *                     not found
.
MAIN6100  CALL      VLDINV00                * Validate invoice number
          GOTO      MAIN1000
.
MAIN6200  CALL      VLDFMA00                * Validate Financial Management acc.
          GOTO      MAIN1000
.
MAIN6300  CALL      GETACC00                * get debtors & gst control acc.
          GOTO      MAIN1000
.
MAIN6400  CALL      SELCDV00
          GOTO      MAIN1000
.
MAIN6500  CALL      VLDCRD00                * Validate Credit Note number
          GOTO      MAIN1000
.
MAIN6600  CALL      VALVTP00                * Validate UR#,Visit# and Visit Type
          GOTO      MAIN1000
.
MAIN6700  CALL      VLDPPI00                * Validate Priv Prac Invoice #
          GOTO      MAIN1000
.
MAIN6800  CALL      VLDARI00                * Validate A/C Receivable Invoice #
          GOTO      MAIN1000
.
MAIN6900  * not used 
.          CALL      VLDPPD00                * Validate Priv Prac Debtor #
          GOTO      MAIN1000
.
MAIN7000  CALL      VLDARD00                * Validate A/C Receivable Debtor #
          GOTO      MAIN1000
.
MAIN7100  CALL      VALUSR00                * Validate Security Code
          GOTO      MAIN1000
.
MAIN7200  CALL      VALPRI00                * Validate Private Practice Code
          GOTO      MAIN1000
.
MAIN7300  CALL      VALDMP00                * Validate Doctor for a Medical Prac
          GOTO      MAIN1000
.
MAIN7400  CALL      VALBFE00                * Validate Bed Fee
          GOTO      MAIN1000
.
MAIN7500  CALL      VLDPCN00                * Validate PP Credit Note number
          GOTO      MAIN1000
.
MAIN7600  CALL      GETAHF00                * Get admission health fund     
          GOTO      MAIN1000
.
MAIN7700  CALL      GETSGC00                * Get suggested class           
          GOTO      MAIN1000
.
MAIN7800  CALL      VALBOK00                * Validate Booking          
          GOTO      MAIN1000
.
MAIN7900  CALL      GETHSP00                * Get hospital id record
          GOTO      MAIN1000
.
MAIN8000  CALL      VALHCG00                * Validate HCP Practice code
          GOTO      MAIN1000
.
MAIN8100  CALL      VALLGA00                * Validate LGA code
          GOTO      MAIN1000
.
MAIN8200  CALL      VALPCD00                * Validate Post code
          GOTO      MAIN1000
.
MAIN8300  CALL      SELCAS00           * output valid case teams for consultant
          GOTO      MAIN1000
.
MAIN8400  CALL      CHKGLI00           * Check parameter for G/L Interface
          GOTO      MAIN1000
.
MAIN8500  CALL      VALRMS00           * Validate Regime/Misc.Item
          GOTO      MAIN1000
.
MAIN8600  CALL      OUTPAS00           * Validate outpatient site password
          GOTO      MAIN1000
.
MAIN8700  MOVE      ONE,DOCTHOSP       * validate doctor for a certain hospital
          CALL      VALDOC00
          GOTO      MAIN1000
.
MAIN8800  CALL      VALOAV00
          GOTO      MAIN1000
.
MAIN8900  CALL      VALDCT00
          GOTO      MAIN1000
.
MAIN9000  MOVE      " ",KEY1           * select all RCP Registers by Hospital Id
          CALL      SELREG00
          GOTO      MAIN1000
.
MAIN9100  MOVE      "1",KEY1           * select RCP Registers by Hospital Id for
          CALL      SELREG00           * payments by HFund,PP,AccRec or Suspense
          GOTO      MAIN1000
.
MAIN9200  CALL      SELCSD00           * select all RCP Cashiers by Hospital Id
          GOTO      MAIN1000
.
MAIN9300  CALL      VALAX300           * Validate Axis III Codes        
          GOTO      MAIN1000
.
MAIN9400  CALL      VALPAR00           * Validate Eclipse Participant Codes
          GOTO      MAIN1000
.
MAIN9500  CALL      VALPCP00           * Validate Eclipse Participant/Capability
          GOTO      MAIN1000
.
MAIN9600  CALL      VALRFS00            * Validate transf src
          GOTO      MAIN1000
.
MAIN9700  CALL      VALACL00           * show all active clinics
          GOTO      MAIN1000
.
MAIN9800  CALL      VALMS100           * Validate Misc Charges
          GOTO      MAIN1000
.
MAIN9900  CALL      VALSRF00           * validate SAC U/R
          GOTO      MAIN1000
.
MAIN99A0  CALL      VALSRD00           * validate SAC department
          GOTO      MAIN1000
.
MAIN99B0  CALL      VALDCL00           * validate clinic effect date
          GOTO      MAIN1000
.
MAIN99C0  CALL      VALCAS00           * list case team with hcp code
          GOTO      MAIN1000
.
MAIN99D0  CALL      VALCHC00           * list hcp in case team
          GOTO      MAIN1000
.
MAIN99E0  CALL      VALMPR00           * list of medical practices for an U/R
          GOTO      MAIN1000
.
MAIN99F0  CALL      VALCTR00           * Contract ID
          GOTO      MAIN1000
.
MAIN99G0  CALL      VALDLS00           * Expiry Date for Legal Status 
          GOTO      MAIN1000
.
MAIN99H0  MOVE      THREE,VTYPFLAG     * Get visit for recurring care
          CALL      VALPUR00
          GOTO      MAIN1000
.
MAIN99I0  CALL      VALDIS00           * Previous Visit Disaster Code/Id Number
          GOTO      MAIN1000
.
MAIN99J0  CALL      GETINS00           * Get default Insurance for a Serv.code
          GOTO      MAIN1000
.
MAIN9999  RETURN
+
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      CONTROLF,"controlf"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      IBAALVA2,"ibaalvaf"
          OPEN      DISPATA1,"dispataf"
          OPEN      DISPATA2,"dispataf"
          OPEN      DISPTLA1,"disptlaf"
          OPEN      EMRICDA2,"emricdaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRHISA2,"emrhisaf"
          OPEN      PATATRA1,"patatraf"
          OPEN      PATATRA3,"patatraf"
          OPEN      PATCMCA1,"patcmcaf"
          OPEN      PATFACT1,"patfactf" 
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATDO1A1,"patdo1af"
          OPEN      PMSCNOA1,"pmscnoaf"
          OPEN      PMSDUNA1,"pmsdunaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      WATPROA1,"watproaf"
          OPEN      PATBFEE1,"patbfeef"
          OPEN      PATFN1A1,"patfn1af"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATHOSP1,"pathospf"
          OPEN      PATHOSP2,"pathospf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PMSCIDA1,"pmscidaf"
          OPEN      PATCT1C1,"patct1cf"
          OPEN      PATLGAA1,"patlgaaf"
          OPEN      PATMA1A1,"patma1af"
          OPEN      PMSPX2A1,"pmspx2af"
          OPEN      PATMX1A1,"patmx1af"
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATPARA1,"patparaf"
          OPEN      PATPCPA1,"patpcpaf"
          OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      NZPMCHA3,"nzpmchaf"
          OPEN      NZPMXCA1,"nzpmxcaf"
          OPEN      PATSGCA1,"patsgcaf"
          OPEN      PATDETA1,"patdetaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
          OPEN      PATIN1A1,"patin1af"      * Open Insurance File
          OPEN      ALLPDIA1,"allpdiaf" 
          OPEN      ALLENCA1,"allencaf"
          OPEN      ALLSERA1,"allseraf" 
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      ALLCTMA2,"allctmaf"
          OPEN      ALLCTMA1,"allctmaf"
          OPEN      OPRNURA1,"oprnuraf"
          OPEN      PMSHCPA1,"pmshcpaf"
          OPEN      PMSHCPA3,"pmshcpaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSHCLA3,"pmshclaf"
          OPEN      OPRAVEA1,"opraveaf"
          OPEN      OPREXPA1,"oprexpaf"
          OPEN      OPRTHIA1,"oprthiaf"
          OPEN      OPRTHIA3,"oprthiaf"
          OPEN      OPRITEA1,"opriteaf"
          OPEN      OPRUPLA1,"opruplaf"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATWMAB1,"patwmabf"
          OPEN      PATWC1A1,"patwc1af"
          OPEN      PMSWX1A1,"pmswx1af"
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      WATVWLA1,"watvwlaf"
          OPEN      WATVWLA2,"watvwlaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      RCPCIDA1,"rcpcidaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPREGA1,"rcpregaf"
          OPEN      PMSEVTA1,"pmsevtaf"
          OPEN      ALLREFA2,"allrefaf"
          OPEN      PMSECTA2,"pmsectaf"
.
          CALL      OPICD1                  * Open ICD Disease files
          CALL      OPICO1                  * Open ICD Operation files
.
          OPEN      MRTMASA3,"mrtmasaf"
          OPEN      MEHAXIA1,"mehaxiaf"
.
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PATIRNG1,"patirnge"
          OPEN      PRIALSA1,"prialsaf"
          OPEN      PRISECA1,"prisecaf"
          OPEN      PRIHREF1,"prihreff"
          OPEN      PRIHDBT1,"prihdbtf"
          OPEN      PRIINVO1,"priinvof"
          OPEN      PRICNOA1,"pricnoaf"
          OPEN      PRIPRAC1,"pripracf"
          OPEN      DEBDBTA1,"debdbtaf"
          OPEN      DEBFDTA6,"debfdtaf"
          OPEN      DEBFTHA6,"debfthaf"
          OPEN      EMRUNKA1,"emrunkaf"
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,ZERO;*85,IBCNUGST
          READ      CONTROLF,TEN8;*163,CGLPATH
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,TWENTY;*193,PTCNDCLM
          READ      CONTROLF,THIRTY6;*222,RCCNDREF
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND05;*210,PTCNLCLM
          READ      CONTROLF,HUND05;*177,PTCNTFEE       * Using theatre fees
          READ      CONTROLF,HUND10;*246,PTCNMHCP
          READ      CONTROLF,TEN;*1,STADMNO
          READ      CONTROLF,TEN8;*162,CGLIND
          READ      CONTROLF,TEN9;*216,CINVRIP
          READ      CONTROLF,SIXTY9;*69,MHCNUSE      * I-44068
.
          READ      CONTROLF,NINTY8;*149,PTCNGDV2
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND05;*217,PTCNGDV4,*227,PTCNGDV5
          READ      CONTROLF,HUND12;*110,PTCNPRDC
          READ      CONTROLF,HUND13;*48,OPCNSIVB,*66,OPCNPTMC
          READ      CONTROLF,HUND18;*154,PTCNUHSC          * using hospital security?
          READ      CONTROLF,HUND24;*144,PTCNELOS,*147,PTCNSUID
          READ      CONTROLF,HUND25;*237,PTCNRCAR
          READ      CONTROLF,HUND28;*103,PTCNLPRA
          READ      CONTROLF,HUND29;*61,PTCNWSIN
.
          CALL      OPICO2
          CALL      OPICD2
.
          OPEN      OUTSITA1,"outsitaf"
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00
.
          CALL      OPNFMS00
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,TEN;*244,CHOSPNUM
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
            OPEN      MLTHCPA1,"mlthcpaf"
            OPEN      MLTHCPA2,"mlthcpaf"
          ENDIF
.
          CALL      TFILENAM
          MOVE      TFILNAME,CFNAMEDP
          CALL      PATDPATH
.
          MOVE      ONE,WSININDC
          MATCH     "1",PTCNWSIN
          IF         @EQUAL
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBPARA1,"webparaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,WSININDC
            ENDIF
.
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            OPEN      WEBPCPA1,"webpcpaf"
            TRAPCLR   IO
            IF        OVRCD=1
              MOVE      ZERO,WSININDC
            ENDIF
.
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Open Outpatient Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA6  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME      
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME      
.
          PACK      CFNAME,CFILEPRE,FILBB1A1  * Get the name of the BB1A1 file
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME    
.
OPNOUT99  RETURN
+
.------------------------------------------------------------
. Open Financial Management System Files
.------------------------------------------------------------
OPNFMS00  MOVE      TWENTY,XLCNT
OPNFMS10  RESET     CGLPATH,XLCNT
          CMATCH    SP1,CGLPATH
          GOTO      OPNFMS20 IF NOT EQUAL
          SUB       ONE,XLCNT
          COMPARE   ZERO,XLCNT
          GOTO      OPNFMS10 IF NOT EQUAL
          CLEAR     CGLPATH
          GOTO      OPNFMS30
.
OPNFMS20  LENSET    CGLPATH
          RESET     CGLPATH
.
OPNFMS30  PACK      FILEOPEN,CGLPATH,FMSAMA
          OPEN      FMSAMAA1,FILEOPEN
          OPEN      FMSAMAA2,FILEOPEN
          OPEN      FMSAMAA3,FILEOPEN
          OPEN      FMSAMAA4,FILEOPEN
.
          PACK      FILEOPEN,CGLPATH,FMSLMA
          OPEN      FMSLMAA1,FILEOPEN
.
OPNFMS99  RETURN
+
.
. Note Following Labels Not Used in Service
.
PROFLD00  RETURN 
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      SP70,VALDCODE
          MOVE      SP70,VALDHCPC
          MOVE      SP70,VALBCODE
          MOVE      SP70,VALDSPEC
          MOVE      SP70,VALDADAT
          MOVE      SP70,VALDDATE
          MOVE      SP70,VALDEDAT
          MOVE      SP70,VALDHOSP
          MOVE      SP70,VALDWARD
          MOVE      SP70,LSTEDATE
          MOVE      SP70,DEPTCODE
          MOVE      ZERO,PRIVPRAC
          MOVE      SP70,VALDCATC
          MOVE      ZERO,VALDCRST
          MOVE      SP70,RETURNDT
          MOVE      ZERO,RETURNFM
          MOVE      ZERO,VALDOPTN
          MOVE      ZERO,VALDTYPE
          MOVE      SP70,VALPTYPE
          MOVE      ZERO,REGIMFLG
          MOVE      SP70,VALDFUND
          MOVE      SP70,VALDUNIQ
          MOVE      SP70,VALDTABL
          MOVE      SP70,VALDURNO
          MOVE      SP70,VALDADNO
          MOVE      SP70,VALDADMT
          MOVE      SP70,VALDBEDT
          MOVE      SP70,VALDCEFF
          MOVE      SP70,VALDCLMT
          MOVE      SP70,VALDDOCT
          MOVE      SP70,VALDDCTR
          MOVE      SP70,VALDDEFV
          MOVE      SP70,VALDHLFN
          MOVE      SP70,VALDECCP
          MOVE      ZERO,USNGICD9
          MOVE      SP70,MEDIPRAC
          MOVE      SP70,DISCHDTE
          MOVE      SP70,FILEFLAG
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,MSCHG001
          MOVE      SP70,MSCHG002
....      MOVE      SP70,MSCHG003
          MOVE      SP70,MSCHG004
          MOVE      SP70,MSCHG034                                     *I-233046
          MOVE      SP70,TRANDATE
          MOVE      SP70,REFRLSRC
          MOVE      SP70,MULTHOSP
          MOVE      SP70,CASEKEYS
          MOVE      SP70,CHECKSIT
          MOVE      SP70,MULDHOSP
          MOVE      SP70,ICDRDDTE
          MOVE      ZERO,DOCTHOSP
          MOVE      SP70,ICD10DAT
          MOVE      SP70,VALDRDAT
          MOVE      SP70,VALDRTIM
          MOVE      SP70,VALDALLH
          MOVE      SP70,ACTVONLY
          MOVE      SP70,FILTDTYP
          MOVE      SP70,DESTTYPE
          MOVE      SP70,DDSTTYPE
          MOVE      ZERO,RETURNID
          MOVE      SP70,SHOWLDSC
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "valdcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdhcpc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDHCPC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valbcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALBCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdward=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDWARD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdedat=",QRYNAME
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      QRYDATA,CCENT,CYEAR,CMON,CDAY
            MOVE      QRYDATA,VALDEDAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdhosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdspec=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDSPEC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LSTEDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deptcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEPTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "privprac=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PRIVPRAC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returnfm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETURNFM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returndt=",QRYNAME
          IF        @EQUAL
            CALL      SETDAT00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            REP      "+ ",CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdoptn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDOPTN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valptype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALPTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valduniq=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDUNIQ
            SQUEEZE   VALDUNIQ
            MOVE      ZERO,F3
            MOVE      VALDUNIQ,F3
            PACK      VALDUNIQ,F3,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "regimflg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REGIMFLG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcrst=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCRST
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdfund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDFUND
            PACK      VALDFUND,VALDFUND,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddoct=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDDOCT
            PACK      VALDDOCT,VALDDOCT,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddctr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDDCTR
            PACK      VALDDCTR,VALDDCTR,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valddefv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDDEFV
            PACK      VALDDEFV,VALDDEFV,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtabl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTABL
            PACK      VALDTABL,VALDTABL,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdurno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDURNO
            PACK      VALDURNO,VALDURNO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdadno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDADNO
            PACK      VALDADNO,VALDADNO,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdcatc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDCATC
            PACK      VALDCATC,VALDCATC,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdadmt=",QRYNAME
          IF        @EQUAL
            PACK      VALDADMT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdbedt=",QRYNAME
          IF        @EQUAL
            PACK      VALDBEDT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdceff=",QRYNAME
          IF        @EQUAL
            PACK      VALDCEFF,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdclmt=",QRYNAME
          IF        @EQUAL
            PACK      VALDCLMT,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdhlfn=",QRYNAME
          IF        @EQUAL
            PACK      VALDHLFN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdeccp",QRYNAME
          IF        @EQUAL
            PACK      VALDECCP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "secureid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SECUREID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "securepw=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SECUREPW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "usngicd9=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,USNGICD9
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mediprac=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MEDIPRAC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dischdte=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISCHDTE
            PACK      ICDRDDTE,DISCHDTE,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fileflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILEFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mschg",QRYNAME
          IF        @EQUAL
            CALL      SMCHG000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "valdadat=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      VALDADAT,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "trandate=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      TRANDATE,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "refrlsrc=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            PACK      REFRLSRC,QRYDATA,SP10,SP10,SP8
          ENDIF

          MATCH     "multhosp=",QRYNAME
          IF        @EQUAL
            PACK      MULTHOSP,QRYDATA,SP10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "checksit=",QRYNAME
          IF        @EQUAL
            PACK      CHECKSIT,QRYDATA,SP10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "muldhosp=",QRYNAME
          IF        @EQUAL
            PACK      MULDHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "docthosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "icd10dat=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.         
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      ICD10DAT,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdrdat=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            GOTO      SETPAR99 IF EQUAL
            GOTO      SETPAR99 IF EOS
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      VALDRDAT,CCENT,CYEAR,CMON,CDAY,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdrtim=",QRYNAME
          IF        @EQUAL
            PACK      VALDRTIM,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdallh=",QRYNAME
          IF        @EQUAL
            PACK      VALDALLH,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "actvonly=",QRYNAME
          IF        @EQUAL
            PACK      ACTVONLY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtdtyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTDTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "desttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DESTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ddsttype=",QRYNAME
          IF        @EQUAL
            PACK      DDSTTYPE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "returnid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETURNID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "showldsc=",QRYNAME
          IF        @EQUAL
            PACK      SHOWLDSC,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.
.------------------------------------------------------------------------------
. Set Parameters for Miscellaneous Charges Maintenance
.------------------------------------------------------------------------------
SMCHG000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
.
          BRANCH    F3,SMCHG001,SMCHG002,SMCHG003,SMCHG004
.
          IF        F3 = 34
            GOTO      SMCHG034
          ENDIF
          MOVE      ONE,EXIT
          GOTO      SMCHG999
.
SMCHG001  MOVE      QRYDATA,MSCHG001
          PACK      MSCHG001,MSCHG001,SP70
          GOTO      SMCHG999
.
SMCHG002  MOVE      QRYDATA,MSCHG002
          PACK      MSCHG002,MSCHG002,SP70
          GOTO      SMCHG999
.
SMCHG003  MOVE      QRYDATA,MSCHG003
          PACK      MSCHG003,MSCHG003,SP70
          GOTO      SMCHG999
.
SMCHG004  MOVE      QRYDATA,MSCHG004
          PACK      MSCHG004,MSCHG004,SP70
          GOTO      SMCHG999
.
.
.
SMCHG034  MOVE      QRYDATA,MSCHG034
          PACK      MSCHG034,MSCHG034,SP70
          GOTO      SMCHG999
.
SMCHG999  RETURN
.------------------------------------------------------------
. Set Item Date to YYMMDD
.------------------------------------------------------------
SETDAT00  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          UNPACK    KEY11,KEY8,KEY3
          MATCH     SP70,KEY3
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      KEY8,CCENT,CYEAR,CMON,CDAY
            REP       " 0",KEY8      
            PACK      RETURNDT,KEY8,SP70
          ELSE
            MOVE      QRYDATA,RETURNDT
          ENDIF
SETDAT99  RETURN
.------------------------------------------------------------
. Output Current Date
.------------------------------------------------------------
CURDTM00  CALL      XMLHED00
          BRANCH    EXIT,CURDTM99
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          CLOCK     TIME,CTIMEIS
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             "|",CTIMEIS:
                             "</RETURN_VALUE>"
          CALL      XMLEND00
CURDTM99  RETURN
.------------------------------------------------------------
. Validate Category/Codes
.------------------------------------------------------------
VALCOD00  CALL      XMLHED00
          BRANCH    EXIT,VALCOD99
.
          IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            BRANCH    OVRCD,VALCOD92
          ENDIF
.
          PACK      KEY5,VALDCODE,SP70
          CALL      RDCODE1 
          BRANCH    OVRCD,VALCOD90
          MATCH     "I",PTCOACTV
          GOTO      VALCOD91 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              MATCH    SP70,ACODE
              IF       !@EQUAL
                PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
                CALL     RDMLCOD1
                BRANCH   OVRCD,VALCOD93
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY40,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             TDESC,"|",KEY40,"|",THCSCOD,"|",TCFORM6:
                             "|",PTCDUDF3:
                             "</RETURN_VALUE>"
.
          GOTO      VALCOD98
.
VALCOD90  UNPACK    KEY5,KEY2,KEY3
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Code - ",KEY3:
                             " Category - ",KEY2,"</RETURN_VALUE>"
          GOTO      VALCOD98
.
VALCOD91  UNPACK    KEY5,KEY2,KEY3
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Code Inactive - ",KEY3:
                             " Category - ",KEY2,"</RETURN_VALUE>"
          GOTO      VALCOD98
.
VALCOD92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid User Id - ":
                             USERID,"</RETURN_VALUE>"
          GOTO      VALCOD98
.
VALCOD93  UNPACK    KEY5,KEY2,KEY3
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Hospital for Code - ",KEY3:
                             " Category - ",KEY2,"</RETURN_VALUE>"
          GOTO      VALCOD98
.
VALCOD98  CALL      XMLEND00
VALCOD99  RETURN
.------------------------------------------------------------
. Validate Doctor
.------------------------------------------------------------
VALDOC00  CALL      XMLHED00
          BRANCH    EXIT,VALDOC99
.
          IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            BRANCH    OVRCD,VALDOC96
          ENDIF
.
          IF        DOCTHOSP=1
            MOVE      MULTHOSP,WBSEHOSP
          ENDIF
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDDOCT1 
          BRANCH    OVRCD,VALDOC90
.
          IF        INACTFLG = 1
            GOTO      VALDOC85         * Return a flag for doctor status
          ENDIF
.                                      * Ignore inactive Doctors if req'd
          IF        VALDTYPE <> 99         
            BRANCH    DRSTAT,VALDOC91
          ENDIF
.
          IF        ATTFLAG<>1
            GOTO    VALDOC40
          ENDIF
.
          IF          DRSTAT=1
            GOTO      VALDOC95
          ENDIF
.
          IF          DRSTAT=2
            GOTO      VALDOC92
          ENDIF
.
VALDOC40  COMPARE   PRIVPRAC,ONE
          GOTO      VALDOC50 IF EQUAL       * For PP,skip Multihospital checks
.
          COMPARE   ONE,IBCNMHOS
          GOTO      VALDOC50 IF NOT EQUAL   * not multihospital
.
VALDOC45  MATCH     SP70,WBSEOCG
          IF        !@EQUAL
            PACK      KEY5,catw0,WBSEOCG,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     "E",TCINDC1
              GOTO      VALDOC50 IF EQUAL        * skip hospital check for ETS
            ENDIF
          ENDIF
.
          MATCH    "1",PTDOHOSS
          IF       @EQUAL
            PACK     KEY13,WBSEHOSP,DCODE,SP70
            CALL     RDMLHCP1
            BRANCH   OVRCD,VALDOC97
            MATCH    "1",MLHCACTV
            GOTO     VALDOC97 IF EQUAL      * only active hospitals
          ELSE
            MATCH    "1",PTCNMHCP           * Only show matching hospitals
            GOTO     VALDOC97 IF EQUAL
          ENDIF
.
VALDOC50  CALL      DOCNAM00
.
VALDOC80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",DRTYPE:
                             "</RETURN_VALUE>"
          GOTO      VALDOC98
.
VALDOC85  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",DRSTAT,"|",DRTYPE:
                             "</RETURN_VALUE>"
          GOTO      VALDOC98
.
VALDOC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Doctor Code - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALDOC98
.
VALDOC91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Doctor Inactive - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALDOC98
.
VALDOC92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Doctor is not valid for admitting - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALDOC98
.
VALDOC95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Doctor Status - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALDOC98
.
VALDOC96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid User Id - ":
                             USERID,"</RETURN_VALUE>"
          GOTO      VALDOC98
.
VALDOC97  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Hospital for Doctor Code - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALDOC98
.
VALDOC98  CALL      XMLEND00
.
VALDOC99  MOVE      ZERO,ATTFLAG
          MOVE      ZERO,INACTFLG
          RETURN
.------------------------------------------------------------
. Validate Item
. VALDTYPE = 0 - validate MBS Item code
.            1 - validate Theatre/Misc.Item and Item date
.            2 - validate Item Date only
.            3 - validate Misc Item only
.            4 - validate MBS Item Code for Outpatient Visit
.            5 - validate Misc Item only (read adm.file) for Elg.Check
.------------------------------------------------------------
VALITM00  CALL      XMLHED00
          BRANCH    EXIT,VALITM99
.
          MOVE      SP70,KEY65
          COMPARE   TWO,VALDTYPE
          GOTO      VALITM78 IF EQUAL  * validate item date only
.
          MOVE      ZERO,MBSFLAG       * Default to Misc.item
          MOVE      "0",AMTFLAG        * Default to 'Can Not change amount'
          MOVE      ZERO,EXCLITM       * Default to 'Not an exclusion list item'
          MOVE      ZERO,ITMCHGE       * Default to 'Item has not been changed'
          MOVE      ZERO,PROSITM       * Default to 'Not a Prosthetic item'
          MOVE      ZERO,VALMBSIA      * Default to 'Not Inactive MBS code'
          MOVE      ZERO,CMIXFLAG
.
          COMPARE   FIVE,VALDTYPE
          GOTO      VALITM01 IF NOT EQUAL
.
          PACK      KEY8,VALDADNO,VALDADNO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,VALITM95
.
          GOTO      VALITM10           * validate miscellaneous item only
.
VALITM01  COMPARE   THREE,VALDTYPE
          GOTO      VALITM10 IF EQUAL  * validate miscellaneous item only
.
          PACK      KEY9,VALDCODE,SP70
          PACK      VALDEDAT,VALDEDAT,SP70
          PACK      KEY17,KEY9,VALDEDAT,SP70
          CALL      PATITMRD
          COMPARE   ZERO,EXIT
          GOTO      VALITM02 IF EQUAL
.
          MOVE      WKITINAC,INVALDFL       * inactive
          MOVE      WKITEXDT,INVALDAT       * date range error
.
          BRANCH    INVALDFL,VALITM91
          BRANCH    INVALDAT,VALITM9A
.
          GOTO      VALITM10       * check if it's a valid drg or misc.item
.
VALITM02  COMPARE   "1",WKITINAC
          GOTO      VALITM04 IF EQUAL        * item is inactive, check the link
.
          BRANCH    VALDTYPE,VALITM30        * validate Theatre item/Misc.
.
          MATCH     "1",PTITIWRN
          IF        @EQUAL
            MOVE      ONE,PROSITM          * Prosthetic may need to be entered
          ENDIF
.
          OPEN      OPRDETA1,"oprdetaf"
          PACK      KEY26,CASEKEYS,SP70
          CALL      RDOPDEA1
          IF        OVRCD=0
            MOVE      OPDAADMN,KEY8
            CALL      RDVISA1
            IF        OVRCD=0 & PVITYPE=3
              CALL      RDMISS1            * read adm file to get adm type
            ENDIF
          ENDIF
          MOVE      VALDCODE,ITCODE
.
.-------- VALDTYPE=4 Validate MBS item code for O/P visit type  *T0859743
          IF        PVITYPE=2 & VALDTYPE=4
            GOTO      VALITM40 
          ENDIF 
.
          GOTO      VALITM32
.
VALITM04  COMPARE   ZERO,VALDTYPE
          GOTO      VALITM91 IF EQUAL         * Display error item is inactive
.
          MOVE      ONE,VALMBSIA              * Setting MBS Code Inactive Flag
          CALL      LNKITM00                  * Check with the linked MBS item
          BRANCH    EXIT,VALITM91             * Display error item is inactive
          GOTO      VALITM30                  * Valid MBS item
.
.      Not a valid MBS item, check if it's a DRG code before checking for Misc.
.
VALITM10  COMPARE   ZERO,VALDTYPE
          GOTO      VALITM90 IF EQUAL        * invalid MBS item
.
          COMPARE   FIVE,VALDTYPE
          GOTO      VALITM11 IF EQUAL
.
          CALL      VDAT0000                 * Validate item date
          BRANCH    EXIT,VALITM98
.
VALITM11  IF        IBCNMHOS=1
            MOVE      SP1,PTHSTFEE
            MOVE      SP10,PTHSDCLM
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1
          ENDIF
.
          PACK      MCHARGE,VALDCODE,SP70
          PACK      DIM10,VALDCODE,SP70                              *T0859743
.
          COMPARE   ONE,IBCNUGST
          GOTO      VALITM12 IF NOT EQUAL
          PACK      KEY9,CGSTITEM,SP10       * check against GST item code
          MATCH     MCHARGE,KEY9
          GOTO      VALITM92 IF EQUAL        * can not use GST Item code
.
VALITM12  IF        IBCNMHOS=1
            MATCH     "1",PTHSTFEE
            GOTO      VALITM20 IF NOT EQUAL  * Hosp not using theatre fees file
          ELSE
            COMPARE   ZERO,PTCNTFEE
            GOTO      VALITM20 IF EQUAL      * Not using theatre fees file
          ENDIF
.
          IF        CMIXFLAG=1
            CALL      CDRG0000               * Check if it's a valid DRG code
            BRANCH    EXIT,VALITM20          * Check if it's a valid misc.item
            MOVE      TWO,MBSFLAG            * valid drg code
            PACK      TSRVDATE,VALDEDAT,SP70 * Service date
            CALL      GENTFE00               * Get theatre fees
            IF        CMIXFLAG=1
              IF        EXIT=1
                MOVE      ZERO,TFHF1
                MOVE      ZERO,TFPAT1
                MOVE      ZERO,PTCTDPAT
                MOVE      ZERO,PTCTDREB
                MOVE      ZERO,QIAMT
              ENDIF
            ELSE
              BRANCH    EXIT,VALITM80
            ENDIF
            MOVE      "0",KEY1               * Warning message
            MOVE      SP10,KEY20
            GOTO      VALITM72
          ENDIF
.
.         Checking for miscellaneous item code
.
VALITM20  IF        CFEETYP=5
            CALL      NZPMSC00
            BRANCH    EXIT,VALITM94
            IF        NZMCCHGT=1 & NZMCPATP=0
              CALL      NZPAC000                 * Get the item total
            ENDIF
          ELSE
            CALL      GETMSC00                 * get misc.charge 
            BRANCH    WKMCXXDT,VALITM97        * out of date range
            BRANCH    WKMCINAC,VALITM96        * item is inactive
.           BRANCH    INVALDFL,VALITM96
            BRANCH    VALMBSIA,VALITM96        * MBS is Inactive
            BRANCH    INVALDFL,VALITM95        * Invalid Item
          ENDIF
          IF        REGIMFLG=1
            BRANCH    EXIT,VALITM50
          ELSE
            BRANCH    EXIT,VALITM94
          ENDIF
          IF        CFEETYP=5
            PACK      KEY90,NZMCDESC,SP70
          ENDIF
.
.      We have a valid Miscellaneous item code
.      Check if this a H.F.Adjustment Code (should not allow,input the code)
.
          IF        MITMTYP=3
            IF        QIAMT=0
              COMPARE   ZERO,MPATPOR
              GOTO      VALITM93 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MATCH     ANSY,PTMCKREB
          IF        @EQUAL
            MOVE      "1",AMTFLAG          * amount can be changed
          ENDIF
          MOVE      "0",KEY1               * Warning message
          MOVE      SP10,KEY20
          GOTO      VALITM72
.
.         We have a valid MBS item code, check if the theatre fees setup
.
VALITM30  CALL      VDAT0000               * Validate item date
          BRANCH    EXIT,VALITM98
.
          IF        IBCNMHOS=1
            MOVE      SP1,PTHSTFEE
            MOVE      SP10,PTHSDCLM
            PACK      KEY3,PMVXMHOS,SP10
            CALL      RDPTHSP1
          ENDIF
.
          COMPARE   THREE,PVITYPE
          GOTO      VALITM90 IF NOT EQUAL  * not an inpatient
.
          MOVE      ONE,MBSFLAG            * Valid MBS item
          MOVE      VALDCODE,ITCODE
          MOVE      PTITGSTA,PTMCGSTA      * GST applicable
          MOVE      PTITGSTC,PTMCGSTC      * GST Code
.
          PACK      TSRVDATE,VALDEDAT,SP70 * Service date
          CALL      GENTFE00               * Get theatre fees
          IF        CMIXFLAG=1
            IF        EXIT=1
              MOVE      ZERO,TFHF1
              MOVE      ZERO,TFPAT1
              MOVE      ZERO,PTCTDPAT
              MOVE      ZERO,PTCTDREB
              MOVE      ZERO,QIAMT
            ENDIF
          ELSE
            BRANCH    EXIT,VALITM80
          ENDIF
.
.         Check the suggested classification - 
.         Return value KEY1 (type of warning msg)
.            1 - Admission type should be xxxx
.            2 - Invalid Suggested Admission type
.            3 - Item has been entered in previous invoice
.            4 - Possible admission type changed
.            5 - Possible admission type changed and item entered
.            6 - Adm type of the patient is excluded from auto adm type update
.         Return value KEY20 (Code Description of suggestion admission type)
.
VALITM32  MOVE      SP1,KEY1
          MOVE      SP70,KEY3              * variable for new suggested admtype
          PACK      ADATE,VALDEDAT,SP70
          PROC      CHKSUGCL        
.
          MOVE      KEY3,ATYPE
          IF        PVITYPE=3
            PACK      KEY5,ANSA,SP1,ATYPE  * use the new suggested adm type
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     ANSX,TCINDC7
              IF        @EQUAL
                MOVE      "6",KEY1         * Exclude this adm type from auto
                GOTO      VALITM40
              ENDIF
            ENDIF
          ENDIF
.
VALITM40  IF        PTITEXCL=1
            MOVE      PTITEXCL,EXCLITM     * exclusion list item flag
          ENDIF
.
          MATCH     "1",PTITIWRN
          IF        @EQUAL
            MOVE      ONE,PROSITM          * Prosthetic may need to be entered
          ENDIF
          MOVE      TFPAT1,MPATPOR        * patient portion
          MOVE      TFHF1,MHFPOR          * health fund portion
          BRANCH    VALDTYPE,VALITM72,VALITM72
.
          MOVE      "cr",CATEGORY
          MOVE      PTITTCER,CODE
          CALL      GETCOD00
.
          MATCH     "R",TCINDC2
          IF        !@EQUAL
            PACK      PTCDLDES,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTITDESC,"|",QIAMT,"|",PTITGSTA,"|",PTITGSTC:
                             "|",ICLSS,"|",PTITEXCL,"|",PROSITM,"|",KEY1:
                             "|",KEY20,"|",ATYPE,"|",PTITDCSC,"|",PTCDLDES:
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM50  PACK      DIM10,VALDCODE,SP70
          PACK      KEY13,DIM10,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,VALITM95
.         
          MOVE      PMREDESC,PTITDESC
          MOVE      ZERO,QIAMT
          MOVE      ZERO,MINDIC
          MOVE      ZERO,AMTFLAG
          MOVE      ZERO,EXCLITM
          MOVE      ZERO,ITMCHGE
          MOVE      ZERO,PROSITM
          MOVE      THREE,MBSFLAG
          MOVE      ZERO,KEY1
          MOVE      SP70,KEY20
          MOVE      ZERO,PTMCGSTA
          MOVE      SP70,PTMCGSTC
          MOVE      ZERO,MPATPOR
          MOVE      ZERO,MHFPOR
          MOVE      SP70,ATYPE
          MOVE      SP70,PTMCKREB
.
          GOTO      VALITM72
.
VALITM72  MATCH     SP70,KEY90
          IF        @EQUAL
            PACK      KEY90,PTITDESC,SP70
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTITDESC,"|",QIAMT,"|",MINDIC,"|",AMTFLAG:
                             "|",EXCLITM,"|",ITMCHGE,"|",PROSITM,"|",MBSFLAG:
                             "|",KEY1,"|",KEY20,"|",PTMCGSTA,"|",PTMCGSTC:
                             "|",MPATPOR,"|",MHFPOR,"|",ATYPE,"|",PTMCKREB:
                             "|",KEY90:
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM78  CALL      VDAT0000                 * Validate item date
          BRANCH    EXIT,VALITM98
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DDATE:
                             "</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM80  IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Theatre Fees ",KEY9:
                               " Not Setup for Claim code ":
                               PTHSDCLM,"</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Theatre Fees ",KEY9:
                               " Not Setup for Claim code ":
                               PTCNDCLM,"</RETURN_VALUE>"
          ENDIF
          GOTO      VALITM98
.
VALITM90  BRANCH    INVALDFL,VALITM91
          BRANCH    INVALDAT,VALITM9A
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid MBS Item Code - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM9A  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "This MBS Item ",KEY9," is not active for the ":
                             "date range selected":
                             "</RETURN_VALUE>"
          GOTO      VALMSC98
.
VALITM91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Item - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "GST Item. May Not Use.  - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Not Allow adjusting H.F. Portion.  - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM94  IF        CFEETYP=5
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "The Item ",KEY9," is not active for the date of ":
                               "the charge.</RETURN_VALUE>"
            GOTO      VALITM98
          ENDIF
.
          IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Misc.Item ",KEY9," Not Setup for Claim code ":
                                PTHSDCLM,"</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Misc.Item ",KEY9," Not Setup for Claim code ":
                                PTCNDCLM,"</RETURN_VALUE>"
          ENDIF
          GOTO      VALITM98
.
VALITM95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Item Code - ":
                              DIM10,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Misc.Item is Inactive - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM97  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Misc.Item out of Date - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALITM98
.
VALITM98  CALL      XMLEND00
VALITM99  RETURN
.
.------------------------------------------------------------
. Check for the linked MBS item
.------------------------------------------------------------
LNKITM00  MOVE      ZERO,EXIT
LNKITM10  MATCH     SP9,PTITLINK
          GOTO      LNKITM90 IF EQUAL         * Display error item is inactive
.
.         Check the linked MBS code,make sure it exists
.
          PACK      KEY17,PTITLINK,VALDEDAT,SP70 *use linked MBS code as the key
          CALL      PATITMRD
          BRANCH    OVRCD,LNKITM90           * no linked MBS record
.
          MOVE      WKITINAC,INVALDFL       * inactive
          MOVE      WKITEXDT,INVALDAT       * date range error
.
.         The linked MBS code exists. Check if this new MBS code is active
.
          COMPARE   ZERO,WKITINAC            * new MBS code active ?
          GOTO      LNKITM10 IF NOT EQUAL    * no -> check for a linked MBS
.
          MOVE      ONE,ITMCHGE              * warning to Item has been changed
          MOVE      ITEMNO,VALDCODE
          MOVE      ZERO,EXIT
          GOTO      LNKITM99
.
LNKITM90  MOVE      ONE,EXIT
LNKITM99  RETURN
+
.------------------------------------------------------------
. Generate theatre fees
.------------------------------------------------------------
GENTFE00  MOVE      ZERO,EXIT
          COMPARE   TWO,MBSFLAG 
          GOTO      GENTFE12 IF EQUAL      * DRG code
.
          IF        IBCNMHOS=1
            MATCH     "1",PTHSTFEE
            GOTO      GENTFE10 IF EQUAL    * Hosp using theatre fees file
          ELSE
            BRANCH    PTCNTFEE,GENTFE10    * using theatre fees
          ENDIF
.
          MOVE      ONE,TFNINV
          MOVE      ZERO,TFHF1
          MOVE      ZERO,TFPAT1
          IF        CMBSFEE=1
            MOVE      QIAMT,TFPAT1        * use MBS item amount
          ENDIF
          GOTO      GENTFE40
.
GENTFE10  COMPARE   ONE,CMIXFLAG
          GOTO      GENTFE30 IF NOT EQUAL
.
GENTFE12  MOVE      VALDCODE,TITEMNO
          MOVE      ONE,PTCTITMS           * Default to the first
          CALL      CMGETTHR               * Get theatre casemix funding
          BRANCH    OVRCD,GENTFE90
.
          MOVE      ONE,TFNINV
          MOVE      PTCTDREB,TFHF1
          MOVE      PTCTDPAT,TFPAT1
          GOTO      GENTFE40
.
GENTFE30  MOVE      ZERO,CNTRCEFR
          MOVE      RETURNDT,CEFFDATE
          PACK      KEY18,ACLAIM,AFUNDH,AFNDTB,DAYCASE,SP5
          CALL      GETTFEES                 * get theatre fees amount
          BRANCH    EXIT,GENTFE90
.
GENTFE40  MOVE      ZERO,MINDIC             * MBS item can not change desc.
          MOVE      ZERO,AMTFLAG            * MBS item can not change amount
          MOVE      TFHF1,QIAMT
          ADD       TFPAT1,QIAMT
          MOVE      ZERO,EXIT
          GOTO      GENTFE99
.
GENTFE90  MOVE      ONE,EXIT
GENTFE99  RETURN
.
.------------------------------------------------------------
. If this is casemix funding - check that it is a valid DRG Code
.------------------------------------------------------------
CDRG0000  MOVE      SP10,KEY4,KEY5
          UNPACK    MCHARGE,KEY4,KEY5
          MATCH     SP5,KEY5
          GOTO      CDRG9000 IF NOT EQUAL  * Not a DRG Code ?
.
          OPEN      PATDGWA1,"patdgwaf"
          MOVE      "999",KEY3
          PACK      KEY7,KEY4,KEY3,SP10   * last DRG version          *I-137125
          CALL      RSPTDGW1
          CALL      RPPTDGW1              * Valid DRG code ?
.         CLOSE     PATDGWA1
          BRANCH    OVRCD,CDRG9000        * It might be a valid misc charge
          MATCH     PTDWDRGC,KEY4         * same DRG code ?           *I-137125
          GOTO      CDRG9000 IF NOT EQUAL                             *I-137125
.
          MOVE      ZERO,MPATPOR
          MOVE      ZERO,MHFPOR
          MOVE      PTDWDESC,PTITDESC
          MOVE      ZERO,EXIT
          GOTO      CDRG9999
.
CDRG9000  MOVE      ONE,EXIT
CDRG9999  RETURN
+
.------------------------------------------------------------
. Validate DRG
.------------------------------------------------------------
VALDRG00  CALL      XMLHED00
          BRANCH    EXIT,VALDRG99
          MOVE      VALDCODE,KEY4
          MOVE      "999",KEY3
          PACK      KEY7,KEY4,KEY3,SP10   * last DRG version          *I-137125
          CALL      RSPTDGW1
          CALL      RPPTDGW1
          BRANCH    OVRCD,VALDRG90
          MATCH     PTDWDRGC,KEY4           * same DRG code ?         *I-137125
          GOTO      VALDRG90 IF NOT EQUAL                             *I-137125
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTDWDESC:
                             "</RETURN_VALUE>"
          GOTO      VALDRG98
.
VALDRG90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid DRG - ":
                              KEY4,"</RETURN_VALUE>"
          GOTO      VALDRG98
.
VALDRG98  CALL      XMLEND00
VALDRG99  RETURN
.------------------------------------------------------------
. Validate Casemix Code
.------------------------------------------------------------
VALCMC00  CALL      XMLHED00
          BRANCH    EXIT,VALCMC99
          MOVE      VALDCODE,KEY9
          CALL      RDPTCMC1
          BRANCH    OVRCD,VALCMC90
.
          COMPARE   ONE,PTCAACTV            * Is selected code Active?
          GOTO      VALCMC80 IF NOT EQUAL   * No, return error
.          
          MOVE      SP70,KEY4
          PACK      DIM60,SP70
          PACK      DIM60,PTCADES1,SP1,PTCADES2
.
          MATCH     "1",PTCNELOS
          GOTO      VALCMC70 IF EQUAL       * No Default
.
          MATCH     "2",PTCNELOS
          GOTO      VALCMC10 IF EQUAL       * Using Claim type,HF,Casemix code
.
          MOVE      PTCAELOS,KEY4
          SQUEEZE   KEY4
.
          GOTO      VALCMC70
.
.         Validate Casemix code based on Claim code, Health fund
.
VALCMC10  PACK      VALDCLMT,VALDCLMT,SP70
          PACK      VALDHLFN,VALDHLFN,SP70
          MATCH     SP70,VALDCLMT
          GOTO      VALCMC70 IF EQUAL       * blank claim code
.
          PACK      KEY9,VALDCLMT,VALDHLFN,SP70
          MATCH     SP70,KEY9
          GOTO      VALCMC70 IF EQUAL
.
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,VALCMC70
.
          COMPARE   TWO,CNTRCEFR
          GOTO      VALCMC70 IF EQUAL      * invalid - using Disc. from
.
          PACK      VALBCODE,VALBCODE,SP70
          UNPACK    VALBCODE,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00              * Set CMON from MTHNAM3
          PACK      VALDCEFF,CCENT,CYEAR,CMON,CDAY
          REP       " 0",VALDCEFF
          MOVE      VALDCEFF,CEFFDATE     * Contract Effective Date
.
          UNPACK    SP70,KEY3,KEY6
          UNPACK    VALDCLMT,KEY3
          UNPACK    VALDHLFN,KEY6
          UNPACK    VALDCODE,KEY9
.
          MOVE      SP70,KEY4
          PACK      KEY18,KEY3,KEY6,KEY9,SP70
          OPEN      PATCMXA1,"patcmxaf"
          PACK      KEY24,KEY18,SP30
          CALL      RSPTCMX1
VALCMC20  CALL      RKPTCMX1
          BRANCH    OVRCD,VALCMC70
.
          PACK      SKEY18,PTCMCLMN,PTCMHFND,PTCMCASM,SP70
          MATCH     KEY18,SKEY18
          GOTO      VALCMC70 IF NOT EQUAL
.
          MOVE      PTCMCNID,KEY6
          CALL      VALCONTR
          BRANCH    EXIT,VALCMC20
.
          MOVE      PTCMTLOS,KEY4
          SQUEEZE   KEY4
.
VALCMC70  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DIM60,"|",*+,KEY4:
                             "</RETURN_VALUE>"
          GOTO      VALCMC98
.
VALCMC80  COMPARE   ONE,PTCNHDPS            * is it NZ ?
          IF        @EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Inactive Contract Procedure Code - ":
                                KEY9,"</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Inactive Casemix Code - ":
                                KEY9,"</RETURN_VALUE>"
          ENDIF
          GOTO      VALCMC98
.
VALCMC90  COMPARE   ONE,PTCNHDPS            * is it NZ ?
          IF        @EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Invalid Contract Procedure Code - ":
                                KEY9,"</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Invalid Casemix Code - ":
                                KEY9,"</RETURN_VALUE>"
          ENDIF
          GOTO      VALCMC98
.
VALCMC98  CALL      XMLEND00
VALCMC99  RETURN
.------------------------------------------------------------
. Validate Insurance Code
.------------------------------------------------------------
VALINS00  CALL      XMLHED00
          BRANCH    EXIT,VALINS99
.
          MOVE      VALDCODE,KEY6
          CALL      RDINSR1
          BRANCH    OVRCD,VALINS90
.
          MATCH     "1",PTINACTV
          GOTO      VALINS90 IF EQUAL
.
          BRANCH    VALDTYPE,VALINS10
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             INAME:
                             "</RETURN_VALUE>"
          GOTO      VALINS98
.
VALINS10  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             INAME,"|",IADD1,"|",IADD2,"|",IADD3,"|":
                             IADD4,"|",IPOST,"|",ICONT,"|",ITELEB,"|",PTINFAXN:
                             "</RETURN_VALUE>"
          GOTO      VALINS98
.
VALINS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Insurance Code - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALINS98
.
VALINS98  CALL      XMLEND00
VALINS99  RETURN
.------------------------------------------------------------
. Validate ICD Disease
. Parameter -USNGICD9 : Validate ICD9 Disease Code
.------------------------------------------------------------
VALICD00  CALL      XMLHED00
          BRANCH    EXIT,VALICD99
.
          BRANCH    USNGICD9,VALICD10      * Validate ICD9? 
.
          MOVE      SP70,ICDRDDTE          * Set ICD10 date   * start *I-226826
.
          MATCH     SP70,ICD10DAT
          IF        !@EQUAL
            MOVE      ICD10DAT,ICDRDDTE    * Set ICD10 date
          ENDIF                                               * end   *I-226826
.
          MOVE      VALDCODE,KEY9          * Validate ICD10      
          CALL      RDPTICD1 
          BRANCH    OVRCD,VALICD90
.
          MATCH     SP70,PT0DDSC2
          IF        !@EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               PT0DDSC2:
                               "</RETURN_VALUE>"
          ELSE
                      WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DDESC:
                             "</RETURN_VALUE>"
          ENDIF
.
          GOTO      VALICD98
.
VALICD10  MOVE      VALDCODE,KEY9     * Validate ICD9
          CALL      RD10T9D1
          BRANCH    OVRCD,VALICD91
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DDESC:
                             "</RETURN_VALUE>"
          GOTO      VALICD98
.
VALICD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ICD10 Disease Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICD98
.
VALICD91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ICD9 Disease Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICD98
.
VALICD98  CALL      XMLEND00
VALICD99  RETURN
.------------------------------------------------------------
. Validate ICD Procedure
. Parameter -USNGICD9 : Validate ICD9 Procedure Code
.------------------------------------------------------------
VALICO00  CALL      XMLHED00
          BRANCH    EXIT,VALICO99
.
VALICO05  BRANCH    USNGICD9,VALICO10       * Validate ICD9?
.
          MOVE      SP70,ICDRDDTE          * Set ICD10 date
.
          MATCH     SP70,ICD10DAT
          IF        !@EQUAL
            MOVE      ICD10DAT,ICDRDDTE    * Set ICD10 date
          ENDIF
.
          MOVE      VALDCODE,KEY9           * Validate ICD10
          CALL      RDPTICO1 
          BRANCH    OVRCD,VALICO90
.
          MATCH     "P",OFLAG
          GOTO      VALICO91 IF NOT EQUAL
.
          MATCH     SP70,PT0ODSC2
          IF        !@EOS & !@EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               PT0ODSC2,"|",OSEX,"|",OAREA,"|",OAGEGP,"|":
                               OLOW,"|",OHIGH,"|",PT0O2AGP,"|",PT0O2ALL,"|":
                               PT0O2AHL:
                               "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               ODESC,"|",OSEX,"|",OAREA,"|",OAGEGP,"|":
                               OLOW,"|",OHIGH,"|",PT0O2AGP,"|",PT0O2ALL,"|":
                               PT0O2AHL:
                               "</RETURN_VALUE>"
          ENDIF
.
          GOTO      VALICO98
.
VALICO10  MOVE      VALDCODE,KEY9     * Validate ICD9
          CALL      RD10T9O1
          BRANCH    OVRCD,VALICO92
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ODESC:
                             "</RETURN_VALUE>"
          GOTO      VALICO98
.
VALICO90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ICD10 Procedure Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICO98
.
VALICO91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Procedure Prefix not Posting - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICO98
.
VALICO92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ICD9 Operation Code - ":
                             KEY9,"</RETURN_VALUE>"
          GOTO      VALICO98
.
VALICO98  CALL      XMLEND00
          MOVE      SP70,ICDRDDTE          * Clear ICD10 date
VALICO99  RETURN
.------------------------------------------------------------
. Validate Patient U/R
.------------------------------------------------------------
VALPUR00  CALL      XMLHED00 
          BRANCH    EXIT,VALPUR99
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,VALPUR90
.
          MOVE      ZERO,MERGEDFL                * Set merged flag to no
          MOVE      VALDCODE,KEY8
          CALL      RDMAST1
          COMPARE   ZERO,OVRCD
          GOTO      VALPUR40 IF EQUAL
          RJUSTIFY  KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALPUR90
.
VALPUR40  CALL      RDPMPX21
          BRANCH    OVRCD,VALPUR90   * New U/R number missing
.
          CALL      GETHFN00
.
          COMPARE   TWO,VTYPFLAG
          GOTO      VALPUR60 IF EQUAL * do not check U/R link for M/R Merge
.
          COMPARE   ONE,PSTAT
          GOTO      VALPUR60 IF NOT EQUAL
.
VALPUR50  MOVE      PPSNAME,KEY8     * This is where the new U/R is hidden
          CALL      RDMAST1          * Read in the new PMI record
          BRANCH    OVRCD,VALPUR90   * New U/R number missing
          BRANCH    PSTAT,VALPUR50   * Another associated U/R number
.
          CALL      RDPMPX21
          BRANCH    OVRCD,VALPUR90   * New U/R number missing extension
.
          MOVE      ONE,MERGEDFL     * Set merged flag to yes
.
VALPUR60  IF        VTYPFLAG=3       
            MATCH     "1",PTCNRCAR
            IF        @EQUAL
              CALL      GETVIS00
            ELSE  
              CALL      RECATR00       * Recurring Care 
              IF        EXIT=1
                CALL      GETVIF00
              ENDIF
            ENDIF
          ELSE
            CALL      GETVIS00
          ENDIF
.
          IF        VTYPFLAG=3
            CALL      CHKGP000       * Check GP is active
            BRANCH    EXIT,VALPUR91,VALPUR92
          ENDIF
          CALL      PATNAA00
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      FMTAGE00      * Format age
          CALL      FMTSEX00      * Format Sex
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DOBDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,RPERDESC
          MATCH     SP70,PMPXRPER
          IF        !@EQUAL
            PACK      KEY5,CATrt,PMPXRPER,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,RPERDESC
            ENDIF
          ENDIF
.
          MOVE      SP70,RPERDATE
          MATCH     SP70,PMPXRDAT
          IF        !@EQUAL
            UNPACK    PMPXRDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      RPERDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          PROC      UPDLSTUR           * add to last 20 UR's
          CALL      CHGP0000           * set gpaccess flag
.
          BRANCH    RETURNFM,VALPUR70,VALPUR80,VALPUR85,VALPUR86
.
          PACK      KEY8,DPVIBILL,SP70              * Emergency Visit
          CALL      RDEMVIS1
          IF        OVRCD=1
            MOVE      SP70,EMVISITE
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",FMTSEX,"|",DOBDATE,"|",PCEASE,"|":
                             PURNO,"|",LASTVIST,"|",LASTVDAT,"|",LASTVTYP,"|":
                             FMTAGE,"|",PMEDI,"|":
                             PADD1,"|",PADD2,"|",PSUBRB,"|",PADD4,"|",PPOST,"|":
                             MERGEDFL,"|",PSNAME,"|,",PGNAME,"|",PMPXIHOS:
                             "|",WBSEHOSP,"|",GPACCESS,"|",EMVISITE,"|":
                             RPERDESC,"|",RPERDATE,"|",PSEX,"|",PMPXPFGN,"|":
                             PMPXPFSN,"</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR70  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PURNO,"|",PSNAME,"|",PGNAME,"|",PTITL,"|",PSEX,"|":
                             DOBDATE,"|",PCEASE,"|",FMTAGE,"|",PMEDI,"|":
                             PADD1,"|",PADD2,"|",PSUBRB,"|",PADD4,"|",PPOST:
                             "|",PMPXIHOS,"|",WBSEHOSP,"|",GPACCESS,"|":
                             PFUNDH,"|",HLFNDDSC,"|",PFNDTB,"|",HLFNTDSC,"|":
                             PFNDMM,"</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR80  MOVE      ZERO,MDRECFLG
          PACK      KEY17,PURNO,SP70
          CALL      RSMRMAS3
          CALL      RKMRMAS3               * Read MRT Master File
          BRANCH    OVRCD,VALPUR81
.
          MATCH     PURNO,MRMAURNO
          GOTO      VALPUR81 IF NOT EQUAL 
.
          MOVE      ONE,MDRECFLG           * Medical Record Still Exists    
.
VALPUR81  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",PSTAT,"|",PPSNAME,"|",MDRECFLG:
                             "|",PMPXIHOS,"|",WBSEHOSP,"</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR85  MATCH     "1",RCCNDREF            * Default name to receipt reference
          IF        @EQUAL
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,DIM1
            PACK      PACGNAME,DIM1,SP20
            MOVE      PTITL,PACTITLE
            MOVE      ONE,PACFRMT
            CALL      PACNAME
            REP       UPPLOW,PACFNAME
          ELSE
            MOVE      SP70,PACFNAME
          ENDIF

          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",PACFNAME:
                             "</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR86  MOVE      SP70,TDESC
          MATCH     "1",PMPXINTR
          IF        @EQUAL
            MATCH     SP70,PMPXLNG1
            IF        !@EQUAL
              PACK      KEY5,ANSL,ANSA,PMPXLNG1,SP70
              CALL      RDCODE1
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",PMPXINTR,"|",TDESC:
                             "</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient UR - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Last Admission - ",AADMNO:
                             " has an Invalid Responsible Clinician":
                             "</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Last Admission - ",AADMNO:
                             " has an Invalid Referring Clinician":
                             "</RETURN_VALUE>"
          GOTO      VALPUR98
.
VALPUR98  CALL      XMLEND00
VALPUR99  RETURN
.
.-------------------------------------------------------------------------------
. Check if PTARTYPE type 025 exists, if it is , use this admission for 
. defaulting if it is still valid
.-------------------------------------------------------------------------------
RECATR00  MOVE      ZERO,EXIT
          MOVE      SP70,LASTVIST
          MOVE      SP70,LASTVDAT
          MOVE      SP70,LASTVTYP
          MOVE      "025",ATRTYPE
          PACK      KEY35,PURNO,SP8,ATRTYPE,Z70
          CALL      RSPTATR3
RECATR02  CALL      RPPTATR3
          BRANCH    OVRCD,RECATR90
.
          MATCH     PURNO,PTARURNO
          GOTO      RECATR90 IF NOT EQUAL
.
          MATCH     SP70,PTARVISN
          GOTO      RECATR90 IF NOT EQUAL
.
          MATCH     ATRTYPE,PTARTYPE
          GOTO      RECATR02 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      RECATR02 IF EQUAL
.
          MOVE      PTARTXT1,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,RECATR90
.
          COMPARE   "3",PVITYPE
          GOTO      RECATR02 IF NOT EQUAL
.
          MATCH     "1",PTCNUHSC
          IF        @EQUAL
            PACK      KEY8,DPVIBILL,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MATCH     PMVXMHOS,WBSEHOSP
              GOTO      RECATR02 IF NOT EQUAL
            ENDIF
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,RECATR02
.
          COMPARE   "3",ASTAT
          GOTO      RECATR02 IF NOT EQUAL
.
          CALL      MVIS0000        * check if match for recurring 
          BRANCH    EXIT,RECATR02 
.
RECATR50  MOVE      PVIBILL,LASTVIST
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTVDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          LOAD      LASTVTYP,PVITYPE,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8
.
          MOVE      ZERO,EXIT 
          GOTO      RECATR99
.
RECATR90  MOVE      ONE,EXIT
.
RECATR99  RETURN
.
.------------------------------------------------------------------------
.  Check GP and doctor on selected visit is active
.------------------------------------------------------------------------
CHKGP000  MOVE      ZERO,EXIT
          MATCH     SP70,ADOCTA
          GOTO      CHKGP900 IF EQUAL
.
          PACK      KEY6,ADOCTA,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,CHKGP900
.
          COMPARE   ZERO,DRSTAT
          GOTO      CHKGP900 IF NOT EQUAL
.
          MATCH     SP70,PMVXRHC1
          GOTO      CHKGP999 IF EQUAL
.
          PACK      KEY10,PMVXRHC1,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,CHKGP910
.
          MATCH     "1",PMHCSTTS
          GOTO      CHKGP910 IF EQUAL
.
          GOTO      CHKGP999
.
CHKGP900  MOVE      ONE,EXIT
          GOTO      CHKGP999
.
CHKGP910  MOVE      TWO,EXIT
          GOTO      CHKGP999
.
CHKGP999  RETURN
+
.------------------------------------------------------------------------
.  Check for GP Access on websecaf
.------------------------------------------------------------------------
CHGP0000 MOVE       ZERO,GPACCESS
         MOVE       SP70,GPCODE
         MOVE       SP70,PRACTICE
.
         MATCH      SP70,WBSEGPAC
         GOTO       CHGP9999 IF EQUAL
.
         MATCH      "1",WBSEGPAC           * using registered gp
         IF         @EQUAL
           PACK       GPCODE,PMPXRHC1,SP70
           PACK       PRACTICE,PMPXRH1G,SP70
         ENDIF
.
         MATCH      "2",WBSEGPAC           * using verified gp
         IF         @EQUAL
           PACK       GPCODE,PMPXVGPC,SP70
           PACK       PRACTICE,PMPXVGPP,SP70
         ENDIF
.
         MATCH      GPCODE,WBSEGPCD
         GOTO       CHGP9999 IF EQUAL
.
         MATCH      SP70,PRACTICE
         GOTO       CHGP9000 IF EQUAL
.
         PACK       KEY20,WBSEGPCD,PRACTICE,SP70
         CALL       RDPMHCL1
         BRANCH     OVRCD,CHGP9000
.
         GOTO       CHGP9999
.
CHGP9000 MOVE       ONE,GPACCESS
.
CHGP9999 RETURN
+
.*****************************************************************************
.*  UPDLSTUR
.*  Procedure to keep track of last 10 UR numbers accessed by a particular
.*  WEB User.
.*****************************************************************************
          DEFPROC   UPDLSTUR
.
          INC       WEBLURFD/INC
.
          MOVE      ZERO,EXIT
          OPEN      WEBLURA1,"webluraf"
.
          PACK      KEY10,USERID,SP70
          CALL      RDWBLUR1
          BRANCH    OVRCD,UPDLUR80          * Insert webluraf row.
.
.         Check current UR number and Admission number against
.         most recent UR number and Admission number stored on file.
.
          MATCH     WBLRUR01,PURNO          * Same as most recent UR?
          GOTO      UPDLUR10 IF NOT EQUAL   * No, Store this UR number
          MATCH     WBLRVS01,ADMISSNO       * Same as most recent Admission?
          GOTO      UPDLUR99 IF EQUAL       * Yes, no update required, exit
.
          MOVE      ADMISSNO,WBLRVS01       * No, update Admission number only.
          GOTO      UPDLUR90
.
UPDLUR10  MATCH     WBLRUR02,PURNO
          GOTO      UPDLUR55 IF EQUAL
.
          MATCH     WBLRUR03,PURNO
          GOTO      UPDLUR50 IF EQUAL
.
          MATCH     WBLRUR04,PURNO
          GOTO      UPDLUR45 IF EQUAL
.
          MATCH     WBLRUR05,PURNO
          GOTO      UPDLUR40 IF EQUAL
.
          MATCH     WBLRUR06,PURNO
          GOTO      UPDLUR35 IF EQUAL
.
          MATCH     WBLRUR07,PURNO
          GOTO      UPDLUR30 IF EQUAL
.
          MATCH     WBLRUR08,PURNO
          GOTO      UPDLUR25 IF EQUAL
.
          MATCH     WBLRUR09,PURNO
          GOTO      UPDLUR20 IF EQUAL
.
          MATCH     WBLRUR10,PURNO
          GOTO      UPDLUR15 IF EQUAL
.
          CALL      UPD2UR00        * check 11-20
.
UPDLUR15  MOVE      WBLRUR09,WBLRUR10
          MOVE      WBLRVS09,WBLRVS10
.
UPDLUR20  MOVE      WBLRUR08,WBLRUR09
          MOVE      WBLRVS08,WBLRVS09
.
UPDLUR25  MOVE      WBLRUR07,WBLRUR08
          MOVE      WBLRVS07,WBLRVS08
.
UPDLUR30  MOVE      WBLRUR06,WBLRUR07
          MOVE      WBLRVS06,WBLRVS07
.
UPDLUR35  MOVE      WBLRUR05,WBLRUR06
          MOVE      WBLRVS05,WBLRVS06
.
UPDLUR40  MOVE      WBLRUR04,WBLRUR05
          MOVE      WBLRVS04,WBLRVS05
.
UPDLUR45  MOVE      WBLRUR03,WBLRUR04
          MOVE      WBLRVS03,WBLRVS04
.
UPDLUR50  MOVE      WBLRUR02,WBLRUR03
          MOVE      WBLRVS02,WBLRVS03
.
UPDLUR55  MOVE      WBLRUR01,WBLRUR02
          MOVE      WBLRVS01,WBLRVS02
          MOVE      PURNO,WBLRUR01
          MOVE      ADMISSNO,WBLRVS01
          GOTO      UPDLUR90
.
.         Write a row to webluraf for this Web User ID
.
UPDLUR80  MOVE      USERID,WBLRUID          * Set User ID
          MOVE      PURNO,WBLRUR01          * Set UR Number
          MOVE      ADMISSNO,WBLRVS01       * Set Admission Number
          MOVE      SP70,WBLRUR02           * Initialize all other fields
          MOVE      SP70,WBLRVS02
          MOVE      SP70,WBLRUR03
          MOVE      SP70,WBLRVS03
          MOVE      SP70,WBLRUR04
          MOVE      SP70,WBLRVS04
          MOVE      SP70,WBLRUR05
          MOVE      SP70,WBLRVS05
          MOVE      SP70,WBLRUR06
          MOVE      SP70,WBLRVS06
          MOVE      SP70,WBLRUR07
          MOVE      SP70,WBLRVS07
          MOVE      SP70,WBLRUR08
          MOVE      SP70,WBLRVS08
          MOVE      SP70,WBLRUR09
          MOVE      SP70,WBLRVS09
          MOVE      SP70,WBLRUR10
          MOVE      SP70,WBLRVS10
          MOVE      SP70,WBLRUR11
          MOVE      SP70,WBLRVS11
          MOVE      SP70,WBLRUR12
          MOVE      SP70,WBLRVS12
          MOVE      SP70,WBLRUR13
          MOVE      SP70,WBLRVS13
          MOVE      SP70,WBLRUR14
          MOVE      SP70,WBLRVS14
          MOVE      SP70,WBLRUR15
          MOVE      SP70,WBLRVS15
          MOVE      SP70,WBLRUR16
          MOVE      SP70,WBLRVS16
          MOVE      SP70,WBLRUR17
          MOVE      SP70,WBLRVS17
          MOVE      SP70,WBLRUR18
          MOVE      SP70,WBLRVS18
          MOVE      SP70,WBLRUR19
          MOVE      SP70,WBLRVS19
          MOVE      SP70,WBLRUR20
          MOVE      SP70,WBLRVS20
          MOVE      SP70,WBLRSPAR
          PACK      KEY10,USERID,SP70
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          CALL      WRWBLUR1                * Insert webluraf row
          TRAPCLR   IO
          GOTO      UPDLUR99
.
UPDLUR90  CALL      UPWBLUR1                * Update webluraf row
          GOTO      UPDLUR99
.
.
UPD2UR00  MATCH     WBLRUR11,PURNO
          GOTO      UPD2UR65 IF EQUAL
.
          MATCH     WBLRUR12,PURNO
          GOTO      UPD2UR55 IF EQUAL
.
          MATCH     WBLRUR13,PURNO
          GOTO      UPD2UR50 IF EQUAL
.
          MATCH     WBLRUR14,PURNO
          GOTO      UPD2UR45 IF EQUAL
.
          MATCH     WBLRUR15,PURNO
          GOTO      UPD2UR40 IF EQUAL
.
          MATCH     WBLRUR16,PURNO
          GOTO      UPD2UR35 IF EQUAL
.
          MATCH     WBLRUR17,PURNO
          GOTO      UPD2UR30 IF EQUAL
.
          MATCH     WBLRUR18,PURNO
          GOTO      UPD2UR25 IF EQUAL
.
          MATCH     WBLRUR19,PURNO
          GOTO      UPD2UR20 IF EQUAL
.
          MOVE      WBLRUR19,WBLRUR20
          MOVE      WBLRVS19,WBLRVS20
.
UPD2UR20  MOVE      WBLRUR18,WBLRUR19
          MOVE      WBLRVS18,WBLRVS19
.
UPD2UR25  MOVE      WBLRUR17,WBLRUR18
          MOVE      WBLRVS17,WBLRVS18
.
UPD2UR30  MOVE      WBLRUR16,WBLRUR17
          MOVE      WBLRVS16,WBLRVS17
.
UPD2UR35  MOVE      WBLRUR15,WBLRUR16
          MOVE      WBLRVS15,WBLRVS16
.
UPD2UR40  MOVE      WBLRUR14,WBLRUR15
          MOVE      WBLRVS14,WBLRVS15
.
UPD2UR45  MOVE      WBLRUR13,WBLRUR14
          MOVE      WBLRVS13,WBLRVS14
.
UPD2UR50  MOVE      WBLRUR12,WBLRUR13
          MOVE      WBLRVS12,WBLRVS13
.
UPD2UR55  MOVE      WBLRUR11,WBLRUR12
          MOVE      WBLRVS11,WBLRVS12
.
UPD2UR65  MOVE      WBLRUR10,WBLRUR11
          MOVE      WBLRVS10,WBLRVS11
.
          RETURN
.
          INC       WEBLURIO/INC
          INC       IBAOVRIO/INC
.
UPDLUR99  CLOSE     WEBLURA1
          ENDPROC
.
.------------------------------------------------------------
. Format sex
.------------------------------------------------------------
FMTSEX00  MOVE      SP8,FMTSEX
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      SP70,TDESC
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      TDESC,FMTSEX
.* ******************************************   End of Changes         *C-49016
.
FMTSEX99  RETURN
.------------------------------------------------------------
. Write Patient Age in Y,M,W or D
.------------------------------------------------------------
FMTAGE00  MATCH     "y",PSAGETYP
          GOTO      FMTAGE10 IF NOT EQUAL
          PACK      FMTAGE,PSAGEYRS,FMTYRS,SP70
          GOTO      FMTAGE99
.
FMTAGE10  MATCH     "d",PSAGETYP
          GOTO      FMTAGE20 IF NOT EQUAL
          PACK      FMTAGE,PSAGEDAY,FMTDAYS,SP70
          GOTO      FMTAGE99
.
FMTAGE20  MATCH     "m",PSAGETYP
          GOTO      FMTAGE30 IF NOT EQUAL
          PACK      FMTAGE,PSAGEMNT,FMTMTHS,SP70
          GOTO      FMTAGE99
.
FMTAGE30  MATCH     "w",PSAGETYP
          GOTO      FMTAGE99 IF NOT EQUAL
          PACK      FMTAGE,PSAGEWKS,FMTWKS,SP70
.
FMTAGE99  RETURN
.------------------------------------------------------------
. Get Last Visit
.------------------------------------------------------------
GETVIS00  READ      CONTROLF,HUND18;*154,PTCNUHSC    * using hospital security?
.
          IF        VTYPFLAG=3
            PACK      KEY24,PURNO,VALDRDAT,Z70       * Recurring visit adm date
          ELSE
            PACK      KEY24,PURNO,Z70
          ENDIF
.
          MOVE      SP70,LASTVIST
          MOVE      SP70,LASTVDAT
          MOVE      SP70,LASTVTYP
          CALL      RDSVISA2
GETVIS10  CALL      RDPVISA2
          BRANCH    OVRCD,GETVIS99
          MATCH     PURNO,PVIURNO
          GOTO      GETVIS99 IF NOT EQUAL
          MATCH     "1",PTCNUHSC
          IF        @EQUAL
            PACK      KEY8,DPVIBILL,SP70
            CALL      RDPMVX11
            IF        OVRCD<>1
              MATCH     PMVXMHOS,WBSEHOSP
              GOTO      GETVIS10 IF NOT EQUAL
            ENDIF
          ENDIF
          BRANCH    VTYPFLAG,GETVIS15,GETVIS15,GETVIS15
          GOTO      GETVIS90
.
GETVIS15  COMPARE   "3",PVITYPE
          GOTO      GETVIS10 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETVIS10
.
          COMPARE   "3",ASTAT
          GOTO      GETVIS10 IF NOT EQUAL
.
          IF        VTYPFLAG=3
            MATCH     VALDRDAT,ADATE
            IF        @EQUAL
              MATCH     ATIME,VALDRTIM
              GOTO      GETVIS10 IF LESS
            ENDIF
.
            CALL      MVIS0000        * check if match for recurring care
            IF        EXIT=1
              MOVE      SP70,LASTVIST
              MOVE      SP70,LASTVDAT
              MOVE      SP70,LASTVTYP
              GOTO      GETVIS10
            ENDIF
          ENDIF
          GOTO      GETVIS90
.
GETVIS90  MOVE      PVIBILL,LASTVIST
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTVDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          LOAD      LASTVTYP,PVITYPE,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8
.
GETVIS99  RETURN
.
.------------------------------------------------------------
. Get First Visit of U/R
.------------------------------------------------------------
GETVIF00  READ      CONTROLF,HUND18;*154,PTCNUHSC    * using hospital security?
.
          IF        VTYPFLAG=3
            PACK      KEY24,PURNO,SP70       * Recurring visit adm date
          ELSE
            PACK      KEY24,PURNO,Z70
          ENDIF
.
          MOVE      SP70,LASTVIST
          MOVE      SP70,LASTVDAT
          MOVE      SP70,LASTVTYP
          CALL      RDSVISA2
GETVIF10  CALL      RDKVISA2
          BRANCH    OVRCD,GETVIF99
.
          MATCH     PURNO,PVIURNO
          GOTO      GETVIF99 IF NOT EQUAL
.
          MATCH     "1",PTCNUHSC
          IF        @EQUAL
            PACK      KEY8,DPVIBILL,SP70
            CALL      RDPMVX11
            IF        OVRCD<>1
              MATCH     PMVXMHOS,WBSEHOSP
              GOTO      GETVIF10 IF NOT EQUAL
            ENDIF
          ENDIF
          BRANCH    VTYPFLAG,GETVIF15,GETVIF15,GETVIF15
          GOTO      GETVIF90
.
GETVIF15  COMPARE   "3",PVITYPE
          GOTO      GETVIF10 IF NOT EQUAL
.
          MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETVIF10
.
          COMPARE   "3",ASTAT
          GOTO      GETVIF10 IF NOT EQUAL
.
          IF        VTYPFLAG=3
            CALL      MVIS0000        * check if match for recurring care
            IF        EXIT=1
              MOVE      SP70,LASTVIST
              MOVE      SP70,LASTVDAT
              MOVE      SP70,LASTVTYP
              GOTO      GETVIF10
            ENDIF
          ENDIF
          GOTO      GETVIF90
.
GETVIF90  MOVE      PVIBILL,LASTVIST
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTVDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          LOAD      LASTVTYP,PVITYPE,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8
.
GETVIF99  RETURN
.
.------------------------------------------------------------
. Matching visit to use for recurring care
.------------------------------------------------------------
MVIS0000  MOVE      ZERO,EXIT
          MATCH     SP70,PMVXIDUS
          GOTO      MVIS9000 IF EQUAL
.
          PACK      KEY5,ANSV,ANSI,PMVXIDUS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,MVIS9000
.
          MATCH     "2",TCINDC1
          GOTO      MVIS9000 IF NOT EQUAL
.
          PACK      KEY30,AADMNO,SP70
          CALL      RDSTRAN2
          CALL      RDKTRAN2
          BRANCH    OVRCD,MVIS9000
.
          MATCH     TADMN,AADMNO
          GOTO      MVIS9000 IF NOT EQUAL
.
          MATCH     TWARD,VALDWARD
          GOTO      MVIS9000 IF NOT EQUAL
.
          MATCH     TDEPT,VALDSPEC
          GOTO      MVIS9000 IF NOT EQUAL
.
          GOTO      MVIS9999
.
MVIS9000  MOVE      ONE,EXIT
.
MVIS9999  RETURN
+
.------------------------------------------------------------
. Validate Transfer Source
.------------------------------------------------------------
VALVAD00  CALL      XMLHED00
          BRANCH    EXIT,VALVAD99
.
          MOVE      VALDCODE,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,VALVAD90
.
          MATCH     "I",PTVAACTV
          GOTO      VALVAD91 IF EQUAL
.
          MATCH     "1",FILTDTYP            * Check Destination Type?
          GOTO      VALVAD10 IF NOT EQUAL   * no; skip
.
          MATCH     SP70,DESTTYPE
          GOTO      VALVAD10 IF EQUAL
.
          MATCH     DESTTYPE,PTVADTYP
          GOTO      VALVAD94 IF NOT EQUAL
.
VALVAD10  MATCH     SP70,TRANDATE           * Check date (eg Admission date)
          GOTO      VALVAD30 IF EQUAL
.
          MATCH     PTVASDAT,TRANDATE       * Transfer source start date
          GOTO      VALVAD92 IF LESS
.         
          MATCH     SP70,PTVAEDAT           * Still active if no end date
          GOTO      VALVAD30 IF EQUAL
.
          MATCH     PTVAEDAT,TRANDATE       * Transfer source end date
          GOTO      VALVAD93 IF NOT LESS
.
VALVAD30  MATCH     SP70,DDSTTYPE           * Discharge Destination Type
          IF        !@EQUAL
            MATCH     DDSTTYPE,PTVADTYP
            GOTO      VALVAD95 IF NOT EQUAL
          ENDIF 
.
VALVAD50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTVADESC,"|",PTVANHSC:
                             "</RETURN_VALUE>"
          GOTO      VALVAD98
.
VALVAD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Transfer Source - ":
                             KEY5,"</RETURN_VALUE>"
          GOTO      VALVAD98
.
VALVAD91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Transfer Source - ":
                             KEY5,"</RETURN_VALUE>"
          GOTO      VALVAD98
.
VALVAD92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             " This Transfer Source code is not valid - ":
                             " Start date has not been reached. - ":
                             KEY5,"</RETURN_VALUE>"
          GOTO      VALVAD98
.
VALVAD93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             " This Transfer Source code is not valid - ":
                             " End date has been reached. - ":
                             KEY5,"</RETURN_VALUE>"
          GOTO      VALVAD98

.
VALVAD94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Transfer Source - ":
                             "'Destination Type' mismatch - ":
                             KEY5,"</RETURN_VALUE>"
          GOTO      VALVAD98
.
VALVAD95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Transfer Source - ":
                             "'Discharge Destination Type' mismatch - ":
                             KEY5,"</RETURN_VALUE>"
          GOTO      VALVAD98
.
VALVAD98  CALL      XMLEND00
VALVAD99  RETURN
.------------------------------------------------------------
. Validate Transfer Source
.------------------------------------------------------------
VALRFS00  CALL      XMLHED00
          BRANCH    EXIT,VALRFS99
          MOVE      VALDCODE,KEY5
          CALL      RDPTVAD1
          BRANCH    OVRCD,VALRFS90
.
          MATCH     "I",PTVAACTV
          GOTO      VALRFS91 IF EQUAL
.
          UNPACK    REFRLSRC,DIM9,DIM1
          MATCH     PTVADTYP,DIM1       * Transfer source end date
          GOTO      VALRFS93 IF NOT EQUAL
.
VALRFS50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTVADESC,"|",PTVANHSC:
                             "</RETURN_VALUE>"
          GOTO      VALRFS98
.
VALRFS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Transfer Source - ":
                             KEY5,"</RETURN_VALUE>"
          GOTO      VALRFS98
.
VALRFS91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Transfer Source - ":
                             KEY5,"</RETURN_VALUE>"
          GOTO      VALRFS98
.
VALRFS93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "This Transfer Source code is not valid for the Referral Source":
                             "</RETURN_VALUE>"
          GOTO      VALRFS98

.
VALRFS98  CALL      XMLEND00
.
VALRFS99  RETURN
+
.------------------------------------------------------------------------------
.         Select all active clinics
.------------------------------------------------------------------------------
.
VALACL00  CALL      XMLHED00
          BRANCH    EXIT,VALACL99

          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          PACK      KEY20,WBSESIT,SP70
          CALL      RDSCLIA1
VALACL10  CALL      RDKCLIA1
          BRANCH    OVRCD,VALACL98
.
          MATCH     WBSESIT,OCASITE            * Check site
          GOTO      VALACL98 IF NOT EQUAL
.
.         A clinic id has been found, so get the latest record to display
.
          PACK      KEY20,WBSESIT,OCACLIN,Z70
          CALL      RDSCLIA1
VALACL20  CALL      RDPCLIA1
          BRANCH    OVRCD,VALACL98
.
          MATCH     WBSESIT,OCASITE
          GOTO      VALACL98 IF NOT EQUAL
.
          MOVE      VALDCODE,FORM1
.
          BRANCH    FORM1,VALACL30:       *show all active
                          VALACL35        *show all
.
          GOTO      VALACL99
.
VALACL30  MATCH     "0",OTCLIACT            *0 - active 1 - inactive
          GOTO      VALACL10 IF NOT EQUAL
.
VALACL35  MOVE      SP30,KEY25
          MATCH     SP6,OCADOCT
          IF        @EQUAL
            MOVE      OCACLIN,DCODE
            PACK      KEY25,OCADESC
            GOTO      VALACL50
          ENDIF
.
          MOVE      OCADOCT,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,VALACL50
.
          MOVE      DTITL,PACTITLE
          MOVE      DGNAME,PACGNAME
          MOVE      DSNAME,PACSNAME
          MOVE      ONE,PACFRMT
          CALL      PACNAME
          PACK      KEY25,PACFNAME
.
VALACL50  WRITE     HTMLFILE;OCACLIN,",(",OCACLIN,")",KEY25,"|";
          GOTO      VALACL10
.
VALACL98  WRITE     HTMLFILE;"</RETURN_VALUE>";
          CALL      XMLEND00
VALACL99  RETURN
+
.------------------------------------------------------------
. Validate if ASCII File Exist
.------------------------------------------------------------
VALFIL00  CALL      XMLHED00
          BRANCH    EXIT,VALFIL99
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      XXASCII1,VALDCODE
          TRAPCLR   IO
          BRANCH    OVRCD,VALFIL90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "File Exists - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      VALFIL98
.
VALFIL90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "File Does Not Exist":
                             "</RETURN_VALUE>"
          GOTO      VALFIL98
.
VALFIL98  CALL      XMLEND00
VALFIL99  RETURN
.------------------------------------------------------------
. Validate Security & Password
.------------------------------------------------------------
VALSEC00  CALL      XMLHED00
          BRANCH    EXIT,VALSEC99
.
          MATCH     "1",PTCNSUID
          IF        @EQUAL
            PACK      KEY10,SECUREID,SP70   * Using web user id for application
            CALL      RDWBSE1               * authentication
            BRANCH    OVRCD,VALSEC90
.
            PACK      SECUREID,WBSELOGN,SP256    * re set to login name
          ELSE
            PACK      KEY80,SECUREID,SP256
            CALL      RDWBSE7
            IF        OVRCD=1
              REP       LOWUPP,KEY80
              CALL      RDWBSE7
              BRANCH    OVRCD,VALSEC90
            ENDIF
          ENDIF
.
          IF        RETURNID=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               WBSEUID:
                               "</RETURN_VALUE>"
            GOTO      VALSEC98
          ENDIF
.
          CALL      VFYUSR00
          BRANCH    EXIT,VALSEC91
.
          IF        VALDTYPE=1
            MATCH     "1",WBSEGENR
            GOTO      VALSEC92 IF EQUAL        * Generic User ID
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "Password Verified Correct":
                             "</RETURN_VALUE>"
          GOTO      VALSEC98
.
VALSEC90  STRIP     SECUREID
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Security ID - ":
                             SECUREID,"</RETURN_VALUE>"
          GOTO      VALSEC98
.
VALSEC91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Security Password":
                             "</RETURN_VALUE>"
          GOTO      VALSEC98
.
VALSEC92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Username must not be a Generic User ID":
                             "</RETURN_VALUE>"
          GOTO      VALSEC98
.
VALSEC98  CALL      XMLEND00
VALSEC99  RETURN
.------------------------------------------------------------
. Validate Security Code
.------------------------------------------------------------
VALUSR00  CALL      XMLHED00
          BRANCH    EXIT,VALUSR99
.
          PACK      KEY10,VALDCODE,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,VALUSR90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             WBSENAM,"|",WBSEGENR: 
                             "</RETURN_VALUE>"
          GOTO      VALUSR98
.
VALUSR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Security ID - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      VALUSR98
.
VALUSR98  CALL      XMLEND00
VALUSR99  RETURN
.------------------------------------------------------------
. Validate Private Practice Code
.------------------------------------------------------------
VALPRI00  CALL      XMLHED00
          BRANCH    EXIT,VALPRI99
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDPRPR1
          BRANCH    OVRCD,VALPRI90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PRPRDESC,"|",PRPRPYEE,"|":
                             PRPRREGI:
                             "</RETURN_VALUE>"
          GOTO      VALPRI98
.
VALPRI90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Private Practice ID - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      VALPRI98
.
VALPRI98  CALL      XMLEND00
VALPRI99  RETURN
.
.------------------------------------------------------------
. Validate Service doctor for a Medical Practice 
.------------------------------------------------------------
VALDMP00  CALL      XMLHED00
          BRANCH    EXIT,VALDMP99
.
          MOVE      VALDCODE,DIM6
          BRANCH    RETURNFM,VALDMP10         * don't check hcp file
.
          PACK      KEY10,VALDCODE,SP70
          CALL      RDPMHCP1 
          BRANCH    OVRCD,VALDMP90
.
VALDMP10  MATCH     SP70,MEDIPRAC
          GOTO      VALDMP91 IF EQUAL         * Medical practice is not entered
.
          PACK      PRDOPRAC,MEDIPRAC,SP70
          MOVE      PRDOPRAC,MEDIPRAC
.
          OPEN      PRIDOCT1,"pridoctf"
          PACK      KEY22,MEDIPRAC,VALDCODE,SP70
          CALL      RSPRDO1
          CALL      RKPRDO1
          BRANCH    OVRCD,VALDMP92
.
          MATCH     MEDIPRAC,PRDOPRAC
          GOTO      VALDMP92 IF NOT EQUAL     * different medical practice
          MATCH     VALDCODE,PRDODOCT
          GOTO      VALDMP92 IF NOT EQUAL     * different doctor
.
          BRANCH    RETURNFM,VALDMP80         * don't want doctor name
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",PRDOSTAT:
                             "</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PRDOSTAT,"|",PRDOPROV:
                             "</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Doctor Code":
                             "</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Medical Practice must be entered first.":
                             "</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Doctor ",DIM6," Not Setup for Medical ":
                             "Practice - ",MEDIPRAC,"</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Doctor is Inactive for Medical Practice - ":
                             MEDIPRAC,"</RETURN_VALUE>"
          GOTO      VALDMP98
.
VALDMP98  CALL      XMLEND00
VALDMP99  RETURN
.
.------------------------------------------------------------
. Format Patient Name in Title Text
.------------------------------------------------------------
PATNAA00  CLEAR     DISPNAME
          MOVE      SP70,PATFNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          PACK      NAME35,PSNAME,SP70
          REP       UPPLOW,PSNAME
          APPEND    PSNAME,DISPNAME
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PATFNAME
          STRIP     PATFNAME
          RETURN
.------------------------------------------------------------
. Format Doctor Name in Title Text
.------------------------------------------------------------
DOCNAM00  CLEAR     DISPNAME
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          STRIP     FMTTITLE
          STRIP     FMTGNAME
          STRIP     FMTSNAME
          CALL      DOCNM000
          RETURN
.-------------------------------------------------
. Format Doctors Given Name
.-------------------------------------------------
DOCGIV00  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV00 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this name
.
          UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
.         Check for any more names
.
          SETLPTR   NAME35,35              * reset logical length
          ADD       ONE,CCITEM             * position of 1st blank
          RESET     NAME35,CCITEM          * reset to this point
          PACK      KEY35,NAME35,SP70      * reset form pointer
          MOVE      KEY35,NAME35

DOCGIV10  CMATCH    SP1,NAME35               * Remove Leading Blanks
          IF        @EQUAL
            BUMP      NAME35
            GOTO      DOCGIV10 IF NOT EOS
            GOTO      DOCGIV99               * entire name if blank
          ENDIF
          PACK      KEY35,NAME35,SP30        * reset form pointer
          MOVE      KEY35,NAME35
.
          SCAN      SP1,NAME35             * Locate the blank
          GOTO      DOCGIV20 IF NOT EQUAL
          BUMP      NAME35,-1              * go back 1 to end of name
          MOVEFPTR  NAME35,CCITEM          * another handly form field
          RESET     NAME35                 * reset the form pointer
          SETLPTR   NAME35,CCITEM          * set logical length to end of name
.
.         Save this Initial
.
          UNPACK    NAME35,KEY1,KEY50
          APPEND    KEY1,DISPNAME
          APPEND    SP1,DISPNAME
.
          GOTO      DOCGIV99
.
.         Rest of the string is one name
.
DOCGIV20  UNPACK    NAME35,KEY1,KEY50
          REP       DOWNCASE,KEY50
          APPEND    KEY1,DISPNAME
          STRIP     KEY50
          APPEND    KEY50,DISPNAME
          APPEND    SP1,DISPNAME
.
DOCGIV99  RETURN
.
.------------------------------------------------------------
. Validate Patient Visit No
.------------------------------------------------------------
VALVIS00  CALL      XMLHED00
          BRANCH    EXIT,VALVIS99
          MOVE      ZERO,VALDTYPE
          READ      CONTROLF,HUND18;*154,PTCNUHSC    * using hospital security?
          READ      CONTROLF,HUND28;*230,PTCNALTV    * using alternate visit id
.
          MOVE      ZERO,F1
          MOVE      VALDCODE,SAVKEY20
          MATCH     "1",PTCNALTV
          IF        @EQUAL
            STRIP     VALDCODE
            MOVELPTR  VALDCODE,F2
.
            COMPARE   "20",F2
            IF        @EQUAL
              UNPACK    VALDCODE,DIM10,DIM2,KEY8
              MOVE      KEY8,VALDCODE
            ENDIF
          ENDIF
.
VALVIS05  MOVE      SP70,PVIURNO
          MOVE      SP70,PVIDATE
          MOVE      ZEROVISN,PVIBILL
          MOVE      ZERO,PVITYPE
          MOVE      " 0",PTVITYPE
          MOVE      SP70,OPCASEKY
.
          PACK      ADMISSNO,VALDCODE,SP70
          MOVE      VALDCODE,KEY8
          CALL      RDVISA1
          IF        OVRCD<>1
            MATCH     "1",PTCNUHSC
            IF        @EQUAL
              PACK      KEY8,DPVIBILL,SP70
              CALL      RDPMVX11
              IF        OVRCD<>1
                MATCH     PMVXMHOS,WBSEHOSP
                GOTO      VALVIS95 IF NOT EQUAL
              ENDIF
            ENDIF
.
            COMPARE   TWO,PVITYPE           * Outpatient visit goto VALVIS10
            GOTO      VALVIS10 IF EQUAL     * to populate OPCASEKY
.
            GOTO      VALVIS20
          ENDIF
. ****  check if inpatient booking ****
.
          CALL      CHKBOK00 
          BRANCH    EXIT,VALVIS10
          GOTO      VALVIS20
.
. ****  check if outpatient booking ****
.
VALVIS10  CALL      OUTFIL00              * Check user id site files
          PACK      KEY36,VALDCODE,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,VALVIS81
.
          MATCH     VALDCODE,DOBAOUTN
          GOTO      VALVIS81 IF NOT EQUAL
          MOVE      DOBAOUTN,PVIBILL
          MOVE      DOBAOUTN,DPVIBILL
          MOVE      OBAURNO,PVIURNO
          MOVE      OBADATE,PVIDATE
          MOVE      " 2",PTVITYPE
          MOVE      TWO,PVITYPE
          PACK      OPCASEKY,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
.
VALVIS20  MATCH     "1",PTCNUHSC
          IF        @EQUAL
            PACK      KEY8,DPVIBILL,SP70
            CALL      RDPMVX11
            IF        OVRCD<>1
              MATCH     PMVXMHOS,WBSEHOSP
              GOTO      VALVIS95 IF NOT EQUAL
            ENDIF
          ENDIF
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTVDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      PTVITYPE,F2
          LOAD      LASTVTYP,F2,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8,VT9,VT10
.
VALVIS30  MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALVIS81
          COMPARE   ONE,PSTAT
          GOTO      VALVIS80 IF NOT EQUAL
.
VALVIS35  MOVE      PPSNAME,KEY8     * This is where the new U/R is hidden
          CALL      RDMAST1          * Read in the new PMI record
          BRANCH    OVRCD,VALVIS81   * New U/R number missing
          BRANCH    PSTAT,VALVIS35   * Another associated U/R number
.
VALVIS80  CALL      PATNAA00
.
          PACK      KEY8,DPVIBILL,SP70              * Emergency Visit
          CALL      RDEMVIS1
          IF        OVRCD=1
            MOVE      SP70,EMVISITE
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",PSEX,"|",PBDATE,"|",PCEASE,"|":
                             PURNO,"|",PVIBILL,"|",LASTVDAT,"|",LASTVTYP,"|":
                             PSAGE,"|",PMEDI,"|":
                             PADD1,"|",PADD2,"|",PSUBRB,"|",PADD4,"|":
                             PPOST,"|",EMVISITE,"|",OPCASEKY:
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS81  PACK      KEY8,VALDCODE,SP70
          CALL      RDEMVIS1                * Zero U/R visit?
          BRANCH    OVRCD,VALVIS85
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDEMUNK1
          BRANCH    OVRCD,VALVIS85
.
          MOVE      EMUNSNAM,PSNAME
          MOVE      EMUNGNAM,PGNAME
          CALL      PATNAA00
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",EMUNSEX,"|",EMUNBDAT,"|",SP1,"|":
                             ZERO,"|",EMUNADMN,"|",SP1,"|",SP1,"|":
                             SP1,"|",SP1,"|":
                             SP1,"|",SP1,"|",SP1,"|",SP1,"|":
                             SP1,"|",EMVISITE:
                             "</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS85  MATCH     "1",PTCNALTV
          GOTO      VALVIS90 IF NOT EQUAL
.
          COMPARE   ONE,F1 * already checked, exit
          GOTO      VALVIS91 IF EQUAL
          MOVE      ONE,F1
.
          LJUSTIFY  SAVKEY20
.
          PACK      KEY28,SAVKEY20,SP70
          CALL      RSIBALV2
          CALL      RKIBALV2
          BRANCH    OVRCD,VALVIS91
.
          MATCH     SAVKEY20,IBAVAVIS              * same alt. visit no. ?
          GOTO      VALVIS91 IF NOT EQUAL          * no
.
          MOVE      IBAVVISN,ADMISSNO
          MOVE      IBAVVISN,VALDCODE
          GOTO      VALVIS05
.
VALVIS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Visit - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Visit - ":
                             SAVKEY20,"</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS95  PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            PACK      PTHSNAME,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Visit Belongs to  - ":
                             PTHSNAME,"</RETURN_VALUE>"
          GOTO      VALVIS98
.
VALVIS98  CALL      XMLEND00
VALVIS99  RETURN
.------------------------------------------------------------
. Validate Patient Admission No
.------------------------------------------------------------
VALADM00  CALL      XMLHED00
          BRANCH    EXIT,VALADM99
.
          MOVE      VALDCODE,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,VALADM90
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      LASTADAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          LOAD      LASTSTAT,ASTAT,AT1,AT2,AT3,AT4,AT5
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VALADM90
          COMPARE   ONE,PSTAT
          GOTO      VALADM80 IF NOT EQUAL
.
VALADM10  MOVE      PPSNAME,KEY8     * This is where the new U/R is hidden
          CALL      RDMAST1          * Read in the new PMI record
          BRANCH    OVRCD,VALADM90   * New U/R number missing
          BRANCH    PSTAT,VALADM10   * Another associated U/R number
.
VALADM80  CALL      PATNAA00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PATFNAME,"|",PSEX,"|",PBDATE,"|",PCEASE,"|":
                             PURNO,"|",AADMNO,"|",LASTADAT,"|",LASTSTAT,"|":
                             PSAGE,"|",PMEDI,"|":
                             PADD1,"|",PADD2,"|",PSUBRB,"|",PADD4,"|",PPOST:
                             "</RETURN_VALUE>"
          GOTO      VALADM98
.
VALADM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Admission - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VALADM98
.
VALADM98  CALL      XMLEND00
VALADM99  RETURN
.------------------------------------------------------------
. Output Select Options for Allied Health Service Type
.------------------------------------------------------------
SELDPT00  CALL      XMLHED00
          BRANCH    EXIT,SELDPT99
.
          PACK      VALDCODE,VALDCODE,SP70
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY9,VALDCODE,SP70
          CALL      RSALSER1
SELDPT10  CALL      RKALSER1
          BRANCH    OVRCD,SELDPT19
.
          MATCH     VALDCODE,ALSRDEPT
          GOTO      SELDPT19 IF NOT EQUAL
.
          MATCH        "1",ALSRACTV
          GOTO      SELDPT10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALSRSERV,",",ALSRDESC,"|";
          GOTO      SELDPT10
.
SELDPT19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELDPT98
.
SELDPT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ??? - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      SELDPT98
.
SELDPT98  CALL      XMLEND00
SELDPT99  RETURN
.------------------------------------------------------------
. Output Select Options for Allied Health Referring Dept.
.------------------------------------------------------------
SELRDP00  CALL      XMLHED00
          BRANCH    EXIT,SELRDP99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY9,VALDCODE,SP70
          CALL      RSALPDI1
SELRDP10  CALL      RKALPDI1
          BRANCH    OVRCD,SELRDP19
          MATCH     VALDCODE,ALPDRDEP
          GOTO      SELRDP19 IF NOT EQUAL
          MATCH     "1",ALPDACTV
          GOTO      SELRDP10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ALPDREAS,",",ALPDDESC,"|";
          GOTO      SELRDP10
.
SELRDP19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELRDP98
.
SELRDP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ??? - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      SELRDP98
.
SELRDP98  CALL      XMLEND00
SELRDP99  RETURN
.------------------------------------------------------------
. Output Select Options for Selected Category Code
.------------------------------------------------------------
SELCOD00  CALL      XMLHED00
          BRANCH    EXIT,SELCOD99
.
          IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            BRANCH    OVRCD,SELCOD91
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";

          PACK      KEY2,VALDCODE,SP70
          PACK      PTCDKEY2,KEY2,SP70
          CALL      RDSCODE2
SELCOD10  CALL      RDKCODE2
          BRANCH    OVRCD,SELCOD19
          MATCH     KEY2,TCODE
          GOTO      SELCOD19 IF NOT EQUAL
          MATCH     ACODE,SP70
          GOTO      SELCOD10 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SELCOD10 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,SELCOD10
            ENDIF
          ENDIF
.
          PACK      KEY40,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV
.
          IF        RETURNFM=1
            PACK      KEY45,ACODE,KEY40,SP70
          ELSE
            PACK      KEY45,QUOTE,ACODE,KEY40,QUOTE
          ENDIF
.
          MATCH     "Y",SHOWLDSC
          IF        @EQUAL
            WRITE     HTMLFILE;KEY45,",",PTCDLDES,"|";
          ELSE
            WRITE     HTMLFILE;KEY45,",",TDESC,"|";
          ENDIF
          GOTO      SELCOD10
.
SELCOD19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELCOD98
.
SELCOD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ??? - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      SELCOD98
.
SELCOD91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid User Id - ":
                             USERID,"</RETURN_VALUE>"
          GOTO      SELCOD98
.
SELCOD98  CALL      XMLEND00
SELCOD99  RETURN
.------------------------------------------------------------
. Output Select Options for Selected Category Code, with selected value
.------------------------------------------------------------
SELCDV00  CALL      XMLHED00
          BRANCH    EXIT,SELCDV99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";

          PACK      KEY2,VALDCODE,SP70
          PACK      PTCDKEY2,KEY2,SP70
          CALL      RDSCODE2
SELCDV10  CALL      RDKCODE2
          BRANCH    OVRCD,SELCDV19
          MATCH     KEY2,TCODE
          GOTO      SELCDV19 IF NOT EQUAL
          MATCH     ACODE,SP70
          GOTO      SELCDV10 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SELCDV10 IF EQUAL
          PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
          PACK      KEY18,ACODE,KEY15
          MATCH     VALDCATC,ACODE
          IF        @EQUAL
            WRITE     HTMLFILE;KEY18,",",TDESC,",selected,|";
          ELSE
            WRITE     HTMLFILE;KEY18,",",TDESC,",        ,|";
          ENDIF
          GOTO      SELCDV10
.
SELCDV19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELCDV98
.
SELCDV90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ??? - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      SELCDV98
.
SELCDV98  CALL      XMLEND00
SELCDV99  RETURN
.
.------------------------------------------------------------
. Validate Credit Note number
.------------------------------------------------------------
VLDCRD00  CALL      XMLHED00
          BRANCH    EXIT,VLDCRD99
.
          MOVE      VALDCODE,KEY8
          MOVE      ZERO,FORM8
          MOVE      KEY8,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPMCNO1
          BRANCH    OVRCD,VLDCRD90
.
          MOVE      PMCNVISN,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,VLDCRD90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PMCNCRNO,"|",PMCNVISN,"|":
                             PVIURNO,"|",PMCNSYST,"|",PMCNINVN:
                             "</RETURN_VALUE>"
          GOTO      VLDCRD98
.
VLDCRD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Credit Note Number. ":
                             "</RETURN_VALUE>"
          GOTO      VLDCRD98
.
VLDCRD98  CALL      XMLEND00
VLDCRD99  RETURN
+
.------------------------------------------------------------
. Validate PP Credit Note number
.------------------------------------------------------------
VLDPCN00  CALL      XMLHED00
          BRANCH    EXIT,VLDPCN99
.
          MOVE      VALDCODE,KEY8
          MOVE      ZERO,FORM8
          MOVE      KEY8,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRCNO1
          BRANCH    OVRCD,VLDPCN90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PRCOCRNO,"|",PRCODEBT,"|",PRCOINVN:
                             "</RETURN_VALUE>"
          GOTO      VLDPCN98
.
VLDPCN90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Private Practice Credit Note Number. ":
                             "</RETURN_VALUE>"
          GOTO      VLDPCN98
.
VLDPCN98  CALL      XMLEND00
VLDPCN99  RETURN
+
.------------------------------------------------------------
. Output Health fund name and banding.              
.------------------------------------------------------------
SELHFT00  CALL      XMLHED00
          BRANCH    EXIT,SELHFT99
.
          PACK      KEY6,VALDCODE,SP70
          PACK      KEY14,KEY6,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,SELHFT90
.
SELHFT10  MATCH     KEY6,HCODE
          GOTO      SELHFT90 IF NOT EQUAL
          BRANCH    PHFTACT,SELHFT95
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          WRITE     HTMLFILE;HFNAME,"|",HFBAND,"|",DTHFUCMX;
.
SELHFT19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELHFT98
.
SELHFT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Health Fund ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      SELHFT98
.
SELHFT95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Health Fund ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      SELHFT98
.
SELHFT98  CALL      XMLEND00
SELHFT99  RETURN
.--------HPS code Starts -----------------
.------------------------------------------------------------
. Validate Nurse Code
.------------------------------------------------------------
VALNUR00  CALL      XMLHED00
          BRANCH    EXIT,VALNUR99
          MOVE      ZERO,F1
.
          PACK      VALDCODE,VALDCODE,SP70
.
          UNPACK    VALDCODE,KEY6,KEY4
          MATCH     SP70,KEY4               * Invalid nurse code if
          GOTO      VALNUR92 IF NOT EQUAL   * greater than 6 characaters
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDOPNUR1 
          BRANCH    OVRCD,VALNUR90
.
          MOVE      OPNRSTAT,F1
          BRANCH    F1,VALNUR91
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OPNRSNAM,"|",OPNRGNAM: 
                             "</RETURN_VALUE>"
          GOTO      VALNUR98
.
VALNUR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Nurse Code - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALNUR98
.
VALNUR91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Nurse Code - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALNUR98
.
VALNUR92  UNPACK    VALDCODDE,KEY10
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Nurse Code - ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      VALNUR98
.
VALNUR98  CALL      XMLEND00
VALNUR99  RETURN
.
.------------------------------------------------------------
. Validate Axis I Code
.------------------------------------------------------------
VALAXI00  CALL      XMLHED00
          BRANCH    EXIT,VALAXI99
          MOVE      ZERO,F1
          IF        MHCNUSE=1
            PACK      KEY10,ONE,VALDCODE,SP70
            CALL      RDMHAXI1 
            BRANCH    OVRCD,VALAXI90
.
            MATCH     "1",ACTVONLY          * Active Only
            IF        @EQUAL
              MATCH     "1",MHAXSTAT
              GOTO      VALAXI90 IF EQUAL
            ENDIF
.
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               MHAXDESC: 
                               "</RETURN_VALUE>"
          ENDIF
          GOTO      VALAXI98
.
VALAXI90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Axis I Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALAXI98
.
VALAXI98  CALL      XMLEND00
VALAXI99  RETURN
.
.------------------------------------------------------------
. Validate Axis II Code
.------------------------------------------------------------
VALAX200  CALL      XMLHED00
          BRANCH    EXIT,VALAX299
          MOVE      ZERO,F1
          IF        MHCNUSE=1
            PACK      KEY10,TWO,VALDCODE,SP70
            CALL      RDMHAXI1 
            BRANCH    OVRCD,VALAX290
.
            MATCH     "1",ACTVONLY          * Active Only
            IF        @EQUAL
              MATCH     "1",MHAXSTAT
              GOTO      VALAX290 IF EQUAL
            ENDIF
.
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               MHAXDESC: 
                               "</RETURN_VALUE>"
          ENDIF
          GOTO      VALAX298
.
VALAX290  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Axis II Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALAX298
.
VALAX298  CALL      XMLEND00
VALAX299  RETURN
.
.------------------------------------------------------------
. Validate Axis III Code
.------------------------------------------------------------
VALAX300  CALL      XMLHED00
          BRANCH    EXIT,VALAX399
          MOVE      ZERO,F1
          IF        MHCNUSE=1
            PACK      KEY10,THREE,VALDCODE,SP70
            CALL      RDMHAXI1
            BRANCH    OVRCD,VALAX390
.
            MATCH     "1",ACTVONLY          * Active Only
            IF        @EQUAL
              MATCH     "1",MHAXSTAT
              GOTO      VALAX390 IF EQUAL
            ENDIF
.
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               MHAXDESC:
                               "</RETURN_VALUE>"
          ENDIF
          GOTO      VALAX398
.
VALAX390  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Axis III Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALAX398
.
VALAX398  CALL      XMLEND00
VALAX399  RETURN
+
.--------------------------------------------------------------------------
. Validate Misc Charge Item Code (not checking for Active/Inactive and Date)
. this is used for IBABIL18 - Misc.Invoice Listing report
.--------------------------------------------------------------------------
VALMIT00  CALL      XMLHED00
          BRANCH    EXIT,VALMIT99
          MOVE      ZERO,F1
.
          OPEN      PATMCHG4,"patmchgf"
          PACK      KEY9,VALDCODE,SP70
          PACK      KEY29,KEY9,Z70
          CALL      RDSMCHG4
          CALL      RDPMCHG4
          BRANCH    OVRCD,VALMIT90
.
          MATCH     KEY9,MCHARGE
          GOTO      VALMIT90 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             MDESC:
                             "</RETURN_VALUE>"
          GOTO      VALMIT98
.
VALMIT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Misc Charge Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALMIT98
.
VALMIT98  CALL      XMLEND00
.
VALMIT99  RETURN
+
.------------------------------------------------------------
. Validate Misc Charge Item Code                             * I SRF 33349
. With Default Claim Code, Blank Health Fund & Table and
. Current effective date.
.------------------------------------------------------------
VALMSC00  CALL      XMLHED00
          BRANCH    EXIT,VALMSC99
          MOVE      ZERO,F1
.
          MOVE      CURRDATE,D8
          PACK      RETURNDT,RETURNDT,SP70
          IF        VALDTYPE=3
            MATCH     SP8,RETURNDT
            IF        !@EQUAL
              MOVE      RETURNDT,D8
            ENDIF
          ENDIF
          REP      " 0",D8
.
          MOVE      ZERO,INVALDFL
          PACK      KEY9,VALDCODE,SP70
          IF        IBCNMHOS=1
            MATCH     SP10,MULTHOSP
            IF        @EQUAL
              PACK      KEY3,SP10
              CALL      RSPTHSP1
              CALL      RKPTHSP1
              BRANCH    OVRCD,VALMSC92
            ELSE
              PACK      KEY3,MULTHOSP
              CALL      RDPTHSP1
              BRANCH    OVRCD,VALMSC92
            ENDIF
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,D8,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,D8,SP10
          ENDIF
VALMSC03  CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      VALMSC50 IF EQUAL
.
          MOVE      WKMCINAC,INVALDFL       * set inactive flag
          MOVE      WKMCXXDT,INVALDAT       * set date range error
.
.                          read forward (for some reason)
.
VALMSC05  IF        IBCNMHOS=1
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,D8,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,D8,SP10
          ENDIF
.
          CALL      RDMCHG1
          IF        OVRCD=0
            MATCH     "1",PTMCACTV               * Inactive ?
            GOTO      VALMSC50 IF NOT EQUAL      * No
            MOVE      ONE,INVALDFL
          ENDIF
.
          UNPACK    KEY29,KEY21,KEY8
.
          CALL      RDKMCHG1
          BRANCH    OVRCD,VALMSC40
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE
          MATCH     KEY21,KEY21A
          IF        @EQUAL
            MOVE      ONE,INVALDFL
          ENDIF
.
VALMSC40  IF        IBCNMHOS=1
            MATCH     SP10,MULTHOSP
            IF        @EQUAL
              CALL      RKPTHSP1
              IF        OVRCD=0
                PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,D8,SP10
                GOTO      VALMSC03
              ENDIF
            ENDIF
          ENDIF
.
          BRANCH    INVALDFL,VALMSC91
          BRANCH    INVALDAT,VALMSC94
          GOTO      VALMSC90
.
.                         output HTML data
.
VALMSC50  BRANCH    VALDTYPE,VALMSC60,VALMSC70,VALMSC60
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             MDESC,"|",MPATPOR:
                             "</RETURN_VALUE>"
          GOTO      VALMSC98
.
VALMSC60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             MDESC,"|",PTMCGSTA,"|",PTMCGSTC,"|",PTMCKREB,"|":
                             "</RETURN_VALUE>"
          GOTO      VALMSC98
.
VALMSC70  MATCH     "Y",PTMCCOBD
          GOTO      VALMSC93 IF NOT EQUAL      * Not doctor charge item code
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             MDESC:
                             "</RETURN_VALUE>"
          GOTO      VALMSC98
.
VALMSC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Misc Charge Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALMSC98
.
VALMSC91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Misc Charge Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALMSC98
.
VALMSC92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Multi Hospital Default Claim Code not setup ":
                             "</RETURN_VALUE>"
          GOTO      VALMSC98
.
VALMSC93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Doctor Misc Charge Code - ":
                             "</RETURN_VALUE>"
          GOTO      VALMSC98
.
VALMSC94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Misc Charge Code outside Date range - ":
                             "</RETURN_VALUE>"
          GOTO      VALMSC98
.
VALMSC98  CALL      XMLEND00
.
VALMSC99  RETURN
.
.-----------------------------------------------------------------------
. Validate NZP Misc Charge Item Code with selected Claim Code (VALDCLMT)
.         VALDTYP=3 - Adding Items to a Pack Item (exploding item)
.         VALDTYP=4 - Adding Items to Favourite Items Group (pmsufiaf)
.-----------------------------------------------------------------------
VALNZM00  CALL      XMLHED00
          BRANCH    EXIT,VALNZM99
.
          IF        IBCNMHOS=1
            MATCH     "1",OPCNPTMC
            IF        @EQUAL
              PACK      KEY10,USERID,SP70
              CALL      RDWBSE1
              BRANCH    OVRCD,VALNZM91
            ENDIF
          ENDIF
.
          MATCH     "N",FILEFLAG
          IF        @EQUAL
            OPEN      NZPMC1A3,"nzpmc1af"
          ENDIF
.
          PACK      DIM3,VALDHOSP,SP70
VALNZM02  PACK      MCHARGE,VALDCODE,SP70
          PACK      KEY37,MCHARGE,VALDCLMT,DIM3,SP70
          MATCH     "N",FILEFLAG
          IF        @EQUAL
            CALL      RSNZMC13
          ELSE
            CALL      RSNZMCH3
          ENDIF
VALNZM10  MATCH     "N",FILEFLAG
          IF        @EQUAL
            CALL      RKNZMC13
          ELSE
            CALL      RKNZMCH3
          ENDIF
          BRANCH    OVRCD,VALNZM14
.
          MATCH     MCHARGE,NZMCMCHG
          GOTO      VALNZM14 IF NOT EQUAL        * does charge code exist?
.
          MATCH     SP70,VALDCLMT
          IF        !@EQUAL
            MATCH     VALDCLMT,NZMCCLMC
            GOTO      VALNZM10 IF NOT EQUAL        * correct claim code?
          ENDIF
.
          MATCH     "1",NZMCACFL                * Inactive?
          GOTO      VALNZM10 IF EQUAL           * Yes
.
.   VALDTYP=3 - Adding Misc.item to a Pack Item (Exploding Item), the Hospital
.         code of the Pack item must be equal to Hosp. code of Misc.item
.
.   VALDTYP=4 - Adding Items to Favourite Items Group (pmsufiaf), the Hospital
.         code of the Favourite item must be equal to Hosp. code of Misc.item
.
          IF        VALDTYPE=4
            IF        IBCNMHOS=1
              MATCH     SP70,NZMCHOSP
              IF        !@EQUAL
                MATCH     DIM3,NZMCHOSP
                GOTO      VALNZM10 IF NOT EQUAL   * Different hospital
              ENDIF
            ENDIF
            GOTO    VALNZM12
          ENDIF
.
          COMPARE   THREE,VALDTYPE
          GOTO      VALNZM11 IF NOT EQUAL
.
          MATCH     DIM3,NZMCHOSP
          GOTO      VALNZM14 IF NOT EQUAL   * try blank hospital if necessary
.
.         Check Contract
.
          PACK      VALDFUND,VALDFUND,SP70
          MATCH     NZMCCNTR,VALDFUND
          GOTO      VALNZM10 IF NOT EQUAL   * different Contract
.
.         Check Effective date
.
          PACK      VALDCEFF,VALDCEFF,SP70
          MATCH     SP70,VALDCEFF
          IF        @EQUAL
            PACK      VALDCEFF,CCC,CYY,CMM,CDD
            REP       " 0",VALDCEFF
          ENDIF
.
          MATCH     NZMCEFDT,VALDCEFF       * effective date => serv. date ?
          GOTO      VALNZM10 IF LESS        * yes
.
          MATCH     SP70,NZMCEEDT
          IF        !@EQUAL
            MATCH     VALDCEFF,NZMCEEDT
            GOTO      VALNZM10 IF LESS
          ENDIF
.
          GOTO      VALNZM12
.
VALNZM11  IF        IBCNMHOS=1
            MATCH     "1",OPCNPTMC
            IF        @EQUAL
              MATCH     SP70,NZMCHOSP
              IF        !@EQUAL
                MATCH     SP70,VALDHOSP
                IF        @EQUAL 
                  MATCH     WBSEHOSP,NZMCHOSP
                  GOTO      VALNZM10 IF NOT EQUAL
                ELSE
                  MATCH     VALDHOSP,NZMCHOSP
                  GOTO      VALNZM10 IF NOT EQUAL
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
VALNZM12  BRANCH    VALDTYPE,VALNZM20,VALNZM30
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             NZMCDESC:
                             "</RETURN_VALUE>"
          GOTO      VALNZM98
.
VALNZM14  MATCH     SP70,DIM3
          GOTO      VALNZM90 IF EQUAL
.
          MOVE      SP70,DIM3      *  Try with blank Hospital
          GOTO      VALNZM02
.
VALNZM20  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             NZMCDESC,"|",NZMCGSTA,"|",NZMCGSTC,"|":
                             "</RETURN_VALUE>"
          GOTO      VALNZM98
.
VALNZM30  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             NZMCDESC:
                             "</RETURN_VALUE>"
          GOTO      VALNZM98
.
VALNZM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Misc Charge Code - ":
                              VALDCODE,"</RETURN_VALUE>"
.
VALNZM91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid User Id - ":
                             USERID,"</RETURN_VALUE>"
          GOTO      VALNZM98
.
VALNZM98  CALL      XMLEND00
VALNZM99  RETURN
.
.------------------------------------------------------------
. Validate MH Diagnosis Code                             * I SRF 33563
.------------------------------------------------------------
VALDIA00  CALL      XMLHED00
          BRANCH    EXIT,VALDIA99
          MOVE      ZERO,F1
          PACK      KEY9,VALDCODE,SP70
          CALL      RDPTICD1               * Check ICD10 Codes
          BRANCH    OVRCD,VALDIA10         * If not found then check ICD9 codes
.
          MATCH     "P",DFLAG
          GOTO      VALDIA90 IF NOT EQUAL  * Only viewing Posting Records
.
.                                                                     *C-174809
.                                       * ICDRDVER cotains the Edition No. of
.                                       * the ICD10 code read - now check that
.                                       * this Code is valid for this Ed.No.
          LOAD      KEY1,ICDRDVER,DPT0DV1C,DPT0DV2C,DPT0DV3C,DPT0DV4C,DPT0DV5C:
                                  DPT0DV6C,DPT0DV7C,DPT0DV8C,DPT0DV9C,DPT0DVXC:
                                  DPT0DVX1,DPT0DVX2,DPT0DVX3
          MATCH     "1",KEY1
          GOTO      VALDIA91 IF NOT EQUAL
.
VALDIA05  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DDESC:
                             "</RETURN_VALUE>"
          GOTO      VALDIA98
.
.                                           * Check ICD9 codes
VALDIA10  PACK      KEY9,VALDCODE,SP70
          CALL      RD10T9D1               * Check ICD9 codes
          BRANCH    OVRCD,VALDIA90
.
          MATCH     "P",DFLAG
          GOTO      VALDIA90 IF NOT EQUAL  * Only viewing Posting Records      
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DDESC:
                             "</RETURN_VALUE>"
          GOTO      VALDIA98
.
VALDIA90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Diagnosis Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALDIA98
.
VALDIA91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                              KEY9," is not a valid ICD10-AM - Ed.":
                              ICDRDVER," code":
                             "</RETURN_VALUE>"
          GOTO      VALDIA98
.
VALDIA98  CALL      XMLEND00
VALDIA99  RETURN
.
.------------------------------------------------------------
.                                                             * end I SRF 33563
.------------------------------------------------------------
. Validate Claim Code                                         * I SRF 18390
.------------------------------------------------------------
VALCLC00  CALL      XMLHED00
          BRANCH    EXIT,VALCLC99
          MATCH     ANSN,PTCNLCLM
          GOTO      VALCLC90 IF EQUAL
.
VALCLC10  MOVE      ZERO,F1
          PACK      KEY24,VALDCODE,Z70
          CALL      RSPTVIS2
VALCLC11  CALL      RPPTVIS2
          BRANCH    OVRCD,VALCLC90
.
          MATCH     VALDCODE,PVIURNO
          GOTO      VALCLC90 IF NOT EQUAL
.
          MATCH     ANSI,PTCNLCLM
          GOTO      VALCLC12 IF NOT EQUAL           * any/all visits
          COMPARE   THREE,PVITYPE                   * inpat visit only
          GOTO      VALCLC11 IF NOT EQUAL
.
VALCLC12  BRANCH    PVITYPE,VALCLC20:               * Emergency Visit
                            VALCLC30:               * Outpatient Visit
                            VALCLC40                * Inpatient Visit
.
          COMPARE   PVITYPE,NINE
          GOTO      VALCLC90 IF NOT EQUAL
.
          PACK      DIM2,SP1,TWO,SP70
          MATCH     PVISYST,DIM2
          GOTO      VALCLC90 IF NOT EQUAL
.
          GOTO      VALCLC50                        * Allied Health Visit   
.
VALCLC20  PACK      KEY8,DPVIBIll,SP70              * Emergency Visit
          CALL      RDEMVIS1
          BRANCH    OVRCD,VALCLC90
.
          MATCH     DPVIBILL,DEMVIADM
          GOTO      VALCLC90 IF NOT EQUAL
.
          MOVE      EMVICOMP,ACLAIM
          MOVE      EMVICOMP,OBACOMP
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             EMVICOMP:
                             "</RETURN_VALUE>"            
.
          GOTO      VALCLC98
.
VALCLC30  PACK      KEY8,DPVIBILL,SP70              * Outpatient Visit
          CALL      RDBOKB1
          BRANCH    OVRCD,VALCLC90
.
          MATCH     DPVIBILL,DOBAOUTN
          GOTO      VALCLC90 IF NOT EQUAL
.
          MOVE      OBACOMP,ACLAIM
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OBACOMP:
                             "</RETURN_VALUE>"                   
.
          GOTO      VALCLC98        
.
.VALCLC40  PACK      KEY17,VALDCODE,Z70              * Inpatient Visit
.          CALL      RSPTMI18
.          CALL      RPPTMI18
.          BRANCH    OVRCD,VALCLC90
.
.          MATCH     VALDCODE,AURNO
.          GOTO      VALCLC90 IF NOT EQUAL
.
.          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
.                             ACLAIM:
.                             "</RETURN_VALUE>"
.          GOTO      VALCLC98
.
VALCLC40  PACK      KEY8,DPVIBILL,SP70              * Inpatient Visit
          CALL      RDPTMIS1
          BRANCH    OVRCD,VALCLC90
.
          MATCH     DPVIBILL,DAADMNO
          GOTO      VALCLC90 IF NOT EQUAL
.
          MOVE      ACLAIM,OBACOMP
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ACLAIM:
                             "</RETURN_VALUE>"
.
          GOTO      VALCLC98
.
VALCLC50  PACK      KEY8,DPVIBILL,SP70              * A/H Referral
          CALL      RDALREF1
          BRANCH    OVRCD,VALCLC90
.
          MATCH     DPVIBILL,ALREVISN
          GOTO      VALCLC90 IF NOT EQUAL
.
          MATCH     SP70,ALRECOMP
          GOTO      VALCLC60 IF NOT EQUAL
.
          PACK      KEY16,DPVIBILL,Z70              * A/H Encounter
          CALL      RSALENC1
VALCLC55  CALL      RPALENC1            
          BRANCH    OVRCD,VALCLC90
.
          MATCH     DPVIBILL,ALENVISN
          GOTO      VALCLC90 IF NOT EQUAL
.
          MATCH     "1",ALENRSTA                    * Cancelled
          GOTO      VALCLC55 IF EQUAL
.
          MOVE      ALENCOMP,ALRECOMP
.
VALCLC60  MOVE      ALRECOMP,ACLAIM
          MOVE      ALRECOMP,OBACOMP
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ALRECOMP:
                             "</RETURN_VALUE>"
.
          GOTO      VALCLC98
.
VALCLC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             SP3:
                              "</RETURN_VALUE>"
          GOTO      VALCLC98
.
VALCLC98  CALL      XMLEND00
VALCLC99  RETURN
.
.------------------------------------------------------------

.------------------------------------------------------------
. Validate TAC Screen
.------------------------------------------------------------
VALTAC00  CALL      XMLHED00
          BRANCH    EXIT,VALTAC99
.
          MOVE      ZERO,F1
          PACK      KEY8,VALDADNO,SP70          * Find out if the current admno 
          CALL      RDWMAB1                     * already has a TAC record
          BRANCH    OVRCD,VALTAC20              * If not then find the last vist
.
.          UNPACK    MACDAT,CCENT,CYEAR,CMON,CDAY
.          CALL      PACDATE
          MOVE      SP70,DIM11                  * Date of Accident formatting
          MATCH     MACDAT,SP70
          GOTO      VALTAC12 IF EQUAL
          UNPACK    MACDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VALTAC12  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    MREFNO,"|",DIM11,"|",MACLOC,"|",MOTHDET1,"|",MPOLIC,"|":
                    MOTHDET2,"|",MCREGO,"|",MOTHDET3,"|",PTWMTYPE,"|":
                    MMDTRANS,"|",MENGAGED,"|",MPINJURE,"|",MMECHSEV,"|":
                    MREGNSEV,"|",MSNAME,"|",MSTELE,"|",MDPINDIC:
                    "</RETURN_VALUE>"
.
          GOTO      VALTAC98
.
VALTAC20  PACK      KEY24,VALDURNO,Z70          * Find the last visit 
          CALL      RSPTVIS2                  
VALTAC25  CALL      RPPTVIS2
          BRANCH    OVRCD,VALTAC90              
.                                               
          MATCH     VALDURNO,PVIURNO            * If there are no visits then
          GOTO      VALTAC90 IF NOT EQUAL       * default spaces into TAC screen
.
          MATCH     VALDADNO,DPVIBILL
          GOTO      VALTAC25 IF EQUAL
.
          PACK      KEY8,DPVIBILL,SP70          * Find out if the last admno
          CALL      RDWMAB1                     * already has a TAC record
          BRANCH    OVRCD,VALTAC90              * If not then default spaces
.
.          UNPACK    MACDAT,CCENT,CYEAR,CMON,CDAY
.          CALL      PACDATE
          MOVE      SP70,DIM11
          MATCH     MACDAT,SP70                 * Date of Accident Formatting
          GOTO      VALTAC27 IF EQUAL
          UNPACK    MACDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VALTAC27  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    MREFNO,"|",DIM11,"|",MACLOC,"|",MOTHDET1,"|",MPOLIC,"|":
                    MOTHDET2,"|",MCREGO,"|",MOTHDET3,"|",PTWMTYPE,"|":
                    MMDTRANS,"|",MENGAGED,"|",MPINJURE,"|",MMECHSEV,"|":
                    MREGNSEV,"|",MSNAME,"|",MSTELE,"|",MDPINDIC:
                    "</RETURN_VALUE>"
.
          GOTO      VALTAC98          
.
VALTAC90  PACK      DIM12,SP70
          PACK      DIM40,SP70
          PACK      DIM36,SP70
          MOVE      "19010101",MACDAT
          UNPACK    MACDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    SP70,MREFNO,MACLOC,MOTHDET1
          UNPACK    SP70,MPOLIC,MOTHDET2
          UNPACK    SP70,MOTHDET3,MCREGO
          UNPACK    SP70,MMDTRANS
          UNPACK    SP70,MENGAGED,MPINJURE
          UNPACK    SP70,MMECHSEV,MREGNSEV
          UNPACK    SP70,MSNAME,MSTELE
          MOVE      ZERO,MDPINDIC
          MOVE      ZERO,PTWMTYPE
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    MREFNO,"|",DIM11,"|",MACLOC,"|",MOTHDET1,"|",MPOLIC,"|":
                    MOTHDET2,"|",MCREGO,"|",MOTHDET3,"|",PTWMTYPE,"|":
                    MMDTRANS,"|",MENGAGED,"|",MPINJURE,"|",MMECHSEV,"|":
                    MREGNSEV,"|",MSNAME,"|",MSTELE,"|",MDPINDIC:
                    "</RETURN_VALUE>"
.
.         WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
.                   SP20,"|",DIM11,"|",DIM40,"|",SP30,"|",SP20,"|":
.                   SP30,"|",DIM36,"|",SP30,"|",SP3,"|":
.                   SP10,"|",SP20,"|",SP30,"|",SP30,"|":
.                   SP20,"|",SP30,"|",DIM12,"|",SP1: 
.                   "</RETURN_VALUE>"
.
          GOTO      VALTAC98
.
VALTAC98  CALL      XMLEND00
VALTAC99  RETURN
+
.------------------------------------------------------------
. Validate WCO Screen
.------------------------------------------------------------
VALWCO00  CALL      XMLHED00
          BRANCH    EXIT,VALWCO99
.
          MOVE      ZERO,F1
          PACK      KEY8,VALDADNO,SP70          * Find out if the current admno 
          CALL      RDWCOM1                     * already has a WCO record
          BRANCH    OVRCD,VALWCO20              * If not then find the last vist
          CALL      RDPMWX11
          BRANCH    OVRCD,VALWCO20              * If not then find the last vist
.
          MOVE      SP70,DIM11                  * Date of Accident formatting
          MATCH     WCACDAT,SP70
          GOTO      VALWCO12 IF EQUAL
          UNPACK    WCACDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VALWCO12  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    WCENAME,"|",WCEADD1,"|",WCEADD2,"|",WCEADD3,"|",WCEADD4,"|":
                    WCEPOST,"|",WCETELE,"|",DIM11,"|",WCACCPT,"|":
                    WCICODE,"|",WCCLMNO,"|",WCCOMN1,"|",WCCOMN2,"|":
                    PMWXALOC,"|",PMWXCINJ,"|",PMWXICOD,"|",PMWXCNAM:
                    "</RETURN_VALUE>"
.
          GOTO      VALWCO98
.
VALWCO20  PACK      KEY24,VALDURNO,Z70          * Find the last visit 
          CALL      RSPTVIS2                  
VALWCO25  CALL      RPPTVIS2
          BRANCH    OVRCD,VALWCO90              
.                                               
          MATCH     VALDURNO,PVIURNO            * If there are no visits then
          GOTO      VALWCO90 IF NOT EQUAL       * default spaces into WCO screen
.
          MATCH     VALDADNO,DPVIBILL
          GOTO      VALWCO25 IF EQUAL
.
          PACK      KEY8,DPVIBILL,SP70          * Find out if the last admno
          CALL      RDWCOM1                     * already has a WCO record
          BRANCH    OVRCD,VALWCO90              * If not then default spaces
          CALL      RDPMWX11
          BRANCH    OVRCD,VALWCO90              * If not then default spaces
.
          MOVE      SP70,DIM11
          MATCH     WCACDAT,SP70                 * Date of Accident Formatting
          GOTO      VALWCO27 IF EQUAL
          UNPACK    WCACDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
VALWCO27  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    WCENAME,"|",WCEADD1,"|",WCEADD2,"|",WCEADD3,"|",WCEADD4,"|":
                    WCEPOST,"|",WCETELE,"|",DIM11,"|",WCACCPT,"|":
                    WCICODE,"|",WCCLMNO,"|",WCCOMN1,"|",WCCOMN2,"|":
                    PMWXALOC,"|",PMWXCINJ,"|",PMWXICOD,"|",PMWXCNAM:
                    "</RETURN_VALUE>"
.
          GOTO      VALWCO98          
.
VALWCO90  PACK      DIM12,SP70
          PACK      DIM40,SP70
          PACK      DIM36,SP70
          MOVE      SP10,DIM11
.
          UNPACK    SP70,WCENAME
          UNPACK    SP70,WCEADD1,WCEADD2
          UNPACK    SP70,WCEADD3,WCEADD4
          UNPACK    SP70,WCEPOST,WCETELE
          UNPACK    SP70,WCICODE
          UNPACK    SP70,WCACDAT,WCCLMNO
          UNPACK    SP70,WCCOMN1,WCCOMN2
          UNPACK    SP70,PMWXALOC,PMWXCINJ
          UNPACK    SP70,PMWXICOD,PMWXCNAM
          MOVE      ZERO,WCACCPT
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    WCENAME,"|",WCEADD1,"|",WCEADD2,"|",WCEADD3,"|",WCEADD4,"|":
                    WCEPOST,"|",WCETELE,"|",DIM11,"|",WCACCPT,"|":
                    WCICODE,"|",WCCLMNO,"|",WCCOMN1,"|",WCCOMN2,"|":
                    PMWXALOC,"|",PMWXCINJ,"|",PMWXICOD,"|",PMWXCNAM:
                    "</RETURN_VALUE>"
          GOTO      VALWCO98
.
VALWCO98  CALL      XMLEND00
VALWCO99  RETURN
+
.------------------------------------------------------------ * end I SRF 18390
. Validate HCP Code
. VALDTYPE:
.          0 = Default no validation
.          1 = Validate Attending HCP
.          2 = Validate Referring HCP
.          3 = Validate Attending and Referring HCP
.          4 = Validate GP
.          5 = Validate Attending Doctor and GP
.          6 = Referring Doctor and GP
.          7 = Attending, Referring and GP
.          8 = Validate Other
.          9 = Validate Other
.         10 = Validate Other
.         11 = Validate Other
.         12 = Validate - Invalid if GP
.         13 = All Active Other   
.         14 = All Attending HCP
.         15 = All Attending and Referring
.         16 = Validate related provider type
.         17 = All Types                      
.         18 = Validate Mental Health HCP
.         19 = Assessor with NBRS Clinical Responsibility Code
.         20 = All Nurses
.------------------------------------------------------------
VALHCP00  CALL      XMLHED00
          BRANCH    EXIT,VALHCP99
          MOVE      ZERO,F1
          PACK      VALDCODE,VALDCODE,SP70
          MATCH     SP70,VALDCODE
          GOTO      VALHCP98 IF EQUAL
.
          IF        IBCNMHOS=1
            PACK      KEY10,USERID,SP70
            CALL      RDWBSE1
            BRANCH    OVRCD,VALHCP94
          ENDIF
.
          COMPARE   THREE,RETURNFM
          GOTO      VALHCP87 IF EQUAL            * validate provider number
.
          COMPARE   FIVE,RETURNFM                * Return link doctor code
          GOTO      VALHCP84 IF EQUAL            * for a HCP
.
          COMPARE   SIX,RETURNFM                * Return link doctor code
          GOTO      VALHC87A IF EQUAL            * for a HCP
.
          PACK      KEY10,VALDCODE,SP70
          CALL      RDPMHCP1 
          BRANCH    OVRCD,VALHCP90
          MOVE      PMHCSTTS,F1                  * set Status (0=active 1=inact)
.
          MATCH     "1",PMHCHOSS
          GOTO      VALHCP02 IF NOT EQUAL
.
          MATCH     SP70,VALDADAT
          GOTO      VALHCP02 IF EQUAL
.
          MATCH     SP70,VALDHOSP
          GOTO      VALHCP02 IF EQUAL
.
          COMPARE   ONE,IBCNMHOS
          GOTO      VALHCP02 IF NOT EQUAL        * 0854372
.
          PACK      KEY13,WBSEHOSP,PMHCHCPC,SP70
          CALL      RDMLHCP1
          BRANCH    OVRCD,VALHCP89
.
          MOVE      MLHCSTAT,PMHCHCST     * use status in hospital
.
          MATCH     MLHCSDAT,VALDADAT
          GOTO      VALHCP86 IF LESS
.
          MATCH     SP70,MLHCEDAT
          GOTO      VALHCP02 IF EQUAL
.
          MATCH     VALDADAT,MLHCEDAT
          GOTO      VALHCP86 IF LESS
.
VALHCP02  COMPARE   TEN7,VALDTYPE                * bypass Doc Type "All Types"
          GOTO      VALHCP04 IF EQUAL
.
          UNPACK    SP10,ADATE
          MATCH     SP10,VALDADNO
          IF        !@EQUAL 
            PACK      KEY8,VALDADNO,SP10
            CALL      RDMISS1                    * read Admission for ADATE
            IF        F1 = 1
              MATCH     PMHCEDAT,ADATE           * is Admn Date before End Date
              IF        @LESS
                MOVE      "0",PMHCSTTS           * re-set to "Active"
                MOVE      ZERO,F1
              ENDIF
              BRANCH      F1,VALHCP91            * issue "Inactive" error
            ENDIF
          ELSE
            BRANCH      F1,VALHCP91            * issue "Inactive" error
          ENDIF
.
VALHCP04  MATCH     "1",VALDALLH            * Ignore multi hospital test
          GOTO      VALHCP06 IF EQUAL
.
          COMPARE   "0",VALDTYPE
          GOTO      VALHCP06 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PMHCHOSS           * is Doctor "Hospital specific"?
            IF       @EQUAL
              PACK     KEY13,WBSEHOSP,PMHCHCPC,SP70
              CALL     RDMLHCP1
              BRANCH   OVRCD,VALHCP95            * wrong hospital ?
.                                                                     *I-240103
              CALL     VALDAT00                  * check HCP active at Admn date
              BRANCH   EXIT,VALHCP91             * HCP inactive ?
            ELSE              
              MATCH    "1",PTCNMHCP              * Only show matching hospitals
              GOTO     VALHCP95 IF EQUAL
            ENDIF
          ENDIF
.
.
VALHCP06  BRANCH    VALDTYPE,VALHCP10,VALHCP15,VALHCP20,VALHCP25:
                             VALHCP30,VALHCP35,VALHCP40,VALHCP45:
                             VALHCP50,VALHCP55,VALHCP60,VALHCP65:
                             VALHCP70,VALHCP75,VALHCP77,VALHCP78:
                             VALHCP80,VALHCP79,VALHC79A,VALHCP21
          GOTO      VALHCP80
.
VALHCP10  
.        HCP Type - 0, 2, 4, 6, 8, 10,11,13
.
          BRANCH    PMHCHCST,VALHCP92,VALHCP80,VALHCP92,VALHCP80,VALHCP92:
                             VALHCP80,VALHCP92,VALHCP80,VALHCP92,VALHCP80:
                             VALHCP80,VALHCP92,VALHCP80,VALHCP92,VALHCP92
          GOTO      VALHCP80
.
. Referring
.                            HCP Type - 1, 2, 5, 6, 9, 10,12,13
VALHCP15  BRANCH    PMHCHCST,VALHCP80,VALHCP80,VALHCP92,VALHCP92,VALHCP80:
                             VALHCP80,VALHCP92,VALHCP92,VALHCP80,VALHCP80:
                             VALHCP80,VALHCP80,VALHCP80,VALHCP92,VALHCP92
          GOTO      VALHCP92
.
. All Active Attending and Ref Doctor Types
.                            HCP Type - 0,1,2,4,5,6,8,9,10,11,12,13
VALHCP20  BRANCH    PMHCHCST,VALHCP80,VALHCP80,VALHCP92,VALHCP80,VALHCP80:
                             VALHCP80,VALHCP92,VALHCP80,VALHCP80,VALHCP80:
                             VALHCP80,VALHCP80,VALHCP80,VALHCP92,VALHCP92
          GOTO      VALHCP80
.
. Nurses
.                            HCP Type - 14, 15
VALHCP21  BRANCH    PMHCHCST,VALHCP92,VALHCP92,VALHCP92,VALHCP92,VALHCP92:
                             VALHCP92,VALHCP92,VALHCP92,VALHCP92,VALHCP92:
                             VALHCP92,VALHCP92,VALHCP92,VALHCP80,VALHCP80
          GOTO      VALHCP92
.
VALHCP25  COMPARE   THREE,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   FOUR,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   FIVE,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   SIX,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN1,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN2,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN3,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          GOTO      VALHCP92 
.
VALHCP30  COMPARE   FOUR,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   SIX,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN1,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN3,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          GOTO      VALHCP92
.
VALHCP35  COMPARE   FIVE,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   SIX,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN2,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN3,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          GOTO      VALHCP92
.
VALHCP40  COMPARE   SIX,PMHCHCST
          GOTO      VALHCP80 IF NOT EQUAL
.
          COMPARE   TEN3,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          GOTO      VALHCP92
.
VALHCP45  COMPARE   SEVEN,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   EIGHT,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   NINE,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN1,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN2,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN3,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          GOTO      VALHCP92
.
VALHCP50  COMPARE   EIGHT,PMHCHCST
          GOTO      VALHCP92 IF NOT EQUAL
          GOTO      VALHCP80
.
VALHCP55  COMPARE   NINE,PMHCHCST
          GOTO      VALHCP92 IF NOT EQUAL
          GOTO      VALHCP80
.
VALHCP60  COMPARE   TEN,PMHCHCST
          GOTO      VALHCP92 IF NOT EQUAL
          GOTO      VALHCP80
.
VALHCP65  COMPARE   THREE,PMHCHCST
          GOTO      VALHCP92 IF EQUAL
          GOTO      VALHCP80
.
VALHCP70  COMPARE   SEVEN,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   EIGHT,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   NINE,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN1,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN2,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN3,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN5,PMHCHCST         * HCP Type 15 - Nurse & Other
          GOTO      VALHCP80 IF EQUAL
.
          GOTO      VALHCP92
.
.                                           * validate Active Attending HCP
VALHCP75  COMPARE   ZERO,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TWO,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   FOUR,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
.                            * removed - a "Referring" HCP type should not be in
.                            * "Active Attending"                     *D-179365
.                            * - also removed in PATWEB99 at PMSHKB10
....      COMPARE   FIVE,PMHCHCST           * "Referring HCP & GP"
....      GOTO      VALHCP80 IF EQUAL
.
          COMPARE   SIX,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   EIGHT,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN1,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN3,PMHCHCST
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN4,PMHCHCST         * HCP Type 14 - Nurses         
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TEN5,PMHCHCST         * HCP Type 15 - Nurse & Other
          GOTO      VALHCP80 IF EQUAL
.
          GOTO      VALHCP92
.
VALHCP77  COMPARE   ZERO,PMHCHCST             * Attending doctor
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   ONE,PMHCHCST             * Referring doctor
          GOTO      VALHCP80 IF EQUAL
.
          COMPARE   TWO,PMHCHCST
          GOTO      VALHCP80 IF EQUAL        * Attending & Referring doctor
.
          COMPARE   TEN3,PMHCHCST
          GOTO      VALHCP80 IF EQUAL        * Attending & Referring doctor,GP
.
          GOTO      VALHCP92
.
VALHCP78  MATCH     VALPTYPE,PMHCPTYP        * Related Provider Type
          GOTO      VALHCP96 IF NOT EQUAL
.
          GOTO      VALHCP80
.
VALHCP79  MOVE      "DT",TCODE
          PACK      KEY5,TCODE,PMHCSPC1,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VALHCP97
.
          MATCH     "L",TCINDC1 
          GOTO      VALHCP97 IF NOT EQUAL
.         
          GOTO      VALHCP80
.
VALHC79A  MATCH     SP70,PMHCPRV5
          GOTO      VALHC97A IF EQUAL
.
          GOTO      VALHCP80
.
VALHCP80  MOVE      PMHCTITL,DTITL
          MOVE      PMHCGNAM,DGNAME
          MOVE      PMHCSNAM,DSNAME
          CALL      DOCNAM00
.
          COMPARE   FOUR,RETURNFM
          GOTO      VALHCP88 IF EQUAL
.
          BRANCH    RETURNFM,VALHCP82,VALHCP83
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME:
                             "</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP82  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",PMHCPRV1,"|",PMHCADR3,"|":
                             "</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP83  CALL      GHCPL000
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",PRACCODE,"|",PRACNAME,"|":
                             PRACCNTR,"|",PRACPRV1,"|",NODEFPRA,"|":
                             "</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP84  PACK      KEY10,VALDCODE,SP70
          CALL      RDPMHCP1 
          IF        OVRCD=1
            CALL      CLPMSHCP 
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PMHCLDOC,"|":
                             "</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP86  PACK      KEY3,WBSEHOSP
          CALL      RDPTHSP1
          IF        OVRCD=1
            MOVE      SP70,PTHSNAME
          ENDIF
          STRIP     KEY10
          STRIP     PTHSNAME
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "HCP Code ",*+,KEY10:
                             " Not Active in Hospital ",*+,PTHSNAME:
                             " on this date.</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP87  PACK      VALDCODE,VALDCODE,SP70
          CALL      GHCPD000
          BRANCH    EXIT,VALHCP93
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",PRACCODE,"|",PRACNAME,"|":
                             PRACCNTR,"|",DOCTCODE,"|":
                             "</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHC87A  PACK      VALDCODE,VALDCODE,SP70
          CALL      GHCPPR00
          IF        EXIT=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               PMHCHCPC:
                               "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               "</RETURN_VALUE>"
          ENDIF
          GOTO      VALHCP98
.
VALHCP88  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",PMHCSLGP,"|":
                             "</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP89  PACK      KEY3,WBSEHOSP
          CALL      RDPTHSP1
          IF        OVRCD=1
            MOVE      SP70,PTHSNAME
          ENDIF
          STRIP     KEY10
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "HCP Code ",*+,KEY10:
                             " Not Active in Hospital ",PTHSNAME:
                             "</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid HCP Code - ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive HCP Code - ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid HCP Status - ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Provider Number - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid User Id - ":
                             USERID,"</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Hospital for HCP - ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid provider type for this provider - ":
                              PMHCPTYP,"</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHCP97  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Primary Specialty - ":
                              PMHCSPC1,"</RETURN_VALUE>"
          GOTO      VALHCP98
.
VALHC97A  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Assessor Code : ":
                              KEY10," ":
                         "Please ensure the Assessor Code has a ":
                         "NBRS Clinical Responsibility Code.</RETURN_VALUE>"
          GOTO      VALHCP98
. 
VALHCP98  CALL      XMLEND00
VALHCP99  RETURN
.---------------------------------------------------
.         Get hcp details from provider number
.---------------------------------------------------
GHCPD000  PACK      KEY30,VALDCODE,SP70
          CALL      RSPMHCL3                * check link table
          CALL      RKPMHCL3                * check link table
          BRANCH    OVRCD,GHCPD100
.
          MATCH     VALDCODE,PMHLPRV1
          GOTO      GHCPD100 IF NOT EQUAL   * found hcl provider number?
.
          PACK      KEY12,PMHLHCPR,SP70
          CALL      RSPMHCG1
          CALL      RKPMHCG1                * get hcg details
          BRANCH    OVRCD,GHCPD995
.
          MATCH     PMHGPRAC,PMHLHCPR
          GOTO      GHCPD995 IF NOT EQUAL   * can't find practice
.
          MOVE      PMHGPRAC,PRACCODE
          MOVE      PMHGPNAM,PRACNAME
          MOVE      PMHGCNTR,PRACCNTR
          MOVE      PMHLHCPC,DOCTCODE
.
          PACK      KEY10,PMHLHCPC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GHCPD995
          GOTO      GHCPD990
.
GHCPD100  PACK      KEY20,VALDCODE,SP70   
          CALL      RSPMHCP3                * check hcp table
          CALL      RKPMHCP3                * check hcp table
          BRANCH    OVRCD,GHCPD995          * can't find provider number
.
          MATCH     VALDCODE,PMHCPRV1
          GOTO      GHCPD995 IF NOT EQUAL   * can't find provider number
.
GHCPD950  MOVE      SP70,PRACCODE
          MOVE      SP70,PRACNAME
          MOVE      SP70,PRACCNTR
          MOVE      PMHCHCPC,DOCTCODE
.
GHCPD990  MOVE      PMHCTITL,DTITL
          MOVE      PMHCGNAM,DGNAME
          MOVE      PMHCSNAM,DSNAME
          CALL      DOCNAM00
          MOVE      ZERO,EXIT
          GOTO      GHCPD999
.
GHCPD995  MOVE      ONE,EXIT
GHCPD999  RETURN
+
.---------------------------------------------------
.         Get hcp details from provider number
.---------------------------------------------------
GHCPPR00  PACK      KEY20,VALDCODE,SP70
          CALL      RSPMHCP3              
GHCPPR20  CALL      RKPMHCP3
          BRANCH    OVRCD,GHCPPR99
.
          MATCH     VALDCODE,PMHCPRV1
          GOTO      GHCPPR99 IF NOT EQUAL   * found hcl provider number?
.
          MATCH     VALDHCPC,PMHCHCPC
          GOTO      GHCPPR20 IF EQUAL       * found hcp code?
.
GHCPPR95  MOVE      ONE,EXIT
GHCPPR99  RETURN
+
.---------------------------------------------------
.         Get linked hcp practice
.---------------------------------------------------
GHCPL000  MOVE      ZERO,NODEFPRA           * Default linked practice
.
          MATCH     "1",PTCNLPRA            * Don't default linked practice
          GOTO      GHCPL400 IF NOT EQUAL   * if multiple links exist
.
.         Count how many linked practices exist
.
          MOVE      ZERO,FORM3              * Linked practice count
          PACK      KEY20,PMHCHCPC,SP70
          CALL      RSPMHCL1
GHCPL100  CALL      RKPMHCL1                * read hcp link table
          BRANCH    OVRCD,GHCPL300
.
          MATCH     PMHLHCPC,PMHCHCPC
          GOTO      GHCPL300 IF NOT EQUAL
.
          MATCH     DZERO,PMHLSTAT          * is practice active?
          GOTO      GHCPL100 IF NOT EQUAL
.
          PACK      KEY12,PMHLHCPR,SP70
          CALL      RSPMHCG1
          CALL      RKPMHCG1                * get hcg details
          BRANCH    OVRCD,GHCPL300
.
          MATCH     PMHGPRAC,PMHLHCPR
          GOTO      GHCPL300 IF NOT EQUAL
.
          ADD       ONE,FORM3               * Linked practice count
          GOTO      GHCPL100
.
GHCPL300  IF        FORM3>1
            MOVE      ONE,NODEFPRA          * Don't default linked practice
          ENDIF                             * as more than one link exists
.
GHCPL400  PACK      KEY20,PMHCHCPC,SP70
          CALL      RSPMHCL1
GHCPL500  CALL      RKPMHCL1                * read hcp link table
          BRANCH    OVRCD,GHCPL950
.
          MATCH     PMHLHCPC,PMHCHCPC
          GOTO      GHCPL950 IF NOT EQUAL
.
          MATCH     DZERO,PMHLSTAT          * is practice active?
          GOTO      GHCPL500 IF NOT EQUAL
.
          PACK      KEY12,PMHLHCPR,SP70
          CALL      RSPMHCG1
          CALL      RKPMHCG1                * get hcg details
          BRANCH    OVRCD,GHCPL950
.
          MATCH     PMHGPRAC,PMHLHCPR
          GOTO      GHCPL950 IF NOT EQUAL
.
          MOVE      PMHGPRAC,PRACCODE
          MOVE      PMHGPNAM,PRACNAME
          MOVE      PMHGCNTR,PRACCNTR
          MOVE      PMHLPRV1,PRACPRV1
          GOTO      GHCPL999
.
GHCPL950  MOVE      SP70,PRACCODE
          MOVE      SP70,PRACNAME
          MOVE      SP70,PRACCNTR
          MOVE      PMHCPRV1,PRACPRV1
.
GHCPL999  RETURN
+
.------------------------------------------------------------
. Validate HCP Practice (and Linked HCP if VALDDCTR populated)
.------------------------------------------------------------
VALHCG00  PACK      VALDCODE,VALDCODE,SP70
          CALL      XMLHED00
          BRANCH    EXIT,VALHCG99
          PACK      KEY12,VALDCODE,SP70
          CALL      RSPMHCG1
          CALL      RKPMHCG1
          BRANCH    OVRCD,VALHCG90
.
          MATCH     PMHGPRAC,VALDCODE                 * valid practice ?
          GOTO      VALHCG90 IF NOT EQUAL
.
          MATCH     "0",PMHGSTTS                      * active practice ?
          GOTO      VALHCG91 IF NOT EQUAL
.
          MATCH     SP70,VALDDCTR                     * check hcp/active link
          GOTO      VALHCG80 IF EQUAL
.
          PACK      KEY20,VALDDCTR,VALDCODE,SP70
          CALL      RDPMHCL1
          BRANCH    OVRCD,VALHCG92
.
          MATCH     PMHLHCPC,VALDDCTR                 * valid linked hcp ?
          GOTO      VALHCG92 IF NOT EQUAL
.
          MATCH     "0",PMHLSTAT                      * active linked hcp ?
          GOTO      VALHCG93 IF NOT EQUAL
.
VALHCG80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PMHGPNAM,"|",PMHGCNTR:
                             "</RETURN_VALUE>"
.
          GOTO      VALHCG98
.
VALHCG90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Practice Code - ",VALDCODE:
                             "</RETURN_VALUE>"
          GOTO      VALHCG98
.
VALHCG91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Practice Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALHCG98
.
VALHCG92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid HCP/Practice Link - ":
                              VALDDCTR,"/",VALDCODE,"</RETURN_VALUE>"
          GOTO      VALHCG98
.
VALHCG93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive HCP/Practice Link - ":
                              VALDDCTR,"/",VALDCODE,"</RETURN_VALUE>"
          GOTO      VALHCG98
.
VALHCG98  CALL      XMLEND00
VALHCG99  RETURN
+
.------------------------------------------------------------
. Validate HCP Enddate against Admission date (only if HCP is Inactive)
.------------------------------------------------------------
VALDAT00  MOVE      ZERO,EXIT
          MATCH     "1",PMHCSTTS                 * Inactive HCP ? - Check dates
          GOTO      VALDAT99 IF NOT EQUAL
.
          MATCH     SP10,VALDADNO                * was Admissno passed in?
          GOTO      VALDAT90 IF EQUAL
.
....      PACK      KEY8,VALDADNO,SP10
....      CALL      RDMISS1
....      BRANCH    OVRCD,VALDAT90
....      PACK      DDATE,CCC,CYY,CMM,CDD
....      REP       " 0",DDATE
....      IF        ASTAT = 3
....        CALL      RDDSCH1
....      ENDIF
.
          MATCH     SP8,MLHCEDAT
          IF        !@EQUAL
            MATCH     ADATE,MLHCEDAT
            GOTO      VALDAT90 IF LESS
          ENDIF
.
          MOVE      "0",PMHCSTTS                 * make HCP temporaly active
          GOTO      VALDAT99
.
.
VALDAT90  IF        VALDTYPE <> 17   
            MOVE      ONE,EXIT
          ENDIF
          GOTO      VALDAT99
. 
VALDAT99  RETURN
+
.------------------------------------------------------------
. Validate LGA
.------------------------------------------------------------
VALLGA00  CALL      XMLHED00
          BRANCH    EXIT,VALLGA99
          MOVE      VALDCODE,KEY4
          CALL      RDLGAA1
          BRANCH    OVRCD,VALLGA90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             LGADESC:
                             "</RETURN_VALUE>"
          GOTO      VALLGA98
.
VALLGA90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid LGA Code - ":
                              KEY4,"</RETURN_VALUE>"
          GOTO      VALLGA98
.
VALLGA98  CALL      XMLEND00
VALLGA99  RETURN
+
.------------------------------------------------------------
. Validate Postcode
.------------------------------------------------------------
VALPCD00  CALL      XMLHED00
          BRANCH    EXIT,VALPCD99
          MOVE      VALDCODE,KEY8
          CALL      RDCATC1
          BRANCH    OVRCD,VALPCD90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             CTCCODE,"|",CTCLGA:
                             "</RETURN_VALUE>"
          GOTO      VALPCD98
.
VALPCD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Post Code - ":
                              KEY8,"</RETURN_VALUE>"
          GOTO      VALPCD98
.
VALPCD98  CALL      XMLEND00
VALPCD99  RETURN
+
.---------------------------------------------------
.         Health Fund Validation
.---------------------------------------------------
HEFUND00  CALL      XMLHED00
          BRANCH    EXIT,HEFUND99
          MOVE      ZERO,F1
          PACK      KEY6,VALDCODE,SP70
          PACK      KEY14,KEY6,SP70
          CALL      RDSFUND1
          CALL      RDKFUND1
          BRANCH    OVRCD,HEFUND90
.
          MOVE      DHFTACT,F1
          BRANCH    F1,HEFUND91
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               HFNAME:
                             "</RETURN_VALUE>"
          GOTO      HEFUND98
.
HEFUND90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Health Fund - ":
                              KEY14,"</RETURN_VALUE>"
          GOTO      HEFUND98
.
HEFUND91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Health Fund - ": 
                              KEY14,"</RETURN_VALUE>"
          GOTO      HEFUND98
.
HEFUND98  CALL      XMLEND00
.
HEFUND99  RETURN
.---------------------------------------------------
.         Health Fund Validation
.---------------------------------------------------
HFNDTB00  CALL      XMLHED00
          BRANCH    EXIT,HFNDTB99
          MOVE      ZERO,F1
          PACK      VALDFUND,VALDFUND,SP70
          PACK      VALDTABL,VALDTABL,SP70
.
          MATCH     SP70,VALDFUND
          GOTO      HFNDTB92 IF EQUAL
.
          MATCH     SP70,VALDTABL
          GOTO      HFNDTB90 IF EQUAL
.
          PACK      KEY14,VALDFUND,ZERO4,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,HFNDTB93
.
          MOVE      HFNAME,FUNDNAME
.
          PACK      KEY14,VALDFUND,VALDTABL,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,HFNDTB90
.
          MOVE      DHFTACT,F1
          BRANCH    F1,HFNDTB91
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               FUNDNAME,"|",HFNAME,"|",HFBAND,"|",PTHFBCAT:
                             "</RETURN_VALUE>"
          GOTO      HFNDTB98
.
HFNDTB90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Health Fund/Table combination - ":
                              VALDFUND," - ",VALDTABL,"</RETURN_VALUE>"
          GOTO      HFNDTB98
.
HFNDTB91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Health Fund/Table - ":
                              VALDTABL,"</RETURN_VALUE>"
          GOTO      HFNDTB98
.
HFNDTB92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Health Fund must be entered":
                              "</RETURN_VALUE>"
          GOTO      HFNDTB98
.
HFNDTB93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Health Fund":
                              "</RETURN_VALUE>"
          GOTO      HFNDTB98
.
HFNDTB98  CALL      XMLEND00
.
HFNDTB99  RETURN
.******************************************************************************
.*        Validation  for     Theatre Expensive Items (oprexpaf.dat)          *
.******************************************************************************
VALEXI00  CALL      XMLHED00
          BRANCH    EXIT,VALEXI99
          PACK      KEY6,VALDCODE,SP70
          CALL      RDOPEXP1
          BRANCH    OVRCD,VALEXI10
.
          MATCH     "1",OPEXACTV                 * Inactive
          GOTO      VALEXI20 IF EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    OPEXDESC:
                    "</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      VALEXI99
.
VALEXI10  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Invalid Expensive Item Code" :
                    "</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      VALEXI99
.
VALEXI20  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                    "Expensive Item is Inactive" :
                    "</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      VALEXI99
.
VALEXI99  RETURN
.******************************************************************************
.*            Validation for Theatre Implant Code(oprthiaf.dat)          *
.******************************************************************************
VALTIC00  CALL      XMLHED00
          BRANCH    EXIT,VALTIC99 
.
          MATCH     "1",OPCNSIVB
          GOTO      VALTIC20 IF NOT EQUAL       * Search by EAN number
.
          BRANCH    VALDTYPE,VALTIC10           * Assign Adhoc- Search for EAN
.
.         Search for a barcode
.
          PACK      VALDCODE,VALDCODE,SP70
          PACK      VALBCODE,VALBCODE,SP70
          UNPACK    VALBCODE,OPTIBCOD
          PACK      KEY75,OPTIBCOD,VALDCODE,SP70
          CALL      RDOPTHI3
          COMPARE   ZERO,OVRCD
          GOTO      VALTIC30 IF EQUAL
.
          MATCH     SP70,VALBCODE
          GOTO      VALTIC40 IF EQUAL        * blank Barcode no
.
          PACK      KEY75,VALBCODE,SP70
          CALL      RSOPTHI3
VALTIC04  CALL      RKOPTHI3
          BRANCH    OVRCD,VALTIC40
          MATCH     OPTIBCOD,VALBCODE
          GOTO      VALTIC40 IF NOT EQUAL    * same Barcode
.
          MATCH     "1",OPTISTAT
          GOTO      VALTIC04 IF EQUAL        * Inactive
.
          GOTO      VALTIC30
.
.         Search for EAN number for Ad-hoc management
.
VALTIC10  PACK      VALDCODE,VALDCODE,SP70
          UNPACK    VALDCODE,OPTICODE
          PACK      KEY75,OPTICODE,VALBCODE,SP70
          CALL      RDOPTHI1
          COMPARE   ZERO,OVRCD
          GOTO      VALTIC30 IF EQUAL
.
          MATCH     SP70,VALDCODE
          GOTO      VALTIC40 IF EQUAL        * blank EAN no
.
          PACK      KEY75,VALDCODE,SP70
          CALL      RSOPTHI1
VALTIC12  CALL      RKOPTHI1
          BRANCH    OVRCD,VALTIC40
          MATCH     OPTICODE,VALDCODE
          GOTO      VALTIC40 IF NOT EQUAL    * same EAN
.
          MATCH     "1",OPTISTAT
          GOTO      VALTIC12 IF EQUAL        * Inactive
.
          GOTO      VALTIC30
.
.         Search via EAN number
.
VALTIC20  PACK      KEY75,VALDCODE,SP70   * full read with blank EAN
          CALL      RDOPTHI1
          BRANCH    OVRCD,VALTIC40
.
VALTIC30  MATCH     "1",OPTISTAT      * Is Implant Inactive?
          IF        @EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                      "This implant is currently inactive." :
                      "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                      OPTIDESC,"|",OPTITYIM,"|",OPTIMCHG,"|":
                      OPTIMANU,"|",OPTISIZE,"|",OPTISUPP,"|":
                      OPTICOST,"|",OPTIREGI:
                      "</RETURN_VALUE>"
          ENDIF
          GOTO      VALTIC60
.
VALTIC40  WRITE   HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                     "0":
                    "</RETURN_VALUE>"
          GOTO      VALTIC60
.
VALTIC44  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                      "This implant exists for Barcode ",OPTIBCOD:
                      "</RETURN_VALUE>"
          GOTO      VALTIC60
.
.
VALTIC60  CALL      XMLEND00
          GOTO      VALTIC99
.
VALTIC99  RETURN
.******************************************************************************
.*      Validation For Surgical Table Item Code(oprsesaf.dat)              *
.******************************************************************************
VALITC00  CALL      XMLHED00
          BRANCH    EXIT,VALITC99
.
          PACK      KEY15,VALDCODE,SP70
          CALL      RDOPITE1
          IF        OVRCD=0
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                      OPITDESC:
                       "</RETURN_VALUE>";
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                       "Invalid Code - ",KEY15:
                       "</RETURN_VALUE>";
          ENDIF
          CALL      XMLEND00
          GOTO      VALITC99   
.
VALITC99  RETURN
.******************************************************************************
.*        Remote Scripting function for Default Discharge Date/Time
.******************************************************************************
DISDTM00  CALL      XMLHED00
          BRANCH    EXIT,DISDTM99
.
          STRIP     VALDCODE 
          PACK      KEY8,VALDCODE,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,DISDTM98
          COMPARE   FOUR,ASTAT              * Checks Patient is OnLeave or not
          GOTO      DISDTM10 IF EQUAL
          PACK      KEY8,CCC,CYY,CMM,CDD    * Pack KEY8 with Current Date
          REP       " 0",KEY8
          CLOCK     TIME,CTIMEIS            * Get Current Time
          MOVE      CTIMEIS,D8
          GOTO      DISDTM20
.
DISDTM10  PACK      KEY30,VALDCODE,Z70      * To read last Transfer record
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,DISDTM98
          MATCH     DTADMN,VALDCODE
          GOTO      DISDTM98 IF NOT EQUAL
          ASSIGN    TWO,MINADD
          ASSIGN    ONE,ADDFLAG
          CALL      CTME0000                * This will return TDATE & TTIME
          MOVE      TDATE,KEY8
          MOVE      TTIME,D8
.
DISDTM20  UNPACK    KEY8,CCENT,CYEAR,CMON,CDAY
          ASSIGN    ZERO,F2
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                             "|",D8:
                             "</RETURN_VALUE>";
DISDTM98  CALL      XMLEND00
.
DISDTM99  RETURN
.------------------------------------------------------------
. CTME0000  : Set Transfer time to be one second before current time
. Called By : GRET0000
. Return values : TDATE,TTIME
.------------------------------------------------------------
CTME0000  UNPACK    TTIME,CHOUR,ANS,CMIN,DIM127
          MOVE      CHOUR,FORM2
          MOVE      FORM2,FORM4D
          MULT      "60",FORM4D
          MOVE      CMIN,FORM2
          ADD       FORM2,FORM4D            * This is now total time in minutes
          IF        ADDFLAG=1
            ADD       MINADD,FORM4D         * Add minutes
          ELSE
            SUB       MINADD,FORM4D         * Subtract minutes
          ENDIF
.
          MOVE      FORM4D,SFORM4D          * Save the total time
          IF        FORM4D>=1440
            UNPACK    TDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CCENT,CC
            MOVE      CYEAR,YY
            MOVE      CMON,MM
            MOVE      CDAY,DD
            CALL      DMYCON
            ADD       ONE,JULDAY
            MOVE      JULDAY,JWKDAY
            MOVE      JULYR,JWKYER
            MOVE      JULCC,JWKCC
            CALL      JULCON
            PACK      TDATE,CC,YY,MM,DD
            REP       " 0",TDATE
          ENDIF
.
          ASSIGN    FORM4D/SIXTY,FORM4D
          ASSIGN    FORM4D*SIXTY,FORM4D
          SUB       FORM4D,SFORM4D
          MOVE      SFORM4D,F2
          MOVE      CMIN,FORM2
          IF        F2<FORM2
            MOVE      CHOUR,FORM2
            IF        FORM2=23
              ASSIGN    ZERO,FORM2          * If Hours are 23,make it as 00
            ELSE
              ADD       ONE,FORM2           * Increment Hours by 1
            ENDIF
            MOVE      FORM2,CHOUR
            REP       " 0",CHOUR
          ENDIF
          MOVE      F2,CMIN
          REP       " 0",CMIN
          PACK      TTIME,CHOUR,COLON,CMIN,DIM127
.
CTME9999  RETURN
.
.------------------------------------------------------------
. Validate Clinic Code
.------------------------------------------------------------
VALCLI00  CALL      XMLHED00
          BRANCH    EXIT,VALCLI99
.
          MATCH     SP70,CHECKSIT           * Check outpatient site file prefix
          IF        !@EQUAL
            CALL      VOTFIL00
          ENDIF
.
          MOVE      ZERO,F1
          PACK      VALDCODE,VALDCODE,SP70
          MOVE      VALDCODE,KEY6
.
          MATCH     SP70,CHECKSIT           * Check outpatient site file prefix
          IF        !@EQUAL
            PACK      KEY20,CHECKSIT,KEY6,Z70
          ELSE
            PACK      KEY20,WBSESIT,KEY6,Z70
          ENDIF
.
          CALL      RDSCLIA1 
VALCLI10  CALL      RDPCLIA1 
          BRANCH    OVRCD,VALCLI90
.
          MATCH     SP70,CHECKSIT           * Check site
          IF        !@EQUAL
            MATCH     CHECKSIT,OCASITE
            GOTO      VALCLI90 IF NOT EQUAL
          ELSE
            MATCH     WBSESIT,OCASITE
            GOTO      VALCLI90 IF NOT EQUAL
          ENDIF

          MOVE      VALDCODE,KEY6                * Same Clinic Id
          MATCH     KEY6,OCACLIN
          GOTO      VALCLI90 IF NOT EQUAL
.
          MOVE      OTCLIACT,F1                  * Inactive
          BRANCH    F1,VALCLI91

          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OCADESC:
                             "</RETURN_VALUE>"
          GOTO      VALCLI98
.
VALCLI90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Clinic ID - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALCLI98
.
VALCLI91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Clinic ID - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALCLI98
.
VALCLI98  CALL      XMLEND00
.
VALCLI99  RETURN
+
.------------------------------------------------------------
. Validate effective date 
.------------------------------------------------------------
VALDCL00  CALL      XMLHED00
          BRANCH    EXIT,VALDCL99
.
          MATCH     SP70,CHECKSIT           * Check outpatient site file prefix
          IF        !@EQUAL
            CALL      VOTFIL00
          ENDIF
.
          MOVE      ZERO,F1
          PACK      VALDCODE,VALDCODE,SP70
          MOVE      VALDCODE,KEY6
.
          MATCH     SP70,CHECKSIT           * Outpatient site 
          IF        !@EQUAL
            PACK      KEY20,CHECKSIT,KEY6,LSTEDATE,Z70
          ELSE
            PACK      KEY20,WBSESIT,KEY6,LSTEDATE,Z70
          ENDIF
.
          CALL      RDCLIA1
          IF        OVRCD<>1
            GOTO      VALDCL11
          ENDIF
.
          CALL      RDSCLIA1
VALDCL10  CALL      RDPCLIA1
          BRANCH    OVRCD,VALDCL95                                  * CAR 281536
.
VALDCL11  MATCH     SP70,CHECKSIT
          IF        !@EQUAL
            MATCH     OCASITE,CHECKSIT
            GOTO      VALDCL95 IF NOT EQUAL
          ELSE
            MATCH     OCASITE,WBSESIT
            GOTO      VALDCL95 IF NOT EQUAL
          ENDIF
.
          MOVE      VALDCODE,KEY6                * Same Clinic Id
          MATCH     KEY6,OCACLIN
          GOTO      VALDCL95 IF NOT EQUAL                           * CAR 281536
.
          MOVE      OTCLIACT,F1                  * Inactive
          BRANCH    F1,VALDCL91

          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OCADESC:
                             "</RETURN_VALUE>"
          GOTO      VALDCL98
.
VALDCL91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Clinic ID - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALDCL98
.                                                                   * CAR 281536
VALDCL95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Clinic ID - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALDCL98
.
VALDCL98  CALL      XMLEND00
.
VALDCL99  RETURN
+
.------------------------------------------------------------
.         Case Team - Responsible HCP - CAR 186516
.           List Case Team based on HCP code
.------------------------------------------------------------
.
VALCAS00  CALL      XMLHED00
          BRANCH    EXIT,VALCAS99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>"
.
          PACK      VALDCODE,VALDCODE,SP70
          PACK      KEY20,VALDCODE,SP70
          CALL      RSALCTM2
VALCAS10  CALL      RKALCTM2
          BRANCH    OVRCD,VALCAS50
.
          MATCH     SP70,VALDRDAT           * Referral Date?
          GOTO      VALCAS20 IF EQUAL
.
          MATCH     SP70,ALCTEDAT           * End Date?
          IF        !@EQUAL
            MATCH     VALDRDAT,ALCTEDAT     * Is End Date before Referral Date?
            GOTO      VALCAS10 IF LESS
          ENDIF
.
VALCAS20  MATCH     ALCTHCPC,VALDCODE
          GOTO      VALCAS50 IF NOT EQUAL
.
          PACK      KEY10,ALCTTEAM,SP70
          CALL      RDALCAS1
          BRANCH    OVRCD,VALCAS10
.
          MATCH     "2",ALCAACTV           * Check Active - Exclude from PRIMHD
          GOTO      VALCAS40 IF EQUAL
.
          MATCH     "1",ALCAACTV           * Check Active
          GOTO      VALCAS10 IF NOT EQUAL
          GOTO      VALCAS40 IF EQUAL
.
VALCAS40  WRITE     HTMLFILE;ALCATEAM,":",ALCADESC,"|";
          GOTO      VALCAS10
.
VALCAS50  WRITE     HTMLFILE;"</RETURN_VALUE>"
.
VALCAS98  CALL      XMLEND00
.
VALCAS99  RETURN
+
.------------------------------------------------------------
.         Case Team - Responsible HCP - CAR 186516
.           List HCP (Code/Name) based on Case Team Number
.------------------------------------------------------------
.
VALCHC00  CALL      XMLHED00
          BRANCH    EXIT,VALCHC99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>"
.
          PACK      VALDCODE,VALDCODE,SP70
          PACK      KEY20,VALDCODE,SP70
          CALL      RSALCTM1
VALCHC10  CALL      RKALCTM1
          BRANCH    OVRCD,VALCHC50
.
          MATCH     ALCTTEAM,VALDCODE
          GOTO      VALCHC50 IF NOT EQUAL
.
          MATCH     SP70,VALDRDAT
          GOTO      VALCHC20 IF EQUAL 
.
          MATCH     SP70,ALCTEDAT
          IF        !@EQUAL
            MATCH     VALDRDAT,ALCTEDAT
            GOTO      VALCHC10 IF LESS
          ENDIF 
.
VALCHC20  PACK      KEY10,ALCTHCPC,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,VALCHC10
.
          MOVE      PMHCSTTS,FORM1
          BRANCH    FORM1,VALCHC10
.               
          MOVE      SP70,PRACCODE
          MOVE      SP70,PRACNAME
          MOVE      SP70,PRACCNTR
.
          MOVE      PMHCHCPC,DOCTCODE
.
          MOVE      PMHCTITL,DTITL
          MOVE      PMHCGNAM,DGNAME
          MOVE      PMHCSNAM,DSNAME
          CALL      DOCNAM00
.          
          WRITE     HTMLFILE;DOCTCODE,":",DOCFNAME,"|";
          GOTO      VALCHC10
.
VALCHC50  WRITE     HTMLFILE;"</RETURN_VALUE>"
.
VALCHC98  CALL      XMLEND00
.
VALCHC99  RETURN
+
.------------------------------------------------------------
. Validate Waiting Unit/Consultant 
.------------------------------------------------------------
VALWAT00  CALL      XMLHED00
          BRANCH    EXIT,VALWAT99
          MOVE      ZERO,F1
          PACK      KEY9,VALDCODE,SP70
          CALL      RSWTVWL1 
VALWAT10  CALL      RKWTVWL1
          BRANCH    OVRCD,VALWAT90
          PACK      KEY6,VALDCODE,SP70
          MATCH     KEY6,WTVWCONS
          GOTO      VALWAT90 IF NOT EQUAL 
          MOVE      WTVWSTAT,F1
          BRANCH    F1,VALWAT10
.
          PACK      KEY6,WTVWCONS,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,VALWAT90
          BRANCH    DRSTAT,VALWAT92
          CALL      DOCNAM00
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",WTVWLTYP:
                             "</RETURN_VALUE>"
          GOTO      VALWAT98
.
VALWAT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Doctor Code - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALWAT98
.
VALWAT91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive  Unit Code - ":
                              KEY9,"</RETURN_VALUE>"
          GOTO      VALWAT98
.
VALWAT92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive  Doctor Code - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALWAT98
.
VALWAT98  CALL      XMLEND00
.
VALWAT99  RETURN
.
.---------------------------------------------------------------
.   validation of the Procedure code
.---------------------------------------------------------------
VALPRO00  CALL      XMLHED00
          BRANCH    EXIT,VALPRO99
          MOVE      ZERO,F1
          PACK      VALDCODE,VALDCODE,SP70
          MATCH     SP70,VALDCODE
          GOTO      VALPRO90 IF EQUAL
          PACK      KEY9,VALDCODE,SP70
          CALL      RDPROA1
          BRANCH    OVRCD,VALPRO90
          MOVE      WTWPACTV,F1
          BRANCH    F1,VALPRO91
.

          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             WPDESC,"|",WPGRP,"|",WPESTLS,"|",WPTIME,"|",WPRHAT:
                             "</RETURN_VALUE>"
          GOTO      VALPRO98
.
VALPRO90  IF        PTCNHDPS = 1
            MATCH     SP70,VALDDEFV
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                                 "Invalid Procedure Code - ",KEY9:
                                 "</RETURN_VALUE>"
            ELSE
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                                 "Invalid Procedure Code - ",KEY9:
                                 " Use Supervisor Options to Change Procedure":
                                 "</RETURN_VALUE>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Invalid ESIS Code - ":
                                KEY9,"</RETURN_VALUE>"
          ENDIF
.
          GOTO      VALPRO98
.
VALPRO91  IF        PTCNHDPS = 1
            MATCH     SP70,VALDDEFV
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                                 "Inactive Procedure Code - ",KEY9:
                                 "</RETURN_VALUE>"
            ELSE
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                                 "Inactive Procedure Code - ",KEY9:
                                 " Use Supervisor Options to Change Procedure":
                                 "</RETURN_VALUE>"
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Inactive  ESIS Code - ":
                                KEY9,"</RETURN_VALUE>"
          ENDIF
.
          GOTO      VALPRO98
.
VALPRO98  CALL      XMLEND00
.
VALPRO99  RETURN
.
.------------------------------------------------------------
. Validate Doctor/Unit Combination
.------------------------------------------------------------
VALDUN00  CALL      XMLHED00
          BRANCH    EXIT,VALDUN99
          MOVE      ZERO,F1
          PACK      KEY9,VALDFUND,VALDTABL,SP70
          CALL      RDPMDUN1
          BRANCH    OVRCD,VALDUN90
.
          PACK      KEY6,PMDUDOCT,SP70
          CALL      RDDOCT1
          BRANCH    OVRCD,VALDUN90
          BRANCH    DRSTAT,VALDUN92
          CALL      DOCNAM00
.
          PACK      KEY5,ANSA,ANSC,PMDUUNIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VALDUN94
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DOCFNAME,"|",PMDUUNIT:
                             "</RETURN_VALUE>"
          GOTO      VALDUN98
.
VALDUN90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Doctor Unit Combination - ":
                              VALDCODE,SP2,VALDCATC,"</RETURN_VALUE>"
          GOTO      VALDUN98
.
VALDUN92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive  Doctor Code - ":
                              KEY6,"</RETURN_VALUE>"
          GOTO      VALDUN98
.
VALDUN94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Unit - ":
                              PMDUUNIT,"</RETURN_VALUE>"
          GOTO      VALDUN98
.
VALDUN98  CALL      XMLEND00
.
VALDUN99  RETURN
.
.------------------------------------------------------------
. Output Select Options for Unit depending on consultant
.------------------------------------------------------------
SELUNI00  CALL      XMLHED00
          BRANCH    EXIT,SELUNI99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY9,VALDCODE,SP70
          CALL      RSPMDUN1
SELUNI10  CALL      RKPMDUN1
          BRANCH    OVRCD,SELUNI19

          MATCH     VALDCODE,PMDUDOCT
          GOTO      SELUNI19 IF NOT EQUAL
.
          PACK      KEY5,ANSA,ANSC,PMDUUNIT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,SELUNI19
.
          MATCH     ACODE,SP70
          GOTO      SELUNI10 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SELUNI10 IF EQUAL
          PACK      KEY40,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV,PTCDASC1,SP70
          PACK      KEY45,ACODE,KEY40
          WRITE     HTMLFILE;KEY45,",",TDESC,"|";
          GOTO      SELUNI10
.
SELUNI19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELUNI98
.
SELUNI98  CALL      XMLEND00
SELUNI99  RETURN
.
.------------------------------------------------------------
. Output Select Options for Case Team depending on consultant
.------------------------------------------------------------
SELCAS00  CALL      XMLHED00
          BRANCH    EXIT,SELCAS99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY20,VALDCODE,SP70
          CALL      RSALCTM2
SELCAS10  CALL      RKALCTM2
          BRANCH    OVRCD,SELCAS19

          MATCH     VALDCODE,ALCTHCPC
          GOTO      SELCAS19 IF NOT EQUAL
.
          PACK      KEY10,ALCTTEAM,SP70
          CALL      RDALCAS1
          BRANCH    OVRCD,SELCAS19
.
          MATCH     "2",ALCAACTV           * Check Active - exclude from PRIMHD
          GOTO      SELCAS15 IF EQUAL
.
          MATCH     "1",ALCAACTV           * Check Active
          GOTO      SELCAS10 IF NOT EQUAL   * not active
          GOTO      SELCAS15 IF EQUAL
.
SELCAS15  PACK      KEY18,ACODE,KEY15
          WRITE     HTMLFILE;ALCATEAM,",",ALCADESC,"|";
          GOTO      SELCAS10
.
SELCAS19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELCAS98
.
SELCAS98  CALL      XMLEND00
SELCAS99  RETURN
.
.------------------------------------------------------------
. Select RCP Cashier Drawers by Hospital Id.
.------------------------------------------------------------
SELCSD00  CALL      XMLHED00
          BRANCH    EXIT,SELCSD99
.
          PACK      KEY3,VALDCODE,SP3       * get Hospital Id
          MOVE      KEY3,VALDCODE
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY6,SP70
          CALL      RDSCIDA1
SELCSD10  CALL      RDKCIDA1
          BRANCH    OVRCD,SELCSD50
.
          MATCH     VALDCODE,RCCIHOSP
          GOTO      SELCSD10 IF NOT EQUAL
.
          MATCH     "1",RCCIACTV
          GOTO      SELCSD10 IF EQUAL   * Inactive
.
          STRIP     RCPGIVEN
          STRIP     RCPSUR
          PACK      KEY30,RCPGIVEN,SP1,RCPSUR,SP20
          MOVE      "0",KEY1
          MATCH     SP6,RCPPASS
          IF        !@EQUAL
            MOVE      "1",KEY1
          ENDIF
          PACK      KEY7,RCPCASH,KEY1
.
SELCSD20  CLEAR     KEY45
          APPEND    "(",KEY45
          APPEND    RCPCASH,KEY45
          APPEND    ") ",KEY45
          APPEND    KEY30,KEY45
          RESET     KEY45
          WRITE     HTMLFILE;KEY7,",",KEY45,"|";
          GOTO      SELCSD10
.
SELCSD50  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELCSD98
.
SELCSD98  CALL      XMLEND00
SELCSD99  RETURN
.
.------------------------------------------------------------
. Select RCP Registers by Hospital Id.
.------------------------------------------------------------
SELREG00  CALL      XMLHED00
          BRANCH    EXIT,SELREG99
.
          PACK      KEY3,VALDCODE,SP3
          MOVE      KEY3,VALDCODE
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY3,SP70
          CALL      RDSREGA1
SELREG10  CALL      RDKREGA1
          BRANCH    OVRCD,SELREG50
.
          MATCH     "1",REGACTIV
          GOTO      SELREG10 IF EQUAL
          MATCH     VALDCODE,REGHOSP
          GOTO      SELREG10 IF NOT EQUAL
.
          MATCH     "1",KEY1                * check for HFund, PP, AcctRec
          IF        @EQUAL
            IF        REGIBACD=1 | REGIBACD=2 | REGIBACD=5 | REGIBACD=99
              GOTO      SELREG20
            ENDIF
            GOTO    SELREG10
          ENDIF
.
SELREG20  CLEAR     KEY45
          APPEND    "(",KEY45
          APPEND    REGCODE,KEY45
          APPEND    ") ",KEY45
          APPEND    REGDESC,KEY45
          RESET     KEY45
          WRITE     HTMLFILE;REGCODE,",",KEY45,"|";
          GOTO      SELREG10
.
SELREG50  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELREG98
.
SELREG98  CALL      XMLEND00
SELREG99  RETURN
.
.------------------------------------------------------------
. Check parameter for G/L interface 
.------------------------------------------------------------
CHKGLI00  CALL      XMLHED00
          BRANCH    EXIT,CHKGLI99
.
          MOVE      "0",KEY1
          COMPARE   ONE,IBCNMHOS
          GOTO      CHKGLI70 IF EQUAL    * multi hospital
.
          IF        CGLIND=1
            MOVE      "1",KEY1
          ENDIF
          GOTO      CHKGLI80
.
CHKGLI70  PACK      KEY3,VALDCODE
          CALL      RDPTHSP1
          BRANCH    OVRCD,CHKGLI90
.
          MATCH     "1",PTHSPTIN
          IF        @EQUAL
            MOVE      "1",KEY1
          ENDIF
.
CHKGLI80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             KEY1:
                             "</RETURN_VALUE>"
          GOTO      CHKGLI98
.
CHKGLI90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Hospital ID- ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      CHKGLI98
.
CHKGLI98  CALL      XMLEND00
CHKGLI99  RETURN
+
.------------------------------------------------------------
. Validate Misc.Charge or Regime code
.------------------------------------------------------------
VALRMS00  CALL      XMLHED00
          BRANCH    EXIT,VALRMS99
          MOVE      ZERO,F1
.
          PACK      VALDCODE,VALDCODE,SP70
          MATCH     SP70,VALDCODE
          GOTO      VALRMS90 IF EQUAL
.
          PACK      KEY10,VALDCODE
          PACK      PMREREGM,VALDCODE,SP70
          MOVE      "  0",PMREUNIQ
          PACK      KEY13,PMREREGM,PMREUNIQ,SP70
          CALL      RDPMREG1
          BRANCH    OVRCD,VALRMS90
.
          MOVE      PMREACTV,F1
          BRANCH    F1,VALRMS91
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PMREDESC,"|",PMREITYP:
                             "</RETURN_VALUE>"
          GOTO      VALRMS98
.
VALRMS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Regime Code - ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      VALRMS98
.
VALRMS91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Regime Code - ":
                              KEY10,"</RETURN_VALUE>"
          GOTO      VALRMS98
.
VALRMS98  CALL      XMLEND00
VALRMS99  RETURN
+
.------------------------------------------------------------
. Output Select Options for Selected Category Code and text match
.------------------------------------------------------------
SELDCD00  CALL      XMLHED00
          BRANCH    EXIT,SELDCD99
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";

          PACK      KEY2,VALDCATC,SP70
          PACK      PTCDKEY2,KEY2,SP70
          CALL      RDSCODE2
SELDCD10  CALL      RDKCODE2
          BRANCH    OVRCD,SELDCD19
          MATCH     KEY2,TCODE
          GOTO      SELDCD19 IF NOT EQUAL
          MATCH     ACODE,SP70
          GOTO      SELDCD10 IF EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SELDCD10 IF EQUAL
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,SELDCD10
            ENDIF
          ENDIF
.
          MATCH     VALDCODE,TDESC
          GOTO      SELDCD10 IF NOT EQUAL
.
          PACK      KEY40,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD,PTCDNHCP,TCFORM6:
                          TCINDC12,TCINDC13,TCINDC14,TCINDC15,TCINDC16:
                          TCINDC17,TCINDC18,TCINDC19,TCINDC20,TCINDC21:
                          PTCOACTV,PTCDASC1,SP70
          PACK      KEY45,ACODE,KEY40
          WRITE     HTMLFILE;KEY45,",",TDESC,"|";

..          WRITE     HTMLFILE;ACODE,",",TDESC,"|";

          GOTO      SELDCD10
.
SELDCD19  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      SELDCD98
.
SELDCD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid ??? - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      SELDCD98
.
SELDCD98  CALL      XMLEND00
SELDCD99  RETURN
.------------------------------------------------------------
. Validate Patient U/R
.------------------------------------------------------------
UREXIS00  PACK      DIM60,SP70
          CALL      XMLHED00
          BRANCH    EXIT,UREXIS99
.
          MOVE      ZERO,EXISTFLG      * Set U/R exists to no
          MOVE      VALDCODE,KEY8
          CALL      RDMAST1
          COMPARE   ZERO,OVRCD
          GOTO      UREXIS40 IF EQUAL
.
          RJUSTIFY  KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,UREXIS50
.
UREXIS40  MOVE      ONE,EXISTFLG       * Set U/R exists to yes
          STRIP     PSNAME
          STRIP     PGNAME
          STRIP     PTITL
.
          PACK      DIM60,PTITL,SP1,PSNAME,SP1,PGNAME
.
UREXIS50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             EXISTFLG,"|",DIM60:
                             "</RETURN_VALUE>"
          GOTO      UREXIS98
.
UREXIS98  CALL      XMLEND00
UREXIS99  RETURN
.------------------------------------------------------------
. Validate Theatre Upload Done 
.------------------------------------------------------------
VALTUD00  CALL      XMLHED00
          BRANCH    EXIT,VALTUD99
          PACK      VALDDATE,CCC,CYY,CMM,CDD
          REP       " 0",VALDDATE
          PACK      KEY71,VALDDATE,SP70
          CALL      RSOPUP1
VALTUD20  CALL      RKOPUP1
          BRANCH    OVRCD,VALTUD80
.
          MATCH     VALDDATE,OPUPDATE
          GOTO      VALTUD80 IF NOT EQUAL
.
          MATCH     VALDCODE,OPUPMANF
          GOTO      VALTUD20 IF NOT EQUAL
.
          GOTO      VALTUD90
.
VALTUD80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "File OK to go ":
                             "</RETURN_VALUE>"
.
          GOTO      VALTUD98
.
VALTUD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "File already Processed ":
                             "</RETURN_VALUE>"
          GOTO      VALTUD98
.
VALTUD98  CALL      XMLEND00
VALTUD99  RETURN
+
.------------------------------------------------------------
. Validate Theatre fees
.------------------------------------------------------------
GETMSC00  MOVE      ZERO,EXIT
          MOVE      SP3,MMSCGRP
          MOVE      ZERO,TCFORM6
          MOVE      ZERO,INVALDFL
.                                                                     *I-119158
          MOVE      CURRDATE,KEY8
          PACK      RETURNDT,RETURNDT,SP70
          MATCH     SP8,RETURNDT
          IF        !@EQUAL
            MOVE      RETURNDT,KEY8
          ENDIF
          REP      " 0",KEY8
.
          MOVE      MCHARGE,KEY9
.
.
          MOVE      SP10,PTHFBCAT           * convert "Table" to "Table Type"
          PACK      KEY14,AFUNDH,AFNDTB,SP20   
          CALL      RDFUND1                 * find correct "Table Type"
.
.         Check for miscellaneous item code
.
GETMSC10  MOVE      SP1,KEY1                * MBS item can be changed
          PACK      KEY29,ACLAIM,AFUNDH,PTHFBCAT,KEY9,KEY8,SP10
          CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      GETMSC50 IF EQUAL
.
          MOVE      ONE,INVALDFL
.
.         No record with health fund details - try a blank health fund
.
GETMSC20  PACK      KEY29,ACLAIM,SP6,SP3,KEY9,KEY8,SP10
          CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      GETMSC50 IF EQUAL
.
          MOVE      ONE,INVALDFL
.
.         No record with health fund details - last chance, try default claim
.
GETMSC30  IF        IBCNMHOS=1
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,KEY8,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,KEY8,SP10
          ENDIF
.
          CALL      PATMCHRD                * read Misc.Charges file 
          COMPARE   ZERO,EXIT
          GOTO      GETMSC50 IF EQUAL
.
          MOVE      ONE,INVALDFL
.
          GOTO      GETMSC90
.
GETMSC50  MOVE      MDESC,PTITDESC
          MOVE      MPATPOR,QIAMT
          ADD       MHFPOR,QIAMT
          MOVE      ZERO,INVALDFL
          MOVE      ZERO,EXIT
          GOTO      GETMSC99
.
GETMSC90  MOVE      ONE,EXIT
GETMSC99  RETURN
+
.------------------------------------------------------------
. Validate NZ Private Miscellaneous Item
.------------------------------------------------------------
NZPMSC00  MOVE      ZERO,EXIT
          MOVE      SP3,MMSCGRP
          MOVE      ZERO,TCFORM6
          MOVE      ZERO,F1
.
          OPEN      NZPMCHA1,"nzpmchaf"
.
          PACK      KEY8,CCC,CYY,CMM,CDD
          MATCH     SP8,RETURNDT
          IF        !@EQUAL
            MOVE      RETURNDT,KEY8
          ENDIF
          REP       " 0",KEY8
.
          MOVE      MCHARGE,KEY9
.
.         Check for miscellaneous item code
.
          MOVE      ONE,F1
          MOVE      SP1,KEY1              * MBS item can be changed
          MATCH     SP70,VALDUNIQ
          GOTO      NZPMSC05 IF EQUAL
.
          PACK      KEY11,VALDADNO,VALDUNIQ,SP70
          CALL      RDNZSPR1
          BRANCH    OVRCD,NZPMSC05
.
          PACK      ACLAIM,NZSPCLMN,SP70
          PACK      AFUNDH,NZSPCNTR,SP70
          PACK      AFNDTB,SP70
  
NZPMSC05  PACK      KEY29,PMVXMHOS,ACLAIM,AFUNDH,AFNDTB,KEY9
          PACK      KEY37,PMVXMHOS,ACLAIM,AFUNDH,AFNDTB,KEY9,KEY8
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC20
          GOTO      NZPMSC80
.
.         No record with health fund details - try a blank health fund
.
NZPMSC20  PACK      KEY29,PMVXMHOS,ACLAIM,SP10,SP2,SP2,KEY9
          PACK      KEY37,PMVXMHOS,ACLAIM,SP10,SP2,SP2,KEY9,KEY8
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC30
          GOTO      NZPMSC80
.
.         No record with health fund details - try default claim, blank hf
.
NZPMSC30  IF        IBCNMHOS=1
            PACK      KEY29,PMVXMHOS,PTHSDCLM,SP10,SP2,SP2,KEY9
            PACK      KEY37,PMVXMHOS,PTHSDCLM,SP10,SP2,SP2,KEY9,KEY8
          ELSE
            PACK      KEY29,PMVXMHOS,PTCNDCLM,SP10,SP2,SP2,KEY9
            PACK      KEY37,PMVXMHOS,PTCNDCLM,SP10,SP2,SP2,KEY9,KEY8
          ENDIF
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC40
          GOTO      NZPMSC80
.
.         No record for the hosp.- try with blank hosp,claim,hf
.
NZPMSC40  PACK      KEY29,SP3,ACLAIM,AFUNDH,AFNDTB,KEY9
          PACK      KEY37,SP3,ACLAIM,AFUNDH,AFNDTB,KEY9,KEY8
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC50
          GOTO      NZPMSC80
.
.
.         No record for the hosp.- try with blank hosp,claim,blank hf
.
NZPMSC50  PACK      KEY29,SP3,ACLAIM,SP10,SP2,SP2,KEY9
          PACK      KEY37,SP3,ACLAIM,SP10,SP2,SP2,KEY9,KEY8
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC70
          GOTO      NZPMSC80
.
.         No record for the hosp.- try with blank hosp,default claim,blank hf
.
NZPMSC70  IF        IBCNMHOS=1
            PACK      KEY29,SP3,PTHSDCLM,SP10,SP2,SP2,KEY9
            PACK      KEY37,SP3,PTHSDCLM,SP10,SP2,SP2,KEY9,KEY8
          ELSE
            PACK      KEY29,SP3,PTCNDCLM,SP10,SP2,SP2,KEY9
            PACK      KEY37,SP3,PTCNDCLM,SP10,SP2,SP2,KEY9,KEY8
          ENDIF
          CALL      RDMSC000
          BRANCH    EXIT,NZPMSC90
.
NZPMSC80  MOVE      NZMCDESC,MDESC
          MOVE      MDESC,PTITDESC
          MOVE      NZMCKPRI,PTMCKREB
.
          MOVE      NZMCCLMC,MCLMCOD
          MOVE      NZMCCNTR,MHFUND
          MOVE      NZMCFTAB,PTMCHFTT
          MOVE      NZMCMCHG,MCHARGE
          MOVE      NZMCEFDT,PTMCEFDT
          MOVE      NZMCPATP,MPATPOR
          MOVE      NZMCREBP,MHFPOR
          MOVE      NZMCINDC,MINDIC
.
NZPMSC82  MOVE      MPATPOR,QIAMT
          ADD       MHFPOR,QIAMT
          MOVE      ZERO,EXIT
          GOTO      NZPMSC99
.
NZPMSC90  MOVE      ONE,EXIT
NZPMSC99  RETURN
+
.------------------------------------------------------------
.         Read NZ Misc.charge item file
.------------------------------------------------------------
RDMSC000  CALL      RDNZMCH1
          IF        OVRCD=0
            MATCH     "1",NZMCACFL                * Inactive?
            GOTO      RDMSC800 IF NOT EQUAL       * No
          ENDIF
.
RDMSC100  CALL      RPNZMCH1
          BRANCH    OVRCD,RDMSC900
.
          PACK      KEY29A,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG
          MATCH     KEY29,KEY29A
          GOTO      RDMSC900 IF NOT EQUAL
.
          MATCH     "1",NZMCACFL                * Inactive?
          GOTO      RDMSC100 IF EQUAL           * Yes
.
          MATCH     NZMCEFDT,KEY8           * effective date => serv. date ?
          GOTO      RDMSC900 IF LESS        * yes
.
          MATCH     SP70,NZMCEEDT
          IF        !@EQUAL
            MATCH     KEY8,NZMCEEDT
            GOTO      RDMSC900 IF LESS
          ENDIF
.
RDMSC800  MOVE      ZERO,EXIT
          GOTO      RDMSC999
.
RDMSC900  MOVE      ONE,EXIT
RDMSC999  RETURN
+
.------------------------------------------------------------
.      Get the total item amount for the content of Pack item
.------------------------------------------------------------
NZPAC000  PACK      KEY37,NZMCHOSP,NZMCCLMC,NZMCCNTR,NZMCFTAB,NZMCMCHG:
                          NZMCEFDT,SP70
          PACK      SAVKEY37,KEY37,SP70
          MOVE      ZERO,PPACKITM
          MOVE      ZERO,FPACKITM
.
          PACK      KEY40,KEY37,SP70
          CALL      RSNZMXC1
NZPAC100  CALL      RKNZMXC1
          BRANCH    OVRCD,NZPAC800
.
          PACK      DIM37,NZMXHOSP,NZMXCLMC,NZMXCNTR,NZMXFTAB,NZMXMCHG:
                              NZMXEFDT,SP70
.
          MATCH     DIM37,SAVKEY37
          GOTO      NZPAC800 IF NOT EQUAL
.
          PACK      MCHARGE,NZMXITMN,SP70       * item code of pack item
          CALL      NZPMSC00
          BRANCH    EXIT,NZPAC100               * invalid misc.item
.
          MOVE      NZMXQNTY,FORM4
          MULT      FORM4,NZMCPATP
          MULT      FORM4,NZMCREBP
          ADD       NZMCPATP,PPACKITM
          ADD       NZMCREBP,FPACKITM
          GOTO      NZPAC100
.
NZPAC800  MOVE      SAVKEY37,KEY37
          CALL      RDNZMCH1                 * reposition to Pack item
.
          MOVE      PPACKITM,NZMCPATP
          MOVE      FPACKITM,NZMCREBP
          MOVE      PPACKITM,MPATPOR
          MOVE      FPACKITM,MHFPOR
          MOVE      MPATPOR,QIAMT
          ADD       MHFPOR,QIAMT
.
NZPAC999  RETURN
+
.------------------------------------------------------------
.         VDAT0000 - Validate the item date
.------------------------------------------------------------
VDAT0000  MOVE      ZERO,EXIT
          MOVE      SP10,DDATE
          MOVE      ZERO,CMIXFLAG
          MOVE      SP70,CONTRCID
.
          PACK      CDATE,CCC,CYY,CMM,CDD
          REP       " 0",CDATE
          MOVE      VALDADNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,VDAT9400
          MOVE      ANSN,PTMICMXP
.
          MOVE      VALDADNO,KEY8
          CALL      RDPMVX11
          BRANCH    OVRCD,VDAT9400
.
          BRANCH    PVITYPE,VDAT1000,VDAT2000,VDAT3000
.
          IF        PVITYPE=9
            MATCH     " 1",PVISYST
            IF        @EQUAL
              CALL      CEVN0000             * Check Event file
            ENDIF
          ENDIF
          GOTO      VDAT9999
.
.         Emergency
.
VDAT1000  MOVE      PVIBILL,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,VDAT9300
.
          MOVE      EMVIDATE,ADATE
          IF        EMVISTAT=3
            MOVE      EMVIDDAT,DDATE        * Discharged complete
          ENDIF
          MOVE      EMVICOMP,ACLAIM
          MOVE      EMVIFUND,AFUNDH
          MOVE      EMVITABL,AFNDTB
          GOTO      VDAT5000
.
VDAT2000  CALL      COTFIL00                * check prefix on outpatient files
.
          MOVE      PVIBILL,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,VDAT9300
          MOVE      OBADATE,ADATE
          MOVE      OBADATE,DDATE
          MOVE      OBACOMP,ACLAIM
          MOVE      OTBBFUND,AFUNDH
          MOVE      OTBBTBLE,AFNDTB
          GOTO      VDAT5000
.
VDAT3000  MOVE      PVIBILL,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,VDAT9300
          IF        ASTAT=3
            CALL      RDDSCH1
            BRANCH    OVRCD,VDAT9500
          ENDIF
.
          MATCH     ANSY,PTMICMXP
          GOTO      VDAT5000 IF NOT EQUAL
          MATCH     SP10,PTMIPCMX
          GOTO      VDAT5000 IF EQUAL
.
          PACK      KEY9,ACLAIM,AFUNDH
          CALL      GETCNEFF               * Get Contract Effective From
          BRANCH    EXIT,VDAT5000
.
          MOVE      PTMIPCMX,CMCODE
          PACK      KEY18,ACLAIM,AFUNDH,CMCODE,SP70
          MOVE      RETURNDT,CEFFDATE
          LOAD      CEFFDATE,CNTRCEFR,ADATE,DDATE
.
.         If Contract Effective From is 'For Discharges From', Discharged date
.         is blank and TCINDC19=D, default Effective date to Service date
.
          IF        CNTRCEFR=2
            PACK      DDATE,DDATE,SP70
            MATCH     SP70,DDATE
            IF        @EQUAL
              PACK      KEY5,ANSC,ANSL,ACLAIM
              CALL      RDCODE1
              IF        OVRCD=0
                MATCH     "D",TCINDC19
                IF        @EQUAL
                  MOVE      RETURNDT,CEFFDATE
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          CALL      VALCMXFN              * get the contract ID (CONTRCID)
          BRANCH    EXIT,VDAT5000
          MOVE      ONE,CMIXFLAG           * casemix patient
.
.         Check the claim code - if MBS amount will be used for charging
.
VDAT5000  MOVE      ZERO,CMBSFEE
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            CMATCH    "1",TCINDC1           * check if overseas
            IF        @EQUAL
              CMATCH    "1",TCINDC2         * check if we are using MBS Amount
              IF        @EQUAL
                MOVE      ONE,CMBSFEE
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP1,DAYCASE
          MOVE      ZERO,PTCTDCAS
          MATCH     SP10,DDATE
          GOTO      VDAT8000 IF EQUAL
.
          MATCH     RETURNDT,DDATE
          GOTO      VDAT7000 IF NOT LESS  * Item date is before Disc.
          GOTO      VDAT9200
.
.         Commented out allowing entering items 24 hrs after Disharged date
.         as currenly items entered after discharged date will not be on the 
.         invoice
.
.         MOVE      AURNO,KEY8
.         CALL      RDMAST1
.         BRANCH    OVRCD,VDAT9200
.
.         COMPARE   ONE,PCEASE            * if patient is not deceased
.         GOTO      VDAT9200 IF NOT EQUAL * date must be before discharged date
.
.         Only allow entering items after 24 hrs of deceased time
.
.         UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
.         MOVE      CCENT,CC
.         MOVE      CYEAR,YY
.         MOVE      CMON,MM
.         MOVE      CDAY,DD
.         CALL      DMYCON
.         ADD       ONE,JULDAY
.         MOVE      JULDAY,JWKDAY
.         MOVE      JULYR,JWKYER
.         MOVE      JULCC,JWKCC
.         CALL      JULCON
.         PACK      KEY8,CC,YY,MM,DD
.         REP       " 0",KEY8
.         MATCH     RETURNDT,KEY8
.         GOTO      VDAT9200 IF LESS     * Date must be before 24hrs after Disc.
.
VDAT7000  IF        PVITYPE=3
            MATCH     DDATE,ADATE
            IF        @EQUAL
              MOVE      ANSD,DAYCASE     * Daycase
              MOVE      ONE,PTCTDCAS
            ENDIF
          ENDIF
.
VDAT8000  MATCH     ADATE,RETURNDT      * Item date must be after Adm.date
          GOTO      VDAT9000 IF LESS
          MATCH     RETURNDT,CDATE
          GOTO      VDAT9100 IF LESS    * Item date must be before current date
          MOVE      ZERO,EXIT
          GOTO      VDAT9999
.
VDAT9000  UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Date must be after Admission Date - ":
                              CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                              "</RETURN_VALUE>"
          MOVE      ONE,EXIT
          GOTO      VDAT9999
.
VDAT9100  UNPACK    CDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Date must be before Current Date - ":
                              CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                              "</RETURN_VALUE>"
          MOVE      ONE,EXIT
          GOTO      VDAT9999
.
VDAT9200  UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Date must be on or before Discharged Date - ":
                              CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                              "</RETURN_VALUE>"
          MOVE      ONE,EXIT
          GOTO      VDAT9999
.
VDAT9300  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Admission record- ":
                              VALDADNO,"</RETURN_VALUE>"
          MOVE      ONE,EXIT
          GOTO      VDAT9999
.
VDAT9400  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Visit record- ":
                              VALDADNO,"</RETURN_VALUE>"
          MOVE      ONE,EXIT
          GOTO      VDAT9999
.
VDAT9500  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Missing Discharge record- ":
                              VALDADNO,"</RETURN_VALUE>"
          MOVE      ONE,EXIT
          GOTO      VDAT9999
VDAT9999  RETURN
+
.------------------------------------------------------------
.         Check for Event Patient
.------------------------------------------------------------
CEVN0000  MOVE      PVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CEVN9000
.
          MOVE      VALDADNO,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,CEVN9000
.
          MOVE      PMEVADTE,ADATE
          MOVE      PMEVDDTE,DDATE
.
          MOVE      PMEVCCOD,ACLAIM
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          MOVE      ZERO,EXIT
          GOTO      CEVN9999
.
CEVN9000  MOVE      ONE,EXIT
CEVN9999  RETURN
+
.------------------------------------------------------------
. Validate a health fund code to check if it exits.
. Use validateCode() function to call this remote script.
.------------------------------------------------------------
VLDHFN00  CALL      XMLHED00
          BRANCH    EXIT,VLDHFN99
.
          PACK      KEY6,VALDCODE,SP70
.
          MATCH     SP70,KEY6
          GOTO      VLDHFN91 IF EQUAL
.
          PACK      KEY14,KEY6,ZERO4,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,VLDHFN90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               HFNAME:
                             "</RETURN_VALUE>"
          GOTO      VLDHFN98
.
VLDHFN90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Health Fund Code - ":
                              KEY6 :
                             "</RETURN_VALUE>"
          GOTO      VLDHFN98
.
VLDHFN91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Health Fund Code must be entered ":
                             "</RETURN_VALUE>"
          GOTO      VLDHFN98
.
VLDHFN98  CALL      XMLEND00
VLDHFN99  RETURN                             
.
.------------------------------------------------------------
. Validate a health fund table code to check if it exists.
. Use validateHFT() function to call this remote script.              
.------------------------------------------------------------
VLDHFT00  CALL      XMLHED00
          BRANCH    EXIT,VLDHFT99
.
          PACK      VALDFUND,VALDFUND,SP70
          PACK      VALDTABL,VALDTABL,SP70
.
          MATCH     SP70,VALDFUND
          GOTO      VLDHFT91 IF EQUAL
.
          MATCH     SP70,VALDTABL
          GOTO      VLDHFT90 IF EQUAL
.
          PACK      KEY14,VALDFUND,ZERO4,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,VLDHFT92
.
          MOVE      HFNAME,FUNDNAME
.
          PACK      KEY14,VALDFUND,VALDTABL,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,VLDHFT90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               FUNDNAME,"|",HFNAME:
                             "</RETURN_VALUE>"
          GOTO      VLDHFT98
.
VLDHFT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Health Fund/Table combination - ":
                              VALDFUND," - ",VALDTABL:
                             "</RETURN_VALUE>"
          GOTO      VLDHFT98
.
VLDHFT91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Health Fund Code must be entered":
                             "</RETURN_VALUE>"
          GOTO      VLDHFT98
.
VLDHFT92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Health Fund Code - ":
                              VALDFUND:
                             "</RETURN_VALUE>"
          GOTO      VLDHFT98
.
VLDHFT98  CALL      XMLEND00
VLDHFT99  RETURN
.
.------------------------------------------------------------
. Validate Patient Admission Number and does not return an 
. error if not found.
.------------------------------------------------------------
VLDADM00  CALL      XMLHED00
          BRANCH    EXIT,VLDADM99
.
          READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            READ      CONTROLF,HUND30;*76,PTCNNXTV
            MOVE      VALDCODE,KEY8
            MATCH     PTCNNXTV,KEY8
            GOTO      VLDADM92 IF NOT LESS
          ELSE
            MOVE      VALDCODE,KEY8
            MOVE      ZERO,FORM8
            MOVE      KEY8,FORM8
            COMPARE   STADMNO,FORM8
            GOTO      VLDADM92 IF NOT LESS
          ENDIF
.
          BRANCH    VALDTYPE,VLDADM02,VLDADM90,VLDADM06
          GOTO      VLDADM90
.
VLDADM02  OPEN      AAEDE1A1,"aaede1af"
          CALL      RDDETA1
          BRANCH    OVRCD,VLDADM90
          GOTO      VLDADM08
.
VLDADM06  CALL      RDMISS1
          BRANCH    OVRCD,VLDADM90
          BRANCH    ASTAT,VLDADM94,VLDADM08,VLDADM08,VLDADM08,VLDADM95 
.
VLDADM08  MOVE      SP10,PMVXMHOS
          CALL      RDPMVX11
          BRANCH    OVRCD,VLDADM90
.
VLDADM10  MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,VLDADM90
          COMPARE   ONE,PSTAT
          GOTO      VLDADM80 IF NOT EQUAL
.
VLDADM20  MOVE      PPSNAME,KEY8     * This is where the new U/R is hidden
          CALL      RDMAST1          * Read in the new PMI record
          BRANCH    OVRCD,VLDADM91   * New U/R number missing
          BRANCH    PSTAT,VLDADM20   * Another associated U/R number
.
VLDADM80  CALL      PATNAA00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              PATFNAME,"|",PURNO,"|",ACLAIM,"|",PMVXMHOS:
                             "</RETURN_VALUE>"
          GOTO      VLDADM98
.
VLDADM90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              SP10,"|",SP10,"|",SP3,"|",SP3:
                             "</RETURN_VALUE>"
          GOTO      VLDADM98
.
VLDADM91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Patient Admission - ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VLDADM98
.
VLDADM92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Admission Number is Too High. ":
                             "</RETURN_VALUE>"
          GOTO      VLDADM98
.
VLDADM94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Patient is Pre-Admitted. ":
                             "</RETURN_VALUE>"
          GOTO      VLDADM98
.
VLDADM95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Pre-Admission Number is cancelled. ":
                             "</RETURN_VALUE>"
          GOTO      VLDADM98
.
VLDADM98  CALL      XMLEND00
VLDADM99  RETURN
.------------------------------------------------------------
. Validate Invoice Number                                    
.------------------------------------------------------------
VLDINV00  CALL      XMLHED00
          BRANCH    EXIT,VLDINV99
.
          MOVE      ZERO,FORM1
          MOVE      ZERO,F1
          BRANCH    VALDTYPE,VLDINV10,VLDINV30,VLDINV10,VLDINV10,VLDINV10
.
          MOVE      VALDCODE,KEY12
          MOVE      ZERO,FORM8
          MOVE      KEY12,FORM8
          MOVE      FORM8,KEY8
.
          CALL      RDINV1
          BRANCH    OVRCD,VLDINV80
          GOTO      VLDINV91
.
VLDINV10  MOVE      VALDCODE,KEY12
          MOVE      ZERO,FORM8
          MOVE      KEY12,FORM8
          MOVE      FORM8,KEY8
.
          COMPARE   FIVE,CFEETYP
          GOTO      VLDINV12 IF NOT EQUAL   * Not NZ Private
.
          CALL      RDINV1
          BRANCH    OVRCD,VLDINV92
.
          PACK      KEY8,DPINVADM,SP10
          CALL      RDPMVX11
          BRANCH    OVRCD,VLDINV95
.
          IF        IBCNMHOS=1
            MATCH     SP70,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PMVXMHOS
              GOTO      VLDINV92 IF NOT EQUAL 
            ENDIF
          ENDIF
.
VLDINV12  MATCH     SP70,MULDHOSP
          IF        !@EQUAL
            CALL      MULT0000
          ELSE
            CLOSE     PATINVR1
            OPEN      PATINVR1,"patinvrf"
          ENDIF
.
          MOVE      VALDCODE,KEY12
          MOVE      ZERO,FORM8
          MOVE      KEY12,FORM8
          MOVE      FORM8,KEY8
          CALL      RDINV1
          IF        VALDTYPE=5
            BRANCH    OVRCD,VLDINV30
          ELSE
            BRANCH    OVRCD,VLDINV92
          ENDIF
.
          IF        VALDTYPE=3
            MATCH     VALDURNO,PINVUR         * Correct U/R no?
            GOTO      VLDINV92 IF NOT EQUAL
          ENDIF
.
          IF        VALDCRST=1
            MATCH     "1",PTINCRST       * Fully Credited
            GOTO      VLDINV94 IF EQUAL
          ENDIF
.
.         Check if there is an eclipse claim associated with this invoice
.
          PACK      KEY16,PINVNO,SP70
          CALL      RDPMECT2
          COMPARE   ZERO,OVRCD
          GOTO      VLDINV16 IF EQUAL
.
          CALL      RKPMECT2
          BRANCH    OVRCD,VLDINV18
.
          MATCH     PINVNO,PMECINVN        * Same Invoice number?
          GOTO      VLDINV18 IF NOT EQUAL  * No
.
VLDINV16  MOVE      ONE,FORM1
.
VLDINV18  MOVE      SP1,INVDETIN           * set Invoice Debt Indicators
          MOVE      PINVSYS,PTDESYST       * System
          CALL      INVDET00
.
VLDINV20  MOVE      PINVPATA,TOTPAID       * Total Paid
          ADD       PINVHFDA,TOTPAID
          ADD       PINVOTHA,TOTPAID
.
          MOVE      PINVAMT,TOTOUTS        * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PINVJOUR,TOTOUTS
          ADD       PTINGSTJ,TOTOUTS
.
          MOVE      ZERO,F1              * zero for Patient invoice
          MOVE      PINVNO,FORM12
          MOVE      FORM12,INVOICEN
          MOVE      PINVUR,SAVURNUM
          CALL      GTNBK000             * Get Non-banked total
          ADD       CASHTOT,TOTOUTS
          ADD       CASHTOT,TOTPAID
.
          IF        VALDTYPE=4
            MOVE      ZERO,FORM12P2
            ADD       PINVJOUR,FORM12P2
            ADD       PTINCRTT,FORM12P2
            ADD       PTINGSTJ,FORM12P2  * Journal total
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PINVNO,"|",PINVADM,"|",PINVUR,"|",PINVSYS:
                             "|",TOTOUTS,"|",PINVAMT:
                             "|",PINVREB,"|",TOTPAID,"|",FORM1,"|",INVDETIN:
                             "|",PTINCRST,"|",FORM12P2:
                             "</RETURN_VALUE>"
            GOTO      VLDINV98
          ENDIF
.
          IF        VALDTYPE=3
            MOVE      PINVSYS,PTDESYST
            MOVE      PINVNO,KEY8
            CALL      GPDT0000            * Get patient debts
            MOVE      SP70,TDESC1
            CALL      GETFA000            * Get Future Action Code
.     
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PINVNO,"|",PINVADM,"|",PINVUR,"|",PINVSYS:
                             "|",TOTOUTS,"|",PINVAMT:
                             "|",PINVREB,"|",TOTPAID,"|",FORM1,"|",INVDETIN:
                             "|",PTINCRST,"|",PTDERPAY,"|",TDESC2,"|",DIM11:
                             "|",PTDENOFP,"|",DIM11A,"|",TDESC1:
                             "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PINVNO,"|",PINVADM,"|",PINVUR,"|",PINVSYS:
                             "|",TOTOUTS,"|",PINVAMT:
                             "|",PINVREB,"|",TOTPAID,"|",FORM1,"|",INVDETIN:
                             "|",PTINCRST:
                             "</RETURN_VALUE>"
          ENDIF
          GOTO      VLDINV98
.
VLDINV30  MOVE      VALDCODE,KEY12
          MOVE      ZERO,FORM8
          MOVE      KEY12,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,VLDINV93
.
          IF        VALDCRST=1
            MATCH     "1",PRINCNST       * Fully Credited
            GOTO      VLDINV94 IF EQUAL
          ENDIF
.
          MOVE      SP1,INVDETIN         * set Invoice Debt Indicators
          MOVE      "4",PTDESYST         * System
          CALL      INVDET00
.
          MOVE      PRINPAMT,TOTPAID     * Total Paid
          ADD       PRINHAMT,TOTPAID     * health fund
          ADD       PRINIAMT,TOTPAID     * insurance
          ADD       PRINMAMT,TOTPAID     * medicare
          ADD       PRINVAMT,TOTPAID     * veteran affairs
          ADD       PRINOTHA,TOTPAID     * others
.
          MOVE      PRINITOT,TOTOUTS     * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PRINCNTT,TOTOUTS     * Credit notes
          ADD       PRINJAMT,TOTOUTS
          ADD       PRINGSTJ,TOTOUTS
.
          MOVE      ONE,F1               * one for Private Practice invoice
          MOVE      PRINNUMB,FORM12
          MOVE      FORM12,INVOICEN
          MOVE      PRINDEBT,SAVURNUM
          CALL      GTNBK000             * Get Non-banked total
          ADD       CASHTOT,TOTOUTS
.
          PACK      PATFNAME,SP70
          MOVE      PRINDEBT,KEY8
          CALL      RDMAST1
          IF        OVRCD=0
            CALL      PATNAA00
          ENDIF
.
          IF        VALDTYPE=3
            MOVE      "4",PTDESYST        * Private practice
            MOVE      PRINNUMB,KEY8
            CALL      GPDT0000            * Get patient debts
.
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               PRINNUMB,"|",PRINUNIQ,"|",PRINDEBT,"|",PTDESYST:
                               "|",TOTOUTS,"|",INVDETIN:
                               "|",PTDERPAY,"|",TDESC,"</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               PRINNUMB,"|",PRINDEBT,"|",PRINUNIQ,"|",PATFNAME:
                               "|",TOTOUTS,"</RETURN_VALUE>"
          ENDIF
          GOTO      VLDINV98
.
VLDINV80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              IRANGE:         
                             "</RETURN_VALUE>"
          GOTO      VLDINV98
.
VLDINV90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Invoice Number. ":
                             "</RETURN_VALUE>"
          GOTO      VLDINV98
.
VLDINV91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invoice Number Already Exists. ":
                             "</RETURN_VALUE>"
          GOTO      VLDINV98
.
VLDINV92  COMPARE   THREE,VALDTYPE
          GOTO      VLDINV30 IF EQUAL           * try PP U/R Number
.
VLDINV93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Invoice Number. ":
                             "</RETURN_VALUE>"
          GOTO      VLDINV98
.
VLDINV94  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invoice has been Fully Credited. ":
                             "</RETURN_VALUE>"
          GOTO      VLDINV98
.
VLDINV95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invoice has Invalid Visit Number ":
                             "</RETURN_VALUE>"
          GOTO      VLDINV98
.
VLDINV98  CALL      XMLEND00
VLDINV99  CLOSE     PATINVR1
          OPEN      PATINVR1,"patinvrf"
          RETURN
+
.------------------------------------------------------------
. Get Future Action Code 
.------------------------------------------------------------
GETFA000  MATCH     PTDECOD1,SP70
          GOTO      GETFA999 IF EQUAL
          MOVE      "FA",CATEGORY
          MOVE      PTDECOD1,CODE
          CALL      GETCOD00
          MATCH     "P",TCINDC3
          GOTO      GETFA999 IF NOT EQUAL
          MOVE      TDESC,TDESC1
.
GETFA999  RETURN
+
.------------------------------------------------------------
. Get patient debt details 
.------------------------------------------------------------
GPDT0000  MOVE      "2",PTDETYPE        * Payment Plan
          PACK      KEY10,PTDETYPE,KEY8,PTDESYST,SP20
          CALL      RDPTDET1
          IF        OVRCD=1
            MOVE      ZERO,PTDERPAY
            MOVE      SP70,TDESC
          ELSE
            MATCH     SP70,PTDEFREQ
            IF        !@EQUAL
              MOVE      "FP",KEY2
              PACK      KEY5,KEY2,PTDEFREQ
              CALL      RDCODE1
              IF        OVRCD=1
                MOVE      SP70,TDESC
              ENDIF
              MOVE      TDESC,TDESC2
            ENDIF
.
            REP       " 0",PTDESDAT
            UNPACK    PTDESDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            REP       " 0",PTDEEDAT
            UNPACK    PTDEEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11A,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
GPDT9999  RETURN
+
.------------------------------------------------------------
. flag invoice debt indicator                                
.------------------------------------------------------------
INVDET00  MOVE      ONE,F1
.
          REPEAT
            PACK      KEY10,F1,PINVNO,PTDESYST,SP20
            CALL      RDPTDET1
            IF        OVRCD = 0
              MATCH     SP8,PTDEDTCL        * check "Date Debt Cleared"
              GOTO      INVDET20 IF NOT EQUAL
.                                           * found an active Debt Indicator
              MOVE      F1,INVDETIN
            ENDIF
.
INVDET20    ADD       ONE,F1
          UNTIL     F1 > 3
. 
INVDET99  RETURN
.------------------------------------------------------------
. Open multi database table                                  
.------------------------------------------------------------
MULT0000  PACK      KEY4,MULDHOSP,SP70
          CALL      RDHOSP1
          IF        OVRCD<>1
            MOVE      HOSINDX,HOSPCNT
          ENDIF
.
          PACK      XXDPATH,SP20,SP20,SP20
          LOAD  XXDPATH,HOSPCNT,HDPATH1,HDPATH2,HDPATH3,HDPATH4,HDPATH5,HDPATH6
.
          MOVE      "patinvrf",OPFILE
          MOVE      ONE,FILENUM
          CALL      OMDFN000
.
MULT9999  RETURN
+
.------------------------------------------------------------
.         open the required file
.------------------------------------------------------------
OTRF0000  IF        FILENUM = 1
            CLOSE     PATINVR1
            OPEN      PATINVR1,PATH
          ENDIF
.
OTRF9999  RETURN
.--------------------------------------------------------------------
.   Get Non-banked amount for invoice only for payment after invoice
.--------------------------------------------------------------------
GTNBK000  MOVE      ZERO,CASHTOT
          PACK      KEY29,INVOICEN,SP70
          CALL      RSRCDTE3
GTNBK100  CALL      RKRCDTE3
          BRANCH    OVRCD,GTNBK999
.
          MATCH     INVOICEN,RCDTINVN       * Same invoice number?
          GOTO      GTNBK999 IF NOT EQUAL
.
          MATCH     SAVURNUM,RCDTURNO       * same U/R number?
          GOTO      GTNBK100 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,GTNBK100
.
          MATCH     "0",RCBNSTAT            * Cash Not banked?
          GOTO      GTNBK100 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,GTNBK100
.
          BRANCH    F1,GTNBK180                * Private Practice
.
          COMPARE   "1",REGIBACD
          GOTO      GTNBK100 IF NOT EQUAL      * Not a Patient receipt
          GOTO      GTNBK200
.
GTNBK180  COMPARE   "2",REGIBACD               * PP receipt
          GOTO      GTNBK100 IF NOT EQUAL      * Not a PP payment receipt
.
GTNBK200  MULT      "-1",RCDTAMNT
          ADD       RCDTAMNT,CASHTOT
          GOTO      GTNBK100
.
GTNBK999  RETURN
.------------------------------------------------------------
. Validate Financial Management Ledger Accounts              
.------------------------------------------------------------
VLDFMA00  CALL      XMLHED00
          BRANCH    EXIT,VLDFMA99
.
          PACK      KEY14,VALDCODE,SP70
          CALL      RDFMAM1
          BRANCH    OVRCD,VLDFMA90
.
VLDFMA80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             FMAMDESC:         
                             "</RETURN_VALUE>"
          GOTO      VLDFMA98
.
VLDFMA90  UNPACK    KEY14,FMAMLEDG,FMAMACCT 
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Ledger/Account Combination ":
                             FMAMLEDG," - ",FMAMACCT:
                             "</RETURN_VALUE>"
          GOTO      VLDFMA98
.
VLDFMA98  CALL      XMLEND00
VLDFMA99  RETURN
.------------------------------------------------------------
. Get Debtors & GST Control Accounts              
.------------------------------------------------------------
GETACC00  CALL      XMLHED00
          BRANCH    EXIT,GETACC99
.
          PACK      VALDCODE,VALDCODE,SP70
          UNPACK    VALDCODE,PTFMILD,PTFMICA
          MOVE      PTFMILD,KEY2
          CALL      RDFMLA1
          BRANCH    OVRCD,GETACC90
          MOVE      FMLADEB,PTFMIDA
          MOVE      FMLAAGST,PTFMIGS
.
          MATCH     PTFMICA,SP20
          GOTO      GETACC70 IF EQUAL
.
          OPEN      FMSCSAA1,"fmscsaaf"
          PACK      KEY14,PTFMILD,PTFMICA,SP70
          CALL      RDFMCS1
          BRANCH    OVRCD,GETACC70
.
          MATCH     FMCSDEB,SP20
          IF        !@EQUAL
            MOVE      FMCSDEB,PTFMIDA
          ENDIF
          MATCH     FMCSAGST,SP20
          IF        !@EQUAL
            MOVE      FMCSAGST,PTFMIGS
          ENDIF
.
GETACC70  PACK      KEY14,PTFMILD,PTFMIDA,SP70
          CALL      RDFMAM1
          IF        OVRCD=0        
            MOVE      FMAMDESC,KEY35
          ELSE
            MOVE      SP70,KEY35
          ENDIF
.
          PACK      KEY14,PTFMILD,PTFMIGS,SP70
          CALL      RDFMAM1
          IF        OVRCD=1        
            MOVE      SP70,FMAMDESC
          ENDIF
.
GETACC80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTFMIDA,"|",KEY35,"|",PTFMIGS,"|",FMAMDESC: 
                             "</RETURN_VALUE>"
          GOTO      GETACC98
.
GETACC90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Ledger ",PTFMILD:
                             "</RETURN_VALUE>"
          GOTO      GETACC98
.
GETACC98  CALL      XMLEND00
GETACC99  RETURN
.-----------------------------------------------------------------------
. Validate a visit number and check it against U/R number and visit type
. Used for receipting.
.-----------------------------------------------------------------------
VALVTP00  CALL      XMLHED00
          BRANCH    EXIT,VALVTP99
          MOVE      ZERO,WARNFLAG
.
          PACK      ADMISSNO,VALDCODE,SP70
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1
          IF        OVRCD=1
            CALL      CHKBOK00              * check for inpatient booking
            BRANCH    EXIT,VALVTP20,VALVTP92
            GOTO      VALVTP50
          ENDIF
.
          MATCH     SP10,VALDURNO
          GOTO      VALVTP10 IF EQUAL
.
          MATCH     PVIURNO,VALDURNO
          GOTO      VALVTP91 IF NOT EQUAL
.
VALVTP10  COMPARE   ZERO,VALDTYPE           * unknown visit type
          GOTO      VALVTP50 IF EQUAL
.
          MOVE      PTVITYPE,F2
          LOAD      LASTVTYP,F2,VT1,VT2,VT3,VT4,VT5,VT6,VT7,VT8,VT9,VT10
.
          COMPARE   ONE,VALDTYPE
          GOTO      VALVTP16 IF NOT EQUAL   * Not for emergency
.
.      Check for EMR events - allow Emergency event to use EMR Deposit Register
.
          COMPARE   NINE,PVITYPE
          GOTO      VALVTP16 IF NOT EQUAL
          MATCH     " 1",PVISYST
          GOTO      VALVTP16 IF NOT EQUAL        * not an event
.
          MOVE      PVIBILL,KEY8
          CALL      RDPMEVT1
          BRANCH    OVRCD,VALVTP16
          PACK      KEY5,ANSE,ANSV,PMEVEVNT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VALVTP16
          MATCH     ANSE,TCINDC1
          GOTO      VALVTP18 IF EQUAL            * Emergency event
.
VALVTP16  COMPARE   F2,VALDTYPE
          GOTO      VALVTP92 IF NOT EQUAL
.
.         Inpatient
.
          IF        VALDTYPE=3
            PACK      KEY8,ADMISSNO,SP70
            CALL      RDMISS1
            BRANCH    OVRCD,VALVTP90
            COMPARE   FIVE,ASTAT            * cancelled admission
            GOTO      VALVTP93 IF EQUAL
          ENDIF
.
VALVTP18  CALL      CHKINV00
          BRANCH    EXIT,VALVTP98
          GOTO      VALVTP50
.
VALVTP20  COMPARE   TWO,VALDTYPE          * outpatient visit
          GOTO      VALVTP30 IF EQUAL
          COMPARE   ZERO,VALDTYPE         * unknown visit type
          GOTO      VALVTP30 IF EQUAL
          GOTO      VALVTP90
.
.         Outpatient - booked
.
VALVTP30  CALL      OUTFIL00              * Check user id site files
          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,VALVTP90
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      VALVTP90 IF NOT EQUAL
          MOVE      DOBAOUTN,PVIBILL
          MOVE      OBAURNO,PVIURNO
.
VALVTP50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               PVIBILL,"|",PVIURNO,"|",WARNFLAG:
                             "</RETURN_VALUE>"
          GOTO      VALVTP98
.
VALVTP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid visit number - ":
                             ADMISSNO,"</RETURN_VALUE>"
          GOTO      VALVTP98
.
VALVTP91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid visit for this U/R - ":
                             ADMISSNO,"</RETURN_VALUE>"
          GOTO      VALVTP98
.
VALVTP92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid visit type - ":
                             LASTVTYP,"</RETURN_VALUE>"
          GOTO      VALVTP98
.
VALVTP93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Visit is Cancelled - ":
                             ADMISSNO,"</RETURN_VALUE>"
          GOTO      VALVTP98
.
VALVTP98  CALL      XMLEND00
VALVTP99  RETURN
+
.------------------------------------------------------------
. Check Booking or waiting list                                 
.------------------------------------------------------------
CHKBOK00  MOVE      ZERO,EXIT
          PACK      KEY8,ADMISSNO,SP10
          CALL      RDBKREC1             * read inpatient booking
          BRANCH    OVRCD,CHKBOK90
.
          MOVE      BKREBOOK,PVIBILL
          MOVE      BKREBOOK,DPVIBILL
          MOVE      BKREURNO,PVIURNO
          MOVE      BKREEDAT,PVIDATE
.
          COMPARE   ZERO,BKRESTAT        * Booking status
          GOTO      CHKBOK90 IF NOT EQUAL
.
          IF        VALDTYPE<>3
            MOVE      "Booking",LASTVTYP
            MOVE      TWO,EXIT
            GOTO      CHKBOK99 
          ENDIF
.
          GOTO      CHKBOK99 
.
CHKBOK90  MOVE      ONE,EXIT
CHKBOK99  RETURN
.------------------------------------------------------------
. Validate Inpatient                                 
.------------------------------------------------------------
CHKINV00  MOVE      ZERO,EXIT
          PACK      VALDDATE,CYY,CMM,CDD       * set todays date
          REP       " 0",VALDDATE
.
          PACK      KEY16,ADMISSNO,SP8
          CALL      RDSINV3
          CALL      RDKINV3
          BRANCH    OVRCD,CHKINV99
.
          MATCH     ADMISSNO,DPINVADM         * no invoices on file so valid
          GOTO      CHKINV99 IF NOT EQUAL
.
          MATCH     VALDDATE,PINVDTE          * test if invoiced today
          GOTO      CHKINV90 IF EQUAL
.
CHKINV10  CALL      RDKINV3                * Loop to get last invoice.
          BRANCH    OVRCD,CHKINV90         * End Of File
.
          MATCH     ADMISSNO,DPINVADM
          GOTO      CHKINV80 IF NOT EQUAL
.
          MATCH     VALDDATE,PINVDTE          * test if invoiced today
          GOTO      CHKINV90 IF EQUAL
          GOTO      CHKINV10
.
CHKINV80  CALL      RDPINV3                * Re-read last invoice
.
CHKINV90  MOVE      ONE,WARNFLAG
..          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
..                             "Invoice ",PINVNO," already exists for Visit ":
..                             ADMISSNO,". ":
..                             "</RETURN_VALUE>"
..          MOVE      ONE,EXIT
          GOTO      CHKINV99
.
..CHKINV91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
..                             "An Invoice Has Been Raised Today. ":
..                             "</RETURN_VALUE>"
..          MOVE      ONE,EXIT
..          GOTO      CHKINV99
.
CHKINV99  RETURN
+
.*******************************************************************************
. OUTFIL00 - Check if the user id has an outpatienty site. If they do open
.            the correct outpatient files according to the site. If they do not
.            have a site make sure the default prefix of out is is used to
.            open the files.
.*******************************************************************************
OUTFIL00  PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,OUTFIL10
          MATCH     SP70,WBSESIT             * Does the user have a site
          GOTO      OUTFIL50 IF NOT EQUAL
.
OUTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL50  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      OUTFIL99
.
OUTFIL90  MOVE      "Outpatient Site Invalid",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
OUTFIL99  RETURN
+
.------------------------------------------------------------
. Validate Private Practice Invoice Number - priinvof 
.------------------------------------------------------------
VLDPPI00  CALL      XMLHED00
          BRANCH    EXIT,VLDPPI99
.
VLDPPI10  MOVE      VALDCODE,KEY12
          MOVE      ZERO,FORM8
          MOVE      KEY12,FORM8
          MOVE      FORM8,KEY8
          CALL      RDPRIN1
          BRANCH    OVRCD,VLDPPI92
.
          IF        VALDCRST=1
            MATCH     "1",PRINCNST       * Fully Credited
            GOTO      VLDPPI93 IF EQUAL
          ENDIF
.
          MOVE      PRINPAMT,TOTPAID     * Total Paid
          ADD       PRINHAMT,TOTPAID
          ADD       PRINIAMT,TOTPAID
          ADD       PRINMAMT,TOTPAID
          ADD       PRINVAMT,TOTPAID
          ADD       PRINOTHA,TOTPAID
.
          MOVE      PRINITOT,TOTOUTS      * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PRINCNTT,TOTOUTS     * Credit notes
          ADD       PRINJAMT,TOTOUTS
          ADD       PRINGSTJ,TOTOUTS
.
          MOVE      ONE,F1               * one for Private Practice invoice
          MOVE      PRINNUMB,FORM12
          MOVE      FORM12,INVOICEN
          MOVE      PRINDEBT,SAVURNUM
          CALL      GTNBK000             * Get Non-banked total
          ADD       CASHTOT,TOTOUTS
.
          MOVE      SP70,KEY3
          PACK      KEY6,PRINPRAC,SP70
          CALL      RDPRPR1
          IF        OVRCD=0
            PACK      KEY3,PRPRREGI,SP70 * Register for the Invoice Practice
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PRINNUMB,"|",PRINDEBT,"|",PRINSCAN:
                             "|",TOTOUTS,"|",KEY3,"</RETURN_VALUE>"
          GOTO      VLDPPI98
.
VLDPPI92  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Private Practice Invoice Number. ":
                             "</RETURN_VALUE>"
          GOTO      VLDPPI98
.
VLDPPI93  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Private Practice Invoice has been Fully Credited.":
                             "</RETURN_VALUE>"
          GOTO      VLDPPI98
VLDPPI98  CALL      XMLEND00
VLDPPI99  RETURN
.------------------------------------------------------------
. Validate Account Receivable Invoice Number  
.------------------------------------------------------------
VLDARI00  CALL      XMLHED00
          BRANCH    EXIT,VLDARI99
.
VLDARI10  MOVE      VALDCODE,KEY12
          MOVE      ZERO,FORM12
          MOVE      KEY12,FORM12
          MOVE      FORM12,KEY12
          REP       " 0",KEY12
          PACK      KEY21,ONE,KEY12,SP70
          CALL      RSDBFH6
          CALL      RKDBFH6
          BRANCH    OVRCD,VLDARI91
.
          MATCH     "1",DBFHDTY
          GOTO      VLDARI91 IF NOT EQUAL
          MATCH     KEY12,DBFHDOC
          GOTO      VLDARI91 IF NOT EQUAL
.
          MOVE      ZERO,FRSTFLAG
          MOVE      ZERO,PINVAMT
          MOVE      ZERO,TOTPAID
          MOVE      ZERO,PINVJOUR
.
          PACK      KEY36,DBFHDEB,DBFHDOC,SP70
          CALL      RSDBFD6
VLDARI20  CALL      RKDBFD6
          BRANCH    OVRCD,VLDARI90      
.
          MATCH     DBFHDEB,DBFDDEB
          GOTO      VLDARI90 IF NOT EQUAL   * Not same debtor
          MATCH     DBFDINV,DBFHDOC 
          GOTO      VLDARI90 IF NOT EQUAL   * Not same invoice
.
VLDARI30  MOVE      ONE,FRSTFLAG
          MOVE      ZERO,FORM1
          MOVE      DBFDDTY,FORM1
          BRANCH    FORM1,VLDARI31,VLDARI32,VLDARI32,VLDARI34,VLDARI35
          GOTO      VLDARI20
.
VLDARI31  ADD       DBFDTOT,PINVAMT     * invoice amount
          ADD       DBFDTAX,PINVAMT     * Tax amount
          GOTO      VLDARI20
.
VLDARI32  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,TOTPAID     * payments
          GOTO      VLDARI20
.
VLDARI34  ADD       DBFDPAID,PINVJOUR    * Debit Adjustment Journals
          GOTO      VLDARI20
.
VLDARI35  MULT      "-1",DBFDPAID
          ADD       DBFDPAID,PINVJOUR    * Credit Adjustment Journals
          GOTO      VLDARI20
.
VLDARI80  MOVE      PINVAMT,TOTOUTS    * Total Outstanding
          ADD       TOTPAID,TOTOUTS
          ADD       PINVJOUR,TOTOUTS
.
          MOVE      ZERO,F1              * zero for Patient invoice
          MOVE      DBFHDOC,INVOICEN
          MOVE      DBFDDEB,SAVURNUM
          CALL      GTNBK000             * Get Non-banked total
          ADD       CASHTOT,TOTOUTS
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DBFHDOC,"|",DBFHDEB:
                             "|",TOTOUTS,"</RETURN_VALUE>"
          GOTO      VLDARI98
.
VLDARI90  COMPARE   ZERO,FRSTFLAG
          GOTO      VLDARI91 IF EQUAL
          GOTO      VLDARI80
.
VLDARI91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Account Receivable Invoice Number: ":
                             KEY12,"</RETURN_VALUE>"
          GOTO      VLDARI98
.
VLDARI98  CALL      XMLEND00
VLDARI99  RETURN
.
.------------------------------------------------------------
. Validate Private Practice Debtors Number  
.------------------------------------------------------------
.VLDPPD00  CALL      XMLHED00
.          BRANCH    EXIT,VLDPPD99
.
.          PACK      KEY8,VALDCODE,SP70
.          CALL      RDPRDB1
.          BRANCH    OVRCD,VLDPPD90
.
.          MOVE      PRDBSNAM,PSNAME
.          MOVE      PRDBGNAM,PGNAME
.          MOVE      PRDBTITL,PTITL
.          CALL      PATNAA00
.          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
.                              PATFNAME,"|",PRDBDEBT:
.                             "</RETURN_VALUE>"
.          GOTO      VLDPPD98
.
.VLDPPD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
.                             "Invalid Private Practice Debtor Number. ":
.                             "</RETURN_VALUE>"
.          GOTO      VLDPPD98
.
.VLDPPD98  CALL      XMLEND00
.VLDPPD99  RETURN
.
.------------------------------------------------------------
. Validate Account Receivable Debtors Number
.------------------------------------------------------------
VLDARD00  CALL      XMLHED00
          BRANCH    EXIT,VLDARD99           
.         
          REP      "~&",VALDCODE
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDDBDB1
          BRANCH    OVRCD,VLDARD90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              DBDBNA1,"|",DBDBDEB:
                             "</RETURN_VALUE>"
          GOTO      VLDARD98
.
VLDARD90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Account Receivable Debtor Number: ":
                             KEY8,"</RETURN_VALUE>"
          GOTO      VLDARD98
.
VLDARD98  CALL      XMLEND00
VLDARD99  RETURN    
+
.------------------------------------------------------------
. Validate Bed Fee 
.------------------------------------------------------------
VALBFE00  CALL      XMLHED00
          BRANCH    EXIT,VALBFE99
.
          COMPARE   FIVE,CFEETYP
          GOTO      VALBFE60 IF EQUAL       * NZ Private
          COMPARE   NINE,CFEETYP
          GOTO      VALBFE50 IF EQUAL       * Johns Hopkins
.
          MOVE      SP70,PTHFBCAT
          PACK      KEY14,VALDFUND,VALDTABL
          CALL      RDFUND1
.
          PACK      VALDCEFF,VALDCEFF,SP70
          MATCH     SP70,VALDCEFF
          IF        @EQUAL
            PACK      VALDCEFF,CCC,CYY,CMM,CDD
            REP       " 0",VALDCEFF
          ENDIF
          MOVE      VALDCEFF,CEFFDATE     * Contract Effective Date
          MOVE      ZERO,FORM2
          PACK      KEY18,VALDCLMT,VALDFUND,PTHFBCAT,VALDADMT,VALDBEDT,SP70
VALBFE20  PACK      KEY27,KEY18,SP30
          CALL      RDSBFEE1                * Position on & read the bed fee
VALBFE22  CALL      RDKBFEE1                  file
          BRANCH    OVRCD,VALBFE30
.
          PACK      KEY18A,BFCLM,BFHFUND,PTBFHTYP,BFATYPE,BFBTYPE,SP70
          MATCH     KEY18,KEY18A
          GOTO      VALBFE30 IF NOT EQUAL
.
          MOVE      PTBFCNID,KEY6         * Contract ID
          CALL      VALCONTR              * Validate the Contract ID
          BRANCH    EXIT,VALBFE22         * not valid
.
          MOVE      PTBFCNID,CONTRCID     * Contract ID
          GOTO      VALBFE80              * Same bed fee rate, print
.
VALBFE30  ADD       ONE,FORM2
          BRANCH    FORM2,VALBFE40,VALBFE42
.
          IF        IBCNMHOS=1
            MATCH     SP10,MULTHOSP
            IF        @EQUAL
              CALL      RKPTHSP1       * next read of hospital record 
              BRANCH    OVRCD,VALBFE90
              PACK      KEY18,PTHSDCLM,SP6,SP3,VALDADMT,VALDBEDT
              GOTO      VALBFE20
            ENDIF
          ENDIF
.
          GOTO      VALBFE90
.
VALBFE40  PACK      KEY18,VALDCLMT,SP6,SP3,VALDADMT,VALDBEDT
          GOTO      VALBFE20
.
VALBFE42  IF        IBCNMHOS=1
            MATCH     SP10,MULTHOSP
            IF        @EQUAL
              MOVE      SP10,KEY3
              CALL      RSPTHSP1        * first read of hospital file
              CALL      RKPTHSP1
              BRANCH    OVRCD,VALBFE90
              PACK      KEY18,PTHSDCLM,SP6,SP3,VALDADMT,VALDBEDT
            ELSE
              MOVE      MULTHOSP,KEY3
              CALL      RDPTHSP1
              BRANCH    OVRCD,VALBFE90
              PACK      KEY18,PTHSDCLM,SP6,SP3,VALDADMT,VALDBEDT
            ENDIF
          ELSE
            PACK      KEY18,PTCNDCLM,SP6,SP3,VALDADMT,VALDBEDT
          ENDIF
          GOTO      VALBFE20
.
.         Johns Hopkins
.
VALBFE50  OPEN      JHSBFEA1,"jhsbfeaf"
          MOVE      ZERO,FORM2
          PACK      KEY23,VALDCLMT,VALDFUND,VALDTABL,VALDADMT,VALDBEDT
VALBFE52  PACK      KEY26,KEY23,SP30
          CALL      RSJHBFE1                * Position on & read the bed fee
          CALL      RKJHBFE1                  file
          BRANCH    OVRCD,VALBFE54
.
          PACK      KEY23A,BFCLM,BFHFUND,BFHFTAB,BFATYPE,BFBTYPE
          MATCH     KEY23,KEY23A
          GOTO      VALBFE80 IF EQUAL       * Same bed fee rate, print
.
VALBFE54  ADD       ONE,FORM2
          BRANCH    FORM2,VALBFE56,VALBFE58
.
          IF        IBCNMHOS=1
            MATCH     SP10,MULTHOSP
            IF        @EQUAL
              CALL      RKPTHSP1       * next read of hospital record
              BRANCH    OVRCD,VALBFE90
              PACK      KEY23,PTHSDCLM,SP6,SP8,VALDADMT,VALDBEDT
              GOTO      VALBFE52
            ENDIF
          ENDIF
.
          GOTO      VALBFE90
.
VALBFE56  PACK      KEY23,VALDCLMT,SP6,SP8,VALDADMT,VALDBEDT
          GOTO      VALBFE52
.
VALBFE58  IF        IBCNMHOS=1
            MATCH     SP10,MULTHOSP
            IF        @EQUAL
              MOVE      SP10,KEY3
              CALL      RSPTHSP1        * first read of hospital file
              CALL      RKPTHSP1
              BRANCH    OVRCD,VALBFE90
              PACK      KEY23,PTHSDCLM,SP6,SP8,VALDADMT,VALDBEDT
            ELSE
              MOVE      MULTHOSP,KEY3
              CALL      RDPTHSP1
              BRANCH    OVRCD,VALBFE90
              PACK      KEY23,PTHSDCLM,SP6,SP8,VALDADMT,VALDBEDT
            ENDIF
          ELSE
            PACK      KEY23,PTCNDCLM,SP6,SP8,VALDADMT,VALDBEDT
          ENDIF
          GOTO      VALBFE52
.
.         Use NZ Private bed fees
.
VALBFE60  OPEN      NZPBFEA1,"nzpbfeaf"
          MOVE      ZERO,FORM2
          PACK      KEY26,MULTHOSP,VALDCLMT,VALDFUND,VALDTABL:
                          VALDADMT,VALDBEDT,SP70
.
VALBFE64  PACK      KEY37,KEY26,SP30
          CALL      RSNZBFE1                * Position on & read the bed fee
          CALL      RKNZBFE1                  file
          BRANCH    OVRCD,VALBFE68
.
          PACK      KEY26A,NZBFHOSP,NZBFCLMC,NZBFCNTR,NZBFFTAB:
                           NZBFATYP,NZBFBTYP,SP70
          MATCH     KEY26,KEY26A
          GOTO      VALBFE80 IF EQUAL       * Same bed fee rate, print
.
VALBFE68  ADD       ONE,FORM2
          BRANCH    FORM2,VALBFE70,VALBFE72
          GOTO      VALBFE90
.
VALBFE70  PACK      KEY26,MULTHOSP,VALDCLMT,SP6,SP8,VALDADMT,VALDBEDT,SP70
          GOTO      VALBFE64
.
VALBFE72  MOVE      MULTHOSP,KEY3
          CALL      RDPTHSP1
          BRANCH    OVRCD,VALBFE74
.
          PACK      KEY26,MULTHOSP,PTHSDCLM,SP6,SP8,VALDADMT,VALDBEDT,SP70
          GOTO      VALBFE64
.
VALBFE74  PACK      KEY26,MULTHOSP,PTCNDCLM,SP6,SP8,VALDADMT,VALDBEDT,SP70
          GOTO      VALBFE64
.
VALBFE80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             SP10:
                             "</RETURN_VALUE>"
          GOTO      VALBFE98
.
VALBFE90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "No bed fee detail found.  Default not set up.":
                             "</RETURN_VALUE>"
          GOTO      VALBFE98
.
VALBFE98  CALL      XMLEND00
VALBFE99  RETURN
+
.------------------------------------------------------------
. Validate Bed Fee 
.------------------------------------------------------------
GETAHF00  CALL      XMLHED00
          BRANCH    EXIT,GETAHF99
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDVISA1
          BRANCH    OVRCD,GETAHF90
.
          COMPARE   THREE,PVITYPE
          GOTO      GETAHF90 IF NOT EQUAL
.
          PACK      KEY8,VALDCODE,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,GETAHF90
.
          MATCH     SP70,AFUNDH
          GOTO      GETAHF50 IF EQUAL
.
          PACK      KEY14,AFUNDH,ZERO4,SP70
          CALL      RDFUND1
          IF        OVRCD=0
            MOVE      HFNAME,TDESC
          ELSE
            MOVE      "Unknown Health Fund",TDESC
          ENDIF
.          
          PACK      KEY14,AFUNDH,AFNDTB,SP70
          CALL      RDFUND1
          IF        OVRCD=1
            MOVE      "Unknown Health Fund Table",HFNAME
          ENDIF
          GOTO      GETAHF60
.          
GETAHF50  MOVE      SP70,AFUNDH
          MOVE      SP70,AFNDTB
          MOVE      SP70,TDESC
          MOVE      SP70,HFNAME
.
GETAHF60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             AFUNDH,"|",TDESC,"|",AFNDTB,"|",HFNAME:
                             "</RETURN_VALUE>"
          GOTO      GETAHF98
.
GETAHF90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Inpatient visit number":
                             "</RETURN_VALUE>"
          GOTO      GETAHF98
.
GETAHF98  CALL      XMLEND00
GETAHF99  RETURN
+
.------------------------------------------------------------
. Validate Hospital ID
.------------------------------------------------------------
GETHSP00  CALL      XMLHED00
          BRANCH    EXIT,GETHSP99
.
          PACK      KEY3,VALDCODE,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,GETHSP90
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTHSNAME,"|",PTHSUFMS,"|",PTHSHLOC,"|",PTHSRCTY:
                             "</RETURN_VALUE>"
          GOTO      GETHSP98
.
GETHSP90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Hospital ID":
                             "</RETURN_VALUE>"
          GOTO      GETHSP98
.
GETHSP98  CALL      XMLEND00
GETHSP99  RETURN
+
.------------------------------------------------------------
. Validate Bed Fee 
.------------------------------------------------------------
GETSGC00  CALL      XMLHED00
          BRANCH    EXIT,GETSGC99
.
          UNPACK    VALDCODE,VALDCLMT,VALDFUND,ITCODE
          PACK      KEY18,VALDFUND,ITCODE,SP20
          CALL      RDPTSGC1                * Get suggested adm. type
          IF        OVRCD=1
            MOVE      SP70,PTSGCLSS
          ENDIF
.
GETSGC60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             PTSGCLSS:
                             "</RETURN_VALUE>"
          GOTO      GETSGC98
.
GETSGC98  CALL      XMLEND00
GETSGC99  RETURN
.
.*******************************************************************************
. COTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the visit files site code. If the site is invalid
.            or blank just open the default site of out.

.*******************************************************************************
COTFIL00  MATCH     SP70,PVISITE             * Does the visit have a site
          GOTO      COTFIL50 IF NOT EQUAL
.
COTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL50  MOVE      PVISITE,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,COTFIL10           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          GOTO      COTFIL99
.
COTFIL99  RETURN
.
.
.*******************************************************************************
. VOTFIL00 - Check that the correct outpatient site prefix files are open
.            according to the site we want to check. If the site is invalid
.            or blank just open the default site of out.

.*******************************************************************************
VOTFIL00  MATCH     SP70,CHECKSIT             * Does the visit have a site
          GOTO      VOTFIL50 IF NOT EQUAL
.
VOTFIL10  MATCH     "out",CFILEPRE           * Is out currently open
          IF        !@EQUAL
            MOVE      "out",OSTFILE          * open default prefix of out
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open out Outpatient Files
          ENDIF
.
          GOTO      VOTFIL99
.
VOTFIL50  MOVE      CHECKSIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,VOTFIL10           * error invalid site code
.
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE       * Save Current File Prefix
            CALL      OPNOUT00               * Open prefixed Outpatient Files
          ENDIF
.
          GOTO      VOTFIL99
.
VOTFIL99  RETURN
+
.-----------------------------------------------------------------------
. Validate a booking number 
.-----------------------------------------------------------------------
VALBOK00  CALL      XMLHED00
          BRANCH    EXIT,VALVTP99
.
          MOVE      ZERO,EXIT
          PACK      ADMISSNO,VALDCODE,SP70
          PACK      KEY8,ADMISSNO,SP10
          CALL      RDBKREC1             * read inpatient booking
          BRANCH    OVRCD,VALBOK90
.
VALBOK60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "OK":
                             "</RETURN_VALUE>"
          GOTO      VALBOK98
.
VALBOK90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Booking number":
                             "</RETURN_VALUE>"
          GOTO      VALBOK98
.
VALBOK98  CALL      XMLEND00
VALBOK99  RETURN
.
.------------------------------------------------------------
. Validate password for outpatient site
. valdtype = 0 - Validate password 
.            1 - Is a password required
.------------------------------------------------------------
OUTPAS00  CALL      XMLHED00
          BRANCH    EXIT,OUTPAS99
.
          PACK      KEY6,CHECKSIT,SP70
          CALL      RDSITA1
          BRANCH    OVRCD,OUTFIL90   
.
          IF        VALDTYPE=1
            MATCH     SP70,OSTPASS 
            IF        @EQUAL           
              MOVE      ZERO,F1             * No password required
            ELSE
              MOVE      ONE,F1              * Password required
            ENDIF
            GOTO      OUTPAS81
          ENDIF
.
          MATCH     SP70,OSTPASS            * No password required
          GOTO      OUTPAS80 IF EQUAL
.
          MATCH     VALDCODE,OSTPASS        * Validate password
          GOTO      OUTPAS91 IF NOT EQUAL 
.
OUTPAS80  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "Password Verified Correct":
                             "</RETURN_VALUE>"
          GOTO      OUTPAS98
.
OUTPAS81  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             F1:
                             "</RETURN_VALUE>"
          GOTO      OUTPAS98
.
OUTPAS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Outpatient Site - ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      OUTPAS98
.
OUTPAS91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Outpatient Site Password":
                             "</RETURN_VALUE>"
          GOTO      OUTPAS98
.
OUTPAS98  CALL      XMLEND00
OUTPAS99  RETURN
.
.-----------------------------------------------------------------------
. Validate Operation Duration Average
.-----------------------------------------------------------------------
VALOAV00  CALL      XMLHED00
          BRANCH    EXIT,VALOAV99
.         
VALOAV10  MOVE      VALDCODE,DIM9
          PACK      DIM9,DIM9,SP70
.         
          PACK      KEY15,DIM9,VALDDOCT
          CALL      RDOPAVE1
          IF        OVRCD=1
            PACK      KEY15,DIM9,SP70
            CALL      RDOPAVE1
            IF        OVRCD=1
              WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                                  SP6:
                                 "</RETURN_VALUE>"
              GOTO      VALOAV98 
            ENDIF
          ENDIF
.         
          COMPARE   OPAVAVER,ZERO
          IF        @EQUAL
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                                SP6:
                               "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                                OPAVAVER:
                               "</RETURN_VALUE>"
          ENDIF
.
VALOAV98  CALL      XMLEND00
VALOAV99  RETURN
.-----------------------------------------------------------------------
. Validate SJOG ED Billing Doctor, Date and Time
.-----------------------------------------------------------------------
VALDCT00  CALL      XMLHED00
          BRANCH    EXIT,VALDCT99
.
          MATCH     SP70,VALDDCTR
          GOTO      VALDCT90 IF EQUAL
.
          MOVE      VALDCODE,DIM8
          PACK      DIM8,DIM8,SP70
.
          PACK      KEY32,DIM8,VALDDCTR,Z70
          CALL      RSEMHIS2
VALDCT20  CALL      RPEMHIS2
          BRANCH    OVRCD,VALDCT90
.
          MATCH     VALDDCTR,EMHIDOC
          GOTO      VALDCT90 IF NOT EQUAL
.
          MATCH     "ALDOC",EMHIUPT
          GOTO      VALDCT20 IF NOT EQUAL
.
          MATCH     SP70,EMHIDAT
          GOTO      VALDCT90 IF EQUAL
.
          MATCH     SP70,EMHITIM
          GOTO      VALDCT90 IF EQUAL
.
          REP       " 0",EMHIDAT
          UNPACK    EMHIDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    EMHITIM,DIM2,DIM2A,DIM2B
          PACK      DIM8,DIM2,COLON,DIM2A,COLON,DIM2B
.
          GOTO      VALDCT95
.
VALDCT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              SP11,"|",SP8:
                             "</RETURN_VALUE>"
          GOTO      VALDCT98
.
VALDCT95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              DIM11,"|",DIM8:
                             "</RETURN_VALUE>"
.
VALDCT98  CALL      XMLEND00
VALDCT99  RETURN
.
.------------------------------------------------------------
. Validate Eclipse Participant Code and display name.
.------------------------------------------------------------
VALPAR00  CALL      XMLHED00
          BRANCH    EXIT,VALPAR99
.
          MATCH     "1",PTCNWSIN
          GOTO      VALPAR50 IF EQUAL
.
          PACK      KEY3,VALDCODE,SP70
          CALL      RDPTPAR1
          BRANCH    OVRCD,VALPAR90
.
VALPAR10  MATCH     KEY3,PTPRCODE
          GOTO      VALPAR90 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          WRITE     HTMLFILE;PTPRNAME;
.
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VALPAR98
.
.
.
VALPAR50  MATCH     "1",WSININDC
          GOTO      VALPAR90 IF NOT EQUAL
.
          PACK      KEY3,VALDCODE,SP70
          CALL      RDWBPAR1
          BRANCH    OVRCD,VALPAR90  
.
VALPAR60  MATCH     KEY3,WBPRCODE
          GOTO      VALPAR90 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          WRITE     HTMLFILE;WBPRNAME;
.
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VALPAR98
.
VALPAR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Eclipse Participant ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      VALPAR98
.
VALPAR98  CALL      XMLEND00
VALPAR99  RETURN
.
.------------------------------------------------------------
. Validate Eclipse Participant Code and Capability
.------------------------------------------------------------
VALPCP00  CALL      XMLHED00
          BRANCH    EXIT,VALPCP99
.
          MATCH     "1",PTCNWSIN
          GOTO      VALPCP53 IF EQUAL 
.
          PACK      KEY6,VALDHLFN,SP70
          CALL      RDPTFX11
          BRANCH    OVRCD,VALPCP50
.
          MATCH     SP70,PTFXECLP
          GOTO      VALPCP50 IF EQUAL
          GOTO      VALPCP50 IF EOS
.
          MOVE      SP70,KEY3
          MOVE      PTFXECLP,KEY3
          PACK      KEY9,KEY3,VALDECCP,SP70
          CALL      RSPTPCP1
          CALL      RKPTPCP1
          BRANCH    OVRCD,VALPCP50
.
          MATCH     KEY3,PTPPCODE
          GOTO      VALPCP50 IF NOT EQUAL
.
          MATCH     VALDECCP,PTPPCPID
          GOTO      VALPCP50 IF NOT EQUAL
.
          GOTO      VALPCP60
.
VALPCP50  PACK      KEY14,VALDHLFN,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,VALPCP97
.
          MATCH     SP70,PTHFHGRP
          GOTO      VALPCP95 IF EQUAL
          GOTO      VALPCP95 IF EOS
.
          MOVE      SP70,KEY3
          MOVE      PTHFHGRP,KEY3
          PACK      KEY9,KEY3,VALDECCP,SP70
          CALL      RSPTPCP1
          CALL      RKPTPCP1
          BRANCH    OVRCD,VALPCP96
.
          MATCH     KEY3,PTPPCODE
          GOTO      VALPCP95 IF NOT EQUAL
.
          MATCH     VALDECCP,PTPPCPID
          GOTO      VALPCP96 IF NOT EQUAL
.
          GOTO      VALPCP60
.
.
.
VALPCP53  MATCH     "1",WSININDC
          GOTO      VALPCP95 IF NOT EQUAL
.
          PACK      KEY6,VALDHLFN,SP70
          CALL      RDPTFX11
          BRANCH    OVRCD,VALPCP55
.
          MATCH     SP70,PTFXECLP
          GOTO      VALPCP55 IF EQUAL
          GOTO      VALPCP55 IF EOS
.
          MOVE      SP70,KEY3
          MOVE      PTFXECLP,KEY3
          PACK      KEY9,KEY3,VALDECCP,SP70
          CALL      RSWBPCP1
          CALL      RKWBPCP1
          BRANCH    OVRCD,VALPCP55
.
          MATCH     KEY3,WBPCCODE
          GOTO      VALPCP55 IF NOT EQUAL
.
          MATCH     VALDECCP,WBPCCPID
          GOTO      VALPCP55 IF NOT EQUAL
.
          GOTO      VALPCP60
.
VALPCP55  PACK      KEY14,VALDHLFN,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,VALPCP97
.
          MATCH     SP70,PTHFHGRP
          GOTO      VALPCP95 IF EQUAL
          GOTO      VALPCP95 IF EOS
.
          MOVE      SP70,KEY3
          MOVE      PTHFHGRP,KEY3
          PACK      KEY9,KEY3,VALDECCP,SP70
          CALL      RSWBPCP1
          CALL      RKWBPCP1
          BRANCH    OVRCD,VALPCP96
.
          MATCH     KEY3,WBPCCODE
          GOTO      VALPCP95 IF NOT EQUAL
.
          MATCH     VALDECCP,WBPCCPID
          GOTO      VALPCP96 IF NOT EQUAL
.
          GOTO      VALPCP60
.
.
.
VALPCP60  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ONE:
                             "</RETURN_VALUE>"
.
          GOTO      VALPCP98
.
VALPCP95  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Participant for Eclipse - ":
                             PTHFHGRP,"</RETURN_VALUE>"
          GOTO      VALPCP98
.
VALPCP96  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Capability - ":
                             VALDECCP," for Participant - ",PTHFHGRP:
                             " for Health Fund - ",VALDHLFN,"</RETURN_VALUE>"
          GOTO      VALPCP98
.
VALPCP97  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Health Fund for Eclipse - ":
                             VALDHLFN,"</RETURN_VALUE>"
          GOTO      VALPCP98
.
VALPCP98  CALL      XMLEND00
.
VALPCP99  RETURN
.
.------------------------------------------------------------
. Validate Misc Charge Item Code
.------------------------------------------------------------
VALMS100  CALL      XMLHED00
          BRANCH    EXIT,VALMS199
          MOVE      ZERO,F1
.
          MOVE      ZERO,INVALDFL
          PACK      KEY9,VALDCODE,SP70
.
.         Check for miscellaneous item code
.
          PACK      KEY29,VALDCLMT,VALDFUND,VALDTABL,KEY9,CURRDATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      VALMS180 IF EQUAL       * it's valid
.
          MOVE      WKMCINAC,INVALDFL       * inactive
          MOVE      WKMCXXDT,INVALDAT       * date range error
.
.         No record with health fund details - try a blank health fund
.
          PACK      KEY29,VALDCLMT,SP6,SP3,KEY9,CURRDATE,SP10
          CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      VALMS180 IF EQUAL       * it's valid
.
          MOVE      WKMCINAC,INVALDFL       * inactive
          MOVE      WKMCXXDT,INVALDAT       * date range error
.
.
.         No record with blank fund details. Last chance, try default claim.
.
VALMS102  IF        IBCNMHOS=1
            MATCH     SP10,MULTHOSP
            IF        @EQUAL
              PACK      KEY3,WBSEHOSP,SP70
              CALL      RSPTHSP1
              CALL      RKPTHSP1
              BRANCH    OVRCD,VALMS192
            ELSE
              PACK      KEY3,MULTHOSP
              CALL      RDPTHSP1
              BRANCH    OVRCD,VALMS192
            ENDIF
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,CURRDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,CURRDATE,SP10
          ENDIF
.
VALMS103  CALL      PATMCHRD                * read Misc.Charges file
          COMPARE   ZERO,EXIT
          GOTO      VALMS180 IF EQUAL       * it's valid
.
          MOVE      WKMCINAC,INVALDFL       * inactive
          MOVE      WKMCXXDT,INVALDAT       * date range error
.
.                          read forward (for some reason)
.
VALMS105  IF        IBCNMHOS=1
            PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,CURRDATE,SP10
          ELSE
            PACK      KEY29,PTCNDCLM,SP6,SP3,KEY9,CURRDATE,SP10
          ENDIF
          CALL      RDMCHG1
          IF        OVRCD=0
            MATCH     "1",PTMCACTV               * Inactive ?
            GOTO      VALMS180 IF NOT EQUAL      * No
            MOVE      ONE,INVALDFL
          ENDIF
.
          UNPACK    KEY29,KEY21,KEY8

          CALL      RDKMCHG1                     * read forward (beware)
          BRANCH    OVRCD,VALMS150
          PACK      KEY21A,MCLMCOD,MHFUND,PTMCHFTT,MCHARGE
          MATCH     KEY21,KEY21A
          IF        @EQUAL
            MOVE      ONE,INVALDFL
            GOTO      VALMS180
          ENDIF
          GOTO      VALMS190
.
.         read thru all hospitals in multi hospitals table
.
VALMS150  IF        IBCNMHOS=1
            MATCH     SP10,MULTHOSP
            IF        @EQUAL
              CALL      RKPTHSP1
              IF        OVRCD=0
                PACK      KEY29,PTHSDCLM,SP6,SP3,KEY9,CURRDATE,SP10
                GOTO      VALMS103
              ENDIF
            ENDIF
          ENDIF
.
          BRANCH    INVALDFL,VALMS191
          BRANCH    INVALDAT,VALMS194
          GOTO      VALMS190
.
.                   set up HTLM data
.
VALMS180  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             MDESC:
                             "</RETURN_VALUE>"
          GOTO      VALMS198
.
VALMS190  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Misc Charge Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALMS198
.
VALMS191  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Inactive Misc Charge Code - ":
                              VALDCODE,"</RETURN_VALUE>"
          GOTO      VALMS198
.
VALMS192  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Multi Hospital Default Claim Code not setup ":
                             "</RETURN_VALUE>"
          GOTO      VALMS198
.
VALMS193  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Doctor Misc Charge Code - ":
                             "</RETURN_VALUE>"
          GOTO      VALMS198
.
VALMS194  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Misc Charge Code outside Date range - ":
                             "</RETURN_VALUE>"
          GOTO      VALMS198
.
VALMS198  CALL      XMLEND00
.
VALMS199  RETURN
.
.------------------------------------------------------------------------------
.         VALSRF00 - validate sac ref U/R
.------------------------------------------------------------------------------
.
VALSRF00  CALL      XMLHED00
          BRANCH    EXIT,VALSRF99
.
          PACK      KEY16,VALDCODE,SP70
          CALL      RSALREF2
VALSRF10  CALL      RKALREF2
          BRANCH    OVRCD,VALSRF80
.
.         we searching for a U/R with a active/waiting/inactive refferal
.         error msg on status = 0,1,3 everything else OK
.
          MATCH     VALDCODE,ALREURNO
          IF        @EQUAL
             MOVE      ALRESTAT,FORM1
             BRANCH    FORM1,VALSRF51,VALSRF50,VALSRF51,VALSRF50,VALSRF50
             GOTO      VALSRF51
          ENDIF
.
          GOTO      VALSRF10
.
VALSRF50  GOTO      VALSRF80
.
VALSRF51  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Patient has a Waiting/Active/Inactive Referral":
                             "</RETURN_VALUE>"
          GOTO      VALSRF80

VALSRF80  CALL      XMLEND00
.
VALSRF99  RETURN
+
.------------------------------------------------------------------------------
.VALSRD00 - check for a active referral by U/R and department
.------------------------------------------------------------------------------
.
VALSRD00  CALL      XMLHED00
          BRANCH    EXIT,VALSRD99
.
          PACK      KEY5,ANSC,ANSG,DEPTCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,VALSRD50
.
          MATCH     SP70,TCINDC8            * Skip test if not a VINAH related
          GOTO      VALSRD50 IF EQUAL       * department
.
          PACK      KEY16,VALDCODE,SP70
          CALL      RSALREF2
VALSRD10  CALL      RKALREF2
          BRANCH    OVRCD,VALSRD50
.
          MATCH     VALDCODE,ALREURNO
          IF        @EQUAL
.
            MATCH   ALREDEPT,DEPTCODE
            IF      !@EQUAL
              GOTO  VALSRD10
            ENDIF
.
            MATCH     "1",ALREUYN4               * Master referrals only
            GOTO      VALSRD10 IF NOT EQUAL
.
            MOVE      ALRESTAT,FORM1
            BRANCH    FORM1,VALSRD51,VALSRD10,VALSRD51,VALSRD10,VALSRD10
            GOTO      VALSRD51
.
          ELSE
            GOTO      VALSRD50
          ENDIF
.
VALSRD50  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              "1":
                             "</RETURN_VALUE>"
          GOTO      VALSRD80
.
VALSRD51  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Patient has a Waiting/Active/Inactive Referral":
                             "</RETURN_VALUE>"
          GOTO      VALSRD80

VALSRD80  CALL      XMLEND00
.
VALSRD99  RETURN
+
.------------------------------------------------------------
. Selection of Medical practice for the U/R
.------------------------------------------------------------
VALMPR00  CALL      XMLHED00
          BRANCH    EXIT,VALMPR99
.
          CALL      INMPA000               * Initialise the array
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
          PACK      KEY27,VALDCODE,SP70
          CALL      RSPRHD1
VALMPR10  CALL      RKPRHD1
          BRANCH    OVRCD,VALMPR80
.
          MATCH     VALDCODE,PRHDDEBT
          GOTO      VALMPR80 IF NOT EQUAL
.
          PACK      KEY27,PRHDUNIQ,SP70
          CALL      RSPRHR1
VALMPR20  CALL      RKPRHR1
          BRANCH    OVRCD,VALMPR10
.
          COMPARE   PRHRUNIQ,PRHDUNIQ
          GOTO      VALMPR10 IF NOT EQUAL
.
          PACK      KEY6,PRHRPRAC
          CALL      RDPRPR1
          BRANCH    OVRCD,VALMPR20
.
          COMPARE   ONE,PRPRSTAT
          GOTO      VALMPR20 IF EQUAL       * Not active
.
          CALL      MPARR000                * Check Medical Practice array
          BRANCH    EXIT,VALMPR20
.
          PACK      KEY10,USERID,SP70
          CALL      RDPRALS1
          COMPARE   ZERO,OVRCD
          GOTO      VALMPR40 IF EQUAL       * User has access to all Med.Prac.
.
          PACK      KEY16,PRHRPRAC,USERID,SP70
          CALL      RDPRSEC1
          BRANCH    OVRCD,VALMPR20
.
VALMPR40  MOVE      PRHRPRAC,DIM6
          MOVE      " (",DIM2A
          MOVE      " )",DIM2B
.         PACK      KEY40,PRPRDESC,DIM2A,PRPRPDOC,DIM2B,SP70
.         WRITE     HTMLFILE;PRPRCODE,",",KEY40,"|";
.
          WRITE     HTMLFILE;PRPRCODE,",",PRPRDESC,"|";
.
          GOTO      VALMPR20
.
VALMPR80  WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VALMPR98
.
VALMPR98  CALL      XMLEND00
VALMPR99  RETURN
+
.------------------------------------------------------------
.         Initialise Array of Medical Practices
.------------------------------------------------------------
INMPA000  MOVE      ONE,F2
          WHILE     F2<99
            MOVE      SP70,MDPRAC[F2]
            ADD       ONE,F2
          DO
INMPA999  RETURN
+
.------------------------------------------------------------
.         Array of Medical Practices
.------------------------------------------------------------
MPARR000  MOVE      ZERO,F2
MPARR100  ADD       ONE,F2
          MATCH     SP70,MDPRAC[F2]
          GOTO      MPARR200 IF EQUAL
.
          MATCH     PRHRPRAC,MDPRAC[F2]
          GOTO      MPARR100 IF NOT EQUAL
          GOTO      MPARR600
.
MPARR200  MOVE      PRHRPRAC,MDPRAC[F2]
          MOVE      ZERO,EXIT
          GOTO      MPARR999
.
MPARR600  MOVE      ONE,EXIT
          GOTO      MPARR999
.
MPARR999  RETURN
+
.------------------------------------------------------------
. Validate Contract ID and return description
. valdtype = 0 - Returns description
.            1 - Returns description & effective to date (+1)
.------------------------------------------------------------
VALCTR00  CALL      XMLHED00
          BRANCH    EXIT,VALCTR99
.
          PACK      KEY6,VALDCODE,SP70
          CALL      RDPMCID1
          BRANCH    OVRCD,VALCTR90
.
VALCTR10  MATCH     KEY6,PMCICNTR
          GOTO      VALCTR90 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>";
.
          MATCH     SP70,PMCIDESC
          IF        @EQUAL | @EOS
            WRITE     HTMLFILE;PMCICNTR;
          ELSE
            WRITE     HTMLFILE;PMCIDESC;
          ENDIF
          BRANCH    VALDTYPE,VALCTR80
.
          WRITE     HTMLFILE;"</RETURN_VALUE>"
          GOTO      VALCTR98
.
VALCTR80  MATCH     SP70,PMCITDAT
          IF        @EQUAL
            PACK      DIM11,SP70
          ELSE
            MOVE      PMCITDAT,CIDEDATE
            REP       " 0",CIDEDATE
            ADD       ONE,CIDEDATE          * effective to date (+1)
            UNPACK    CIDEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          WRITE     HTMLFILE;"|",DIM11:
                    "</RETURN_VALUE>"
          GOTO      VALCTR98
.
VALCTR90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Contract ID ":
                             VALDCODE,"</RETURN_VALUE>"
          GOTO      VALCTR98
.
VALCTR98  CALL      XMLEND00
VALCTR99  RETURN
.
.******************************************************************************
.*      Validation For Expiry Date Legal Status                               *
.******************************************************************************
VALDLS00  CALL      XMLHED00
          BRANCH    EXIT,VALDLS99
.
VALDLS10  MOVE      SP70,DIM11
          MOVE      SP70,DIM6
          MOVE      SP70,DIM8
          MOVE      ZERO,FORM6
          MOVE      SP70,LSEDDATE
          UNPACK    VALDCODE,DIM11,DIM6
.
          UNPACK    DIM11,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      LSEDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",LSEDDATE
.
          SQUEEZE   DIM6
          MOVE      DIM6,FORM6
.
          ADD       FORM6,LSEDDATE
.
          UNPACK    LSEDDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                    CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                    "</RETURN_VALUE>";
.
          CALL      XMLEND00
          GOTO      VALDLS99
.
VALDLS99  RETURN
.
.*******************************************************************************
.*        VALDIS00 - Validate Previous Visit Disaster Code / Id Number         *
.*******************************************************************************
VALDIS00  CALL      XMLHED00
          BRANCH    EXIT,VALDIS99
.
          UNPACK    SP70,DIM8,DIM9
          UNPACK    VALDCODE,DIM8,DIM9
.
          PACK      KEY25,VALDCODE,SP70
          CALL      RSDSPTL1
          CALL      RKDSPTL1
          BRANCH    OVRCD,VALDIS90
.
          MATCH     DIM8,DSPLURNO
          GOTO      VALDIS90 IF NOT EQUAL
.
          MATCH     DIM9,DSPLCODE
          GOTO      VALDIS90 IF NOT EQUAL
.
          PACK      KEY17,DSPLURNO,DSPLCODE,SP70
          CALL      RDDSPAT1
          BRANCH    OVRCD,VALDIS90
.
          MATCH     SP70,DSPTDIID
          GOTO      VALDIS90 IF EQUAL
          GOTO      VALDIS90 IF EOS
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                               DSPTDIID:
                             "</RETURN_VALUE>";
          GOTO      VALDIS98
.
VALDIS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "</RETURN_VALUE>";
          GOTO      VALDIS98
.
VALDIS98  CALL      XMLEND00
.
VALDIS99  RETURN
.
.------------------------------------------------------------------------------
.         Get default Insurance code for a service code
.------------------------------------------------------------------------------
GETINS00  CALL      XMLHED00
          BRANCH    EXIT,GETINS99
.
.         Only have default if it only has one Insurance/Service Code
.
          MOVE      SP70,KEY36
          MOVE      ZERO,FORM3
          MOVE      SP70,KEY6
          CALL      RDSINSR1
GETINS10  CALL      RDKINSR1
          BRANCH    OVRCD,GETINS80
.
          BRANCH    VALDTYPE,GETINS20
.
          MATCH     PTINSERV,VALDCODE         * matching service code
          GOTO      GETINS10 IF NOT EQUAL
          GOTO      GETINS30
.
GETINS20  MATCH     PTINCLAI,VALDCODE         * matching financial code
          GOTO      GETINS10 IF NOT EQUAL
.
GETINS30  ADD       ONE,FORM3
          IF        FORM3=1
            PACK      KEY36,ICODE,INAME,SP70
            GOTO      GETINS10
          ELSE
            PACK      KEY36,SP70
          ENDIF
.
GETINS80  MATCH     SP70,KEY36
          GOTO      GETINS90 IF EQUAL         * No default/More than one default
          UNPACK    KEY36,ICODE,INAME
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              ICODE,"|",INAME:
                             "</RETURN_VALUE>"
          GOTO      GETINS98
.
GETINS90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             "</RETURN_VALUE>";
          GOTO      GETINS98
.
GETINS98  CALL      XMLEND00
.
GETINS99  RETURN
+
.------------------------------------------------------------------------------
.         Get Health Fund and Health Fund Table
.------------------------------------------------------------------------------
GETHFN00  MOVE      SP70,HLFNDDSC
          MOVE      SP70,HLFNTDSC
.
          MATCH     SP70,PFUNDH
          GOTO      GETHFN99 IF EQUAL
          GOTO      GETHFN99 IF EOS
.
          PACK      KEY14,PFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,GETHFN99
.
          MOVE      HFNAME,HLFNDDSC
.
          MATCH     SP70,PFNDTB
          GOTO      GETHFN99 IF EQUAL
          GOTO      GETHFN99 IF EOS
.
          PACK      KEY14,PFUNDH,PFNDTB,SP70
          CALL      RDFUND1
          BRANCH    OVRCD,GETHFN99
.
          MOVE      HFNAME,HLFNTDSC
.
GETHFN99  RETURN
.
.------------------------------------------------------------
. Validate Clinic Type Code
.------------------------------------------------------------
VALCTY00  CALL      XMLHED00
          BRANCH    EXIT,VALCTY99
.
          MATCH     SP70,CHECKSIT           * Check outpatient site file prefix
          IF        !@EQUAL
            CALL      VOTFIL00
          ENDIF
.
          MATCH     SP70,CHECKSIT           * Check outpatient site file prefix
          IF        !@EQUAL
            PACK      KEY12,CHECKSIT,VALDCODE,SP70
          ELSE
            PACK      KEY12,WBSESIT,VALDCODE,SP70
          ENDIF
.
          CALL      RDCTYA1
          BRANCH    OVRCD,VALCTY90
.
          IF        RETURNFM=1
            MATCH     "1",OCTACT              * Only allow inactive codes
            GOTO      VALCTY90 IF NOT EQUAL   * for returnfm=1
          ENDIF
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             OCTDESC:
                             "</RETURN_VALUE>"
          GOTO      VALCTY98
.
VALCTY90  IF        RETURNFM=1
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>": * Silent
                               SP1:                          * No errors
                               "</RETURN_VALUE>"
          ELSE
            WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                               "Invalid Clinic Type - ":
                                KEY12,"</RETURN_VALUE>"
          ENDIF
          GOTO      VALCTY98
.
VALCTY98  CALL      XMLEND00
.
VALCTY99  RETURN
.
.------------------------------------------------------------------------------
          INC       CHKSUGCL
          INC       VALCMXFN 
          INC       GETCNEFF
          INC       CLPMSHCP
          INC       BOKRC1IO/INC
          INC       DISPATIO/INC
          INC       DISPTLIO/INC
          INC       EMRICDIO/INC
          INC       EMRVISIO/INC
          INC       EMRHISIO/INC
          INC       FMSAMAIO/INC            * Accounts
          INC       FMSCSAIO/INC            * Control Accounts
          INC       FMSLMAIO/INC            * Ledger
          INC       IBAALVIO/INC
          INC       MLTHCPIO/INC
          INC       PATFMSIO/INC            * Interface file
          INC       PATATRIO/INC
          INC       PATCFAIO/INC
          INC       PATCT1IO/INC
          INC       PATCMCIO/INC
          INC       PATCTFIO/INC
          INC       PATCMXIO/INC
          INC       PATDGWIO/INC
          INC       PATDTRIO/INC
          INC       PATDO1IO/INC
          INC       PATLGAIO/INC
          INC       PMSCNOIO/INC
          INC       PMSEVTIO/INC
          INC       PMSDUNIO/INC
          INC       PMSVX1IO/INC
          INC       PATBFEIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATHSPIO/INC
          INC       PATHOSIO/INC
          INC       PATITMIO/INC
          INC       PATTFEIO/INC
          INC       PATICOIO/INC
          INC       PATICDIO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PATMI1IO/INC
          INC       PATDSCIO/INC
          INC       PATMCHIO/INC
          INC       NZPBFEIO/INC
          INC       NZPSPRIO/INC
          INC       NZPMCHIO/INC            * NZP Misc Item File
          INC       NZPMC1IO/INC            * NZP Misc Item File
          INC       NZPMXCIO/INC
          INC       PATDETIO/INC
          INC       PATVADIO/INC
          INC       PATVISIO/INC
          INC       PATIN1IO/INC  
.         INC       PAT10DIO/INC
          INC       ALLPDIIO/INC
          INC       ALLENCIO/INC
          INC       ALLSERIO/INC
          INC       ALLREFIO/INC
          INC       ALLCASIO/INC
          INC       ALLCTMIO/INC
          INC       PMSHCPIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCLIO/INC
          INC       OPRAVEIO/INC
          INC       OPRNURIO/INC
          INC       OPRDEAIO/INC
          INC       OPREXPIO/INC
          INC       OPRTHIIO/INC
          INC       OPRITEIO/INC
          INC       OPRUPLIO/INC     
          INC       PMSCIDIO/INC
          INC       PATSGCIO/INC
          INC       PATTRNIO/INC
          INC       PATWMAIO/INC
          INC       PATWC1IO/INC
          INC       PATPARIO/INC
          INC       PATPCPIO/INC
          INC       PMSWX1IO/INC
          INC       PMSREGIO/INC
          INC       WATVWLIO/INC
          INC       OUTCLIIO/INC            * Valid Clinic Id
          INC       OUTCTYIO/INC
          INC       OUTSITIO/INC
          INC       OUTBB1IO/INC
          INC       OUTBOAIO/INC
          INC       WATPROIO/INC
          INC       MRTMASIO/INC
          INC       MEHAXIIO/INC            * Mental Health Axis Codes
          INC       WEBPARIO/INC
          INC       WEBPCPIO/INC
.
          INC       AAEDE1IO/INC
          INC       RCPBNKIO/INC
          INC       RCPCIDIO/INC            * Receipting - Cashier Id
          INC       RCPDTEIO/INC
          INC       RCPREGIO/INC
          INC       PATINVIO/INC
          INC       PATIRNIO/INC
          INC       PMSECTIO/INC
          INC       PRIALSIO/INC                 * Medical Prac.all user access
          INC       PRISECIO/INC                 * Medical Prac.security access
          INC       PRIHDBIO/INC
          INC       PRIHREIO/INC
          INC       PRICNOIO/INC                 * PP Doctor file
          INC       PRIDOCIO/INC                 * PP Doctor file
          INC       PRIINVIO/INC                 * invoice file
          INC       PRIPRAIO/INC                 * Private Practice file
          INC       DEBDBTIO/INC                 * debtors file
          INC       DEBFTHIO/INC                 * Acc Rec debtors trns hdr file
          INC       DEBFDTIO/INC                 * Acc Rec debtors trns dtl file
          INC       EMRUNKIO/INC            * Unknown Patient details
          INC       PATDDHIO/INC
          INC       PATFACIO/INC
.
          INC       PATDDHRD
          INC       PATDOCCD
          INC       CMGETTHR
          INC       CALCAGE 
          INC       NAMSTRCD
          INC       IBAWEBCD
          INC       PATDPATH
          INC       PATMCHRD
          INC       PATITMRD
          INC       GETTFEES
          INC       VALCONTR
          INC       TFILENAM 
.
