.----------------------------------------------------------------------
. Program       : COMWEB12
.
. Function      : Server for displaying lists of HL7 Messages
.               : 
.
. Modifications : 
.----------------------------------------------------------------------
. V11.05.01  09/12/2024  Thanh T       TSK 0945766
.            Recompiled for PMSQPTTM changes
. V11.04.05  24/05/2024  Thanh T       TSK 0941543
.            Added LOPML000 for Category Code - Long Description  
. V11.04.04  28/03/2024  Thanh T                TSK 0935314
.            Recompiled for PMSQDRFD changes
. V11.04.03  09/01/2024  Thanh T                TSK 0936263
.            Added OPEN PMSQPXA1 index
. V11.04.02  11/12/2023  Thanh T                TSK 0935728
.            Recompiled for OPRQUEFD changes
. V11.04.01  08/12/2023  Thanh T                TSK 0936282
.            Recompiled for EMRQUEFD changes
. V11.03.04  25/09/2023  Davin         TSK 0896442
.            Added read of pmsqpt for pmi tags (PROFLD31)
. V11.03.03  28/07/2023  Ebon Clements TSK 0935527
.            Recompiled for OPRQUEFD - Theatre booking hospital
. V11.03.02  17.04.2023  Sunny         TSK 0931303
.            Fixed CHHLTY00 for A08 message type
. V11.03.01  13/01/2023 Thanh T.               TSK 0928174
.            Changed HOML0100 to improve the processing time of the
.            HL7 Message by Hospital list 
. V11.02.11  02/11/2022 Jacob Jackson            TSK 0921463
.            Add functions to help with appending name to Operator ID
.            and usernames
.            Recompile EMRQUETM, PMSQVITM, PMSQPTTM, HL7CISTM, PMSQDRTM
.            ALLQUETM, OPRQUETM and OUTRQUTM
. V11.02.10  07/07/2022 Jacob Jackson            TSK 0921871
.            Fix issue where it displays records from future days
.            Fix issue where HL7 message data would not update
.            Recompile for HL7CISTM and add H7DETIME/H7DEDATE
. V11.02.09  24/06/2022 Ebon Clements            TSK 0920836
.            Skip hospital permissions if not multi hospital - HOML0000
. V11.02.08  22/06/2022 Ebon Clements            TSK 0920836
.            Corrected key pack and file loop for hospital level messages.
.            Increased max record display from 200 to 2000 - HOML0000
. V11.02.07  09/05/2022 Jacob Jackson            TSK 0912222
.            For hospital level page, ensure converted messages are 
.            filtered correctly when searching by message type
. V11.02.06  09/05/2022 Jacob Jackson            TSK 0912222
.            Add check for A05 messages converted from A14 for INP
.            Perform A14->A05 conversion for hospital level page
.            Recompile HL7CISTM and add H7WRTIME/H7WRDATE
. V11.02.05  06/05/2022  Jacob Jackson            TSK 0912222
.            Add missing check for A05 messages for O/P
.            Add CONTROLF variables: PTCNA31X (alternate A31 id) & 
.            PTCNH7A5 (A14->A05)
.            Recompile OUTQUETM
. V11.02.04  05/05/2022  Jacob Jackson            TSK 0912222
.            Move generation of icons to server to not interfere with table
.            JS code
. V11.02.03  03/05/2022  Jacob Jackson            TSK 0912222
.            RJUSTIFY urnumber to ensure DB search can occur properly
. V11.02.02  26/04/2022  Jacob Jackson            TSK 0912222
.            Add support for multiple new HL7 queue tables
.            Checks which specific HL7 message fits with which table
. V11.02.01  03/10/2021  Jacob Jackson            SRF 0912222
.            Created server file to generate HL7 lists.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF
.
          INC       PATDO1FD/INC   * Doctor File
          INC       PATMI1FD/INC
          INC       PATMA1FD/INC
          INC       PATVISFD/INC   * Patients Visits File
          INC       PMSVX1FD/INC   * Visit Extension File
          INC       PATCONFD/INC
          INC       PATALRFD/INC
          INC       OUTSITFD/INC
          INC       PATCOMFD/INC
          INC       PATPR1FD/INC
          INC       PMSPX2FD/INC
          INC       PATFN1FD/INC
          INC       PATWR1FD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       PATCALAG/INC
          INC       PMSPX2TD/INC
          INC       PATMASTD/INC
          INC       PATRE1FD/INC
          INC       PATDGWFD/INC
          INC       PATCMNFD/INC
          INC       PATITMFD/INC
          INC       PATDADFD/INC
          INC       PATVADFD/INC
          INC       PATCMCFD/INC
          INC       PATASFFD/INC
          INC       PMSHCGTD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSHCPTD/INC
          INC       APSMASFD/INC
          INC       PATIN1FD/INC
          INC       PATDSCFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PMSCCDFD/INC
          INC       PATHSPFD/INC
          INC       HL7CISFD/INC
          INC       MLTSECFD/INC
          INC       PMSQPTFD/INC
          INC       PATNIDFD/INC
          INC       PMSQVIFD/INC
          INC       PATTRNFD/INC
          INC       MEHLERFD/INC
          INC       PATONLFD/INC
          INC       PMSBRQFD/INC
          INC       EMRVISFD/INC
          INC       EMRQUEFD/INC
          INC       ALLREFFD/INC
          INC       ALLENCFD/INC
          INC       ALLQUEFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTRSHFD/INC
          INC       OUTCANFD/INC
          INC       OUTMA1FD/INC
          INC       OUTTHIFD/INC
          INC       OUTQUEFD/INC
          INC       WATTR1FD/INC
          INC       WATTX1FD/INC
          INC       WATQUEFD/INC
          INC       OPRDEAFD/INC
          INC       OPRQUEFD/INC
          INC       PMSQDRFD/INC
          INC       OUTRQUFD/INC
          INC       OUTQMAFD/INC
          INC       OUTRF1FD/INC
.         INC       WEBSECFD/INC
+
.----------------------------------------------------------------------
NEXTPAGE  DIM       1       * Nextpage parameter CGI parameter
UPDTTYPE  DIM       1       * Update Type
STARTKEY  DIM       10      * Starting Key
CURRDATE  DIM       8       * Current Date
FORM8     FORM      8
FORM3     FORM      3
DOCTCODE  DIM       8
PSAGETYP  DIM       3
MBSDESC   DIM       70
PSAGECON  DIM       3
STATWORD  DIM       9
STATUSHL  DIM       1  
HOSPTLHL  DIM       3
MSGTYPHL  DIM       3
COUNTER1  FORM      8
COUNTER2  FORM      4
PATLINK   DIM       127
HL7POPUP  DIM       127
HL7POPU2  DIM       127
HL7DATA1  DIM       127
MONTHW    DIM       3
MONTHI    DIM       2
MONTHO    FORM      2
YEARI     DIM       2
CENTI     DIM       2
DAYI      DIM       2
DATEFMT   DIM       8
DATECUT   DIM       8
MONTHWL   DIM       9
HL7CIMES  DIM       20
VARTEMP1  FORM      2
VARTEMP2  DIM       3
TC01      DIM       2
AC02      DIM       3
HP03      DIM       3
UNIQNUM   DIM       4
HL7TIME   DIM       8 
HL7DATE   DIM       8
SUPERLEV  DIM       1
DELLINK   DIM       127
RESLINK   DIM       127
UPH7STAT  DIM       1
SAVTXWRD  DIM       3
TEMPLNUM  FORM      3
DTTBLLST  DIM       8
ABBREDE1  DIM       3
ABBREDE2  DIM       3
ABBREDE3  DIM       3
ABBREDE4  DIM       3
ABBREDE5  DIM       3
LONGIDE1  DIM       40
LONGIDE2  DIM       40
LONGIDE3  DIM       40
LONGIDE4  DIM       40
LONGIDE5  DIM       40
LONGIDE6  DIM       40
LONGIDE7  DIM       40
LONGIDE8  DIM       40
LONGIDE9  DIM       40
LONGDE10  DIM       40
LONGDE11  DIM       40
ABBREVAR  DIM       3
ABSPRVAR  DIM       3
SIGVALUE  DIM       1
H7DATTYP  DIM       3
LNGTHNUM  FORM      3
NUMCHECK  FORM      3
STATONUM  FORM      1
NUMABVAR  FORM      3
H7WRDATE  DATE      8
H7WRTIME  DIM       8
H7DEDATE  DATE      8
H7DETIME  DIM       8
OPERATID  DIM       4
WBUSRNAM  DIM       10
.
.----------------------------------------------------------------------
PRGID     INIT      "COMWEB12"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "HL7 Message Listing Webserver"
.----------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1300
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "Invalid Option",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      MSBYUR00   * Setup patient-level HL7 list webpage
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN1000
.
MAIN1200  CALL      MSBYHP00   * Setup hospital-wide HL7 list webpage
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN1000
.
MAIN1300  CALL      MSHLDI00   * Setup popup page for HL7 message details
          BRANCH    EXIT,MAIN1000
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Open Files and Initialize Variables
.----------------------------------------------------------
INIT0000  CALL      INTMAS00     * Open routine for PATMASTM 
          OPEN      PATVISA2,"patvisaf"
          OPEN      PMSVX1A1,"pmsvx1af"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATCMNT1,"patcmntf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      HL7CISA5,"hl7cisaf"
          OPEN      HL7CISA2,"hl7cisaf"
          OPEN      HL7CISA1,"hl7cisaf"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      PMSQPTA1,"pmsqptaf"
          OPEN      PMSQPXA1,"pmsqpxaf"
.
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PMSHCPA6,"pmshcpaf"
          OPEN      PMSQVIA1,"pmsqviaf"
          OPEN      EMRQUEA1,"emrqueaf"
          OPEN      ALLQUEA1,"allqueaf"
          OPEN      OUTQUEA1,"outqueaf"
          OPEN      WATQUEA1,"watqueaf"
          OPEN      OPRQUEA1,"oprqueaf"
          OPEN      PMSQDRA1,"pmsqdraf"
          OPEN      OUTQMAA1,"outqmaaf"
          OPEN      OUTRQUA1,"outrquaf"
          OPEN      WEBSECA1,"websecaf"
          OPEN      WEBSECA3,"websecaf"
.
          OPEN      CONTROLF,"controlf"
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,HUND10;*98,PTCNA31X  * get alternative A31 message
          READ      CONTROLF,HUND12;*99,PTCNH7A5  * sending A05 instead of A08
          READ      CONTROLF,HUND18;*241,PTCNH7RA
.
INIT9999  RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      SP70,TEMPLATE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,STATUSHL
          MOVE      SP70,HOSPTLHL
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,TEMPLATE
          MOVE      SP70,PREFDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,MSGTYPHL
          MOVE      ZERO,COUNTER1
          MOVE      SP70,HL7CIMES
          MOVE      SP70,HL7DATE
          MOVE      SP70,HL7TIME
          MOVE      SP70,SUPERLEV
          MOVE      SP70,UPH7STAT
.
CLRPAR99  RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "statushl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STATUSHL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hosptlhl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOSPTLHL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "msgtyphl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MSGTYPHL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hl7cimes=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HL7CIMES
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmhclupd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HL7DATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmhclupt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HL7TIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "superlev=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SUPERLEV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "uph7stat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPH7STAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Message by UR Number Function
.------------------------------------------------------------
MSBYUR00  MATCH     SP70,UPDTTYPE
          GOTO      MSBYUR70 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      MSBYUR10 IF EQUAL
.
          MATCH     "D",UPDTTYPE
          GOTO      MSBYUR20 IF EQUAL
.
          GOTO      MSBYUR90
.
MSBYUR10  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDH7CIS1
          MOVE      UPH7STAT,H7CISTAT
          CALL      UPH7CIS1   * update hl7 message
          GOTO      MSBYUR70
.
MSBYUR20  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      DEH7CIS1   * delete hl7 message
          GOTO      MSBYUR70
.
MSBYUR70  MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,MSBYUR91
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "List of HL7 Messages for UR -",WEBTITLE
          ENDSET    WEBTITLE
          APPEND    PURNO,WEBTITLE
          RESET     WEBTITLE 
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MSBYUR99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      MSBYUR99
.
MSBYUR90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MSBYUR99
.
MSBYUR91  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MSBYUR99
.
MSBYUR99  RETURN
+
.------------------------------------------------------------
. Message by Hospital Function
.------------------------------------------------------------
.
MSBYHP00  MATCH     SP70,UPDTTYPE
          GOTO      MSBYHP70 IF EQUAL
.
          MATCH     "U",UPDTTYPE
          GOTO      MSBYHP10 IF EQUAL
.
          MATCH     "D",UPDTTYPE
          GOTO      MSBYHP20 IF EQUAL
.
          GOTO      MSBYHP90
.
MSBYHP10  PACK      KEY20,HL7CIMES,SP70
          CALL      RDH7CIS1
          MOVE      UPH7STAT,H7CISTAT
          CALL      UPH7CIS1   * update hl7 message
          GOTO      MSBYHP70
.
MSBYHP20  PACK      KEY20,HL7CIMES,SP70
          CALL      DEH7CIS1   * delete hl7 message
          GOTO      MSBYHP70
.
MSBYHP70  CALL      CURPER00
          CALL      CALCDT00
. 
          CLEAR     WEBTITLE
          MOVE      "List of All HL7 Messages for Selected Hospitals",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MSBYHP99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      MSBYHP99
.
MSBYHP90  MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MSBYHP99
.
MSBYHP99  RETURN
+
.------------------------------------------------------------
. Detailed HL7 Message Detail
.------------------------------------------------------------
.
MSHLDI00  MATCH     SP70,UPDTTYPE
          GOTO      MSHLDI70 IF EQUAL
.
          GOTO      MSHLDI90
.
MSHLDI70  CALL      CURPER00
          CALL      CALCDT00
.          
          CLEAR     WEBTITLE
          CALL      FRTY0000
          RESET     WEBTITLE           
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,MSHLDI99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      MSBYHP99
.
MSHLDI90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      MSHLDI99
.
MSHLDI99  RETURN
+
.------------------------------------------------------------
. [FUNCTION] HL7 Frame Type
.------------------------------------------------------------
FRTY0000  MOVE      TEMPLATE,TEMPLNUM
          BRANCH    TEMPLNUM,FRTY0100,FRTY0200,FRTY0300,FRTY0400,FRTY0500:
                             FRTY0600,FRTY0700,FRTY0800,FRTY0900,FRTY1000
.
FRTY0100  IF        REPORTNO=04
            MOVE      "Referral Letter Data",WEBTITLE
          ELSE
            MOVE      "Patient Data",WEBTITLE
          ENDIF
          GOTO      FRTY9999
.
FRTY0200  MOVE      "Message Data",WEBTITLE
          GOTO      FRTY9999
.
FRTY0300  MOVE      "Visit Data",WEBTITLE
          GOTO      FRTY9999
.
FRTY0400  MOVE      "HCP Data",WEBTITLE
          GOTO      FRTY9999
.
FRTY0500  MOVE      "Emergency Data",WEBTITLE
          GOTO      FRTY9999
.
FRTY0600  MOVE      "Allied Health Data",WEBTITLE
          GOTO      FRTY9999
.
FRTY0700  MOVE      "Outpatient Data",WEBTITLE
          GOTO      FRTY9999
.
FRTY0800  MOVE      "Waiting List Data",WEBTITLE
          GOTO      FRTY9999
.
FRTY0900  MOVE      "Operating Data",WEBTITLE
          GOTO      FRTY9999
.
FRTY1000  MOVE      "Clinic Data",WEBTITLE
          GOTO      FRTY9999
.
FRTY9999  ENDSET    WEBTITLE
          APPEND    " - HL7 Detail",WEBTITLE
          RETURN
+
.------------------------------------------------------------
. Process Fields 
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD50
          GOTO      PROFLD99 
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      MASF0000    * Master File Info
          GOTO      PROFLD99
.
PROFLD12  CALL      GTAG0000    * General tags
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99
.
PROFLD21  CALL      GTAG0000    * General tags
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31,PROFLD32,PROFLD33,PROFLD34,PROFLD35:
                             PROFLD36,PROFLD37,PROFLD38,PROFLD39,PROFLD40
          GOTO      PROFLD99
.
PROFLD31  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDPMQPT1
.
          CALL      PMSA0000    * PMI tags
          GOTO      PROFLD99
.
PROFLD32  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDH7CIS1
.
          CALL      H7CA0000    * HL7 MSG Tech Info tags
          GOTO      PROFLD99
.
PROFLD33  RJUSTIFY  HL7CIMES
          PACK      KEY22,HL7CIMES,SP70
          CALL      RSPMQVI1
          CALL      RKPMQVI1
.
          CALL      PMQA0000    * PMQ tags
          GOTO      PROFLD99
.
PROFLD34  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDPMQDR1
.
          CALL      PQDA0000    * HCP tags
          GOTO      PROFLD99    
.
PROFLD35  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDEMQUE1
.
          CALL      EMRA0000    * Emergency tags
          GOTO      PROFLD99
.
PROFLD36  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDALQUE1
.
          CALL      ALLA0000    * ALL tags
          GOTO      PROFLD99
.
PROFLD37  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDOTQUE1
.
          CALL      OUTA0000    * OUT tags
          GOTO      PROFLD99
.
PROFLD38  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDWTQUE1
.
          CALL      WATA0000    * WAT tags
          GOTO      PROFLD99
.
PROFLD39  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDOPQUE1   
.
          MOVE      "TT",WEBTITLE
          CALL      OPDA0000
          GOTO      PROFLD99
.
PROFLD40  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDOTQMA1
.
          CALL      OMQA0000
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51
          GOTO      PROFLD99
.
PROFLD51  RJUSTIFY  HL7CIMES
          PACK      KEY20,HL7CIMES
          CALL      RDOTRQU1
.
          CALL      ORFA0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
+
.------------------------------------------------------------
. General Tags                                              
.------------------------------------------------------------
.
GTAG0000  BRANCH    FLDITMNO,GTAG0100,GTAG0200,GTAG0300,GTAG0400,GTAG0500:
                             GTAG0600,GTAG0700,GTAG0800,GTAG0900,GTAG1000:
                             GTAG1100,GTAG1200,GTAG1300,GTAG1400,GTAG1500:
                             GTAG1600,GTAG1700,GTAG1800,GTAG1900,GTAG2000
          GOTO      GTAG9999
.
GTAG0100  CALL      URML0000    * loop through messaging by U/R
          GOTO      GTAG9999
.
GTAG0200  CALL      HOML0000    * loop through messaging by hospital
          GOTO      GTAG9999
.
GTAG0300  CALL      HOSL0000    * list all hospitals for select
          GOTO      GTAG9999
.
GTAG0400  CALL      STSL0000    * list all status for select
          GOTO      GTAG9999
.
GTAG0500  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      GTAG9999
.
GTAG0600  CALL      NEXT0000    * generates all parameter links for >> button for date
          GOTO      GTAG9999
.
GTAG0700  CALL      PREV0000    * generates all parameter links for << button for date
          GOTO      GTAG9999
.
GTAG0800  CALL      SELV0000    * helper call to set all dates in date select list
          GOTO      GTAG9999
.
GTAG0900  WRITE     HTMLFILE;MSGTYPHL;
          GOTO      GTAG9999
.
GTAG1000  WRITE     HTMLFILE;FRSTDATE;
          GOTO      GTAG9999
.
GTAG1100  WRITE     HTMLFILE;LASTDATE;
          GOTO      GTAG9999
.
GTAG1200  WRITE     HTMLFILE;HOSPTLHL;
          GOTO      GTAG9999
.
GTAG1300  MOVE      FRSTDATE,DATEFMT
          CALL      DTFM0000
          GOTO      GTAG9999
.
GTAG1400  MOVE      LASTDATE,DATEFMT
          CALL      DTFM0000
          GOTO      GTAG9999
.
GTAG1500  CALL      MODI0000
          GOTO      GTAG9999
.
GTAG1600  WRITE     HTMLFILE;SUPERLEV;
          GOTO      GTAG9999
.
GTAG1700  WRITE     HTMLFILE;FRSTDATE;
          GOTO      GTAG9999
.
GTAG1800  WRITE     HTMLFILE;LASTDATE;
          GOTO      GTAG9999
.
GTAG1900  WRITE     HTMLFILE;VYEARMTH;
          GOTO      GTAG9999
.
GTAG2000  WRITE     HTMLFILE;STATUSHL;
          GOTO      GTAG9999
.
GTAG9999  RETURN
+
.-------------------------------------------------------------
. [TAG/FUNCTION] Display date in format - dd Mon ccyy
.-------------------------------------------------------------
.
DTFM0000  MATCH     SP70,DATEFMT
          GOTO      DTFM9999 IF EQUAL    * avoid having blank value be written
          UNPACK    DATEFMT,CENTI,YEARI,MONTHI,DAYI
          MOVE      MONTHI,MONTHO
          LOAD      MONTHW,MONTHO,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;DAYI,SP1,MONTHW,SP1,CENTI,YEARI;
          CLEAR     DATEFMT

DTFM9999  RETURN
+
.-------------------------------------------------------------
. [TAG] Display full month name
.-------------------------------------------------------------
.
MODI0000  UNPACK    FRSTDATE,CENTI,YEARI,MONTHI,DAYI
          MOVE      MONTHI,MONTHO
          LOAD      MONTHWL,MONTHO,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;MONTHWL;
.
MODI9999  RETURN
+
.-------------------------------------------------------------
. [TAG] Loop to display all HL7 messages which match UR
.-------------------------------------------------------------
.
URML0000  MOVE      ZERO,COUNTER2
          PACK      KEY44,URNUMBER,SP70
          CALL      RSH7CIS5
.
URML0100  CALL      RKH7CIS5
          BRANCH    OVRCD,URML9999
.
          MATCH     URNUMBER,H7CIURNO
          GOTO      URML9999 IF NOT EQUAL
          CALL      STCO0000
.
URML0300  MATCH     SP70,STATUSHL
          GOTO      URML0310 IF EQUAL
.
          MATCH     H7CISTAT,STATUSHL
          GOTO      URML0100 IF NOT EQUAL
.
URML0310  CALL      HLMT0000
          CALL      HLLI0000
          MATCH     "1",SUPERLEV
          IF        @EQUAL
            CALL     LIRE0000
            CALL     LIDE0000
            WRITE    HTMLFILE;"t.addRow(#"",H7CIDTTM,"#",":
                              "#"",H7CIMETP,"#",":
                              "#"",STATWORD,"#",":
                              "#"",DH7CIMES,"#",":
                              "#"",H7CIDDAT,"#",":
                              "#"",HL7POPU2,HL7POPUP,"#",":
                              "#"",HL7DATA1,"#",":
                              "#"",KEY3,"#",":
                              "#"",RESLINK,"#",":
                              "#"",DELLINK,"#");"
          ELSE
            WRITE    HTMLFILE;"t.addRow(#"",H7CIDTTM,"#",":
                              "#"",H7CIMETP,"#",":
                              "#"",STATWORD,"#",":
                              "#"",DH7CIMES,"#",":
                              "#"",H7CIDDAT,"#",":
                              "#"",HL7POPU2,HL7POPUP,"#",":
                              "#"",HL7DATA1,"#",":
                              "#"",KEY3,"#");"
          ENDIF
          ADD       ONE,COUNTER2
          GOTO      URML0100
.          
URML9999  RETURN          
+
.------------------------------------------------------------
. [FUNCTION] HL7 Status Converter
.------------------------------------------------------------
.
STCO0000  MOVE      SP70,HTMLLINK
          MATCH     "W",H7CISTAT
          IF        @EQUAL
	     MOVE      "Waiting",STATWORD
          ENDIF
.
          MATCH     "R",H7CISTAT
          IF        @EQUAL
            MOVE      "Rejected",STATWORD
          ENDIF
.
          MATCH     "D",H7CISTAT
          IF        @EQUAL
            MOVE      "Delivered",STATWORD
          ENDIF
.
STCO9999  RETURN
.------------------------------------------------------------
. [TAG] Loop to display all HL7 Messages based on Hospital
.------------------------------------------------------------
.
HOML0000  MOVE      ZERO,COUNTER1
.
          MATCH     SP70,STATUSHL           * Exit if status filter is blank
          GOTO      HOML9999 IF EQUAL
.
          PACK      KEY37,STATUSHL,FRSTDATE,SP70
          CALL      RSH7CIS2
HOML0100  CALL      RKH7CIS2
          BRANCH    OVRCD,HOML9999
.
          RESET     DTTBLLST
          MOVE      H7CIDTTM,DTTBLLST
.
          MATCH     STATUSHL,H7CISTAT       * Exit if status not correct
          GOTO      HOML9999 IF NOT EQUAL
.
          MATCH     DTTBLLST,LASTDATE       * Exit if date after date to
          GOTO      HOML9999 IF LESS
.          
          IF        COUNTER1 >= 2000
            WRITE     HTMLFILE;"alert('Too many records to view - 2000')";
            GOTO      HOML9999
          ENDIF
.
          COMPARE   ONE,IBCNMHOS            * Using multi hospital
          GOTO      HOML0110 IF NOT EQUAL
.
          MATCH     SP70,HOSPTLHL
          IF        !@EQUAL
            MATCH     HOSPTLHL,H7CIHOSP
            GOTO      HOML0100 IF NOT EQUAL
          ENDIF
. 
          PACK      KEY13,USERID,SP70
          CALL      RDMLSEC1
          IF        OVRCD=0
            GOTO      HOML0110
          ENDIF 
.            
          PACK      KEY13,USERID,H7CIHOSP,SP70
          CALL      RDMLSEC1
          BRANCH    OVRCD,HOML0100
.
.          PACK      KEY13,USERID,SP70
.          CALL      RDMLSEC1
.          IF        OVRCD=1
.
.            PACK      KEY13,USERID,HOSPTLHL,SP70
.            CALL      RDMLSEC1
.            IF        OVRCD=1
.              PACK      KEY3,SP70
.              CALL      RSPTHSP1
.HOML0105      CALL      RKPTHSP1
.              BRANCH    OVRCD,HOML0100
.              MATCH     PTHSHOSP,H7CIHOSP
.              GOTO      HOML0105 IF NOT EQUAL
.              PACK      KEY13,USERID,PTHSHOSP,SP70
.              CALL      RDMLSEC1
.              BRANCH    OVRCD,HOML0105
.            ENDIF
.          ENDIF
.         
HOML0110  CALL      HP7C0000
          MATCH     SP70,MSGTYPHL
          IF        !@EQUAL
            MATCH     MSGTYPHL,H7CIMETP
            GOTO      HOML0100 IF NOT EQUAL
          ENDIF
.
          CALL      STCO0000
          CALL      HLLI0000
          MATCH     SP70,H7CIURNO
          IF        @EQUAL
            CLEAR     PATLINK
            CLEAR     FORMATNM
            CALL      H2MS0000
          ELSE
            CALL      LINK0000 
            CALL      GETPAT00
            CALL      PATLN000
          ENDIF
.
          MATCH     "1",SUPERLEV
          IF        @EQUAL
            CALL     LIRE0000
            CALL     LIDE0000
            WRITE     HTMLFILE;"t.addRow(#"",H7CIDTTM,"#",":
                             "#"",H7CIMETP,"#",":
                             "#"",STATWORD,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",PATLINK,"#",":
                             "#"",H7CIURNO,"#",":
                             "#"",DH7CIMES,"#",":
                             "#"",H7CIDDAT,"#",":
                             "#"",HL7DATA1,"#",":
                             "#"",KEY3,"#",":
                             "#"",RESLINK,"#",":
                             "#"",DELLINK,"#");"
          ELSE 
            WRITE     HTMLFILE;"t.addRow(#"",H7CIDTTM,"#",":
                             "#"",H7CIMETP,"#",":
                             "#"",STATWORD,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",PATLINK,"#",":
                             "#"",H7CIURNO,"#",":
                             "#"",DH7CIMES,"#",":
                             "#"",H7CIDDAT,"#",":
                             "#"",HL7DATA1,"#",":
                             "#"",KEY3,"#");"
          ENDIF
          ADD       ONE,COUNTER1
          GOTO      HOML0100
. 
HOML9999  RETURN
+
.------------------------------------------------------------
. [TAG] Create hospital select element, based on permissions
.------------------------------------------------------------
.
HOSL0000  PACK      KEY3,SP70
          CALL      RSPTHSP1
.
HOSL0100  CALL      RKPTHSP1
          BRANCH    OVRCD,HOSL9999
.
          PACK      KEY13,USERID,SP70
.
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70
            CALL      RDMLSEC1
            BRANCH    OVRCD,HOSL0100
          ENDIF
.
          WRITE     HTMLFILE;"<option value=#"",PTHSHOSP,"#">",PTHSNAME,"</option>";
.
          GOTO      HOSL0100
.
HOSL9999  RETURN
+
.------------------------------------------------------------
. [TAG] HL7 Status Filter
.-----------------------------------------------------------
.
STSL0000  WRITE     HTMLFILE;STATUSHL;
.
STSL9999  RETURN
+
.
.-----------------------------------------------------------
. [FUNCTION] Hospital-Level Message M01 or M02 Popup
.-----------------------------------------------------------
H2MS0000  SQUEEZE   DH7CIMES
          APPEND    "javascript:AssessLink('",PATLINK
          APPEND    DH7CIMES,PATLINK
          MATCH     "M01",H7CIMETP
          IF        @EQUAL
            APPEND    "', 'OQ');", PATLINK
            APPEND    "Clinic Data Changed",FORMATNM
          ENDIF
          MATCH     "M02",H7CIMETP
          IF        @EQUAL
            APPEND    "', 'H');", PATLINK
            APPEND    "HCP Data Changed",FORMATNM
          ENDIF
.
H2SM9999  RETURN
m
+
.-----------------------------------------------------------
. [FUNCTION] Create message reset function link
.-----------------------------------------------------------
LIRE0000  CLEAR     RESLINK
          APPEND    "javascript:LinkReset('",RESLINK
          APPEND    DH7CIMES,RESLINK
          APPEND    "', '",RESLINK
          APPEND    H7CISTAT,RESLINK
          APPEND    "');",RESLINK
.
LIRE9999  RETURN
+
.-----------------------------------------------------------
. [FUNCTION] Create message delete function link
.-----------------------------------------------------------
.
LIDE0000  CLEAR     DELLINK
          APPEND    "javascript:LinkDelete('",DELLINK
          APPEND    DH7CIMES,DELLINK
          APPEND    "');",DELLINK
.         
LIDE9999  RETURN
+
.-----------------------------------------------------------
. [FUNCTION] Check if DIM is purely a number
.-----------------------------------------------------------
.
ISNUMBER  MOVEFPTR  ABBREVAR,LNGTHNUM
          MOVE      ABBREVAR,ABSPRVAR
          RESET     ABSPRVAR
          MOVE      ZERO,NUMCHECK
          MOVE      TWO,STATONUM
CHKISNUM  ADD       ONE,NUMCHECK
          CMATCH    ABSPRVAR,"1"
          GOTO      FOUNDNUM IF EQUAL
          CMATCH    ABSPRVAR,"2"
          GOTO      FOUNDNUM IF EQUAL
          CMATCH    ABSPRVAR,"3"
          GOTO      FOUNDNUM IF EQUAL
          CMATCH    ABSPRVAR,"4"
          GOTO      FOUNDNUM IF EQUAL
          CMATCH    ABSPRVAR,"5"
          GOTO      FOUNDNUM IF EQUAL
          CMATCH    ABSPRVAR,"6"
          GOTO      FOUNDNUM IF EQUAL
          CMATCH    ABSPRVAR,"7"
          GOTO      FOUNDNUM IF EQUAL
          CMATCH    ABSPRVAR,"8"
          GOTO      FOUNDNUM IF EQUAL
          CMATCH    ABSPRVAR,"9"
          GOTO      FOUNDNUM IF EQUAL
          CMATCH    ABSPRVAR,"0"
          GOTO      FOUNDNUM IF EQUAL
          MOVE      ZERO,STATONUM
FOUNDNUM  BUMP      ABSPRVAR,1
          COMPARE   NUMCHECK,LNGTHNUM
          GOTO      CHKISNUM IF NOT EQUAL
          COMPARE   ZERO,STATONUM
          GOTO      NOTANUMB IF EQUAL
.
          MOVE      ONE,STATONUM
NOTANUMB  RETURN
.  
+
.-----------------------------------------------------------
. [FUNCTION] Abbreviation, Longification
.-----------------------------------------------------------
.
ABLO0000  SQUEEZE   ABBREVAR
.
          CALL      ISNUMBER
          IF        STATONUM=1
            MOVE      ABBREVAR,NUMABVAR
            ADD       ONE,NUMABVAR
            BRANCH    NUMABVAR,ABLO0100,ABLO0200,ABLO0300,ABLO0400,ABLO0500:
                               ABLO0600,ABLO0700,ABLO0800,ABLO0900,ABLO1000:
                               ABLO1100
          ENDIF
.
          SQUEEZE   ABBREDE1
          MATCH     ABBREDE1,ABBREVAR
          IF        @EQUAL
ABLO0100    WRITE     HTMLFILE;LONGIDE1;
            GOTO      ABLO9999
          ENDIF
.
          SQUEEZE   ABBREDE2
          MATCH     ABBREDE2,ABBREVAR
          IF        @EQUAL
ABLO0200    WRITE     HTMLFILE;LONGIDE2;
            GOTO      ABLO9999
          ENDIF
.
          SQUEEZE   ABBREDE3
          MATCH     ABBREDE3,ABBREVAR
          IF        @EQUAL
ABLO0300    WRITE     HTMLFILE;LONGIDE3;
            GOTO      ABLO9999
          ENDIF
.
          SQUEEZE   ABBREDE4
          MATCH     ABBREDE4,ABBREVAR
          IF        @EQUAL
ABLO0400    WRITE     HTMLFILE;LONGIDE4;
            GOTO      ABLO9999
          ENDIF
.
          SQUEEZE   ABBREDE5
          MATCH     ABBREDE5,ABBREVAR
          IF        @EQUAL
ABLO0500    WRITE     HTMLFILE;LONGIDE5;
            GOTO      ABLO9999
          ENDIF
.
ABLO0600  WRITE     HTMLFILE;LONGIDE6;
          GOTO      ABLO9999
.
ABLO0700  WRITE     HTMLFILE;LONGIDE7;
          GOTO      ABLO9999
.
ABLO0800  WRITE     HTMLFILE;LONGIDE8;
          GOTO      ABLO9999
.
ABLO0900  WRITE     HTMLFILE;LONGIDE9;
          GOTO      ABLO9999
.
ABLO1000  WRITE     HTMLFILE;LONGDE10;
          GOTO      ABLO9999
.
ABLO1100  WRITE     HTMLFILE;LONGDE11;
          GOTO      ABLO9999
.
ABLO9999  CLEAR     LONGIDE1
          CLEAR     LONGIDE2
          CLEAR     LONGIDE3
          CLEAR     LONGIDE4
          CLEAR     LONGIDE5
          CLEAR     LONGIDE6
          CLEAR     LONGIDE7
          CLEAR     LONGIDE8
          CLEAR     LONGIDE9
          CLEAR     LONGDE10
          CLEAR     LONGDE11
          CLEAR     ABBREDE1
          CLEAR     ABBREDE2
          CLEAR     ABBREDE3
          CLEAR     ABBREDE4
          CLEAR     ABBREDE5
          CLEAR     ABBREVAR
          CLEAR     NUMABVAR
          CLEAR     STATONUM
          RETURN
+
.-----------------------------------------------------------
. [FUNCTION] Get patient details for FORMATNM
.-----------------------------------------------------------
.
GETPAT00  MATCH     SP70,H7CIURNO
          IF        !@EQUAL
            MOVE      H7CIURNO,KEY8
            CALL      RDMAST1
            BRANCH    OVRCD,GETPAT99
            CALL      RDPMPX21
          ENDIF
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                
          MOVE      DSEXDESC,DISPSEX     
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATNAM00
.
GETPAT99  RETURN
+
.------------------------------------------------------------
. [TAG] Next Date for Date Select (day, week, month)
.------------------------------------------------------------
.
NEXT0000  WRITE     HTMLFILE;"comweb12.pbl":
                             "?reportno=",REPORTNO:
                             "&template=",TEMPLATE:
                             "&frstdate=",NXTFDATE:
                             "&viewtype=",VIEWTYPE:
                             "&statushl=",STATUSHL:
                             "&hosptlhl=",HOSPTLHL:
                             "&msgtyphl=",MSGTYPHL:
                             "&lastdate=",NXTLDATE:
                             "&superlev=",SUPERLEV;
.
NEXT9999  RETURN
+
.------------------------------------------------------------
. [TAG] Prev Date for Date Select (day, week, month)
.------------------------------------------------------------
.
PREV0000  WRITE     HTMLFILE;"comweb12.pbl":
                             "?reportno=",REPORTNO:
                             "&template=",TEMPLATE:
                             "&frstdate=",PREFDATE:
                             "&viewtype=",VIEWTYPE:
                             "&statushl=",STATUSHL:
                             "&hosptlhl=",HOSPTLHL:
                             "&msgtyphl=",MSGTYPHL:
                             "&lastdate=",PRELDATE:
                             "&superlev=",SUPERLEV;
.
PREV9999  RETURN
+
.------------------------------------------------------------
. [FUNCTION] Create patient link for FORMATNM
.------------------------------------------------------------
.
LINK0000  CLEAR     PATLINK
          APPEND    "javascript:LinkPatient('",PATLINK
          APPEND    "patweb98.pbl?reportno=01&template=001&urnumber=",PATLINK
          APPEND    H7CIURNO,PATLINK
          APPEND    "&viewtype=",PATLINK
          APPEND    VIEWTYPE,PATLINK
          APPEND    "')",PATLINK
.
LINK9999  RETURN
+
.-------------------------------------------------------------
. [HELPER-FUNCTION] DB calls to check HL7 <-> Queue relation
.-------------------------------------------------------------
H7CHKWAT  PACK      KEY20,DH7CIMES   *watqueaf
          CALL      RAWTQUE1
          IF        OVRCD=0
            MOVE      "W",H7DATTYP
            GOTO      CHHLTY99
          ENDIF
          RETURN
.
H7CHKINP  PACK      KEY22,DH7CIMES,SP1,ONE   *pmsqviaf
          CALL      RAPMQVI1
          IF        OVRCD=0
            MOVE      "V",H7DATTYP
            GOTO      CHHLTY99
          ENDIF
          RETURN
.
H7CHKOUT  PACK      KEY20,DH7CIMES   *outqueaf
          CALL      RAOTQUE1
          IF        OVRCD=0
            MOVE      "OU",H7DATTYP
            GOTO      CHHLTY99
          ENDIF
          RETURN
.
H7CHKALL  PACK      KEY20,DH7CIMES   *allqueaf
          CALL      RAALQUE1
          IF        OVRCD=0
            MOVE      "A",H7DATTYP
            GOTO      CHHLTY99
          ENDIF
          RETURN
.
H7CHKEMR  PACK      KEY20,DH7CIMES   *emrqueaf
          CALL      RAEMQUE1
          IF        OVRCD=0
            MOVE      "E",H7DATTYP
            GOTO      CHHLTY99
          ENDIF
          RETURN
.
H7CHKORF  PACK      KEY20,DH7CIMES   *outrquaf
          CALL      RDOTRQU1
          IF        OVRCD=0
            MOVE      "RF",H7DATTYP
            GOTO      CHHLTY99
          ENDIF
          RETURN
.
H7CHKOPR  PACK      KEY20,DH7CIMES   *oprqueaf
          CALL      RAOPQUE1
          IF        OVRCD=0
            MOVE      "OP",H7DATTYP
            GOTO      CHHLTY99
          ENDIF
          RETURN
.
H7CHKMAS  PACK      KEY20,DH7CIMES   *outqmaaf
          CALL      RAOTQMA1
          IF        OVRCD=0
            MOVE      "OQ",H7DATTYP
            GOTO      CHHLTY99
          ENDIF
          RETURN
.
H7CHKHCP  PACK      KEY20,DH7CIMES
          CALL      RAPMQDR1
          IF        OVRCD=0
            MOVE      "H",H7DATTYP
            GOTO      CHHLTY99
          ENDIF
          RETURN
.
+
.-------------------------------------------------------------
. [HELPER-FUNCTION] Match HL7 Message Type with Queue Data
.-------------------------------------------------------------
CHHLTY00  MATCH     "A02",H7CIMETP   *INP & WAT
          IF        @EQUAL
            CALL      H7CHKINP
            CALL      H7CHKWAT
          ENDIF
.
          MATCH     "A03",H7CIMETP   *INP, OUT, ALL & EMR
          IF        @EQUAL
            CALL      H7CHKINP
            CALL      H7CHKOUT
            CALL      H7CHKALL
            CALL      H7CHKEMR
          ENDIF
.
          MATCH     "A04",H7CIMETP   *OUT, EMR, ORF
          IF        @EQUAL
            CALL      H7CHKOUT
            CALL      H7CHKEMR
            CALL      H7CHKORF
          ENDIF
.
          MATCH     "A05",H7CIMETP   *OUT, WAT
          IF        @EQUAL
            CALL      H7CHKOUT
            CALL      H7CHKORF
            CALL      H7CHKWAT
            CALL      H7CHKINP
          ENDIF
.
          MATCH     "A08",H7CIMETP   *INP, EMR, OUT, ALL, ORF, WAT
          IF        @EQUAL
            CALL      H7CHKEMR
            CALL      H7CHKOUT
            CALL      H7CHKALL
            CALL      H7CHKORF
            CALL      H7CHKINP
            CALL      H7CHKWAT
          ENDIF
.
          MATCH     "A11",H7CIMETP   *INP, OUT, EMR
          IF        @EQUAL
            CALL      H7CHKINP
            CALL      H7CHKOUT
            CALL      H7CHKEMR
          ENDIF
.
          MATCH     "A13",H7CIMETP   *INP, OUT, ALL, EMR
          IF        @EQUAL
            CALL      H7CHKINP
            CALL      H7CHKOUT
            CALL      H7CHKALL
            CALL      H7CHKEMR
          ENDIF
.
          MATCH     "A38",H7CIMETP   *OUT, WAT
          IF        @EQUAL
            CALL      H7CHKOUT
            CALL      H7CHKWAT
          ENDIF        
.
          MATCH     "A44",H7CIMETP   *ALL, WAT, INP, EMR, OUT
          IF        @EQUAL
            CALL      H7CHKALL
            CALL      H7CHKWAT
            CALL      H7CHKINP
            CALL      H7CHKEMR
            CALL      H7CHKOUT
          ENDIF
.
          MATCH     "S",H7CIMETP     *OPR
          IF        @EQUAL
            MOVE      "OP",H7DATTYP
            GOTO      CHHLTY98
          ENDIF
.
          MATCH     "I12",H7CIMETP   *ALL, WAT
          IF        !@EQUAL
            MATCH     "I13",H7CIMETP
            IF        !@EQUAL
              MATCH     "I14",H7CIMETP
              IF        !@EQUAL
                GOTO      CHHLTY10
              ENDIF
            ENDIF
          ENDIF
          CALL      H7CHKALL
          CALL      H7CHKWAT
.
CHHLTY10  MATCH     "A12",H7CIMETP
          IF        !@EQUAL
            MATCH     "A14",H7CIMETP
            IF        !@EQUAL
              MATCH     "A21",H7CIMETP
              IF        !@EQUAL
                MATCH     "A22",H7CIMETP
                IF        !@EQUAL
                  MATCH     "A27",H7CIMETP
                  IF        !@EQUAL
                    GOTO      CHHLTY20
                  ENDIF
                ENDIF
              ENDIF
            ENDIF  
          ENDIF
          MOVE      "V",H7DATTYP  *INP
          GOTO      CHHLTY98
.
CHHLTY20  MOVE      "INV",H7DATTYP   
.
CHHLTY98  RETURN
CHHLTY99  NORETURN
          RETURN
+
.-------------------------------------------------------------
. [FUNCTION] Match HL7 Messages to Call App. Icons
.-------------------------------------------------------------
HLMT0000  CLEAR     HL7POPUP
          CLEAR     HL7POPU2
          CLEAR     H7DATTYP
          MATCH     "A14",H7CIMETP
          IF        @EQUAL
            MATCH     "1",PTCNH7A5
            IF      @EQUAL
              MOVE      "A05",H7CIMETP
            ENDIF
          ENDIF
          MATCH     "A31",H7CIMETP
          IF        @EQUAL
            MATCH     SP2,PTCNA31X              
            IF        !@EQUAL
              PACK      H7CIMETP,ANSA,PTCNA31X
            ENDIF
          ENDIF
          CALL      CHHLTY00
          MOVE      COUNTER2,UNIQNUM
          SQUEEZE   UNIQNUM
          SQUEEZE   DH7CIMES
          APPEND    "<a href=javascript:AssessLink('",HL7POPU2
          APPEND    DH7CIMES,HL7POPU2
          APPEND    "','P')><img src='../images/AdmitIcon.gif'",HL7POPU2
          APPEND    " border=0 hspace=4></a>",HL7POPU2
          MATCH     "INV",H7DATTYP
          IF        !@EQUAL
            APPEND    "<a href=javascript:AssessLink('",HL7POPUP
            APPEND    DH7CIMES,HL7POPUP
            APPEND    "','",HL7POPUP
            APPEND    H7DATTYP,HL7POPUP
            APPEND    "')><img src='../images/AppointmentIcon.gif'",HL7POPUP
            APPEND    " border=0 hspace=4></a>",HL7POPUP
          ENDIF
.
HLMT9999  RETURN
+
.-------------------------------------------------------------
. [FUNCTION] Check CONTROLF conditions for Hosp Level
.-------------------------------------------------------------
HP7C0000  MATCH     "A14",H7CIMETP
          IF        @EQUAL
            MATCH     "1",PTCNH7A5
            IF      @EQUAL
              MOVE      "A05",H7CIMETP
            ENDIF
          ENDIF
          MATCH     "A31",H7CIMETP
          IF        @EQUAL
            MATCH     SP2,PTCNA31X
            IF        !@EQUAL
              PACK      H7CIMETP,ANSA,PTCNA31X
            ENDIF
          ENDIF
.
HP7C9999  RETURN
+
.-------------------------------------------------------------
. [FUNCTION] Create Popup for HL7 Message Info
.-------------------------------------------------------------
.
HLLI0000  CLEAR     HL7DATA1
          APPEND    "javascript:CheckStatus('",HL7DATA1
          APPEND    DH7CIMES,HL7DATA1
          APPEND    "','",HL7DATA1
          APPEND    H7CIMETP,HL7DATA1
          APPEND    "');",HL7DATA1
.
HLLI9999  RETURN
+
.------------------------------------------------------------
. [FUNCTION] Convert field to be YES or NO
.------------------------------------------------------------
COYN0000  ADD       ONE,VARTEMP1
          LOAD      VARTEMP2,VARTEMP1,NO,YES,NO
          WRITE     HTMLFILE;VARTEMP2;
          CLEAR     VARTEMP1
          CLEAR     VARTEMP2
.
COYN9999  RETURN
+
.-----------------------------------------------------------
. [FUNCTION] Load Category Code
.-----------------------------------------------------------
LOPM0000  MATCH     SP70,AC02
          IF        !@EQUAL
            PACK      KEY5,TC01,AC02
            CALL      RDCODE1
            WRITE     HTMLFILE;TDESC;
          ENDIF
          CLEAR     TC01
          CLEAR     AC02
.
LOPM9999  RETURN
+
.-----------------------------------------------------------
. [FUNCTION] Load Category Code - Long Description
.-----------------------------------------------------------
LOPML000  MATCH     SP70,AC02
          IF        !@EQUAL
            PACK      KEY5,TC01,AC02
            CALL      RDCODE1
            WRITE     HTMLFILE;PTCDLDES;
          ENDIF
          CLEAR     TC01
          CLEAR     AC02
.
LOPML999  RETURN
+
.-----------------------------------------------------------
. [FUNCTION] Load Hospital Code
.-----------------------------------------------------------
LOHP0000  PACK      KEY3,HP03
          CALL      RDPTHSP1
          WRITE     HTMLFILE;PTHSNAME;
          CLEAR     HP03      
.
LOHP9999  RETURN
+
.-----------------------------------------------------------
. [FUNCTION] Add Name to Username
.-----------------------------------------------------------
ADUS0000  MATCH     SP70,WBUSRNAM
          IF        !@EQUAL
            PACK      KEY10,WBUSRNAM
            CALL      RDWBSE1
            WRITE     HTMLFILE;WBUSRNAM," - ",WBSENAM;
          ENDIF
          CLEAR     WBUSRNAM
.
ADUS9999  RETURN
+
.-----------------------------------------------------------
. [FUNCTION] Add Name to Operator ID
.-----------------------------------------------------------
ADOI0000  MATCH     SP70,OPERATID
          IF        !@EQUAL
            PACK      KEY14,OPERATID,SP10
            CALL      RSWBSE3
            CALL      RKWBSE3
            WRITE     HTMLFILE;OPERATID," - ",WBSENAM;
          ENDIF
          CLEAR     OPERATID

ADOI9999  RETURN
+
.-----------------------------------------------------------
.
          INC       IBAWEBCD
          INC       WEBDATCD
          INC       PATNAMCD
.
          INC       PATDO1IO/INC   * Doctor File
          INC       PATMI1IO/INC
          INC       PATMA1IO/INC
          INC       PATVISIO/INC   * Patients Visits File
          INC       PMSVX1IO/INC   * Visit Extension File
          INC       PATALRIO/INC
          INC       OUTSITIO/INC
          INC       PATCOMIO/INC
          INC       PATPR1IO/INC
          INC       PMSPX2IO/INC
          INC       PATFN1IO/INC
          INC       PATWR1IO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       PATRE1IO/INC
          INC       PATDGWIO/INC
          INC       PATCMNIO/INC
          INC       PATITMIO/INC
          INC       PATDADIO/INC
          INC       PATVADIO/INC
          INC       PATCMCIO/INC
          INC       PATASFIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       APSMASIO/INC
          INC       PATIN1IO/INC
          INC       PATDSCIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATHSPIO/INC
          INC       PMSCCDIO/INC
          INC       HL7CISIO/INC
          INC       MLTSECIO/INC
          INC       PMSQDRIO/INC
          INC       OUTQMAIO/INC
.         INC       WEBSECIO/INC
          INC       PMSQVIIO/INC
          INC       PMSQPTIO/INC
          INC       EMRVISIO/INC
          INC       EMRQUEIO/INC
          INC       ALLQUEIO/INC
          INC       OUTQUEIO/INC
          INC       WATQUEIO/INC
          INC       OPRQUEIO/INC
          INC       OUTRQUIO/INC
          INC       OUTRF1IO/INC
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLPMSPX2
          INC       CLPATMIS
          INC       CLPMSQPX
.
          INC       PATMASTM
          INC       PATDOCTM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       PMSQPTTM
          INC       PMSQVITM
          INC       HL7CISTM
          INC       EMRQUETM
          INC       ALLQUETM
          INC       OUTQUETM
          INC       WATQUETM
          INC       OPRQUETM
          INC       PMSQDRTM
          INC       OUTQMATM
          INC       OUTRQUTM
          INC       PATDOCCD
          INC       CALCAGE
          INC       NAMSTRCD
          INC       DAYOFWEK

