.----------------------------------------------------------------------
. Program       : OUTWEB01
.
. Function      : Outpatients Server
.
. Modifications  :
.-------------------------------------------------------------------------------
. V12.00.02 11/11/2025  Zumin Yu       TSK 0969239
.           Modified CASTIT00 & FMTTIM00 to resolve the 12PM time display issue
. V12.00.01 13/05/2025  Ebon Clements  TSK 0955096
.           Added alpanumeric visit number generation - WOPNM000 - GENANVIS
. V11.05.02 20.12.2024 DA Sarkies      TSK 0954547
.           Commented out <cat> tags to prevent browser incompatibility
. V11.05.01 26/11/2024  Ebon Clements  TSK 0954547
.           Added <cat-c> start and end tag to category=XX tag
. V11.04.03 30/10/2024  Ebon Clements  TSK 0953008d
.           CASROW10 corrected syntax of parameter OTHEPCOD 
. V11.04.02 03/05/2024  PJ Le Febour   TSK 0906342d
.           CASROW10 corrected parameter OTMAPCOD to OTHEPCOD 
. V11.04.01 12/04/2024  PJ Le Febour   TSK 0906342a
.           CASROW10 added additional parameter OTMAPCOD 
. V11.03.05 16/08/2023  Nikitha B      TSK 0936375
.           Restored previous theatre diary functionality - at line CHKOUT20 
. V11.03.04 07.07.2023  Ebon Clements  TSK 0934634
.           Display doctors theatre sessions for all hospitals - 
.           Changed CHKALL00 to use undex 7 on oprsesaf instead of 1
. V11.03.03 05.07.2023  Ebon Clements  TSK 0934634
.           Added theatre session hospital id to sesskeys - CHKOPR00 CHKALL00
.           Restored previous theatre diary functionality to display sessions
.           for all OP sites for a doctor Use index 2 instead of 6 on outsesaf
.           CHKOUT00
. V11.03.02 04.07.2023  Nikitha B      TSK 0932738a
.           Modified to save Tier 2 code from Master- OTMATCOD at CASROW00
. V11.03.01 20.03.2023  DA Sarkies    TSK 0909393
.           Added hospital name as key to theatre booking
. V11.02.03 04/08/2022  Ebon Clements TSK 0920141
.           Read OP letter file by index 2 - LTRSEL00
. V11.02.02 05.05.2022  DA Sarkies       TSK 0905641
.           Reconfigured CHKOUT00 so that the diary displays not only the 
.           clinics the doctor is in charge of, but slots where dr is the
.           treating or the additional HCP
. V11.02.01 10/02/2022  Thanh T          TSK 0905641
.           Recompiled as OUTHEDFD/OUTMA1FD changes
. V11.01.01 08/12/2021  Ebon Clements  TSK 0912859
.           Added mosaiqrs cgi to allow supervisor reschedule to a MOSIAQ clinic
. V11.00.04 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.03 06/10/2020  Ebon Clements TSK 0890602
.           Don't allow bookings into MOSAIQ clinics - MOSAIQCL
. V11.00.02 20/03/2020  Peter Vela     TSK 0889143
.           Fixed OUTLET IO calls
. V11.00.01 18/03/2020  Peter Vela     TSK 0889143
.           Recompiled for OUTLETFD
. V10.15.01 23/10/2019  Ebon Clements    TSK 0308709
.           Added clinic type linked visit type functionality
.-------------------------------------------------------------------------------
. V10.14.01 12/08/2019  Ebon Clements  TSK 0879180
.           Added location filter to next and prev buttons - CSRH0100 CSRH0200
. V10.12.02 16/05/2018  Ania P         TSK 0845045
.           Added output of OTHELTYP
. V10.12.01 19/04/2018  Thanh Tieu     Task 0851975
.           Changed for triage status enhancement. Added codes to
.           output the triage status description TRGSDESC to show on various
.           templates.
.-------------------------------------------------------------------------------
. V10.11.05 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.04 24/10/2017 Ebon Clements   TSK 0841602
.           Added referral mandatory to CASROW00 
. V10.11.03 04/2017  Thanh T.       TSK 0821710
.           Removed GETEXT00/DCMNT000/WCMNT000 since it is not used
. V10.11.02 08/08/2017  Thanh T.       TSK 0821710
.           Revompiled OUTRFLTM.
. V10.11.01 30/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
.-------------------------------------------------------------------------------
. V10.10.01 20/03/2017  Ebon Clements  TSK 0815431
.           Added appoinment request comments tag from OUTRCMFD
. V10.09.01 27/01/2017  Ebon Clements  TSK 0828785
.           Recompiled for ALLREFTM - OP Site selection list security test
. V10.08.01 08/07/2016  Jill Parkinson    TSK 0822002
.           Recompiled for PATMASTM
. V10.07.04 17/12/2015  Ebon Clements  CAR 294154
.           Added SMS notification functionality
. V10.07.03 29/10/2015  Ebon Clements  CAR 268970
.           Change to use OUTCLIFD index 1 instead of index 2
. V10.07.02 28/10/2015  Ebon Clements  CAR 268970
.           Changed CHKOUT00 to use OUTCLIFD index 6          
. V10.07.01 23/10/2015  Ebon Clements  CAR 320819
.           Added Inactive test to letter selection lists
. V10.06.03 11/08/2915  Ania P         CAR 319861
.           Recompile for ALLREFTM
. V10.06.02 12/05/2015  Ebon Clements     CAR 303890
.           Added ALLPROFD and open
. V10.06.01 20/04/2015  Ebon Clements  CAR 315691
.           Recompiled for OUTRFLTM - Referral letter list clinic display
. V10.05.04 06/11/2014  Don Nguyen     CAR 304059
.           Recompiled for changes to OPRSESIO - added Default Team Completed
.           fields.
. V10.05.03 24/10/2014  Patrick Adair  CAR 302971
.           Do Not default Visit type field for NZ - VTYSEL00
. V10.05.01 06/10/2014  Ebon Clements  CAR 268970
.           Removed OUTCLIFD index 4 open as it was not used
. V10.05.01 16/07/2014  Ebon Clements  CAR 251384
.           Added tier 2 code functionality
. V10.04.02 07/04/2014  Peter Vela      CAR 286258
.           Recompiled for PATMASTM
. V10.04.01 31.03.2014  B.G.Ackland  CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
.-------------------------------------------------------------------------------
. V10.03.11 09.09.2013  B.G.Ackland     CAR 289483
.           JSON Appointment Search Results
. V10.03.10 04/10/2013  Patrick Adair   CAR 284134
.           Recompiled for new oprcliaf field
. V10.03.09 30/08/2013  Don Nguyen      CAR 273426
.           Recompiled for changes to CLALLREF
. V10.03.08 30/06/2013  Davin           CAR 283202
.           Recompiled for changes to hl7 messaging
. V10.03.07 20/05/2013  Don Nguyen      CAR 285199
.           Modified CASROW00 to use OUTCLIA1 for Outpatients Clinic Table read
. V10.03.06 19/03/2013  Jill Parkinson  CAR 282814
.           Recompiled for PATMASTM - Disability alert DSAL0000 change
. V10.03.05 19/02/2013  Ebon Clements   CAR 277862
.           Added mandatory referral functionality
. V10.03.04 21/11/2012  Peter Vela      CAR 276423
.           Recompiled for OUTARTTM
. V10.03.03 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.02 15/12/2011  Nicole Torrisi  CAR 253134
.           Mods to correct display of inactive sessions in diary
. V10.03.01 07/12/2011  Nicole Torrisi  CAR 253134
.           Mods to prevent display of inactive and non-current sessions in 
.           diary
. V10.02.08 11/10/2011  Mark Coupland   CAR 252429
.           Recompiled for PMSPX2TM and PATMASTM
. V10.02.07 13/09/2011 Jill Parkinson  CAR 248652
.           Recompiled for PMSPX2TM - Added read of pmsvx1af in GETCURIP
. V10.02.06 23.08.2011  Ebon Clements  CAR 249416
.           Added end of search results line to CLISRH00 and CTYSRH00
. V10.02.05 12/07/2011  Peter McMullen CAR 248483
.           Recompile for OUTARTTM                              
. V10.02.04 14/07/2011  Ebon Clements  CAR 242246
.           Added NMDS, care type, service delivery and clinic risk - CASROW00
. V10.02.03 20/05/2011  Ebon Clements  CAR 239554
.           Added generate letter date functionality
. V10.02.02 13/05/2011  Ebon Clements     CAR 240720
.           Added requested appointment file
. V10.02.01 21/03/2011  Jill Parkinson    CAR 239574
.           Increased printer variables
. V10.00.02 02/09/2010  Ebon Clements     CAR 229436
.           Increased length of REFLINK to 427
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.----------------------------------------------------------------------
. V9.12.02  10/12/2009  Peter McMullen    CAR 210130
.           convert to newer doctor name formatting routine DOCNM000          
. V9.12.01  15/09/2009  Davin S           CAR 206063
.           Added read of pmspx2af after reading patma1af (various spots)
.----------------------------------------------------------------------
. V9.11.04  13/03/2009  Ebon Clements    CAR 186197
.           Increased length of REFLINK to 400
. V9.11.03  27/02/2009  Steve Armstrong  CAR 177234
.           Added triggers for HL7 Messages (DGCLIRAD & DGCLIRUP)
. V9.11.02  27/11/2008  Jill Habasque  CAR 167148
.           Recompiled for OUTRFLTM                            
. V9.11.01  06/11/2008  Peter McMullen CAR 174725
.           convert internal javascript to W3C standards
.----------------------------------------------------------------------
. V9.09.01  29/06/2007  Ebon Clements  143552
.           Recompiled for OUTRFLTM - Referring gp on referral list display
.----------------------------------------------------------------------
. V9.08.02  15/05/2007  Ebon Clements  131843
.           Recompiled for OUTRFLTM - Referring gp and practice
. V9.08.01  25/01/2007  Peter Vela CAR 127930
.           Recompiled for MRTMASFD
.----------------------------------------------------------------------
. V9.07.01  31/08/2006  Ebon Clements CAR 111757
.           Added DEFTOVRD cgi and tag
.----------------------------------------------------------------------
. V9.06.01  17/05/2006  Ebon Clements CAR 105541
.           Added multi hospital test to VTYSEL00
.----------------------------------------------------------------------
. V9.05.02  30/03/2006  Ebon Clements CAR 79277
.           Added carer details
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B04 20/02/2006  Ebon Clements     CAR 76341
.           Added referral and encounter file audit
. V9.05.B03 14/02/2006  Ebon Clements CAR 71116
.           Recompiled for OUTRFLTM - Created and Updated by tags
. V9.05.B02 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.05.B01 11/01/2006  Peter Vela    CAR 89639
.           Recompiled for OUTRFLTM - Removed single quotes from OTRLDIAG
.----------------------------------------------------------------------
. V9.04.06  23/05/2005  Ebon Clements CAR 62018
.           Recompiled for OUTBITFD - Added provider usage
. V9.04.05  31/03/2005  Jill Habasque CAR 59996
.           Added otrfl041 - claim code
. V9.04.04  17/03/2005  Davin         CAR 56697
.           Added clinic indicator output in CASROW00
.           Added tables for allied health referral tags
. V9.04.03  14/01/2005  Davin         CAR 54253
.           Added PMI and Address labels to referral details (prtlab00)
. V9.04.02  11/01/2005  Ebon Clements CAR 56397
.           Added cancelled to referral letter filter status
. V9.04.01  07/01/2005  Ebon Clements CAR 54653
.           Added date filter to referral letter list
.----------------------------------------------------------------------
. V9.03.19  11/06/2004  Mike Laming   CAR 49016  July 2004 PRS/2      
.           - Add Sex Description routine SEXDSC00 with Code "R" - "Intersex"
. V9.03.18  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.17  22/04/2004 Peter Vela     CAR 48456
.           Recompiled for OUTRFLTM - Referral Letter List
. V9.03.16  14/04/2004 Sylvek Litewka CAR 48981
.           Increased length of the variable REFLINK. Recompiled for OUTRFLTM 
.           changes.
. V9.03.15  26/03/2004 Peter Vela     CAR 13038
.           Recompiled for PATDOCCD - Doctor Name format Parameter
. V9.03.14  12/02/2004 Ebon Clements  CAR 47409
.           Recompiled for OUTRFLTM - Inactive clinic types
.           12/02/2004 Sylvek Litewka CAR 47091
.           Added EOCRDIND - Episodes of Care Redirect Indicator. Used to set
.           redirect from Referral Letters to Episodes of Care.
. V9.03.13  11/02/2004 Sylvek Litewka CAR 47058
.           Recompiled for changes made to OUTRFLTM.PBL
. V9.03.12  09/02/2004 Sylvek Litewka CAR 47000
.           Added processing to display Referral Letters Print screen and to
.           schedule selected letters and labels for printing.
. V9.03.11  06/01/2004 Sylvek Litewka CAR 46257
.           Recompiled for OUTRF1IO - mods to write routines.
. V9.03.10  15/12/2003 Ebon Clements  CAR 45553
.           Recompiled for OUTRFLTM - display referral status of cancelled
. V9.03.09  15/12/2003 Ebon Clements  CAR 45478
.           Recompiled for OUTRFLTM - site specific clinic type and clinic.
. V9.03.08  11/12/2003 Ebon Clements  CAR 45549
.           Mods for OUTRF1FD - change from doctors file to hcp file
.           11/12/2003 Peter Vela     CAR 40355
.           Recompiled for PATNAMCD
. V9.03.07  30/09/2003 Ebon Clements  CAR 43674
.           Close files before opening in OPNOUT00
. V9.03.06  29/09/2003 Ebon Clements CAR 22361
.           Added reads of outhedaf to display the correct session setup details
. V9.03.05  10/09/2003 Sandra Barcham      43011
.           Remove file prefix for outpreaf
. V9.03.04  22/07/2003 Ebon Clements   CAR 40633
.           Mods to VTYSEL00 for over booking slot types
. V9.03.03  17/06/2003 Ebon Clements   SRF 37705
.           Added tag CSRH1200 for the clinic type code
.           17/06/2003 Sylvek Litewka  CAR 39213
.           Mods to procedure REFDET00 to store users security ID when updating
.           referral letters.
. V9.03.02  02/06/2003 Sylvek Litewka  CAR 39598
.           Fixed date validation in CHKSUS00.
.           02/06/2003 Sylvek Litewka  CAR 39213
.           Mods to WOTRL000 to write the Referral Type. Also added procedure
.           OTHREF00 in include OUTRFLTM.PBL to list referral letters of type
.           'Other'.
. V9.03.01  15/05/2003 Sylvek Litewka  CAR 39071
.           Recompiled for changes made to "outmspaf".
.----------------------------------------------------------------------
. V9.02.25  11/04/2003 Sylvek Litewka  CAR 38158
.           Recompiled for changes made to include OUTRFLTM.PBL (Modified
.           ORFL4300 and ORFL4400 to pack search filter with itself and SP70).
. V9.02.24  07/02/2003 Tonii CAR 35992
.           Recompiled for PATMISTM - inactive codes in patfundf
. V9.02.23  10/12/2002  Sylvek Litewka        SRF 22711
.           Added LSTUNBFL flag which indicates that only 'Unbooked' outpatient
.           referral letters are to be listed. Used by OUTRFLTM.PBL.
. V9.02.22  29/11/2002  Lina Vo               SRF 22709
.           Changed program to open outpatient files with site prefix. 
. V9.02.21  26/10/2002  Sylvek Litewka        SRF 22711
.           Added processing for Report number 5 - Search Referral Letters
.           and filter fields (FLTRSTAT, FLTRCTYP, FLTRCLID, FLTRPRIO and 
.           FLTRDCDE). Also added processing for fileds that hold the booking
.           details on "outrf1af". These fields are OTRLF036 to OTRFL040. 
. V9.02.20  09/10/2002  Peter Vela    SRF 17693
.           Recompiled for PATMISTM - Admitting Point
. V9.02.19  23/08/2002  Ebon Clements SRF 17673 
.           Mods to visit type selection list for unavailable slots VTYSEL00
. V9.02.18  28/05/2002  Mike Laming  SRF 15999  
.           Recompiled for OUTRF1IO.INC
. V9.02.17  02/04/2002 Dean Cramer      
.           Fixed CSRH0000 to pass SRCHDATE for Appointment Search
. V9.02.16  04/03/2002 Ebon Clements 
.           Fixed read of clinic file in CASROW00
. V9.02.15  10.02.2002 B.G.Ackland
.           Ignore Clinic Type on Find
. V9.02.15  10.02.2002 B.G.Ackland
.           Ignore Clinic Type on Find
. V9.02.14  07.02.2002 Ebon Clements 
.           Added clinic indicator description to CASTAB00 clinic search
. V9.02.13  07.02.2002 B.G.Ackland
.           New Tag for RCH Conversions
. V9.02.12  24.12.2001 B.G.Ackland
.           Enable Default Clinic ID
. V9.02.11  06/12/2001 Harvinder
.           CHKOUT00 - OCADESC added after OCTDESC
. V9.02.10  03/12/2001 Katie Nelson/Harvinder   SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.09  29.11.2001 B.G.Ackland
.           Fix Search/Suspension Check
. V9.02.08  18.11.2001 B.G.Ackland
.           Make Sure Sessions Only Display if Session Date
.           is between Master Open & Close Dates
.           Make Sure Sessions Only Display if Session Date
.           Not Suspended
.           Make Sure All Filters Processed in Search
. V9.02.07  13.11.2001 B.G.Ackland
.           Change Row Height on Search
. V9.02.06  23.10.2001 B.G.Ackland
.           Change Day Name to 3 Char
. V9.02.05  05.10.2001 Ashwin - HPS
.           Fixed clinic selection for appointment search
. V9.02.04  21.08.2001 Raghu - HPS
.           Modified for redirecting to new booking on add slot Changed to 
.           display correct Clinic Type; Changed to remove Invalid Clinic error
. V9.02.03  17.08.2001 Ashwin,Raghu- HPS
.           Fixed for Invalid Clinic error and Clinic Search
. V9.02.02  11.09.2001 Raghu -HPS
.           Added OBAVISIT argument for updateParent
. V9.02.01  08.09.2001 Sai,Kuldeep -HPS
.           Changed for Appointment search frame
. V9.01.02  16.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.001 13.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.B04 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B03 HPS
.           Modified for clinic search
. V9.00.B02 14.06.2001 B.G.Ackland
.           Recompile for Changes to PATMASTM
. V9.00.B01 05.06.2001 Dean Cramer    
.           New variables in OPRDEAFD                           
.           31.05.2001 Bronko Sosic   
.----------------------------------------------------------------------
.  V5.10.03 22.03.2001 B.G.Ackland
.           Bug Fixes THL
.  V5.09.02 15.01.2001  Bronko Sosic
.           Recompiled for PATMASTM          
.  V5.08.07 31.10.2000  B.G.Ackland
.           Remove Check for Inactive Clinics on Diary
.  V5.08.06 30.10.2000  B.G.Ackland
.           Check for Inactive Clinics
.  V5.08.05 05/09/2000  Tonii
.           Mods to accept Unknown and Indeterminate as valid patient sex desc.
.  V5.08.04  16/08/2000  Caleb Sharman
.           Changed Health Fund variables to be 8 chars
.  V5.08.03 07.06.2000  B.G.Ackland
.           Recompiled for PATMASTM          
.  V5.08.02 25.05.2000  Pat Dirito  
.           Recompiled for PATMASTM          
.  V5.08.01 22.05.2000  B.G.Ackland 
.           Fix up for Clinic Effective Date
.  V5.07.07 02/02/2000 Steven Watkins
.           Recompiled for PATMASTM / PATMISTM
.  V5.07.06 22.01.2000  B.G.Ackland 
.           Fix up to Standards, Update Referral, Add Referral
.  V5.07.05 05.01.2000  K.C.Nelson  
.           Recompiled for WEBDATCD Y2K date correction / PATMASTM changes   
.  V5.07.04 20.12.1999  K.C.Nelson  
.           Recompiled for IBAWEBCD/IBAWEBDF   
.  V5.07.03 03.11.1999  K.C.Nelson  
.           Recompiled for WEBDATCD/DAYOFWEK   
.  V5.07.02 09.10.1999  B.G.Ackland 
.           Add option for Clinic or Surgeon
.           13.10.1999  K.C.Nelson  
.           Changed current day cell color     
.  V5.07.01 21.09.1999  K.C.Nelson  
.           Change table cell bgcolor to class                 
.           12.07.1999  B.G.Ackland
.           Add Nowrap to Time Column on Diary Page
.
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF    
.
          INC       ALLCONFD/INC
          INC       APSMASFD/INC
          INC       IBALPCFD/INC
          INC       SCRMASFD/INC
          INC       MLTSECFD/INC
          INC       MLTSITFD/INC
          INC       OUTARTFD/INC        * Requested Appointments
          INC       OUTARTTD/INC
          INC       OUTBOAFD/INC        * Bookings file A
          INC       OUTBB1FD/INC        * Bookings file B
          INC       OUTCLIFD/INC        * Clinic Ids
          INC       OUTCONFD/INC        * Outpatient System Parameters
          INC       OUTCTYFD/INC        * Clinic Types
          INC       OUTDIAFD/INC        * Clinic Types
          INC       OUTMA1FD/INC        * Session Master file
          INC       OUTPREFD/INC        * Outpatient Pre-attendance file
          INC       OUTRCMFD/INC        * Appointment Request Comments
          INC       OUTSESFD/INC        * Clinic Open Sessions file
          INC       OUTSITFD/INC        * Site file
          INC       OUTRF1FD/INC        * Referral List
.
          INC       OPRCONFD/INC        * Clinic Open Sessions file
          INC       OPRCLIFD/INC        * Clinic Open Sessions file
          INC       OPRSESFD/INC        * Clinic Open Sessions file
          INC       OPROPRFD/INC        * Clinic Open Sessions file
          INC       OUTMSPFD/INC        * Session Master file
          INC       OUTLETFD/INC        * Outpatient Letter File
          INC       OUTLPCFD/INC        * Outpatients Print Scheduling
.
          INC       PATALRFD/INC
          INC       PATCALAG/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATCONFD/INC        * Controlf file
          INC       PATDO1FD/INC        * Doctors file
          INC       PATFN1FD/INC        * Health Fund file
          INC       PMSHCPFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCLFD/INC
          INC       PMSHCPTD/INC
          INC       PMSHCGTD/INC
          INC       PATIN1FD/INC        * Insurance file
          INC       PATMA1FD/INC        * PMI file
          INC       PATNIDFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PATHSPFD/INC
          INC       PATMI1FD/INC
          INC       PATPR1FD/INC        * Pre-attendance PMI file
          INC       PATVISFD/INC
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSVX1FD/INC
          INC       PATWR1FD/INC
          INC       RESLNKFD/INC
          INC       MRTMASFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       OUTHEDFD/INC        * Outpatient template header file
.
          INC       ALLREFFD/INC
          INC       ALLREFTD/INC
          INC       ALLRITFD/INC
          INC       ALLPROFD/INC
          INC       ALLPRRFD/INC
          INC       ALLDIAFD/INC
          INC       ALLCASFD/INC
          INC       ALLLNKFD/INC
          INC       ALLSTSFD/INC
.
          INC       PRIITMFD/INC
          INC       PRITHDFD/INC
          INC       VISCMTFD/INC
.
. Includes & Variables for 5.06
.
          INC       PATDHEAD/INC
.
.
BSTATUS   FORM      1
BSTATDSC  DIM       9
CLININDC  DIM       1
CLNIDESC  DIM       20
CHECKDAT  DIM       1
CURDATE   DIM       8
DEFTOVRD  DIM       1
ENDTIM    DIM       5
EOCRDIND  FORM      1        * Episodes of Care Redirect Indicator
FORM8     FORM      8
FROMDATE  DIM       8
NEXTPAGE  FORM      1
NMPNUMB   DIM       20
OLINKPRG  DIM       8
OLINKREP  DIM       2
OLINKTEM  DIM       3
OVERBOOK  FORM      1       Over bookings flag
PATLINK   DIM       127
PRIODESC  DIM       20
REFLINK   DIM       427
REFSTAT   DIM       10         * referral status
REFRLVIS  DIM       8          * A/H referral visit number
STATDESC  DIM       20
TLINKPRG  DIM       8
TLINKREP  DIM       2
TLINKTEM  DIM       3
TXTLEN    FORM      3   * Text Length for Episodes of Care Comments
UPDTTYPE  DIM       1
.
SESUSED   FORM      4
SESTOTAL  FORM      4
CODEST    INIT      "ST"
STRTIM    DIM       5
.
TAGMATCH  DIM       14
.
STRAMPM   DIM       2
SAVKEY44  DIM       44
ENDAMPM   DIM       2
ENDDAY    FORM      2
ENDMON    FORM      2
ENDYER    FORM      4
.
JAVSNAME  DIM       80
ENDNAME   DIM       80
STRTNAME  DIM       80
.
MINUSED   FORM      5
MINAVAI   FORM      5
MOSAIQCL  FORM      1          * MOSAIQ clinic
MOSAIQRS  FORM      1          * Allow supervisor reschedule to MOSAIC clinic
DIMHRS    DIM       2
DIMMIN    DIM       2
DIM20     DIM       20
DIM40     DIM       40
DIM60     DIM       60
FORMHRS   FORM      2
FORMMIN   FORM      2
.
DEPTCODE  DIM       3
DOCTCODE  DIM       6
CFILEPRE  DIM       3   * Current Open File Prefix for Outpatient Files
OUTPCLIN  DIM       12
CASEKEYS  DIM       28
SRCHPERD  DIM       3 
SRCHLTYP  DIM       3
SRCHTIME  DIM       10
SRCHFLAG  DIM       1 
SRCHREFN  DIM       8   * Search AH Referral number for mandatory referral test
SESSKEYS  DIM       25
CLINICID  DIM       6 
CLINICTY  DIM       6 
VISITTYP  DIM       3 
VIEWNAME  DIM       5
.
SESSDATE  DIM       10    Session Date
SESSFILL  FORM      3.1   Fill Percentage for Session
SESHEAD1  DIM       80
FILWIDTH  DIM       10
FILHIGHT  DIM       12
SRCHDATE  DIM       8 
FILHIGH   FORM      3 
.
LETNUMBR  DIM       3       * Letter number
LETPRNTR  DIM       6       * Letter printer
LETTNCOD  FORM      3
SCHDCOPY  FORM      3       * No of Copies
SCHDPRNT  DIM       6       * Printer
SETDFPRG  DIM       8
SETDFRPT  FORM      2
SAVREPTN  FORM      2
SAVPRGID  DIM       8
SUBSYSKY  DIM       50
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
LABELREF  INIT      "LABELREF"
LETTRREF  INIT      "LETTRREF"
LABELTYP  DIM       10      * Type of Label To Print Coded Field
STATNCOD  DIM       6       * Stationary Code Coded Field
LABPRT01  DIM       1       * Print Indicator - Referral Label
LABPRT02  DIM       1       * Print Indicator - Referral Mailing Label
LABPRT03  DIM       1       * Print Indicator - Address Label
LABPRT04  DIM       1       * Print Indicator - PMI Label
LABPNO01  DIM       3       * Number of Labels for Referral Label
LABPNO02  DIM       3       * Number of Labels for Referral Mailing Label
LABPNO03  DIM       3       * Number of Labels for Address Label
LABPNO04  DIM       3       * Number of Labels for PMI Label
LABPSL01  DIM       6       * Printer Selected - Referral Label
LABPSL02  DIM       6       * Printer Selected - Referral Mailing Label
LABPSL03  DIM       6       * Printer Selected - Address Label
LABPSL04  DIM       6       * Printer Selected - PMI Label
ADDLABEL  DIM       10      * cgi var for address label type
PMILABEL  DIM       10      * cgi var for pmi label type
.
OTRFL001  DIM       8              * Date of Letter
OTRFL002  DIM       10             * Referring Doctor
OTRFL003  DIM       6              * Outpatient Site
OTRFL004  DIM       6              * Clinic Id/Consultant
OTRFL005  DIM       3              * Department (Cat A)
OTRFL006  DIM       50             * Diagnosis       
OTRFL007  DIM       3              * Priority (Cat PR)
OTRFL008  DIM       3              * User Defined 1 (Cat L1)
OTRFL009  DIM       3              * User Defined 2 (Cal L2)
OTRFL010  DIM       3              * User Defined 3 (Cal L3)
OTRFL011  DIM       3              * User Defined 4 (Cal L4)
OTRFL012  DIM       1              * Not Used (for Consistency with EOCWEB01)
OTRFL013  DIM       10             * Referring GP   
OTRFL014  DIM       10             * GP Practice Code
OTRFL015  DIM       2              * GP Practice Count
OTRFL016  DIM       20             * Request Number
OTRFL017  DIM       8              * Request for App. Canc Date
OTRFL018  DIM       3              * Reason for request (Cat RQ)     
OTRFL019  DIM       3              * Specialty functions code (Cat OF)
OTRFL020  DIM       35             * Correspondence Address Line 1
OTRFL021  DIM       35             * Correspondence Address Line 2
OTRFL022  DIM       35             * Correspondence Address Line 3
OTRFL023  DIM       35             * Correspondence Address Line 4
OTRFL024  DIM       8              * Correspondence Post Code
OTRFL025  DIM       20             * ECR Approval Number
OTRFL026  DIM       20             * GPFH Approval Number
OTRFL027  DIM       6              * Clinic Type of Referral
OTRFL028  DIM       3              * Source of Referral (Cat S)
OTRFL029  DIM       10             * Responsible Health Care Prof
OTRFL030  DIM       8              * Date Referral Received 
OTRFL031  DIM       8              * Date of Priority
OTRFL032  DIM       3              * Expected Purchaser (Cat HP)
OTRFL033  DIM       6              * Patient Rank   
OTRFL034  DIM       1              * Referral Type 0=Outpat, 1=Other
OTRFL035  DIM       4              * Operator who recorded O/P Referral
OTRFL036  DIM       6              * Booked Site
OTRFL037  DIM       6              * Booked Clinic
OTRFL038  DIM       8              * Booked Date 
OTRFL039  DIM       5              * Booked Start Time
OTRFL040  DIM       3              * Booked Slot Number
OTRFL041  DIM       3              * Claim Code (Category CL)
OTRFL042  DIM       3              * Triage Status Code (Category ts)
.
FLTRSTAT  DIM       1              * Filter for Ref. Status (Booked/Unbooked)
FLTRCTYP  DIM       6              * Filter for Clinic Type
FLTRCLID  DIM       6              * Filter for Clinic Id
FLTRPRIO  DIM       3              * Filter for Priority
FLTRTRGS  DIM       3              * Filter Triage status
FLTRDCDE  DIM       6              * Filter for Doctor
FLTRRFGP  DIM       10             * Filter for referring gp
.
LSTUNBFL  FORM      1              * Flag to list unbooked letters only
.
SITECODE  DIM       6              
CLNCTYPE  DIM       6
CLNCID    DIM       6
.
SAVECLIN  DIM       6
.
VISTFLAG  FORM      1
JSONFLAG  FORM      1
TRGSDESC  DIM       20             
.
.-------------------------------------------------------------------------------
PRGID     INIT      "OUTWEB01"
VERSION   INIT      "V12.01.00"
PRGNAM    INIT      "Outpatient Diary, Search, Referral Update"
.-------------------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID & Set Para
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          CALL      CHKFIL00       * Check Correct Files Are Open & Valid Site
          BRANCH    EXIT,MAIN1000
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500
.
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      SESLST00   * Diary View of Sessions
          GOTO      MAIN1000
.
MAIN1200  CALL      CASSRH00   * Search for a Booking
          GOTO      MAIN1000
.
MAIN1300  CALL      REFLST00   * List Referrals for a Clinic ID
          GOTO      MAIN1000
.
MAIN1400  CALL      REFDET00   * Referral Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN1500  CALL      FLTLST00   * List Referrals based on search filters
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  OPEN      PATCODE1,"patcodes" 
          OPEN      PATCODE2,"patcodes" 
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PMSHCPA1,"pmshcpaf" 
          OPEN      OPRCLIA1,"oprcliaf"
          OPEN      OUTSITA2,"outsitaf"      * Open pre-attendance file
          OPEN      OPRSESA1,"oprsesaf"
          OPEN      OPRSESA2,"oprsesaf"
          OPEN      OPRSESA7,"oprsesaf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      SCRMASA1,"scrmasaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      MLTSITA1,"mltsitaf"
          OPEN      CONTROLF,"controlf"  * Open the control file
          OPEN      IBAPRTA1,"ibaprtaf"        * For Printer Selection
          OPEN      IBACODE1,"ibacodef"        * For Printer Selection
          OPEN      IHAPASS1,"ihapassf"        * For Printer Selection
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      PATPR1A1,"patpr1af" 
          OPEN      ALLREFA1,"allrefaf"
          OPEN      ALLREFA2,"allrefaf"
          OPEN      ALLPROA1,"allproaf"
          OPEN      ALLPROA2,"allproaf"
          OPEN      ALLPRRA1,"allprraf"
          OPEN      ALLDIAA1,"alldiaaf"
          OPEN      ALLCASA1,"allcasaf"
          OPEN      ALLLNKA1,"alllnkaf"
          OPEN      ALLLNKA2,"alllnkaf"
          OPEN      ALLRITA1,"allritaf"
          OPEN      ALLSTSA1,"allstsaf"
          OPEN      PATHSPA1,"pathspaf"
.
          OPEN      PMSCCDA1,"pmsccdaf"
          OPEN      PMSHCGA1,"pmshcgaf"
          OPEN      PMSHCLA1,"pmshclaf"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          OPEN      PRIITEM1,"priitemf"
          OPEN      PRITHDA1,"prithdaf"
          OPEN      VISCMTA1,"viscmtaf"
.
.         Open Outpatient Files with no site prefix
.
          OPEN      OUTLPCA1,"outlpcaf"        * Outpatient Print Scheduling
          OPEN      OUTLETR1,"outletrf"        * Outpatient Letter File
          OPEN      OUTLETR2,"outletrf"        * Outpatient Letter File
          OPEN      OUTARTA1,"outartaf" 
          OPEN      OUTRCMA1,"outrcmaf"
.
          CALL      INTMAS00
.
          READ      CONTROLF,FORTY;*111,OPCNCLSU,OPCNCODE,OPCNRUSI
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND21;*125,ALCNDTRG
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          MOVE      "OUT   ",KEY6            * Key for the site file
          CALL      RDSITA1             * Read the site record
          IF        OVRCD=1
            MOVE      "      ",KEY6            * Key for the site file
            CALL      RDSSITA1             * Read the site record
            CALL      RDKSITA1             * Read the site record
            BRANCH    OVRCD,INIT9000       * Invalid site
          ENDIF
          MOVE      OSTFILE,CFILEPRE     * Save Current File Prefix
.
          MOVE      "out",CFILEPRE
          CALL      OPNOUT00             * Open Outpatient Files
          GOTO      INIT9999             * Open Outpatient Files
.
INIT9000  DISPLAY   *R,"NO SITES EXIST IN OUTSITAF"
          DISPLAY   *R,"SERVER SHUTDOWN"
          STOP
.
INIT9999  RETURN
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      ONE,EXIT
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60
.          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50
.
          CALL      WINCLS00
          GOTO      NXTPAG99
.
NXTPAG10  CALL      LOCDIR00
          GOTO      NXTPAG99
.
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99
.
NXTPAG30  CALL      GOBACK00      * Go Back 2 html pages 
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
.NXTPAG50  MOVE      SP70,UPDTTYPE
.          MOVE      OTRLOUTN,ADMISSNO
.          MOVE      OTRLURNO,URNUMBER
.          MOVE      ZERO,EXIT
.          GOTO      NXTPAG99
.
NXTPAG50  CALL      RDIRNA00      * Redirect - no alert
          GOTO      NXTPAG99
.
NXTPAG60  CALL      WINPAR00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.------------------------------------------------------------------------------
.  Redirect URL
.------------------------------------------------------------------------------
LOCDIR00  CALL      OPENHTML
          BRANCH    EXIT,LOCDIR90
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      LOCDIR99
LOCDIR90  DISPLAY   "*** Fifo Not Found ***"
LOCDIR99  RETURN
.------------------------------------------------------------------------------
.  Redirect URL - No Alert
.------------------------------------------------------------------------------
RDIRNA00  CALL      OPENHTML
          BRANCH    EXIT,RDIRNA90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      RDIRNA99
.
RDIRNA90  DISPLAY   "*** Fifo Not Found ***"
.
RDIRNA99  RETURN
.
.------------------------------------------------------------------------------
.                Close Window or Frame and Goto New Location
.------------------------------------------------------------------------------
WINPAR00  CALL      OPENHTML
          BRANCH    EXIT,WINPAR99
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#"> {":
                             " if (self.name==#"PopUpFrame#") {":
                             "  redirectParentFrame(#"",REDIRECT,"#"); }":
                             " else { ":
                             "  opener.location.href=#"",REDIRECT,"#";":
                             "  self.close(); }":
                             "}":
                             "</script>"
          CALL      CLOSHTML
WINPAR99  RETURN
.-------------------------------------------------------------------------------
.  Goes back x page(s)
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          MOVE      NEXTPAGE,F1
          SUB       ONE,F1
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    history.go(-",F1,");":
                             "    reload();":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.------------------------------------------------------------
. Process Field from Template Body
.------------------------------------------------------------
PROFLD00  BRANCH    REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50
          GOTO      PROFLD99
.
PROFLD10  BRANCH    FLDSETNO,PROFLD11,PROFLD12
          GOTO      PROFLD99
.
PROFLD11  CALL      SESL0000     * Session List
          GOTO      PROFLD99
.
PROFLD12  CALL      DOCF0000
          GOTO      PROFLD99
.
PROFLD20  BRANCH    FLDSETNO,PROFLD21
          GOTO      PROFLD99
.
PROFLD21  CALL      CSRH0000
          GOTO      PROFLD99
.
PROFLD30  BRANCH    FLDSETNO,PROFLD31
          GOTO      PROFLD99
.
PROFLD31  CALL      REFL0000    
          GOTO      PROFLD99
.
PROFLD40  BRANCH    FLDSETNO,PROFLD41,PROFLD42,PROFLD43
          GOTO      PROFLD99
.
PROFLD41  CALL      MASF0000    
          GOTO      PROFLD99
.
PROFLD42  CALL      ORFL0000    
          GOTO      PROFLD99
.
PROFLD43  CALL      PRDT0000           * Printing Details
          GOTO      PROFLD99
.
PROFLD50  BRANCH    FLDSETNO,PROFLD51,PROFLD52
          GOTO      PROFLD99
.
PROFLD51  CALL      MASF0000
          GOTO      PROFLD99
.
PROFLD52  CALL      ORFL0000
          GOTO      PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
. Check that Correct Files are Open
.------------------------------------------------------------
CHKFIL00  MATCH     SP70,OUTPCLIN        * Parameter Passed in URL ?
          IF        !@EQUAL
            UNPACK    OUTPCLIN,WBSESIT,WBSECLI  
          ENDIF
          MOVE      WBSESIT,KEY6
          CALL      RDSITA1              * Read the site record 
          BRANCH    OVRCD,CHKFIL90
          MATCH     OSTFILE,CFILEPRE         * Save Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE
            CALL      OPNOUT00
          ENDIF
          MOVE      ZERO,EXIT
          GOTO      CHKFIL99
           
CHKFIL90  MOVE      "INVALID SITE SPECIFIED",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
.
CHKFIL99  RETURN
.------------------------------------------------------------
. Open Outpateint Files
.------------------------------------------------------------
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA1  * Get the name of the BOKA1 file
          CLOSE     OUTBOKA1
          OPEN      OUTBOKA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA2  * Get the name of the BOKA2 file
          CLOSE     OUTBOKA2
          OPEN      OUTBOKA2,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA3  * Get the name of the BOKA3 file
          CLOSE     OUTBOKA3
          OPEN      OUTBOKA3,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILBOKA4  * Get the name of the BOKA4 file
          CLOSE     OUTBOKA4
          OPEN      OUTBOKA4,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILSESA1  * Get the name of the SESA2 file
          CLOSE     OUTSESA1
          OPEN      OUTSESA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILSESA2  * Get the name of the SESA2 file
          CLOSE     OUTSESA2
          OPEN      OUTSESA2,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILSESA6  * Get the name of the SESA2 file
          CLOSE     OUTSESA6
          OPEN      OUTSESA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCLIA1  * Get the name of the CLIA1 file
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILCLIA6  * Get the name of the CLIA6 file
          CLOSE     OUTCLIA6
          OPEN      OUTCLIA6,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILCTYA1  * Get the name of the CTYA1 file
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME           * Open the file
          PACK      CFNAME,CFILEPRE,FILCTYA2  * Get the name of the CTYA2 file
          CLOSE     OUTCTYA2
          OPEN      OUTCTYA2,CFNAME           * Open the file
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          CALL      OPOTMA11                * Open the file
.
          PACK      CFNAME,CFILEPRE,FILBOKA1
          CLOSE     OUTBB1A1
          CALL      OPOTBB11               * Open the file
.
          OPEN      OUTPREA1,"outpreaf"      * Open pre-attendance file
.
          PACK      CFNAME,CFILEPRE,FILMSPA1  * Get the name of the MSPA1 file
          CLOSE     OUTMSPA1
          OPEN      OUTMSPA1,CFNAME      
.
          PACK      CFNAME,CFILEPRE,FILHEDA1  * Get the name of the HEDA1 file
          CLOSE     OUTHEDA1
          OPEN      OUTHEDA1,CFNAME      
.
          OPEN      OUTRF1A1,"outrf1af"
          OPEN      OUTRF1A2,"outrf1af"
          OPEN      OUTRF1A5,"outrf1af"
          OPEN      OUTRF1A7,"outrf1af"
.
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          MOVE      ZERO,NEXTPAGE
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      "000",TEMPLATE
          MOVE      SP70,UPDTTYPE
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,DEFTOVRD
          MOVE      SP70,DOCTCODE
          MOVE      SP70,OUTPCLIN
          MOVE      SP70,OTRLPRIO
          MOVE      SP70,SESSKEYS
          MOVE      SP70,CASEKEYS
          MOVE      SP70,SRCHPERD
          MOVE      SP70,SRCHLTYP
          MOVE      SP70,SRCHTIME
          MOVE      SP70,SRCHFLAG
          MOVE      SP70,SRCHREFN
          MOVE      SP70,CLINICID
          MOVE      SP70,CLINICTY
          MOVE      SP70,VISITTYP
          MOVE      SP70,FRSTDATE
          MOVE      SP70,LASTDATE
          MOVE      SP70,VYEARMTH
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,SRCHDATE
          MOVE      ZERO,NORECORD 
          MOVE      ZERO,STARTNUM
.
          MOVE      Z70,LETNUMBR
          MOVE      Z70,LETPRNTR
          MOVE      Z70,LABPRT01
          MOVE      Z70,LABPRT02
          MOVE      Z70,LABPRT03
          MOVE      Z70,LABPRT04
          MOVE      Z70,LABPNO01
          MOVE      Z70,LABPNO02
          MOVE      Z70,LABPNO03
          MOVE      Z70,LABPNO04
          MOVE      Z70,LABPSL01
          MOVE      Z70,LABPSL02
          MOVE      Z70,LABPSL03
          MOVE      Z70,LABPSL04
          MOVE      Z70,ADDLABEL
          MOVE      Z70,PMILABEL
.
          MOVE      Z70,OTRFL001
          MOVE      Z70,OTRFL002 
          MOVE      Z70,OTRFL003  
          MOVE      Z70,OTRFL004  
          MOVE      Z70,OTRFL005 
          MOVE      Z70,OTRFL006
          MOVE      Z70,OTRFL007
          MOVE      Z70,OTRFL008
          MOVE      Z70,OTRFL009
          MOVE      Z70,OTRFL010
          MOVE      Z70,OTRFL011
          MOVE      Z70,OTRFL012
          MOVE      Z70,OTRFL013
          MOVE      Z70,OTRFL014
          MOVE      Z70,OTRFL015
          MOVE      Z70,OTRFL016
          MOVE      Z70,OTRFL017
          MOVE      Z70,OTRFL018
          MOVE      Z70,OTRFL019
          MOVE      Z70,OTRFL020
          MOVE      Z70,OTRFL021
          MOVE      Z70,OTRFL022
          MOVE      Z70,OTRFL023
          MOVE      Z70,OTRFL024
          MOVE      Z70,OTRFL025
          MOVE      Z70,OTRFL026
          MOVE      Z70,OTRFL027
          MOVE      Z70,OTRFL028
          MOVE      Z70,OTRFL029
          MOVE      Z70,OTRFL030
          MOVE      Z70,OTRFL031
          MOVE      Z70,OTRFL032
          MOVE      Z70,OTRFL033
          MOVE      Z70,OTRFL034  
          MOVE      Z70,OTRFL035  
          MOVE      Z70,OTRFL036  
          MOVE      Z70,OTRFL037  
          MOVE      Z70,OTRFL038  
          MOVE      Z70,OTRFL039  
          MOVE      Z70,OTRFL040  
          MOVE      Z70,OTRFL041
          MOVE      Z70,OTRFL042
.
          MOVE      SP70,FLTRSTAT
          MOVE      SP70,FLTRCTYP
          MOVE      SP70,FLTRCLID
          MOVE      SP70,FLTRPRIO
          MOVE      SP70,FLTRTRGS
          MOVE      SP70,FLTRDCDE
          MOVE      SP70,FLTRRFGP
.
          MOVE      ZERO,LSTUNBFL
          MOVE      ZERO,EOCRDIND
          MOVE      ZERO,MOSAIQRS
          CALL      CPOTAR00
.
          RETURN
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "otrfl",QRYNAME
          IF        @EQUAL
            CALL      SPRFL000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updttype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchperd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHPERD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchtime=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHTIME
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SRCHFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchrefn=",QRYNAME
          IF        @EQUAL
            PACK      SRCHREFN,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "casekeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CASEKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clinicid=",QRYNAME
          IF        @EQUAL
            PACK      CLINICID,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clinicty=",QRYNAME
          IF        @EQUAL
            PACK      CLINICTY,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "visittyp=",QRYNAME
          IF        @EQUAL
            PACK      VISITTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "sesskeys=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SESSKEYS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outpclin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OUTPCLIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otrlprio=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OTRLPRIO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLTRSTAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrctyp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLTRCTYP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrclid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLTRCLID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrprio=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLTRPRIO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrtrgs=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLTRTRGS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrdcde=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLTRDCDE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fltrrfgp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FLTRRFGP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lstunbfl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LSTUNBFL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchdate=",QRYNAME
          IF        @EQUAL
            PACK      QRYDATA,QRYDATA,SP30
            UNPACK    QRYDATA,KEY8,KEY3 * Check for formatted or unformatted
            MATCH     SP70,KEY3
            IF        @EQUAL
                MOVE      QRYDATA,SRCHDATE * Do not change format = (CCYYMMDD)
            ELSE
               MOVE      QRYDATA,KEY11  * Change Date as format is (DD MON CCYY)
               PACK      KEY11,KEY11,SP70
               MATCH     SP70,KEY11
               IF        !@EQUAL
                UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
                CALL      SETMTH00
                PACK      SRCHDATE,CCENT,CYEAR,CMON,CDAY
                REP       " 0",SRCHDATE
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     "letnumbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LETNUMBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "letprntr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LETPRNTR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labprt01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPRT01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labprt02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPRT02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labprt03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPRT03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labprt04=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPRT04
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labpno01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPNO01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labpno02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPNO02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labpno03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPNO03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labpno04=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPNO04
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labpsl01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPSL01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labpsl02=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPSL02
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labpsl03=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPSL03
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "labpsl04=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LABPSL04
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "eocrdind=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EOCRDIND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "addlabel=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADDLABEL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmilabel=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMILABEL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftovrd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTOVRD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "otart",QRYNAME
          IF        @EQUAL
            CALL      SPOTAR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "srchltyp=",QRYNAME
          IF        @EQUAL
            PACK      SRCHLTYP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mosaiqrs=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MOSAIQRS
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
.------------------------------------------------------------
. Set Parameters for Option 1: Episode of Care Display   
.------------------------------------------------------------
SPRFL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPRFL001,SPRFL002,SPRFL003,SPRFL004,SPRFL005,SPRFL006:
                       SPRFL007,SPRFL008,SPRFL009,SPRFL010,SPRFL011,SPRFL012:
                       SPRFL013,SPRFL014,SPRFL015,SPRFL016,SPRFL017,SPRFL018:
                       SPRFL019,SPRFL020,SPRFL021,SPRFL022,SPRFL023,SPRFL024:
                       SPRFL025,SPRFL026,SPRFL027,SPRFL028,SPRFL029,SPRFL030:
                       SPRFL031,SPRFL032,SPRFL033,SPRFL034,SPRFL035,SPRFL036:
                       SPRFL037,SPRFL038,SPRFL039,SPRFL040,SPRFL041,SPRFL042
.
          GOTO      SPRFL999   
.
SPRFL001  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL001,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OTRFL001
          ENDIF 
          GOTO      SPRFL999   
.
SPRFL002  MOVE      QRYDATA,OTRFL002
          GOTO      SPRFL999   
.
SPRFL003  MOVE      QRYDATA,OTRFL003
          GOTO      SPRFL999   
.
SPRFL004  MOVE      QRYDATA,OTRFL004
          GOTO      SPRFL999   
.
SPRFL005  MOVE      QRYDATA,OTRFL005
          GOTO      SPRFL999   
.
SPRFL006  MOVE      QRYDATA,OTRFL006
          GOTO      SPRFL999   
.
SPRFL007  MOVE      QRYDATA,OTRFL007
          GOTO      SPRFL999   
.
SPRFL008  MOVE      QRYDATA,OTRFL008
          GOTO      SPRFL999   
.
SPRFL009  MOVE      QRYDATA,OTRFL009
          GOTO      SPRFL999   
.
SPRFL010  MOVE      QRYDATA,OTRFL010
          GOTO      SPRFL999   
.
SPRFL011  MOVE      QRYDATA,OTRFL011
          GOTO      SPRFL999   
.
SPRFL012  MOVE      QRYDATA,OTRFL012
          GOTO      SPRFL999   
.
SPRFL013  MOVE      QRYDATA,OTRFL013
          GOTO      SPRFL999   
.
SPRFL014  MOVE      QRYDATA,OTRFL014
          GOTO      SPRFL999   
.
SPRFL015  MOVE      QRYDATA,OTRFL015
          GOTO      SPRFL999   
.
SPRFL016  MOVE      QRYDATA,OTRFL016
          GOTO      SPRFL999   
.
SPRFL017  UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
          CALL      SETMTH00
          PACK      OTRFL017,CCENT,CYEAR,CMON,CDAY
          GOTO      SPRFL999   
.
SPRFL018  MOVE      QRYDATA,OTRFL018
          GOTO      SPRFL999   
.
SPRFL019  MOVE      QRYDATA,OTRFL019
          GOTO      SPRFL999   
.
SPRFL020  MOVE      QRYDATA,OTRFL020
          GOTO      SPRFL999   
.
SPRFL021  MOVE      QRYDATA,OTRFL021
          GOTO      SPRFL999   
.
SPRFL022  MOVE      QRYDATA,OTRFL022
          GOTO      SPRFL999   
.
SPRFL023  MOVE      QRYDATA,OTRFL023
          GOTO      SPRFL999   
.
SPRFL024  MOVE      QRYDATA,OTRFL024
          GOTO      SPRFL999   
.
SPRFL025  MOVE      QRYDATA,OTRFL025
          GOTO      SPRFL999   
.
SPRFL026  MOVE      QRYDATA,OTRFL026
          GOTO      SPRFL999   
.
SPRFL027  MOVE      QRYDATA,OTRFL027
          GOTO      SPRFL999   
.
SPRFL028  MOVE      QRYDATA,OTRFL028
          GOTO      SPRFL999   
.
SPRFL029  MOVE      QRYDATA,OTRFL029
          GOTO      SPRFL999   
.
SPRFL030  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL030,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OTRFL030
          ENDIF 
          GOTO      SPRFL999   
.
SPRFL031  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL031,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OTRFL031
          ENDIF 
          GOTO      SPRFL999   
.
SPRFL032  MOVE      QRYDATA,OTRFL032
          GOTO      SPRFL999   
.
SPRFL033  MOVE      QRYDATA,OTRFL033
          GOTO      SPRFL999   
.
SPRFL034  MOVE      QRYDATA,OTRFL034
          GOTO      SPRFL999   
.
SPRFL035  MOVE      QRYDATA,OTRFL035
          GOTO      SPRFL999   
.
SPRFL036  MOVE      QRYDATA,OTRFL036
          GOTO      SPRFL999   
.
SPRFL037  MOVE      QRYDATA,OTRFL037
          GOTO      SPRFL999   
.
SPRFL038  MOVE      QRYDATA,KEY11   * Change Date as format is (DD MON CCYY)
          PACK      KEY11,KEY11,SP70
          MATCH     SP70,KEY11
          IF        !@EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            PACK      OTRFL038,CCENT,CYEAR,CMON,CDAY
            REP       " 0",OTRFL038
          ENDIF
          GOTO      SPRFL999   
.
SPRFL039  MOVE      QRYDATA,OTRFL039
          GOTO      SPRFL999   
.
SPRFL040  MOVE      QRYDATA,OTRFL040
          GOTO      SPRFL999   
.
SPRFL041  MOVE      QRYDATA,OTRFL041
          GOTO      SPRFL999   
.
SPRFL042  MOVE      QRYDATA,OTRFL042
          GOTO      SPRFL999   
.
SPRFL999  RETURN
.------------------------------------------------------------
. Session List 
.------------------------------------------------------------
SESLST00  MATCH     SP70,WBSESIT
          GOTO      SESLST95 IF EQUAL
.
          MOVE      WBSESIT,KEY6
          CALL      RDSITA1          * Read Site Record
          BRANCH    OVRCD,SESLST95
.
          MOVE      WBSEDOC,KEY6
          CALL      RDDOCT1
          BRANCH    OVRCD,SESLST95
.
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          CALL      DOCNM000
          CALL      CURPER00   * Calculate Next and Last Period Dates
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          STRIP     MTHNAM
          CLEAR     WEBTITLE
          APPEND    MTHNAM,WEBTITLE
          APPEND    " Clinic Timetable",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,SESLST99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          GOTO      SESLST99
.
SESLST95  MOVE      "INVALID SITE/CLINIC",WEBTITLE
          CALL      WEBERR00
.
SESLST99  RETURN
.------------------------------------------------------------
. Session List Options
.------------------------------------------------------------
SESL0000  BRANCH    FLDITMNO,SESL0100,SESL0200,SESL0300,SESL0400,SESL0500:
                             SESL0600,SESL0700,SESL0800,SESL0900,SESL1000:
                             SESL1100
          GOTO      SESL9999
.
SESL0100  CALL      NEXT0000
          GOTO      SESL9999
.
SESL0200  CALL      PREV0000
          GOTO      SESL9999
.
SESL0300  CALL      CURSTD00
          GOTO      SESL9999
.
SESL0400  CALL      CUREND00
          GOTO      SESL9999
.
SESL0500  CALL      CURYR000
          GOTO      SESL9999
.
SESL0600  CALL      CURMON00
          GOTO      SESL9999
.
SESL0700  CALL      SELV0000
          GOTO      SESL9999
.
SESL0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      SESL9999
.
SESL0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      SESL9999
.
SESL1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      SESL9999
.
SESL1100  CALL      SESTAB00
          GOTO      SESL9999
.
.
SESL9999  RETURN
.------------------------------------------------------------
. Output Session Table
.------------------------------------------------------------
SESTAB00  UNPACK    DIM127,D1,TLINKPRG,DIM127 
          UNPACK    DIM127,D1,TLINKREP,DIM127
          UNPACK    DIM127,D1,TLINKTEM,DIM127
          UNPACK    DIM127,D1,OLINKPRG,DIM127 
          UNPACK    DIM127,D1,OLINKREP,DIM127
          UNPACK    DIM127,D1,OLINKTEM,DIM127
          UNPACK    LASTDATE,KEY4,CMON,CDAY
          MOVE      CDAY,ENDDAY
          MOVE      CMON,ENDMON
          MOVE      KEY4,ENDYER
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          CALL      MTHEND00
          MOVE      CDAY,CURDAY
          MOVE      FRSTDATE,CURDATE
.
SESTAB10  LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CURDAY,KEY2
          REP       " 0",KEY2
          MATCH     CURDATE,TODAYDAT
          IF        @EQUAL
            WRITE     HTMLFILE;"<tr><td bgcolor=#00FFFF width=90 nowrap>":
                               "<b>",KEY2,"</b>",SP1,DAYNAM3,"</td>" 
            GOTO      SESTAB15
          ENDIF
          IF        WEEKDAY=6|WEEKDAY=7
            WRITE     HTMLFILE;"<tr><td bgcolor=##CCCCCC width=90 nowrap>":
                               "<b>",KEY2,"</b>",SP1,DAYNAM3,"</td>" 
            GOTO      SESTAB15
          ENDIF
          WRITE     HTMLFILE;"<tr><td width=90 nowrap>":
                             "<b>",KEY2,"</b>",SP1,DAYNAM3,"</td>" 
.
SESTAB15  MOVE      ZERO,FRSTFLAG
.
          CALL      CHKOUT00     * Get Outpatient Sessions
.
          CALL      CHKALL00     * Get Theatre Sessions by Clinic Doctor
.
SESTAB30  IF        FRSTFLAG=0
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td></tr>"
          ENDIF
          ADD       ONE,WEEKDAY
          IF        WEEKDAY=8
            MOVE      ONE,WEEKDAY
          ENDIF
          ADD       ONE,CURDAY
          UNPACK    CURDATE,KEY4,CMON,CDAY
          MOVE      CMON,CURMON
          MOVE      KEY4,CURYER
          IF        CURDAY>MTHENDDY
            MOVE      ONE,CURDAY
            ADD       ONE,CURMON
            IF        CURMON>12
              MOVE      ONE,CURMON
              ADD       ONE,CURYER
            ENDIF
          ENDIF
          PACK      CURDATE,CURYER,CURMON,CURDAY
          REP       " 0",CURDATE
.
          MATCH     CURDATE,LASTDATE
          GOTO      SESTAB90 IF LESS
          GOTO      SESTAB10
.
SESTAB90  
SESTAB99  RETURN
.------------------------------------------------------------
. Get Session Details for SESSKEYS
.------------------------------------------------------------
SESDET00  PACK      KEY25,SESSKEYS,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,SESDET90
.
          PACK      KEY20,OSESITE,OSECLIN,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,SESDET90
.
          MATCH     OSESITE,OCASITE
          GOTO      SESDET90 IF NOT EQUAL
.
          MATCH     OSECLIN,OCACLIN
          GOTO      SESDET90 IF NOT EQUAL
.
          CLEAR     DISPNAME
          MOVE      OCADESC,NAME35
          CALL      NAMSTR00
          RESET     DISPNAME
          MOVE      DISPNAME,DOCFNAME
.
          MOVE      ZERO,EXIT
          GOTO      SESDET99
SESDET90  MOVE      ONE,EXIT
SESDET99  RETURN
.------------------------------------------------------------
.  New booking link
.------------------------------------------------------------
NWBKLK00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8
          MATCH     KEY8,OSEDATE
          GOTO      NWBKLK99 IF LESS
          REP       " +",SESSKEYS
          WRITE     HTMLFILE;LINKPRG,".pbl?":
                             "reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&sesskeys=",SESSKEYS;
          REP       "+ ",SESSKEYS
.
NWBKLK99  RETURN
.------------------------------------------------------------
. Output Case List Search Table
.------------------------------------------------------------
CASTAB00  IF         JSONFLAG=1
            WRITE      HTMLFILE;"[";
          ENDIF
.
          MATCH     SP70,SRCHFLAG
          GOTO      CASTAB99 IF EQUAL
.
          MOVE      "10",NORECORD 
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
 
          MATCH     SP70,SRCHDATE
          IF        !@EQUAL
            MOVE      SRCHDATE,FROMDATE
            GOTO      CASTAB10 
          ENDIF
.
          CALL      GETDAT00       * Determine From Date
.
CASTAB10  MATCH     SP70,CLINICID
          GOTO      CASTAB20 IF EQUAL
.
          CALL      CLISRH00       * Clinic ID Search
          GOTO      CASTAB99
.
CASTAB20  MATCH     SP70,CLINICTY
          GOTO      CASTAB99 IF EQUAL
.
          CALL      CTYSRH00       * Clinic Type Search
          GOTO      CASTAB99
.
CASTAB99  IF         JSONFLAG=1
            WRITE      HTMLFILE;"]";
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Search by Clinic ID
.------------------------------------------------------------
CLISRH00  PACK      KEY28,WBSESIT,CLINICID,FROMDATE,SP70
          CALL      RDSBOKA1
CLISRH10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,CLISRH90          * end of session
          MATCH     WBSESIT,OBASITE
          GOTO      CLISRH90 IF NOT EQUAL
          MATCH     CLINICID,OBACLIN
          GOTO      CLISRH90 IF NOT EQUAL
.
          COMPARE   ZERO,OBASTAT
          GOTO      CLISRH10 IF NOT EQUAL
.
          CALL      CASFLT00
          BRANCH    EXIT,CLISRH10
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      CLISRH10
          ENDIF
.
          CALL      CASROW00
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      CLISRH10 IF NOT EQUAL
          GOTO      CLISRH99
.
CLISRH90  
          IF         JSONFLAG=0
            WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                "<td colspan=6 align=center>":
                                "End of search results</td>"
          ENDIF
.
CLISRH99  RETURN
.------------------------------------------------------------
. Filter Search List
.------------------------------------------------------------
CASFLT00  MATCH     SP70,CLINICID
          IF        !@EQUAL
            MATCH     CLINICID,OBACLIN
            GOTO      CASFLT90 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLINICTY
          IF        !@EQUAL
            MATCH     OBACTYP,CLINICTY
            GOTO      CASFLT90 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,VISITTYP
          IF        !@EQUAL
            MATCH     OBAVISIT,VISITTYP
            GOTO      CASFLT90 IF NOT EQUAL
          ENDIF
.
          MATCH     STRTIM,OBATIME
          GOTO      CASFLT90 IF LESS
          MATCH     OBATIME,ENDTIM
          GOTO      CASFLT90 IF LESS
.
          PACK      KEY25,OBASITE,OBACLIN,OBADATE,OBASTRT,SP70
          CALL      RDSESA1
          BRANCH    OVRCD,CASFLT90
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CASFLT90
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CASFLT90
.
          MATCH     SRCHLTYP,SP70
          IF        !@EQUAL
            MATCH     OTHELTYP,SRCHLTYP
            GOTO      CASFLT90 IF NOT EQUAL
          ENDIF
.
          CALL      CHKSUS00
          BRANCH    EXIT,CASFLT90
.
          MATCH     OTMADTCO,OSEDATE
          GOTO      CASFLT90 IF LESS
          MATCH     SP70,OTMADTCC
          IF        !@EQUAL
            MATCH     OSEDATE,OTMADTCC
            GOTO      CASFLT90 IF LESS
          ENDIF
.
          MOVE      ZERO,EXIT
          GOTO      CASFLT99
.
CASFLT90  MOVE      ONE,EXIT
.
CASFLT99  RETURN
.------------------------------------------------------------
. Check for Master Suspension
.------------------------------------------------------------
CHKSUS00  MOVE      ZERO,EXIT
          PACK      KEY24,OSESITE,OSECLIN,OSEDAY,Z70
          CALL      RSOTMSP1
CHKSUS10  CALL      RPOTMSP1
          BRANCH    OVRCD,CHKSUS99
          MATCH     OSESITE,OTMSSITE
          GOTO      CHKSUS99 IF NOT EQUAL
          MATCH     OSECLIN,OTMSCLIN
          GOTO      CHKSUS99 IF NOT EQUAL
          MOVE      OSEDAY,KEY1
          MATCH     KEY1,OTMSDOWK
          GOTO      CHKSUS99 IF NOT EQUAL
          MATCH     OSESTRT,OTMSSTIM
          GOTO      CHKSUS10 IF NOT EQUAL
.
... CAR 39598 - START
... The match statement sets the LESS flag if the "Session Date" is less than
... the "Suspension To Date". It should not go to CHKSUS10 in this case.
...          MATCH     SP70,OTMSTDAT
...          IF        !@EQUAL
...            MATCH     OTMSTDAT,OSEDATE
...            GOTO      CHKSUS10 IF LESS
...          ENDIF
... CAR 39598 - END
.
          MATCH     OTMSFDAT,OSEDATE
          GOTO      CHKSUS10 IF LESS
          GOTO      CHKSUS20 IF EQUAL
          MATCH     OSEDATE,OTMSTDAT
          GOTO      CHKSUS10 IF LESS
.
CHKSUS20  MOVE      ONE,EXIT
.
CHKSUS99  RETURN
.------------------------------------------------------------
. Search by Clinic Type
.------------------------------------------------------------
CTYSRH00  PACK      KEY35,WBSESIT,CLINICTY,ZERO,FROMDATE,SP70
          CALL      RDSBOKA2
CTYSRH10  CALL      RDKBOKA2                * next read on details file
          BRANCH    OVRCD,CTYSRH90          * end of session
          MATCH     WBSESIT,OBASITE
          GOTO      CTYSRH90 IF NOT EQUAL
          MATCH     CLINICTY,OBACTYP
          GOTO      CTYSRH90 IF NOT EQUAL
          COMPARE   ZERO,OBASTAT
          GOTO      CTYSRH90 IF NOT EQUAL
.
          CALL      CASFLT00
          BRANCH    EXIT,CTYSRH10
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      CTYSRH10
          ENDIF
.
          CALL      CASROW00
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      CTYSRH10 IF NOT EQUAL
          GOTO      CTYSRH99
.
CTYSRH90  IF         JSONFLAG=0
            WRITE      HTMLFILE;"<tr bgcolor=#FF0000>":
                                "<td colspan=6 align=center>":
                                "End of search results</td>"
          ENDIF
.
CTYSRH99  RETURN
.------------------------------------------------------------
. Show Empty Slot
.------------------------------------------------------------
CASROW00  PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
          CALL      RDCLIA1
          IF        OVRCD=0
            GOTO      CASROW10
          ENDIF
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,CASROW05
.
          MATCH     OBASITE,OCASITE
          GOTO      CASROW05 IF NOT EQUAL
.
          MATCH     OBACLIN,OCACLIN
          GOTO      CASROW10 IF EQUAL
.
CASROW05  MOVE      "Invalid Clinic",OCADESC
.
CASROW10  PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          MOVE      SP70,OCTDESC
          PACK      KEY12,WBSESIT,OBACTYP,SP70
          CALL      RDCTYA1
.
          REP       "#" ",OCADESC
          REP       "' ",OCADESC
.         
          REP       "#" ",OBAVISIT
          REP       "' ",OBAVISIT
.
          MOVE      SP70,TDESC
          MOVE      "CT",CATEGORY
          MOVE      OTHELTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIM20
.
          MOVE      SP70,TDESC           * Clinic indicator/description
          MOVE      "CI",CATEGORY
          MOVE      OTHECIND,CODE
          CALL      GETCOD00
          MOVE      TDESC,CLNIDESC
          MOVE      TCINDC1,CLININDC
          MATCH     ANSM,TCINDC2
          IF        @EQUAL
            MOVE      ONE,MOSAIQCL          * Yes it's a MOSAIQ Clinic
          ELSE
            MOVE      ZERO,MOSAIQCL
          ENDIF
.
          IF        MOSAIQRS=1
            MOVE      ZERO,MOSAIQCL         * Allow supervisor MOSAIQ reschedule
          ENDIF
.
          MOVE      SP70,TDESC
          MOVE      "CV",CATEGORY
          MOVE      OBAVISIT,CODE
          CALL      GETCOD00
.
          IF         JSONFLAG=0
            IF         MOSAIQCL=1
              WRITE      HTMLFILE;"<tr class='MosaiqClinic'><td>";
            ELSE
              WRITE      HTMLFILE;"<tr><td>";
            ENDIF
          ELSE
            WRITE      HTMLFILE;"{";
          ENDIF
.
          MATCH     "1",OTHEMREF
          IF       @EQUAL
            MATCH     SP70,SRCHREFN         * Check if referral populated when
            GOTO      CASROW50 IF EQUAL     * referral is mandatory
          ENDIF
.
          BRANCH    MOSAIQCL,CASROW50       * MOSAIQ Clinic
.
          IF         JSONFLAG=0
            WRITE     HTMLFILE;"<img src=../images/AppointmentIcon.gif ":
                      "class=ListIcon":
                      " onclick='updateParent(#"":
                      CASEKEYS,"#",#"":
                      OCADESC,"#",#"":
                      DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR," at ":
                      OBATIME,"#",#"":
                      OBAVISIT,"#",#"":
                      OCTCTYP,"#",#"":
                      OCTDESC,"#",#"":
                      CLNIDESC,"#",#"":
                      CLININDC,"#",#"":
                      OTMAUMCI,"#",#"":
                      OTHECCAR,"#",#"":
                      OTHENDPS,"#",#"":
                      OTHENMDS,"#",#"":
                      OTHECART,"#",#"":
                      OTHESRVD,"#",#"":
                      OTHECLHR,"#",#"":
                      SP1,"#",#"":
                      OTHETCOD,"#",#"":
                      OTHEMREF,"#",#"":
                      OTMATCOD,"#",#"": 
                      OTHEPCOD,"#");'>";
          ELSE
            WRITE     HTMLFILE;"#"code#":#"",CASEKEYS,"#",":
                               "#"time#":#"",OBATIME,"#",":
                               "#"visitcode#":#"",OBAVISIT,"#",":
                               "#"typecode#":#"",OCTCTYP,"#",":
                               "#"clinindc#":#"",CLININDC,"#",":
                               "#"otmaumci#":#"",OTMAUMCI,"#",":
                               "#"otheccar#":#"",OTHECCAR,"#",":
                               "#"othendps#":#"",OTHENDPS,"#",":
                               "#"othenmds#":#"",OTHENMDS,"#",":
                               "#"othecart#":#"",OTHECART,"#",":
                               "#"othesrvd#":#"",OTHESRVD,"#",":
                               "#"otheclhr#":#"",OTHECLHR,"#",":
                               "#"value#":#"",DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR:
                               " at ",OBATIME,"#",";
          ENDIF
          GOTO      CASROW60
.
CASROW50  
          IF         JSONFLAG=0
            WRITE     HTMLFILE;"<img src=../images/BlankIcon.gif ":
                               "class=ListIcon>";
          ELSE
            WRITE     HTMLFILE;"#"code#":#"Error : Slot Not Available.#",":
                               "#"visitcode#":#"",OBAVISIT,"#",":
                               "#"typecode#":#"",OCTCTYP,"#",":
                               "#"value#":#"",DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR:
                               " at ",OBATIME," (N/A)#",";
          ENDIF
.
CASROW60  IF         JSONFLAG=0
            WRITE      HTMLFILE;DAYNAM3," ",CDAY," ",MTHNAM3," ",CCENT,CYEAR:
                               "</td><td align=center>",OBATIME," </td>":
                               "<td>",TDESC,"</td>":
                               "<td>",OCTDESC,"</td>":
                               "<td>&nbsp;",OCADESC,"</td>":
                               "<td>&nbsp;",DIM20,"</td></tr>"
          ELSE
            WRITE     HTMLFILE;"#"visit#":#"",TDESC,"#",":
                               "#"type#":#"",OCTDESC,"#",":
                               "#"clinic#":#"",OCADESC,"#"},";
          ENDIF
.
CASROW99  RETURN
.------------------------------------------------------------
. Determine from Date 
.------------------------------------------------------------
GETDAT00  UNPACK    SRCHTIME,STRTIM,ENDTIM
          MATCH     SP70,ENDTIM
          IF        @EQUAL
            MOVE      Z70,ENDTIM
          ENDIF
          PACK      FROMDATE,CCC,CYY,CMM,CDD
          REP       " 0",FROMDATE
          MATCH     SP70,SRCHPERD
          GOTO      GETDAT99 IF EQUAL
          UNPACK    SRCHPERD,KEY2,KEY1
          MOVE      KEY2,F2
          MOVE      F2,ADJDAYS
          MATCH     "M",KEY1
          GOTO      GETDAT30 IF EQUAL
          MATCH     "D",KEY1
          GOTO      GETDAT20 IF EQUAL
          MATCH     "W",KEY1
          GOTO      GETDAT99 IF NOT EQUAL
          ASSIGN    F2*7,ADJDAYS
.
GETDAT20  UNPACK    FROMDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      FROMDATE,CCENT,CYEAR,CMON,CDAY
          GOTO      GETDAT99
.
GETDAT30  UNPACK    FROMDATE,KEY4,CMON,CDAY
          MOVE      CMON,IMON
          ADD       F2,IMON
          IF        IMON>12
            MOVE      KEY4,F4  
            ADD       ONE,F4  
            MOVE      F4,KEY4
            SUB       "12",IMON  
          ENDIF
          MOVE      IMON,CMON
          PACK      FROMDATE,KEY4,CMON,CDAY
          REP       " 0",FROMDATE
          GOTO      GETDAT99
.
GETDAT99  RETURN
.------------------------------------------------------------
. Case List Title
.------------------------------------------------------------
CASTIT00  UNPACK    OSEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          CLEAR     WEBTITLE
          APPEND    "Clinic List for ",WEBTITLE
          UNPACK    OMASTART,DIMHRS,KEY1,DIMMIN
          MOVE      DIMHRS,F2
          IF        F2>=12
            IF        F2>12
              SUB       "12",F2                  * when 13:00 is 1:00pm
            ENDIF
            APPEND    F2,WEBTITLE
            APPEND    KEY1,WEBTITLE
            APPEND    DIMMIN,WEBTITLE
            APPEND    " pm",WEBTITLE
          ELSE
            APPEND    F2,WEBTITLE
            APPEND    KEY1,WEBTITLE
            APPEND    DIMMIN,WEBTITLE
            APPEND    " am",WEBTITLE
          ENDIF
          APPEND    SP1,WEBTITLE
          APPEND    CDAY,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    MTHNAM3,WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    CCENT,WEBTITLE
          APPEND    CYEAR,WEBTITLE
          RESET     WEBTITLE
          RETURN
.------------------------------------------------------------
. Get Case Details
.------------------------------------------------------------
CASDET00  MATCH     "       0",OBAURNO
          GOTO      CASDET10 IF NOT EQUAL   * have a UR number
.
.         on pre-admission file
.
          MOVE      OBAOUTNO,KEY8           * visit number
          CALL      RDPRAM1
          BRANCH    OVRCD,CASDET10          * invalid visit number
.
          MOVE      ZERO,PURNO
          GOTO      CASDET99                * valid patient
.
.         on master file
.
CASDET10  PACK      KEY8,OBAURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,CASDET99          * invalid UR number
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
CASDET99  RETURN
.
.------------------------------------------------------------
. Show Referral Details
.------------------------------------------------------------
REFDET00  MOVE      WBSESIT,IDDD
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      REFDET50 IF EQUAL
.
          MATCH     "A",UPDTTYPE    * Add formaction
          GOTO      REFDET10 IF EQUAL
.
          MATCH     "U",UPDTTYPE    * Update formaction
          GOTO      REFDET20 IF EQUAL
.
          MATCH     "D",UPDTTYPE    * Delete formaction
          GOTO      REFDET30 IF EQUAL
.
          MATCH     "P",UPDTTYPE    * Delete formaction
          GOTO      REFDET40 IF EQUAL
.
          MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFDET99
.
.         ************ ADD FORMACTION ***********
.
REFDET10  PACK      KEY8,URNUMBER           
          CALL      RLPTMAS1
          BRANCH    OVRCD,REFDET96,REFDET97
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
REFDET11  CALL      CLOUTRFL     * Clear Referral Fields
          CALL      WOPNM000     * Determine New Outpatient Number
          CALL      WOTRL000     * Write New Record
          BRANCH    EXIT,REFDET11
.
          CALL      PMIGTNID                     * CAR 177234
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLIRAD                     * trigger HL7 A05 message
.
          PACK      KEY8,URNUMBER           
          CALL      UUPTMAS1
.
          STRIP     REDIRECT
          ENDSET    REDIRECT
          APPEND    "&admissno=",REDIRECT
          MOVE      OTRLOUTN,KEY8
          REP       " +",KEY8
          APPEND    KEY8,REDIRECT
.
          MOVE      ZERO,EXIT
          MOVE      "New Referral Added",WEBTITLE
          GOTO      REFDET99
.
.         ************ Update FORMACTION ***********
.
REFDET20  MOVE      ADMISSNO,KEY8
          CALL      RDOTRFL1
          BRANCH    OVRCD,REFDET95
          MATCH     SP70,OTRLBSIT
          GOTO      REFDET98 IF NOT EQUAL
          PACK      KEY8,URNUMBER           
          CALL      RLPTMAS1
          BRANCH    OVRCD,REFDET96,REFDET97
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDOTRFL1
          IF        OVRCD=0
            CALL      MVRFL000
            MOVE      PASSCODE,OTRLOPER     * Store User ID for this update
.
            PACK      OTRLUDAT,CCC,CYY,CMM,CDD
            REP       " 0",OTRLUDAT
            CLOCK     TIME,OTRLUTIM
            MOVE      WBSEUID,OTRLUUID
.
            CALL      UPOTRFL1
.
            CALL      PMIGTNID                   * CAR 177234
            MOVE      NMPNUMB,PTNINMPI
            MOVE      TWO,HL7TRGID
            MOVE      SP8,HL7INCLD
            PROC      DGCLIRUP                   * trigger HL7 A08 message
          ENDIF
          PACK      KEY8,URNUMBER           
          CALL      UUPTMAS1
          MOVE      "Referral Updated",WEBTITLE
          GOTO      REFDET99
.
REFDET30  MOVE      ADMISSNO,KEY8
          CALL      RDOTRFL1
          BRANCH    OVRCD,REFDET95
          MATCH     SP70,OTRLBSIT
          GOTO      REFDET98 IF NOT EQUAL
          MOVE      ADMISSNO,KEY8
          CALL      RDOTRFL1
          IF        OVRCD=0
            CALL      DEOTRFL1
          ENDIF
          MOVE      "Referral Deleted",WEBTITLE
          GOTO      REFDET99
.
REFDET40  CALL      CLOUTRFL
          MOVE      ADMISSNO,KEY8
          CALL      RDOTRFL1
.
          PACK      KEY8,URNUMBER
          CALL      RDMAST1
          BRANCH    OVRCD,REFDET96
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          CALL      PRTLET00           * Print Letter
          CALL      PRTLAB00           * Print Labels
.
          MOVE      ZERO,EXIT
          GOTO      REFDET99
.
REFDET50  CALL      CLOUTRFL
          MOVE      ADMISSNO,KEY8
          CALL      RDOTRFL1
.
          PACK      KEY8,URNUMBER           
          CALL      RDMAST1
          BRANCH    OVRCD,REFDET96
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      "Referral Details",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,REFDET99
.
          CALL      WEBBOD00
.
REFDET90  CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      REFDET99
.
REFDET95  CLEAR     WEBTITLE
          APPEND    "Invalid Referral Number - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFDET99
.
REFDET96  CLEAR     WEBTITLE
          APPEND    "Invalid Patient U/R - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFDET99
.
REFDET97  CLEAR     WEBTITLE
          APPEND    "Patient U/R Locked - ",WEBTITLE
          APPEND    KEY8,WEBTITLE
          APPEND    " on ",WEBTITLE
          APPEND    PPORT,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFDET99
.
REFDET98  MOVE      "Referral Appointment Booked. Update not Allowed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      REFDET99
.
REFDET99  RETURN
.------------------------------------------------------------
. WOPNM000 : Get New Outpatient Number
.------------------------------------------------------------
WOPNM000  READ      CONTROLF,HUND30;*75,PTCNUANV      * Using AN Visit Numbers
.
          MATCH     "1",PTCNUANV
          IF        @EQUAL
            CALL      GANV0000                * Get next AN visit number
            MOVE      PTCNNXTV,OTRLOUTN           * Set Referral Letter Variable
          ELSE
            MOVE      " 10",PRXCODE            * Lock I/O
            CALL      GETSLK00
            READ      CONTROLF,TEN;*1,FORM8    * Get the next Outpatient number
            ADD       ONE,FORM8                * Increment next Outpatient No.
            WRITAB    CONTROLF,TEN;*1,FORM8    * Post new outpatient no
            CALL      RELSLK00
            SUB       ONE,FORM8                * Go back to original O/P Number
            MOVE      FORM8,OTRLOUTN           * Set Referral Letter Variable
          ENDIF
.
.
.         Make sure this outpatient number has not been used
.
          PACK      KEY8,OTRLOUTN            * Key for visit file
          CALL      RDVISA1                  * Check if visit record exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      WOPNM000 IF EQUAL        * Yes. Try again
.
          PACK      KEY8,OTRLOUTN            * Key for pre-attendance file
          CALL      RDPREA1                  * Check if record already exists
          COMPARE   ZERO,OVRCD               * Does this record exist ?
          GOTO      WOPNM000 IF EQUAL        * Yes. Try again
.
WOPNM999  RETURN
.------------------------------------------------------------
. Write New Referral Letter Details
.------------------------------------------------------------
WOTRL000  PACK      KEY8,OTRLOUTN            * Key for Out. Referral Let. File
          CALL      RAOTRFL1
          COMPARE   ZERO,OVRCD
          GOTO      WOTRL990 IF EQUAL
.
          CALL      MVRFL000     * Move in Fields
.
          MOVE      URNUMBER,OTRLURNO
          UNPACK    SP70,OTRLBSIT,OTRLBCLI,OTRLBDTE,OTRLBSTR,OTRLBSLT
.
          PACK      OTRLCDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTRLCDAT
          CLOCK     TIME,OTRLCTIM
          MOVE      WBSEUID,OTRLCUID
.
          CALL      WROTRFL1
          MOVE      ZERO,EXIT
          GOTO      WOTRL999
.
WOTRL990  MOVE      ONE,EXIT
.
WOTRL999  RETURN
.
.------------------------------------------------------------------------------
. Print Letter
.------------------------------------------------------------------------------
PRTLET00  MATCH     Z70,LETNUMBR
          GOTO      PRTLET99 IF EQUAL
          MATCH     SP70,LETNUMBR
          GOTO      PRTLET99 IF EQUAL
.
          MOVE      LETPRNTR,SCHDPRNT
          MOVE      ONE,SCHDCOPY
          MOVE      LETTRREF,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          MOVE      LETNUMBR,LETTNCOD
.
PRTLET10  PACK      KEY5,Z70
          CALL      RSOTLPC1
          CALL      RPOTLPC1
          IF        OVRCD=1
            MOVE      ZERO,F5
            MOVE      F5,OTLPSCHE
          ENDIF
.
          MOVE      OTLPSCHE,F5
          ADD       ONE,F5
          MOVE      F5,OTLPSCHE
          MOVE      OTRLURNO,OTLPURNO
          MOVE      OTRLOUTN,OTLPBOOK
          MOVE      OTRLSITE,OTLPSITE
          MOVE      SP70,OTLPCLIN
          MOVE      SP70,OTLPSDAT
          MOVE      SP70,OTLPSTIM
          MOVE      SP70,OTLPSLOT
.
          MOVE      LETPRNTR,OTLPPRNT
          MOVE      ONE,OTLPCOPY
          MOVE      SP70,OTLPSTAT
          MOVE      LETTNCOD,OTLPLETT
          MOVE      TWO,OTLPPTYP
          MOVE      USERID,OTLPWEBU
          PACK      OTLPRDAT,CCC,CYY,CMM,CDD
          REP       " 0",OTLPRDAT
          MOVE      CTIMEIS,OTLPRTIM
.
PRTLET50  PACK      KEY5,OTLPSCHE
          CALL      RAOTLPC1
          IF        OVRCD=1
            TRAP      WRTRAP IF IO               * Trap to stop I * D when
            CALL      WROTLPC1                   * multiple servers write to the
            TRAPCLR   IO                         * outpatient print file
          ELSE
            GOTO      PRTLET10
          ENDIF
.
PRTLET99  RETURN
.
WRTRAP    NORETURN
          ADD         ONE,F5
          MOVE        F5,OTLPSCHE
          GOTO        PRTLET50
.
.------------------------------------------------------------------------------
. Print Labels
.------------------------------------------------------------------------------
PRTLAB00  MATCH     "1",LABPRT01
          GOTO      PRTLAB10 IF NOT EQUAL
          MOVE      LABPSL01,SCHDPRNT
          MOVE      LABPNO01,SCHDCOPY
          MOVE      "01",DIM2
          PACK      LABELTYP,LABELREF,DIM2
.
          MOVE      LABELREF,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRTLAB10  MATCH     "1",LABPRT02
          GOTO      PRTLAB20 IF NOT EQUAL
          MOVE      LABPSL02,SCHDPRNT
          MOVE      LABPNO02,SCHDCOPY
          MOVE      "02",DIM2
          PACK      LABELTYP,LABELREF,DIM2
.
          MOVE      LABELREF,SETDFPRG
          MOVE      "2",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRTLAB20  MATCH     "1",LABPRT03
          GOTO      PRTLAB30 IF NOT EQUAL
          MOVE      LABPSL03,SCHDPRNT
          MOVE      LABPNO03,SCHDCOPY
          MOVE      ADDLABEL,LABELTYP            * address label type
.
          MOVE      LABELREF,SETDFPRG
          MOVE      "3",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRTLAB30  MATCH     "1",LABPRT04
          GOTO      PRTLAB99 IF NOT EQUAL
          MOVE      LABPSL04,SCHDPRNT
          MOVE      LABPNO04,SCHDCOPY
          MOVE      PMILABEL,LABELTYP            * pmi label type
.
          MOVE      LABELREF,SETDFPRG
          MOVE      "4",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRTLAB99  RETURN
.
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
.
SETDEF99  RETURN
.
.------------------------------------------------------------
. Show Referral Details
.------------------------------------------------------------
FLTLST00  MOVE      WBSESIT,IDDD
          RESET     UPDTTYPE
          MATCH     SP1,UPDTTYPE
          GOTO      FLTLST40 IF EQUAL
.
          MOVE      "Invalid Form Action",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      FLTLST99
.
FLTLST40  CALL      CURPER00   * Calculate Next and Last Period Dates
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Referral Details",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,FLTLST99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          MOVE      ONE,EXIT
          GOTO      FLTLST99
.
FLTLST99  RETURN
.
          INC       ALLREFIO/INC
          INC       ALLRITIO/INC
          INC       ALLPROIO/INC
          INC       ALLPRRIO/INC
          INC       ALLDIAIO/INC
          INC       ALLCASIO/INC
          INC       ALLLNKIO/INC
          INC       ALLSTSIO/INC
.
          INC       PRIITMIO/INC
          INC       PRITHDIO/INC
.
          INC       APSMASIO/INC
          INC       IBALPCIO/INC
          INC       IBALPCCD
          INC       OUTARTTM
          INC       SCRMASIO/INC
          INC       MLTSECIO/INC
          INC       MLTSITIO/INC
          INC       OUTBOAIO/INC       * Bookings file A
          INC       OUTBB1IO/INC       * Bookings file B
          INC       OUTCLIIO/INC       * Clinic Ids
          INC       OUTCTYIO/INC       * Clinic Types
          INC       OUTDIAIO/INC       * Clinic Types
          INC       OUTMA1IO/INC       * Session Master file
          INC       OUTARTIO/INC       * Requested Appointments
          INC       OUTSESIO/INC       * Clinic Open Sessions file
          INC       OUTSITIO/INC       * Site file
          INC       OUTPREIO/INC       * Outpatient Pre-attendance file
          INC       OUTRCMIO/INC
          INC       OUTRF1IO/INC       * Referral List
.
          INC       OPRCLIIO/INC        * Clinic Open Sessions file
          INC       OPRSESIO/INC        * Clinic Open Sessions file
          INC       OPROPRIO/INC        * Clinic Open Sessions file
          INC       OUTMSPIO/INC        * Session Master file
          INC       OUTLETIO/INC       * Outpatient Letter File
          INC       OUTLPCIO/INC       * Outpatient Print Scheduling
.
          INC       PATALRIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATDO1IO/INC       * Doctors file
          INC       PATFN1IO/INC       * Health Fund file
          INC       PATIN1IO/INC       * Insurance file
          INC       PMSHCPIO/INC       * Doctors file
          INC       PMSHCGIO/INC       * Doctors file
          INC       PMSHCLIO/INC
          INC       PMSHCPTM
          INC       PMSHCGTM
          INC       PATMA1IO/INC       * PMI file
          INC       PMSPX2IO/INC
          INC       PATHSPIO/INC
          INC       PATMI1IO/INC
          INC       PATNIDIO/INC
          INC       PATPR1IO/INC       * Pre-attendance PMI file
          INC       PATVISIO/INC
          INC       PMSVX1IO/INC
          INC       PATWR1IO/INC
          INC       RESLNKIO/INC
          INC       MRTMASIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       VISCMTIO/INC
          INC       OUTHEDIO/INC
          INC       CLNHIMAS                   * Clear nhimasaf file variables
          INC       CLOUTRFL
.
          INC       PATDOCTM
          INC       PATMASTM
          INC       CLPMSPX2
          INC       DGCLIRAD
          INC       DGCLIRUP
          INC       PMIGTNID
          INC       PMSPX2TM
          INC       PATMSXTM
          INC       OUTRFLTM
          INC       OUTSESTM
          INC       CLALLREF
          INC       ALLREFTM
.
          INC       PATDOCCD
          INC       CALCAGE 
          INC       NAMSTRCD
          INC       DAYOFWEK
          INC       WEBDATCD    
          INC       IBAWEBCD    
          INC       CLPATMAS
          INC       PATNAMCD
          INC       GENANVIS
.------------------------------------------------------------
. Check for Theatre Sessions
.------------------------------------------------------------
CHKOPR00  PACK      KEY22,WBSEDOC,WBSEHOSP,CURDATE,SP70
          CALL      RSOPSES2
CHKOPR10  CALL      RKOPSES2
          BRANCH    OVRCD,CHKOPR99
          MATCH     WBSEDOC,OPSECLIN
          GOTO      CHKOPR99 IF NOT EQUAL
          MATCH     OPSEHOSP,WBSEHOSP
          GOTO      CHKOPR99 IF NOT EQUAL
          MATCH     OPSEDATE,CURDATE
          GOTO      CHKOPR99 IF NOT EQUAL
.
          MOVE      OPSETIME,STRTIM
          MOVE      OPSEENDT,ENDTIM
          CALL      FMTTIM00
          MOVE      OPSETHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=1
            MOVE      SP70,OPRMDESC
          ENDIF
          PACK      KEY5,CODEST,OPSETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          IF        FRSTFLAG=0
            MOVE      ONE,FRSTFLAG
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>"
          ENDIF
.
          MOVE      OPSEDURA,SESTOTAL
          MOVE      OPSETIMB,SESUSED
          CALL      CALBAR00
.
          WRITE     HTMLFILE;"<td align=center nowrap>":
                         "<img src=../images/MaintenanceIcon.gif border=0":
                         " hspace=4 align=absmiddle onclick=":
                         "'location.href=#"",TLINKPRG,".pbl?reportno=",TLINKREP:
                         "&template=",TLINKTEM:
                        "&sesskeys=",OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,"#"'>":
                             STRTIM,SP1,STRAMPM," to ":
                             ENDTIM,SP1,ENDAMPM,"</td>":
                             "<td>Theatre ",TDESC:
                             " in ",OPRMDESC,"</td>":
                             "<td ALIGN=LEFT NOWRAP ":
                             "width=100 height=10 bgcolor=##000080>":
                             "<img src=../images/bar1.gif ",FILHIGHT,SP1,FILWIDTH:
                             " align=absbottom>":
                             "</td></tr>"
          GOTO      CHKOPR10
.
CHKOPR99  RETURN
.------------------------------------------------------------
. Get Outpatient Sessions for a Day
.------------------------------------------------------------
CHKOUT00  PACK      KEY25,CURDATE,SP70     * Loads the site at the date
          CALL      RDSSESA2
CHKOUT10  CALL      RDKSESA2
          BRANCH    OVRCD,CHKOUT99
.
          MATCH     OSEDATE,CURDATE                * Matches the date
          GOTO      CHKOUT99 IF NOT EQUAL
.
          PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OSESITE,OSECLIN,OSEDATE,SP70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,CHKOUT10
.
            MATCH     OSECLIN,OCACLIN   * Matches the Clinic
            GOTO      CHKOUT10 IF NOT EQUAL
.
            MATCH     OSESITE,OCASITE   * Matches the site
            GOTO      CHKOUT10 IF NOT EQUAL
.
          ENDIF
.
          PACK      KEY18,OSESITE,OSECLIN,OSEDAY,OSESTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CHKOUT10
.
          PACK      KEY28,OSESITE,OSECLIN,OSEDAY,OSESTRT,OSESSHNO,OSESSDAT,SP70
          CALL      RDOTHED1
          BRANCH    OVRCD,CHKOUT10
.
          MATCH     OCADOCT,WBSEDOC         * Matches the Dr for the user
          GOTO      CHKOUT20 IF EQUAL
.
          MATCH     WBSEDOC,OTHEDEFD        * Matches the Slot Dr
          GOTO      CHKOUT20 IF EQUAL 
.
          MATCH     WBSEDOC,OTHEHCP1        * Matches Add HCP 1
          GOTO      CHKOUT20 IF EQUAL 
.
          MATCH     WBSEDOC,OTHEHCP2        * Matches Add HCP 2
          GOTO      CHKOUT20 IF EQUAL 
.
          MATCH     WBSEDOC,OTHEHCP3        * Matches Add HCP 3
          GOTO      CHKOUT20 IF EQUAL 
.
          MATCH     WBSEDOC,OTHEHCP4        * Matches Add HCP 4
          GOTO      CHKOUT10 IF NOT EQUAL 
.
CHKOUT20  PACK      KEY12,OTHESITE,OTHECTYP,SP70
          CALL      RDCTYA1
          BRANCH    OVRCD,CHKOUT10
.
          IF        FRSTFLAG=0
            MOVE      ONE,FRSTFLAG
          ELSE 
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>"
          ENDIF
          MOVE      OMASTART,STRTIM
          MOVE      OMAEND,ENDTIM
          CALL      FMTTIM00
.
          PACK      SESSKEYS,OSESITE,OSECLIN,OSEDATE,OSESTRT,SP70
          REP       " +",SESSKEYS
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          WRITE     HTMLFILE;"<td>":
                        "<img src=../images/OutpatientIcon.gif border=0":
                        " hspace=4 align=absmiddle onclick=":
                        "'location.href=#"",OLINKPRG,".pbl?reportno=",OLINKREP:
                        "&template=",OLINKTEM:
                        "&sesskeys=",SESSKEYS,"#"'>":
                        STRTIM,SP1,STRAMPM," to ":
                        ENDTIM,SP1,ENDAMPM,"</td>":
                        "<td>Clinic: ",OCTDESC,SP1,OCADESC,"</td></tr>"
.
          GOTO      CHKOUT10
.
CHKOUT99  RETURN
.------------------------------------------------------------
. Format Time
.------------------------------------------------------------
FMTTIM00  MOVE      "am",STRAMPM
          MOVE      "am",ENDAMPM
          UNPACK    STRTIM,DIMHRS,KEY1,DIMMIN
          MOVE      DIMHRS,F2
          IF        F2>=12
            MOVE      "pm",STRAMPM
            IF        F2>12
              SUB       "12",F2
            ENDIF
            PACK      STRTIM,F2,KEY1,DIMMIN
            REP       " 0",STRTIM
          ENDIF
.
          UNPACK    ENDTIM,DIMHRS,KEY1,DIMMIN
          MOVE      DIMHRS,F2
          IF        F2>=12
            MOVE      "pm",ENDAMPM
            IF        F2>12
              SUB       "12",F2                  * when 13:00 is 1:00pm
            ENDIF
            PACK      ENDTIM,F2,KEY1,DIMMIN
            REP       " 0",ENDTIM
          ENDIF
          RETURN
.------------------------------------------------------------
. Calculate Bar for Session
.------------------------------------------------------------
CALBAR00  MOVE      "8",FILHIGH
          ASSIGN    SESUSED/SESTOTAL*100.0,SESSFILL
          ASSIGN    SESUSED/SESTOTAL*100,F3
          IF        F3>100
            MOVE      "100",F3
          ENDIF
          IF        F3=0
            MOVE      ONE,F3
            MOVE      "1",FILHIGH
          ENDIF
          MOVE      F3,KEY3
          SQUEEZE   KEY3
          CLEAR     FILWIDTH
          APPEND    "WIDTH=",FILWIDTH
          APPEND    KEY3,FILWIDTH
          RESET     FILWIDTH
.
          MOVE      FILHIGH,KEY3
          SQUEEZE   KEY3
          CLEAR     FILHIGHT
          APPEND    "HEIGHT=",FILHIGHT
          APPEND    KEY3,FILHIGHT
          RESET     FILHIGHT
          RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          PACK      KEY12,WBSESIT,WBSECLI,SP70
          REP       " +",KEY12
.
          WRITE     HTMLFILE;"outweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&outpclin=",KEY12:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE;
.
NEXT9999  RETURN
.
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
.
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          PACK      KEY12,WBSESIT,WBSECLI,SP70
          REP       " +",KEY12
.
          WRITE     HTMLFILE;"outweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&outpclin=",KEY12:
                             "&frstdate=",PREFDATE:                             
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE;
.                                                           
PREV9999  RETURN
..------------------------------------------------------------
. Search for Case 
.------------------------------------------------------------
CASSRH00  MATCH     SP70,WBSESIT
          GOTO      CASSRH95 IF EQUAL
.
          MOVE      WBSESIT,KEY6
          CALL      RDSITA1          * Read Site Record
          BRANCH    OVRCD,CASSRH95
.
          CALL      IBACLOCK         * Read Site Record
          MOVE      "Outpatient Booking Search",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,CASSRH99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          GOTO      CASSRH99
.
CASSRH95  MOVE      "OUTPATIENT SITE INVALID",WEBTITLE
          CALL      WEBERR00
.
CASSRH99  RETURN
.------------------------------------------------------------
.  Case list display options
.------------------------------------------------------------
CSRH0000  BRANCH    FLDITMNO,CSRH0100,CSRH0200,CSRH0300,CSRH0400,CSRH0500:
                             CSRH0600,CSRH0700,CSRH0800,CSRH0900,CSRH1000:
                             CSRH1100,CSRH1200,CSRH1300,CSRH1400,CSRH1500:
                             CSRH1600,CSRH1700
          GOTO      CSRH9999
.
CSRH0100  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          MOVE      TEMPLATE,F3
          MOVE      F3,TEMPLATE
          REP       " 0",TEMPLATE
          WRITE     HTMLFILE;"outweb01.pbl?reportno=2":
                                 "&template=",TEMPLATE:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&srchflag=",SRCHFLAG: 
                                 "&visittyp=",VISITTYP: 
                                 "&clinicty=",CLINICTY: 
                                 "&clinicid=",CLINICID: 
                                 "&srchdate=",SRCHDATE: 
                                 "&srchperd=",SRCHPERD: 
                                 "&srchtime=",SRCHTIME: 
                                 "&srchrefn=",SRCHREFN: 
                                 "&srchltyp=",SRCHLTYP: 
                                 "&mosaiqrs=",MOSAIQRS; 
          GOTO      CSRH9999   
.
CSRH0200  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          MOVE      TEMPLATE,F3
          MOVE      F3,TEMPLATE
          REP       " 0",TEMPLATE
          WRITE     HTMLFILE;"outweb01.pbl?reportno=2":
                                 "&template=",TEMPLATE:
                                 "&startnum=",KEY3:
                                 "&norecord=",KEY2:
                                 "&srchflag=",SRCHFLAG: 
                                 "&visittyp=",VISITTYP: 
                                 "&clinicty=",CLINICTY: 
                                 "&clinicid=",CLINICID: 
                                 "&srchdate=",SRCHDATE: 
                                 "&srchperd=",SRCHPERD: 
                                 "&srchtime=",SRCHTIME:
                                 "&srchrefn=",SRCHREFN: 
                                 "&srchltyp=",SRCHLTYP:
                                 "&mosaiqrs=",MOSAIQRS; 
          GOTO      CSRH9999
.
CSRH0300  MOVE      VISITTYP,CODE
          MOVE      ZERO,VISTFLAG
          CALL      VTYSEL00
          GOTO      CSRH9999
.
CSRH0400  CALL      CLITYP00     * Clinic Types
          GOTO      CSRH9999
.
CSRH0500  CALL      CLIOPT00     * Clinic ID's
          GOTO      CSRH9999
.
CSRH0600  WRITE     HTMLFILE;TEMPLATE;
          GOTO      CSRH9999
.
CSRH0700  WRITE     HTMLFILE;REPORTNO;
          GOTO      CSRH9999
.
CSRH0800  MOVE      ZERO,JSONFLAG
          CALL      CASTAB00     * Clinic ID's
          GOTO      CSRH9999
.
CSRH0900  CALL      CLIDET00     * Clinic ID's
          GOTO      CSRH9999
.
CSRH1000  CALL      FINDSL00     * Find Slot Key
          GOTO      CSRH9999
.
CSRH1100  MOVE      VISITTYP,CODE
          MOVE      ONE,VISTFLAG
          CALL      VTYSEL00
          GOTO      CSRH9999
.
CSRH1200  WRITE     HTMLFILE;CLINICTY;
          GOTO      CSRH9999
.
CSRH1300  WRITE     HTMLFILE;DEFTOVRD;
          GOTO      CSRH9999
.
CSRH1400  WRITE     HTMLFILE;SRCHREFN;           * Search referral number for
          GOTO      CSRH9999                     * mandatory referral test
.
CSRH1500  MOVE      ONE,JSONFLAG
          CALL      CASTAB00     
          GOTO      CSRH9999
.
CSRH1600  WRITE     HTMLFILE;VISITTYP;
          GOTO      CSRH9999
.
CSRH1700  WRITE     HTMLFILE;MOSAIQRS;
          GOTO      CSRH9999
.
CSRH9999  RETURN
.
CLIDET00  UNPACK    DIM127,ANS,KEY1,DIM127
          MATCH     SP70,CLINICID
          GOTO      CLIDET99 IF EQUAL
          MOVE      ZERO,F1
          MOVE      KEY1,F1
          BRANCH    F1,CLIDET10
.
          PACK      KEY20,WBSESIT,CLINICID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,CLIDET99
.
          MATCH     OCASITE,WBSESIT
          GOTO      CLIDET99 IF NOT EQUAL
.
          MATCH     OCACLIN,CLINICID
          GOTO      CLIDET99 IF NOT EQUAL
.
          WRITE     HTMLFILE;OCADESC;
          GOTO      CLIDET99
.
CLIDET10  WRITE     HTMLFILE;CLINICID;
.
CLIDET99  RETURN
.------------------------------------------------------------
. Clinic Option List
.------------------------------------------------------------
CLIOPT00  PACK      KEY20,WBSESIT,SP70
          CALL      RDSCLIA1
CLIOPT10  CALL      RDKCLIA1
          BRANCH    OVRCD,CLIOPT99
.
          MATCH     OCASITE,WBSESIT
          GOTO      CLIOPT99 IF NOT EQUAL
.
          MATCH     "1",OTCLIACT
          GOTO      CLIOPT10 IF EQUAL
.
          MATCH     CLINICID,OCACLIN
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#" selected>(":
                               OCACLIN,") ",OCADESC,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCACLIN,"#">(":
                               OCACLIN,") ",OCADESC,"</option>";
          ENDIF
          GOTO      CLIOPT10
.
CLIOPT99  PACK      KEY20,WBSESIT,CLINICID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          RETURN
.------------------------------------------------------------
. Clinic Option List
.------------------------------------------------------------
CLITYP00  PACK      KEY42,WBSESIT,SP70
          CALL      RDSCTYA2
CLITYP10  CALL      RDKCTYA2
          BRANCH    OVRCD,CLITYP99
          MATCH     OCTSITE,WBSESIT
          GOTO      CLITYP99 IF NOT EQUAL
          MATCH     "1",OCTACT
          GOTO      CLITYP10 IF EQUAL
.
          MATCH     CLINICTY,OCTCTYP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#" selected>":
                               OCTDESC,"</option>";
          ELSE
            WRITE     HTMLFILE;"<option value=#"",OCTCTYP,"#">":
                               OCTDESC,"</option>";
          ENDIF
          GOTO      CLITYP10
.
CLITYP99  RETURN
.------------------------------------------------------------
. Check for Theatre Sessions
.------------------------------------------------------------
CHKALL00  PACK      KEY22,CURDATE,SP70
          CALL      RSOPSES7
CHKALL10  CALL      RKOPSES7
          BRANCH    OVRCD,CHKALL99
.
          MATCH     OPSEDATE,CURDATE
          GOTO      CHKALL99 IF NOT EQUAL
.
          CALL      CHKDOC00
          BRANCH    EXIT,CHKALL10
.
          MOVE      OPSETIME,STRTIM
          MOVE      OPSEENDT,ENDTIM
          CALL      FMTTIM00
          MOVE      OPSETHET,KEY6
          CALL      RDOPOPR1
          IF        OVRCD=1
            MOVE      SP70,OPRMDESC
          ENDIF
          PACK      KEY5,CODEST,OPSETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          IF        FRSTFLAG=0
            MOVE      ONE,FRSTFLAG
          ELSE
            WRITE     HTMLFILE;"<tr><td>&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td>":
                         "<img src=../images/TheatreIcon.gif border=0":
                         " hspace=4 align=absmiddle onclick=":
                         "'location.href=#"",TLINKPRG,".pbl?reportno=",TLINKREP:
                         "&template=",TLINKTEM:
                        "&sesskeys=",OPSEHOSP,OPSEDATE,OPSETIME,OPSECLIN,"#"'>":
                         STRTIM,SP1,STRAMPM," to ":
                         ENDTIM,SP1,ENDAMPM,"</td>":
                         "<td>Surgery: ",TDESC:
                         " in ",OPRMDESC,"</td></tr>"
          GOTO      CHKALL10
.
CHKALL99  RETURN
.
CHKDOC00  IF        OPCNCLSU=1
            MATCH     WBSEDOC,OPSECLIN
            GOTO      CHKDOC90 IF EQUAL
          ENDIF
          MATCH     WBSEDOC,OPSEANAE
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSECORD
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSEDCC1
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSEDCC2
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSEDCC3
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSEDCC4
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSEDCC5
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSEDCC6
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSEDCC7
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSEDCC8
          GOTO      CHKDOC90 IF EQUAL
          MATCH     WBSEDOC,OPSEXDOC
          GOTO      CHKDOC90 IF EQUAL
.
          MOVE      OPSECLIN,KEY6
          CALL      RDOPCLI1
          BRANCH    OVRCD,CHKDOC80
.
          MATCH     WBSEDOC,OPCLDOCT
          GOTO      CHKDOC90 IF EQUAL
.
CHKDOC80  MOVE      ONE,EXIT
          GOTO      CHKDOC99 
.
CHKDOC90  MOVE      ZERO,EXIT
CHKDOC99  RETURN
.------------------------------------------------------------
. Referral List  - by Clinic ID 
.------------------------------------------------------------
REFLST00  MATCH     SP70,CLINICID
          IF        @EQUAL
            MOVE      WBSECLI,CLINICID
          ENDIF
          MOVE      WBSESIT,KEY6
          CALL      RDSITA1          * Read Site Record
          BRANCH    OVRCD,REFLST95
.
          PACK      KEY20,WBSESIT,CLINICID,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,REFLST95
.
          MATCH     WBSESIT,OCASITE
          GOTO      REFLST95 IF NOT EQUAL
.
          MATCH     CLINICID,OCACLIN
          GOTO      REFLST95 IF NOT EQUAL
.
          CALL      CURPER00   * Calculate Next and Last Period Dates
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Referral List",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,REFLST99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
          GOTO      REFLST99
.
REFLST95  MOVE      "Invalid Security/Clinic ID",WEBTITLE
          CALL      WEBERR00
.
REFLST99  RETURN
.------------------------------------------------------------
. Referral List Options
.------------------------------------------------------------
REFL0000  BRANCH    FLDITMNO,REFL0100,REFL0200,REFL0300,REFL0400,REFL0500:
                             REFL0600,REFL0700,REFL0800,REFL0900,REFL1000:
                             REFL1100,REFL1200
          GOTO      REFL9999
.
REFL0100  CALL      REFNXT00
          GOTO      REFL9999
.
REFL0200  CALL      REFPRV00
          GOTO      REFL9999
.
REFL0300  CALL      CURSTD00
          GOTO      REFL9999
.
REFL0400  CALL      CUREND00
          GOTO      REFL9999
.
REFL0500  CALL      CURYR000
          GOTO      REFL9999
.
REFL0600  CALL      CURMON00
          GOTO      REFL9999
.
REFL0700  CALL      SELV0000
          GOTO      REFL9999
.
REFL0800  WRITE     HTMLFILE;TEMPLATE;
          GOTO      REFL9999
.
REFL0900  WRITE     HTMLFILE;REPORTNO;
          GOTO      REFL9999
.
REFL1000  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      REFL9999
.
REFL1100  CALL      REFTAB00
          GOTO      REFL9999
.
REFL1200  UNPACK    DIM127,D1,ANS,DIM127
          MOVE      ZERO,F1
          MOVE      ANS,F1
          BRANCH    F1,REFL1210,REFL1220
          WRITE     HTMLFILE;CLINICID;
          GOTO      REFL9999
.
REFL1210  PACK      KEY20,WBSESIT,CLINICID,Z70 
          CALL      RDSCLIA1          * Read Clinic Record
          CALL      RDPCLIA1          * Read Clinic Record
          WRITE     HTMLFILE;OCADESC;
          GOTO      REFL9999
.
REFL1220  CALL      CLIOPT00     * Clinic ID's
          GOTO      REFL9999
.
REFL9999  RETURN
.------------------------------------------------------------
. Output Referral Table - by Date Range for a Doctor
.------------------------------------------------------------
REFTAB00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          PACK      KEY22,CLINICID,FRSTDATE,SP70
          CALL      RSOTRFL5
REFTAB10  CALL      RKOTRFL5
          BRANCH    OVRCD,REFTAB99          * end of file
          MATCH     CLINICID,OTRLCONS
          GOTO      REFTAB99 IF NOT EQUAL   * different consultant
          MATCH     OTRLDATE,LASTDATE
          GOTO      REFTAB99 IF LESS
          COMPARE   ZERO,OTRLTREF
          GOTO      REFTAB10 IF NOT EQUAL   * Not Outpatient Referral
.
          MATCH     "       0",OTRLURNO
          IF        @EQUAL
            MOVE      OTRLOUTN,KEY8           * visit number
            CALL      RDPRAM1
            MOVE      ZERO,PURNO
          ELSE
            PACK      KEY8,OTRLURNO           * r5
            CALL      RDMAST1
            IF        OVRCD=0
              MOVE      PURNO,KEY8
              CALL      RDPMPX21
              IF        OVRCD=1
                CALL      CLPMSPX2
              ENDIF
            ENDIF
          ENDIF
.
          CALL      PATNAM00
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          UNPACK    OTRLDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          MOVE      OTRLURNO,KEY8
          REP       " +",KEY8
          APPEND    KEY8,PATLINK
          APPEND    "&admissno=",PATLINK
          MOVE      OTRLOUTN,KEY8
          REP       " +",KEY8
          APPEND    KEY8,PATLINK
          RESET     PATLINK
.
          MOVE      OTRLPRIO,CODE
          MOVE      "PR",CATEGORY
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"t.addRow(#"",OTRLOUTN,"#",":
                             "#"",OTRLURNO,"#",":
                             "#"",OTRLDATE,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",DISPSEX,"#",":
                             "#"",PSAGEYRS,"#",":
                             "#"",OTRLDIAG,"#",":
                             "#"",TDESC,"#",":
                             "#"",PATLINK,"#");"
.
          GOTO      REFTAB10
.
REFTAB99  RETURN
.
.------------------------------------------------------------------------------
. Referral Letters Printing Details - Display Options
.------------------------------------------------------------------------------
PRDT0000  BRANCH    FLDITMNO,PRDT0010,PRDT0020
.
          GOTO      PRDT9999
.
PRDT0010  CALL      LTRSEL00           * Letter Selection List
          GOTO      PRDT9999
.
PRDT0020  WRITE     HTMLFILE;EOCRDIND; * Episodes of Care Redirect Indicator
          GOTO      PRDT9999
.
PRDT9999  RETURN
.
.------------------------------------------------------------
. Letter Selection List
.------------------------------------------------------------
LTRSEL00  MOVE      ZERO,OTLTLINO
          PACK      KEY6,OTLTLINO,SP70
          CALL      RSOTLET2
LTRSEL10  CALL      RKOTLET2
          BRANCH    OVRCD,LTRSEL99
.
          COMPARE   ZERO,OTLTLINO
          GOTO      LTRSEL99 IF NOT EQUAL
.
          MATCH     "R",OTLTTYPE            * Is this referral letter type?
          GOTO      LTRSEL10 IF NOT EQUAL   * No, skip this record.
.
          MATCH     "1",OTLTACTV                 * Skip Inactive
          GOTO      LTRSEL10 IF EQUAL
.
          MATCH     "1",OTLTCOMM                 * Skip if SMS
          GOTO      LTRSEL10 IF EQUAL
.
          MOVE      OTLTTEXT,KEY40
          PACK      KEY5,QUOTE,DOTLTLTN,QUOTE
          WRITE     HTMLFILE;"<option value=",KEY5,">",KEY40,"</option>"
          GOTO      LTRSEL10
.
LTRSEL99  RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
REFNXT00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          WRITE     HTMLFILE;"outweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE;
.
REFNXT99  RETURN
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
REFPRV00  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"outweb01.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&frstdate=",PREFDATE:                             
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE;
.                                                           
REFPRV99  RETURN
.------------------------------------------------------------
. Referral List 
.------------------------------------------------------------
LSTREF00  MATCH     SP70,WBSESIT
          GOTO      LSTREF95 IF EQUAL
          MATCH     SP70,WBSECLI
          GOTO      LSTREF95 IF EQUAL
          MOVE      WBSESIT,KEY6
          CALL      RDSITA1          * Read Site Record
          BRANCH    OVRCD,LSTREF95
.
          PACK      KEY20,WBSESIT,WBSECLI,Z70
          CALL      RDSCLIA1
          CALL      RDPCLIA1
          BRANCH    OVRCD,LSTREF95
.
          MATCH     WBSESIT,OCASITE
          GOTO      LSTREF95 IF NOT EQUAL
.
          MATCH     WBSECLI,OCACLIN
          GOTO      LSTREF95 IF NOT EQUAL
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     DISPNAME
          MOVE      OCADESC,NAME35
          CALL      NAMSTR00
          RESET     DISPNAME
          MOVE      DISPNAME,DOCFNAME
.
          MOVE      "Referral Letter Priority Processing",WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,LSTREF99
.
          WRITE     HTMLFILE;"<TABLE WIDTH=#"100%#" BORDER=0 ALIGN=CENTER>":
                             "<tr><td class=HeadingCell align=center><b>":
                             "Referral List for ",DOCFNAME,"</td>":
                             "</tr></TABLE>":
                             "<CENTER>":
                             "<TABLE BORDER=1 CELLSPACING=0 CELLPADDING=0 ":
                             "WIDTH=#"100%#" >":
                             "<tr>":
                             "<td class=HeadingCell ALIGN=CENTER>Date</td>":
                             "<td class=HeadingCell>Name</td>":
                             "<td class=HeadingCell align=center>Sex</td>":
                             "<td class=HeadingCell align=center>Age</td>":
                             "<td class=HeadingCell>Diagnosis</td>":
                             "<td class=HeadingCell>U/R No</td>":
                             "<td class=HeadingCell></td>":
                             "</tr>"
.
          PACK      KEY22,WBSECLI,SP30
          CALL      RSOTRFL5
LSTREF10  CALL      RKOTRFL5
          BRANCH    OVRCD,LSTREF90          * end of file
          MATCH     WBSECLI,OTRLCONS
          GOTO      LSTREF90 IF NOT EQUAL   * different consultant
          MATCH     SP3,OTRLPRIO
          GOTO      LSTREF10 IF NOT EQUAL   * already have a priority
          COMPARE   ZERO,OTRLTREF
          GOTO      LSTREF10 IF NOT EQUAL   * Not Outpatient Referral
.
          MATCH     "       0",OTRLURNO
          IF        @EQUAL
            MOVE      OTRLOUTN,KEY8           * visit number
            CALL      RDPRAM1
            MOVE      ZERO,PURNO
          ELSE
            PACK      KEY8,OTRLURNO           * r5
            CALL      RDMAST1
            IF        OVRCD=0
              MOVE      PURNO,KEY8
              CALL      RDPMPX21
              IF        OVRCD=1
                CALL      CLPMSPX2
              ENDIF
            ENDIF
          ENDIF
.
          CALL      PATNAM00
.
.* ****************************************** Start of Changes         *C-49016
          MOVE      PSEX,DSEXCHAR
          CALL      SEXDSC00                * get sex description (in IBACOMN)
.                                           *       returns DSEXDESC & DSEXNO
          MOVE      DSEXDESC,DISPSEX
.* ******************************************   End of Changes         *C-49016
.
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          UNPACK    OTRLDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          PACK      CASEKEYS,OTRLOUTN,SP70
          REP       " +",CASEKEYS
          MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          WRITE     HTMLFILE;"<tr>":
                             "<td ALIGN=CENTER NOWRAP>",CDAY,SP1,MTHNAM3:
                               SP1,CCENT,CYEAR,"</td>":
                             "<td NOWRAP>":
                               "<A HREF=outweb01.pbl?reportno=4":
                               "&template=",KEY3:
                               "&casekeys=",CASEKEYS,">":
                               "<img src=../images/patdet.gif align=absmiddle":
                               " BORDER=0></A>":
                               SP1,PATFNAME,"</td>":
                             "<td ALIGN=CENTER>",DISPSEX,"</td>":
                             "<td ALIGN=CENTER>",PSAGEYRS,"</td>":
                             "<td>",OTRLDIAG,"</td>":
                             "<td>",OTRLURNO,"</td>"
          GOTO      LSTREF10
.
LSTREF90  WRITE     HTMLFILE;"</TABLE></CENTER>"
          CALL      WEBEND00
          GOTO      LSTREF99
.
LSTREF95  MOVE      "INVALID SECURITY FOR REFERRAL PROCESSING",WEBTITLE
          CALL      WEBERR00
.
LSTREF99  RETURN
.------------------------------------------------------------
. Move in Variables passed back from Input Page
.------------------------------------------------------------
MVRFL000  MATCH      Z70,OTRFL001
          IF         !@EQUAL
            MOVE       OTRFL001,OTRLDATE
          ENDIF
.
          MATCH      Z70,OTRFL002 
          IF         !@EQUAL
            MOVE       OTRFL002,OTRLRDOC
          ENDIF
.
          MATCH      Z70,OTRFL003  
          IF         !@EQUAL
            MOVE       OTRFL003,OTRLSITE
          ENDIF
.
          MATCH      Z70,OTRFL004  
          IF         !@EQUAL
            MOVE       OTRFL004,OTRLCONS
          ENDIF
.
          MATCH      Z70,OTRFL005 
          IF         !@EQUAL
            MOVE       OTRFL005,OTRLDEPT
          ENDIF
.
          MATCH      Z70,OTRFL006
          IF         !@EQUAL
            MOVE       OTRFL006,OTRLDIAG
          ENDIF
.
          MATCH      Z70,OTRFL007
          IF         !@EQUAL
            MOVE       OTRFL007,OTRLPRIO
          ENDIF
.
          MATCH      Z70,OTRFL008
          IF         !@EQUAL
            MOVE       OTRFL008,OTRLUSD1
          ENDIF
.
          MATCH      Z70,OTRFL009
          IF         !@EQUAL
            MOVE       OTRFL009,OTRLUSD2
          ENDIF
.
          MATCH      Z70,OTRFL010
          IF         !@EQUAL
            MOVE       OTRFL010,OTRLUSD3
          ENDIF
.
          MATCH      Z70,OTRFL011
          IF         !@EQUAL
            MOVE       OTRFL011,OTRLUSD4
          ENDIF
.
          MATCH      Z70,OTRFL012
          IF         !@EQUAL
          ENDIF
.
          MATCH      Z70,OTRFL013
          IF         !@EQUAL
            MOVE       OTRFL013,OTRLRFGP
          ENDIF
.
          MATCH      Z70,OTRFL014
          IF         !@EQUAL
            MOVE       OTRFL014,OTRLGPPC
          ENDIF
.
          MATCH      Z70,OTRFL015
          IF         !@EQUAL
            MOVE       OTRFL015,OTRLGPPT
          ENDIF
.
          MATCH      Z70,OTRFL016
          IF         !@EQUAL
            MOVE       OTRFL016,OTRLRQST
          ENDIF
.
          MATCH      Z70,OTRFL017
          IF         !@EQUAL
            MOVE       OTRFL017,OTRLCDTE
          ENDIF
.
          MATCH      Z70,OTRFL018
          IF         !@EQUAL
            MOVE       OTRFL018,OTRLREAS
          ENDIF
.
          MATCH      Z70,OTRFL019
          IF         !@EQUAL
            MOVE       OTRFL019,OTRLSPFC
          ENDIF
.
          MATCH      Z70,OTRFL020
          IF         !@EQUAL
            MOVE       OTRFL020,OTRLCAD1
          ENDIF
.
          MATCH      Z70,OTRFL021
          IF         !@EQUAL
            MOVE       OTRFL021,OTRLCAD2
          ENDIF
.
          MATCH      Z70,OTRFL022
          IF         !@EQUAL
            MOVE       OTRFL022,OTRLCAD3
          ENDIF
.
          MATCH      Z70,OTRFL023
          IF         !@EQUAL
            MOVE       OTRFL023,OTRLCAD4
          ENDIF
.
          MATCH      Z70,OTRFL024
          IF         !@EQUAL
            MOVE       OTRFL024,OTRLCPC
          ENDIF
.
          MATCH      Z70,OTRFL025
          IF         !@EQUAL
            MOVE       OTRFL025,OTRLECRN
          ENDIF
.
          MATCH      Z70,OTRFL026
          IF         !@EQUAL
            MOVE       OTRFL026,OTRLGPFH
          ENDIF
.
          MATCH      Z70,OTRFL027
          IF         !@EQUAL
            MOVE       OTRFL027,OTRLCTYP
          ENDIF
.
          MATCH      Z70,OTRFL028
          IF         !@EQUAL
            MOVE       OTRFL028,OTRLSRCE
          ENDIF
.
          MATCH      Z70,OTRFL029
          IF         !@EQUAL
            MOVE       OTRFL029,OTRLRHCP
          ENDIF
.
          MATCH      Z70,OTRFL030
          IF         !@EQUAL
            MOVE       OTRFL030,OTRLDREC
          ENDIF
.
          MATCH      Z70,OTRFL031
          IF         !@EQUAL
            MOVE       OTRFL031,OTRLDPRI
          ENDIF
.
          MATCH      Z70,OTRFL032
          IF         !@EQUAL
            MOVE       OTRFL032,OTRLPURC
          ENDIF
.
          MATCH      Z70,OTRFL033
          IF         !@EQUAL
            MOVE       OTRFL033,OTRLRANK
          ENDIF
.
          MATCH      Z70,OTRFL034  
          IF         !@EQUAL
            MOVE       OTRFL034,OTRLTREF
          ENDIF
.
          MATCH      Z70,OTRFL035  
          IF         !@EQUAL
            MOVE       OTRFL035,OTRLOPER
          ENDIF
.
          MATCH      Z70,OTRFL036  
          IF         !@EQUAL
            MOVE       OTRFL036,OTRLBSIT
          ENDIF
.
          MATCH      Z70,OTRFL037  
          IF         !@EQUAL
            MOVE       OTRFL037,OTRLBCLI
          ENDIF
.
          MATCH      Z70,OTRFL038  
          IF         !@EQUAL
            MOVE       OTRFL038,OTRLBDTE
          ENDIF
.
          MATCH      Z70,OTRFL039  
          IF         !@EQUAL
            MOVE       OTRFL039,OTRLBSTR
          ENDIF
.
          MATCH      Z70,OTRFL040  
          IF         !@EQUAL
            MOVE       OTRFL040,OTRLBSLT
          ENDIF
.
          MATCH      Z70,OTRFL041
          IF         !@EQUAL
            MOVE       OTRFL041,OTRLCLAM
          ENDIF
.
          MATCH      Z70,OTRFL042
          IF         !@EQUAL
            MOVE       OTRFL042,OTRLTRGS
          ENDIF
.
          RETURN
.
.------------------------------------------------------------
. Find Slot
.------------------------------------------------------------
FINDSL00  MATCH     SP70,SRCHDATE
          GOTO      FINDSL90 IF EQUAL
          MATCH     SP70,CLINICID
          GOTO      FINDSL91 IF EQUAL
          MATCH     SP70,CLINICTY
          GOTO      FINDSL92 IF EQUAL
          MATCH     SP70,SRCHTIME
          GOTO      FINDSL93 IF EQUAL
.
          MOVE      SRCHTIME,KEY5
.
          PACK      KEY28,WBSESIT,CLINICID,SRCHDATE,SP70
          CALL      RDSBOKA1
FINDSL10  CALL      RDKBOKA1                * next read on details file
          BRANCH    OVRCD,FINDSL94          * end of session
          MATCH     WBSESIT,OBASITE
          GOTO      FINDSL94 IF NOT EQUAL
          MATCH     CLINICID,OBACLIN
          GOTO      FINDSL94 IF NOT EQUAL
          MATCH     SRCHDATE,OBADATE
          GOTO      FINDSL94 IF NOT EQUAL
..          MATCH     CLINICTY,OBACTYP
..          GOTO      FINDSL10 IF NOT EQUAL
          MATCH     SRCHTIME,OBATIME
          GOTO      FINDSL10 IF NOT EQUAL
          COMPARE   ZERO,OBASTAT
          GOTO      FINDSL95 IF NOT EQUAL
.
          PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          WRITE     HTMLFILE;CASEKEYS;
.
          GOTO      FINDSL99
.
FINDSL90  WRITE     HTMLFILE;"Invalid Search Date ";
          GOTO      FINDSL99
.
FINDSL91  WRITE     HTMLFILE;"Invalid Clinic ID ";
          GOTO      FINDSL99
.
FINDSL92  WRITE     HTMLFILE;"Invalid Clinic Type ";
          GOTO      FINDSL99
.
FINDSL93  WRITE     HTMLFILE;"Invalid Search Time ";
          GOTO      FINDSL99
.
FINDSL94  WRITE     HTMLFILE;"No Match Found ";
          GOTO      FINDSL99
.
FINDSL95  WRITE     HTMLFILE;"Invalid Slot Status - Not Available for Booking";
          GOTO      FINDSL99
.
FINDSL99  RETURN
.
.
.------------------------------------------------------------
. Visit Type Selection Options
. Category CV - Indictor 6 ="U"navailable slot type
.------------------------------------------------------------
VTYSEL00  MOVE      "CV",CATEGORY
          MOVE      SP70,TDESC
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      CATEGORY,TCODE
            MOVE      "Invalid Category",TDESC
          ENDIF
          REP       " _",TCODE
          REP       " _",THCSCOD
          WRITE     HTMLFILE;"<!--<cat-c category=#"",TCODE,"#" name=#"",TDESC:
                             "#" map=#"",THCSCOD,"#"></cat-c>-->"
.
          PACK      PTCDKEY2,CATEGORY,SP70
          CALL      RDSCODE2
VTYSEL10  CALL      RDKCODE2
          BRANCH    OVRCD,VTYSEL99
.
          MATCH     CATEGORY,TCODE
          GOTO      VTYSEL99 IF NOT EQUAL
.
          MATCH     SP70,ACODE
          GOTO      VTYSEL10 IF EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      VTYSEL10 IF EQUAL
.
          IF        VISTFLAG=1
            MATCH     "U",TCINDC6
            GOTO      VTYSEL10 IF NOT EQUAL
          ELSE
            MATCH     "U",TCINDC6
            GOTO      VTYSEL10 IF EQUAL
.
            MATCH     ANSZ,TCINDC2
            GOTO      VTYSEL10 IF EQUAL
          ENDIF
.
          PACK      KEY15,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5:
                          TCINDC6,TCINDC7,TCINDC8,TCINDC9,TCINDC10:
                          TCINDC11,THCSCOD
          PACK      KEY20,QUOTE,ACODE,KEY15,QUOTE
          MATCH     CODE,ACODE
          IF        @EQUAL
            IF        PTCNHDPS=1
              MATCH     "N",TCINDC9
              GOTO      VTYSEL90 IF EQUAL
            ENDIF
            WRITE     HTMLFILE;"<option value=",KEY20," selected>":
                               TDESC,"</option>"
            GOTO      VTYSEL10
          ENDIF
.
          IF        IBCNMHOS=1
            MATCH    "1",PTCDHOSS
            IF       @EQUAL
              PACK     KEY8,WBSEHOSP,TCODE,ACODE,SP70
              CALL     RDMLCOD1
              BRANCH   OVRCD,VTYSEL10
            ENDIF
          ENDIF
.
VTYSEL90  WRITE     HTMLFILE;"<option value=",KEY20,">",TDESC,"</option>"
          GOTO      VTYSEL10
.
VTYSEL99  RETURN
.
