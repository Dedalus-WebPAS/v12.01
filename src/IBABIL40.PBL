.******************************************************************************
.* System         : Patient Billing                                           *
.* Program        : IBABIL40.PBL                                              *
.* Name           : Schedule and Print Inpatient Invoices                     *
.******************************************************************************
.* Date           : 31/08/2015                                                *
.* Author         : J.Tan                                                     *
.* Function       : This program enables users to raise Inpatient, Outpatient *
.*                  and Emergency invoices in bulk                            *
.* Modifications  :                                                           *
.*                                                                            *
.*----------------------------------------------------------------------------*
.*        V12.01.01 16/02/2026  J.Tan          TSK 0946305                    *
.*                  Removed array of ADMISSNO variable                        *
.*        V12.00.05 10/10/2025  J.Tan          TSK 0946593                    *
.*                  Recompiled for PATCATBI-Sort Casepayment Theatre fee items*
.*        V12.00.04 30/09/2025  Thanh T        TSK 0937505                    *
.*                  Recompiled for PATINVHL changes                           *
.*        V12.00.03 17/07/2025  J.Tan          TSK 0961277                    *
.*                  Recompiled for PATCATBI-Chk if Accom.included in Pat.inv. *
.*                  22/07/2025  J.Tan          TSK 0963587                    *
.*                  Recompiled for PINCATBI-Chk if pat.is disch.& invoiced    *
.*        V12.00.02 23/06/2025  J.Tan           TSK 0961623                   *
.*                  Recompiled for PATINVS - added DDRGCODE for GETDRG        *
.*        V12.00.01 20/05/2025  Ebon Clements    TSK 0955096                  *
.*                  Alphanueric visit number changes                          *
.*        V11.05.01 24/02/2025  J.Tan            TSK 0946490                  *
.*                  Recompiled for PATCATBI - Added PMSHATFD/IO               *
.*        V11.04.10 07/11/2024 Thanh T          TSK 0946085                   *
.*                  Recompiled for RCPCONFD changes                           *
.*        V11.04.09 25/10/2024 J.Tan             TSK 0951578                  *
.*                  Recompiled for ABFPTINV-Added Min.to roundup ICU Hrs(ABF) *
.*        V11.04.08 04/10/2024  J.Tan          TSK 0951441                    *
.*                  Recompiled for PATCATBI - Charging AddOn for NoPayDay     *
.*        V11.04.07 23/09/2024  J.Tan          TSK 0949848                    *
.*                  Recompiled for ABFPTINV - DRG List used in for COVID Adjus*
.*        V11.04.06 20/09/2024 J.Tan           TSK 0950577                    *
.*                  Recompiled for PATIPERH - Fixed Hold Invoice audit issue  *
.*        V11.04.05 11/09/2024  J.Tan          TSK 0947315                    *
.*                  Recompiled for ABFPTINV - fixed Total Unqualified         *
.*        V11.04.04 01/08/2024  J.Tan          TSK 0947804                    *
.*                  Recompiled for ABFMHINV - Changes for Disch.after 1/7/2023*
.*        V11.04.03 17/07/2024  J.Tan          TSK 0947315                    *
.*                  Recompiled for ABFPTINV (LOS ICU adjusted & Newborn)      *
.*        V11.04.02 14/03/2024  J.Tan          TSK 0910994                    *
.*                  Recompiled for CMXMATRX                                   *
.*        V11.04.01 29/01/2024  Jacob Jackson  TSK 0919335                    *
.*                  Add HF History includes and new variable for GETTFEES     *
.*        V11.03.09 17/11/2023  J.Tan          TSK 0940089                    *
.*                  Recompiled for ABFPTINV - checking for blank Disc.DRG     *
.*        V11.03.08 13/11/2023  J.Tan          TSK 0939019                    *
.*                  Recompiled for ABFPTINV - HAC ICD10 Edition 12            *
.*        V11.03.07 08/11/2023  Nikitha B      TSK 0927699c                   *
.*                  Read CAPPRVNO and PTCNHABN for Hospital Approval and      *
.*                  ABN number.                                               *
.*        V11.03.06 04/10/2023  Nikitha B     TSK 0927699                     *
.*                  Recomplied for PATINVHL, PATINVTL - Stationary variables  *
.*        V11.03.05 04/10/2023  J.Tan          TASK 0938230                   *
.*                  Recompiled for ABFAECCL - Emergency ABF                   *
.*        V11.03.04 29/08/2023  J.Tan          TSK 0916870                    *
.*                  Recompiled for ABFPTINV - Claim code Multiple NEP value   *
.*        V11.03.03 15/06/2023  Bella Turco    TSK 0931756                    *
.*                  Recompiled for PRTINVBD                                   * 
.*        V11.03.02 15/06/2023  J.Tan          TSK 0923703                    *
.*                  Recompiled for ABF new calculations                       *
.*        V11.03.01 05/04/2023  Bella Turco    TSK 0911166                    *
.*                  Recompiled for PATIPERH - Hold Invoice Audit              *
.*        V11.02.05 10/10/2022  Peter Vela          0925622                   *
.*                  Recompiled for PATINVS - Removed old Eclipse IHC from     *
.*                  Inpatient Invoicing                                       *
.*        V11.02.04 20/02/2022  Thanh T        TSK 0908346                    *
.*                  Added CHKCLDCP,GINP2100,CHKDCI00,CHKDCO00,CHKDCE00 to     *
.*                  Claim Type/Clinical Document Mapping table if the Invoice *
.*                  can be printed                                            *
.*        V11.02.03 29/06/2022 J.Tan           TSK 0920712                    *
.*                  Recompiled for ABFAECCL - I*D on emrvcdaf file            *
.*        V11.02.02 03/03/2022  J.Tan           TSK 0902652                   *
.*                  Recompiled for OUTCATBI/AAECATBI-Pat.Inv.new functionality*
.*        V11.02.01 09/02/2022  Thanh T       TSK 0905641                     *
.*                  Recompiled as OUTMA1FD changes                            *
.*        V11.01.17 08/11/2021 J.Tan           TSK 0880410                    *
.*                  Recompiled for PATIPERH - added Hospital and System       *
.*        V11.01.16 17/11/2021  J.Tan          TSK 0913621                    *
.*                  Recompiled for ABFPTINV - Mod for Multiple NEP Values     *
.*        V11.01.15 28/10/2021 J.Tan           TSK 0913056                    *
.*                  Recompiled for ABFAECCL-ADMFLAG and CCAR0000(Clinical Care*
.*        V11.01.14 13/10/2021 J.Tan           TSK 0905305                    *
.*                  Recompiled for ABFAECCL - Adjustment type 068 & 069       *
.*        V11.01.13 29/09/2021  J.Tan          TSK 0901515                    *
.*                  Recompiled for CMXMATRX - Added Primary Proc.to Matrix    *
.*        V11.01.12 14/09/2021  J.Tan          TSK 0906222                    *
.*                  Recompiled for ABFPTINV - Mod for Multiple NEP Values     *
.*        V11.01.11 14/09/2021  Davin           TSK 0911277                   *
.*                  Recompiled for PRTINVBD                                   *
.*        V11.01.10 10/09/2021  Davin           TSK 0911277                   *
.*                  Recompiled for PATINVTL - Changed field 20 length to 12.2 *
.*        V11.01.09 09/08/2021  J.Tan           TSK 0905305                   *
.*                  Recompiled for AAECATBI - AE Care class for 2021/2022     *
.*                  31/08/2021  J.Tan           TSK 0910799                   *
.*                  Recompiled for PRTINVBD - printing Referring ADF          *
.*        V11.01.08 24/08/2021  Davin          TSK 0897318                    *
.*                  Recompiled for PATINVTL - added field 57(Adjustment Total)*
.*                  25/08/2021  J.Tan           TSK 0903454                   *
.*                  Recompiled for PATCATBI -Claim code to LS/Daily(CACCFEE=4)*
.*        V11.01.07 03/08/2021  J.Tan           TSK 0909724                   *
.*                  Recompiled for PRTINVBD - SJOG invoice                    *
.*        V11.01.06 07/07/2021  J.Tan           TSK 0908588                   *
.*                  Recompiled for PATCATBI - Exclude Unqualified days for C/P*
.*        V11.01.05 16/06/2021  Peter Vela     TSK 0907637                    *
.*                  Recompiled for PATINVS                                    *
.*        V11.01.04 28/04/2021  Thanh T        TSK 0895165                    *
.*                  Recompiled for OPRARDFD changes                           *
.*                  01/04/2021  Peter Vela     Task 0902857                   *
.*                  Recompiled for WEBIHCFD - Added Index 8                   *
.*                  07/04/2021  Tracey Nguyen   TSK 0901515                   *
.*                  Recompiled for PMSCMTFD - Added new fields                *
.*                  a) 1 File type for ICD procedure (PMCCIPF)                *
.*                  b) 3 new CMBS Field Type (PMCCFTS4/PMCCFT5C/PMCCFT6C)     *
.*                  c) 3 new CMBS Codes From (PMCCPC4F,PMCCSC5F,PMCCTC6F)     *
.*                  d) 3 new CMBS Codes To   (PMCCPC4T/PMCCSC5T,PMCCTC6T)     *
.*                  27/04/2021  J.Tan           TSK 0863287                   *
.*                  Mod for Patient Invoice new functionality                 *
.*        V11.01.03 23/03/2021  Peter Vela     Task 0902857                   *
.*                  Recompiled for PATINVS - WebServices IHCW                 *
.*        V11.01.02 10/03/2021  Tracey Nguyen   TSK 0901515                   *
.*                  Recompiled for PMSCMTFD - Added Primary ICD Procedure 1-5 *
.*                  (PMCCICP1-5)                                              *
.*        V11.01.01 17/02/2021  Tracey Nguyen  TSK 0888639                    *
.*                  Recompiled for PATMMBFD changes                           *
.*                  22/02/2021  Peter Vela     Task 0902857                   *
.*                  Recompiled for PATINVS - WebServices IHCW                 *
.******************************************************************************
.*        V11.00.14 19/01/2021  J.Tan          TSK 0883075                    *
.*                  Recompiled for PRTINVBD - mod to print ADF addr.on invoice*
.*        V11.00.13 10/11/2020  J.Tan           TSK 0899562                   *
.*                  Recompiled for CMXMATRX - setup date for reading MBS item *
.*        V11.00.12 22/10/2020  J.Tan           TSK 0898866                   *
.*                  Recompiled for PATIPERH - on hold invoice                 *
.*        V11.00.11 14/10/2020  J.Tan          TSK 0894879                    *
.*                  Recompiled for PRTINVBD - Print 30 item desc.for RCH Inv. *
.*        V11.00.10 29/09/2020  J.Tan          TSK 0896829                    *
.*                  Recompiled for CMXMATRX - use National(PTPGNDRG)DRG       *
.*        V11.00.09 22/09/2020  J.Tan           TSK 0895330                   *
.*                  Recompiled for CMXMATRX - reposition read of Matrix table *
.*        V11.00.08 20/07/2020  J.Tan           TSK 0892319                   *
.*                  Recompiled for ABFPTINV - Additional NEP and Psych.Adjus. *
.*        V11.00.07 14/07/2020  J.Tan          TSK 0892902                    *
.*                  Recompiled for PATCATBI - Mod to initialise CASMXKEY      *
.*        V11.00.06 01/07/2020  J.Tan           TSK 0892765                   *
.*                  Recompiled for PATCATBI-Low outlier exc. unqualified days *
.*                  05/07/2020  J.Tan           TSK 0892746                   *
.*                  Recompiled for ABFPTINV - CALCAGE as at Admission date    *
.*        V11.00.05 29/06/2020  J.Tan           TSK 0893767                   *
.*                  Recompiled for ABFPTINV - Changed CALCFLAG to 01/01/2021  *
.*        V11.00.04 20/04/2020 J.Tan           TSK 0890733                    *
.*                  Recompiled for ABFPTINV - ABF new 2020 calculation        *
.*        V11.00.03 07/05/2020  J.Tan            TSK 0891341                  *
.*                  Recompiled for ABFOTINV - added TRAP to write pmsabfaf    *
.*        V11.00.02 08/04/2020 J.Tan           TSK 0868813                    *
.*                  Recompiled for PATINVHL                                   *
.*                  15/04/2020 Thanh T         TSK 0879163                    *
.*                  Added SEXDSP00                                            *
.*        V11.00.01 12/03/2020  J.Tan          TSK 0838262                    *
.*                  Added PATITMRD                                            *
.*        V10.15.01 11/10/2019  Peter Vela       TSK 0882906                  *
.*                  Recompiled for OUTCATBI - Fixed I*C for OUTBB1 ABF        *
.*        V10.14.03 09/09/2019  J.Tan           TSK 0857392                   *
.*                  Recompiled for ABF invoice                                *
.*        V10.14.02 05/08/2019  J.Tan           TSK 0857392                   *
.*                  Recompiled for ABF Invoices                               *
.*        V10.14.01 21/05/2019  J.Tan           TSK 0857392                   *
.*                  Recompiled for ABF Invoices                               *
.*        V10.13.03 11/01/2019  Peter Vela     TSK 0867807                    *
.*                  Recompiled for OUTCATBI                                   *
.*        V10.13.02 26/10/2018  Thanh T        TSK 0859743                    *
.*                  Added BULKBILL field and removed OUTHEDFD/OUTHEDIO,       *
.*                  OUTSESFD/OUTSESIO for OUTCATBI changes                    *
.*        V10.13.01 25/10/2018  Thanh T        TSK 0859743                    *
.*                  Added OUTHEDFD/OUTHEDIO, OUTSESFD/OUTSESIO for OUTCATBI   *
.*                  changes                                                   *
.*----------------------------------------------------------------------------*
.*        V10.12.03 18/07/2018  J.Tan          TSK 0859911                    *
.*                  Recompiled for PATCATBI - Fixed No Payday Add on charge   *
.*        V10.12.02 18/06/2018  Ebon Clements  TSK 0846868                    *
.*                  Recompiled for PATINVS - Eclipse exclude claim type       *
.*        V10.12.01 28/02/2018  J.Tan          TSK 0852351                    *
.*                  Recompiled for PATINVHL-fields 226 227(Program Code/Desc) *
.*        V10.11.03 07/09/2017  J.Tan         TSK 0837479                     *
.*                  Recompiled for CMXMATRX - Consumption type items          *
.*        V10.11.02 24/08/2017  Thanh T.              TSK 0821710             *
.*                  Removed PATCMNTS                                          *
.*        V10.11.01 10/08/2017  Peter Vela            TSK 0837619             *
.*                  Recompiled for PATINVS                                    *
.*----------------------------------------------------------------------------*
.*        V10.10.02 13/06/2017  J.Tan          TSK 0839991                    *
.*                  Recompiled for PATDBTYP (PATCMSTP)                        *
.*        V10.10.01 25/01/2017  J.Tan          TSK 0832407                    *
.*                  Recompiled for PATCATBI- multi bed trans on sameday for MV*
.*                  04/04/2017  J.Tan         TSK 0297904                     *
.*                  Recompiled for PATCMSTP - Non-Accumulative inlier ICU/CCU *
.*        V10.08.08 06/10/2016  J.Tan         TSK 0826824                     *
.*                  Recompiled for CALCMVHR - MV Hours                        *
.*        V10.08.07 21/09/2016  J.Tan         TSK 0826370                     *
.*                  Recompiled for CMXMATRX - Chgd MCHGARR MCHGAMT array to F3*
.*        V10.08.06 26/08/2016  Don Nguyen    TSK 0312570                     *
.*                  Recompiled for CMXMATRX - Added check for PTCNDGED=1      *
.*                  Added PMSEDGFD/IO and GETEFDRG                            *
.*        V10.08.05 17/08/2016  J.Tan         TSK 0808745                     *
.*                  Recompiled for PATCATBI - for NPDAYFLG=1                  *
.*        V10.08.04 20/07/2016  J.Tan         TSK 0819914                     *
.*                  Recompiled for PATCATBI - Non ICU MV Hours                *
.*        V10.08.03 15/07/2016  J.Tan         TSK 0819914                     *
.*                  Recompiled for PATCATBI - Calculating non ICU MV hours    *
.*        V10.08.02 20/06/2016  J.Tan         TSK 0820816                     *
.*                  Recompiled for PATCATBI - Fixed No payday for Daycase     *
.*        V10.08.01 02/06/2016  J.Tan         TSK 0816651                     *
.*                  Recompiled for PATCATBI -Continuous Bill.to chk for Matrix*
.*        V10.07.02 04/03/2016  J.Tan         CAR 290448                      *
.*                  Recompiled for PATCATBI - Mods for Addon with No Pay DAy  *
.*        V10.07.01 18/11/2015  J.Tan         CAR 303942                      *
.*                  Added new payment types                                   *
.*                  V10.06.02 20/09/2015 J.Tan  CAR 317216                    *
.*                  Mods Emergency to check check discharge date range        *
.*                  V10.06.01 28/09/2015 J.Tan  CAR 317216                    *
.*                  Mods to print heading No charges even if no data to print *
.*                  and default HF outpatient and emergency from master file  *
.*                  V10.06.00 31/08/2015 J.Tan  CAR 317216                    *
.*                  Created program                                           *
.******************************************************************************
+
. FILE DESCRIPTION INCLUDES
. -------------------------
.
          INC       STD001FD
          INC       STDHLPDF
          INC       STDKWSDF
          INC       RSHWEBDF
          INC       CHKDIGVR/INC
          INC       PABXVARS/INC
          INC       PATCOMM/INC
          INC       TFILEVAR/INC                 * Generate Temp File Name
          INC       WEBERRFD/INC                 * Web Server Error Logging
          INC       WEBSECFD/INC
.
          INC       CHKCLDCD/INC
          INC       IBAPOLFD/INC
          INC       PATSTAFD/INC
          INC       PATAA1FD/INC
          INC       AAEDE1FD/INC
          INC       AAEDTRFD/INC
          INC       AAECONFD/INC
          INC       BOKRC1FD/INC
          INC       EMRSITFD/INC
          INC       EMRHISFD/INC
          INC       EMRVISFD/INC
          INC       IBACONFD/INC
          INC       IBAGSTFD/INC
          INC       IBAGEDFD/INC
          INC       IBAPRNFD/INC
          INC       IBATMDFD/INC
          INC       IBATMHFD/INC
          INC       IBAPDFFD/INC
          INC       NZHISIFD/INC       * for NZIBSRCH
.
          INC       COMDEPFD/INC
          INC       OUTBB1FD/INC
          INC       OUTBOAFD/INC
          INC       OUTCLIFD/INC
          INC       OUTDTRFD/INC
          INC       OUTSITFD/INC
          INC       OUTCTYFD/INC
          INC       OUTPREFD/INC
          INC       OPRARDFD/INC
          INC       OPRDEAFD/INC
          INC       OPRDECFD/INC
          INC       OPRSRGFD/INC
          INC       MLTCFNFD/INC
          INC       NZPEXTFD/INC
          INC       NZPRDTFD/INC
          INC       NZPBFEFD/INC
          INC       NZPCFNFD/INC
          INC       NZPCMTFD/INC
          INC       NZPFIGFD/INC
          INC       NZPFINFD/INC
          INC       NZPIBRFD/INC
          INC       NZPIRNFD/INC
          INC       NZPMCHFD/INC
          INC       NZPMXCFD/INC
          INC       NZPPFEFD/INC
          INC       NZPRBRFD/INC
          INC       NZPRFNFD/INC
          INC       NZPPICFD/INC
          INC       NZPSPRFD/INC
          INC       NZPTFEFD/INC
          INC       NZPIVBFD/INC
          INC       NZPRVBFD/INC
          INC       OPRSESFD/INC
.
          INC       PATELGFD/INC
          INC       PATINMFD/INC
          INC       PATRATFD/INC
          INC       PATREMFD/INC
          INC       PATCALAG/INC
          INC       PATCFAFD/INC
          INC       PMSABFFD/INC
          INC       PMSPWAFD/INC
          INC       PMSICMFD/INC
          INC       PMSCIDFD/INC
          INC       PMSCCDFD/INC
          INC       PMSTLEFD/INC
          INC       PATCRAFD/INC
          INC       PATCURFD/INC
          INC       PATALWFD/INC       * Allowances file
          INC       PATBFEFD/INC
          INC       PATCODFD/INC
          INC       PATCONFD/INC
          INC       PATDINVS/INC
          INC       PATDO1FD/INC
          INC       PATDSCFD/INC
          INC       PATDRGFD/INC
          INC       PATDTRFD/INC
          INC       PATECOFD/INC
          INC       PATECDFD/INC
          INC       PATECHFD/INC
          INC       PATEDSFD/INC
          INC       PATEDTFD/INC
          INC       PATFACFD/INC
          INC       PATFEEFD/INC
          INC       PATFINFD/INC
          INC       PATFMOFD/INC
          INC       PATFN1FD/INC
          INC       PATFN2FD/INC
          INC       PATFIGFD/INC
          INC       PATFX1FD/INC
          INC       PATFHIFD/INC
          INC       PATGTUFD/INC
          INC       PATIBLFD/INC
          INC       PATICDFD/INC
          INC       PATICUFD/INC
          INC       PATINLFD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATIOVFD/INC
          INC       PATIPEFD/INC
          INC       PATIPRFD/INC
          INC       PATIRNFD/INC
          INC       PATITMFD/INC       * Item file
          INC       PATJRNFD/INC
          INC       PATMA1FD/INC
          INC       PMSEVTFD/INC
          INC       PMSHATFD/INC
          INC       PMSHCPFD/INC
          INC       PMSPX2FD/INC
          INC       PATMMBFD/INC
          INC       PATMCHFD/INC
          INC       PATMI1FD/INC
          INC       PATNOBFD/INC
          INC       PATOVBFD/INC
          INC       PATPGRFD/INC
          INC       NHIMASFD/INC       * for PATSRCH
          INC       PATPR1FD/INC
          INC       PATRBLFD/INC
          INC       PATRCAUD/INC
          INC       PATRE1FD/INC
          INC       PATRFNFD/INC
          INC       PATRFGFD/INC
          INC       PATSGCFD/INC
          INC       PATSRBFD/INC
          INC       PATGSRFD/INC
          INC       PATTFEFD/INC
          INC       PATTRDAT/INC
          INC       PATTRNFD/INC
          INC       PATVENFD/INC
          INC       PATVISFD/INC
          INC       PATWC1FD/INC
          INC       PATWMAFD/INC
          INC       PATWR1FD/INC
          INC       PATWVEFD/INC
          INC       PMSSINFD/INC
          INC       PATCMTFD/INC
          INC       PMSCMTFD/INC
          INC       PMSECTFD/INC
          INC       PMSVX1FD/INC
          INC       PMSCNOFD/INC
          INC       PMSFCIFD/INC
          INC       PMSSGAFD/INC
          INC       PMSMTIFD/INC
          INC       PMSMPRFD/INC
          INC       PMSBBIFD/INC
          INC       PMSBISFD/INC
          INC       VISPAYFD/INC
          INC       PRIITMFD/INC
          INC       PATHTRFD/INC
          INC       EMRHTRFD/INC
          INC       OUTHTRFD/INC
.
          INC       PATAFEFD/INC
          INC       PATASDFD/INC
          INC       PATCMXFD/INC         * casemix files
          INC       PATCTFFD/INC
          INC       PATDGWFD/INC
          INC       PATHDFFD/INC
          INC       PATHLFFD/INC
          INC       PATHSPFD/INC
          INC       PATLDFFD/INC
          INC       PATLSDFD/INC
          INC       PATONHFD/INC
          INC       PMSEXTFD/INC
          INC       PMSPRGFD/INC
.
          INC       RCPCONFD/INC
.
          INC       PATDNRFD/INC
          INC       PATSDNFD/INC
          INC       PATSMWFD/INC
          INC       PATNIDFD/INC
          INC       PATALRFD/INC
          INC       PMSPYRFD/INC
          INC       PMSPBRFD/INC
          INC       PMSIDEFD/INC
          INC       PMSIVBFD/INC
.
          INC       RCPBNKFD/INC
          INC       RCPDTEFD/INC
          INC       RCPBDTFD/INC
          INC       RCPCRSFD/INC
          INC       PATDHEAD/INC
          INC       SCRPSTFD/INC
          INC       VARGBCRN/INC
          INC       WEBCONFD/INC
          INC       WEBSCHFD/INC
          INC       WEBIHCFD/INC
          INC       PMSEDGFD/INC       * Effective DRG Dates
          INC       PATDDHFD/INC
+
EXCPFIL1  IFILE     SQL, FIXED=52, KEY="u1-1,10-17"
EXCPFIL2  IFILE     SQL, FIXED=52, KEY="u1-1,2-9,10-17"
.
.Name     Type      Length  Phys.  Start  Description
.-------  ----      ------  -----  -----  ----------------------------------
RECTYPE    DIM       1          1       1  Record type 1=No Charge,2=Raise Inv
.AURNO     DIM       8          8       2  PATIENT U.R NO.
.DAADMNO   DIM       8          8      10  PATIENT ADMISSION NO.
.AFUNDH    DIM       6          6      18  PATIENT HEALTH FUND
CASEKEYS   DIM      28         28      24  Casekeys for Outpatient
.EOF                                   52
.
.
. LOCAL VARIABLE DEFINITION
. -------------------------
.
CLAIMTYP  DIM       3
CLMDESC   DIM       6
CLAIMDES  DIM       20
EXCLINVD  FORM      1
.
DSPSTDTE  DIM       10                      * Display start date (dd/mm/ccyy)
DSPEDDTE  DIM       10                      * Display end  date (dd/mm/ccyy)
STRTDTE   DIM       8                       * Start date (ccyymmdd)
ENDDTE    DIM       8                       * End date (ccyymmdd)
.ERASE     INIT      "iserase "
.ISBUILD   INIT      "isbuild "
UKEY1     INIT      " 52 u1-1,10-17 u1-1,2-9,10-17" 
.
ATTDSTAT  DIM       1
ACTNCODE  DIM       3
ACTNPLAN  DIM       1
.
ACTION    DIM       1                       * Action for PATAA1FD
ADD       DIM       2                       * Day for PATAA1FD
AMM       DIM       2                       * Month for PATAA1FD
AYY       DIM       2                       * Year for PATAA1FD
ACC       DIM       2                       * Century for PATAA1FD
ADMNDATE  DIM      10
AADMNOX   DIM       8
ADIAG     DIM       50
ADMISSNO  DIM       8
XDESC     DIM       30
BFAMT     FORM      8.2                                               *C-111521
.
CSTRTYR   DIM       8
CDYSDAYS  FORM      6                       * CALCDAYS number of days
CDYSFDTE  DIM       8                       * CALCDAYS from date
CDYSTDTE  DIM       8                       * CALCDAYS to date
CDYSYEAR  FORM      2                       * CALCDAYS year
CERTINDC  FORM      1
CHGFLAG   FORM      1
CALDAYS   FORM      3
CHOICE    FORM      2
CMDLINE   DIM       80
BULKBILL  DIM       1
.
CN        INIT      "CN"
CODE      DIM       2
CATCR     INIT      "cr"
CODEA     INIT      "A "
CODEBT    INIT      "BT"
CODECL    INIT      "CL"
CODEDP    INIT      "DP"
CODEFA    INIT      "FA"
CODEPY    INIT      "Py"
COUNTER   FORM      2
CURPAGE   FORM      2                  * used by comments maintenance
CURSESS   DIM       18
CURRDATE  DIM       8
.
DOWNCASE  INIT      "AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz"
DISPNAME  DIM       60
DAYSDIFF  FORM      2
DISCDATE  DIM       10
DIM1A     DIM       1
DIM2A     DIM       2
.DIM3      DIM       3
DIM4      DIM       4
DIM9      DIM       9
DIM12     DIM       12
DIM12A    DIM       12
DIM14     DIM       14
DIM14A    DIM       14
DIM18     DIM       18
DIM18A    DIM       18
DIM24A    DIM       24
DIM30     DIM       30
DIMC01    DIM       8
DIMC02    DIM       8
DIMC03    DIM       8
DIMC04    DIM       8
DIMC05    DIM       8
DIMC06    DIM       8
DIMC07    DIM       8
DIMC08    DIM       8
DIMC09    DIM       8
DIMC10    DIM       8
DIMC11    DIM       8
DIMC12    DIM       8
DIMC13    DIM       8
DIMC14    DIM       8
DIM5A     DIM       5
DNAME     DIM       20
DOCTCODE  DIM       6
DOCFNAME  DIM       50
DDRGCODE  DIM       4
.
EMCNDPOC  DIM       1
EMCNOPOC  DIM       15
EMCNGINV  DIM       1
ENDDAT    DIM       6
ENDNAM    DIM       6
ENDSEC    FORM      5
EXPCHCNT  FORM      2
EFTADMIN  DIM       8
EFTATYPE  DIM       3
EFTTIME   DIM       8
EFTDATE   DIM       8
.
FORM10    FORM      10
FMTGNAME  DIM       35
FMTTITLE  DIM       10
FMTSNAME  DIM       35
FHDUDT1   DIM       8
FHDUDT2   DIM       8
FNAMER    DIM       8
FNAMET    DIM       8
FNAMEW    DIM       8
FNAMEC    DIM       8
FORM3A    FORM      3
FORM5     FORM      5
FRSTGNAM  DIM       40
FULLGNAM  DIM       80
.
HOSPID    DIM       3
HDUDAY1   FORM      3                  * High Dependency
HDUDAY2   FORM      3
HDUFLG    FORM      "0"
HFHIFUND  FORM      2
.
INVPRNTD  FORM      3
IPRINTER  DIM       6
INVOICEN  FORM      8
INVIACTV  DIM       1
IWARD     DIM       3
IDTYP     DIM       20
ITEMCD    FORM      1
JYEAR     FORM      2
.
KEY12A    DIM       12
KEY13A    DIM       13
KEYFLAG   FORM      1
.
LASTREC   FORM      "0"
LINECNT   FORM      2
LINVDATE  DIM       10
LNO       FORM      2
LWCHG     FORM      6.2                * Labour Ward Fee
LWCODE    INIT      "LW"
LWDT      DIM       8
.
MAXSEPDY  FORM      "35"
MBSLOP    FORM      2
MBSFLAG   FORM      1
MBS1      DIM       9
MBS2      DIM       9
MBS3      DIM       9
MBSDT1    DIM       8
MBSDT2    DIM       8
MBSDT3    DIM       8
MBSCH1    DIM       9
MBSCH2    DIM       9
MBSCH3    DIM       9
MBSNUM    FORM      "0"
MENUTYPE  DIM       2
MINOWE    FORM      6.2
MULTAMT   FORM      6.2
MULTNUM   FORM      2
MINFLD    FORM      2
MAXSCRN   FORM      2
MODE1     DIM       1
.NEXTFLAG  FORM      1
NMPNUMB   DIM       2                  * required by PATSRCH
NAME35    DIM       35
.
OPCNCONS  DIM       1
ONAME     DIM       30
OPERCODE  DIM       4
OTCHG1    FORM      6.2
OTCHG2    FORM      6.2
OTCODE    INIT      "OT"
OTCNOTIH  DIM       6
OTCNOTIT  DIM       6
OTDESC1   DIM       15
OTDESC2   DIM       15
OTDT1     DIM       8                  * Other Items
OTDT2     DIM       8
OTFLG     FORM      "0"
.
OPOCFLAG  FORM      1
OPNFLAG   FORM      "0"      * Used in stepdown
OTCNCFEE  FORM      1
OTCNFTYP  FORM      1
.
PUBCDESC  DIM       20
PCENFLG   FORM      1
PAGECNT   FORM      3
PSTROL    FILE      ASCII, FIXED=256
.
PRNTFLAG  FORM     1
PREVTRID  DIM      24
RINVFLAG  FORM      1
RACLINDC  DIM       1
REGIST8   DIM       2
REPLY     FORM      1
REPORTNO  FORM      2
REPORTTY  FORM      1
.
SAVAMNT   FORM      12.2
SELECTID  DIM       4
SERVDOCT  DIM       10
PMSBI001  DIM       4
SAVKEY12  DIM       12
SCDJULDY  FORM      4
SCDJULYR  FORM      2
SCNDGNAM  DIM       40
SAVADM    DIM       8
SAVBEND   FORM      3
SAVALLW   FORM      6.2
SAVDISC   FORM      6.2
SAVEXTRA  FORM      6.2
SMCHARGE  DIM       9
SMITMTYP  FORM      1
SMMSCGRP  DIM       3
SAVCENT   DIM       2
SAVFLAG   FORM      1
SAVDAT    DIM       6
SAVDAY    DIM       2
SAVITEM   DIM       4
SAVMAMT   FORM      6.2
SAVMON    DIM       2
SAVTYP    FORM      1
SAVYEAR   DIM       2
SDATE     DIM       8
SEC       FORM      5
SELFLG    FORM      "0"
SP14      INIT      "              "
SP22      INIT      "                      "
SP27      INIT      "                           "
SPECCODE  FORM      1
SPECDATE  DIM       8
SPLING    FORM      2
STRTDAT   DIM       6
STRTNAM   DIM       6
SURGFLG   FORM      "0"
.
TFFSAMNT  FORM      12.2
TAMTT     FORM      6.2
TAMTP     FORM      6.2
TEMPAMT   FORM      6.2
TFEEIND   FORM      1
THCFLG    FORM      2
THDUDT1   DIM       8
THDUDT2   DIM       8
THEACHG   FORM      6.2                * Theatre Fee
THEADTE   DIM       8
THFUND    FORM      6.2
TODAY     DIM       8
TOTVIST   FORM      8
TOTINVC   FORM      8
TOTHFND   FORM      8
.
UPADMTYP  DIM       1
UNIQUE    FORM      8
UNIQUEX   DIM       8
USERID    DIM       10
VAR       DIM       127
WARNINGL  DIM       20
WDATE1    DIM       8
WDATE2    DIM       8
WORK      FILE      ASCII, FIXED=256
.
XXADM     DIM       8
XXCENT    DIM       2
XXDAY     DIM       2
XXMON     DIM       2
XXMULT    FORM      2
XXNAM     DIM       22
XXYEAR    DIM       2
XAMT      FORM      4.2
XMBS      FORM      5
XAMTX     DIM       7
XMBSX     DIM       5
.
Z15       INIT      "zzzzzzzzzzzzzzz"
Z30       INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
ZERO4     INIT      "0000"
ZTWO      FORM      "00"
.
SELECT    FORM       1
PRINTED   INIT       "Discharge Invoice Printed    "
NOTPRINT  INIT       "Discharge Invoice Not Printed"
.
.         Web Variables (only the include files use these variables)
.
DAYFORMT  DIM       4
NJAN      INIT      "January"
NFEB      INIT      "February"
NMAR      INIT      "March"
NAPR      INIT      "April"
NMAY      INIT      "May"
NJUN      INIT      "June"
NJUL      INIT      "July"
NAUG      INIT      "August"
NSEP      INIT      "September"
NOCT      INIT      "October"
NNOV      INIT      "November"
NDEC      INIT      "December"
.
HTMLFILE  FIFO      ASCII, FIXED=250
MTHNAM3   DIM       3
MTHNAM3A  DIM       3
.
CFPAYCOD  DIM       3        * 3M Codefinder PAY Code
.
.
.         end web variables
.
PRGID     INIT      "IBABIL40"
PRGNAM    INIT      "Bulk Invoices Exception Report                  "
VERSION   INIT      "V12.01.01"
+
.******************************************************************************
.*                                   ML0000                                   *
.*                                 Main Module                                *
.******************************************************************************
ML0000    CALL      INIT0000                * Initialise variables & open files
ML1000    CALL      OPTN0000                * Choose main option
          BRANCH    EXIT,ML9999
.
ML2000    CALL      DATE0000                * Keyin the date range
          BRANCH    EXIT,ML1000
.
ML3000    CALL      KCLM0000                * Keyin claim code
          BRANCH    EXIT,ML1000
.
          CALL      EXCI0000                * Exclude already invoiced visits
          BRANCH    EXIT,ML1000
.
          CALL      IPRT0000                * Keyin Invoice printer
          BRANCH    EXIT,ML1000
.
          CALL      GUSR0000                * get web user id
.
          CALL      CONTQST                 * Ok to continue (Y/N/C) ?
          BRANCH    CEXIT,ML4000,ML3000,ML1000
          GOTO      ML1000
.
ML4000    CALL      CREA0000                * Create tempfile
          CALL      PROC0000                * Process the files
.
          CALL      PEXC0000                * Print exception report
.
          CALL      KILL0000                * Delete tempfile
          GOTO      ML1000
.
ML9999    CHAIN     PGM
+
.******************************************************************************
.*                                   INIT0000             Called by: ML0000   *
.*                        Initialise Variable & Open Files                    *
.******************************************************************************
INIT0000  CALL      DISPHEAD                * Display screen heading
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MOVE      ZERO,EXIT
          MOVE      ONE,BDTEFLAG            * Yes we are backdating Invoices
.
          CALL      IBACLOCK
          PACK      TODAY,CCENT,CYEAR,CMON,CDAY
          REP       " 0",TODAY
.
          OPEN      IBAPDFA1,"ibapdfaf"        * For default printer selection
          OPEN      IBASPOL1,"ibaspolf"
          OPEN      IBAPOLA1,"ibapolaf"
.
          DISPLAY   *P56:24,"Opening patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"patmmbsf";
          OPEN      PATMMBS1,"patmmbsf"
.
          DISPLAY   *P64:24,"patdo1af";
          OPEN      PATDO1A1,"patdo1af"
.
          DISPLAY   *P64:24,"patdschf";
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
.
          DISPLAY   *P64:24,"patdtraf";
          OPEN      PATDTRA1,"patdtraf"
.
          DISPLAY   *P64:24,"pmsmtiaf";
          OPEN      PMSMTIA1,"pmsmtiaf"
.
          DISPLAY   *P64:24,"pmsbbiaf";
          OPEN      PMSBBIA1,"pmsbbiaf"
.
          DISPLAY   *P64:24,"pmsbisaf";
          OPEN      PMSBISA1,"pmsbisaf"
.
          DISPLAY   *P64:24,"patgtuaf";
          OPEN      PATGTUA1,"patgtuaf"
.
          DISPLAY   *P64:24,"patfinsf";
          OPEN      PATFINS1,"patfinsf"
.
          DISPLAY   *P64:24,"patgsrnf";
          OPEN      PATGSRN2,"patgsrnf"
          OPEN      PATGSRN3,"patgsrnf"
          OPEN      PATGSRN4,"patgsrnf"
.
          DISPLAY   *P64:24,"patinmaf";
          OPEN      PATINMA1,"patinmaf"
.
          DISPLAY   *P64:24,"patirnge";
          OPEN      PATIRNG1,"patirnge"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A4,"patmi1af"
.
          OPEN      PATMCHG1,"patmchgf"
          OPEN      PATFN1A1,"patfn1af"
.
          DISPLAY   *P64:24,"patnobef";
          OPEN      PATNOBE1,"patnobef"
.
          DISPLAY   *P64:24,"patpramf";
          OPEN      PATPR1A1,"patpr1af"
          OPEN      PATPX1A1,"patpx1af"
.
          DISPLAY   *P64:24,"pattranf";
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P64:24,"patvisaf";
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
.
          DISPLAY   *P64:24,"patwr1af";
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A4,"patwr1af"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"nzpirnaf";
          OPEN      NZPIRNA1,"nzpirnaf"
          OPEN      NZPIRNA2,"nzpirnaf"
.
          DISPLAY   *P64:24,"nzpbfeaf";
          OPEN      NZPBFEA1,"nzpbfeaf"
.
          DISPLAY   *P64:24,"nzpcfnaf"
          OPEN      NZPCFNA1,"nzpcfnaf"
.
          DISPLAY   *P64:24,"nzpcmtaf"
          OPEN      NZPCMTA1,"nzpcmtaf"
          OPEN      NZPCMTA2,"nzpcmtaf"
          OPEN      NZPCMTA3,"nzpcmtaf"
.
          DISPLAY   *P64:24,"nzpfigaf"
          OPEN      NZPFIGA1,"nzpfigaf"
          OPEN      NZPFIGA2,"nzpfigaf"
.
          DISPLAY   *P64:24,"nzpfinaf"
          OPEN      NZPFINA1,"nzpfinaf"
          OPEN      NZPFINA2,"nzpfinaf"
.
          DISPLAY   *P64:24,"nzpibraf"
          OPEN      NZPIBRA1,"nzpibraf"
.
          DISPLAY   *P64:24,"nzpmchaf"
          OPEN      NZPMCHA1,"nzpmchaf"
          OPEN      NZPMCHA2,"nzpmchaf"
.
          DISPLAY   *P64:24,"nzppicaf"
          OPEN      NZPPICA1,"nzppicaf"
          OPEN      NZPPICA2,"nzppicaf"
.
          DISPLAY   *P64:24,"nzprbraf"
          OPEN      NZPRBRA1,"nzprbraf"
.
          DISPLAY   *P64:24,"nzprfnaf"
          OPEN      NZPRFNA1,"nzprfnaf"
          OPEN      NZPRFNA2,"nzprfnaf"
.
          DISPLAY   *P64:24,"nzppfeaf"
          OPEN      NZPPFEA1,"nzppfeaf"
.
          DISPLAY   *P64:24,"nzpspraf"
          OPEN      NZPSPRA1,"nzpspraf"
          OPEN      NZPSPRA2,"nzpspraf"
.
          DISPLAY   *P64:24,"nzptfeaf"
          OPEN      NZPTFEA1,"nzptfeaf"
          OPEN      NZPTFEA2,"nzptfeaf"
.
          DISPLAY   *P64:24,"oprdetaf"
          OPEN      OPRDETA1,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
.
          DISPLAY   *P64:24,"oprdetaf"
          OPEN      OPRDETA2,"oprdetaf"
.
          DISPLAY   *P64:24,"oprsesaf"
          OPEN      OPRSESA1,"oprsesaf"
.
          DISPLAY   *P64:24,"controlf";
          OPEN      CONTROLF,"controlf"
.
          OPEN      PATRE1A1,"patre1af"
.
          DISPLAY   *P64:24,"oprardaf";
          OPEN      OPRARDA1,"oprardaf"
.
          DISPLAY   *P64:24,"outsitaf";
          OPEN      OUTSITA1,"outsitaf"
.
          OPEN      PMSICMA1,"pmsicmaf"
          OPEN      PATINVR3,"patinvrf"
          OPEN      PMSCNOA3,"pmscnoaf"
          OPEN      PATIPEN1,"patipenf"
          OPEN      WEBSECA1,"websecaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVISA2,"emrvisaf"
          OPEN      AAEDE1A1,"aaede1af"
          OPEN      PMSEVTA1,"pmsevtaf"
.
...  used in ABFAECCL
          CALL      TFILENAM                * Get file name calculating Exponent
          MOVE      TFILNAME,FNAMEN
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMER
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMET
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEW
.
...  used in PATCATBI CRMV0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEX
.
...  used in PATCATBI PTMP0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEZ
.
...  used in PATCATBI PT2P0000
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,FNAMEY
.
...  used in PABXBILL
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAME
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PBXFNAM2
.
          CALL      RDCNT000                       *Read control file
.
          CALL      TFILENAM                * Generate temporary file name
          MOVE      TFILNAME,FNAMEC
.
          MOVE      ZERO TO DISPROG
          MOVE      ZERO TO BEQPROG        * Not the billing enquiry program
.
          MATCH     "IBARSH",PGM
          IF        !@EQUAL
            CALL      SELPRINT
            MOVE      CPRTFLG,SPLING       * Save the spooling flag
          ENDIF
.
INIT9000  MOVE      ZERO,EXIT
INIT9999  RETURN
+
.------------------------------------------------------------
.   Read the control file
.------------------------------------------------------------
RDCNT000  READ      CONTROLF,ZERO;*43,IBCNMHOS:
                                  *85,IBCNUGST
          READ      CONTROLF,TEN;*32,PTCNUBRD,*66,CINVLAY,*79,CAPPRVNO:
                                 *94,CAGECOFF,*104,PTCNMBSF:           *C-47385
                                 *166,CMEMB:
                                *183,CVIEWIP,*188,CCHKRAT,*192,CACCFEE:
                                *217,CAUDQ
          READ      CONTROLF,TEN3;CHADD1,CHADD2,CHPOST,CHPADD1,CHPADD2,CHPPOST:
                                  CHTELEB,*154,CUSEMBS,*163,BEDTYP:
                             *211,CINV1ST,*245,CHOSTYP
          READ      CONTROLF,TEN4;CNOCLMS,CINMES1,CINMES2:
                             *228,CINVFF,*245,CMAXINV
          READ      CONTROLF,TEN5;*247,CSTDOWN
          READ      CONTROLF,TEN8;*206,CFINAN
          READ      CONTROLF,TEN9;*212,CFEETYP,*216,CINVRIP
          READ      CONTROLF,TWENTY;*164,PTRESDAY:
                                    *193,PTCNDCLM:
                                    *198,PTCNPIOP,PTCNBCUT,PTCNBDOM:
                                    *211,PTCNCNDY,*239,PTCNMXCH
          READ      CONTROLF,TWENTY1;*51,PTCNINVL,*60,PTCNCCRR,PTCNCLOR:
                                    *120,PTCNADDC,*136,PTCNMITM,*138,PTCNNHII:
                                    *174,PTCNDONR,*178,PTCNMPTR:
                                    *190,PTCNPCON,*200,PTCNICRA,*235,PTCNDPL8:
                                    *237,PTCNPAOF
          READ      CONTROLF,THIRTY;*132,HSTANDM,HINVDES
          READ      CONTROLF,FIFTY9;*1,CDLSTEP,*23,CFUTINV,*25,CFUTCOM:
                                   *66,CGSTPERC,CGSTITEM
          READ      CONTROLF,SEVENTY9;*248,PTCNIPEN
          READ      CONTROLF,SEVENTY9;*68,PTCNMFEE,PTCNJFEE
          READ      CONTROLF,EIGHTY;*248,PTCNPEFR
          READ      CONTROLF,EIGHTY8;*86,CC,YY,MM,DD
          READ      CONTROLF,NINTY8;*127,PTCNPMIS,*136,PTCNPAIH:
                                    *142,PTCNPAIT,*148,PTCNINVB
          READ      CONTROLF,HUND03;*220,PTCNDEES,*221,PTCNDDES
          READ      CONTROLF,HUND05;*130,PTCNAUAT:    * auto update adm.type
                                         PTCNWSPC:    * Warning for sub-seq item
                                    *177,PTCNTFEE:    * Using theatre fees
                                    *190,PTSGCOPT:    * Using suggested class.
                                    *195,PTCNLASR:
                                    *226,PTCNPRWD:    * Print wrd/bed on inv.
                                    *235,PTCNQCCT:
                                    *247,PTCNCDIS
.
          READ      CONTROLF,HUND09;*238,PTCNPRIN     * Display zero invoice
          READ      CONTROLF,HUND10;*115,PTCNUEDI
          READ      CONTROLF,HUND12;*102,PTCNHITC,*103,PTCNHICC,*113,PTCNXCHS:
                                    *118,PTCNTRPR
          READ      CONTROLF,HUND16;*209,PTCNADEP:
                                    *210,PTCNICLS:
                                    *219,PTCNCLEV:
                                    *222,PTCNXCOM,*226,PTCNGPHR

          READ      CONTROLF,HUND18;*165,PTCNPPRC,*166,PTCNPITM
          READ      CONTROLF,HUND30;*1,PTCNHABN
.
RDCNT999  RETURN
+
.******************************************************************************
.*                                  OPTN0000              Called by: ML0000   *
.*                                Choose Option                               *
.******************************************************************************
OPTN0000  MOVE      ZERO,OPTION
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,"0",*HOFF," = Exit":
                    *P1:5,*V2LON,"1",*HOFF," = Coding Complete by Claim Type":
                           " - Inpatient":
                    *P1:6,*V2LON,"2",*HOFF," = Claim Type with a Date Range":
                           " - Outpatient":
                    *P1:7,*V2LON,"3",*HOFF," = Claim Type with a Date Range":
                           " - Emergency":
                    *P1:8,"Select Option : ";
OPTN1000  KEYIN     *P17:8,*V2LON,*DV,UNDLN2,*P17:8,OPTION;
.
          COMPARE   ZERO,OPTION
          GOTO      OPTN9500 IF EQUAL
.
          BRANCH    OPTION,OPTN1100,OPTN1200,OPTN1300
          BEEP
          GOTO      OPTN1000
.
OPTN1100  MOVE      "Bulk Inpatient Invoices Exception Report",PRGNAM
          GOTO      OPTN9000
.
OPTN1200  MOVE      "Bulk Outpatient Invoices Exception Report",PRGNAM
          GOTO      OPTN9000
.
OPTN1300  MOVE      "Bulk Emergency Invoices Exception Report",PRGNAM
.
OPTN9000  MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
OPTN9999  RETURN
+
.******************************************************************************
.*                                  DATE0000              Called by: ML0000   *
.*                            Keyin The Date Range                            *
.******************************************************************************
DATE0000  MOVE      "17",CCOL
          DISPLAY   *P1:9,"Starting Date : ",*EF:
                    *P1:10,"Ending Date   : ";
.
          MOVE      ONE,CCANLDTE            * Blank cancel default
.
. ----- Keyin start date -----
.
DATE1000  MOVE      "9",CVERT
          MOVE      CCC,CCENT
          UNPACK    SP6,CYEAR,CMON,CDAY
          CALL      KEYDATE                 * Keyin date
          BRANCH    OVRCD,DATE9500          * Nothing entered
          BRANCH    CQUEST,DATE1000
.
          PACK      STRTDTE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDTE
          CALL      PACDATE                 * Format the start date
          MOVE      CPCDATE,DSPSTDTE
          DISPLAY   *PCCOL:CVERT,*EL,*V2LON,DSPSTDTE;
.
          MATCH     STRTDTE,CURRDATE
          IF        @LESS
            DISPLAY   *P1:24,*B,*EL,"Start date must not be in the future.  ";
            CALL      HITENTER 
            GOTO      DATE1000
          ENDIF
.
. ----- Keyin end date -----
.
DATE2000  MOVE      "10",CVERT
          UNPACK    STRTDTE,CCENT,CYEAR,CMON,CDAY
          CALL      KEYDATE                 * Keyin date
          BRANCH    OVRCD,DATE1000          * Nothing entered
          BRANCH    CQUEST,DATE2000
.
          PACK      ENDDTE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDTE
          CALL      PACDATE                 * Format the end date
          MOVE      CPCDATE,DSPEDDTE
          DISPLAY   *PCCOL:CVERT,*EL,*V2LON,DSPEDDTE;
.
          MATCH     ENDDTE,CURRDATE
          IF        @LESS
            DISPLAY   *P1:24,*B,*EL,"End date must not be in the future.  ";
            CALL      HITENTER 
            GOTO      DATE2000
          ENDIF
.
          MATCH     STRTDTE,ENDDTE
          IF        @LESS
            DISPLAY   *P1:24,*B,*EL,"End date must after the start date.  ";
            CALL      HITENTER 
            GOTO      DATE2000
          ENDIF
.
DATE9000  MOVE      ZERO,EXIT
          GOTO      DATE9999
.
DATE9500  MOVE      ONE,EXIT
DATE9999  RETURN
+
.******************************************************************************
.         Keyin Claim Code
.******************************************************************************
KCLM0000  MOVE      ZERO,EXIT
          MOVE      SP70,CLAIMDES
          MOVE      SP70,CLMDESC
          PACK      KEY5,ANSC,ANSL,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,CLAIMDES           * Claim type description
            UNPACK    TDESC,CLMDESC
          ENDIF
.
          MOVE      SP70,CLAIMTYP
          DISPLAY   *P1:12,*EF:
                    *P1:12,"Claim Type      :";
.
          MOVE      ONE,CNEWDS
          MOVE      "17",ECOL
          MOVE      "12",EVERT
          MOVE      SP3,CKYIDEF3
          MOVE      ZERO,CKYIMAND
          MOVE      SP10,ACODE
          KEYIN     *PECOL:EVERT,*V2LON,ACODE
          PACK      ACODE,ACODE,SP10
          MATCH     SP70,ACODE
          GOTO      KCLM9000 IF EQUAL
.
          MOVE      ACODE,CLAIMTYP
          PACK      KEY5,ANSC,ANSL,CLAIMTYP
          CALL      RDCODE1
          BRANCH    OVRCD,KCLM2000
.
          MOVE      ZERO,EXIT
          UNPACK    TDESC,PUBCDESC
          DISPLAY   *P22:12,TDESC;
          GOTO      KCLM9999
.
KCLM2000  DISPLAY   *PECOL:EVERT,*B,*V2LON,"Invalid Claim type"
          GOTO      KCLM0000
.
KCLM9000  MOVE      ONE,EXIT
KCLM9999  RETURN
+
.******************************************************************************
.*                                  EXCI0000              Called by: ML0000   *
.*                              New Page Question                             *
.******************************************************************************
EXCI0000  MOVE      ZERO,EXCLINVD
          DISPLAY   *P1:12,*EF,"Exclude Already Invoiced Visits (":
                    *V2LON,"Y",*HOFF,"/",*V2LON,"N",*HOFF,") ? ";
.
EXCI1000  MOVE      ANSN,ANS
          KEYIN     *P44:12,*V2LON,*RV,ANS;
.
          RESET     ANS
          REP       UPPLOW,ANS
.
          MATCH     SP1,ANS
          GOTO      EXCI2000 IF EQUAL       * Spaces, print new page
.
          MATCH     EXITCHAR,ANS
          GOTO      EXCI9500 IF EQUAL       * Exit char, exit
.
          MATCH     ANSN,ANS
          GOTO      EXCI2000 IF EQUAL       * Dont print new page for each ward
.
          MATCH     ANSY,ANS
          GOTO      EXCI3000 IF EQUAL       * Print new page for each ward
.
          BEEP
          GOTO      EXCI1000
.
EXCI2000  DISPLAY   *P44:12,*EL,*V2LON,"No";
          MOVE      ZERO,EXCLINVD
          GOTO      EXCI9000
.
EXCI3000  DISPLAY   *P44:12,*EL,*V2LON,"Yes";
          MOVE      ONE,EXCLINVD
.
EXCI9000  MOVE      ZERO,EXIT
          GOTO      EXCI9999
.
EXCI9500  MOVE      ONE,EXIT
EXCI9999  RETURN
+
.**********************************************************************
.*                            IPRT0000                                *
.**********************************************************************
IPRT0000  DISPLAY   *P1:14,*EF:
                    *P1:14,"Inv. Printer  : ";
.
          KEYIN     *P17:14,IPRINTER;
.
          ENDSET    IPRINTER
          APPEND    SP70,IPRINTER
          RESET     IPRINTER
.
          MATCH     SP70,IPRINTER
          GOTO      IPRT9000 IF EQUAL
          MOVE      ZERO,EXIT
          GOTO      IPRT9999
.
IPRT9000  MOVE      ONE,EXIT
IPRT9999  RETURN
+
.*******************************************************************************
.*                                  GUSR0000               Called by: MAIN0000 *
.*                               Get Web User Id                               *
.*******************************************************************************
.
GUSR0000  KEYIN     *P1:16,*EF,"Web User Id  : ",*V2LON,USERID
.
          PACK      USERID,USERID,SP70
          PACK      KEY10,USERID,SP70
          CALL      RDWBSE1
          BRANCH    OVRCD,GUSR9100
.
          MOVE      ZERO,EXIT
          GOTO      GUSR9999
.
GUSR9100  MOVE      ONE,EXIT
GUSR9999  RETURN
+
.******************************************************************************
.*                                  PROC0000              Called by: ML0000   *
.*                              Process The Files                             *
.******************************************************************************
PROC0000  CALL      CLRF0000                * clear temp file records
.
          MOVE      ZERO,PRNTFLAG
          MOVE      ZERO,CPAGENO            * Reset the page counter
          MOVE      "60",CLNO              * Init line number
          CLOCK     TIME,CTIMEIS           * Init starting time
          MOVE      ZERO,TOTVIST
          MOVE      ZERO,TOTINVC
          MOVE      ZERO,TOTHFND
.
          DISPLAY   *P1:24,*EL,"Scanning : ",*P35:24,"Printing : ";
.
          MOVE      ZERO,INVPRNTD           * existing invoice
          BRANCH    OPTION,PROC1000,PROC2000,PROC3000
.
PROC1000  CALL      GINP0000                * Generate Inpatient invoices
          GOTO      PROC8000
.
PROC2000  CALL      GOUT0000                * Generate Outpatient invoices
          GOTO      PROC8000
.
PROC3000  CALL      GEMR0000                * Generate Emergency invoices
          GOTO      PROC8000
.
PROC8000  MATCH     "IBARSH",PGM
          IF        !@EQUAL
            MOVE      SPLING,CPRTFLG            * Restore the original setting
            CALL      CLSPRINT
          ENDIF
.
PROC9999  RETURN
+
.******************************************************************************
.         Get Inpatient invoices
.******************************************************************************
GINP0000  PACK      KEY16,STRTDTE,SP70
          CALL      RDSMISS4                * Position on & read admission file
GINP1000  CALL      RDKMISS4                  record
          BRANCH    OVRCD,GINP9999
.
          DISPLAY   *P15:24,AADMNO;
          MATCH     ACODDTE,ENDDTE
          GOTO      GINP9999 IF LESS
.
          MATCH     ACLAIM,CLAIMTYP
          GOTO      GINP1000 IF NOT EQUAL   * Different claim code
.
          PACK      KEY8,AURNO
          CALL      RDMAST1                 * Read a master file record
          BRANCH    OVRCD,GINP1000
.
          MOVE      AADMNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD,GINP1000
.
          MOVE      PVIBILL,ADMISSNO
          MOVE      AINVPRT,INVPRNTD           * save no of invoices printed
.
.        Check to see if the patient is discharged yet
.
          MOVE      ONE,DISFLG                   * Assume no discharge record
.
          COMPARE   THREE,ASTAT
          GOTO      GINP1200 IF NOT EQUAL
.
          MOVE      ZERO,DISFLG                  * Patient is discharged
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1                      * Read in the discharge record
          BRANCH    OVRCD,GINP1000
.
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11
.
GINP1200 DISPLAY   *P50:24,*V2LON,AADMNO
.
          MOVE      ZERO,BDTEFLAG           * set 'No' to backdating invoice flg
          MOVE      SP70,BACKDATE
          MOVE      ONE,PROGFLAG
          MOVE      ZERO,DISPROG
          MOVE      CPAGENO,FORM3A
          MOVE      ZERO,IBCNUGST         * set no GST for pending report
          CALL      CALCTBI
          MOVE      FORM3A,CPAGENO
.
          COMPARE   ZERO,GROSSTOT
          GOTO      GINP2000 IF NOT EQUAL   * got charges
.
.         Check if we Exclude already invoiced visit in the Exception report
.         If it's ticked/Yes,do not include patient that has an existing invoice
.
          IF        EXCLINVD=1
            COMPARE   ZERO,INVPRNTD
            GOTO      GINP1000 IF NOT EQUAL * has an existing invoice 
          ENDIF
.
          ADD       ONE,TOTVIST             * Total visits with No charge
          MOVE      "1",RECTYPE             * No charge
          GOTO      GINP6000                * Write to Exception file
.
.         If Public patient (Catg CL INDIC1=P) with health fund, skip checking
.         rules for rules if invoice can be raised
.
GINP2000  PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     "P",TCINDC1
            IF        @EQUAL
              MATCH     SP70,AFUNDH
              GOTO      GINP3000 IF NOT EQUAL   * has HF - no rule checking
            ENDIF
          ENDIF
.
          CALL      CRIS0000                * check rule if inv.can be raised
          BRANCH    RINVFLAG,GINP1000       * invoice can not be raised
.
GINP2100  MOVE      AURNO,INDMURNO
          MOVE      AADMNO,INDMADNO
          CALL      CHKDCI00                * check clinical document if
          MATCH     "1",INVIACTV            * invoice can be raised
          GOTO      GINP1000 IF EQUAL
.
.         Print invoice
.
GINP3000  CALL      PNTX0000                * Write to pulling table
.
          ADD       ONE,TOTINVC             * Total no of invoices raised
          MATCH     SP70,AFUNDH
          GOTO      GINP1000 IF EQUAL       * no health fund
.
          MOVE      "2",RECTYPE             * Report type for patient with HF
          ADD       ONE,TOTHFND             * Total invoice raised with HF
.
          IF        EXCLINVD=1
            COMPARE   ZERO,INVPRNTD
            GOTO      GINP1000 IF NOT EQUAL * has an existing invoice 
          ENDIF
.
GINP6000  MOVE      SP70,CASEKEYS
          PACK      KEY9,RECTYPE,DAADMNO,SP70
          CALL      WREXCA1
          GOTO      GINP1000
.
GINP9999  RETURN
.
.------------------------------------------------------------------------------
. Check Claim Type/Clinical Document Mapping table to determine if the 
. Invoice can be raised for Inpatient
.------------------------------------------------------------------------------
CHKDCI00  MOVE      "0",INVIACTV 
.
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,INDMHOSP
          ELSE
            MOVE      SP70,INDMHOSP
          ENDIF
          MOVE      ACLAIM,INDMCLAM
          MOVE      "I",INDMSYST
          MOVE      ACARE,INDMCTYP
          MOVE      PMVXIDUS,INDMILOS
.
          PROC      CHKCLDCP
          MOVE      EXIT,INVIACTV
.
CHKDCI99  RETURN
.
.------------------------------------------------------------------------------
. Check Claim Type/Clinical Document Mapping table to determine if the
. Invoice can be raised for Outpatient
.------------------------------------------------------------------------------
CHKDCO00  MOVE      "0",INVIACTV
.
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,INDMHOSP
          ELSE
            MOVE      SP70,INDMHOSP
          ENDIF
          MOVE      OBACOMP,INDMCLAM
          MOVE      "O",INDMSYST
          MOVE      SP70,INDMCTYP
          MOVE      SP70,INDMILOS
.
          PROC      CHKCLDCP
          MOVE      EXIT,INVIACTV
.
CHKDCO99  RETURN
.
.------------------------------------------------------------------------------
. Check Claim Type/Clinical Document Mapping table to determine if the
. Invoice can be raised for Emergency
.------------------------------------------------------------------------------
CHKDCE00  MOVE      "0",INVIACTV
.
          IF        IBCNMHOS=1
            MOVE      PMVXMHOS,INDMHOSP
          ELSE
            MOVE      SP70,INDMHOSP
          ENDIF
          MOVE      EMVICOMP,INDMCLAM
          MOVE      "E",INDMSYST
          MOVE      SP70,INDMCTYP
          MOVE      SP70,INDMILOS
.
          PROC      CHKCLDCP
          MOVE      EXIT,INVIACTV
.
CHKDCE99  RETURN
+
.******************************************************************************
.         Get Outpatient invoices
.******************************************************************************
GOUT0000  MOVE      WBSESIT,KEY6
          CALL      RDSITA1
          BRANCH    OVRCD,GOUT9999
          CALL      OPNOUT00               * Open Outpatient Files
.
          PACK      KEY12,OSTSITE,SP6        * All records for current site
          CALL      RDSCTYA1                 * Positioning read
.
GOUT1000  CALL      RDKCTYA1                 * Read clinic type record
          BRANCH    OVRCD,GOUT9999           * No more records 
.
          MATCH     OSTSITE,OCTSITE          * Same site still ?
          GOTO      GOUT9999 IF NOT EQUAL    * No
.
          MOVE      FOUR,ATTDSTAT            * Set status to attendees
          PACK      KEY35,OCTSITE,OCTCTYP,ATTDSTAT,STRTDTE,SP30
          CALL      RDSBOKA2
GOUT2000  CALL      RDKBOKA2
          BRANCH    OVRCD,GOUT1000           * No more records - get next ctype
.
          MATCH     OCTSITE,OBASITE
          GOTO      GOUT1000 IF NOT EQUAL    * Different site - get next ctype
.
          MATCH     OCTCTYP,OBACTYP
          GOTO      GOUT1000 IF NOT EQUAL    * Different clinic type - get next
.
          MATCH     ATTDSTAT,DOBASTAT
          GOTO      GOUT1000 IF NOT EQUAL    * Different clinic type - get next
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF GOUT2000
.
          MOVE      PVIBILL,ADMISSNO
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD OF GOUT2000
.
          MATCH     OBADATE,ENDDTE
          GOTO      GOUT1000 IF LESS
.
          MATCH     OBACOMP,CLAIMTYP
          GOTO      GOUT2000 IF NOT EQUAL    * Different claim code
.
GOUT2100  MOVE      OBAURNO,PURNO
          MOVE      PURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF GOUT2000
.
          MOVE      PFUNDH,AFUNDH            * default to Patient master HF
          MATCH     SP70,OTBBFUND
          IF        !@EQUAL
            MOVE      OTBBFUND,AFUNDH
          ENDIF
.
          MOVE      OBACOMP,ACLAIM
          MOVE      DPVIBILL,DAADMNO
          MOVE      PVIBILL,AADMNO
          MOVE      PVIURNO,AURNO
.
          CALL      CEIV00000                * Check for an existing invoice
.
          MOVE      ONE,PROGFLAG
          CALL      OUTTBI
.
          COMPARE   ZERO,GROSSTOT
          GOTO      GOUT4000 IF NOT EQUAL   * got charges
.
.         Check if we Exclude already invoiced visit in the Exception report
.         If it's ticked/Yes,do not include patient that has an existing invoice
.
          IF        EXCLINVD=1
            COMPARE   ZERO,INVPRNTD
            GOTO      GOUT2000 IF NOT EQUAL     * has an existing invoice
          ENDIF
.
          ADD       ONE,TOTVIST             * Total visits with No charge
          MOVE      "1",RECTYPE             * No charge
          GOTO      GOUT6000                * Write to Exception file
.
.         Print invoice
.
GOUT4000  MOVE      OBAURNO,INDMURNO
          MOVE      OBAOUTNO,INDMADNO
          CALL      CHKDCO00                * check clinical document if
          MATCH     "1",INVIACTV            * invoice can be raised
          GOTO      GOUT2000 IF EQUAL
.
          CALL      PNTX0000                * Write to pulling table
.
          ADD       ONE,TOTINVC             * Total no of invoices raised
          MATCH     SP70,AFUNDH
          GOTO      GOUT2000 IF EQUAL       * no health fund
.
          MOVE      "2",RECTYPE             * Report type for patient with HF
          ADD       ONE,TOTHFND             * Total invoice raised with HF
.
          IF        EXCLINVD=1
            COMPARE   ZERO,INVPRNTD
            GOTO      GOUT2000 IF NOT EQUAL  * has an existing invoice
          ENDIF
.
GOUT6000  PACK      CASEKEYS,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          PACK      KEY9,RECTYPE,DAADMNO,SP70
          CALL      WREXCA1
          GOTO      GOUT2000
.
GOUT9999  RETURN
+
.*******************************************************************************
.         Check for Exisitng invoices
.*******************************************************************************
CEIV0000  MOVE      ZERO,INVPRNTD              * default to No existing invoice
          PACK      KEY16,PVIBILL,SP70
          CALL      RDSINV3
CEIV1000  CALL      RDKINV3
          BRANCH    OVRCD,CEIV9999
.
          MATCH     PVIBILL,PINVADM
          GOTO      CEIV9999 IF NOT EQUAL
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          GOTO      CEIV1000 IF NOT EQUAL     * invoice had been credited note
.
          MOVE      ONE,INVPRNTD              * Invoice already been raised
.
CEIV9999  RETURN
+
.*******************************************************************************
.                    Open Outpateint Files
.*******************************************************************************
OPNOUT00  PACK      CFNAME,OSTFILE,FILBOKA1
          CLOSE     OUTBOKA1
          OPEN      OUTBOKA1,CFNAME          * Open bookings file
.
          PACK      CFNAME,OSTFILE,FILBOKA2
          CLOSE     OUTBOKA2
          OPEN      OUTBOKA2,CFNAME          * Open bookings file
.
          PACK      CFNAME,OSTFILE,FILDTRO1
          CLOSE     OUTDTRO1
          OPEN      OUTDTRO1,CFNAME
.
          PACK      CFNAME,OSTFILE,FILBB1A1  * Set up physical filename
          CLOSE     OUTBB1A1
          CALL      OPOTBB11
          PACK      CFNAME,OSTFILE,FILBB1A2  * Set up physical filename
          CLOSE     OUTBB1A2
          CALL      OPOTBB12
.
          PACK      CFNAME,OSTFILE,FILCTYA1
          CLOSE     OUTCTYA1
          OPEN      OUTCTYA1,CFNAME          * Open clinic type file
.
          RETURN
+
.******************************************************************************
.         Get Emergency invoices
.         for patient discharged complete within the date range
.****************************************************************************
GEMR0000  MOVE      "3",DEMVISTA
          PACK      KEY9,DEMVISTA,SP30
          CALL      RSEMVIS2
GEMR1000  CALL      RKEMVIS2
          BRANCH    OVRCD,GEMR9999
          MATCH     "3",DEMVISTA
          GOTO      GEMR9999 IF NOT EQUAL    * Not discharged complete
.
          MATCH     STRTDTE,EMVIDDAT
          GOTO      GEMR1000 IF LESS
          MATCH     EMVIDDAT,ENDDTE
          GOTO      GEMR1000 IF LESS
.
          MOVE      DEMVIADM,KEY8
          CALL      RDVISA1
          BRANCH    OVRCD OF GEMR1000
.
          MOVE      PVIBILL,ADMISSNO
          IF        PVITYPE=9
            MATCH     " 1",PVISYST
            IF        @EQUAL
              MOVE      DEMVIADM,KEY8
              CALL      RDPMEVT1
              IF        @EQUAL
                MOVE      PMEVCCOD,ADACOMP  * Event visit
                MOVE      PVIURNO,ADAURNO
                MOVE      PVIBILL,ADANUMB
                GOTO      GEMR1200
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      PVIBILL,KEY8
          CALL      RDDETA1
          BRANCH    OVRCD,GEMR1000
          MATCH     SP70,ADACOMP
          IF        @EQUAL
            MOVE      EMVICOMP,ADACOMP       * Claim code
          ENDIF
.
GEMR1200  MATCH     ADACOMP,CLAIMTYP
          GOTO      GEMR1000 IF NOT EQUAL    * Different claim code
.
          MOVE      EMVIURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD OF GEMR1000
.
          MOVE      PFUNDH,AFUNDH            * default to Patient master HF
          MATCH     SP70,EMVIFUND
          IF        !@EQUAL
            MOVE      EMVIFUND,AFUNDH
          ENDIF
.
          MOVE      ADACOMP,ACLAIM
          MOVE      DPVIBILL,DAADMNO
          MOVE      PVIBILL,AADMNO
          MOVE      PVIURNO,AURNO
.
          CALL      CEIV00000                * Check for an existing invoice
.
          MOVE      ONE,PROGFLAG
          CALL      AAETBI
.
          COMPARE   ZERO,GROSSTOT
          GOTO      GEMR4000 IF NOT EQUAL
.
.         Check if we Exclude already invoiced visit in the Exception report
.         If it's ticked/Yes,do not include patient that has an existing invoice
.
          IF        EXCLINVD=1
            COMPARE   ZERO,INVPRNTD
            GOTO      GEMR1000 IF NOT EQUAL     * has an existing invoice
          ENDIF
.
          ADD       ONE,TOTVIST             * Total visits with No charge
          MOVE      "1",RECTYPE             * No charge
          GOTO      GEMR6000                * Write to Exception file
.
.         Print invoice
. 
GEMR4000  MOVE      EMVIURNO,INDMURNO
          MOVE      DEMVIADM,INDMADNO
          CALL      CHKDCE00                * check clinical document if
          MATCH     "1",INVIACTV            * invoice can be raised
          GOTO      GEMR1000 IF EQUAL
.
          CALL      PNTX0000                * Write to pulling table
.
          ADD       ONE,TOTINVC             * Total no of invoices raised
          MATCH     SP70,AFUNDH
          GOTO      GEMR1000 IF EQUAL       * No health fund
.
          MOVE      "2",RECTYPE             * Report type for patient with HF
          ADD       ONE,TOTHFND             * Total invoice raised with HF
.
          IF        EXCLINVD=1
            COMPARE   ZERO,INVPRNTD
            GOTO      GEMR1000 IF NOT EQUAL * has an existing invoice
          ENDIF
.
GEMR6000  MOVE      SP70,CASEKEYS
          MOVE      PVIBILL,DAADMNO
          PACK      KEY9,RECTYPE,DAADMNO,SP70
          CALL      WREXCA1
          GOTO      GEMR1000
.
GEMR9999  RETURN
+
.-------------------------------------------------------------------------
. Write Adm and U/R number to the COMWEB70 polling table to print invoice
.-------------------------------------------------------------------------
PNTX0000  MOVE      ZERO,FORM10
.
          PACK      KEY10,Z70
          CALL      RSIBPOL1
          CALL      RPIBPOL1
          BRANCH    OVRCD,PNTX1000
.
          MOVE      IBPLUNIQ,FORM10
PNTX1000  ADD       ONE,FORM10
.
          MOVE      FORM10,IBPLUNIQ
          MOVE      "011",IBPLTYPE     * Inpatient print invoice Pooling Type
          IF        OPTION=2
            MOVE      "012",IBPLTYPE     * Outpatient print invoice Pooling Type
          ELSE
            IF        OPTION=3
              MOVE      "013",IBPLTYPE     * Emergency print invoice Pooling Type
            ENDIF
          ENDIF
          MOVE      AURNO,IBPLURNO
          MOVE      AADMNO,IBPLVISN
          PACK      IBPLSKEY,IPRINTER,USERID,SP70
          MOVE      SP70,IBPLSPAR
.
          MOVE      FORM10,KEY10
          CALL      RAIBPOL1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRIBPOL1
            TRAPCLR   IO
            BRANCH    OVRCD,PNTX1000
          ELSE
            GOTO      PNTX1000
          ENDIF
.
PNTX9999  RETURN
+
.-------------------------------------------------------------------------
.         Print Exception report
.-------------------------------------------------------------------------
PEXC0000  
          IF        OPTION=2
            PACK      CFNAME,OSTFILE,FILBOKA1
            CLOSE     OUTBOKA1
            OPEN      OUTBOKA1,CFNAME          * Open bookings file
          ENDIF
.
          MOVE      ONE,REPORTTY               * Print patient with No charge
.
PEXC1000  MOVE      REPORTTY,RECTYPE           * Report type
          PACK      KEY17,RECTYPE,SP70
          CALL      RSEXCA2                    * position at start of file
PEXC2000  CALL      RKEXCA2                    * read next record
          BRANCH    OVRCD,PEXC4000               * end of file - finished
          DISPLAY   *P46:24,*V2LON,AADMNO;
.
          MOVE      ZERO,F1
          MOVE      RECTYPE,F1
          COMPARE   REPORTTY,F1
          GOTO      PEXC4000 IF NOT EQUAL
.
          PACK      KEY8,AURNO
          CALL      RDMAST1                 * Read a master file record
          BRANCH    OVRCD,PEXC2000
.
          BRANCH    OPTION,PEXC2100,PEXC2200,PEXC2300
.
.         Inpatient
.
PEXC2100  MOVE      AADMNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PEXC2000
.
          UNPACK    SP70,DDATE,DTIME
          IF        ASTAT=3
            MOVE      AADMNO,KEY8
            CALL      RDDSCH1
            BRANCH    OVRCD,PEXC2000
          ENDIF
          GOTO      PEXC3000
.
.         Outpatient
.
PEXC2200  PACK      KEY28,CASEKEYS,SP70
          CALL      RDBOKA1
          BRANCH    OVRCD,PEXC2000
.
          MOVE      OBAOUTNO,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,PEXC2000
          CALL      RDPMVX11
          BRANCH    OVRCD,PEXC2000
          MOVE      OBACOMP,ACLAIM
.
          GOTO      PEXC3000
.
.         Emergency
.
PEXC2300  MOVE      AADMNO,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,PEXC2000
          CALL      RDPMVX11
          BRANCH    OVRCD,PEXC2000
          MOVE      EMVICOMP,ACLAIM
.
PEXC3000  COMPARE   "52",CLNO
          CALL      HEAD0000 IF NOT LESS    * Start new page if neccessary
.
          CALL      PLIN0000                * Print details
.
          GOTO      PEXC2000
.
PEXC4000  COMPARE   ONE,REPORTTY
          GOTO      PEXC8000 IF NOT EQUAL
.
          IF        PRNTFLAG=0
            CALL      HEAD0000              * print header for No charges sect.
          ENDIF
.
          MOVE      TWO,REPORTTY            * Invoice raised for Public with HF
          CALL      HEAD0000
          GOTO      PEXC1000
.
PEXC8000  CALL      SUMM0000                * Print summary total
PEXC9999  RETURN
+
.******************************************************************************
.         Print Exception line 
.******************************************************************************
PLIN0000  BRANCH    OPTION,PLIN1000,PLIN2000,PLIN3000
.
.         Inpatient
.
PLIN1000  REP       " 0",ADATE
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the start date
.
          UNPACK    PSNAME,KEY18
          UNPACK    PGNAME,KEY19
          UNPACK    ATIME,KEY5
          PRINT     *1,"|",AURNO,*11,KEY18:
                    *30,KEY19,*50,AADMNO:
                    *60,CPDATE," ",KEY5;
.
          IF        ASTAT=3
            REP       " 0",DDATE
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE                 * Format the start date
            UNPACK    DTIME,KEY5
            PRINT     *75,CPDATE," ",KEY5;
          ENDIF
.
          PRINT     *90,ACLAIM;
.
          MATCH     SP70,AFUNDH
          IF        !@EQUAL
            PRINT     *96,AFUNDH,"/",AFNDTB;
          ENDIF
.
          MATCH     SP70,ACODDTE
          IF        !@EQUAL
            REP       " 0",ACODDTE
            UNPACK    ACODDTE,CCENT,CYEAR,CMON,CDAY
            CALL      PACDATE                 * Format the start date
            PRINT     *112,CPDATE;
          ENDIF
.
          PRINT     *122,PTDSDDRG," ",PTDSVOGU,*132,"|"
          ADD       ONE,CLNO
.
          GOTO      PLIN8000
.
.         Outpatient
.
PLIN2000  REP       " 0",OBADATE
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the start date
          UNPACK    OBATIME,KEY5
          MOVE      OBAOUTNO,AADMNO
          GOTO      PLIN6000
.
.         Emergency
.
PLIN3000  REP       " 0",EMVIDATE
          UNPACK    EMVIDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the start date
          UNPACK    EMVITIME,KEY5
          MOVE      EMVIADMN,AADMNO
.
PLIN6000  UNPACK    PSNAME,KEY18
          UNPACK    PGNAME,KEY19
.
          PRINT     *1,"|",AURNO,*11,KEY18:
                    *30,KEY19,*50,AADMNO:
                    *60,CPDATE," ",KEY5;
.
          PRINT     *90,ACLAIM;
.
          MATCH     SP70,AFUNDH
          IF        !@EQUAL
            PRINT     *96,AFUNDH,"/",AFNDTB;
          ENDIF
.
          PRINT     *132,"|"
          ADD       ONE,CLNO
.
PLIN8000  CALL      PCIN0000                * Print current invoices
          CALL      UND132                  * Print underline
.
PLIN9000  MOVE      ZERO,EXIT
PLIN9999  RETURN
+
.******************************************************************************
.         Print Current invoices
.******************************************************************************
PCIN0000  PACK      KEY16,AADMNO,Z70
          CALL      RDSINV3
PCIN1000  CALL      RDPINV3
          BRANCH    OVRCD,PCIN9999
.
          MATCH     PINVADM,AADMNO
          GOTO      PCIN9999 IF NOT EQUAL  * Different admission no
.
          REP       " 0",PINVDTE
          UNPACK    PINVDTE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the start date
          PRINT     *1,"|",PINVNO:
                    *30,CPDATE,*50,PINVAMT;
.
          REP       " 0",PTINCRST
          MATCH     "0",PTINCRST
          IF        !@EQUAL
            CALL      CRNT0000              * Get Credit note number
          ENDIF
.
          IF        IBCNMHOS=1
            PRINT   *112,PMVXMHOS;
          ENDIF
.
          PRINT     *132,"|"
          ADD       ONE,CLNO
.
          GOTO      PCIN1000
.
PCIN9999  RETURN
+
.******************************************************************************
.         Get Credit Note number for the invoice if any
.******************************************************************************
CRNT0000  PACK      KEY16,PINVNO,SP70
          CALL      RSPMCNO3
          CALL      RKPMCNO3
          BRANCH    OVRCD,CRNT9999
.
          MATCH     PINVNO,PMCNINVN
          GOTO      CRNT9999 IF NOT EQUAL     * Different invoice number
.
          REP       " 0",PMCNDATE
          UNPACK    PMCNDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE                 * Format the end date
          PRINT     *75,PMCNCRNO:
                    *90,CPDATE;
          ADD       ONE,CLNO
.
CRNT9999  RETURN
+
.******************************************************************************
.         Tranfer any tobe invoiced comments to invoiced
.******************************************************************************
INVC0000  PACK      KEY19,DAADMNO,SP70
          CALL      RSPMICM1
          CALL      RKPMICM1
          BRANCH    OVRCD,INVC9999
          MATCH     DAADMNO,PMICVISN      * Same visit no?
          GOTO      INVC9999 IF NOT EQUAL
          MATCH     SP70,PMICINVN
          GOTO      INVC9999 IF NOT EQUAL
.
          MOVE      CNEXTINV,PMICINVN
          PACK      PMICUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMICUDAT
          CLOCK     TIME,PMICUTIM                * System time
          MOVE      USERID,PMICUUID              * web user id
          CALL      UPPMICM1
          GOTO      INVC0000
.
INVC9999  RETURN
+
.******************************************************************************
. Check if invoice can be raised
.******************************************************************************
CRIS0000  MOVE      ZERO,RINVFLAG          * raise invoice flag
.
.         If the Contract is for 'Discharged from' and patient is not Discharged
.         then invoice can not be raised
.
          IF        CNTRCEFR=2 & ASTAT<>3
            PACK      KEY5,ANSC,ANSL,ACLAIM
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "D",TCINDC19
              GOTO      CRIS8000 IF EQUAL        * can not raise invoice
            ENDIF
          ENDIF
.
          COMPARE   ZERO,PTCNIPEN
          GOTO      CRIS1000 IF NOT EQUAL        * Not using Invoice pending
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDIPEN1                      * Read invoice pending record
          BRANCH    OVRCD,CRIS1000
.
          MATCH     SP70,PTIPRHLD                * On hold
          GOTO      CRIS8000 IF NOT EQUAL
.
CRIS1000  CALL      CHCMB000           * check if CMBS completed required
          BRANCH    EXIT,CRIS8000
.
          MATCH     ANSY,PTMICMXP
          GOTO      CRIS9999 IF NOT EQUAL
.
          COMPARE   THREE,ASTAT
          GOTO      CRIS8000 IF NOT EQUAL         * not discharge
.
.         If Prov.Casemix code is not blank and Matrix is not found, disable
.         Raise invoice button
.
          MATCH     SP70,PTMIPCMX                 * Prov.Casemix code
          IF        !@EQUAL
            BRANCH    MATRXFLG,CRIS8000           * from DINV0000 routine
          ENDIF
          GOTO      CRIS9999
.
CRIS8000  MOVE      ONE,RINVFLAG                  * can not raise invoice
CRIS9999  RETURN
+
.******************************************************************************
. Check if Theatre complete is required
.******************************************************************************
CHCMB000  MOVE      ZERO,EXIT
          READ      CONTROLF,HUND12;*102,PTCNHITC
.
          MATCH     "0",PTCNHITC          * not required
          GOTO      CHCMB999 IF EQUAL
.
          MATCH     "1",PMVXATCP
          GOTO      CHCMB999 IF EQUAL   * all theatre charges posted
.
          PACK      KEY31,AADMNO,SP70   * has the patient been to theatre?
          CALL      RSOPDEA2
CHCMB100  CALL      RKOPDEA2
          BRANCH    OVRCD,CHCMB999
.
          MATCH     KEY8,OPDAADMN
          GOTO      CHCMB999 IF NOT EQUAL
.
.         OPDASTAT=0 Booked, 1=Preadmitted 2=Admitted 3=Cancelled 4=Discharged
.
          BRANCH    OPDASTAT,CHCMB999,CHCMB200,CHCMB100,CHCMB200
          GOTO      CHCMB999
.
.         Check booking type
.
CHCMB200  OPEN      BOKRC1A1,"bokrc1af"
          MOVE      AADMNO,KEY8
          CALL      RDBKREC1
          BRANCH    OVRCD,CHCMB900
.
          PACK      KEY5,ANSB,ANSK,BKRETYPE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHCMB900
          MATCH     "C",TCINDC1
          GOTO      CHCMB999 IF EQUAL       * not required theatre complete
.
CHCMB900  MOVE      ONE,EXIT                * can not raise invoice
.
CHCMB999  RETURN
+
.******************************************************************************
.*                                  HEAD0000              Called by: PROC0000 *
.*                             Print Report Header                            *
.******************************************************************************
HEAD0000  CALL      HEAD132                 * Print report header
          MOVE      CLAIMDES,KEY20
          STRIP     KEY20
          CLEAR     KEY60
          APPEND    KEY20,KEY60
          BRANCH    OPTION,HEAD1000,HEAD2000,HEAD3000
.
HEAD1000  APPEND    SP70,KEY60
          RESET     KEY60
.
          PRINT     *N,*40,"Report Type         : Coding Complete by ":
                          KEY60:
                    *N,*40,"Coding Date Range   : ",DSPSTDTE:
                       *72," to : ",DSPEDDTE:
                    *N,*40,CLAIMDES,": ",PUBCDESC;
          GOTO      HEAD5000
.
HEAD2000  APPEND    " within a Date Range",KEY60
          APPEND    SP70,KEY60
          RESET     KEY60
.
          PRINT     *N,*40,"Report Type             : ",KEY60:
                    *N,*40,"Attendance Date Range   : ",DSPSTDTE:
                       " to ",DSPEDDTE:
                    *N,*40,CLAIMDES,"    : ",PUBCDESC;
          GOTO      HEAD5000
.
HEAD3000  APPEND    " within a Date Range",KEY60
          APPEND    SP70,KEY60
          RESET     KEY60
.
          PRINT     *N,*40,"Report Type             : ",KEY60:
                    *N,*40,"Attendance Date Range   : ",DSPSTDTE:
                       " to : ",DSPEDDTE:
                    *N,*40,CLAIMDES,"    : ",PUBCDESC;
.
HEAD5000  IF        EXCLINVD=1
            PRINT     *N,*40,"Excluding Invoiced Patients"
          ELSE
            PRINT     *N,*40,"Including Invoiced Patients"
          ENDIF
.
          IF        REPORTTY=1
            PRINT     *50,"No Charges to be Raised",*N
            MOVE      ONE,PRNTFLAG
          ELSE
            PACK      KEY20,PUBCDESC,SP70
            STRIP     KEY20
            CLEAR     KEY40
            APPEND    KEY20,KEY40
            APPEND    " with a Health Fund",KEY40
            APPEND    SP70,KEY40
            RESET     KEY40
            PRINT     *50,KEY40,*N
          ENDIF
          ADD       "7",CLNO
.
          CALL      PHED0000
.
HEAD9000  MOVE      ZERO,EXIT
HEAD9999  RETURN
+
.******************************************************************************
.*                                  PHED0000                                  *
.*                           Print Report Header                              *
.******************************************************************************
PHED0000  CALL      UND132                  * Print underline
          BRANCH    OPTION,PHED1000,PHED2000,PHED2000
.
PHED1000  PRINT     *1,"|U/R ##",*11,"Patient Surname":
                    *30,"Patient Given Name",*50,"Admission ##":
                    *62,"Adm Date/Time",*76,"Dis Date/Time":
                    *90,CLMDESC,*97,"Fund/Table":
                    *109,"Coding Date",*121,"DRG/Version",*132,"|",*N:
                    *1,"|Invoice Number":
                    *30,"Invoice Date",*50,"Invoice Amount":
                    *76,"Credit Note ##":
                    *90,"Credit Note Date";
          GOTO      PHED5000
.
PHED2000  PRINT     *1,"|U/R ##",*11,"Patient Surname":
                    *30,"Patient Given Name",*50,"Visit ##":
                    *62,"Attendance Date/Time":
                    *90,CLMDESC,*97,"Fund/Table":
                    *132,"|",*N:
                    *1,"|Invoice Number":
                    *30,"Invoice Date",*50,"Invoice Amount":
                    *76,"Credit Note ##":
                    *90,"Credit Note Date";
.
PHED5000  IF        IBCNMHOS=1
            PRINT     *109,"Hospital ID";
          ENDIF
          PRINT     *132,"|"
.
          CALL      UND132                  * Print underline
          ADD       "2",CLNO
.
PHED9000  MOVE      ZERO,EXIT
PHED9999  RETURN
+
.******************************************************************************
.*                                  SUMM0000              Called by: PRNT0000 *
.*                              Print Report Summary                          *
.******************************************************************************
SUMM0000  PRINT     *N,*1,"Totals ":
                    *N,*1,"No.of Visits           =",TOTVIST:
                    " - No of Patients with no charges to be raised":
                    *N,*1,"No.of Invoices         =",TOTINVC:
                    " - No of Invoices raised for ",CLAIMDES:
                    *N,*1,"No.of Health Fund      =",TOTHFND:
                    " - No of Invoices raised with Health fund      ":
                    *N
.
SUMM9999  RETURN
+
.******************************************************************************
.*                                  CREA0000                                  *
.*                  Create a tempfile for the Exception report                *
.******************************************************************************
CREA0000  CALL      KILL0000                * deleting temporary file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISBUILD,FNAMEC,UKEY1
          EXECUTE   CMDLINE,TASKID
          OPEN      EXCPFIL1,FNAMEC
          OPEN      EXCPFIL2,FNAMEC
.
CREA9999  RETURN
+
.******************************************************************************
.*                       Deleting an indexed file                             *
.******************************************************************************
KILL0000  CLOSE     EXCPFIL1
          CLOSE     EXCPFIL2
          CLEAR     CMDLINE
          PACK      CMDLINE,ERASE,FNAMEC         * set file erase command
          EXECUTE   CMDLINE,TASKID               * erase temp file
.
KILL9999  RETURN
+
.*****************************************************************************
.*                             CLRF0000                                      *
.*               Clear temporary table records                               *
.*****************************************************************************
CLRF0000  MOVE      ZERO,EXIT
.
CLRF3000  MOVE      SP70,KEY9
          CALL      RSEXCA1                      * position at start of file
          CALL      RKEXCA1                      * read next record
          BRANCH    OVRCD,CLRF9999               * end of file - finished
.
          PACK      KEY9,RECTYPE,DAADMNO,SP70
          CALL      DEEXCA1                      * delete record
          GOTO      CLRF3000                     * get next record
.
CLRF9999  RETURN
+
.------------------------------------------------------------------------------
.* Temp file IO
.------------------------------------------------------------------------------
RSEXCA1   RESET     KEY9
          READ      EXCPFIL1,KEY9;;
          RETURN
.
RKEXCA1   MOVE      ZERO,OVRCD
          READKS    EXCPFIL1;RECTYPE,AURNO,DAADMNO,AFUNDH,CASEKEYS
          GOTO      OVERCOND IF OVER
          MOVE      DAADMNO,AADMNO
          RETURN
.
WREXCA1   MOVE      ZERO,OVRCD
          WRITE     EXCPFIL1,KEY9;RECTYPE,AURNO,DAADMNO,AFUNDH,CASEKEYS
          GOTO      OVERCOND IF OVER
          RETURN
.
DEEXCA1   RESET     KEY9
          DELETE    EXCPFIL1,KEY9
          RETURN
.
RSEXCA2   RESET     KEY17
          READ      EXCPFIL2,KEY17;;
          RETURN
.
RKEXCA2   MOVE      ZERO,OVRCD
          READKS    EXCPFIL2;RECTYPE,AURNO,DAADMNO,AFUNDH,CASEKEYS
          GOTO      OVERCOND IF OVER
          MOVE      DAADMNO,AADMNO
          RETURN
.
. =========================================================================
.         I/O Includes
. =========================================================================
RDADMB1
SBDY0000
ADDWRN00
OPEN0000
CLOS0000
WEBERR00
GETSVAR
PRTIPROV  RETURN
.
.------------------------------------------------------------
. Procedure to get Doctor Code from Outpatient Clinic ID
. COPTION - 1 Return DOCTCODE
.           2 Output Location
.           3 (N/A)
.           4 Output Menu Type
.           5 Output Unit
.------------------------------------------------------------
          DEFPROC  OUTDET00
.
          INC      OUTPREFD/INC
          INC      OUTCLIFD/INC
          INC      OUTBOAFD/INC
          INC      OUTMA1FD/INC
          INC      OUTBB1FD/INC
.
KEYBOA    DIM      28
KEYCLI    DIM      20
TESTSITE  DIM      6
TESTCLIN  DIM      6
.
          MOVE     SP70,DOCTCODE
          COMPARE  ZERO,PVITYPE
          GOTO     OUTDET50 IF EQUAL
.
          PACK     KEY6,PVISITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYCLI,PVISITE,PVIDOCT,PVIDATE,SP70
          BRANCH   COPTION,OUTDET60
.
          PACK     KEY8,OSTFILE,FILBOKA1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKA1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYBOA,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY28,PVISITE,PVIDOCT,PVIDATE,SP70
          PACK     KEY20,PVISITE,PVIDOCT,PVIDATE,SP70
          CALL     RDSBOKA1
OUTDET10  CALL     RDKBOKA1
          BRANCH   OVRCD,OUTDET95
          PACK     KEYBOA,OBASITE,OBACLIN,OBADATE,OBASTRT,OBASLOT,SP70
          MATCH    KEY20,KEYBOA
          GOTO     OUTDET95 IF NOT EQUAL
          MATCH    OBAOUTNO,PVIBILL         * Set up billing number
          GOTO     OUTDET10 IF NOT EQUAL
          GOTO     OUTDET80
.
OUTDET50  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     OUTPREA1,"outpreaf"   * Pre Attendance File
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
          MOVE     ADMISSNO,KEY8
          CALL     RDPREA1               * Check for Pre-Attendance
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY6,OPRSITE,SP70
          CALL     RDSITA1
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEYCLI,OPRSITE,OPRCLIN,OPRDATE,SP70
          PACK     KEYBOA,OPRSITE,OPRCLIN,OPRDATE,OPRSTRT,OPRSLOT
.
          BRANCH   COPTION,OUTDET60,OUTDET70,OUTDET70,OUTDET70
.
OUTDET60  MOVE     ZERO,OVRCD
          PACK     KEY8,OSTFILE,FILCLIA1 * Determine Doctor from Clinic ID
          TRAP     OVERCOND IF IO
          OPEN     OUTCLIA1,KEY8         * Clinic Details
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK      KEY20,KEYCLI,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,KEYCLI,Z70
            CALL      RDSCLIA1          * Read Clinic Record
            CALL      RDPCLIA1          * Read Clinic Record
            BRANCH    OVRCD,OUTDET95
.
            UNPACK    KEYCLI,TESTSITE,TESTCLIN
.
            MATCH     TESTSITE,OCASITE
            GOTO      OUTDET95 IF NOT EQUAL
.
            MATCH     TESTCLIN,OCACLIN
            GOTO      OUTDET95 IF NOT EQUAL
          ENDIF
.
          MOVE     OCADOCT,DOCTCODE
          MATCH    SP70,DOCTCODE
          IF       @EQUAL
            MOVE     OCACCONS,DOCTCODE
          ENDIF
          MOVE     ZERO,EXIT
          GOTO     OUTDET99
.
OUTDET70  PACK     KEY8,OSTFILE,FILBOKA1 * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTBOKA1,KEY8         * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          MOVE     KEYBOA,KEY28
          CALL     RDBOKA1
          BRANCH   OVRCD,OUTDET95
.
OUTDET80  IF       COPTION=4
            PACK     MENUTYPE,TWO,OBASTAT * Outpatient Booking
            MOVE     ZERO,EXIT
            GOTO     OUTDET99
          ENDIF
.
          IF       COPTION=5
            PACK     CFNAME,OSTFILE,FILBB1A1
            CALL     OPOTBB11
            MOVE     ADMISSNO,KEY8
            CALL     RDBOKB1
            IF       OVRCD=0
              MATCH    SP6,OTBBDEPT
              GOTO     OUTDET95 IF EQUAL
              MOVE     OTBBDEPT,CODE       * Unit code
              MOVE     ZERO,EXIT
            ENDIF
            GOTO     OUTDET99
          ENDIF
.
          MOVE     ZERO,OVRCD
          PACK     KEY8,OSTFILE,FILMA1A1  * Determine Location from Masterfile
          TRAP     OVERCOND IF IO
          OPEN     OUTMA1A1,KEY8          * Master
          TRAPCLR  IO
          BRANCH   OVRCD,OUTDET95
.
          PACK     KEY18,OBASITE,OBACLIN,OBADAY,OBASTRT
          CALL     RDMASA1
          BRANCH   OVRCD,OUTDET95
.
          WRITE    HTMLFILE;OTMACLOC;
          MOVE     ZERO,EXIT
          GOTO     OUTDET99
.
OUTDET95  MOVE     ONE,EXIT
          GOTO     OUTDET99
.
          INC       OUTCLIIO/INC
          INC      OUTPREIO/INC
          INC       OUTBOAIO/INC
          INC       OUTMA1IO/INC
          INC       IBAOVRIO/INC
          INC       OUTBB1IO/INC
.
OUTDET99  ENDPROC
.------------------------------------------------------------
. Procedure to get Emergency Details
.   COPTION = 1 Return Consultant DOCTCODE
.             2 Output Location
.             3 Output Triage Status
.             4 Output Menu Type
.------------------------------------------------------------
          DEFPROC  EMRCHK00
.
          INC      EMRVISFD/INC
          INC      EMRLOCFD/INC
.
EMRCHK10  MOVE     ZERO,OVRCD
          TRAP     OVERCOND IF IO
          OPEN     EMRVISA1,"emrvisaf"
          TRAPCLR  IO
          BRANCH   OVRCD,EMRCHK90
.
          MOVE     ADMISSNO,KEY8
          CALL     RDEMVIS1
          BRANCH   OVRCD,EMRCHK90
.
          COMPARE  FOUR,EMVISTAT
          GOTO     EMRCHK90 IF EQUAL
.
          MOVE     EMVIDOCT,DOCTCODE
          IF       COPTION=4
            PACK     MENUTYPE,ONE,EMVISTAT
            GOTO     EMRCHK99
          ENDIF
          IF       COPTION=2
            IF       EMVISTAT=1
              OPEN     EMRLOCA1,"emrlocaf"
              MOVE     "Other Departments",EMLODESC
              MOVE     EMVILOCN,KEY3
              CALL     RDEMLOC1
              WRITE    HTMLFILE;"Emergency - ",EMLODESC;
            ELSE
              WRITE    HTMLFILE;"Discharged";
            ENDIF
          ENDIF
          IF       COPTION=3
            WRITE    HTMLFILE;EMVITRIG;
          ENDIF
          GOTO     EMRCHK99
.
EMRCHK90  MOVE     PVIDOCT,DOCTCODE
          IF       COPTION=2
            WRITE    HTMLFILE;"Emergency";
          ENDIF
          GOTO     EMRCHK99
.
          INC      EMRVISIO/INC
          INC      EMRLOCIO/INC
          INC       IBAOVRIO/INC
.
EMRCHK99  ENDPROC
.*****************************************************************************
.*  GETALTID
.*  Procedure to get an alternate ID
.*  Exit=0  No alternate ID
.*       1  Alternate ID's exist
.*****************************************************************************
          DEFPROC   GETALIDS
.
          INC       PMSAIDFD/INC
.
          MOVE      ZERO,EXIT
          PACK      KEY20,SP70
          OPEN      PMSAIDA1,"pmsaidaf"
.
          PACK      KEY31,PURNO,SP70
          CALL      RSPMAID1           * Read alternate id Table
GETALI10  CALL      RKPMAID1
          BRANCH    OVRCD,GETALI99
.
          MATCH     PURNO,PMAIURNO     * Check same UR
          GOTO      GETALI99 IF NOT EQUAL
.
          MATCH     "1",PMAIDISU
          GOTO      GETALI10 IF NOT EQUAL
.
          PACK      KEY20,PMAIALID,SP70
          MOVE      ONE,EXIT
          GOTO      GETALI99
.
          INC       PMSAIDIO/INC
          INC       IBAOVRIO/INC
.
GETALI99  CLOSE     PMSAIDA1
.
          ENDPROC

.**********************************************************************
.         Update Default Printer File for User
.**********************************************************************
UPDFPT00  MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          PACK      KEY20,PRGID,KEY2,WBSEUID,SP70
          UNPACK    KEY20,IBPDPID,IBPDREP,IBPDUID
          MOVE      SELPRINT,IBPDPRT
          MOVE      SP70,IBPDSPA
          CALL      RAIBPD1
          IF        OVRCD=0
            CALL      UPIBPD1
          ELSE
            CALL      WRIBPD1
          ENDIF
UPDFPT99  RETURN
.==============================================================================
.****************************************************************************
.  SINVH000 - Set up invoice header for stationery templating
.****************************************************************************
SINVH000  OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          MOVE      PTCNPAIH,KEY6
          CALL      RDIBTH1                   * read header detail file
          BRANCH    OVRCD,SINVH900
.
          PACK      KEY12,PTCNPAIH,SP6        * position on details file
          CALL      RSIBDET1
          CALL      RKIBDET1
          BRANCH    OVRCD,SINVH900
.
          MATCH     PTCNPAIH,IBDTSCOD         * match stationery codes
          GOTO      SINVH950 IF EQUAL
.
.------ stationery code not on file ------
.
SINVH900  DISPLAY   *P1:24,*EL,*B:
                    "User Defined Stationery Code not on File. ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      SINVH999
.
SINVH950  MOVE      ZERO,EXIT
SINVH999  RETURN
+
.****************************************************************************
.  SINVT000 - Set up invoice tail for stationery templating
.****************************************************************************
SINVT000  OPEN      IBATMHA1,"ibatmhaf"
          OPEN      IBATDET1,"ibatmdaf"
.
          READ      CONTROLF,NINTY8;*136,PTCNPAIH,*142,PTCNPAIT
          MOVE      PTCNPAIT,KEY6
          CALL      RDIBTH1                   * read header detail file
          BRANCH    OVRCD,SINVT900
.
          PACK      KEY12,PTCNPAIT,SP6        * position on details file
          CALL      RSIBDET1
          CALL      RKIBDET1
          BRANCH    OVRCD,SINVT900
.
          MATCH     PTCNPAIT,IBDTSCOD         * match stationery codes
          GOTO      SINVT950 IF EQUAL
.
.------ stationery code not on file ------
.
SINVT900  DISPLAY   *P1:24,*EL,*B:
                    "User Defined Stationery Code not on File. ";
          CALL      HITENTER
          MOVE      ONE,EXIT
          GOTO      SINVT999
.
SINVT950  MOVE      ZERO,EXIT
SINVT999  RETURN
+
.******************************************************************************

.
          INC       STD001IO
          INC       STDHLPCD
          INC       STDKWSCD
          INC       CLPATMAS           * for PATSRCH
          INC       CLPATINV
          INC       CLNZPPIC
          INC       CMXMATRX
          INC       IBAPRINT
          INC       IBAGSTKY
          INC       IBAGKIKY
          INC       NHOSPDAY
          INC       NZHISIIO           * for NZIBSRCH
          INC       NZIBSRCH           * for PATSRCH
          INC       PATITMRD
          INC       PATCALFN
          INC       PATCATAI
          INC       PATCATBI
          INC       PATCOMN1
          INC       PATCOMN3
          INC       PATGBCRN           * I-48227
          INC       PATGNCMX
          INC       PATINVS
          INC       CMGETTHR
          INC       PATIVMES
          INC       PABXBILL
          INC       CLPATDTR
          INC       KYPTBANK                 * Banking has started message
          INC       OUTCATBI
          INC       AAECATBI
          INC       CHKCLDCP
.
          INC       PATRECAL
          INC       PATSNDX
          INC       PATSNX2
          INC       PATTRRAT
          INC       STEPDOWN
          INC       PATCMSTP
          INC       CHKCMXPT
          INC       CALCDAYS
          INC       CHNADMTP
          INC       GETBFEES
          INC       PATMCHRD
.
          INC       PATHSPKY
          INC       PATALWDS
          INC       PATCODDS
          INC       PATWRDDS
          INC       PATDOCCD
          INC       NAMSTRCD
          INC       SEXDSP00
.
          INC       IBAPOLIO/INC
          INC       AAEDE1IO/INC
          INC       AAEDTRIO/INC
          INC       BOKRC1IO/INC
          INC       OUTCLIIO/INC
          INC       EMRSITIO/INC
          INC       EMRHISIO/INC
          INC       EMRVISIO/INC
          INC       IBAGSTIO/INC
          INC       IBAGEDIO/INC
          INC       IBAPRNIO/INC
          INC       IBAPDFIO/INC
          INC       IBATMDIO/INC
          INC       IBATMHIO/INC
          INC       COMDEPIO/INC
          INC       MLTCFNIO/INC
          INC       NZPEXTIO/INC
          INC       NZPRDTIO/INC
          INC       NZPBFEIO/INC
          INC       NZPCFNIO/INC
          INC       NZPCMTIO/INC
          INC       NZPFIGIO/INC
          INC       NZPIBRIO/INC
          INC       NZPIRNIO/INC
          INC       NZPMCHIO/INC
          INC       NZPMXCIO/INC
          INC       NZPPFEIO/INC
          INC       NZPPICIO/INC
          INC       NZPRBRIO/INC
          INC       NZPRFNIO/INC
          INC       NZPFINIO/INC
          INC       NZPSPRIO/INC
          INC       NZPTFEIO/INC
          INC       NZPIVBIO/INC
          INC       NZPRVBIO/INC
          INC       OPRSESIO/INC
.
          INC       OUTBB1IO/INC
          INC       OUTBOAIO/INC
          INC       OUTDTRIO/INC
          INC       OUTPREIO/INC
          INC       OUTSITIO/INC
          INC       OUTCTYIO/INC
          INC       PATINMIO/INC
          INC       PATCFAIO/INC
          INC       PMSABFIO/INC
          INC       PMSPWAIO/INC
          INC       PMSICMIO/INC
          INC       PMSCIDIO/INC
          INC       PMSCCDIO/INC
          INC       PMSTLEIO/INC
          INC       PATCRAIO/INC
          INC       PATCURIO/INC
          INC       PATDRGIO/INC
          INC       PATECOIO/INC
          INC       PATECDIO/INC
          INC       PATECHIO/INC
          INC       PATFEEIO/INC
          INC       PATINLIO/INC
          INC       PATALWIO/INC
          INC       PATBFEIO/INC
          INC       PATCODIO/INC
          INC       PATDO1IO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PATEDSIO/INC
          INC       PATEDTIO/INC
          INC       PATFACIO/INC
          INC       PATFINIO/INC
          INC       PATFMOIO/INC
          INC       PATFN1IO/INC
          INC       PATFN2IO/INC
          INC       PATFIGIO/INC
          INC       PATFX1IO/INC
          INC       PATFHIIO/INC
          INC       PATGTUIO/INC
          INC       PATIBLIO/INC
          INC       PATICUIO/INC
          INC       PATIN1IO/INC
          INC       PATINVIO/INC
          INC       PATIOVIO/INC
          INC       PATIPEIO/INC
          INC       PATIRNIO/INC
          INC       PATITMIO/INC
          INC       PATJRNIO/INC
          INC       PATMA1IO/INC
          INC       PMSPX2IO/INC
          INC       PATMCHIO/INC
          INC       PATMI1IO/INC
          INC       PATMMBIO/INC
          INC       PATOVBIO/INC
          INC       PATPGRIO/INC
          INC       PATPR1IO/INC
          INC       PATRBLIO/INC
          INC       PATRE1IO/INC
          INC       PATRCAIO/INC
          INC       PATSRBIO/INC
          INC       PATGSRIO/INC                 * Surname / Given Name File
          INC       PATTFEIO/INC
          INC       PATTRNIO/INC
          INC       PATVENIO/INC
          INC       PATVISIO/INC
          INC       PATWC1IO/INC
          INC       PATWMAIO/INC
          INC       PATWR1IO/INC
          INC       PATWVEIO/INC
          INC       NHIMASIO/INC       * for PATSRCH
          INC       PATDNRIO/INC
          INC       PATSDNIO/INC
          INC       PATSMWIO/INC
          INC       PATNIDIO/INC
          INC       PATALRIO/INC
          INC       PATNOBIO/INC
          INC       PMSEVTIO/INC
          INC       PMSHATIO/INC
          INC       PMSHCPIO/INC
          INC       PMSSINIO/INC
          INC       PATCMTIO/INC
          INC       PMSCMTIO/INC
          INC       PMSECTIO/INC
          INC       PMSVX1IO/INC
          INC       PMSCNOIO/INC
          INC       PMSFCIIO/INC
          INC       PMSSGAIO/INC
          INC       PMSMTIIO/INC
          INC       PMSMPRIO/INC
          INC       PMSBISIO/INC
          INC       PMSBBIIO/INC
          INC       VISPAYIO/INC
          INC       WEBSECIO/INC
          INC       PATHTRIO/INC
          INC       EMRHTRIO/INC
          INC       OUTHTRIO/INC
.
          INC       PRIITMIO/INC
          INC       PATELGIO/INC
          INC       PATRATIO/INC
          INC       PATREMIO/INC
          INC       PATRFNIO/INC
          INC       PATRFGIO/INC
          INC       PATSGCIO/INC
          INC       PATAFEIO/INC       * for casemix
          INC       PATASDIO/INC
          INC       PATCMXIO/INC
          INC       PATCTFIO/INC
          INC       PATDGWIO/INC
          INC       PATHDFIO/INC
          INC       PATHLFIO/INC
          INC       PATHSPIO/INC
          INC       PATONHIO/INC
          INC       PATICDIO/INC
          INC       PATIPRIO/INC
          INC       PATINVTL
          INC       PATINVHL
          INC       PRTINVBD
          INC       PATLDFIO/INC
          INC       PATLSDIO/INC
          INC       PMSEXTIO/INC
          INC       PMSPRGIO/INC
          INC       PATAA1IO/INC
          INC       PATSTAIO/INC
.
          INC       OPRDEAIO/INC
          INC       OPRDECIO/INC
          INC       OPRSRGIO/INC
.
          INC       OPRARDIO/INC
.
          INC       RCPBNKIO/INC
          INC       RCPDTEIO/INC
          INC       RCPBDTIO/INC
          INC       RCPCRSIO/INC
          INC       WEBSCHIO/INC
          INC       PMSPYRIO/INC
          INC       PMSPBRIO/INC
          INC       PMSIDEIO/INC
          INC       PMSIVBIO/INC
          INC       PMSEDGIO/INC       * Effective DRG Dates
          INC       WEBERRIO/INC            * Web Server Error Logging
          INC       WEBIHCIO/INC
          INC       PATDDHIO/INC
.
          INC       PMIHEAD
          INC       PATALERT
          INC       PATHEAD
          INC       GETALTID
          INC       GETTFEES
          INC       GETCNEFF
          INC       ICDSCLAS
          INC       CLPMSIDE
          INC       TFILENAM                * Generate Temp File Name
.
          INC       PATIPERH
          INC       PATITMDS
          INC       CALCAGE
          INC       CHKSUGCL
          INC       PATSTRYR
          INC       PATCKEXC
          INC       RSHWEBCD
          INC       SGCHKDIG
          INC       PMSOSDTM              * Outstanding Debt alert routine
          INC       VALCMXFN
          INC       GETEFDRG
.
AGECHK    RETURN
.
.

+
.

