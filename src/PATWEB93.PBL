.-------------------------------------------------------------------------
.
. Program       : PATWEB93
.
. Function      : Ward Patient List Server
.
. Modifications : 
.
.-------------------------------------------------------------------------
. V12.01.02 14/01/2026  Ebon Clements  TSK 0963446
.           Display Cab diet description from cat MJ PMNUDTYP - CBEDK000 - 33
. V12.01.01 15/12/2025  PJ Le Febour   TSK 0963446
.           Added print Diet desc alongside Diet Icon for CAB        
. V12.00.08 07/10/2025  Ebon Clements  TSK 0968096
.           Added custom print-key attribute for bulk A4 labels sheet
.           printing - CBEDG300
. V12.00.07 30/09/2025  Bella Turco    TSK 0955574
.           Fixed order of WRPTATR3 keypack in DIDEUC50
. V12.00.06 03/09/2025  Peter Vela     TSK 0947378
.           Fixed DIDEUC00/PATATRaf processing  for Update Condition DFrame /
.           Medically Cleared for Discharge workflow
. V12.00.05 19/08/2025  PJ Le Febour   TSK 0965390
.           added read CONTROLF HUND10 PTCNDAUR - disp altID instead UR
.           added AlternateID - MBEDH100
. V12.00.04 09/07/2025  Alina Bhari    TSK 0962469
.           Moved space to unused variable PATLINK used in Ward whiteboard 
.           - MBEDH000                                                     
. V12.00.03 23/06/2025  Ebon Clements  TSK 0962469
.           PACK DISWAFIL with SP70 in SETPAR00
. V12.00.02 10/06/2025  Jacob Jackson  TSK 0947378
.           Porting changes from 11.05.08 & 11.05.09 to 12.00
. V12.00.01 21/05/2025  Ebon Clements  TSK 0955096
.           Alphanueric visit number changes
. V11.05.07 28/04/2025  Bella Turco    TSK 0955098
.           Fixed tablesort fields for pmsworaf CBEDK000                        
. V11.05.06 14/04/2025  Jacob/Sunny    TSK 0947378  
.           Add fields to "Update Condition" template and allow them to be
.           submitted, also add "Primary Reason for Discharge Delay" to
.           column in discharge delay             
. V11.05.05 14/04/2025  Bella Turco    TSK 0955098
.           Added functionality for new columns in My Ward View Cabrini template
.           CBEDK000
. V11.05.04 25/02/2025  PJ Le Febour   TSK 0955193
.           added CLRVXD00 in CLRPAR00 to clear cgi visxdcaf
. V11.05.03 06/02/2025  Alina Bhari    TSK 0951353
.           Added  Aboriginality Icon - MBEDH100,CBEDK130,CBEDG130,CBEDI130
. V11.05.02 16/12/2024  Thanh T        TSK 0940638
.           Added GETHIS00 and ADDHIS00 for history comments
. V11.05.01 16/12/2024  Thanh T        TSK 0955017
.           Changed MEDCLR00 to fix issue with admission date not showing
.           correctly
. V11.04.10 09/08/2024  Ebon Clements  Task 0949999
.           Corrected DC past red highlight - SEXPCL00
. V11.04.09 26/07/2024  Peter Vela     Task 0949702
.           Recompiled for FHRDATCD
. V11.04.08 27/06/2024  Nikitha B      TSK 0948028
.           Added check at ALERT100 to skip Alerts if future end date pass
.           current date.
. V11.04.07 25/06/2024  Bella Turco    TSK 0947816 
.           Changed 'Gender' to short desc of cat G in patient onhover details
.           for Oncology templates
. V11.04.06 01/05/2024  Jacob Jackson   TSK 0941762
.           Allow server to receive empty MRFDDATE values to be updated
. V11.04.05 26/04/2024  Jacob Jackson   TSK 0941762
.           Recompiled for PATECDFD
. V11.04.04 24/04/2024  Jacob Jackson  TSK 0941762
.           Upload and display "Reason for Discharge Delay" & "Clinically Ready 
.           for Discharge Date" input values to VSXDCOD2/VSXDDAT1 input value 
.           to VSXDCOD2.
. V11.04.03 02/04/2024  Thanh T        TSK 0940239
.           Added Medically Cleared for Discharge Date/time to condition
.           column         
. V11.04.02 05/03/2024  Nikitha B      TSK 0940727
.           Made View only if "Oncology Outliers template" at BMRW1300.
. V11.04.01 28/11/2023  Nikitha B      TSK 0936214a
.           Changed CBDMSKA1 to show yellow instead of red color for
.           on leave bed column
. V11.03.28 14/11/2023  Thanh T        TSK 0936214
.           Changed CTABG850 to show yellow instead of red color for 
.           on leave bed column
. V11.03.27 31.10.2023  DA Sarkies     TSK 0936698 
.           Refactored code back to original but kept filter. Changed colours
.           in the HEA section of the code
. V11.03.26 27.10.2023  DA Sarkies     TSK 0936698 
.           Added filter to exclude files where the expected ward and post op   
.           ward is the same. Changed code so that display appears red where
.           they are a pre-admission.
. V11.03.25 26.10.2023  DA Sarkies     TSK 0936698 
.           Created filter to exclude Bed Requests from Expected Theatre Booking
.           patients. Changed so that admitted patients black and pre-admit/
.           booked paitents red.
. V11.03.24 03.10.2023  DA Sarkies     TSK 0936698 
.           Reverted changes back to previous version
. V11.03.23 03.10.2023  DA Sarkies     TSK 0936698 
.           Moved the Font Colour styles from EXPRA700 to EXPRA600
. V11.03.22 15.09.2023  DA Sarkies     TSK 0935072
.           Added Status filter for FHIR API
. V11.03.21 28/08/2023  Thanh T        TSK 0935071
.           Changed CBEDG000 CBEDK000 to check FRSTDATE/LASTDATE filter
.           against admission date for FHIR Encounter
. V11.03.20 17/08/2023  J.Tan          TSK 0928105
.           Fixed key for patatraf file
. V11.03.19 11/08/2023  Peter Vela     TSK 0927262
.           Added FHRCON00 - Patient Resource contacts object for FHIR api
. V11.03.18 08.08.2023  Peter Vela     TSK 0921086
.           added tag to display CONTROLF variable PTCNNMPR
. V11.03.17 01/08/2023  Peter Vela     TSK 0927262
.           Recompiled for FHRDATCD
.           Added dxc-hc-hcp and dxc-hc-speciality extensions
. V11.03.16 24/07/2023 Thanh T        TSK 0930508
.           Recompiled as PMSVX1TM changes 
. V11.03.15 21/07/2023 Jacob Jackson   TSK 0927731
.           Fix issue where certain queries would not return multiple
.           location objects
. V11.03.14 13/07/2023 Don Nguyen      TSK 0934707
.           Fixed bug where line 2 of existing 'History' comments (PMVXUDF2 -
.           'User Defined Free Format 2') was getting overwritten with space
.           if 'Update Condition' was posted and the 'History' text area was
.           not present on the screen; Modified UPDCON30 / UPDCON40 to only
.           update PMVXUDF2 with the value of PATCONTL if the field is posted.
. V11.03.13 30.06.2023 DA Sarkies      TSK 0921086
.           Added new variable SHWPHOTO
. V11.03.12 29.06.2023 DA Sarkies      TSK 0921086
.           Extended the details of the patient that are sent to the front
.           end for the patient cells 
. V11.03.11 22/06/2023 Jacob Jackson   TSK 0927731
.           Add changes so that FHIR Response contains a location object
.           for Ward and an object for Bed
. V11.03.10 23/05/2023  Peter Vela     TSK 0927399
.           Recompiled for FHRDATCD - Changed gender validation to
.           Indicator 7
. V11.03.09 17/05/2023  Ebon Clements  TSK 0932616
.           Recompiled for PMSPX2TM - Current IP
. V11.03.08 04/05/2023  Peter Vela     TSK 0927262
.           ClinicalAide FHIR API
.           Added Participant include FHRPARIN functionality
.           Added Location include  FHRLOCIN functionality
. V11.03.07 28/04/2023  Thanh T.       TSK 0929220
.           Changed EXPTA200 to fix issue with expected patient not
.           displayed in red
. V11.03.06 28/02/2023  Peter Vela TSK 0909393
.           Changed KEY for oprsesaf reads
. V11.03.05 25/01/2023  Thanh T.       TSK 0928836 
.           Changed CADM7900 to show the Mechanical Ventilation icon for
.           accessing to Mechanical Ventilation details
. V11.03.04 09/12/2022  Ebon Clements  TSK 0920995
.           Restore ward classification SAVCLASS aftre close bed check CBEDK000
. V11.03.03 09/12/2022  Ebon Clements  TSK 0920995
.           Added hidden bed name field for sorting - CBDMSK00
. V11.03.02 06/12/2022  Ebon Clements  TSK 0920995
.           Added deftview tag to at CADM8000
.           Fixed display of empty, on leave and standy beds - CBDMSK00
. V11.03.01 04/11/2022  Thanh T        TSK 0920995
.           Added CADM7900 to replace CAMD7400 for HEA to use Sort table
.           for patient list.
. V11.02.20 08/11/2022  Bella Turco    TSK 0925948
.           Set DISPDNAM flag to ONE instead of ZERO in CADM7400
. V11.02.19 28/10/2022  Thanh T        TSK 0920995
.           Changed to confirm count only when expected discharge date is 
.           today. Fixed Diagonis description is not shown error.  
. V11.02.18 27/10/2022  Don Nguyen     TSK 0923104
.           Reinstated the fixed width for the 'Comment' column in
.           'Current Admissions - Nutrition' and increased the value to
.           cater for Edge/Chrome; modified CHEADH00, CHEADN00 & CHEADQ00
. V11.02.17 25/10/2022  Don Nguyen     TSK 0923104
.           Removed fixed width value for the 'Comment' column (CHEADH00) to fix
.           the display of comments in Current Admissions - Nutrition View (HEA)
.           for Edge/Chrome.
. V11.02.16 08/09/2022  Bella Turco    TSK 0924201
.           Replaced 'alt=' with 'title=' so hover text appears in Edge/Chrome
. V11.02.15 23/08/2022  Alina Bhari    TSK 0923276
.           Displayed the clinical note icon in selected ward list
.           - CADM7400
. V11.02.14 18/08/2022  Alina Bhari    TSK 0923236
.           Displayed the MV icon when ventilation hr have been entered for
.           the patient - CADM7400                                         
. V11.02.13 15/08/2022  Alina Bhari    TSK 0923104
.           Cleared DTCMTFLG variable -CLRPAR00()                        
. V11.02.12 14/07/2022  Jacob Jackson  TSK 0921879
.           Avoid crashing by checking if index in patatraf exists before
.           calling WRPTATR3 
. V11.02.11 07/07/2022  Jacob Jackson  TSK 0918332
.           Wrap WRPMECA1 call in IF/ELSE statement to avoid duplicate
. V11.02.10 20/06/2022  Thanh T        TSK 0920472
.           Changed EROWD080 to fix issue with Patient still showing in
.           Expected discharge list when ALL ward filter is selected
. V11.02.09 08/06/2022  Thanh T        TSK 0920472
.           Changed EROWD600 to add discharge preparation status
.           description under Update button 
. V11.02.08 19/05/2022  Thanh T        TSK 0918727
.           Changed EXPDSC00, SEXPCL00 to fix issue with incorrect
.           tentative and confirmed count
. V11.02.07 18/05/2022  Thanh T        TSK 0918727
.           Changed EXPDSC00, SEXPCL00 to fix issue with incorrect
.           tentative and confirmed count 
. V11.02.06 03/05/2022  Thanh T        TSK 0918727
.           Changed EROWD080 to skip when Exclude Day only ward filter is
.           checked. Added GPTATR0
. V11.02.05 05.04.2022  Ebon Clements  TSK 0906511
.           Recompiled for PATNAMCD - Gender HDP
. V11.02.04 01.04.2022  DA Sarkies     TSK 0906511
.           Recompiled for PATNAMCD
. V11.02.03 23/02/2022  Thanh T        TSK 0903847
.           Changed EXPDSC00 to fix the Confirm count issue
. V11.02.02 10/02/2022  Thanh T        TSK 0889899
.           Recompiled as WATTR1FD changes
. V11.02.01 09/02/2022  Peter Vela     TSK 0915794
.           Added invoice number validation for RCBNRCOD in RPAY6100
.-------------------------------------------------------------------------
. V11.01.21 14/01/2022  Thanh T        TSK 0903848
.           Changed UPATRA00 and UPATRB00 to fix the PTARUDTE and PTARUTIM
.           written out error
. V11.01.20 13/01/2022  Thanh T        TSK 0903848
.           Changed UPATRA00 and UPATRB00 to fix the PTARUDTE and PTARUTIM
.           written out error
. V11.01.19 21/12/2021  Thanh T        TSK 0910640
.           Changed CBDMSG00 to write out missing last cell when the bed is
.           empty 
. V11.01.18 29/11/2021  Thanh T        TSK 0905116
.           Changed to show all the alert icons with category H1-H9 and
.           indictor 20 = "F"
. V11.01.17 29/11/2021  Thanh T        TSK 0905116
.           Changed to show all the alert icons with category H1-H9 and
.           indictor 20 = "F" 
. V11.01.16 29.11.2021  DSarkies       TSK 0911540
.           Added a check so loop doesn't end in ECRT0000 when incorrect status
.           appears
. V11.01.15 24/11/2021  Thanh T        TSK 0903847
.           Changed CBDMSG00 to show correct bed closing details
. V11.01.14 23/11/2021  Thanh T        TSK 0903847
.           Changed CBDMSG00 to show correct bed closing details
. V11.01.13 23/11/2021  Thanh T        TSK 0903847
.           Added CLSDBD00 to show correct bed closing details
. V11.01.12 22/11/2021  Thanh T        TSK 0903847
.           Fixed issue with incorrect outliers calculation
. V11.01.11 19/11/2021  Thanh T        TSK 0903847
.           Fixed issue with showing incorrect expected discharge date 
. V11.01.10 19/11/2021  Thanh T        TSK 0905116
.           Changed to fix issue with last update date cell not changing 
.           color when the last update date is within 12 hours of today
.           Date  
. V11.01.09 11/11/2021  Thanh T        TSK 0903847
.           Added Expect Discharge destination and Exclude Day Only wards
.           filters            
. V11.01.08 09/11/2021  Thanh T        TSK 0910640
.           Added CHEADK00, DSCHDI00. Changed CBEDG000 for a new discharge
.           direction column for CAB 
. V11.01.07 26/10/2021  Thanh T        TSK 0905116
.           Added GTDTCM00, CHEADQ00, CBEDQ000 and CBDNSQ00 Nutrition for
.           Ward List enhancement
. V11.01.06 21/10/2021  Thanh T        TSK 0903847
.           Added CHEADJ00, CBEDJ000,OUTLR000 for bed management changes 
. V11.01.05 14/10/2021  Ebon Clements  TSK 0897124
.           Allow nutrition updates for emergency visits - UPDIET00
. V11.01.04 20/09/2021  Thanh T        TSK 0903847
.           Added various sections for bed management changes. MAIN3100, 
.           REDIRE00 PROFL210 UPATRA00 MVATRA00 UPATRB00 MVATRB00
.           EXPDSC00 DISM0000 UPDSC000 DISMUP00
. V11.01.03 26/08/2021  Jill Parkinson Task 0910387
.           Added UPWORKDG to allow update of pmsworaf only 
. V11.01.02 09/06/2021  Jill Parkinson Task 0906666
.           Modified ECRT0000 to use index 2 for released views or index 3
.           for un-released
. V11.01.01 27/04/2021  Thanh T        TSK 0895165
.           Recompiled for OPRARDFD changes
.-------------------------------------------------------------------------
. V11.00.16 12/02/2021  Don Nguyen     TSK 0902599
.           Fixed CHEADG00 to output <tr> and </tr> tags accordingly and
.           added missing </b> tag to some Heading Row functions.
. V11.00.15 09/12/2020  Thanh T        TSK 0872840
.           Added PMSCCDFD/PMSCCDIO as PMSPX2TM changes
. V11.00.14 02/11/2020  Peter Vela       TSK 0898544
.           Added close IHC ERA without releasing in ECRE0000
. V11.00.13 09/10/2020  Thanh T          TSK 0892989
.           Changed CHEADF50 to add the Baptised column for Kids template
. V11.00.12 03/09/2020  Jill Parkinson Task 0896904
.           Added clear of oprardaf and oprsrgaf in PATSTS00 before reads
. V11.00.11 31/08/2020  Jill Parkinson Task 0896611
.           Recompiled for PMSVX1TM - clear of pmsvx120 (pmvxpgid)
. V11.00.10 20/07/2020  Peter Vela     TSK 0870469
.           Added OTERPYPN to ERTD0000 - Payee Provider Number
.           Added Payee Provider Number name to ERLB0000 ERTD0000
. V11.00.09 15/07/2020  Thanh T        TSK 0864109
.           Changed CHKLST00 to return legal status flag
. V11.00.08 10/07/2020  Thanh T        TSK 0864109
.           Changed CHKLST00 to return legal status flag
. V11.00.07 16/06/2020  Thanh T        TSK 0864109
.           Changed CTABI000 to return legal status flag
.           Added CMHLM000, CHKLST00
. V11.00.06 15/05/2020  Ebon Clements  TSK 0850105
.           Fixed theatre location display when abandoned - OPCNTHED
. V11.00.05 14/05/2020  Ebon Clements  TSK 0850105
.           Fixed theatre location display when in holding - OPCNTHED
. V11.00.04 29/04/2020  Ebon Clements  TSK 0850105
.           Added theatre location display to ward list - OPCNTHED
.           27/04/2020  Peter Vela        TSK 0870469
.           Added functionality for outerhaf/outerdaf
. V11.00.03 22/04/2020  Peter Vela        TSK 0874495
.           Recompiled for PRIECTFD
. V11.00.02 20/04/2020  Peter Vela        TSK 0874495
.           Recompiled for OUTERHFD
. V11.00.01 17/04/2020  Peter Vela        TSK 0874025
.           Recompiled for PRIECTFD
. V10.15.01 07/10/2019  Ebon Clements     TSK 0878316
.           Recompiled for PATNAMCD - New name formats 21 to 28
. V10.14.08 21/06/2019  Thanh T           TSK 0876387
.           Changed CBEDG100 to fix issue with alert icons not appear
.           for combination of clinical and disability alerts 
. V10.14.07 31/05/2019  Jill Parkinson    TSK 0861051
.           Added expected discharges without date
. V10.14.06 30/05/2019  Nicole Torrisi    TSK 0861051
.           Added expected discharges without date
. V10.14.05 30/04/2019  Peter Vela        TSK 0867807
.           Added decoding for # in ECRB0000
. V10.14.04 08/04/2019  Tracey Nguyen     TSK 0871443
.           Recompiled for PATATRTD/PATARTM
. V10.14.03 04/04/2019  Ania P         TSK 0870267
.           Added PTWDBDST check in BDBD0000
. V10.14.02 27/03/2019  Jill Parkinson Task 0863524
.           Changed to use key21 for oprsemaf read                         
.           26/03/2019  Peter Vela     TSK 0859743
.           Added Provider Num validation to Eclipse DBS payment reports
.           22/03/2019  Peter Vela     TSK 0871630
.           Added hospital filter (filthosp) to IMC ERA list - ERTH0000
.           20/03/2019  J.Tan            TSK 0857392
.           Changed RCP Transaction count from DIM3 to DIM5
. V10.14.01 15/03/2019  Peter Vela     Task 0867807
.           Fixed BRANCH at RPAB0010
. V10.13.11 01/02/2019  Peter Vela     Task 0867807
.           Changed to release all DBS payment reports under a payment run 
.           in outerhaf RPAB0000
. V10.13.10 29/01/2019  Thanh T.       TSK 0869355
.           Changed BEDLO000 to not display the inactive beds
. V10.13.09 25/01/2019  Peter Vela     TSK 0867807
.           Fixed date display in ERLB1000
. V10.13.08 25.01.2019  B.G.Ackland    TSK 0835482
.           Recompile for FHIR Include Change
. V10.13.07 21/12/2018  Peter Vela     Task 0859743
.           Recompiled for OUTECTFD
. V10.13.06 11/12/2017  Peter Vela     TSK 0859743
.           Added Eclipse DBS Payment Report functionality
. V10.13.05 12.11.2017  B.G.Ackland    TSK 0835482
.           FHIR Recompile for change to FHRDATCD
. V10.13.04 06.11.2017  B.G.Ackland    TSK 0835482
.           FHIR Output Change for Boolean values to not have quotes
. V10.13.03  01.11.2018  B.G.Ackland    TSK 0835482
.            Added deceased section to patient FHR resource in FHRDATCD
. V10.13.02 24/10/2018  Nicole Torrisi   TSK 0864815
.           Removed extra apostrophe from diet icon HTML in CBEDI149
. V10.13.01 26/07/2018  J.Tan            TSK 0848506
.           Changed PP Doctor from DIM6 to DIM10
. V10.12.04 13/07/2018  Ebon Clements    TSK 0859342
.           Added hospital filter (filthosp) to ERA list - ECRH0000
. V10.12.03 11/05/2018  Tracey Nguyen    TSK 0837181
.           1) Added OVFDS000 to identify the patients who are transferred to 
.              a ward/bed with an 'Overflow' reason in the transfer reason 
.              record 
.           2) Modified CBEDG120 to display Overflow transfer reason for 
.              hea-view Selected Ward List
.           3) Modified CBEDI120 and added CADM7200 to display Overflow transfer
.              reason for hea-view Selected Ward Sorted List
.           4) Modified MBEDH100 to display Overflow transfer reason for Ward 
.              Whiteboard            
. V10.12.02 23/03/2018  Richa Phogat     TSK 0854416
.           Removed '<br>' affixed before Comments in VSCMNT00
. V10.12.01 07/02/2018  Thanh T.         TSK 0852023
.           Fixed the Main diet code not getting saved in Update diet
.           template patweb9804004.
.           Changed UPDIET00 to default DIETCODE field only when
.           UPDATET2=1
.-------------------------------------------------------------------------
. V10.11.15 27/12/2017  Steve Armstrong  TSK 0850165
.           Recompiled for changes to DGCLICAC.
. V10.11.14 27/11/2017  Thanh Tieu     Task 0821710
.           Recompiled as PATMASTM changed
. V10.11.13 11.07.2017  B.G.Ackland    TSK 0835482 
.           FHIR Empty Contacts Routine for Patient Resource Output
.           03/10/2017  Ania P         TSK 0841602
.           Added RDPMWOR1 to PATCON00 
. V10.11.12 20/09/2017  Peter Vela     TSK 0845362
.           Added tag for new day onc view bed closures CADM7100
. V10.11.11 11/09/2017  Ebon Clements  TSK 0844500
.           Get diet code from admission not PMI - CBEDD0000 & CBEDC000
. V10.11.10 06/09/2017  Peter Vela     TSK 0837619
.           Added validation for ihc adjustments in RPAY1500
.           Added tag for adjusted IHC claim
. V10.11.09 04/09/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments
. V10.11.08 28/08/2017  Peter Vela     TSK 0844315
.           Added nz validation to GETAN000
. V10.11.07 18/08/2017  Jill Parkinson TSK 0840055
.           Added check for current admission in name conflict (CHKD0000)
. V10.11.06 18/08/2017  Ania P          TSK 0843179
.           Recompiled for IBAWEBCD
. V10.11.05 08/08/2017  Peter Vela     TSK 0837619
.           Added IHC Adjustments functionality
. V10.11.04 28/07/2017  Thanh T.       TSK 0821710
.           Audit admission/outpatient/UR comments. changed PATMASTM/PMSPX2TM.
. V10.11.03 26/07/2017  Thanh T.       TSK 0821710
.           Recompiled PASMISTM
. V10.11.02 19/07/2017  Peter Vela     TSK 0831224
.           Added Third index for PMSERH
. V10.11.01 14/07/2017  Thanh T.       TSK 0821710
.           Audit Amission/outpatient visit comments. PATMISTM changed.
.-------------------------------------------------------------------------
. V10.10.12 11/07/2017  Nicole Torrisi TSK 0838134 
.           Added id to Discharge button and pass 
.           'this' through in dischargeAdm() (CBEDG160)
. V10.10.11 11.07.2017  B.G.Ackland    TSK 0835482 
.           FHIR Output Testing for ClinicalAide
. V10.10.10 11/07/2017  Steve Armstrong  TSK 0841534 
.           Added READ of Discharge record prior to sending an A08
.           message (HL7TRGID = 2).
.           28/06/2017  B.G.Ackland    TSK 0835482 
.           FHIR Interface Change Patient Resource for family name
. V10.10.09 05/07/2017  Davin          TSK 0839910
.           Replace ' with ` in ANATDES1, ANATDES2, ANATDES3 to stop js error
. V10.10.08 23/06/2017  Jill Parkinson TSK 0840931
.           Recompiled for PATMASTM - Disability alert icon issue
. V10.10.07 26/05/2017  Thanh T.       TSK 0838692
.           Fix the width and height of the window frame that cause
.           the Update and Cancel buttons missing 
. V10.10.06 11/05/2017  Tracey Nguyen  TSK 0836685
.           Called IALR0000 (intialize Alert Code array) in CLRPAR00 to fix
.           DALR0000 from outputing up to 99 &nbsp when the array value is null 
. V10.10.05 04/05/2017  Ebon Clements  TSK 0814897
.           Fixes js error from apostrophe in phone number
. V10.10.04 21/01/2017  B.G.Ackland    TSK 0835482 
.           FHIR Interface for Encounters by Location Update to STU3
.           Fix Display Format of Secondary Doctor in CBEDG000   
. V10.10.03 21/01/2017  B.G.Ackland    TSK 0835482 
.           FHIR Interface for Encounters by Location
.           29/03/2017  Tracey Nguyen  TSK 0833454
.           Recompiled for PATATRTD/PATATRTM
. V10.10.02 07/03/2017  Jill Parkinson TSK  0833992
.           Mods to return to RSPTBMD2 in DELBMD00
. V10.10.01 06/03/2017  Ania P          TSK 0828101
.           Removed DietIcon text for hea
. V10.09.07 28/02/2017  Peter Vela      TSK 0832229
.           Added close of pmsetraf records after remittance release in
.           RPAY0000
. V10.09.06 21/02/2017  Peter Vela      TSK 0833705
.           Added validation for account reference id (invoice number) in
.           RPAY0000. If invalid then release to suspense register.
. V10.09.05 23/01/2017  J.Tan           TSK 0827921
.           Added MBEDH100 checking for multiple Alert fields
. V10.09.04 17/01/2017  J.Tan           TSK 0808741
.           Added MV icon to Selected Ward List
. V10.09.03 15/12/2016  Peter Vela      TSK 0830592
.           Removed validation for zero and negative balances in RSUB0000
. V10.09.02 13/12/2016  Peter Vela      TSK 0830714
.           Added IMC parameter around IHC validation ECRT0000
. V10.09.01 13/12/2016  Peter Vela      TSK 0830714
.           Added LOOPCNTR to ECRT0000
.           Added LOOPCNTR to ERTM0000
. V10.08.24 22/09/2016  Ebon Clements   TSK 0320737
.           Added discharge preparation status to ward white board - DESCDPST
.           05/08/2016  Peter Vela      TSK 0294177
.           Added IMC ERA functionality
. V10.08.23 16/09/2016  Ebon Clements   TSK 0826212
.           Recompiled for PATNAMCD - Pack PTMASNAM with SP70 after STRIP
. V10.08.22 30/08/2016  J.Tan           TSK 0819992
.            Mods RCDTALLO to 2 instead of 0 for Suspense register
. V10.08.21 19/08/2016  Peter Vela      TSK 0324029
.           Added RELSKC00 Reload Page Skip Cache
. V10.08.20 08/08/2016  Davin           TSK 0321234
.           Added Chronic Condition Alert (PMPXSN11)
. V10.08.19 09/08/2016  Peter Vela      TSK 0823845
.           Validate backslashes for ANATDES1, ANATDES2, ANATDES3 - MBEDH000
. V10.08.18 05/08/2016  Ebon Clements   TSK 0312728
.           Populate bay code if arrived CURSTATC - PATSTS00
. V10.08.17 28/07/2016  Ebon Clements   TSK 0312728
.           Fixed expected patient post op ward test - EXPT0000 & MEXP0000
. V10.08.16 20/07/2016  Ebon Clements   TSK 0312728
.           Fixed count of expected patients - EXPT0000
.           19/07/2016  Peter Vela      TSK 0294177
.           Validate for Eclipse IHC claims in ECOT0000
. V10.08.15 14/07/2016  Ebon Clements   TSK 0312728
.           Only get theatre record/status if booking is today - GETAN000
. V10.08.14 12/07/2016  Ebon Clements   TSK 0312728
.           Display post op and bed requests on ward white board - MEXP0000
. V10.08.13 11/07/2016  Don Nguyen      TSK 0299187
.           Added WDBDSRCH - Ward/Bed Search View flag
. V10.08.12 07/07/2016  Jill Parkinson  TSK 0822002
.           Added check for 001 attribute type in PATATR00
.           05/07/2016  Peter Vela      TSK 0821941
.           Added validation for STVVIEW in CHEADG00
. V10.08.11 01/07/2016  Ebon Clements   TSK 0312728
.           Display expected patients of selected ward view - EXPT0000
. V10.08.10 04/07/2016  Jill Parkinson TSK 0821996
.           Added check for blank lastdate for changes made in 10.07.12 below 
. V10.08.09 04/07/2016  Peter Vela      TSK 0821995 
.           Added category read for ADIET in CBDNSV00
. V10.08.08 30/06/2016  Ebon Clements   TSK 0312728
.           Display theatre status on selected ward list - CTABG000 DISPTHET
. V10.08.07 27/06/2016  Ebon Clements   TSK 0312728
.           Display theatre recovery bay when theatre status is recovery 
.           on ward whiteboard - CMAPH000
. V10.08.06 27/06/2016  Don Nguyen     TSK 0821247
.           Modified CBEDD000 & CBEDG000 to allow for Patient Condition column
.           truncated display; i.e. use "..." for overflowing text.
.           Added GETPAN00 to retrieve Working Diagnosis text from Patient
.           Attribute file.
. V10.08.05 20/06/2016  Jill Parkinson TSK 0821011
.           Removed re-read of ward file in CMHL0000
. V10.08.04 06/06/2016  Peter Vela     TSK 0321157
.           Recompiled for PATATRFD
. V10.08.03 25/05/2016  Don Nguyen     CAR 0316489
.           Modified CTABD000 to capture STVVIEW flag from tag.
.           Modified CBEDD000 to use call GETRIC00 for STV view.
.           Modified MOVATF00 to use DIM80 instead of DIM35.
. V10.08.02 19/05/2016  Peter Vela     TSK 0819251
.           Get fund from patmi1af when in suspense register on Eclipse
.           release RPAY6000
. V10.08.01 28/04/2016  Don Nguyen     CAR 0316489
.           Modified CBEDG000 for new Risk icons. Added GETRIC00.
.           Added CONF1700-CONF2700.
.           Recompiled for PATATRTM & PATATRFD/IO
. V10.07.13 15/03/2016  Peter Vela     CAR 0815006
.           Added comments from BOKDIAFD to BMCM0000
. V10.07.12 09/03/2016  Davin          CAR 0815319
.           If ASTAT = 2 update ADIET if meal date = current date (UPDIET05)
. V10.07.11 08/03/2016  Nicole Torrisi CAR 0321554
.           Changed CBDNSV00 to display 5 lines of comments
. V10.07.10 23/02/2016  Davin          CAR 0814047
.           Only update patmi1af diet code if meal date matches admission date
. V10.07.09 29/01/2016  J.Tan         CAR 303942
.           Mods for Payment types
. V10.07.08 08/12/2015  Davin          CAR 310749
.           Added extra diet details for UPDIET00 (UPCAT000/catcomaf/CATCOMTM)
.           Added new routines for hea nutrition list based on ptcnutom
. V10.07.07 11.12.2015  Peter Vela     CAR 317276
.           Added SP70 validation to PMNUDIET in CBDNSV00 for hea
. V10.07.06 27.11.2015  Peter Vela     CAR 317276
.           Check diet field for hea in CBEDG149
.           Validate for blank ADIET in GETCFL00
. V10.07.05 16.11.2016  J.Tan          CAR 303942/0303942
.           Mods to get payment code for direct deposit
. V10.07.04 02.11.2015  Peter Vela     CAR 317276
.           Get description for hea first diet field in CBDNSV00
. V10.07.03 13.10.2016  J.Tan          CAR 321665
.           Mods to generating Accounts(GTACCT00) for HSYS1=4
. V10.07.02 15/10/2015  Ebon Clements  CAR 316638
.           Added cancelled/tranferred status display - PATSTS00
. V10.07.01 14/10/2015  Peter Vela     CAR 317276
.           Validate for first diet field for Healthscope in CBDNSV00
. V10.06.09 18.09.2016  Peter Vela     CAR 321288
.           Added end date validation for secondary doctor in CBEDG155
. V10.06.08 17.08.2015  J.Tan          CAR 316644 
.           Added Mental Health Legal status icon (target1) to Ward List
. V10.06.07 06.08.2015  B.G.Ackland    CAR 320470 
.           Remove PATBMHAF table updates
.           Restrict Number of Records Written to PATBMDAF to 12 weeks
. V10.06.06 20/05/2015  Ania P         CAR 308277
.           Fixed layout of patweb9301003
. V10.06.05 20/05/2015  J.Tan          CAR 294739
.           Added default printer
. V10.06.04 15/05/2015  J.Tan          CAR 294739
.           Added new new columns to Expected discharges list
. V10.06.03 01.04.2015  Steve Armstrong  CAR 314839
.           Mods in UPDIET00 to read the discharge, visit extension
.           and PRA records for an admission prior to sending an A08
.           message.
. V10.06.02 26.03.2015  Steve Armstrong  CAR 314722
.           Moved PMI read to the start of NUTR0000 so that the PMI
.           details are read before the HL7 message is triggered.
. V10.06.01 12.03.2015  Steve Armstrong  CAR 314108
.           Removed reference to PATCGPFD (No Longer in use)
.           12/03/2015  J.Tan          CAR 291492
.           Mods to display Leave type description
.----------------------------------------------------------------------
. V10.05.28 02.03.2015  B.G.Ackland    CAR 313502
.           Added output of ASTAY,ACLAIM,AFUNDH to Map View Output
. V10.05.27 26/02/2015  Don Nguyen     CAR 313107
.           Added functionality for Form printing (PRNT0030-PRNT0050).
.           Added FORMTYPE - show Stationery Template Forms print options.
. V10.05.26 19/02/2015  Patrick Adair  CAR 305129
.           Corrected display of Row details (Nutrition) in CBDNSV26.
. V10.05.25 16/02/2015  Don Nguyen     CAR 283200
.           Added output of DUPNMFLG in MBEDH000 (Map View).
.           Added CADM5800, CADM5900 & CADM6000.
.           Added CHKD0000 (DISPDNAM) to ward list outputs - duplicate surnames
.           10/02/2016  Peter Vela     CAR 306853
.           Added active validation to SNLD0000
. V10.05.24 29/01/2015  Jill Parkinson CAR 309540
.           Added output of PWDVTYPE
. V10.05.23 08/01/2015  J.Tan          CAR 298445
.           Mods to display all H6 alert codes
. V10.05.22 16/12/2014  Peter Vela     CAR 305064
.           Fixed single quote display for doctor name in BMRW0000 and
.           GETAD000
. V10.05.21 10/12/2014  Davin          CAR 304926
.           Changed CBEDG000 & CBEDI000 to check boarder end time against
.           current time
. V10.05.20 10/12/2014  J.Tan          CAR 298445
.           Added HEAVIEW for Healthscope Nutrition Ward list
. V10.05.19 02/12/2014  Davin          CAR 304926
.           Changed CBEDG000 & CBEDI000 to check boarder end date against
.           current date
. V10.05.18 25/11/2014  Peter Vela     CAR 308906
.           Added tags for regime codes
. V10.05.17 20/11/2014  Peter Vela     CAR 308166
.           Validate number of patients in WMRW1100 to prevent infinite loop
.           in Bed Board View
. V10.05.16 10/11/2014  Ebon Clements  CAR 300196
.           Fixed pre adm meal date display on nutrition list - NUTL0000
. V10.05.15 06/11/2014  Don Nguyen     CAR 304059
.           Recompiled for changes to OPRSESIO - added Default Team Completed
.           fields.
. V10.05.14 31/10/2014  Ebon Clements  CAR 300196
.           Added meal day/date to nutrition list output - NUTL0000
. V10.05.13 24/10/2014  Davin          CAR 305129
.           Added flag dispudf4 to stop display of pmvxudf4 (CADM5500/CBDNSV00)
. V10.05.12 24/10/2014  Peter Vela     CAR 307531
.           Fixed Exp. Discharge Date display in BMRW0000
. V10.05.11 13/10/2014  Peter Vela     CAR 306619
.           Allow negative ERAs to release into suspense register
.           08/10/2014  Ebon Clements  CAR 300196
.           Added report 18 - Patient level diet maintenance
. V10.05.10 12/09/2014  Don Nguyen     CAR 296697
.           Added Disability Alert icons (AlertIconDIS.gif) where applicable
. V10.05.09 04/09/2014  Don Nguyen     CAR 300202
.           Modified ALERTI00 to also display other Alert icons 
.           (Medical, Micro & Risk). Also updated other routines to display
.           mouse hover text for the different types of Alerts.
. V10.05.08 29.08.2014  B.G.Ackland    CAR 300303
.           Enhancement for Whiteboard and Day View
. V10.05.07 15/08/2014  Peter Vela     CAR 299650
.           Fixed RELCOUNT in RPAY1000
. V10.05.06 14/08/2014  Peter Vela     CAR 304860
.           Recompiled for PMSVX1TM
. V10.05.05 12/08/2014  Peter Vela     CAR 299650
.           RPAY1000 - Added functionality to release $0 or less than $0 ERA
.           amounts without going to the suspense register.
. V10.05.04 05/08/2014  Don Nguyen     CAR 300202
.           Cleared STVVIEW when unpacking a non-value (empty).
.           Fixed bug where NEW 'Nutrition for Ward' list columns were showing
.           for STVVIEW & SJOGVIEW (i.e. non-standard).
. V10.05.03 31/07/2014  Peter Vela     CAR 299131
.           Added drug orders to BEDMV000
. V10.05.02 28/07/2014  Peter Vela     CAR 301176
.           Added calculated bmi in CBDNSV00
. V10.05.01 23/07/2014  Don Nguyen     CAR 300202
.           Moved new functionality for St Vincent Health & Aged Care -
.           'Nutrition for Ward' list into standard; removed SVHAVIEW & CADM5500
. V10.04.23 10/07/2014  Don Nguyen     CAR 303355
.           Added IO TRAP around UPPTBMH1 to prevent scenario where record is
.           deleted prior by another process.
. V10.04.22 08/07/2014  Don Nguyen     CAR 300202
.           Added SVHAVIEW, CADM5500, ALERTI00 for new 
.           St Vincent Health & Aged Care view - Nutrition for Ward list.
. V10.04.21 07/07/2014  Peter Vela     CAR 302694
.           Added SP70 to pack of KEY26 before each RAPMECA1
. V10.04.20 25/06/2014  J.Tan          CAR 302523
.           Fixed only allow one record with flag of Open or Closed in pmsecoaf
. V10.04.19 20/06/2014  J.Tan          CAR 302523
.           Fixed I*U on pmsecoaf file
. V10.04.18 23/05/2014  Don Nguyen     CAR 301171
.           Modified CBDNSV00 to not output PMVXUDF4 if flagged
. V10.04.17 16/04/2014  J.Tan          CAR 261630
.           Removed patauc audit files and patbank
. V10.04.16 15/04/2014  Peter Vela     CAR 286158
.           Moved BMI column to CBDNSV25
. V10.04.15 07/04/2014  Peter Vela     CAR 286258
.           Recompiled for PATMASTM
. V10.04.14 31.03.2014  B.G.Ackland    CAR 299363
.           Replace META Tag Redirect with Javascript in Common RDIREC00
.           Routine
. V10.04.13 28/03/2014  Ebon Clements  CAR 297388
.           Fixed allergy display on nutrition list - PTCNDFAL
. V10.04.12 25/03/2014  Ebon Clements  CAR 297388
.           Added PTCNDFAL - Display food allergy on ward list
. V10.04.11 12/03/2014  Peter Vela     CAR 297276
.           Changed index 1 to index 3 for Eclipse Claims Eqnquiry and History
.           Screens
.           12/03/2014  Brian Achland  CAR ??????
.           Fixed formatted patient name in PATINT10
. V10.04.10 05/03/2014  Don Nguyen     CAR 283199
.           Added WNURN000 to get Nursing Station extension number.
.           Modified CBEDG130 to display nursing station ext. number instead
.           of code. Also don't display any number if patient option
.           'Phone Calls Allowed' (PMVXPALW) is turned off.
. V10.04.09 21/02/2014  Jill Parkinson CAR 297508
.           Added STVCVIEW around match for ward in DOUT0000. DOUT0000 is used
.           for 2 different things.  STV want the same ward, as it is used as
.           an 'unallocated booking' list on the day oncology page. SJOG use
.           it as an outlier list and want patients NOT in the selected ward
. V10.04.08 10/02/2014  Peter Vela     CAR 283199
.           Added phone calls allowed from patient condition in CBEDG130
. V10.04.07 03/02/2014  Peter Vela     CAR 295474
.           Added Comments display to BMRW0000
.           Added cookie redirect back to Bed Management / Day Oncology View
.           to BMRW0000
.           Removed Health Fund from DOUT0000, Added Regime Code 3 in DOUT0000
. V10.04.06 31/01/2014  Peter Vela     CAR 283199
.           Added phone extension to CBEDG130
. V10.04.05 24/01/2014  Peter Vela     CAR 286158
.           Changed PATATR reads and writes
. V10.04.04 22/01/2014  Peter Vela     CAR 286158
.           Recompiled for CALCBMIN
. V10.04.03 17/01/2014  Peter Vela     CAR 286158
.           Changed BMI underweight to purple
. V10.04.02 13/01/2014  Peter Vela     CAR 286158
.           Fixed BMI colors
. V10.04.01 17/12/2013  Peter Vela     CAR 286158
.           Fixed BMI colors
.----------------------------------------------------------------------
. V10.03.60 10/12/2013  Ebon Clements  CAR 243062
.           Added exclude closed filter exclclos - ECCT0000
.           05/12/2013  Peter Vela     CAR 286158
.           Added Patient BMI/Attributes functionality
. V10.03.59 04/12/2013  Don Nguyen     CAR 281940
.           Modified DOUT0000 to fix loop; get next booking type after
.           finishing reading through booking records for the date (RKBKREC4).
.           Fixed bug with bookings appearing in the wrong Ward.
.           Fixed bug in UPPBMN00 where FORM3 wasn't initialised before used.
.           Also fixed same (FORM3) issue in GTTOTM00, BDMH0000, BDMR0000
. V10.03.58 15/11/2013  Ania P         CAR 293072
.           Added PMVXUDF4 output to CBDNSV00
. V10.03.57 30/10/2013  Peter Vela     CAR 289819
.           Added default value to SCHDCOPY in PRNREM00
. V10.03.56 16/10/2013  Davin          CAR 278342
.           Added tag for extrdiet flag (cadm5400)
. V10.03.55 14/10/2013  Patrick Adair  CAR 264730
.           Corrected Expected/Admitted Patient by Ward colour setting (WMRW0000)
. V10.03.54 01/10/2013  Peter Vela     CAR 291747
.           Added WINCLE00 for NXTPAT00. Display error message, close the 
.           dframe and refresh the prent screen
. V10.03.53 25/09/2013  Jill Parkinson CAR 292000
.           Fixed code added for CAR 280135 (after read of patalrtf the match
.           on UR should be if !@ instead of ovrcd=1)
. V10.03.52 23/09/2013  Peter Vela       CAR 288342
.           Fixed display of Ward in FWBD5000
. V10.03.51 19/09/2013  Peter Vela       CAR 290924
.           Added Hospital column to ECRT0000
. V10.03.50 17/09/2013  Peter Vela       CAR 291013
.           Fixed javascript error in dischargeAdm()
. V10.03.49 17/09/2013  Peter Vela       CAR 291013
.           Added Dischage Date to dischargeAdm()
. V10.03.48 17/09/2013  Patrick Adair    CAR 289665
.           Replace ' with ` in display fields to prevent showit javascript errors
. V10.03.47 11/09/2013  Don Nguyen       CAR 291424
.           Added PROFLD55 
. V10.03.46 10/09/2013  Steve Armstrong  CAR 291089
.           Recompiled for changes to PMSQVIFD.
. V10.03.45 29/08/2013  Ania P           CAR 280135
.           Added new tag to PALT3300
. V10.03.44 22/08/2013  Jill Parkinson   CAR 290647
.           Fixed all calls to WEBERR00 to set exit to 1 and stop processing
. V10.03.43 09/08/2013  Peter Vela       CAR 259795
.           Added Unreleased ERA Enquiry only functionality in ECRT0000
. V10.03.42 14/08/2013  Don Nguyen       CAR 287711
.           Corrected read call at CTABD650 to get patients in beds
. V10.03.41 26/07/2013  B.G.Ackland      CAR 289172
.           Fix loop in ECCP0000 to stop when U/R does not Match
.           Fix loop in ECCT0000 must have date range
. V10.03.40 18/07/2013  Steve Armstrong  CAR 268961
.           Recompiled for changes to PMSQVIFD.
. V10.03.39 19/06/2013  Peter Vela       CAR 287026
.           Commented out PMVXUDF2 in CTABG000 Working Diagnosis
. V10.03.38 18/06/2013  Peter Vela       CAR 286942
.           Validate for spaces in HOSPCODE before loop in ECCP0000
. V10.03.37 24/04/2013  Peter Vela       CAR 284424
.           Added check for NULL in PMEAEROT @ EDIRW000
. V10.03.36 23/04/2013  J.Tan            CAR 261630
.           Removed port number from temp file name
. V10.03.35 18/04/2013  Peter Vela       CAR 283684
.           Initialised work variables to spaces in WRRDTS00
. V10.03.34 13/03/2013  Ebon Clements    CAR 273917
.           Fixed day oncology outlier ward test - DOUT1000
.           26/03/2013  Patrick Adair    CAR 281548
.           Recompiled for changes to CLBOKRC1
. V10.03.33 04/03/2013  Ebon Clements    CAR 273917
.           Modified CLBD0000 to eliminate unnecessary reads of closed bed file
. V10.03.32 08/02/2013  Peter Vela       CAR 267297
.           Added Visit Based Comments
. V10.03.31 04/01/2013  Don Nguyen       CAR 273917
.           Fixed table row output in BDMN2000 (pre-pended <tr> for non STV)
. V10.03.30 20/12/2012  Peter Vela       CAR 274110
.           Fixed BRANCH OVRCD @ DOUT0200
. V10.03.29 09/11/2012  Peter Vela       CAR 275052
.           Added pmsteraf records close and pmsecoaf records close to ECFD0000
. V10.03.28 24/10/2012  Davin            CAR 256150
.           Created new ward list view tag to display clinical notes icon
.           (based on cnotflag=1/CADM5300)
. V10.03.27 16/10/2012  Mike Laming      CAR 273956
.           Mod to CTABN800, CROWN000 & CBDMSN00 to not display "Closed Bed"
. V10.03.26 04/10/2012  Davin            CAR 265550
.           Added extra diet codes to ward list view (CBEDG140)
.           Enable filtering of diet codes by category DC (if extrdiet=1)
. V10.03.25 26/09/2012  Peter Vela       CAR 273535
.           Branch out inactive @ CTABN200
. V10.03.24 04/09/2012  J.Tan            CAR 268233
.           Mods for Emergency Reassign Debts
. V10.03.23 03/09/2012  Patrick Adair   CAR 235588
.           Added new "Health Speciality" column for NZ display only
. V10.03.22 08/08/2012  Peter Vela      CAR 270725
.           Added write to pmsecaaf @ ECFD6000
.           06/08/2012  Nicole Torrisi  CAR 269341
.           Added check on Admission Number when outputting transfer list
. V10.03.21 02/08/2012  Patrick Adair   CAR 262343
.           Changed Fasting to Feeding Assistance for St Vincent only
. V10.03.20 27/07/2012  Peter Vela      CAR 267858
.           Fixed non Multi-Hospital validations in ECCP0000
. V10.03.19 26/07/2012  Peter Vela      CAR 269831
.           Added ECCP0000 Patient Level Eclipse Enquiry List Screen
. V10.03.18 24/07/2012  Peter Vela      CAR 269831
.           Added functionality to stop timeouts in ECCT0000
. V10.03.17 10/07/2012  Steve Armstrong CAR 267354
.           Added HL7 trigger 2 for DGCLICAC (update patient condition)
. V10.03.16 03/07/2012  Peter Vela      CAR 266258
.           Added &nbsp; to CBDMSI00
. V10.03.15 27/06/2012  Peter Vela      CAR 266258
.           Removed display blank cells in CBDMSI00. Added Condition Description.           to Condition sort column. Added display blank beds functionality.
. V10.03.14 26/06/2012  Peter Vela      CAR 266258
.           Changed to display blank beds last in CBDMSI00
. V10.03.13 19/06/2012  Nicole Torrisi  CAR 236804
.           Fixed duplication of Transfer rows
. V10.03.12 13/06/2012  Peter Vela      CAR 266258
.           Added tag for Selected Ward List (Sort)
. V10.03.11 13/06/2012  Peter Vela      CAR 263434
.           Added multihospital/register PMSVX1 check to WRRDTE00
. V10.03.10 29/05/2012  B.G.Ackland     CAR ?
.           New Ward Map Tags
.
. V10.03.09 29/05/2012  Nicole Torrisi  CAR 236804
.           Changed transfer list to use new PATTRAN5 index to read by date
.           and include transfers out of a ward
. V10.03.08 25/05/2012  Steve Armstrong CAR 266064
.           Mods to UPDIET00 to read pmspx2af after read on patma1af
.           prior to triggering broadcast HL7 message.
.           17/05/2012  Peter Vela      CAR 265287
.           Commented out RSBI0000
.           Removed resubmit validation
. V10.03.07 27/04/2012  Peter Vela      CAR 263801
.           Increased EXPCTDSC to DIM 20
. V10.03.06 29/02/2012  Peter Vela      CAR 248845
.           Added Deposit Amount and Claim Amount to releaseRem()
. V10.03.05 24/03/2012  Peter Vela      CAR 260636
.           Added close Eclipse claim @ ECFD0000
. V10.03.04 27/01/2012  Ebon Clements   CAR 259160
.           Recompiled for PATMASTM - Name field lengths
. V10.03.03 16/01/2012  Sandra Barcham  CAR 256563
.           Recompiled for PATMASTM
. V10.03.02 23/11/2011  Ebon Clements   CAR 255738
.           Show ward beds in short description order - All CTAB?000 routines
. V10.03.01 15/11/2011  Mike Laming     CAR 240184
.           Changes to IBAPOSTF Post Code table - added State to Keys
. V10.02.21 27/10/2011  Steve Armstrong CAR 251323
.           Recompiled for PMSQVIFD changes
. V10.02.20 18/10/2011  Peter McMullen CAR 250289
.           Use formatted ward/bed in movememnt description
. V10.02.19 30/09/2011  Jill Parkinson CAR 248486
.           Recompiled for IBAWEBCD - Restrict Hospital Access
. V10.02.18 28.09.2011  Saroeun Soeur  CAR 252160
.           new oncology view
. V10.02.17 20/09/2011  Ebon Clements  CAR 248572
.           Added reset of PGNAME in PATINT00 if no white space
. V10.02.16 14/09/2011  Peter Vela     CAR 250550
.           Added Ward Short Description to UNALPT00
. V10.02.15 05.09.2011  Peter Vela     CAR 248951
.           Added rest of address details in showit boarder address display 
.           @ CBEDG000
. V10.02.14 01.09.2011  Peter Vela     CAR 248951
.           Fixed showit boarder address display @ CBEDG000
. V10.02.13 11.08.2011  Peter Vela     CAR 247951
.           Fixed Age display for Selected Ward List onmouseover
. V10.02.12 02.08.2011  Saroeun Soeur  CAR 246648
.           added PMSVXUDF[1-4] for storing histroy
. V10.02.11 18/07/2011  McMullen       CAR 240725
.           Update ward/bed name handling to include short name option
. V10.02.10 08/07/2011 Peter Vela         CAR 240705
.           Added extra information in boarders onhover event
. V10.02.09 06/07/2011 Jill Parkinson     CAR 240713
.           Added CHKMUL00
. V10.02.08 25/06/2011 Steve Armstrong    CAR 240722
.           Mods to cater for changes to PATLOCFD.
.                - LSNAME & LGNAME extended to 40 chars.
.                - PTLCGNM2 added.
. V10.02.07 30/06/2011  McMullen       CAR 240725
.           Update ward/bed name handling to include short name option
. V10.02.06 28/06/2011  Peter Vela     CAR 240725
.           Right justified invoices and batchno @ ECOT0000
. V10.02.05 24/06/2011  Peter McMullen CAR 240725
.           change ward selection list to sort by name, not code
. V10.02.04 22/06/2011  Peter Vela     CAR 240705
.           Added Hospital Boarder Functionality
. V10.02.03 25/05/2011  Jill Parkinson CAR 240712              
.           Added bulk discharge list
. V10.02.02 10/05/2011  Davin          CAR 239539 WA Health
.           Changed to allow 3 alert indicators to be displayed (CBEDG100)
. V10.02.01 21/03/2011 Jill Parkinson  CAR 239574
.           Increased sizes of printer variables
.----------------------------------------------------------------------
. V10.01.01 24/01/2011  B.G.Ackland CAR 237136
.           move zero to ovrcd prior to open trap on reslnkaf x 3
. V10.01.12 16/03/2011 J.Tan           CAR 233264
.           Fixed updating Unreconciled invoice file to update date/time
. V10.01.11 28/02/2011  Ebon Clements  CAR 238433
.           Removed double quotes from SERDIM50 - WRRDTS00
. V10.01.10 24/01/2011  Jill Parkinson CAR 236702
.           Mods to check for closed beds in CTABN000
. V10.01.09 12/01/2011  Peter Vela       CAR 235625
.           Added Error message to ERA release to suspense allocation
. V10.01.08 24/12/2010  Peter Vela       CAR 235302
.           Added Regime code descriptions to onmouseover day oncology
. V10.01.07 10/12/2010  Peter Vela       CAR 235284
.           Commented out multihospital functionality in WRRDTS00 when assigning
.           suspense register to rcpdteaf
. V10.01.06 24/11/2010  Peter Vela        CAR 233222
.           Added tag for CFEETYP
. V10.01.05 19/11/2010  Steve Armstrong   CAR 234061
.           Recompiled for changes to PMSNUTFD.
.           Changed CALL's to PMSNUTIO.
. V10.01.04 18/11/2010  Davin            CAR 233892
.           Mods to use file variable not admissno on rapsnut1 (updiet20)
.           17/11/2010  Peter Vela       CAR 233225
.           Added sixth keystroke in PRNREM00
. V10.01.03 10/11/2010  Peter Vela       CAR 233225
.           Added Remittance Report Enquiry Print to RPAY0000
. V10.01.02 04/11/2010  Davin            CAR 232151
.           Trap errors on wrptbmd & wrptbmh to stop I*D
. V10.01.01 01/11/2010  Peter Vela       CAR 232670
.           Commented out validation for discharged patients in BDAR0000
.----------------------------------------------------------------------
. V10.00.27 25/10/2010  Peter Vela       CAR 231631
.           Check for Status 3-processing @ RPAY0500 to prevent duplicate 
.           remittance release
. V10.00.26 06/10/2010  Steve Armstrong  CAR 227986
.           Mods to load HF instead of participant into rcpbnkaf.rcbnrcod.
. V10.00.25 30/09/2010  Peter Vela       CAR 231060
.           Added Patient's telephone number to show_it() Day Oncology
. V10.00.24 27/09/2010  Steve Armstrong  CAR 227986
.           Mods to set RCBNTTYP to "1" instead of "4" for Eclipse Health Fund
.           payment (RPAY0000)
.           Mods to strip spaces out of invoice number when packing key
.           to read pmseahaf (RPAY0000)
. V10.00.23 22/09/2010 J.Tan            Landesk Incident No.500128
.           Mods to set RCDTGSTC
. V10.00.22 22/09/2010 Jill Parkinson  CAR 222489
.           Added onclick function for empty day oncology ward/beds
. V10.00.21 07/09/2010 Peter Vela       CAR 229482
.           Changed Patient Level Eclipse Eqnuiry screen to default month
.           date range ECCE6000
. V10.00.20 03/09/2010 Peter Vela       CAR 229544
.           RPAY0000 - ERA Release into Suspense Account if Invoice is fully
.           credited
. V10.00.19 01/09/2010 Peter Vela       CAR 229050
.           Added PMEHSTAT status 3 Processing
. V10.00.18 26/08/2010 Peter Vela       CAR 229025
.           Pass button object to releaseRem() 
. V10.00.17 24/08/2010 Davin            CAR 216965
.           Mods to update bed management table (patbmdaf) when expected 
.           discharge date is updated on patient condition screen (updcon00)
. V10.00.16 10/08/2010 Saroeun Soeur    CAR 227328
.           fixed bug. moved SAVKEY6 after html write
. V10.00.15 05/08/2010 Peter Vela       CAR 227754
.           Mods to write Eclipse Remittance to suspense account if invoice
.           record cannot be found
. V10.00.14 03/08/2010 J.Tan            CAR 191023
.           Mods to write un-balanced invoice to un-reconciled invoice file
. V10.00.13 29/06/2010 Sandra Barcham     CAR 224669
.           Swap heading ward diet and food allergy
.           07/07/2010 Jill Parkinson     CAR 224669
.           Fixed ward diet column                   
. V10.00.12 21/05/2010  Saroeun Soeur     CAR 212824
.           save KEY6 to SAVKEY6 when reading WARD file so position is not
.           lost. CBEDG160
. V10.00.11 19/05/2010  Peter Vela        CAR 221795
.           Mods for changes to PMSERHFD and PMSERDFD
.           (Removed participant from remittance) 
. V10.00.10 13/05/2010  Peter Vela        CAR 221793
.           Fixed loop at ECCT0000
. V10.00.09 11/05/2010  J.Tan             CAR 216328
.           Added a new parameter HSYS1=3 for G/L Integra cash interface
. V10.00.08 05/05/2010  Peter Vela        CAR 218176
.           Added FILTDPST to NEXT0000 and PREV0000
. V10.00.07 20/04/2010  Peter Vela        CAR 216940
.           Added functionality for ERA Suspense Accounts
. V10.00.06 19/04/2010  Peter Vela        CAR 216920
.           Added PMEHDATE to displayRemH javascript function call.
. V10.00.05 14/04/2010  Peter Vela        CAR 219544
.           Modified looping functionality in ECCT0000 Eclipse Claim Enquiries
. V10.00.04 06/04/2010  Peter Vela        CAR 219042
.           Pack SP70s in EDCE0000
. V10.00.03 26/03/2010  Peter Vela        CAR 217515
.           Added PayerName to Released and Unreleased Remittance List
.           (ECRT0000)
. V10.00.02 25/03/2010   Peter Vela       CAR 214949
.           Fixed wrong goto @ BBAR0000
. V10.00.01 19/03/2010  Steve Armstrong   CAR 135505
.           Added HL7TRGID & HL7INCLD setting for all broadcast messages
.-------------------------------------------------------------------------------
. V9.12.45  01/03/2010  Peter Vela    CAR 216748
.           Fixed redirect of Update Condition On Leave Patient
. V9.12.44  26/02/2010  Peter Vela    CAR 216748
.           Added parameter ased UR display to Eclipse Claims Enquiry ECCT0000
.           Fixed sort order of batch number for ECCT0000
. V9.12.43  25/02/2010  Peter Vela    CAR 216807
.           Added location id validation to ECRD0000
.           Added web user id keystroke to PRNREM00
. V9.12.42  24/02/2010  Peter Vela    CAR 216807
.           Added multihospital to ECRD0000
. V9.12.41  12/01/2010  Saroeun Soeur CAR 212824
.           added ward code / bed description on parameter PTCNWBDS switched on
. V9.12.40  05/01/2010  Saroeun Soeur CAR 210423
.           RABKDIA1 - get booking diag and move into ADIAG1
. V9.12.39  22/12/2009  Saroeun Soeur CAR 210316
.           clear status bar
.           remove html tags from status bar
. V9.12.38  18/12/2009  Mike Laming   CAR 212073
.           Fixed box lines for "Empty" beds if ANAESTFL="1" at CBDMSG20
. V9.12.37  09/12/2009  J.Tan         CAR 212176
.           Fixed to read parameter HSYS1
. V9.12.36  04/12/2009  Davin         CAR 210674
.           Added ability to close eclipse claims that have a status of
.           'Assessing' or 'Int. Ready' (rset0000).
.           Modified rset0000 to change status from 'Unverified' to 'Verified'
.           rather than 'Received'.
. V9.12.35  01/12/2009  Peter Vela    CAR 203064
.           Added different colored alerts to FLDR0000
. V9.12.34  30/11/2009  Davin         CAR 210674
.           Allow users with the appropriate security level to update eclipse
.           status from Unverified to Received (rset0000)
. V9.12.33  02/11/2009  J.Tan         CAR 208676
.           Removed updating HF payment date to Letter Reminder file
. V9.12.32  23/11/2009  Peter Vela       CAR 201654
.           Initialised PMEAEROT to SP70 before write to pmsecaaf
. V9.11.31  23/11/2009  Saroeun Soeur    CAR 209736
.           added columns to the Selected ward list:
.           Post Op ward /Bed, Intended Stay for SJOGVIEW
. V9.12.30  13/11/2009  Jill Parkinson CAR 210065                   
.           Fixed standard doctor name format in CBEDG000
. V9.12.29  06/11/2009  Peter Vela       CAR 208626                   
.           Cater for time sync issue in PROC4000.
.           Loop back to next history record when Trans Id do not
.           match
. V9.12.28  05/11/2009   Peter Vela       CAR 208626
.           Added functionality to only allow resubmit of "3002" after 1 day.
. V9.12.27  04/11/2009   Peter McMullen  CAR 202694
.           Convert to standard doctor name format routine
. V9.12.26  16/10/2009   Jill Parkinson  CAR 206624
.           Added SJOGVIEW flag
. V9.12.25  21/10/2009   Ebon Clements    CAR 190928
.           Added test for post op ward if expected ward is blank - BTABB000
. V9.12.24  28/09/2009   WeeLee Koo       CAR 203603
.           Check if pre admission / booking is cancelled in BBAR0000.
.           If cancelled then dont display in Bed Board View.
. V9.12.23  09/09/2009  Peter Vela        CAR 199831
.           Added validation for cancelled bookings and discharged patients in
.           DOUT0000
. V9.12.22  26/08/2009  WeeLee Koo        CAR 191981
.           Added Secondary Doctor to Current Adm Ward List (CBEDG000)
. V9.12.21  21/08/2009  Peter Vela        CAR 204293
.           Fixed negative display of benefit amount in PMEDBAMT
. V9.12.20  29/07/2009  Peter Vela        CAR 202184
.           Check for nulls PMEHHOSP at remittance release RPAY0000
. V9.12.19  24/07/2009  Peter Vela        CAR 202184
.           Added functionality to release duplicate remittances for multi-
.           hospital in RPAY0000
. V9.12.18  21/07/2009  Mike Laming      CAR 187485
.           Change size of RCBDPAYD, RCBDDRAW,RCBDSTRF - Remove RCBDMONM
. V9.12.17  20/07/2009  Mike Laming      CAR 187485
.           Change size of RCBDPAYD & RCBDDRAW - Remove RCBDMONM
. V9.12.16  17/07/2009  Mike Laming       CAR 174468
.           Added Anaesthetist to Current Admissions List (by Ward)
. V9.12.15  10/07/2009  Peter Vela        CAR 201167
.           Match hospital when releasing remittance RPAY0000
. V9.12.14  01/07/2009  Peter Vela        CAR 199306
.           Assigned RCDTMHOS from PMEHHOSP in WRRDTE00
. V9.12.13  19/06/2009  Peter Vela        CAR 199306
.           Assigned RCDTREGI before call to GTACCT00 in RPAY0000
. V9.12.12  15/06/2009  Peter Vela        CAR 199306
.           Removed update to patinvrf in RPAY0000. This is done in IBARCP76
.           instead.
. V9.12.11  15/06/2009  Ebon Clements  CAR 159088
.           Added Expected return from leave date/time display to CTABG000
. V9.12.10  12/06/2009  Peter Vela        CAR 199306
.           Fixed right justified invoice number in RCDTINVN 
.           11/06/2009  Peter Vela        CAR 198592
.           Fixed negative value ERA amount in RPAY0000
.           11/06/2009  Jill Habasque     CAR 183368
.           Fixed TCOLSPAN for NZ
. V9.12.09  04/06/2009  Peter Vela        CAR 197979
.           Moved SP70 to RCDTRELD and RCDTRELT in RPAY0000
. V9.12.08  01/06/2009  Peter Vela        CAR 197840
.           Added Date Filter to Released Remittance screen ECRE0000.
. V9.12.07  29/05/2009  Steve Armstrong   CAR 197847
.           Added read of pattranf prior to calling DGCLICAC
. V9.12.06  28/05/2009  Jill Habasque     CAR 197722
.           Fixed FLDR0000 if no alerts on file
. V9.12.05  18/05/2009  Jill Habasque     CAR 195396
.           Added DOUT000 - output of day oncology outliers
. V9.12.04  15/05/2009  Peter Vela        CAR 183976
.           Added call to FLAGDEBT in RPAY0000 to update outstanding debt flag
.           PMVXSN15
. V9.12.03  14/05/2009  Peter Vela        CAR 183976
.           Fixed writes to rcpbnkaf, rcpbdtaf and rcpdteaf in RPAY0000
. V9.12.02  13/05/2009  Peter Vela        CAR 183976
.           Fixed assignment to PMECAMTP in RPAY4500
. V9.12.01  06/05/2009  Saroeun Soeur     CAR 188452
.           Added FLDR0000 function to determine folder icon based on patient
.           having an alert or not
. V9.11.09  28/04/2009  J.Tan             CAR 195596
.           Added fields PTDTADPT PTDTADRB
. V9.11.08  08/04/2008  Peter Vela       CAR 183976
.           Removed PTCNBANK, PTCNUBNK
. V9.11.07  06/04/2009  Peter Vela       CAR 183976
.           Added PTHSERRE, PTHSERCD, PTHSERCA for Multi Hospital Remittance
.           Release RPAY0000
. V9.11.06  23/02/2009  Steve Armstrong  CAR 189850
.           Added call to DGCLICAC after UPMISS1 in UPDIET00 routine.
.           17/02/2009  Peter Vela    CAR 183976
.           Added PMVXPOEC to CLRVXS00
. V9.11.05  05/02/2009  Peter Vela    CAR 183976
.           Fixed transaction id variable in EDIP0000
. V9.11.04  02/02/2009  Peter Vela    CAR 183976
.           Added Error Code Decriptino for PMSECAFD
. V9.11.03  19/01/2009  Peter Vela    CAR 183976
.           Added Payment Reference display for Unreleased Remittance Advice
. V9.11.02  15/01/2008  Peter Vela    CAR 183976
.           Added "Payment record partially released" alert @ RPAY0000
. V9.11.01  01/12/2008  Peter Vela    CAR 183976
.           Added Eclipse Claim Enquiry functionality.
. V9.10.09  15/09/2008  Peter Vela    CAR 170824
.           Added functionality to recalculate Planned/Expected Length of Stay
.           UPDCON00
. V9.10.08  10/90/2008  Peter Vela    CAR 177468
.           Recompiled for PMSNUTTM
. V9.10.07  09/09/2008  Peter Vela    CAR 177266
.           Check if pre admission / admission is cancelled in BDAR0000.
.           If cancelled then dont display in Day Oncology
. V9.10.06  29/08/2008  Peter Vela    CAR 177266
.           Check if booking is cancelled in BDAR0000. If cancelled then don't 
.           display in Day Oncology view.
. V9.10.05  05/08/2008  Davin         CAR 172634
.           Use Cat.DD in discharge list if discatdd=1 (DTABA000)
. V9.10.04  28/07/2008  Peter Vela    CAR 174735
.           Replaced special characters with space in patient name for Day
.           Oncology and Bed Board view.
. V9.10.03  08/07/2008  Jill Habasque CAR 162660
.           Mods to output PTMXSIN1 for AlertIcon
. V9.10.02  08/05/2008  Ebon Clements CAR 165223
.           Added Autologous Venesection highlight to day oncology view
. V9.10.01  06/05/2008  Ebon Clements CAR 151910
.           Added AUSR2 display to the expected discharge list - ETABD000
. V9.09.16  07/04/2008  Peter Vela    CAR 163822
.           Added tag for Max No of Patients (Day Oncology View)
. V9.09.15  05/03/2008  Peter Vela    CAR 162996
.           Added tag for No of patients (Day Oncology)
.           Added functionality display closed beds.
. V9.09.14  25/02/2008  Peter Vela    CAR 162284
.           Changed "BedReq Admno" to "Linked Admno" for Bed Management.
. V9.09.13  14/02/2008  Peter Vela    CAR 159983
.           Modified Day Oncology view to only display Regime Length of Stay
. V9.09.12  29/01/2008  Jill Habasque CAR 153370
.           Added bold for bookings and admissions in WMRW0000
. V9.09.11  07/01/2008  Peter Vela     CAR 158768
.           Added Start and End Time Parameters for Day Oncology Inpatient
.           Scheduling
. V9.09.10  20/12/2007  Peter McMullen CAR 158002
.           Fix overwrite of religion on chaplin ward list
. V9.09.09  20/12/2007  Jill Habasque  CAR 153370
.           Added bed management view functionality
. V9.09.08  14/12/2007  Ebon Clements  CAR 157857
.           Added update of AUSR2 PTMIS038 to UPDCON00
.           07/12/2007  Peter McMullen CAR 155103
.           Populate DISPDATE for Expected Discharge List
. V9.09.07  06/12/2007  Ebon Clements  CAR 142954
.           Recompiled for PMSWORFD - Cordless telephone number added
. V9.09.06  28/11/2007  Jill Habasque  CAR 154167
.           Added clear of PTKEYCNT
. V9.09.05  09/10/2007  Peter Vela    CAR 152803
.           Added fasting column to standard selected Ward List
. V9.09.04  15/10/2007  Peter Vela    CAR 148954
.           Changed CAT XX (PMRESNCD) to CAT "sn"
.           Changed indicator values for CAT sn
. V9.09.03  12/10/2007  Davin         CAR 151896
.           Display ward/bed description (based on parameter)
. V9.09.02  27/09/2007  Peter Vela CAR 148954
.           Added Bed Management Ward View
. V9.09.01  19/06/2007  Ebon Clements CAR 142988
.           Added multi hospital test to expected discharge list ETABD000
. V9.08.07  01/06/2007  Mike Laming  CAR 140164
.           Correct DDEST/DSTAT Indicator selection at DROWA100 & GETMOV60
. V9.08.06  20/04/2007  Ebon Clements CAR 132858
.           Added discharge preparation status to ward lists
. V9.08.05  16/03/2007 Jill Habasque CAR 116413
.           Rebound - fixed default printer
. V9.08.04  08/03/2007 Jill Habasque CAR 116413
.           Rebound - removed default of checked for bulk label print
. V9.08.03  08/03/2007 Jill Habasque CAR 116413
.           Added bulk print inpatient labels - reportno 12
. V9.08.02  31/01/2007  Peter Vela     CAR 127930
.           Recompiled for MRTMASFD
. V9.08.01  27/11/2006 Ebon Clements CAR 126035
.           Added report 11 expected discharge list
. V9.07.04  19/09/2006 Ebon Clements CAR 107243
.           Changed to display AlertIconDelete if PTMXSIN1 = 3 
. V9.07.03  27/07/2006  Ebon Clements CAR 113017
.           Changed EMU ward list to dispay EOU beds with ind 8 = 0
. V9.07.02  27/07/2006  Ebon Clements CAR 113017
.           Added read of ward details after emergency map ward list
. V9.07.01  21/06/2006  Ebon Clements CAR 107743
.           Mods for emergency map view ward list
. V9.05.01  09/03/2006  Ebon Clements CAR 78533
.           Mods for PATCODTM - Hospital specific category codes
. V9.05.B01 30/01/2006  Ebon Clements CAR 93186
.           Mods for REDIRECT length change. Recompiled for IBAWEBDF
. V9.04.07  23/06/2005 Ebon Clements CAR 59797
.           Added alternate view with diagnosis to CTABG000
. V9.04.06  07/03/2005 Peter Vela CAR 23312
.           Added display functionality for Expected Discharge Date in pmsworaf
. V9.04.05  18/03/2005 Ebon Clements CAR 58443
.           Changed to display AlertIconBlack if PTMXSIN1 = 2 security alert
. V9.04.04  12/12/2004 Ebon Clements CAR 
.           Added working diagnosis discharge date to GETPAT00
. V9.04.03  08/12/2004 Ebon Clements CAR 55750
.           Added bed comments as a title for mouse over bed in CTABG000
. V9.04.02  21/09/2004 Jill Habasque CAR 53553
.           Added more checks for IBCNMHOS
. V9.04.01  30/08/2004 Jill Habasque CAR 53046
.           Added checks for IBCNMHOS
. V9.03.11  07/06/2004 Peter Vela CAR 49016
.           2004 Statutory Changes - recompiled for PMSPX2TM
. V9.03.10  21/05/2004 Ebon Clements   CAR 44795
.           Added working diagnosis to patient condition update and ward lists
. V9.03.09  06/04/2004 Peter Vela      CAR 48209
.           Changed PTCNNHII to PTCNHDPS
.           29/03/2004 Peter Vela      CAR 48209
.           Added comment to diet column patweb9301001 nz and patweb9301003 nz
.           17/03/2004 Peter Vela      CAR 13038
.           Changed call DOCNAM00 to DOCNM000 (parameter driven doctor name
.           format) for sort lists.
. V9.03.08  10/03/2004 Peter Vela      CAR 48029
.           Added functionality to display Diet comment in patweb9301005 NZ
. V9.03.07  01/12/2003 Peter Vela      CAR 40355
.           Recompiled for PATNAMCD
. V9.03.06  24/10/2003 Peter Vela      CAR 38459
.           Removed Exp. Disch. column from nz template patweb9301001
. V9.03.05  30/09/2003 Sylvek Litewka  CAR 43729
.           Added report number 10 (All Wards Lists) and procedure UNALPT00 to
.           build a list of all Unallocated Patients (pats without a bed)
.           across all Ward/Bed+Ward-Only wards.
. V9.03.04  12/09/2003 Sylvek Litewka  CAR 41826
.           Modified CTABD000 and CTABG000 to display "Closed" beds based on
.           a new field patwr1af.PTWDBDST. The inactive beds are not displayed
.           at all.
. V9.03.03  23/07/2003 Jill Habasque   CAR 21760
.           Changed read of bokdiaaf
. V9.03.02  03/07/2003 Jill Habasque   CAR 40981
.           Added branch on wbedtype in CBDMSG00
. V9.03.01  27.05.2003 Lina Vo         CAR 37504
.           Write SLA/ASGC code from ibapostf to visit extension file for
.           Update Patient conditons. 
.           21.05.2003 Sylvek Litewka  CAR 39213
.           Added variable PATCONTL and modified procedures VISFLG00 and
.           UPDCON00 to capture patient's temporary location. Also modified
.           CBEDD000 and CBEDG000 to display temporary location on Ward Lists.
.----------------------------------------------------------------------
. V9.02.33  24.02.2003 Tonii  CAR 18337
.           Mods to check for alerts in CBEDD000, and display for MyWard list
.           and AllWard list in 'Ward Information Center'.
. V9.02.32  27.01.2003 Ebon Clements SRF 33639
.           Changed NXTEVT00 to select the patient events in ward/bed/admission
.           number order.
. V9.02.31  23.01.2003 Ebon Clements SRF 33706
.           Removed spacer icons from CBEDD000 as they displayed as hyperlinks
. V9.02.30  23.10.2002 Ebon Clements SRF 22327
.           Changed PATINT00 to not remove quotes from patient names. 
. V9.02.29  21.10.2002 Peter Vela    SRF 22685
.           Added functionality for Diet Comment field (patweb9804003.html)
. V9.02.28  29.06.2002 Ebon Clements SRF 19105
.           Recompiled for sigpipe trap  
. V9.02.27  31.05.2002 Ebon Clements SRF 18229
.           Added trap if sigpipe     
. V9.02.26  17.05.2002 Jill Habasque SRF 17711
.           Added pack of currdate                        
. V9.02.25  03.05.2002 Jill Habasque 
.           Fixed update of pmsnutaf for events           
. V9.02.24  01.05.2002 Jill Habasque SV 89144
.           Added read of pmsnutaf                        
. V9.02.23  14.03.2002 Jill Habasque 
.           Added output of ward for patient dependancy
. V9.02.22  13.02.2002 Jill Habasque 
.           Fixed patient dependency list for transferred patients
. V9.02.21  06.02.2002 Jill Habasque 
.           Changed patient dependency to display patient in any ward that day
. V9.02.20  23.01.2002 Ebon Clements 
.           Added kids view two to current admission list CTABG000
. V9.02.19  28.12.2001 Jill Habasque 
.           Fixed clear of patient dependency
. V9.02.18  06.11.2001 Glenn Saunders 
.           Fix NXTPAT00 routine, which currently does patients in wrong order
.           ie. Bed, No bed, On leave, should be Nobed, Bed, Onlv (as display)
.           05.12.2001 Katie Nelson/Harvinder SRF 648628(nz)
.           Recompiled for NHI tags added to PATMASTM
. V9.02.17  26.11.2001 Glenn Saunders
.           Fix Diet display to use ADIET (admission) not PDIET (PMI record) 
.           Applies to Ward/Bed (CTABG); Nutrition (CTABN); Chaplain (CTABF) 
. V9.02.16  21.11.2001 Glenn Saunders
.           Fix Diet display (currently overwritten by Ambulatory status)    
. V9.02.15  20.11.2001 Glenn Saunders
.           Remove URno column for Diet view for St. Vincents.               
. V9.02.14  19.11.2001 Glenn Saunders
.           Move Chaplain view headings into program (as different views reqd
.           by Stnd and RCH. Change processing accordingly for data.
. V9.02.13  14.11.2001 Jill Habasque
.           Fixed DEPLST00 - changed from using KEY4 to DEPKEY
.           14.11.2001 Glenn Saunders 
.           Display Visitors/Phone Calls allowed in Patient Condition cell
.           Add ambulatory status in Pat Cond box.                        
.           Display Visitors/Phone Calls allowed in Patient Condition cell
. V9.02.12  13.11.2001 Jill Habasque
.           Added WBEDTYPE=3 for Occupied (inc onleave) option  (CTABG000)
. V9.02.11  10.11.2001 Jill Habasque
.           Added default of yesterdays date for dependency list
. V9.02.10  09.11.2001 Raghunandan Surve - HPS 
.           Commented out ResultIcon 
. V9.02.09  07.11.2001  Glenn Saunders
.           Fix outstanding Nutrition issues :-                             
.           - add missing dietncde CGI read (used for filter)
. V9.02.08  26.10.2001  Glenn Saunders
.           Version V9.02.07 was 'to-traned' simply to have a working version
.           sent out to St. Vincents and RCH, due to problems documented below.
.           Continuation of V9.02.07 changes for Diet/Nutrition view.      
.           Add new tag  .. PATWEB93.01.019 (Dietitian code - for filter) 
.           Add new tag  .. PATWEB93.01.020 (Dietitian name - for filter) 
.           Include new Nutrition file (pmsnutaf) and related includes.   
. V9.02.07  22.10.2001  Glenn Saunders
.           Continuation of V9.02.05 after further version control problems
.           Add new field set (value 4 - actual 3) to access doctor stuff.   
.           Add one new tag  .. PATWEB93.01.018.2 (Diet Type - for filter) 
.           Introduce new template PATWEB93.01.008 for Diet view.           
.           ~ this uses CTABN000 as it's main data source [PATWEB93.01.017] 
. V9.02.06  19.10.2001  Sai - HPS
.           call to CALCAGE added in DEPLST00 to show the correct age 
. V9.02.05  18.10.2001  Glenn Saunders
.           Restore four sets of changes that were lost, due to poor version
.           control ... I love having to do all my work twice over for nothing.
.
.           Originally done: 06.10.2001 Glenn Saunders
.           Change Patient Folder determination to use PATFLD00
.
.           Originally done: 18.09.2001 Ebon Clements
.           Corrected format of ward description in ward bed selection list
.          
.           Originally done: 13.09.2001  Glenn Saunders
.           Changes related to template patweb93.05.001 (Pat.Cond Popup)
.           ~ Add in "Visitors Allowed" field (PMVXVALW/PATCONVA)
.           ~ Add in "Phone Calls Allowed" field (PMVXPALW/PATCONPA)
.
.           Changes related to template patweb93.01.005
.           Changes related to template patweb93.01.005
.           ~ Change patient desc. to differentiate between "empty" / "on leave"
.           ~ Move table headings from template to proc CHEADG00
.
. V9.02.04  16.10.2001 HPS
.           Added for service date combo for dependency list PDEP0000 added
. V9.02.03  15.10.2001 B.G.Ackland
.           Fix Open on Day File
. V9.02.02a 10.10.2001 B.G.Ackland
.           Fix Open on Day File
. V9.02.01  21.08.2001 J.Tan
.           Recompiled for PATWRDTM
. V9.01.02  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.01.01  14.08.2001 J.Tan
.           Recompiled for PATMASTM
. V9.00.03  13.08.2001 HPS - Jagth
.           Modified for Current Event
. V9.00.02  12.08.2001 HPS - Jagath
.           Modified Functionality for Patient Dependency List
. V9.00.01  3.08.2001 HPS-ODC 
.           Added Functionality for Patient Dependency List
. V9.00.B07 13.07.2001 Sandra Barcham
.           Replace GP with HCP
. V9.00.B06 12/07/2001  HPS
.           Merged the changes 
. V9.00.B05 09/07/2001  Jill Habasque
.           Added the display of Exp. Disch     
. V9.00.B04 22/06/2001 HPS
.           Modified to display the closed beds
. V9.00.B03 07/05/2001 Ebon Clements 
.           Added new ward list screens as defined in
.           the PATWEB93 server specification
. V9.00.B02 22.03.2001 B.G.Ackland 
.           Rep " in Diag
. V9.00.B01 05/03/2001 Bronko Sosic
.           Added PATNAMCD and changed all displays of
.           Patient name to FORMATNM
.           Added a check for dead patients in GETPAT00
.----------------------------------------------------------------------
.                 V5.09.B03 15/01/2001 Bronko Sosic
.                           Recompiled for PATMASTM
.                 V5.09.B02 13.12.2000 B.G.Ackland
.                           Attempt to fix Problem with IE freezing.
.                 V5.09.B01 13.12.2000 B.G.Ackland
.                           Compile Updated IBAWEBCD to Try to Fix Taranaki 
.                           Problem with IE freezing.
.                 V5.08.10 20/09/2000 Katie Nelson
.                          SRF 647270 Included Standby and On-Leave patients 
.                          when updating patient condition and diet.
.                 V5.08.09 20/09/2000 Katie Nelson
.                          509 Changes 
.                 V5.08.08 11/09/2000 Katie Nelson
.                          SRF 647226
.                          Removed the height attribute from CBEDD000.
.                          SRF 647228
.                          Save the value of PSNAME
.                 V5.08.07 31.08.2000 Katie Nelson
.                          Added ADIAG1, ADIAG2 to Transfer List - THL Request
.                 V5.08.06  16/08/2000  Caleb Sharman
.                          Changed Health Fund variables to be 8 chars
.                 V5.08.05 31.07.2000 Katie Nelson 
.                          Change update condition and diet to redirect to next
.                          patient rather then closing and refreshing the table.
.                 V5.08.04 20.07.2000 Katie Nelson 
.                          Set table for ward list to fixed, added routine to
.                          format the name into surname, first name, initial of
.                          second name.  Changed GENDER to output PSEX.
.                 V5.08.03 26.06.2000 Katie Nelson 
.                          Do not write patient condition (LPCONDD) if spaces 
.                 V5.08.02 22.06.2000 Katie Nelson 
.                          Added Update Date/Time against Patient Condition
.                 V5.08.01 07.06.2000 Bronko Sosic
.                          Recompiled for PATMASTM    
.----------------------------------------------------------------------
.                 V5.07.17 15.03.2000 B.G.Ackland 
.                          Fixed Transfer List Option
.                          28.03.2000 K.C.Nelson   
.                          Changed BROWB000 to output BKREATIM 
.                 V5.07.16 14.03.2000 B.G.Ackland 
.                          Fixed Transfer List Option
.                 V5.07.15 09.03.2000 K.C.Nelson  
.                          Added U/R output to BROWB000 - requested by THL
.                          07.03.2000 B.G.Ackland 
.                          New Option for Transfers by Ward patweb9302002.html
.                 V5.07.14 02.02.2000 B.G.Ackland 
.                          Include Admission Diagnosis in Discharge Rows
.                 V5.07.13 01.02.2000 K.C Nelson  
.                          Changed Admission list to display admitting 
.                          diagnosis (at Taranaki)
.                          31.01.2000 K.C Nelson  
.                          Added Diet Comment to be displayed on Patient
.                          list (at Taranaki)
.                 V5.07.12 27.01.2000 B.G.Ackland 
.                          Added Diet Comment to be stored as adm comment 1
.                 V5.07.11 18.01.2000 K.C.Nelson  
.                          Added Standy patients into the count for number of 
.                          patients in a ward.
.                 V5.07.10 05.01.2000 K.C.Nelson  
.                          Recompiled for WEBDATCD Y2K date corrections
.                          and PATMASTM changes
.                 V5.07.09 20.12.1999 K.C.Nelson  
.                          Recompiled for IBAWEBCD/IBAWEBDF/PATWRDTM 
.                 V5.07.08 09.11.1999 K.C.Nelson  
.                          Fixed Display of Booking Time on Booking List    
.                          30.11.1999 K.C.Nelson  
.                          Fixed DOSA display when no theatre record present
.                 V5.07.07 05.11.1999 K.C.Nelson  
.                          Changed colors of legend and added in class attribute
.                 V5.07.06 03.11.1999 K.C.Nelson  
.                          Recompiled for WEBDATCD/DAYOFWEK                
.                 V5.07.05 18.10.1999 K.C.Nelson  
.                          Added class=TextCell to Number of Patients Cell 
.                          Added column DOSA to be output on Booking List     
.                 V5.07.04 11.10.1999 K.C.Nelson  
.                          Added discharge date to the discharge List      
.                 V5.07.03 07.10.1999 K.C.Nelson  
.                          Changed tables to use javascript sort table 
.                          Added option to output number of patients in a ward
.                 V5.07.02 19.07.1999 B.G.Ackland 
.                          Change Current Admission to Not Show Bed for No Bed
.                          Wards
.                 V5.07.01 16.07.1999 B.G.Ackland 
.                          Add New Option for Current Admissions
.                 V5.07.00 01.07.1999 K.C.Nelson  
.                          Port from 6.06 to 5.07      
.----------------------------------------------------------------------
.                 V6.06.02 10.05.1999 B.G.Ackland
.                          Added Diet Code Maintenance
.                 V6.06.01 26.04.1999 Katie Nelson
.                          Replaced KEY12 with KEY14 for on leave read
.                 V6.05.03 27.01.1999 Pat Dirito
.                          Added bookings for a date range option   
.                          15.02.1999 Katie Nelson
.                          Call PATNAA00 instead of PATNAM00 to remove bold
.                          tags within WEBTITLE
.                 V6.05.02 18.01.1999 B.G.Ackland
.                          Fix Next Page Rep + in Ward Code
.                 V6.05.01 13.01.1999 Katie Nelson
.                          Highlight cell background on expected discharge date
.                          for certain conditions.
.                 V6.04.00 28.04.1998 B.G.Ackland
.                          New Program
.----------------------------------------------------------------------
          INC       IBAWEBDF    
          INC       WEBDATDF    
          INC       RSHWEBDF
.
          INC       FHRDATDF
          INC       TFILEVAR/INC
          INC       APSMASFD/INC
          INC       AAEDE1FD/INC
          INC       ALLREFFD/INC
          INC       BOKDIAFD/INC
          INC       BOKRX1FD/INC
          INC       FMSCSAFD/INC
          INC       FMSLMAFD/INC      * Ledger Master Details
          INC       EMRVISFD/INC
          INC       IBAPOSFD/INC
          INC       IBALPCFD/INC
          INC       BOKRC1FD/INC     
          INC       MEHLERFD/INC
          INC       MLTSECFD/INC
          INC       OBSPCOFD/INC
          INC       OPRARDFD/INC
          INC       OPRSRGFD/INC  
          INC       OPRCONFD/INC
          INC       OPRDEAFD/INC
          INC       OPROPRFD/INC
          INC       OPRSESFD/INC            * Theatre Sessions Table
          INC       OPRSEMFD/INC            * Theatre Session Master
          INC       OUTSITFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTECTFD/INC
          INC       OUTEAHFD/INC
          INC       OUTERHFD/INC
          INC       OUTERDFD/INC
          INC       OUTECAFD/INC
          INC       PATBMDFD/INC
          INC       PATRE1FD/INC
          INC       PATRE1TD/INC
          INC       PATREMFD/INC
          INC       PATRGMFD/INC
          INC       PATPARFD/INC 
.
          INC       PMSCCDFD/INC   * Concession Card Details
          INC       PMSBDCFD/INC
          INC       PMSBRQFD/INC
          INC       PMSDTCFD/INC
          INC       PMSEAHFD/INC
          INC       PRIEAHFD/INC
          INC       PMSEADFD/INC
          INC       PRIEADFD/INC
          INC       PMSEBHFD/INC
          INC       PRIIBHFD/INC
          INC       PMSERDFD/INC
          INC       PMSERHFD/INC
          INC       PMSECAFD/INC
          INC       PRIECAFD/INC
          INC       PMSECOFD/INC
          INC       PMSETRFD/INC
          INC       PMSECTFD/INC
          INC       PRIPRAFD/INC
          INC       PRIECTFD/INC
          INC       PRIINVFD/INC
          INC       PMSESHFD/INC
          INC       PRIESHFD/INC
          INC       PMSESDFD/INC
          INC       PRIESDFD/INC
          INC       PMSREGFD/INC
          INC       PMSUCHFD/INC
          INC       PMSUCDFD/INC
          INC       PATMASTD/INC
          INC       PATALRFD/INC
          INC       PATASFFD/INC
          INC       PATATRFD/INC
          INC       PATATRTD/INC
          INC       PATBRDFD/INC
          INC       PATBRDTD/INC
          INC       PATDADFD/INC
          INC       PATDGWFD/INC
          INC       PATDSCFD/INC
          INC       PATDTRFD/INC
          INC       PRIDTRFD/INC
          INC       PRIHDBFD/INC
          INC       PRIHREFD/INC
          INC       PATHSPFD/INC
          INC       PATNIDFD/INC
          INC       PATHFRFD/INC
          INC       PATTRNFD/INC
          INC       PATELGFD/INC
....          INC       HL7BMTFD/INC
          INC       PATMA1FD/INC
          INC       PATNURFD/INC
          INC       PMSHCGFD/INC
          INC       PMSHCPFD/INC
          INC       PMSPX2FD/INC
          INC       PMSPX2TD/INC
          INC       PMSCEXFD/INC
          INC       PMSRELFD/INC
          INC       PMSTLEFD/INC
          INC       PATMI1FD/INC
          INC       PATDHEAD/INC
          INC       PATNOBFD/INC
          INC       PATDO1FD/INC
          INC       PATIN1FD/INC
          INC       PATINVFD/INC
          INC       PATITMFD/INC
          INC       PATVADFD/INC
          INC       PATVENFD/INC
          INC       PATVISFD/INC
          INC       VISCMTFD/INC
          INC       PATUREFD/INC
          INC       PATWR1FD/INC
          INC       PATLOCFD/INC
          INC       PATONLFD/INC
          INC       PATCALAG/INC
          INC       PATCONFD/INC
          INC       PATCMCFD/INC
          INC       VISMDTFD/INC
          INC       VISMTXFD/INC
          INC       PATMISTD/INC 
          INC       PATPR1FD/INC
          INC       PMSRCBFD/INC
          INC       MRTLOCFD/INC
          INC       RESLNKFD/INC
          INC       PATFN1FD/INC
          INC       PATFX1FD/INC
          INC       MRTMASFD/INC
          INC       PATDAYFD/INC            * HPS Code Starts Here 
          INC       PMSEVTFD/INC
          INC       PMSMSWFD/INC        * Multiple Specialty Wards
          INC       PMSPDPFD/INC            * HPS Code Ends Here
          INC       PMSWORFD/INC
          INC       PMSWORTD/INC
.
          INC       PMSHCGTD/INC
          INC       PMSHCPTD/INC
          INC       PMSVX1TD/INC
          INC       PMSQPTFD/INC
          INC       PMSQVIFD/INC
          INC       PMSVX1FD/INC
          INC       PMSNUTFD/INC            * v9.02.08
          INC       PMSNUTTD/INC            * v9.02.08
          INC       CATCOMFD/INC
          INC       CATCOMTD/INC
          INC       RCPBDTFD/INC
          INC       RCPBNKFD/INC
          INC       RCPDTEFD/INC
          INC       RCPCONFD/INC
          INC       RCPREGFD/INC
          INC       NHIMASFD/INC
          INC       NHIETHFD/INC
          INC       WATTR1FD/INC
.
          INC       OBSDETFD/INC      * Observations on Ward Map
          INC       PMSCURFD/INC
          INC       VISXDCFD/INC
          INC       VISXDCTD/INC
          INC       TIMEDIFW/INC
          INC       VISCMTDF
.
ACCNO     DIM       12
ACTVDESC  DIM       3
ROOMDESC  DIM       25
BEDTDESC  DIM       25
CNTR1     FORM      5
ADJTIME   FORM      5
ADMSTAT   FORM      1
ALTVIEW1  FORM      1                       * 0=No, 1=Yes
ALLHFLAG  FORM      1       * 'All' hospital flag
ALCNRAUD  DIM       1
ANATCODE  DIM       6       
ANATNAME  DIM       50      
ANAESTFL  DIM       1       
ANATFLAG  FORM      1
ANATDES1  DIM       50    
ANATDES2  DIM       50   
ANATDES3  DIM       50  
ANATTHET  DIM       25
ANATTYPE  DIM       25
ANATTRAN  DIM       25
ANATANAE  DIM       25
ANATDATE  DIM       8
ANATTIME  DIM       5
ANATEXPS  DIM       5
ANATEXPD  DIM       4
ALRTCODE  DIM       20[99]           * Array of alert codes
ALRTICON  DIM       5[99]            * Array of alert codes
ALRTICNT  FORM      2       
ALRTDCNT  FORM      2       
ICONNAME  DIM       5
ICONFILE  DIM       18
IFSTDESC  DIM       25
POSTOPFL  FORM      1
POSTWBED  DIM       50
BMIINDIC  DIM       1
CREATEDB  DIM       65
CURSTATS  DIM       25
CURSTATT  DIM       40
CURSTATB  DIM       5                * Current status recovery bay
CURSTATC  DIM       5                * Current status recovery bay no ()
DUPNMFLG  FORM      1
SAVCLASS  DIM       3
STAPRFIX  INIT      "RIP - " * Prefix for Patient Status
SKEY31    DIM       31
SAVDIM35  DIM       35                                                *I-174468
SAVTXWRD  DIM       3
ASESDESC  DIM       7
BORDICIN  FORM      1
BODMASIN  DIM       5
BODMASRN  DIM       60
BODMASUW  INIT      "<font color=purple>"
BODMASHE  INIT      "<font color=black>"
BODMASFT  INIT      "<font color=red>"
BOLD      INIT      "<b>"
EDITFLAG  FORM      1
ENDBOLD   INIT      "</b>"
ENDFONT   INIT      "</font>"
BLNKFLAG  FORM      1
BMCMDIM8  DIM       8
BULKDSCH  FORM      1
BTSCHOSP  DIM       3
CNOTFLAG  FORM      1                            * display clinical notes flag
DISPUDF4  FORM      1                            * display pmvxudf4 (1=no)
DISPLUPD  DIM       12
DISPLUTM  DIM       8
DISPTHET  FORM      1
DISPMV    FORM      1
DISPPCNT  DIM       2
DISPPNAM  DIM       80
DISPPRAC  DIM       10
PRACNAME  DIM       80
PRACADD1  DIM       60
PRACADD2  DIM       60
PRACADD3  DIM       60
PRACADD4  DIM       60
PRACPOST  DIM       8
PRACPEML  DIM       80
PRACPTEL  DIM       20
PRACPFAX  DIM       20
PRACPROV  DIM       10
EXDTBLNK  FORM      1
EXTRDIET  FORM      1
CLAIMSTA  DIM       2
CLAMTOTL  FORM      7.2
PROCSTAT  DIM       1
VALDTYPE  FORM      1
BATCHNUM  DIM       8
EXCLCLOS  FORM      1
EXCLWAIT  FORM      1
EXPTTYPE  FORM      1
FASTVIEW  FORM      5
SJOGVIEW  FORM      1
STVVIEW   DIM       1                                               * Car 262343
HEAVIEW   FORM      1
HEAONLY   FORM      1
CABONLY   FORM      1
ONLEAVET  FORM      1
FONTRSTR  INIT      "<font color=red>"
FONTREND  INIT      "</font>"
FORM8A    FORM      8
FORM7P2C  FORM      7.2
FORM10P2  FORM      10.2
FORM12P2  FORM      12.2
FORM12    FORM      12
FORMTYPE  FORM      1
FILTURNO  DIM       8
FILTADMN  DIM       8
FILTHOSP  DIM       3
CODN      INIT      "n"
CODS      INIT      "s"
CMDLINE   DIM       80
CLBDINDC  FORM      1
DEBDINDC  DIM       1
DEFTVIEW  FORM      1
LSFLAG    DIM       1
DESCML01  DIM       20
DESCML02  DIM       20
DESCML03  DIM       20
DESCML04  DIM       20
DESCML05  DIM       20
DESCML06  DIM       20
DESCML07  DIM       20
DESCDPST  DIM       20
DOCEXIST  DIM       1
LINKDOC   DIM       100
TDAYMON   DIM       4                       * HPS Code Starts Here
TOGGLEXP  FORM      1
.
DATE      DIM       8
HOUR      DIM       2
MIN       DIM       2
SEC       DIM       2
DATE8     DATE      8
DFLTWARD  DIM       3  * ward to be pre-selected on ward selection list 
DIFCINDC  DIM       1
DIETDESC  DIM       25
DIETDSC2  DIM       25
DIETDSC3  DIM       25
DIETDSC4  DIM       25
DIETDSC5  DIM       25
DIM1A     DIM       1
DIM1B     DIM       1
DIM1C     DIM       1
DIM10     DIM       10
DIM10A    DIM       10
DIM10B    DIM       10
DIM20     DIM       20
DIM11     DIM       11
DIM15     DIM       15
DIM4      DIM       4
DIM40     DIM       40
DIM40A    DIM       40
DIM40B    DIM       40
DIM40C    DIM       40
DIM5      DIM       5
DIM5A     DIM       5
DIM6      DIM       6
DIM7      DIM       7
DIM9      DIM       9
DIM12     DIM       12
DIM50     DIM       50
DIM127A   DIM       127
DISCATDD  FORM      1
D3A       DIM       3
DAYKEY    DIM       4
DEFTFLAG  DIM       1
DIM3      DIM       3
DOCTORC   DIM       10
EMERGVIS  FORM      1
EMRGVIEW  FORM      1
EMVIFLAG  FORM      1
FULLSTOP  INIT      "."
FOLDRNAM  DIM       40
FOLDRTYP  FORM      1
FORM1A    FORM      1
.FOLDER2   INIT      "PatientFolder.gif"
.FOLDER1   INIT      "FolderAlert.gif"
FOLDER0   INIT      "PatientFolder.gif"
FOLDER1   INIT      "FolderAlert.gif"
FOLDER2   INIT      "FolderAlertBlack.gif"
FOLDER3   INIT      "FolderAlertDelete.gif"
FOLDER4   INIT      "FolderAlertGreen.gif"
FOLDER5   INIT      "FolderAlertBlue.gif"
FOLDER6   INIT      "FolderAlertYellow.gif"
FOLDER7   INIT      "FolderAlertOrange.gif"
FOLDER8   INIT      "FolderAlertPurple.gif"
FOLDER9   INIT      "FolderAlertRed.gif"
CSPAN     DIM       2
CLOSEDEP  FORM      1
CONLINK   DIM       127
CONDINDC  DIM       1
CSPANUM   FORM      2
CELLCOLR  DIM       20
CRSRTCNT  FORM      3
DISPPREP  DIM       20
DISPUSR2  DIM       20
DISPBBDT  DIM       11
DISPBSDT  DIM       11
EXPDSTME  DIM       5        * Calculated Expected Discharge Time
ERDCOUNT  FORM      8
PRLCOUNT  FORM      8
RELCOUNT  FORM      8
BATCHTOT  FORM      12.2
FORM2P1   FORM      2.1
FORM2P1A  FORM      2.1
FORM2P2   FORM      2.2
FORM2P2A  FORM      2.2
FORM4P2   FORM      4.2
FORM3     FORM      3
FORM4B    FORM      4
FORM6     FORM      6
FORM6A    FORM      6
FORM6P1   FORM      6.1
FORM6P1A  FORM      6.1
FILTDPST  DIM       3
FILTCLAI  DIM       3
FILTEXPD  DIM       3
FILTEXDY  FORM      1
SHOWFLAG  FORM      1
FLAGID    DIM       1
FLGITMNO  FORM      1
SUBITMNO  DIM       3
SUBITMFO  FORM      3
.
ATRTYPE   DIM       3
MISMTFLG  DIM       1
WOUTIND1  DIM       1
PSPCIND1  DIM       1
CLBEDDET  DIM       256
CLBEDDE1  DIM       256
DSCHDDET  DIM       256
.
BOOKINGS  FORM      8
PREADMIS  FORM      8
EXPPOSOP  FORM      8
EXPDBREQ  FORM      8
CONFRMDC  FORM      8
.
FREETXT1  DIM       40
FREETXT2  DIM       40
FREETXT3  DIM       40
FREETXT4  DIM       40
FREETXT5  DIM       40
FREETXT6  DIM       40
FREETXT7  DIM       40
FRMCOD01  DIM       6       * Stationery Code for Form 1
FRMCOD02  DIM       6       * Stationery Code for Form 2
FRMCOD03  DIM       6       * Stationery Code for Form 3
FRMPNO01  DIM       3       * Number of Labels for Form 1
FRMPNO02  DIM       3       * Number of Labels for Form 2
FRMPNO03  DIM       3       * Number of Labels for Form 3
FRMPRT01  DIM       1       * Print Indicator - Form 1
FRMPRT02  DIM       1       * Print Indicator - Form 2
FRMPRT03  DIM       1       * Print Indicator - Form 3
FRMPSL01  DIM       6       * Printer Selected for Form 1
FRMPSL02  DIM       6       * Printer Selected for Form 2
FRMPSL03  DIM       6       * Printer Selected for Form 3
INPLABAR  DIM       8[100]           * Array of inpatient records
HYPHEN    INIT      "-"
HLTHFUND  DIM       6
HLFDCLTY  DIM       1
INVNUMBR  DIM       8
KEY8A     DIM       8
KEY16A    DIM       16
LABELTYP  DIM       10
LABPRT01  DIM       1       * Print Indicator - Address Label
LABPRT02  DIM       1       * Print Indicator - PMI Label
LABPRT03  DIM       1       * Print Indicator - INP Label
LABPRT04  DIM       1       * Print Indicator - GP Mailing Label
LABPNO01  DIM       3       * Number of Labels for Address Label
LABPNO02  DIM       3       * Number of Labels for PMI Label
LABPNO03  DIM       3       * Number of Labels for Inpatient Label
LABPNO04  DIM       3       * Number of Labels for GP Mailing Label
LABPSL01  DIM       6       * Printer Selected - Address Label
LABPSL02  DIM       6       * Printer Selected - PMI Label
LABPSL03  DIM       6       * Printer Selected - Inpatient Label
LABPSL04  DIM       6       * Printer Selected - GP Mailing Label
LOOPCNTR  FORM      8
MEDDEXST  DIM       1
NURSTCOD  DIM       3       * Nursing Station code
NURSTNUM  DIM       20      * Nursing Station extension number
OUTLTYPE  DIM       3       * Outlier booking type
BEDMSGID  FORM      1
BDMSGCLS  DIM       23
BDMSGTXT  DIM       16
RYEAR     DIM       4
MEALDATE  DIM       16
MULTHOSP  DIM       50
NBSP      INIT      "&nbsp;"
PATNLOCN  DIM       3
PTMIS038  DIM       3
PTMIS039  DIM       1
PTMIS040  DIM       3
PTMIS041  DIM       3
PTMIS042  DIM       3
PTMIS043  DIM       1
PTMIS044  DIM       3
PRNTLABL  DIM       1
PTKEYCNT  FORM      3
PTCOUNT   FORM      3
NEXTPATF  DIM       1
SERVDATE  DIM       8 
SERVDAT1  DIM       8 
SECDOCDE  DIM       40                      * Secondary Doctor
PARTCODE  DIM       3
PARTNUMB  DIM       4
PSAGEDIM  DIM       3
PMSPD001  DIM       10
PMSPD002  DIM       1 
PTSTATUS  FORM      1
PMHFILAF  FILE      ASCII, FIXED=127
WDIFILAF  FILE      ASCII, FIXED=127
CLNFILAF  FILE      ASCII, FIXED=127
COMFILDF  FILE      ASCII, FIXED=127
.
DTCMTFLG  FORM      1
SHWPHOTO  FORM      1
COMDTCAF  FILE      ASCII, FIXED=127
COMDTCNM  DIM       8
QRYDATA1  DIM       240
ARYCOMMT  DIM       40[5]
ARYDESC   DIM       20[5]
.
PMHFILNM  DIM       8
WDIFILNM  DIM       8
CLNFILNM  DIM       8
COMFILND  DIM       8
LASTITEM  FORM      3
LASTITM2  FORM      3
LASTITM3  FORM      3
PTDSC002  DIM       8
PTDSC005  DIM       3
PTDSC006  DIM       3
DEFTALLH  FORM      1
SHIFTNUM  DIM       1                       * HPS Code Ends Here
SERDIM50  DIM       50
FOLDERSF  DIM       3                       * Folder Icon Suffix
ADMITDAY  FORM      5
FILETYPE  FORM      1
TCOLSPAN  FORM      1
RECFOUND  FORM      1
NOTFOUND  FORM      1
RECPTIND  DIM       1
SAVTDATE  DIM       8
SAVKEY12  DIM       12
SAVKEY24  DIM       24
SAVETRID  DIM       24
SAVEVISN  DIM       8
CALCEXLS  DIM       1
CLMUNIID  DIM       6
ECCLFBID  DIM       3
ECCLARID  DIM       20
ECCLFRID  DIM       12
ECCLRPTC  DIM       3
ECCLSCOD  DIM       11
ECCLSRVC  DIM       3
ECOTFUND  DIM       6
ECOTTYPE  DIM       1
ECOTTRID  DIM       24
FUNDTRID  DIM       24
ECREPYPN  DIM       8
ECREPRUN  DIM       4
ECREPDAT  DIM       8
ECRERKEY  DIM       24
.ECRECLID  DIM       6
.ECREPYRN  DIM       4
.ECREPYRD  DIM       8
.ECRERRKY  DIM       24
ECREADVC  DIM       30
ECREPTNO  DIM       4
ECRETRID  DIM       24
ECRECLAM  DIM       6
FMTPATAG  DIM       10
HOSPCODE  DIM       3  
HOSPNAME  DIM       50
LENPTR    FORM      2
COUNT     FORM      2
TRANOUT   FORM      1
NOCATCOM  FORM      1
NOATTRIB  FORM      1
.
EXPDSDTE  DIM       8        * Calculated Expected Discharge Date
FORM3A    FORM      3
LOSDINDC  FORM      1
MEDCLRDT  DIM       70
PAYEEPNO  DIM       8
PAYMTRUN  DIM       4
PAYMRUND  DIM       8
RETRVKEY  DIM       24
PAYRUNNO  DIM       4
PAYRUNDT  DIM       8
REPRETKY  DIM       24
PROVNUMB  DIM       8
PTRGM001  DIM       10
PTRGM002  DIM       10
PTRGM003  DIM       10
SAVKEY9   DIM       9
SAVEADMO  DIM       8
SAVEBRQN  DIM       8
SAVEDATE  DIM       8
SAVELOSD  DIM       3
SAVELOSM  DIM       5
SAVETIME  DIM       5
STAYDAYS  FORM      5
LOOPDAYS  FORM      5
CNTREADS  FORM      8
STVCVIEW  FORM      1
TRANDATE  DIM       8
TRANTIME  DIM       8
TRNTOBED  DIM       3
TRNTOWRD  DIM       3
TTYPEARG  DIM       2
PWDVTYPE  DIM       1
.
MAVBATCH  DIM       8
MAVINVCE  DIM       8
MBSDESC   DIM       40
MOVEDESC  DIM       35
MOVETYPE  FORM      1
MOVEADM   INIT      "Admission"
MOVEBED   INIT      "Transfer Bed"
MOVEDSC   INIT      "Discharge"
MOVETIN   INIT      "Transfer In"
MOVELVO   INIT      "Sent On Leave"
MOVELVI   INIT      "Return from Leave"
MOVETOT   INIT      "Transfer Out"
MOVESPC   INIT      "Doctor/Specialty Change"
MRFDDATE  DIM       8
MULTLT01  DIM       1
NEXTPAGE  DIM       1
NULL      EQU      000
OVERRIND  FORM      1
OVFLDESC  DIM       40                                               *C-0837181
PAYMTKEY  DIM       47
REMITKEY  DIM       61
SAVEADMN  DIM       8
SAVELOCN  DIM       8
SAVEREGM  DIM       10
STRTTIME  DIM       8
SAVETYPE  DIM       3
SAVEDOCT  DIM       6
SAVEWARD  DIM       3
SAVEBED   DIM       3
SAVKEY30  DIM       30
SAVPSNAM  DIM       20                      * Save PSNAME
SETDFPRG  DIM       8
SETDFRPT  FORM      2
SAVHDSEC  FORM      5
SAVREPTN  FORM      2
SAVPRGID  DIM       8
SHRTNAME  DIM       25
STATNCOD  DIM       6   
SUBSYSKY  DIM       50
TEMPDATE  DIM       8
TEMPSTAT  DIM       1
TEMPTIME  DIM       8
TEMPURNO  DIM       8
TESTDAT1  DIM       14
TESTDAT2  DIM       14
TEMPFILE  DIM       8
UPWORKDG  FORM      1
UPDATETY  DIM       1
UPDATET2  FORM      1
UPDATEDB  DIM       65
UNRELREM  DIM       1
UNRELINQ  DIM       1
ERASTATS  DIM       1
UNLKFLAG  FORM      1
VIEWONLY  FORM      1
VISITNUM  DIM       8                                                *C-0837181
WSDEINDC  DIM       1
.
FORM7P2O  FORM      7.2
FORM8     FORM      8
NUMOFPAT  FORM      3
NOBEDWRD  FORM      1
SDOCFNAM  DIM       50
DIADESC1  DIM       80
DIADESC2  DIM       80
DIM8      DIM       8
DIM8A     DIM       8
DIM8B     DIM       8
DIM8C     DIM       8
DIM8D     DIM       8
DIM8E     DIM       8
DIM16     DIM       16
DIM24     DIM       24
DIM32     DIM       32
DIETCODE  DIM       3
DIETTYPE  DIM       3                       * Diet Type (used for filter)
DIETCOMM  DIM       40
DIETFILT  FORM      1                       * Flag - are Diet filters being used
DIETNCDE  DIM       10                      * Dietitian code (used for filter)
DIETNNAM  DIM       35                      * Dietitian name (disp for filter)
DIM35     DIM       35 
DOSASTAT  DIM       3                       * DOSA status Yes/No/Unkown
PATCONCD  DIM       3
PATCONDS  DIM       35
PATCONVA  DIM       1
PATCONPA  DIM       1
PATCONAM  DIM       3
PATCONTL  DIM       50                      * Pat Condition - Temporary Location
PTVIS067  DIM       50                      * Diet Comment - I SRF 22685
CODEA     INIT      "A "
CODEAM    INIT      "AM"                    * Category for Ambulatory status 
CODECO    INIT      "CO"
CONTDESC  DIM       16
CONTDES1  INIT      "Not in series   "
CONTDES2  INIT      "First in series "
CONTDES3  INIT      "Last in series  "
CONTDES4  INIT      "Middle in series"
COLRFLAG  DIM       15
COLRFLG1  DIM       15
CURRDATE  DIM       8                       * current date in format CCYYMMDD
CURRTIME  DIM       8
EXPCDATE  DIM       8                       * expc discharge date in CCYYMMDD
EXPLRETN  DIM       43                      * Exp return from leave date/time
IMGSRC    DIM       20
CAT       INIT      "BK"                    * category from BKRETYPE
CATAC     INIT      "AC"
CATBU     INIT      "BU"
CATBW     INIT      "BW"
CATCG     INIT      "CG"
CATCL     INIT      "CL"
CATDC     INIT      "DC"
CATME     INIT      "ME"                    * category ME for Diet Meal Code
CATMJ     INIT      "MJ"                    * category MJ for Diet Type
CATMK     INIT      "MK"                    * category MK for Diet Assistnce lv
CATMM     INIT      "MM"                    * category MM for Diet Other Detail
CATSN     INIT      "sn"                    * category sn Special Needs Code
CATVI     INIT      "VI"                    * category VI for Intended Stay
CATLVI    INIT      "vi"                    * category vi Discharge Prep Status
CATwi     INIT      "wi"
CATTC     INIT      "tc"
DTOTHDTL  DIM       20                      * Diet - other details description
DTDTTYPE  DIM       20                      * Diet - diet type description
DTMENUCD  DIM       20                      * Diet - menu code description
DTASSLEV  DIM       20                      * Diet - assistance level desc
DTDTNNAM  DIM       20                      * Diet - Dietitians name
DTFASTNG  DIM       6                       * Diet - Fasting indicator
CONDESC   DIM       25
CONDESC1  DIM       20
DATESTR   DIM       12
DATEEND   DIM       12
THREE6    FORM      "36"
THETODAY  FORM      1                 * Theatre today
FORM5     FORM      5
FORM5A    FORM      5
FOUR8     FORM      "48"      
INCMACCT  DIM       14                * Saved Income Accont
ROWHEAD   DIM       40
LEDNO     DIM       2
LOCNCODE  DIM       4
FIRSTONL  FORM      1
FIRSTCEL  FORM      2
STBYFLAG  FORM      1
DLINKPRG  DIM       8
DLINKREP  DIM       2
DLINKTEM  DIM       3
REMITADV  DIM       30
RECCNT    FORM      4
DRECCNT   DIM       4
FLAG      FORM      1
EXDIFLAG  DIM       1                       * I CAR 38459
EXPDSTDS  DIM       256
SAVKEY6   DIM       6
SAVKEY27  DIM       27
SAVKEY45  DIM       45
SAVKEY47  DIM       47
LASTWARD  DIM       3 
NEXTPATN  DIM       127
NEXTPATM  DIM       1
FROMPATN  DIM       1
KIDSONLY  FORM      1
KIDSVEW2  FORM      1
WAHLFLAG  DIM       1
.
WARDCODE  DIM       3
WARDNAME  DIM       20
WBEDDESC  FORM      1
WARDKEY   DIM       3                       * Ward Code                         
WARDTEXT  DIM       20                                                          
BEDKEY    DIM       3                       * Ward Code                         
BEDTEXT   DIM       20                                                          
WBEDTEXT  DIM       43                                                          
WATCOUNT  DIM       2
RECCOUNT  FORM      4
DISPNUMB  FORM      4
EMPTONLY  FORM      1               
ADMNOF6   FORM      6               
FORMACTN  DIM       5               
DOCTCODE  DIM       6
DIETDRCD  DIM       6
DIM27     DIM       27
DIM100    DIM       100
DOCGNAME  DIM       25
DOCSNAME  DIM       20              
DOCTITLE  DIM       9              
PDIAGNOS  DIM       50
PWARD     DIM       3 
PBED      DIM       3 
BEDSTAT   FORM      1
MALE      INIT       "M"               
PATCOUNT  FORM      8
TENTACNT  FORM      6
CONFMCNT  FORM      6
FILWIDTH  DIM       10
FILHIGHT  DIM       12
FILHIGH   FORM      3 
PERCENT   FORM      3.1
EXPCTDSC  DIM       20
SRTEDDAT  DIM       8
ADMISDAT  DIM       12
BOOKNDAT  DIM       12 
BOOKSTAT  DIM       12 
ERASUSIN  FORM      1
PATBNAME  DIM       40
DIM30     DIM       30 
DIM80     DIM       80 
OPTIONZ   DIM       1
ONLVFLAG  FORM      1
MVFLAG    FORM      1
MEHLSFLG  FORM      1
STATUS    DIM       1
STATDESC  DIM       11
BED       DIM       7
TFLAG     FORM      1         * indicator flag, uses booking time or TH time 
TIME      DIM       5          
TMBDARRY  DIM       38[48]
TIMEARRY  DIM       11[48]     * Time array 30 minute slots
TMARRCNT  FORM      3
DATEARRY  DIM       11[7]     * Date array
DMBDARRY  DIM       40[7]
DMARRCNT  FORM      3
ATTIME    DIM       3 
AT        INIT      "at "     * display html between date and time 
PATLINK   DIM       127                     * Link to the next patient info
DESTDESC  DIM       20
DISPDATE  DIM       13        * display variable for patient condition date
WBEDTYPE  FORM      1         * CGI variable for ward bed type selection
.                             0 = All , 1 = Open Beds, 2 = Empty Beds Only
NMPNUMB   DIM       20
NUMNOBED  FORM      5         * Number of patients not allocated a bed
NUMEMBED  FORM      5         * Number of empty beds
NUMBPATS  FORM      5         * Number of Patients
NUMBREXP  FORM      5         * Number of expected patients
NUMBOUTL  FORM      5         * Number of Outliers
NUMBEXPT  FORM      5         * Number of expexted Patients (current ward)
NUMBCNFD  FORM      5         * Number of confirmed discharges 
SAVNOBED  FORM      5         * Number of patients not allocated a bed
SAVEMBED  FORM      5         * Number of empty beds
SAVBPATS  FORM      5         * Number of Patients
SAVEOUTL  FORM      5         * Number of Outliers
SAVEEXPT  FORM      5         * Number of expexted Patients (current ward)
SAVECNFD  FORM      5         * Number of confirmed discharges
.
SAVEPART  DIM       3
SKIPDIET  DIM       1         * Skip Diet Text
SUPERECL  FORM      1         * Eclipse Supervisor flag (1=yes/0=no)
SHOWTEXT  DIM       1000
.
TEMPINVN  DIM       8         * Invoice Number
TEMPBATN  DIM       8         * Batch Number
TEMPADMN  DIM       8         * Admission Number
.TEMPURNO  DIM       8         * U/R Number
TEMPHFND  DIM       6         * Health Fund
TEMPPBAT  DIM       8         * Previous Batch Number
TEMPHOSP  DIM       3         * Hospital Code
TYPEDESC  DIM       20
TYPOFREQ  FORM      2             * Eclipse type of request
.
UPDATEKY  DIM       32       * admissno,ccyymmdd,hhmmss,webuseid
UPDLINK   DIM       127
UPDLNKP   DIM       127
.
CLOSEFLG  DIM       1         * Bed Closed Flag, 0 = Not Closed, 1 = Closed
.
LEAVFLAG  DIM       1
MHLSFLAG  DIM       1
VIEWINDI  FORM      1
RSUBINDI  FORM      1
VISPHONE  DIM       32
.
WORCOMAF  FILE      ASCII, FIXED=127        * For Working Diagnosis
WORCOMNM  DIM       8
.
HISCOMAF  FILE      ASCII, FIXED=127        * For History Comments
HISCOMNM  DIM       8
.
WORCOMFL  FORM      1
WORKDFLG  FORM      1
HISCOMFL  FORM      1
.
WORKFLAG  DIM       1
WORKDESC  DIM       280
.
ATTMPFAF  FILE      ASCII, FIXED=127        * For Attribute Notes temp file
ATTMPFIL  DIM       8        * Patient Attribute notes temp file name
ATWDIAFN  DIM       8        * Patient Attribute Working Diagnosis filename
ATMHISFN  DIM       8        * Patient Attribute Medical History filename
ATBDISFN  DIM       8        * Patient Attirbute Barriers to Discharge
.
MINSDIFF  DIM       6        * Minutes difference between 2 dates
PATATURN  DIM       8        * Patient Attribute UR no.
PATATVIS  DIM       8        * Patient Attribute Visit no.
PATATNOT  DIM       3        * Patient Attribute Note Type
ATTRNOTE  DIM       250      * Patient Attribute Notes (PTARTXT1-PTARTXT3)
.
WDBDSRCH  DIM       1        * Ward/Bed Search View flag (readonly output)
FRWRDTXT  DIM       40
FRBEDTXT  DIM       40
DISWAFIL  DIM       1
DIDENEWR  DIM       1
.
PIPE      INIT      "|"
.
UKEY      INIT      " 86 U1-24 U83-85,1-24"
.
.         Temporary File Definition
.         -------------------------
.
.         Filename : pms07axx.dat          (xx = port id)
.
ECLTEMP1  IFILE SQL, FIXED=86, KEY="U1-24"
ECLTEMP2  IFILE SQL, FIXED=86, KEY="U83-85,1-24"
.
.NAME     TYPE    LENGTH     PHYSICAL     START     DESCRIPTION
.----     ----    ------     --------     -----     -----------
.PMEDTRID DIM       24         24           1       Transaction ID
.PMEDFTID DIM       24         24          25       Fund Transaction ID
.PMEDRADV DIM       30         30          49       Remittance Advice ID
.PMEDPNUM DIM       4           4          79       Part Number
PARTPANT  DIM       3           3          83       Participant
.         
.End of Record                             86
.
ASESDES1  INIT      "Accept."
ASESDES2  INIT      "Reject."
ASESDES3  INIT      "Warning"
ASESDES4  INIT      "Compl. "
ASESDES5  INIT      "I-Acc. "
.
ERASE     INIT      "iserase "
ISBUILD   INIT      "isbuild "
.
LBRACKT   INIT      "("
RBRACKT   INIT      ")"
CATD      INIT      "D "
CATDD     INIT      "DD"
CATH3     INIT      "H3"              * Food Allergy
CATH6     INIT      "H6"              * Food Allergy
BOOKED    INIT      "Booked"
PREADM    INIT      "Pre-admitted"
CANCEL    INIT      "Cancelled"
ADMITT    INIT      "Admitted"
DISCHR    INIT      "Discharged" 
LABELINP  INIT      "LABELINP"
LABELPMI  INIT      "LABELPMI"
LABELADD  INIT      "LABELADD"
HTMLBR    INIT      "<br />"
LABREQST  INIT      "Req : "
.
SEC1      FORM      "00001"
.
STATUS00  INIT      "Waiting    "
STATUS01  INIT      "Ext. Error "
STATUS02  INIT      "Extracted  "
STATUS03  INIT      "SA Error   "
STATUS04  INIT      "Received   "
STATUS05  INIT      "Unverified "
STATUS06  INIT      "Verified   "
STATUS07  INIT      "Assessing  "
STATUS08  INIT      "Int. Ready "
STATUS09  INIT      "Int. Report"
STATUS10  INIT      "Ready Rej. "
STATUS11  INIT      "Ready Comp."
STATUS12  INIT      "Rej. Report"
STATUS13  INIT      "Com. Report"
STATUS14  INIT      "Rem. Report"
STATUS15  INIT      "Closed     "
.
TYPEDES1  INIT      "Status Request      "
TYPEDES2  INIT      "Status Req. Response"
TYPEDES3  INIT      "Report Request      "
TYPEDES4  INIT      "Report Req. Response"
TYPEDES5  INIT      "Viewed              "
TYPEDES6  INIT      "Data Error          "
TYPEDES7  INIT      "Trans. Error        "
ZERO4     INIT      "0000"
Z20       INIT      "zzzzzzzzzzzzzzzzzzzz"
FRBRACK   INIT      " / "
.
SPECDESC  DIM       25
FUNDDESC  DIM       50
RGMCOD01  DIM       10
RGMCOD02  DIM       10
RGMCOD03  DIM       10
RGMNAM01  DIM       40
RGMNAM02  DIM       40
RGMNAM03  DIM       40
RGMSTA01  DIM       1
RGMSTA02  DIM       1
RGMSTA03  DIM       1
ONLEAVE   FORM      1
RTTDESC  DIM       25
BVTDESC  DIM       25
BWTDESC  DIM       25
CATVA     INIT      "va"
CATVB     INIT      "vb"
CATVC     INIT      "vc"
CATVD     INIT      "vd"
CATVE     INIT      "ve"
CATVF     INIT      "vf"
CATVG     INIT      "vg"
CATVH     INIT      "vh"
NAMECTVA  DIM       25
NAMECTVB  DIM       25
NAMECTVC  DIM       25
NAMECTVD  DIM       25
NAMECTVE  DIM       25
NAMECTVF  DIM       25
NAMECTVG  DIM       25
NAMECTVH  DIM       25
USERDF01  DIM       100
USERDF02  DIM       100
USERDF03  DIM       100
USERDF04  DIM       100
USERDF05  DIM       100
USERDF06  DIM       100
USERDF07  DIM       100
USERDF08  DIM       100
USERDF09  DIM       100
USERDF10  DIM       100
BOARDERS  FORM      2
DIETCNT   FORM      2
BPRNT     DIM       1[999]
BADMN     DIM       8[999]
.
DISPDNAM  FORM      1        * Display duplicate surname icons
ID        DIM       8
WDBEDTXT  DIM       40
ATNSECDC  DIM       40     * Attending Doc and Secondary Doc
ENSTATUS  DIM       20
LCSTATUS  DIM       20
FHRSUBIN  FORM      1
FHRLOCIN  FORM      1      * _include=Encounter:location
FHRPARIN  FORM      1      * _include=Encounter:participant
TIMEZONE  DIM       6
TZFILE    FILE      ASCII, FIXED=256
.
.------------------------------------------------------------------------------
PRGID     INIT      "PATWEB93"
VERSION   INIT      "V12.01.02"
PRGNAM    INIT      "Ward Patient List Server"
.------------------------------------------------------------------------------
.
          CALL      WEBINT00       * Initialise Fifo Etc.
          CALL      INIT0000       * Open Files
.
MAIN1000  CALL      WEBRED00       * Read Fifo WEBPID and USERID
.
          COMPARE   "999",REPORTNO * End Server Process on Report Option 999
          GOTO      MAIN9999 IF EQUAL
.
          BRANCH    REPORTNO,MAIN1100,MAIN1200,MAIN1300,MAIN1400,MAIN1500:
                             MAIN1600,MAIN1700,MAIN1800,MAIN1900,MAIN2000:
                             MAIN2100,MAIN2200,MAIN2300,MAIN2400,MAIN2500:
                             MAIN2600,MAIN2700,MAIN2800,MAIN2900,MAIN3000:
                             MAIN3100
.
          PACK      WEBTITLE,PRGID,SP1,VERSION,SP1,PRGNAM,SP70
          MOVE      "INVALID OPTION",WEBTITLE
          CALL      WEBERR00   * Create Output File and Write HTML Page Header
          GOTO      MAIN1000
.
MAIN1100  CALL      CURADM00   * Ward Current Admissions
          GOTO      MAIN1000
.
MAIN1200  CALL      PATDSC00   * Ward Discharges by Date
          GOTO      MAIN1000
.
MAIN1300  CALL      PATADM00   * Ward Admissions by Date
          GOTO      MAIN1000
.
MAIN1400  CALL      PATPRE00   * Ward Pre Admissions
          GOTO      MAIN1000
.
MAIN1500  CALL      PATCON00   * Output Patient Condition Form
          GOTO      MAIN1000
.
MAIN1600  CALL      UPDCON00   * Update Patient Condition
          MATCH     "1",FROMPATN
          IF        @EQUAL
            CALL      REDIRE00 
          ELSE    
            MATCH     SP70,NEXTPATN
            IF        @EQUAL | @EOS
              CALL      WINCLS00   * Refresh Parent & Close Window
            ELSE
              CALL      NXTPAT00
            ENDIF
          ENDIF
          GOTO      MAIN1000   
.
MAIN1700  CALL      PATBOK00     * Ward Bookings by date
          GOTO      MAIN1000 
.
MAIN1800  CALL      UPVEXT00     * Update Visit Ext (diet comment only)
.                                * I SRF 22685
          CALL      UPDIET00     * Update Nutrition         
          GOTO      MAIN1000   
.
MAIN1900  CALL      XMLSCR00     * returns Status default for Reason
          GOTO      MAIN1000
.
MAIN2000  CALL      ALLWRD00     * All Wards Lists      
          GOTO      MAIN1000
.
MAIN2100  CALL      EXPDIS00     * Expected discharges
          GOTO      MAIN1000
.
MAIN2200  CALL      PRTGPL00   * Schedule Group Label Printing
          GOTO      MAIN1000
.
MAIN2300  CALL      BEDMAN00   * Bed Management
          GOTO      MAIN1000
.
MAIN2400  CALL      ECCE0000   * Eclipse Claim Enquiries
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2500  CALL      REMOTE00        * Various Remote Scripting Functions
          GOTO      MAIN1000
.
MAIN2600  CALL      ECFD0000   * Eclipse Claim Full Details
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2700  CALL      ECRE0000   * Eclipse Remittance Advice Enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2800  CALL      NUTR0000        * Patient Level Nutrition Maintenance
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN2900  CALL      ECRM0000        * Eclipse IMC Remittance Advice Enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3000  CALL      ECRB0000        * Eclipse DBS Payment Report Enquiry
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN3100  CALL      DISM0000        * Discharge Manage Details 
          BRANCH    EXIT,MAIN1000
          CALL      NXTPAG00
          GOTO      MAIN1000
.
MAIN9999  MOVE      "SERVER SHUTDOWN COMPLETE",WEBTITLE
          CALL      WEBERR00
          STOP
.
.--------------------------------------------------------------------------
. Redirect to patient demographic
.--------------------------------------------------------------------------
REDIRE00  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          PACK      VAR,NEXTPATN,SP70,SP70
          STRIP     VAR
          CLEAR     REDIRECT
          APPEND    VAR,REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          RESET     REDIRECT
          CALL      RDIREC00
.
REDIRE99  RETURN   
.------------------------------------------------------------
. Update Visit Extension file                                 * I SRF 22685
.------------------------------------------------------------
UPVEXT00  PACK      KEY8,ADMISSNO,SP10
          CALL      RDVISA1
          IF        OVRCD=1 
            MOVE    SP70,PSUBRB
            MOVE    SP10,PPOST
            MOVE    SP10,PVIDATE
            GOTO    UPVEXT10
          ENDIF
.
          PACK      KEY8,PVIURNO,SP10
          CALL      RDMAST1
          IF        OVRCD=1 
            MOVE    SP70,PSUBRB
            MOVE    SP10,PPOST
            GOTO    UPVEXT10
          ENDIF
.
UPVEXT10  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            CALL      CLRVXS00
          ENDIF
.
          MATCH     PTVIS067,Z70                     
          IF        !@EQUAL
            MOVE      PTVIS067,PMVXUDF4             
          ENDIF
.
          MATCH     SP10,PVIDATE
          IF        !@EQUAL
            MOVE      PVIDATE,PMVXVSDT
          ENDIF
          MOVE      PPOST,PMVXPOST
          MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1                                    
            CALL      RKIBPOS1                                    
            BRANCH    OVRCD,UPVEXT20
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF
.
UPVEXT20  PACK      KEY8,ADMISSNO,SP70
          CALL      RAPMVX11
          BRANCH    OVRCD,UPVEXT90
.
          CALL      UPPMVX11
          GOTO      UPVEXT99
.
UPVEXT90  MOVE      ADMISSNO,PMVXVISN
          PACK      KEY8,PMVXVISN
          CALL      WRPMVX11
          GOTO      UPVEXT99
.
UPVEXT99  RETURN
.------------------------------------------------------------
. Clear Visit Extension
.------------------------------------------------------------
CLRVXS00  MOVE      SP70,PMVXDOCA
          MOVE      SP70,PMVXDOCT
          MOVE      SP70,PMVXCSNR
          MOVE      SP70,PMVXPOST
          MOVE      SP70,PMVXPIND
          MOVE      SP70,PMVXVLOC
          MOVE      SP70,PMVXCFSG
          MOVE      SP70,PMVXINGP
          MOVE      SP70,PMVXCPTH
          MOVE      SP70,PMVXHCP1
          MOVE      SP70,PMVXHCP2
          MOVE      SP70,PMVXHCP3
          MOVE      SP70,PMVXHCP4
          MOVE      SP70,PMVXRHC1
          MOVE      SP70,PMVXRH1G
          MOVE      SP70,PMVXRH1C
          MOVE      SP70,PMVXRHC2
          MOVE      SP70,PMVXRH2G
          MOVE      SP70,PMVXRH2C
          MOVE      SP70,PMVXRHC3
          MOVE      SP70,PMVXRH3G
          MOVE      SP70,PMVXRH3C
          MOVE      SP70,PMVXRHC4
          MOVE      SP70,PMVXRH4G
          MOVE      SP70,PMVXRH4C
          MOVE      SP70,PMVXABRG
          MOVE      SP70,PMVXCADM
          MOVE      SP70,PMVXIRAD
          MOVE      SP70,PMVXIDUS
          MOVE      SP70,PMVXCRAV
          MOVE      SP70,PMVXRCCT
          MOVE      SP70,PMVXAPWD
          MOVE      SP70,PMVXAPBD
          MOVE      SP70,PMVXPOWD
          MOVE      SP70,PMVXPOBD
          MOVE      SP70,PMVXPSTY
          MOVE      SP70,PMVXVALW
          MOVE      SP70,PMVXPALW
          MOVE      SP70,PMVXINDC
          MOVE      SP70,PMVXMDAV
          MOVE      SP70,PMVXFRMS
          MOVE      SP70,PMVXCSNG
          MOVE      SP70,PMVXPWGT
          MOVE      SP70,PMVXPHGT
          MOVE      SP70,PMVXDHWR
          MOVE      SP70,PMVXEDC1
          MOVE      SP70,PMVXEDC2
          MOVE      SP70,PMVXEDC3
          MOVE      SP70,PMVXHOME
          MOVE      SP70,PMVXUDF1
          MOVE      SP70,PMVXUDF2
          MOVE      SP70,PMVXUDF3
          MOVE      SP70,PMVXUDF4
          MOVE      SP70,PMVXUDT1
          MOVE      SP70,PMVXUDT2
          MOVE      SP70,PMVXUDT3
          MOVE      SP70,PMVXUDT4
          MOVE      SP70,PMVXUDT5
          MOVE      SP70,PMVXUDT6
          MOVE      SP70,PMVXCDTE
          MOVE      SP70,PMVXCTIM
          MOVE      SP70,PMVXWEBC
          MOVE      SP70,PMVXLUPD
          MOVE      SP70,PMVXLUPT
          MOVE      SP70,PMVXWEBU
          MOVE      SP70,PMVXMHLS
          MOVE      SP70,PMVXPICD
          MOVE      SP70,PMVXRMOR
          MOVE      SP70,PMVXASUT
          MOVE      SP70,PMVXELPS
          MOVE      SP70,PMVXEMPL
          MOVE      SP70,PMVXFINP
          MOVE      SP70,PMVXOCCP
          MOVE      SP70,PMVXPALC
          MOVE      SP70,PMVXPPAL
          MOVE      SP70,PMVXELPS
          MOVE      SP70,PMVXPPPT
          MOVE      SP70,PMVXPSOS
          MOVE      SP70,PMVXPYSP
          MOVE      SP70,PMVXQLDB
          MOVE      SP70,PMVXREAD
          MOVE      SP70,PMVXUDIN
          MOVE      SP70,PMVXUREA
          MOVE      SP70,PMVXUSAC
          MOVE      SP70,PMVXUVTH
          MOVE      SP70,PMVXINTR
          MOVE      SP70,PMVXLNG1
          MOVE      SP70,PMVXASGC
          MOVE      SP70,PMVXPOEC
          MOVE      SP70,PMVXSPAR
          RETURN
.                                             * end I SRF 22685
.------------------------------------------------------------
. Update Diet Code
.------------------------------------------------------------
UPDIET00  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          MOVE      ZERO,EMERGVIS             * Not an emergency visit
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDEMVIS1
          IF        OVRCD=1
            CALL      CLEMRVIS                * Not an emergency visit
          ELSE
            MOVE      ONE,EMERGVIS            * Yes it and emegency visit
            GOTO      UPDIET10
          ENDIF
.
          MOVE      URNUMBER,KEY8             
          CALL      RLPTMAS1                  * Get PMI master file rec
          BRANCH    OVRCD,UPDIET90,UPDIET95   * Rec is either absent or locked
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,UPDIET91
.
          COMPARE   ONE,UPDATET2
          GOTO      UPDIET01 IF NOT EQUAL
.
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            PACK      DIETCODE,CTCOB001,SP70  * take diet code from catcomaf
          ENDIF
.
UPDIET01  MOVE      ADMISSNO,KEY8             
          CALL      RDMISS1                   * Get Admission file rec 
          BRANCH    OVRCD,UPDIET10            * Rec is absent
.
          MATCH     SP70,LASTDATE
          GOTO      UPDIET02 IF EQUAL
.
          COMPARE   ONE,UPDATET2
          GOTO      UPDIET02 IF NOT EQUAL
.
          IF        ASTAT = 2
            MATCH     LASTDATE,CURRDATE
            GOTO      UPDIET05 IF NOT EQUAL   * only update for current date
          ELSE
            MATCH     LASTDATE,ADATE
            GOTO      UPDIET05 IF NOT EQUAL   * only update for adm.date
          ENDIF
.
UPDIET02  MATCH     Z70,DIETCODE
          IF        !@EQUAL
            MOVE      DIETCODE,ADIET          * Update diet code on Admission
            MOVE      DIETCODE,PDIET          * Update diet code on PMI master
          ENDIF
UPDIET05  CALL      UPMISS1
          CALL      UPMAST1
          CALL      UUPTMAS1
.
.         Get the last transfer record for the admission prior to
.         sending an A08
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                  * position on admission
          CALL      RDPTRAN2                  * read previous record
          BRANCH    OVRCD,UPDIET10            * eof - shouldn't happen
.
          MATCH     AADMNO,TADMN              * same admission still ?
          GOTO      UPDIET10 IF NOT EQUAL     * no - shouldn't happen
.
.         Get the visit extension record for the admission prior to
.         sending an A08
.
          CALL      CLPMSVX1                  * clear visit ext. variables
          MOVE      AADMNO,KEY8
          CALL      RDPMVX11                  * get visit ext. record
.
.         Get the PRA record for the admission prior to sending an A08
.
          CALL      CLPATRE1                  * clear PRA variables
          MOVE      AADMNO,KEY8
          CALL      RDPTRES1                  * get PRA record
.
.         Get the discharge record for the admission prior to
.         sending an A08
.
          CALL      CLPATDSC                  * clear discharge variables
          IF        ASTAT = 3
            MOVE      AADMNO,KEY8
            CALL      RDDSCH1                 * get discharge record
          ENDIF
.
          CALL      PMIGTNID                  * get national id
          MOVE      NMPNUMB,PTNINMPI
          MOVE      ONE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                  * broadcast admission update
.
UPDIET10  PACK      KEY16,ADMISSNO,PMNUT002,SP70
          CALL      RDPMNUT1
          IF        OVRCD=1
            CALL      CLRNUT00
          ENDIF
          CALL      MVNUT000                  * Move CGIs into record vars.
.
          IF        DTCMTFLG = ONE
            MOVE      ARYCOMMT[1],PMNUCOM1
            MOVE      ARYCOMMT[2],PMNUCOM2
            MOVE      ARYCOMMT[3],PMNUCOM3
            MOVE      ARYCOMMT[4],PMNUCOM4
            MOVE      ARYCOMMT[5],PMNUCOM5
          ENDIF
.
          MATCH     Z70,DIETCODE              * Update diet code on PMI master
          IF        !@EQUAL
            MOVE      DIETCODE,PMNUDIET
          ENDIF
.
          CLOCK     TIME,CTIMEIS              * Set update timestamp and userid
          PACK      PMNUUPDU,WBSEUID,SP70     
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
.
UPDIET20  PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1                  * Is nutrition record there ?
          BRANCH    OVRCD,UPDIET25                                   
          CALL      UPPMNUT1                  * Yes - just update it       
          GOTO      UPDIET30
.
UPDIET25  MOVE      PMNUUPDU,PMNUCRTU         * No - set up create t/stamp
          MOVE      PMNUUPDD,PMNUCRTD         *      and userid
          CALL      WRPMNUT1                  *      then write record
.
UPDIET30  IF        NOCATCOM=0
            CALL      UPCAT000                * update catcomaf (extra diet)
          ENDIF
.
UPDIET50  IF        EMERGVIS=1
            MATCH     ZEROUR,EMVIURNO         * Zero U/R emergency visit
            GOTO      UPDIET70 IF EQUAL   
.
            MATCH     Z70,DIETCODE
            IF        !@EQUAL
              PACK      KEY8,URNUMBER,SP70
              CALL      RLPTMAS1
              IF        OVRCD=0
                MOVE      DIETCODE,PDIET        * Update diet code on PMI master
                CALL      UPMAST1
                CALL      UUPTMAS1
                GOTO      UPDIET70
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      URNUMBER,KEY8
          CALL      UUPTMAS1
.
UPDIET70  MATCH     "2",PWDVTYPE
          IF        @EQUAL
            CALL      WINCLS00
          ELSE
            MATCH     SP70,NEXTPATN
            IF        @EQUAL
              CALL      WINCLS00                * Refresh Parent & Close Window
            ELSE
              CALL      NXTPAT00
            ENDIF 
          ENDIF
          GOTO      UPDIET99
.
UPDIET90  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDIET99
.
UPDIET91  MOVE      "PMI Extension record missing",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDIET99
.
UPDIET95  MOVE      "Error U/R Locked",WEBTITLE
          CALL      WEBERR00
          GOTO      UPDIET99
.
UPDIET99  RETURN
+
.------------------------------------------------------------
. Update Extra Diet Details (catcomaf)
.------------------------------------------------------------
UPCAT000  MATCH     "1",PTCNUTOM
          GOTO      UPCAT999 IF NOT EQUAL
.
          MOVE      ONE,F1
          WHILE     F1 <= 5
            PACK      KEY17,ADMISSNO,LASTDATE,F1
            CALL      RDCTCOM1
            IF        OVRCD = 1
              CALL      CLCATCOM
            ENDIF
.
.davvy      CALL      MVCOM000                  * Move CGIs into record vars.
            MOVE      PMNUADMN,CTCOADMN
            MOVE      PMNUDATE,CTCODATE
            MOVE      F1,CTCOMEAL
            IF        F1=1
              CALL      MVCOB000                * Move breakfast cgis
            ENDIF
            IF        F1=3
              CALL      MVCOL000                * Move lunch cgis
            ENDIF
            IF        F1=5
              CALL      MVCOD000                * Move dinner cgis
            ENDIF
.
            PACK        KEY17,CTCOADMN,CTCODATE,CTCOMEAL,SP70
            CALL        RACTCOM1
            IF          OVRCD=1
              CALL        WRCTCOM1
            ELSE
              CALL        UPCTCOM1
            ENDIF
.
            ADD         TWO,F1
          DO
.
          CALL      PMIGTNID                  * get national id
          MOVE      NMPNUMB,PTNINMPI
          MOVE      FOUR,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                  * broadcast admission update
.
UPCAT999  RETURN
+
.------------------------------------------------------------
. Remote scripting for Status               * HPS Code Starts Here
.------------------------------------------------------------
XMLSCR00  CALL      XMLHED00
          BRANCH    EXIT,XMLSCR99
.
          PACK      KEY17,ADMISSNO,SERVDAT1,SHIFTNUM,SP70
          CALL      RDPMPDP1
          IF        OVRCD = 1
            CALL      CLRPDP00              * Clear Patient Dependency Filevar
            CALL      MOVPDP00
            IF        PMPDSCOR<>0
              CALL      WRPMPDP1
            ENDIF
          ELSE
            CALL      MOVPDP00
            IF        PMPDSCOR=0
              CALL      DEPMPDP1
            ELSE
              CALL      UPPMPDP1
            ENDIF
          ENDIF
.
          GOTO      XMLSCR80
.
XMLSCR80  MOVE      PMPDSCOR,DIM3
          MATCH     "  0",DIM3
          IF        @EQUAL
            MOVE      SP70,DIM3
          ENDIF
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                            DIM3:
                             "</RETURN_VALUE>";
          GOTO      XMLSCR95     
.
XMLSCR95  CALL      XMLEND00
.
XMLSCR99  RETURN
.--------------------------------------------------------------------------
. Clear file variables of Patient dependency File
.--------------------------------------------------------------------------
CLRPDP00  MOVE      SP70,PMPDADMN
          MOVE      SP70,PMPDDATE
          MOVE      SP70,PMPDSHIF
          MOVE      SP70,PMPDWARD
          MOVE      ZERO,PMPDSCOR
          MOVE      SP70,PMPDCATE
          MOVE      SP70,PMPDCLOS
CLRPDP99  RETURN
.--------------------------------------------------------------------------
. Clear file variables of Patient Nutrition File
.--------------------------------------------------------------------------
CLRNUT00  MOVE      SP70,PMNUADMN
          MOVE      SP70,PMNUDATE
          MOVE      SP70,PMNUCRTD
          MOVE      SP70,PMNUUPDD
          MOVE      SP70,PMNUCRTU
          MOVE      SP70,PMNUUPDU
          MOVE      SP70,PMNUDTYP
          MOVE      SP70,PMNUWARD
          MOVE      SP70,PMNUSIZE
          MOVE      SP70,PMNUDCDE
          MOVE      SP70,PMNUPAGN
          MOVE      SP70,PMNUALVL
          MOVE      SP70,PMNUFLUI
          MOVE      SP70,PMNUTEAT
          MOVE      SP70,PMNUADTV
          MOVE      SP70,PMNUVOLU
          MOVE      SP70,PMNUML01
          MOVE      SP70,PMNUML02
          MOVE      SP70,PMNUML03
          MOVE      SP70,PMNUML04
          MOVE      SP70,PMNUML05
          MOVE      SP70,PMNUML06
          MOVE      SP70,PMNUML07
          MOVE      SP70,PMNUML08
          MOVE      SP70,PMNUML09
          MOVE      SP70,PMNUML10
          MOVE      SP70,PMNUSTAT
          MOVE      SP70,PMNUBELT
          MOVE      SP70,PMNUMTYP
          MOVE      SP70,PMNUPRNT
          MOVE      SP70,PMNUCOM1
          MOVE      SP70,PMNUCOM2
          MOVE      SP70,PMNUCOM3
          MOVE      SP70,PMNUCOM4
          MOVE      SP70,PMNUCOM5
          MOVE      SP70,PMNUUDF1
          MOVE      SP70,PMNUUDF2
          MOVE      SP70,PMNUUDF3
          MOVE      SP70,PMNUUDF4
          MOVE      SP70,PMNUUDF5
          MOVE      SP70,PMNUFAST
          MOVE      SP70,PMNUBSUP
          MOVE      SP70,PMNUMSUP
          MOVE      SP70,PMNULSUP
          MOVE      SP70,PMNUASUP
          MOVE      SP70,PMNUDSUP
          MOVE      SP70,PMNUSSUP
          MOVE      SP70,PMNUDIET
CLRNUT99  RETURN
.------------------------------------------------------------------------
. Move file variables to Patient Dependency File
.------------------------------------------------------------------------
MOVPDP00  MOVE      PMSPD001,F3
          MOVELPTR  PMSPD001,F2
.
          IF        F3=0 & F2>1 
            GOTO      MOVPDP20
          ENDIF
.
          IF        F3 >= 0 & F3 <= 24
            MOVE      ONE,PMSPD002
          ENDIF
          IF        F3 >= 25 & F3 <= 48
            MOVE      TWO,PMSPD002
          ENDIF
          IF        F3 >= 49 & F3 <= 120
            MOVE      THREE,PMSPD002
          ENDIF
          IF        F3 >= 121 & F3 <= 223
            MOVE      FOUR,PMSPD002
          ENDIF
          IF        F3 >= 224
            MOVE      FIVE,PMSPD002
          ENDIF
.
MOVPDP10  MOVE      ADMISSNO,PMPDADMN
          MOVE      SERVDAT1,PMPDDATE
          MOVE      SHIFTNUM,PMPDSHIF
          MOVE      WARDCODE,PMPDWARD
          MOVE      PMSPD001,PMPDSCOR
          MOVE      PMSPD002,PMPDCATE
          GOTO      MOVPDP99
.
MOVPDP20  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                            PMPDSCOR:
                             "</RETURN_VALUE>";
          GOTO      MOVPDP99     
.
MOVPDP99  RETURN
.------------------------------------------------------------
. Find the next patient in the ward
.------------------------------------------------------------
NXTPAT00  MATCH     "1",NEXTPATF            * HPS Code Starts Here
          IF        @EQUAL
            CALL      NXTEVT00
            BRANCH    EXIT,NXTPAT90
            GOTO      NXTPAT85
          ENDIF                             * HPS Code Ends Here
.
.         V9.02.18 - change this code to be consistent with the way ward/bed
.                    displays.  ie. NoBeds first, then WardBeds, then On leave
.                    So first see if current patient is in no bed file.       
.
          MOVE      SP70,SAVEWARD
NXTPAT10  PACK      KEY13,ADMISSNO,SP70         * Set admission as key
          CALL      RDSNOBE3                    * Position on file
          CALL      RDKNOBE3                    * Get next record
          BRANCH    OVRCD,NXTPAT20              * If EOF, go to Ward file  
          MATCH     ADMISSNO,DNBADMNO           * Check patient admission no.
          GOTO      NXTPAT20 IF NOT EQUAL       * No, try the ward file.        
.
          PACK      KEY13,NBWARD,DNBADMNO,DNBPLUR
          CALL      RDSNOBE1                    * Get patient on Index 1
.
NXTPAT15  CALL      RDKNOBE1                    * Get next patient 
          BRANCH    OVRCD,NXTPAT19              * - no more no bed recs
          MATCH     AWARD,NBWARD                * - still correct ward ?
          GOTO      NXTPAT19 IF NOT EQUAL       
.
          MATCH     ZEROVISN,NBADMNO            * - non-zero admission ?
          GOTO      NXTPAT15 IF EQUAL
.
          MOVE      NBADMNO,ADMISSNO            * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT19  PACK      KEY6,AWARD,SP70             * Set key to start of ward
          CALL      RDSWARD1                    * position on file 
          MOVE      AWARD,SAVEWARD
          GOTO      NXTPAT35                    * go get first rec this ward
.
NXTPAT20  PACK      KEY14,ADMISSNO,SP70         * Is patient in ward file
          CALL      RDSWARD2
          CALL      RDKWARD2 
          BRANCH    OVRCD,NXTPAT30              * If EOF, try Ward Standby      
          MATCH     ADMISSNO,DWADMNO
          GOTO      NXTPAT30 IF NOT EQUAL
.
          PACK      KEY6,WWARD,WBED,SP70        * Set key up       
          CALL      RDSWARD1                    * - position on Index 1
          MOVE      WWARD,SAVEWARD
          GOTO      NXTPAT45 
.
NXTPAT30  PACK      KEY14,ADMISSNO,SP70         * Is patient in ward (standby)
          CALL      RDSWARD4
          CALL      RDKWARD4 
          BRANCH    OVRCD,NXTPAT50              * If EOF, try On-Leave file
          MATCH     ADMISSNO,DWSTBY  
          GOTO      NXTPAT50 IF NOT EQUAL
.
          PACK      KEY6,WWARD,WBED,SP70        
          CALL      RDSWARD1                    * Get crnt patient on Index 1
          MOVE      WWARD,SAVEWARD
.
NXTPAT35  CALL      RDKWARD1                    * Get next bed in ward.      
          BRANCH    OVRCD,NXTPAT49              * - no more no bed recs
          MATCH     SAVEWARD,WWARD              * - still correct ward ?
          GOTO      NXTPAT49 IF NOT EQUAL       
          MATCH     SP3,WBED                    * - ignore ward header   
          GOTO      NXTPAT35 IF EQUAL       
.
NXTPAT40  MATCH     ZEROVISN,WADMNO             * First check main admno
          GOTO      NXTPAT45 IF EQUAL           * - no good - try standby
          MOVE      DWADMNO,ADMISSNO            * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT45  MATCH     ZEROVISN,WSTBY              * Now check standby admno
          GOTO      NXTPAT35 IF EQUAL           * - no good, try next bed
          MOVE      DWSTBY,ADMISSNO             * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT49  PACK      KEY14,AWARD,SP70            * Set key to start of ward
          CALL      RDSONLV1                    * position on On-leave file
          GOTO      NXTPAT55
.
NXTPAT50  PACK      KEY14,ADMISSNO,SP70         * Is patient On-leave        
          CALL      RDSONLV2
          CALL      RDKONLV2 
          BRANCH    OVRCD,NXTPAT90              * If EOF, no more pats (close)  
          MATCH     ADMISSNO,DOADMNO
          GOTO      NXTPAT90 IF NOT EQUAL
          MATCH     AWARD,OWARD                 * - correct ward ?
          GOTO      NXTPAT90 IF NOT EQUAL
.
          PACK      KEY14,OWARD,OBED,DOADMNO     
          CALL      RDSONLV1                    * Get patient on Index 1
.
NXTPAT55  CALL      RDKONLV1                    * Get next patient 
          BRANCH    OVRCD,NXTPAT90              * - no more no bed recs
          MATCH     AWARD,OWARD                 * - still correct ward ?
          GOTO      NXTPAT90 IF NOT EQUAL       
          MATCH     ZEROVISN,OADMNO             * - non-zero admission ?
          GOTO      NXTPAT55 IF EQUAL
          MOVE      DOADMNO,ADMISSNO            * Upd admission to new patient
          GOTO      NXTPAT80
.
NXTPAT80  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,NXTPAT90
.
          MATCH     "1",NEXTPATM          
          IF        @EQUAL
            BRANCH    ASTAT,NXTPAT95,NXTPAT83,NXTPAT95,NXTPAT83,NXTPAT95
          ENDIF
.
NXTPAT83  MOVE      AURNO,URNUMBER
.
NXTPAT85  REP       " +",URNUMBER
          REP       " +",ADMISSNO
          PACK      VAR,NEXTPATN,SP70,SP70 
          STRIP     VAR
          CLEAR     REDIRECT
          APPEND    VAR,REDIRECT
          APPEND    "&urnumber=",REDIRECT
          APPEND    URNUMBER,REDIRECT
          APPEND    "&admissno=",REDIRECT
          APPEND    ADMISSNO,REDIRECT
          RESET     REDIRECT
          CALL      RDIREC00
          GOTO      NXTPAT99
.
NXTPAT90  CALL      WINCLS00
          GOTO      NXTPAT99
.
NXTPAT95  MOVE      "ADMISSION IS NOT CURRENT",WEBTITLE
          CALL      WINCLE00
          GOTO      NXTPAT99
.
NXTPAT99  RETURN
.------------------------------------------------------------
.    Next Event                             * HPS Code Starts Here
.------------------------------------------------------------
NXTEVT00  MOVE      ZERO,EXIT
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMEVT1
          BRANCH    OVRCD,NXTEVT99
.
          MOVE      PMEVPWRD,PATNLOCN
.
          PACK      KEY14,PMEVPWRD,PMEVPBED,PMEVVISN,SP70
          CALL      RSPMEVT5
NXTEVT10  CALL      RKPMEVT5
          BRANCH    OVRCD,NXTEVT98
.
          MATCH     PATNLOCN,PMEVPWRD
          IF        @EQUAL
            MATCH     SP70,PMEVDDTE
            GOTO      NXTEVT10 IF NOT EQUAL
            MOVE      PMEVVISN,ADMISSNO
            PACK      KEY8,ADMISSNO
            CALL      RDVISA1
            BRANCH    OVRCD,NXTEVT99
            MOVE      PVIURNO,URNUMBER
          ELSE
            GOTO      NXTEVT10
          ENDIF
.
          GOTO      NXTEVT99
.
NXTEVT98  MOVE      ONE,EXIT
.
NXTEVT99  RETURN
.                                           * HPS Code Ends Here
.------------------------------------------------------------
. Open Files and Initialize Variables
.------------------------------------------------------------
INIT0000  CALL      INTMAS00  
          CALL      GETTZ000
          OPEN      BOKRC1A7,"bokrc1af"
          OPEN      BOKRC1A1,"bokrc1af"
          OPEN      BOKRC1A4,"bokrc1af"
          OPEN      FMSCSAA1,"fmscsaaf"
          OPEN      FMSLMAA1,"fmslmaaf"
          OPEN      IBALPCA1,"ibalpcaf"
          OPEN      IBAPDFA1,"ibapdfaf"
          OPEN      IBAPOST1,"ibapostf"
          OPEN      ALLREFA2,"allrefaf"
.
          OPEN      OBSDETA1,"obsdetaf" * Ward Map
.
          OPEN      PATASFA1,"patasfaf"
          OPEN      PATBRDA1,"patbrdaf"
          OPEN      PATBRDA2,"patbrdaf"
          OPEN      PATBRDA3,"patbrdaf"
          OPEN      PATBRDA4,"patbrdaf"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A2,"patmi1af"
          OPEN      PATMI1A3,"patmi1af"
          OPEN      PATMI1A6,"patmi1af"
          OPEN      PATMI1A8,"patmi1af"
          OPEN      PATWR1A1,"patwr1af"
          OPEN      PATWR1A2,"patwr1af"
          OPEN      PATWR1A7,"patwr1af"
          OPEN      PATWR1A8,"patwr1af"
          OPEN      BOKDIAA1,"bokdiaaf"
          OPEN      BOKRX1A1,"bokrx1af"
          OPEN      OPRDETA2,"oprdetaf" 
          OPEN      OPRSESA1,"oprsesaf"                               *I-174468
          OPEN      OPRARDA1,"oprardaf"
          OPEN      OPRSRGA1,"oprsrgaf"
          OPEN      OPROPRA1,"opropraf"
          OPEN      OPRSEMA1,"oprsemaf"                               *I-174468
          OPEN      PATBMDA1,"patbmdaf"
          OPEN      PATBMDA2,"patbmdaf"
          OPEN      PATBMDA3,"patbmdaf"
          OPEN      PATBMDA4,"patbmdaf"
          OPEN      PATDADA1,"patdadaf"
          OPEN      PATDGWA1,"patdgwaf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
          OPEN      PATDSCH3,"patdschf"
          OPEN      PATDTRA1,"patdtraf"
          OPEN      PATDTRA5,"patdtraf"
          OPEN      PRIDTRA1,"pridtraf"
          OPEN      PRIDTRA4,"pridtraf"
          OPEN      PRIHDBT2,"prihdbtf"
          OPEN      PRIHREF1,"prihreff"
          OPEN      PATHSPA1,"pathspaf"
          OPEN      PATHFRE1,"pathfrec"
          OPEN      PATTRAN1,"pattranf"
          OPEN      PATTRAN2,"pattranf"
          OPEN      PATTRAN4,"pattranf"
          OPEN      VISMDTA1,"vismdtaf"
          OPEN      VISMTXA1,"vismtxaf"
          OPEN      PATCODE1,"patcodes"
          OPEN      PATCODE2,"patcodes"
          OPEN      PATFX1A1,"patfx1af"
          OPEN      PATONLV1,"patonlvf"
          OPEN      PATONLV2,"patonlvf"
          OPEN      PATINVR1,"patinvrf"
          OPEN      PATITEM1,"patitemn"
          OPEN      PATLOCA1,"patlocaf"
          OPEN      PATNOBE1,"patnobef"
          OPEN      PATNOBE3,"patnobef"
          OPEN      PATRE1A1,"patre1af"
          OPEN      PATREMD1,"patremdf"
          OPEN      PATRGMA1,"patrgmaf"
          OPEN      PMSBDCA1,"pmsbdcaf"
          OPEN      PMSCEXA1,"pmscexaf"
          OPEN      PMSRELA1,"pmsrelaf"
          OPEN      PMSTLEA1,"pmstleaf"          * open Patient Titles table
          OPEN      PMSTLEA2,"pmstleaf"
          OPEN      PMSBRQA3,"pmsbrqaf"
          OPEN      PMSBRQA4,"pmsbrqaf"
          OPEN      PMSDTCA1,"pmsdtcaf"
          OPEN      PMSREGA1,"pmsregaf"
          OPEN      MRTLOCA1,"mrtlocaf"
          OPEN      MLTSECA1,"mltsecaf"
          OPEN      PATPARA1,"patparaf"
          OPEN      PMSEADA1,"pmseadaf"
          OPEN      PMSEAHA2,"pmseahaf"
          OPEN      PMSEBHA1,"pmsebhaf"
          OPEN      PMSEBHA2,"pmsebhaf"
          OPEN      PMSERDA1,"pmserdaf"
          OPEN      PMSERHA1,"pmserhaf"
          OPEN      PMSERHA2,"pmserhaf"
          OPEN      PMSERHA3,"pmserhaf"
          OPEN      PMSECAA1,"pmsecaaf"
          OPEN      PMSECAA2,"pmsecaaf"
          OPEN      PMSECAA3,"pmsecaaf"
          OPEN      PMSECOA1,"pmsecoaf"
          OPEN      PMSETRA1,"pmsetraf"
          OPEN      PMSECTA1,"pmsectaf"
          OPEN      PMSECTA2,"pmsectaf"
          OPEN      PMSECTA3,"pmsectaf"
          OPEN      PMSECTA4,"pmsectaf"
          OPEN      PMSECTA5,"pmsectaf"
          OPEN      PMSECTA6,"pmsectaf"
          OPEN      PRIINVO1,"priinvof"
          OPEN      PRIPRAC1,"pripracf"
          OPEN      PMSESHA1,"pmseshaf"
          OPEN      PMSESDA1,"pmsesdaf"
          OPEN      PMSEVTA1,"pmsevtaf" 
          OPEN      PMSEVTA2,"pmsevtaf"
          OPEN      PMSEVTA3,"pmsevtaf"
          OPEN      PMSEVTA5,"pmsevtaf" 
          OPEN      PMSMSWA1,"pmsmswaf"
          OPEN      PMSPDPA1,"pmspdpaf"     * HPS Code Ends Here
          OPEN      PMSPDPA2,"pmspdpaf"
          OPEN      PMSVX1A1,"pmsvx1af"     * V9.02.05 Open Visit xtension file
          OPEN      PMSNUTA1,"pmsnutaf"     * new nutrition file v9.02.08
          OPEN      PMSHCPA1,"pmshcpaf"     * HCP reference file v9.02.09
          OPEN      PMSHCPA3,"pmshcpaf"
          OPEN      PMSRCBA2,"pmsrcbaf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PMSWORA1,"pmsworaf"
          OPEN      PMSWORA2,"pmsworaf"
          OPEN      PATVADA1,"patvadaf"
          OPEN      PATVENA1,"patvenaf"
          OPEN      RCPBDTA1,"rcpbdtaf"
          OPEN      RCPDTEA1,"rcpdteaf"
          OPEN      RCPDTEA6,"rcpdteaf"
          OPEN      RCPDTEA3,"rcpdteaf"
          OPEN      RCPREGA1,"rcpregaf"
          OPEN      RCPBNKA1,"rcpbnkaf"
          OPEN      EMRVISA1,"emrvisaf"
          OPEN      EMRVISA3,"emrvisaf"
          OPEN      WEBSECA3,"websecaf"
          OPEN      PATUREA1,"patureaf"
          OPEN      VISCMTA1,"viscmtaf"
          OPEN      PATNURS1,"patnursm"
          OPEN      PMSCURA2,"pmscuraf"
          OPEN      PMSCURA6,"pmscuraf"
          OPEN      VISXDCA1,"visxdcaf"
.
          MOVE      ZERO,NOCATCOM
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CATCOMA1,"catcomaf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,NOCATCOM
          ENDIF
.
          OPEN      CONTROLF,"controlf"                   * I CAR 48029
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS        * HDP State Par.C-48209
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TWENTY1;*45,PTCNDRSM                     *I-140164
          READ      CONTROLF,HUND13;*67,OPCNTHED
          READ      CONTROLF,THIRTY6;*86,HSYS1

          READ      CONTROLF,HUND20;*172,PTCNHLEA
          READ      CONTROLF,HUND28;*226,PTCNNMPR
.
          IF        IBCNMHOS=1
            OPEN      MLTCODA1,"mltcodaf"
            OPEN      MLTCODA2,"mltcodaf"
          ENDIF
.
          READ      CONTROLF,HUND12;*104,PTCNWBDS,*107,PTCNBMAN,*114,PTCNDOST:
                                    *116,PTCNDOET
          MOVE      PTCNWBDS,WBEDDESC            * CAR 151896
          READ      CONTROLF,HUND14;*81,PTCNDONP
          READ      CONTROLF,TEN;*244,CHOSPNUM
          READ      CONTROLF,THIRTY6;*229,RCCNERRE,*232,RCCNERCD,*239,RCCNERRS
          READ      CONTROLF,HUND08;*81,RCCNERCA
          READ      CONTROLF,HUND20;*132,PTCNUNDW,*137,PTCNHEFR:
                                    *142,PTCNHETO,*147,PTCNOVRW,*152,PTCNOBES:
                                    *159,PTCNDFAL
          READ      CONTROLF,HUND23;*209,PTCNUTOM,*210,PTCNUESD
          READ      CONTROLF,TEN3;*194,CVETINS
          READ      CONTROLF,TEN9;*212,CFEETYP
          READ      CONTROLF,HUND24;*111,PTCNUIMC
          READ      CONTROLF,HUND25;*173,PTCNBTRE,*174,PTCNBTOD     *C-0837181 
          READ      CONTROLF,HUND27;*122,PTCNUEBB
.
          READ      CONTROLF,HUND10;*249,PTCNDAUR                   
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,TEMPFILE
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,PMHFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,WDIFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,CLNFILNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,WORCOMNM
.
          CALL      TFILENAM                * Get temp file name
          MOVE      TFILNAME,HISCOMNM
.
          CALL      TFILENAM
          MOVE      TFILNAME,COMFILND
.
          MOVE      ZERO,NOATTRIB
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PATATRA1,"patatraf"
          OPEN      PATATRA2,"patatraf"
          OPEN      PATATRA3,"patatraf"
          TRAPCLR   IO
          IF        OVRCD=1
            MOVE      ONE,NOATTRIB
          ENDIF
.
          OPEN      IBATMHA1,"ibatmhaf"
          OPEN      PATELGA1,"patelgaf"
.
          MATCH     "1",PTCNUIMC
          IF        @EQUAL
            OPEN      PRIEADA1,"prieadaf"
            OPEN      PRIEAHA2,"prieahaf"
            OPEN      PRIIBHA1,"priibhaf"
            OPEN      PRIIBHA2,"priibhaf"
            OPEN      PRIECAA1,"priecaaf"
            OPEN      PRIECAA2,"priecaaf"
            OPEN      PRIECAA3,"priecaaf"
            OPEN      PRIECTA1,"priectaf"
            OPEN      PRIECTA2,"priectaf"
            OPEN      PRIECTA3,"priectaf"
            OPEN      PRIECTA5,"priectaf"
            OPEN      PRIECTA6,"priectaf"
            OPEN      PRIESHA1,"prieshaf"
            OPEN      PRIESDA1,"priesdaf"
          ENDIF
. 
          MATCH     "1",PTCNUEBB
          IF        @EQUAL
            OPEN      OUTECAA1,"outecaaf"
            OPEN      OUTECAA2,"outecaaf"
            OPEN      OUTECAA3,"outecaaf"
            OPEN      OUTECTA1,"outectaf"
            OPEN      OUTECTA2,"outectaf"
            OPEN      OUTECTA3,"outectaf"
            OPEN      OUTECTA4,"outectaf"
            OPEN      OUTECTA5,"outectaf"
            OPEN      OUTECTA6,"outectaf"
            OPEN      OUTERHA1,"outerhaf"
            OPEN      OUTEAHA1,"outeahaf"
            OPEN      OUTEAHA2,"outeahaf"
            OPEN      OUTERHA2,"outerhaf"
            OPEN      OUTERHA3,"outerhaf"
            OPEN      OUTERHA4,"outerhaf"
            OPEN      OUTERDA1,"outerdaf"
            OPEN      OUTERDA2,"outerdaf"
            OPEN      OUTERDA3,"outerdaf"
          ENDIF
.
INIT9999  RETURN
.------------------------------------------------------------
. Get Time Zone
.------------------------------------------------------------
GETTZ000  MOVE      ZERO,OVRCD
          MOVE      "+0000",KEY5
          TRAP      OVERCOND IF IO
          OPEN      TZFILE,"timezone"
          TRAPCLR   IO
          IF        OVRCD=0
            READ      TZFILE,SEQ;KEY5
          ELSE
            EXECUTE   "date +#"%z#">timezone.txt",TASKID
            TRAP      OVERCOND IF IO
            OPEN      TZFILE,"timezone"
            TRAPCLR   IO
            IF        OVRCD=0
              READ      TZFILE,SEQ;KEY5
            ENDIF
          ENDIF
          CLOSE     TZFILE
          UNPACK    KEY5,KEY3,KEY2
          PACK      TIMEZONE,KEY3,COLON,KEY2
          RETURN
.------------------------------------------------------------
. Clear Parameters
.------------------------------------------------------------
CLRPAR00  MOVE      ZERO,REPORTNO
          PACK      REDIRECT,SP70,SP70,SP70,SP70
          MOVE      SP70,TEMPLATE
          MOVE      SP70,UPDATETY
          MOVE      ZERO,UPDATET2
          MOVE      SP70,REDIRECT
          MOVE      SP70,NEXTPATN
          MOVE      SP70,NEXTPATM
          MOVE      SP70,FROMPATN
          MOVE      SP70,WARDCODE
          MOVE      SP70,OUTLTYPE
          MOVE      SP70,PWDVTYPE
          MOVE      ZERO,CLOSEDEP
          MOVE      ZERO,VIEWONLY
          MOVE      ZERO,SHOWFLAG
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          MOVE      SP70,VIEWTYPE
          MOVE      SP70,DIETNCDE
          MOVE      SP70,DIETTYPE
          MOVE      SP70,DOCTCODE
          MOVE      ZERO,BULKDSCH
          MOVE      ZERO,KIDSONLY
          MOVE      ZERO,KIDSVEW2
          MOVE      ZERO,ALTVIEW1
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW                                    *Car 262343
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,HEAONLY
          MOVE      ZERO,CABONLY
          MOVE      ZERO,PRNTLABL
          MOVE      SP70,FRSTDATE
          MOVE      SP70,HOSPCODE 
          MOVE      ZERO,ALLHFLAG
          MOVE      ZERO,UPWORKDG
          MOVE      SP70,PARTCODE
          MOVE      SP70,FUNDTRID
          MOVE      SP70,REMITADV
          MOVE      SP70,REMITKEY
          MOVE      SP70,PAYMTKEY
          MOVE      SP70,SELPRINT 
          MOVE      SP70,PARTNUMB
          MOVE      SP70,PROCSTAT
          MOVE      SP70,BTSCHOSP
          MOVE      SP70,NEXTPAGE
          MOVE      SP70,MAVBATCH
          MOVE      SP70,MAVINVCE
          MOVE      SP70,CLMUNIID
          MOVE      SP70,PAYRUNNO
          MOVE      SP70,PAYRUNDT
          MOVE      SP70,REPRETKY
          MOVE      SP70,PROVNUMB
          MOVE      SP70,ECCLFBID
          MOVE      SP70,ECCLARID
          MOVE      SP70,ECCLFRID
          MOVE      SP70,ECCLRPTC
          MOVE      SP70,ECCLSCOD
          MOVE      SP70,ECCLSRVC
          MOVE      SP70,ECOTFUND
          MOVE      SP70,ECOTTYPE
          MOVE      SP70,ECOTTRID
          MOVE      SP70,FUNDTRID
          MOVE      SP70,ECREPYPN
          MOVE      SP70,ECREPRUN
          MOVE      SP70,ECREPDAT
          MOVE      SP70,ECRERKEY
.         MOVE      SP70,ECRECLID
.         MOVE      SP70,ECREPYRN
.         MOVE      SP70,ECREPYRD
.         MOVE      SP70,ECRERRKY
          MOVE      SP70,ECREADVC
          MOVE      SP70,ECREPTNO
          MOVE      SP70,ECRETRID
          MOVE      SP70,ECRECLAM
          MOVE      SP70,FILTURNO
          MOVE      SP70,FILTADMN
          MOVE      ZERO,STARTNUM
          MOVE      ZERO,NORECORD
          MOVE      ZERO,EXDTBLNK
          MOVE      SP70,INVNUMBR
          MOVE      SP70,CLAIMSTA
          MOVE      ZERO,VALDTYPE
          MOVE      SP70,BATCHNUM
          MOVE      ZERO,EXCLCLOS
          MOVE      ZERO,EXCLWAIT
          MOVE      SP70,HLFDCLTY
          MOVE      SP70,HLTHFUND
          MOVE      SP70,LASTDATE
          MOVE      ZERO,LASTITEM
          MOVE      ZERO,LASTITM2
          MOVE      ZERO,LASTITM3
          MOVE      SP70,VYEARMTH
          MOVE      SP70,PATCONCD
          MOVE      SP70,PATCONDS
          MOVE      SP70,PATCONVA
          MOVE      SP70,PATCONPA
          MOVE      SP70,PATCONAM
          MOVE      Z70,PATCONTL
          MOVE      SP70,PTDSC002
          MOVE      SP70,PTDSC005
          MOVE      SP70,PTDSC006
          MOVE      SP70,DISWAFIL
          MOVE      Z70,DIETCODE
          MOVE      SP70,OPTIONZ
          MOVE      SP70,DOSASTAT
          MOVE      ZERO,WBEDTYPE
          MOVE      SP70,SERVDATE           * HPS Code Starts Here
          MOVE      SP70,SERVDAT1
          MOVE      SP70,PMSPD001
          MOVE      SP70,PMSPD002
          MOVE      SP70,NEXTPATF
          MOVE      SP70,SHIFTNUM           * HPS Code Ends Here
          MOVE      Z70,PTVIS067            * I SRF 22685
          MOVE      SP70,DEFTFLAG
          MOVE      SP70,FILTDPST
          MOVE      SP70,FILTCLAI
          MOVE      SP70,FILTEXPD
          MOVE      ZERO,FILTEXDY
          MOVE      SP70,CALCEXLS
          CALL      CLPNUT00                * Clear Nutrition CGIs v9.02.08
          CALL      CPPMWO00                * Working diagnosis file
          CALL      CPVXTF00
          MOVE      ZERO,PTKEYCNT
          MOVE      Z70,PTMIS038
          MOVE      SP70,PTMIS039
          MOVE      Z70,PTMIS040
          MOVE      Z70,PTMIS041
          MOVE      Z70,PTMIS042
          MOVE      Z70,PTMIS043
          MOVE      Z70,PTMIS044
          MOVE      ZERO,STVCVIEW
          MOVE      ZERO,DEFTVIEW
          MOVE      SP70,SAVCLASS
          MOVE      ZERO,TOGGLEXP
          MOVE      ZERO,NUMBREXP
.
          MOVE      ZERO,WORCOMFL
          MOVE      ZERO,HISCOMFL
          MOVE      ZERO,WORKFLAG
          MOVE      ZERO,LEAVFLAG
          MOVE      ZERO,MHLSFLAG
          MOVE      ZERO,SKIPDIET
.
          MOVE      Z70,LABPRT01
          MOVE      Z70,LABPRT02
          MOVE      Z70,LABPRT03
          MOVE      Z70,LABPRT04
          MOVE      Z70,LABPNO01
          MOVE      Z70,LABPNO02
          MOVE      Z70,LABPNO03
          MOVE      Z70,LABPNO04
          MOVE      Z70,LABPSL01
          MOVE      Z70,LABPSL02
          MOVE      Z70,LABPSL03
          MOVE      Z70,LABPSL04
          MOVE      ZERO,EMPTONLY
          MOVE      ZERO,DISCATDD
          MOVE      SP70,PTRGM001
          MOVE      SP70,PTRGM002
          MOVE      SP70,PTRGM003
          MOVE      SP70,MULTLT01
          MOVE      SP70,DEBDINDC
          MOVE      ZERO,EXTRDIET
          MOVE      ZERO,DISPUDF4
.
          PACK      USERDF01,SP70,SP70
          PACK      USERDF02,SP70,SP70
          PACK      USERDF03,SP70,SP70
          PACK      USERDF04,SP70,SP70
          PACK      USERDF05,SP70,SP70
          PACK      USERDF06,SP70,SP70
          PACK      USERDF07,SP70,SP70
          PACK      USERDF08,SP70,SP70
          PACK      USERDF09,SP70,SP70
          PACK      USERDF10,SP70,SP70
.
          MOVE      ZERO,DISPDNAM      * Display duplicate surname icons
          MOVE      ZERO,ONLVFLAG
          MOVE      ZERO,MEHLSFLG
          MOVE      ZERO,DISPTHET
          MOVE      ZERO,DISPMV
          MOVE      ZERO,MVFLAG
.
          MOVE      ZERO,FORMTYPE
          MOVE      SP70,FRMCOD01
          MOVE      SP70,FRMCOD02
          MOVE      SP70,FRMCOD03
          MOVE      SP70,FRMPNO01
          MOVE      SP70,FRMPNO02
          MOVE      SP70,FRMPNO03
          MOVE      SP70,FRMPRT01
          MOVE      SP70,FRMPRT02
          MOVE      SP70,FRMPRT03
          MOVE      SP70,FRMPSL01
          MOVE      SP70,FRMPSL02
          MOVE      SP70,FRMPSL03
.
          MOVE      ONE,F3
          WHILE     F3 <= 100
            MOVE      SP70,BPRNT[F3]
            MOVE      SP70,BADMN[F3]
            ADD       ONE,F3
          DO
.
          CALL      CLCTCM00           * Clear Menus Table CGIs
.
          MOVE      SP70,ATCODVAL
          MOVE      Z70,ATWDIAFN       * Working Diagnosis notes filename
          MOVE      Z70,ATMHISFN       * Relevant Medical History notes filename
          MOVE      Z70,ATBDISFN       * Barriers to Discharge notes filename
.
          MOVE      SP70,PATATURN
          MOVE      SP70,PATATVIS
          MOVE      SP70,PATATNOT
          PACK      ATTRNOTE,SP70,SP70,SP70,SP70
.
          MOVE      ZERO,WDBDSRCH
          MOVE      ZERO,FHRSUBIN
          MOVE      ZERO,FHRLOCIN
          MOVE      ZERO,FHRPARIN
.
          CALL      IALR0000            * Initialize Alert Code array
          MOVE      SP70,FILTHOSP
          MOVE      ZERO,DEFTALLH
.
          MOVE      SP70,PAYEEPNO
          MOVE      SP70,PAYMTRUN
          MOVE      SP70,PAYMRUND
          MOVE      SP70,RETRVKEY
          MOVE      ZERO,DTCMTFLG
          MOVE      ZERO,SHWPHOTO
          MOVE      ZERO,PTSTATUS
          MOVE      Z70,MRFDDATE
.
          CALL      CLRVXD00            * clear cgi visxdcaf         
.
CLRPAR99  RETURN
+
.------------------------------------------------------------
. Set Parameters
.------------------------------------------------------------
SETPAR00  MATCH     "reportno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPORTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "template=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TEMPLATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatety=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATETY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "updatet2=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPDATET2
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dietncde=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIETNCDE                                         
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "outltype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,OUTLTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pwdvtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PWDVTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "closedep=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLOSEDEP                                         
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "redirect=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REDIRECT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpatn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPATN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpatm=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPATM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frompatn=",QRYNAME
          IF        @EQUAL
          MOVE      QRYDATA,FROMPATN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "upworkdg=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,UPWORKDG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dietcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIETCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptvis067=",QRYNAME            * I SRF 22685
          IF        @EQUAL
            MOVE      QRYDATA,PTVIS067             * Populate CGI parameter
            GOTO      SETPAR99                     * with diet comment
          ENDIF
.
                                                   * end I SRF 22685
          MATCH     "pmsvx052",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,PMSVX052
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx053",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,PMSVX053
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx054",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,PMSVX054
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmsvx055",QRYNAME
          IF        @EQUAL
            MOVE    QRYDATA,PMSVX055
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "urnumber=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,URNUMBER
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "admissno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ADMISSNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wardcode=",QRYNAME
          IF        @EQUAL
            PACK      WARDCODE,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "inplabar=",QRYNAME
          IF        @EQUAL
            COMPARE   "99",PTKEYCNT
            GOTO      SETPAR99 IF EQUAL
            ADD       ONE,PTKEYCNT
            PACK      INPLABAR[PTKEYCNT],QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ctcob",QRYNAME
          IF        @EQUAL
            CALL      SCCOB000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ctcol",QRYNAME
          IF        @EQUAL
            CALL      SCCOL000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ctcod",QRYNAME
          IF        @EQUAL
            CALL      SCCOD000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ctcom",QRYNAME
          IF        @EQUAL
            CALL      SCCOM000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmnut",QRYNAME
          IF        @EQUAL
            CALL      SPNUT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "viewtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VIEWTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "doctcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DOCTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "frstdate=",QRYNAME 
          IF        @EQUAL
            MOVE      QRYDATA,FRSTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "lastdate=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,LASTDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vyearmth=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VYEARMTH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconcd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONCD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconds=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONDS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconva=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONVA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diettype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DIETTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconpa=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONPA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patconam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patcontl=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATCONTL
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wbedtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WBEDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "servdate=",QRYNAME     * HPS Code Starts Here
          IF        @EQUAL
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      SERVDATE,CCENT,CYEAR,CMON,CDAY
            REP       " 0",SERVDATE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc002=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        !@EQUAL & !@EOS
              PACK      PTDSC002,QRYDATA,SP70
              REP       " 0",PTDSC002
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc005=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        !@EQUAL & !@EOS
              PACK      PTDSC005,QRYDATA,SP70
.             REP       " 0",PTDSC005
            ENDIF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptdsc006=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        !@EQUAL & !@EOS
              PACK      PTDSC006,QRYDATA,SP70
.             REP       " 0",PTDSC006
            ENDIF
            GOTO      SETPAR99
          ENDIF          
.
          MATCH     "servdat1=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SERVDAT1
            GOTO      SETPAR99
          ENDIF
.
.
          MATCH     "nextpatf=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPATF
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "shiftnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHIFTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmspd001=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSPD001
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmspd002=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PMSPD002
            GOTO      SETPAR99
          ENDIF
.                                           * HPS Code Ends Here
          MATCH     "deftflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTFLAG
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "filtdpst=",QRYNAME
          IF        @EQUAL
            PACK      FILTDPST,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "filtclai=",QRYNAME
          IF        @EQUAL
            PACK      FILTCLAI,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF 
.
          MATCH     "filtexpd=",QRYNAME
          IF        @EQUAL
            PACK      FILTEXPD,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtexdy=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTEXDY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pmswo",QRYNAME
          IF        @EQUAL
            CALL      SPPMWO00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wdcom001=",QRYNAME     * Working diagnosis comments
          IF        @EQUAL
            CALL      GETWOR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hiscomnt=",QRYNAME     * Working diagnosis comments
          IF        @EQUAL
            CALL      GETHIS00
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "labpno",QRYNAME
          IF        @EQUAL
            CALL     STPNO000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labpsl",QRYNAME
          IF        @EQUAL
            CALL     STLSL000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "labprt",QRYNAME
          IF        @EQUAL
            CALL     STLAB000
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "ptmis038=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS038
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis039=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS039
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis040=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS040
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis041=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS041
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis042=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS042
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis043=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS043
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptmis044=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTMIS044
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dschcomm",QRYNAME
          IF        @EQUAL
            CALL      GDSCCM00
            GOTO      SETPAR99
          ENDIF
. 
          MATCH     "emptonly=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EMPTONLY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "discatdd=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DISCATDD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "calcexls=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CALCEXLS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hospcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HOSPCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "allhflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ALLHFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "btschosp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BTSCHOSP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "nextpage=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NEXTPAGE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filtadmn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTADMN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filturno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FILTURNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "norecord=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,NORECORD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "startnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,STARTNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exdtblnk=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXDTBLNK
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "invnumbr=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,INVNUMBR
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "claimsta=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLAIMSTA
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "valdtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,VALDTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "batchnum=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,BATCHNUM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exclwait=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXCLWAIT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "exclclos=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXCLCLOS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hlthfund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HLTHFUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "hlfdclty=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,HLFDCLTY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mavbatch=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MAVBATCH
            GOTO      SETPAR99
          ENDIF
.         
          MATCH     "mavinvce=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MAVINVCE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclfbid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLFBID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclarid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLARID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclfrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLFRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclrptc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLRPTC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclscod=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLSCOD
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecclsrvc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECCLSRVC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecotfund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECOTFUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecottype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECOTTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecottrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECOTTRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "procstat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROCSTAT
            GOTO      SETPAR99
          ENDIF  
.
          MATCH     "fundtrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FUNDTRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clmuniid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,CLMUNIID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "payrunno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYRUNNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "payrundt=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYRUNDT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "repretky=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REPRETKY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "provnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PROVNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecrepypn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREPYPN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecreprun=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREPRUN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecrepdat=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREPDAT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecrerkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECRERKEY
            GOTO      SETPAR99
          ENDIF
.
.         MATCH     "ecreclid=",QRYNAME
.         IF        @EQUAL
.           MOVE      QRYDATA,ECRECLID
.           GOTO      SETPAR99
.         ENDIF
.
.         MATCH     "ecrepyrn=",QRYNAME
.         IF        @EQUAL
.           MOVE      QRYDATA,ECREPYRN
.           GOTO      SETPAR99
.         ENDIF
.
.         MATCH     "ecrepyrd=",QRYNAME
.         IF        @EQUAL
.           MOVE      QRYDATA,ECREPYRD
.           GOTO      SETPAR99
.         ENDIF
.
.         MATCH     "ecrerrky=",QRYNAME
.         IF        @EQUAL
.           MOVE      QRYDATA,ECRERRKY
.           GOTO      SETPAR99
.         ENDIF
.
          MATCH     "ecreadvc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREADVC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecreptno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECREPTNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecretrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECRETRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ecreclam=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,ECRECLAM
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "partcode=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PARTCODE
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fundtrid=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FUNDTRID
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remitadv=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMITADV
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "partnumb=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PARTNUMB
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "selprint=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SELPRINT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "remitkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,REMITKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "paymtkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYMTKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptrgm",QRYNAME
          IF        @EQUAL
            CALL      SPRGM000
            COMPARE   ZERO,EXIT
            GOTO      SETPAR99 IF EQUAL
          ENDIF
.
          MATCH     "multlt01=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,MULTLT01
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "debdindc=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEBDINDC
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "extrdiet=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,EXTRDIET
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mhcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETPMH00           * Get patient medical history comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wdcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETWDI00           * Get working diagnosis comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "clcommnt=",QRYNAME
          IF        @EQUAL
            CALL      GETCLN00           * Get clinical notes comments
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vsc18",QRYNAME
          IF        @EQUAL
            UNPACK    QRYNAME,KEY5,KEY3
            MOVE      KEY3,F3
            STORE     QRYDATA,F3,USERDF01,USERDF02,USERDF03,USERDF04,USERDF05:
                                 USERDF06,USERDF07,USERDF08,USERDF09,USERDF10
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftview=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTVIEW
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "formtype=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FORMTYPE
            GOTO      SETPAR99
          ENDIF
.
          MATCH    "frmprt",QRYNAME
          IF        @EQUAL
            CALL     STFRM000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "frmpno",QRYNAME
          IF        @EQUAL
            CALL     STFPN000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "frmpsl",QRYNAME
          IF        @EQUAL
            CALL     STFPS000
            GOTO     SETPAR99
          ENDIF
.
          MATCH    "frmcod",QRYNAME
          IF        @EQUAL
            CALL     STFSC000
            GOTO     SETPAR99
          ENDIF
.
          MATCH     "prt00",QRYNAME
          IF        @EQUAL
            CALL      STPRT000
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "acval",QRYNAME
          IF        @EQUAL
            CALL      UPCVAL00         * Update Attribute Coded Field value
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "attxt",QRYNAME
          IF        @EQUAL
            CALL      SAVATF00         * Save Attribute Text to temp file
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "atexpdsc=",QRYNAME     * Attribute Expected Discharge Dest
          IF        @EQUAL
            MOVE      "9",ATTYPIND          * Attribute Type 009
            MOVE      "1",ATTXTIND          * Text Field 1
            MOVE      QRYDATA,ATTXTVAL
            MOVE      URNUMBER,PTATR001
            MOVE      ADMISSNO,PTATR002
            CALL      UPDATV00              * Update Attribute Text Field value
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "pataturn=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATATURN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptatr",QRYNAME
          IF        @EQUAL
            CALL      SPTATR00
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "diswafil=",QRYNAME
          IF        @EQUAL
            PACK      DISWAFIL,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patatvis=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATATVIS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "patatnot=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PATATNOT
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "togglexp=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,TOGGLEXP
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "wdbdsrch=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,WDBDSRCH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrsubin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRSUBIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrlocin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRLOCIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "fhrparin=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,FHRPARIN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "filthosp=",QRYNAME
          IF        @EQUAL
            PACK      FILTHOSP,QRYDATA,SP70
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "deftallh=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,DEFTALLH
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "payeepno=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYEEPNO
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "paymtrun=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYMTRUN
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "paymrund=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PAYMRUND
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "retrvkey=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,RETRVKEY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "dtcommnt=",QRYNAME
          IF        @EQUAL
            MOVE      ONE,DTCMTFLG
            CALL      GTDTCM00              * Diet Comments
          ENDIF
.
          MATCH     "shwphoto=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHWPHOTO
            CALL      SETPAR99              
          ENDIF
.
          MATCH     "showflag=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,SHOWFLAG
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "ptstatus=",QRYNAME
          IF        @EQUAL
            MOVE      QRYDATA,PTSTATUS
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "mrfddate=",QRYNAME
          IF        @EQUAL
            MATCH     SP70,QRYDATA
            IF        @EQUAL | @EOS
              MOVE      SP70,MRFDDATE
              GOTO      SETPAR99
            ENDIF 
.
            UNPACK    QRYDATA,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00            * Set CMON from MTHNAM3
            PACK      MRFDDATE,CCENT,CYEAR,CMON,CDAY
            GOTO      SETPAR99
          ENDIF
.
          MATCH     "vsxdc",QRYNAME
          IF        @EQUAL
            CALL      SVSXDC00              * Visit extra data
            GOTO      SETPAR99
          ENDIF
.
SETPAR99  RETURN
+
.------------------------------------------------------------
. Set parameters for print billing statement
.------------------------------------------------------------
STPRT000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          RESET     QRYDATA
          MATCH     SP70,QRYDATA
          GOTO      STPRT999 IF EQUAL
          MOVE      QRYDATA,BPRNT[F3]
STPRT999  RETURN
+
.*******************************************************************************
.                   SET LABPRT PARAMETERS
.*******************************************************************************
STLAB000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLAB001,STLAB002,STLAB003,STLAB004
.
          MOVE      ONE,EXIT
          GOTO      STLAB999
.
STLAB001  MOVE      QRYDATA,LABPRT01
          GOTO      STLAB999
.
STLAB002  MOVE      QRYDATA,LABPRT02
          GOTO      STLAB999
.
STLAB003  MOVE      QRYDATA,LABPRT03
          GOTO      STLAB999
.
STLAB004  MOVE      QRYDATA,LABPRT04
          GOTO      STLAB999
.
STLAB999  RETURN
+
.*******************************************************************************
.                   SET FRMPRT PARAMETERS
.*******************************************************************************
STFRM000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STFRM001,STFRM002,STFRM003
.
          MOVE      ONE,EXIT
          GOTO      STFRM999
.
STFRM001  MOVE      QRYDATA,FRMPRT01
          GOTO      STFRM999
.
STFRM002  MOVE      QRYDATA,FRMPRT02
          GOTO      STFRM999
.
STFRM003  MOVE      QRYDATA,FRMPRT03
          GOTO      STFRM999
.
STFRM999  RETURN
+
.*******************************************************************************
.                   SET LABPNO PARAMETERS
.*******************************************************************************
STPNO000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STPNO001,STPNO002,STPNO003,STPNO004
.
          MOVE      ONE,EXIT
          GOTO      STPNO999
.
STPNO001  MOVE      QRYDATA,LABPNO01
          GOTO      STPNO999
.
STPNO002  MOVE      QRYDATA,LABPNO02
          GOTO      STPNO999
.
STPNO003  MOVE      QRYDATA,LABPNO03
          GOTO      STPNO999
.
STPNO004  MOVE      QRYDATA,LABPNO04
          GOTO      STPNO999
.
STPNO999  RETURN
+
.*******************************************************************************
.                   SET FRMPNO PARAMETERS
.*******************************************************************************
STFPN000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STFPN001,STFPN002,STFPN003
.
          MOVE      ONE,EXIT
          GOTO      STFPN999
.
STFPN001  MOVE      QRYDATA,FRMPNO01
          GOTO      STFPN999
.
STFPN002  MOVE      QRYDATA,FRMPNO02
          GOTO      STFPN999
.
STFPN003  MOVE      QRYDATA,FRMPNO03
          GOTO      STFPN999
.
STFPN999  RETURN
+
.******************************************************************************
.                   SET LABPSL PARAMETERS
.******************************************************************************
STLSL000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STLSL001,STLSL002,STLSL003,STLSL004
.
          MOVE      ONE,EXIT
          GOTO      STLSL999
.
STLSL001  MOVE      QRYDATA,LABPSL01
          GOTO      STLSL999
.
STLSL002  MOVE      QRYDATA,LABPSL02
          GOTO      STLSL999
.
STLSL003  MOVE      QRYDATA,LABPSL03
          GOTO      STLSL999
.
STLSL004  MOVE      QRYDATA,LABPSL04
          GOTO      STLSL999
.
STLSL999  RETURN
+
.******************************************************************************
.                   SET FRMPSL PARAMETERS
.******************************************************************************
STFPS000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STFPS001,STFPS002,STFPS003
.
          MOVE      ONE,EXIT
          GOTO      STFPS999
.
STFPS001  MOVE      QRYDATA,FRMPSL01
          GOTO      STFPS999
.
STFPS002  MOVE      QRYDATA,FRMPSL02
          GOTO      STFPS999
.
STFPS003  MOVE      QRYDATA,FRMPSL03
          GOTO      STFPS999
.
STFPS999  RETURN
+
.******************************************************************************
.                   SET FRMCOD PARAMETERS
.******************************************************************************
STFSC000  MOVE      ZERO,EXIT
          UNPACK    QRYNAME,KEY6,KEY2
          MOVE      KEY2,F2
          BRANCH    F2,STFSC001,STFSC002,STFSC003
.
          MOVE      ONE,EXIT
          GOTO      STFSC999
.
STFSC001  MOVE      QRYDATA,FRMCOD01
          GOTO      STFSC999
.
STFSC002  MOVE      QRYDATA,FRMCOD02
          GOTO      STFSC999
.
STFSC003  MOVE      QRYDATA,FRMCOD03
          GOTO      STFSC999
.
STFSC999  RETURN
.
.-----------------------------------------------------------------
. Get Diet comments from input comment TextArea and write them to
. the temporary file for updating to the database
.-----------------------------------------------------------------
GTDTCM00  MOVE      SP70,ARYCOMMT[1]
          MOVE      SP70,ARYCOMMT[2]
          MOVE      SP70,ARYCOMMT[3]
          MOVE      SP70,ARYCOMMT[4]
          MOVE      SP70,ARYCOMMT[5] 
          MOVE      ZERO,F1
          GOTO      GTDTCM20
.
GTDTCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GTDTCM99 IF OVER
.
          MATCH     SP70,QRYNAME
          GOTO      GTDTCM80 IF NOT EQUAL
.          
GTDTCM20  MOVE      QRYDATA,QRYDATA1
          SQUEEZE   QRYDATA1                 * skip the blank line
          MATCH     SP70,QRYDATA1 
          GOTO      GTDTCM10 IF EOS
          GOTO      GTDTCM10 IF EQUAL
.
          ADD       ONE,F1
          MOVE      QRYDATA,ARYCOMMT[F1]
.
          COMPARE   FIVE,F1
          GOTO      GTDTCM80 IF EQUAL
.
          GOTO      GTDTCM10
.
GTDTCM80  MOVE      ONE,TEXTAREA             * Flag for Next CGI Param
.
GTDTCM99  RETURN
.
.------------------------------------------------------------
. Called from WEBBOD00
.------------------------------------------------------------
PROFLD00  BRANCH  REPORTNO,PROFLD10,PROFLD20,PROFLD30,PROFLD40,PROFLD50:
                           PROFLD60,PROFLD70,PROFLD99,PROFLD99,PROFL100:
                           PROFL110,PROFLD99,PROFLD10,PROFL120,PROFLD99:
                           PROFL130,PROFL140,PROFL180,PROFL190,PROFL200:
                           PROFL210
          GOTO    PROFLD99
.
. Current Admissions
.
PROFLD10  BRANCH  FLDSETNO,PROFLD11,PROFLD12,PROFLD13
.
PROFLD11  CALL    CADM0000
          GOTO    PROFLD99
.
PROFLD12  CALL    WRDF0000
          GOTO    PROFLD99
.
PROFLD13  CALL    PDEP0000
          GOTO    PROFLD99 
.
. Discharges
.
PROFLD20  BRANCH  FLDSETNO,PROFLD21,PROFLD22
.
PROFLD21  CALL    PDSC0000
          GOTO    PROFLD99
.
PROFLD22  CALL    WRDF0000
          GOTO    PROFLD99
.
. Admissions
.
PROFLD30  BRANCH  FLDSETNO,PROFLD31,PROFLD32
.
PROFLD31  CALL    PADM0000
          GOTO    PROFLD99
.
PROFLD32  CALL    WRDF0000
          GOTO    PROFLD99
.
. Pre-Admissions
.
PROFLD40  BRANCH  FLDSETNO,PROFLD41,PROFLD42
.
PROFLD41  CALL    PPRE0000
          GOTO    PROFLD99
.
PROFLD42  CALL    WRDF0000
          GOTO    PROFLD99
.
. Patient Condition Form
.
PROFLD50  BRANCH  FLDSETNO,PROFLD51,PROFLD52,PROFLD53,PROFLD54,PROFLD55
          GOTO    PROFLD99
.
PROFLD51  CALL    MASF0000
          GOTO    PROFLD99
.
PROFLD52  CALL    CONF0000
          GOTO    PROFLD99
.
PROFLD53  CALL    PMWO0000
          GOTO    PROFLD99
.
PROFLD54  CALL    VXTF0000
          GOTO    PROFLD99
.
PROFLD55  CALL    MISF0000
          GOTO    PROFLD99
.
PROFLD60
          GOTO    PROFLD99
.
.  Bookings 
.
PROFLD70  BRANCH  FLDSETNO,PROFLD71,PROFLD72
          GOTO    PROFLD99
.
PROFLD71  CALL    PBOK0000
          GOTO    PROFLD99
.
PROFLD72  CALL    WRDF0000
          GOTO    PROFLD99
.
PROFL100  BRANCH  FLDSETNO,PROFL101
          GOTO    PROFLD99
.
PROFL101  CALL    AWRL0000
          GOTO    PROFLD99
.
PROFL110  BRANCH  FLDSETNO,PROFL111
          GOTO    PROFLD99
.
PROFL111  CALL    EXPD0000 
          GOTO    PROFLD99
.
PROFL120  BRANCH  FLDSETNO,PROFL121,PROFL122,PROFL123
          GOTO    PROFLD99
.
PROFL121  CALL    ECCL0000
          GOTO    PROFLD99
.
PROFL122  CALL    MASF0000
          GOTO    PROFLD99
.
PROFL123  CALL    MISF0000
          GOTO    PROFLD99
.
PROFL130  BRANCH  FLDSETNO,PROFL131,PROFL132,PROFL133
          GOTO    PROFLD99
.
PROFL131  CALL    MASF0000
          GOTO    PROFLD99
.
PROFL132  CALL    MISF0000
          GOTO    PROFLD99
.
PROFL133  CALL    ECFL0000
          GOTO    PROFLD99
.
PROFL140  BRANCH  FLDSETNO,PROFL141
          GOTO    PROFLD99
.
PROFL141  CALL    ECRL0000
          GOTO    PROFLD99
.
PROFL180  BRANCH  FLDSETNO,PROFL181,PROFL182,PROFL183,PROFL184
          GOTO    PROFLD99
.
PROFL181  CALL    MASF0000
          GOTO    PROFLD99
.
PROFL182  CALL    MISF0000 
          GOTO    PROFLD99
.
PROFL183  CALL    GTAG0000
          GOTO    PROFLD99
.
PROFL184  CALL    PNUT0000
          GOTO    PROFLD99
.
PROFL190  BRANCH  FLDSETNO,PROFL191
          GOTO    PROFLD99
.
PROFL191  CALL    ERLM0000
          GOTO    PROFLD99
.
PROFL200  BRANCH  FLDSETNO,PROFL201
          GOTO    PROFLD99
.
PROFL201  CALL    ERLB0000
          GOTO    PROFLD99
.
PROFL210  BRANCH  FLDSETNO,PROFL211,PROFL212,PROFL213
          GOTO    PROFLD99
.
PROFL211  CALL    MASF0000
          GOTO    PROFLD99
.
PROFL212  CALL    CONF0000
          GOTO    PROFLD99
.
PROFL213  CALL    PMWO0000
          GOTO    PROFLD99
.
PROFLD99  RETURN
.------------------------------------------------------------
. Ward Current Admissions
.------------------------------------------------------------
CURADM00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,CURADM90
.
          MATCH     "7",TEMPLATE           * dependancy list
          IF        !@EQUAL
            MATCH     "9",TEMPLATE
            GOTO      CURADM20 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,SHIFTNUM
          IF        @EQUAL
            MOVE      ONE,SHIFTNUM
          ENDIF
.
          COMPARE   ONE,CLOSEDEP
          IF        @EQUAL
            CALL      CLDEP000
          ENDIF
.
          MATCH     SP70,LASTDATE
          IF        @EQUAL
            CALL       IBACLOCK        * default to yesterdays date
            CALL       DMYCON
            SUB        ONE,JULDAY      
            MOVE       JULDAY,JWKDAY
            MOVE       JULYR,JWKYER
            MOVE       JULCC,JWKCC
            CALL       JULCON
            PACK       LASTDATE,CC,YY,MM,DD
            REP        " 0",LASTDATE
          ENDIF
CURADM20  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CALL      WARDET00           * Calculate  ward statistics
.
          CALL      CALCA000
.
          CLEAR     WEBTITLE
          MOVE      WBDESC,KEY20       * EC changes
          APPEND    KEY20,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,CURADM99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      CURADM99
.
CURADM90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
CURADM99  RETURN
.------------------------------------------------------------
. Ward Discharges
.------------------------------------------------------------
PATDSC00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,PATDSC90
.
          CALL      CURPER00 
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      WBDESC,KEY20           * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
.
          APPEND    "(Patient Discharges)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PATDSC99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      PATDSC99
.
PATDSC90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
PATDSC99  RETURN
.------------------------------------------------------------
. Ward Admissions 
.------------------------------------------------------------
PATADM00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,PATADM90
.
          CALL      CURPER00 
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      WBDESC,KEY20           * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
.
          APPEND    "(Patient Admissions)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PATADM99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      PATADM99
.
PATADM90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
PATADM99  RETURN

.------------------------------------------------------------
. Ward Pre Admissions 
.------------------------------------------------------------
PATPRE00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,PATPRE90
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      WBDESC,KEY20               * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
.
          APPEND    "(Patient Pre-Admissions)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PATPRE99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      PATPRE99
.
PATPRE90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
PATPRE99  RETURN
.------------------------------------------------------------
. Ward Bookings 
.------------------------------------------------------------
PATBOK00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,PATBOK90
.
          CALL      CURPER00 
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      WBDESC,KEY20         * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
          APPEND    "(Patient Bookings)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,PATBOK99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      PATBOK99
.
PATBOK90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
PATBOK99  RETURN
.
.------------------------------------------------------------------------------
.                            All Wards Lists
. This report number allows for lists where WARDCODE does not need to 
. be known (i.e. passed from template or specified on user security).
.------------------------------------------------------------------------------
ALLWRD00  MOVE      WBDESC,KEY20         * EC changes
          CLEAR     WEBTITLE
          APPEND    KEY20,WEBTITLE
          APPEND    "(Unallocated Patients List)",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBHED00
          BRANCH    EXIT,ALLWRD99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
ALLWRD99  RETURN
.
.------------------------------------------------------------------------------
. All Wards Lists
.------------------------------------------------------------------------------
AWRL0000  BRANCH    FLDITMNO,AWRL0100,AWRL0200,AWRL0300
.
          GOTO      AWRL9999 
.
AWRL0100  CALL      WONSEL00           * Ward-Only wards selection list
          GOTO      AWRL9999
.
AWRL0200  CALL      UNALPT00           * Unallocated Patients List
          GOTO      AWRL9999
.
AWRL0300  WRITE     HTMLFILE;NUMNOBED; * Number of unallocated patients
          GOTO      AWRL9999
.
AWRL9999  RETURN
.
.------------------------------------------------------------
. Ward-Only Wards Selection List
.------------------------------------------------------------
WONSEL00  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
WONSEL10  CALL      RDKWARD7
          BRANCH    OVRCD,WONSEL99
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      WONSEL99 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WONSEL10 IF NOT EQUAL
.
          COMPARE   TWO,WINPUT              * List only Ward/Bed+Ward-Only wards
          GOTO      WONSEL10 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WONSEL99 IF NOT EQUAL
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     WARDCODE,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WONSEL10
.
WONSEL99  RETURN
.
.------------------------------------------------------------------------------
.                       Unallocated Patients List
. This procedure produces a list of all patients without a bed allocation
. It lists patients across all Ward/Bed + Ward-Only wards (default) or for 
. a given Ward/Bed + Ward-Only ward. 
.------------------------------------------------------------------------------
UNALPT00  MOVE      ZERO,WSDEINDC
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,WSDEINDC,DIM127
.
          MOVE      ZERO,NUMNOBED           * Initialize number of patients
.
          PACK      KEY13,SP70
          CALL      RDSNOBE1
UNALPT10  CALL      RDKNOBE1
          BRANCH    OVRCD,UNALPT99
.
          MATCH     WARDCODE,SP70           * Include all wards?
          GOTO      UNALPT20 IF EQUAL       * Yes, skip check for given ward.
.
          MATCH     WARDCODE,NBWARD         * Specified ward?
          GOTO      UNALPT10 IF NOT EQUAL   * No, get next record.
.
UNALPT20  PACK      KEY6,NBWARD,SP70        * Read Ward/Bed file to check if
          CALL      RDWARD1                 * record found is for a Ward/Bed +
          BRANCH    OVRCD,UNALPT10          * Ward-Only ward.
.
          COMPARE   TWO,WINPUT              * Is this a Ward/Bed+Ward-Only ward?
          GOTO      UNALPT10 IF NOT EQUAL   * No, get next record
.
          IF        IBCNMHOS<>1
            GOTO      UNALPT30
          ENDIF
.
          MATCH     SP70,WBSEHOSP
          GOTO      UNALPT30 IF EQUAL
.
          MATCH     PTWDHOSN,WBSEHOSP
          GOTO      UNALPT10 IF NOT EQUAL
.
UNALPT30  PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          CALL      DSPUNA00                * Display unallocated patient row
.
          ADD       ONE,NUMNOBED            * Increment number of patients
          GOTO      UNALPT10                * Get next record.
.
UNALPT99  RETURN
.
.------------------------------------------------------------------------------
.                      Display Unallocated Patient Row
.------------------------------------------------------------------------------
DSPUNA00  CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          MATCH       "1",WSDEINDC
          IF          @EQUAL
            WRITE     HTMLFILE;"<tr><td align=center>",PTWDSDES,"&nbsp;":
                               "<img src=#"../images/EditIcon.gif#"":
                               " class=ListIcon onclick='BedAllocation(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'></td>";
          ELSE
            WRITE     HTMLFILE;"<tr><td align=center>",NBWARD,"&nbsp;":
                               "<img src=#"../images/EditIcon.gif#"":
                               " class=ListIcon onclick='BedAllocation(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'></td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>";
.
          REP       "+ ",URNUMBER
.
          WRITE     HTMLFILE;"<td nowrap align=center>",URNUMBER,"</td>";
.
          MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     TDESC,SP70
          IF        @EQUAL
            WRITE     HTMLFILE;"<td nowrap>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td nowrap>",TDESC,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td nowrap><a href='":
                             "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                              SDOCFNAM,"</a></td>":
                             "<td nowrap>",DISPDATE,ATIME,"</td></tr>";
. 
DSPUNA99  RETURN
.
.------------------------------------------------------------
. Ward Current Admissions
.------------------------------------------------------------
CADM0000  BRANCH    FLDITMNO,CADM0100,CADM0200,CADM0300,CADM0400,CADM0500:
                             CADM0600,CADM0700,CADM0800,CADM0900,CADM1000:
                             CADM1100,CADM1200,CADM1300,CADM1400,CADM1500:
                             CADM1600,CADM1700,CADM1800,CADM1900,CADM2000:
                             CADM2100,CADM2200,CADM2300,CADM2400,CADM2500:
                             CADM2600,CADM2700,CADM2800,CADM2900,CADM3000:
                             CADM3100,CADM3200,CADM3300,CADM3400,CADM3500:
                             CADM3600,CADM3700,CADM3800,CADM3900,CADM4000:
                             CADM4100,CADM4200,CADM4300,CADM4400,CADM4500:
                             CADM4600,CADM4700,CADM4800,CADM4900,CADM5000:
                             CADM5100,CADM5200,CADM5300,CADM5400,CADM5500:
                             CADM5600,CADM5700,CADM5800,CADM5900,CADM6000:
                             CADM6100,CADM6200,CADM6300,CADM6400,CADM6500:
                             CADM6600,CADM6700,CADM6800,CADM6900,CADM7000:
                             CADM7100,CADM7200,CADM7300,CADM7400,CADM7500:
                             CADM7600,CADM7700,CADM7800,CADM7900,CADM8000 
.
.                                           * HPS CODE ADDED 14,15,16
          GOTO      CADM9999
.
CADM0100  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000      * Ward Select Options
          GOTO      CADM9999
.
CADM0200  CALL      CTABA000      * Table of Current Admissions
          GOTO      CADM9999
.
CADM0300  CALL      CTABB000      * Table of Current Admissions with Condition
          GOTO      CADM9999
.
CADM0400  CALL      CTABC000      * Table of Current Admissions with Condition
          GOTO      CADM9999      * & Diet
.
CADM0500  CALL      CTABD000      * Table of Current Admissions with Condition
          GOTO      CADM9999      * & Diet (No Expected Discharge + Prov. DRG)
.
CADM0600  WRITE     HTMLFILE;NUMOFPAT;                          
          GOTO      CADM9999      
.
CADM0700  CALL      CTABE000      * Table of Current Admissions 
          GOTO      CADM9999    
.
CADM0800  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          CALL      CTABF000            * - chaplin view
          GOTO      CADM9999    
.
CADM0900  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999    
.
CADM1000  WRITE     HTMLFILE;NUMNOBED;  * Number of patients not allocated a bed
          GOTO      CADM9999      
.
CADM1100  WRITE     HTMLFILE;NUMEMBED;  * Number of empty beds
          GOTO      CADM9999      
.
CADM1200  WRITE     HTMLFILE;NUMBPATS;  * Number of patients
          GOTO      CADM9999      
.
CADM1300  WRITE     HTMLFILE;WBEDTYPE;  * Ward Bed Type
          GOTO      CADM9999      
.
CADM1400  CALL      DEPLST00            * Dependency List
          GOTO      CADM9999
.
CADM1500  CALL      SHFSEL00            * Shift Combo Display
          GOTO      CADM9999
.
CADM1600  MATCH     SP70,SERVDATE
          GOTO      CADM9999 IF EQUAL
          UNPACK    SERVDATE,CCENT,CYEAR,CMON,CDAY  * Service Date 
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      CADM9999
.
CADM1700  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,STVVIEW        * STV flag                    Car 262343
          CALL      CTABN000            * - nutrition view                     
          GOTO      CADM9999
.
CADM1800  MOVE      CATMJ,CATEGORY     
          MOVE      DIETTYPE,CODE
          CALL      CODITM00
          GOTO      CADM9999
.
CADM1900  WRITE     HTMLFILE;DIETNCDE;  * Dietitian - doctor code
          GOTO      CADM9999      
.
CADM2000  CALL      DIETTN00            * Dietitian - doctor name 
          GOTO      CADM9999      
.
CADM2100  MOVE      ONE,KIDSONLY        * Table of patient ward list (rch)     
          MOVE      ZERO,KIDSVEW2       *   kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999    
.
CADM2200  MOVE      ONE,KIDSONLY        * Table of patient ward list (rch)     
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          CALL      CTABN000            * - nutrition view                     
          GOTO      CADM9999
.
CADM2300  MOVE      ONE,KIDSONLY        * Table of patient ward list (rch)     
          CALL      CTABF000            * - chaplin view
          GOTO      CADM9999    
.
CADM2400  MOVE      ONE,KIDSONLY        * Table of patient ward list (rch)     
          MOVE      ONE,KIDSVEW2        * Kids view Two
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999    
.
CADM2500  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ONE,ALTVIEW1        * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM2600  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ONE,EMRGVIEW        * Emergency View - Yes
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
.
          PACK      KEY6,WARDCODE,SP70  * Re Read correct ward
          CALL      RDWARD1
          BRANCH    OVRCD,CADM9999
.
          GOTO      CADM9999    
.
CADM2700  CALL      EMUW0000            * Ward Select Options with default
          GOTO      CADM9999            * tofirst EOU ward
.
CADM2800  CALL      BDMN0000            * Bed Management Ward View
          GOTO      CADM9999
.
CADM2900  CALL      BDBD0000            * Bed Board View
          GOTO      CADM9999
.
CADM3000  WRITE     HTMLFILE;EMPTONLY;
          GOTO      CADM9999
.
CADM3100  CALL      CNPBMV00
          GOTO      CADM9999
.
CADM3200  MATCH     SP70,PTCNDONP
          GOTO      CADM9999 IF EQUAL
          GOTO      CADM9999 IF EOS
.
          MOVE      ZERO,FORM5
          SQUEEZE   PTCNDONP
          MOVE      PTCNDONP,FORM5
.
          COMPARE   ZERO,FORM5
          GOTO      CADM9999 IF EQUAL
.
          WRITE     HTMLFILE;"Max No. of Patients: ",PTCNDONP;
          GOTO      CADM9999
.
CADM3300  CALL      CATD0000                * Return Cat sn long description
          GOTO      CADM9999
.
CADM3400  CALL      DOUT0000                * Day oncology outlier list
          GOTO      CADM9999
.
CADM3500  WRITE     HTMLFILE;OUTLTYPE;
          GOTO      CADM9999
.
CADM3600  MOVE      ONE,VIEWONLY
          CALL      BDMN0000            * Bed Management Ward View
          GOTO      CADM9999
.
CADM3700  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1        * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ONE,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM3800  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ONE,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                    Car 262343
          CALL      CTABN000            * - nutrition view
          GOTO      CADM9999
.
CADM3900  MOVE      ONE,STVCVIEW
          CALL      BDMN0000            * Bed Management Ward View
          GOTO      CADM9999
.
CADM4000  MOVE      ONE,STVCVIEW
          CALL      DOUT0000                * Day oncology outlier list
          GOTO      CADM9999
.
CADM4100  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ONE,BULKDSCH
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999    
.
CADM4200  MATCH     SP70,PTDSC002
          GOTO      CADM9999 IF EQUAL
          WRITE     HTMLFILE;PTDSC002;
          GOTO      CADM9999
.
CADM4300  CALL      CTABH000
          GOTO      CADM9999
.
CADM4400  MOVE      WARDCODE,KEY3
          REP       " _",KEY3
          WRITE     HTMLFILE;KEY3;
          GOTO      CADM9999
.
CADM4500  CALL      BEDMV000
          GOTO      CADM9999
.
CADM4600  CALL      BEDLO000
          GOTO      CADM9999
.
CADM4700  CALL      SNLD0000
          GOTO      CADM9999
.
CADM4800  CALL      LOCAT000
          GOTO      CADM9999
.
CADM4900  MOVE      ONE,DISPMV
          CALL      CMAPH000
          GOTO      CADM9999
.
CADM5000  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          CALL      CTABI000            * WAHealth Sort Table view
          GOTO      CADM9999
.
CADM5100  WRITE     HTMLFILE;DEBDINDC;
          GOTO      CADM9999
.
CADM5200  MOVE      CATDC,CATEGORY
          MOVE      DIETTYPE,CODE
          CALL      CODITM00
          GOTO      CADM9999
.
CADM5300  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM5400  WRITE     HTMLFILE;EXTRDIET;
          GOTO      CADM9999
.
CADM5500  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,STVVIEW        * STV flag                    Car 262343
          MOVE      ONE,DISPUDF4        * don't display pmvxudf4 (CAR 305129)
          CALL      CTABN000            * - nutrition view
          GOTO      CADM9999
.
CADM5600  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,STVVIEW        * STV flag                    Car 262343
          MOVE      ONE,HEAVIEW         * Healthscope view
          MOVE      ZERO,DISPTHET       * display theatre status - no
          CALL      CTABN000            * - nutrition view                     
          GOTO      CADM9999
.
CADM5700  WRITE     HTMLFILE;PWDVTYPE;
          GOTO      CADM9999
.
CADM5800  MOVE      ZERO,KIDSONLY       * Table of patient ward list (hea)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ONE,WAHLFLAG        * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM5900  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          CALL      CTABI000            * WAHealth Sort Table view
          GOTO      CADM9999
.
CADM6000  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ONE,ALTVIEW1        * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * STV flag                   Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ONE,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6100  WRITE     HTMLFILE;FORMTYPE;
          GOTO      CADM9999
.
CADM6200  MOVE      ZERO,KIDSONLY       * Table of patient ward list (hea)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          MOVE      ONE,HEAVIEW
          MOVE      ZERO,DISPTHET       * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6300  MOVE      ZERO,KIDSONLY       * Table of patient ward list (hea)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          MOVE      ZERO,HEAVIEW
          MOVE      ONE,DISPTHET        * display theatre status - yes
          MOVE      ONE,DISPMV          * display Mechanical Ventilation - yes
          MOVE      ONE,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6400  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ONE,CABONLY          
          MOVE      ONE,DISPTHET        * display theatre status - yes
          MOVE      ONE,DISPMV          * display Mechanical Ventilation - yes
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6500  MOVE      ZERO,KIDSONLY       * Table of patient ward list (hea)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = yes
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          MOVE      ONE,HEAVIEW
          MOVE      ONE,DISPTHET        * display theatre status - yes
          MOVE      ONE,DISPMV          * display Mechanical Ventilation - yes
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM6600  WRITE     HTMLFILE;TOGGLEXP;  * Show expected patients
          GOTO      CADM9999
.
CADM6700  CALL      EXPT0000            * Expected patients list for ward view
          GOTO      CADM9999
.
CADM6800  WRITE     HTMLFILE;NUMBREXP;  * Number of expected patients
          GOTO      CADM9999      
.
CADM6900  WRITE     HTMLFILE;WDBDSRCH;  * Ward/Bed Search View
          GOTO      CADM9999      
.
CADM7000  CALL      MEXP0000            * Map view expected patients
          GOTO      CADM9999      
.
CADM7100  CALL      BEDCL000
          GOTO      CADM9999
.
CADM7200  MOVE      ONE,HEAVIEW         * Hea view
          MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = yes
          CALL      CTABI000            * WAHealth Sort Table view
          GOTO      CADM9999
.
CADM7300  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ONE,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag                    Car 262343
          MOVE      ZERO,CNOTFLAG       * display clinical notes icon = no
          MOVE      ZERO,DISPDNAM       * display duplicate surname icons = no
          MOVE      ZERO,HEAVIEW
          MOVE      ONE,DISPTHET        * display theatre status - no
          MOVE      ZERO,DISPMV         * display Mechanical Ventilation - no
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM7400  MOVE      ZERO,KIDSONLY       * Table of patient ward list (standard)
          MOVE      ZERO,KIDSVEW2       * kids view 1
          MOVE      ZERO,ALTVIEW1       * Alternate view - with diagnosis
          MOVE      ZERO,EMRGVIEW       * Emergency View - No
          MOVE      ZERO,FASTVIEW
          MOVE      ZERO,SJOGVIEW
          MOVE      ZERO,STVVIEW        * Stv flag 
          MOVE      ONE,CNOTFLAG        * display clinical notes icon = Yes
          MOVE      ONE,DISPDNAM        * display duplicate surname icons = Yes
          MOVE      ZERO,HEAVIEW
          MOVE      ONE,DISPTHET        * display theatre status - no
          MOVE      ONE,DISPMV          * display Mechanical Ventilation - Yes
          MOVE      ONE,HEAONLY
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * - public version
          GOTO      CADM9999
.
CADM7500  WRITE     HTMLFILE;NUMBOUTL;  * Number of outliers
          GOTO      CADM9999
.
CADM7600  WRITE     HTMLFILE;NUMBEXPT;  * Number of expected patients
          GOTO      CADM9999
.
CADM7700  WRITE     HTMLFILE;NUMBCNFD;  * Number of confirmed discharge
          GOTO      CADM9999
.
CADM7800  CALL      EXPTA000            * Expected patients list for ward view
          GOTO      CADM9999
.
CADM7900  MOVE      ONE,HEAONLY         * Hea view
          MOVE      ONE,DISPMV          * display Mechanical Ventilation - Yes
          MOVE      ZERO,WAHLFLAG       * WA Health
          CALL      CTABG000            * public version 
          GOTO      CADM9999
.
CADM8000  WRITE     HTMLFILE;DEFTVIEW;  * Default tablesort view
          GOTO      CADM9999
.
CADM9999  RETURN
+
.------------------------------------------------------------
. Ward Bed Locations
.------------------------------------------------------------
LOCAT000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
LOCAT100  CALL      RDKWARD1
          BRANCH    OVRCD,LOCAT999
          MATCH     WARDCODE,WWARD
          GOTO      LOCAT999 IF NOT EQUAL
          COMPARE   ONE,WACTIVE
          GOTO      LOCAT100 IF EQUAL
.
          MOVE      "BV",CATEGORY
          MOVE      PTWDHKST,CODE
          CALL      GETCOD00
          MOVE      TDESC,BVTDESC
.
          MOVE      "BW",CATEGORY
          MOVE      PTWDIFST,CODE
          CALL      GETCOD00
          MOVE      TDESC,BWTDESC
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,RTTDESC
.
          MOVE      ZERO,ONLEAVE
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
          CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,LOCAT110
          MATCH     OWARD,WWARD
          GOTO      LOCAT110 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      LOCAT110 IF NOT EQUAL
          MOVE      ONE,ONLEAVE
.
LOCAT110  WRITE     HTMLFILE;"obj.AddBed(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"",WBDESC,"#",":
                             "#"",WEXTN,"#",":
                             "#"",PTWDCOMM,"#",":
                             "#"",WACTIVE,"#",":
                             "#"",RTTDESC,"#",":
                             "#"",WEFRBT,"#",":
                             "#"",WPLUR,"#",":
                             "#"",PTWDDNIN,"#",":
                             "#"",PTWDIAGE,"#",":
                             "#"",PTWDICRE,"#",":
                             "#"",PTWDSEX,"#",":
                             "#"",PTWDNSTA,"#",":
                             "#"",PTWDDOSA,"#",":
                             "#"",PTWDFVDW,"#",":
                             "#"",PTWDBDST,"#",":
                             "#"",BVTDESC,"#",":
                             "#"",BWTDESC,"#",":
                             "#"",ONLEAVE,"#",":
                             "#"",PTWDCOMM,"#");"
          GOTO     LOCAT100
.
LOCAT999  RETURN

.------------------------------------------------------------
. Display the selected Dietitian name      
.------------------------------------------------------------
DIETTN00  MOVE      SP70,DIETNNAM
          MATCH     SP70,DIETNCDE
          GOTO      DIETTN90 IF EQUAL
          
          PACK      KEY6,DIETNCDE
          CALL      RDDOCT1
          IF        OVRCD=0
            CALL      SDOCNM00
            MOVE      SDOCFNAM,DIETNNAM
          ENDIF
.
DIETTN90  WRITE     HTMLFILE;DIETNNAM;  * Dietitian - doctor name 
.
DIETTN99  RETURN
.------------------------------------------------------------
. Displays Transfers in/out for a Ward
.------------------------------------------------------------
DEPLST00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    LASTDATE,D4,DAYKEY
.
          MATCH     SP70,LASTDATE
          GOTO      DEPLST99 IF EQUAL
.
          UNPACK    LASTDATE,CCENT,CYEAR,TDAYMON
          PACK      RYEAR,CCENT,CYEAR
          REP       " 0",RYEAR
.
          CLOSE     PATDAYA1
          PACK      CFNAME,FILDAYA1,RYEAR
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO           * trap if file does not exist
          OPEN      PATDAYA1,CFNAME
          TRAPCLR   IO
          BRANCH    OVRCD,DEPLST99 
.
          PACK      KEY12,DAYKEY,SP70
          CALL      RSPTDAY1
DEPLST20  CALL      RKPTDAY1
          BRANCH    OVRCD,DEPLST99
          MATCH     DAYKEY,PTDYDATE
          GOTO      DEPLST99 IF NOT EQUAL
          MOVE      ZERO,RECFOUND
          MOVE      SP70,SAVTDATE
.
          PACK      KEY30,DPTDYADM,LASTDATE,Z70
          CALL      RDSTRAN2
DEPLST30  CALL      RDPTRAN2
          BRANCH    OVRCD,DEPLST20
          MATCH     DPTDYADM,DTADMN
          GOTO      DEPLST20 IF NOT EQUAL
          IF        RECFOUND=1
            MATCH     SAVTDATE,LASTDATE
            GOTO      DEPLST20 IF NOT EQUAL
          ENDIF
.
          MATCH     "A",TMOVE
          GOTO      DEPLST40 IF EQUAL
          MATCH     TDATE,LASTDATE
          GOTO      DEPLST40 IF NOT EQUAL
.
DEPLST40  MATCH     SP70,WARDCODE
          IF        !@EQUAL
            MOVE      ONE,RECFOUND
            MOVE      TDATE,SAVTDATE
            MATCH     TWARD,WARDCODE
            GOTO      DEPLST30 IF NOT EQUAL
          ENDIF
.
          PACK      KEY8,TURNO,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,DEPLST20
.
          PACK      KEY17,DPTDYADM,LASTDATE,SHIFTNUM,SP70
          CALL      RDPMPDP1
          IF        OVRCD = 1
            CALL      CLRPDP00
            MOVE      SP70,KEY3
            MOVE      ANSN,PMPDCLOS
          ELSE
            MOVE      PMPDSCOR,KEY3
          ENDIF
.
          UNPACK    PBDATE,CDAY,CMON,CYEAR,CCENT
          CALL      IBACLOCK
          PACK      AGEDATE,CCC,CYY,CMM,CDD
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          CALL      PATLN000
.       
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    PURNO,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    DPTDYADM,PATLINK
          RESET     PATLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",PATLINK,"#",":
                             "#"",PURNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",KEY3,"#",":
                             "#"",DPTDYADM,"#",":
                             "#"",LASTDATE,"#",":
                             "#"",SHIFTNUM,"#",":
                             "#"",WARDCODE,"#",":
                             "#"",PMPDCATE,"#",":
                             "#"",PMPDWARD,"#",":
                             "#"",PMPDCLOS,"#");";
.         
          GOTO      DEPLST20
.
DEPLST99  RETURN
.******************************************************************************
.*                       List Combo Display                                   *
.******************************************************************************
SHFSEL00  MATCH     "1",SHIFTNUM
          GOTO      SHFSEL10 IF EQUAL
          MATCH     "2",SHIFTNUM
          GOTO      SHFSEL20 IF EQUAL
          MATCH     "3",SHIFTNUM
          GOTO      SHFSEL30 IF EQUAL
.
SHFSEL10  WRITE     HTMLFILE;"<option value=1 selected>Shift 1 </option>":
                             "<option value=2>Shift 2 </option>":
                             "<option value=3>Shift 3 </option>";
.
          GOTO      SHFSEL99
.
SHFSEL20  WRITE     HTMLFILE;"<option value=1>Shift 1 </option>":
                             "<option value=2 selected>Shift 2 </option>":
                             "<option value=3>Shift 3 </option>";
.
          GOTO      SHFSEL99
.
SHFSEL30  WRITE     HTMLFILE;"<option value=1>Shift 1 </option>":
                             "<option value=2>Shift 2 </option>":
                             "<option value=3 selected>Shift 3 </option>";
.
SHFSEL99  RETURN
.------------------------------------------------------------
.Dependency List
.------------------------------------------------------------
PDEP0000  BRANCH    FLDITMNO,PDEP0100,PDEP0200,PDEP0300,PDEP0400,PDEP0500:
                             PDEP0600,PDEP0700,PDEP0800,PDEP0900,PDEP1000:
                             PDEP1100,PDEP1200,PDEP1300,PDEP1400

          GOTO      PDEP9999
.
PDEP0100  CALL      NEXT0000
          GOTO      PDEP9999
.
PDEP0200  CALL      PREV0000
          GOTO      PDEP9999
.
PDEP0300  CALL      CURSTD00
          GOTO      PDEP9999
.
PDEP0400  CALL      CUREND00
          GOTO      PDEP9999
.
PDEP0500  CALL      CURYR000
          GOTO      PDEP9999
.
PDEP0600  CALL      CURMON00
          GOTO      PDEP9999
.
PDEP0700  CALL      SELV0000
          GOTO      PDEP9999
.
PDEP0800  CALL      DEPLST00
          GOTO      PDEP9999 
.
PDEP0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PDEP9999
.
PDEP1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PDEP9999
.
PDEP1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PDEP9999
.
PDEP1200  WRITE     HTMLFILE;SHOWFLAG;
          GOTO      PDEP9999
.
PDEP1300  WRITE     HTMLFILE;SHWPHOTO;
          GOTO      PDEP9999
.
PDEP1400  WRITE     HTMLFILE;PTCNNMPR;
          GOTO      PDEP9999
.
PDEP9999  RETURN
.------------------------------------------------------------
. Ward discharges
.------------------------------------------------------------
PDSC0000  BRANCH    FLDITMNO,PDSC0100,PDSC0200,PDSC0300,PDSC0400,PDSC0500:
                             PDSC0600,PDSC0700,PDSC0800,PDSC0900,PDSC1000:
                             PDSC1100,PDSC1200,PDSC1300,PDSC1400
          GOTO      PDSC9999
.
PDSC0100  CALL      NEXT0000
          GOTO      PDSC9999
.
PDSC0200  CALL      PREV0000
          GOTO      PDSC9999
.
PDSC0300  CALL      CURSTD00
          GOTO      PDSC9999
.
PDSC0400  CALL      CUREND00
          GOTO      PDSC9999
.
PDSC0500  CALL      CURYR000
          GOTO      PDSC9999
.
PDSC0600  CALL      CURMON00
          GOTO      PDSC9999
.
PDSC0700  CALL      SELV0000
          GOTO      PDSC9999
.
PDSC0800  CALL      DTABA000        * Table of Discharges    
          GOTO      PDSC9999
.
PDSC0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PDSC9999
.
PDSC1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PDSC9999
.
PDSC1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PDSC9999
.
PDSC1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      PDSC9999
.
PDSC1300  CALL      TTABA000      * Table of Transfers
          GOTO      PDSC9999
.
PDSC1400  WRITE     HTMLFILE;DISCATDD;
          GOTO      PDSC9999
.
PDSC9999  RETURN
.------------------------------------------------------------
. Ward Admissions
.------------------------------------------------------------
PADM0000  BRANCH    FLDITMNO,PADM0100,PADM0200,PADM0300,PADM0400,PADM0500:
                             PADM0600,PADM0700,PADM0800,PADM0900,PADM1000:
                             PADM1100,PADM1200
          GOTO      PADM9999
.
PADM0100  CALL      NEXT0000
          GOTO      PADM9999
.
PADM0200  CALL      PREV0000
          GOTO      PADM9999
.
PADM0300  CALL      CURSTD00
          GOTO      PADM9999
.
PADM0400  CALL      CUREND00
          GOTO      PADM9999
.
PADM0500  CALL      CURYR000
          GOTO      PADM9999
.
PADM0600  CALL      CURMON00
          GOTO      PADM9999
.
PADM0700  CALL      SELV0000
          GOTO      PADM9999
.
PADM0800  CALL      ATABA000        * Table of Admissions    
          GOTO      PADM9999
.
PADM0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PADM9999
.
PADM1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PADM9999
.
PADM1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PADM9999
.
PADM1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      PADM9999
.
PADM9999  RETURN
.------------------------------------------------------------
. Ward selection
.------------------------------------------------------------
WSEL0000  PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70   
          ENDIF
          CALL      RDSWARD7
WSEL0100  CALL      RDKWARD7
          BRANCH    OVRCD,WSEL9999
.
.                         if we have a bed number we have passed all the ward 
.                         master records, so exit 
          MATCH     SP70,WBED
          GOTO      WSEL9999 IF NOT EQUAL  
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      WSEL0100 IF NOT EQUAL 
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      WSEL9999 IF NOT EQUAL
            ENDIF 
          ENDIF
.
.                       write the select option. 
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#""; 
          MATCH     DFLTWARD,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected"; 
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1 
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      WSEL0100 
.
WSEL9999  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABA000  MOVE      ZERO,RECNUMB
          IF        FHIRTYPE=0
            UNPACK    DIM127,D1,LINKPRG,DIM127
            UNPACK    DIM127,D1,LINKREP,DIM127
            UNPACK    DIM127,D1,LINKTEM,DIM127
            UNPACK    DIM127,D1,DLINKPRG,DIM127
            UNPACK    DIM127,D1,DLINKREP,DIM127
            UNPACK    DIM127,D1,DLINKTEM,DIM127
            CALL      CHEDA000      * Output Table Heading
          ENDIF
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    WINPUT,CTABA500
.
CTABA100  CALL      RDKWARD1
          BRANCH    OVRCD,CTABA700
          MATCH     WARDCODE,WWARD
          GOTO      CTABA700 IF NOT EQUAL
          BRANCH    WACTIVE,CTABA100     *Do not display inactive bed
.
          CALL      WRDROW00
          GOTO      CTABA100
.
. No Bed Ward
.------------------------------------------------------------
CTABA500  PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABA600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABA700
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABA700 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDA000         * Output Row Details
          GOTO      CTABA600
.
. On Leave Patients
.------------------------------------------------------------
CTABA700  MOVE      ONE,FIRSTONL
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABA800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABA950
          MATCH     OWARD,WARDCODE
          GOTO      CTABA950 IF NOT EQUAL
.
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABA800 IF EQUAL
.
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDA000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDA000         * Output Row Details
          GOTO      CTABA800
.
CTABA950  CALL      CENDA000         * Output End of Table
.
CTABA999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDA000  MOVE      WBDESC,KEY20 
          WRITE     HTMLFILE;"<tr>":
                               "<td colspan=5 align=center class=HeadingCell>":
                               "Current Admission for ":
                               KEY20,"</td>":
                             "</tr>":
                             "<tr>":
                               "<td class=HeadingCell>Bed</td>":
                               "<td class=HeadingCell>Patient</td>":
                               "<td class=HeadingCell>Diagnoses</td>":
                               "<td class=HeadingCell>Att. Doct.</td>":
                               "<td class=HeadingCell>Exp. Disch.</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. End of Table
.------------------------------------------------------------
CENDA000  BRANCH    FHIRTYPE,CENDA999
          WRITE     HTMLFILE;"<tr><td colspan=5>":
                             "<table border=0 align=center":
                             " width=100%>":
                             "<tr align=center><td width=40%></td>":
                             "<td class=AvailableCell align=center":
                             " width=10%>":
                             "Available Bed</td>":
                             "<td width=10% align=center class=StandbyCell>":
                             "Standby Patient":
                             "</td><td width=40%></td></tr>":
                             "</table></td></tr>"
CENDA999  RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDA000  BRANCH    FHIRTYPE,CRHDA999
          WRITE     HTMLFILE;"<tr><td colspan=5 align=center ":
                               "class=HeadingCell>",ROWHEAD,"</td></tr>"
CRHDA999  RETURN
.------------------------------------------------------------
. Current Admissions Empty Bed Row
.------------------------------------------------------------
CEMPA000  BRANCH    FHIRTYPE,CEMPA999
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                    "<td align=center class=AvailableCell>":
                    WBED,"</td>":
                    "<td align=center>*** Empty ***</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "</tr>";
CEMPA999  RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDA000  CALL      FHRCLR00                * Clear FHIR Encounter Variable
          CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          IF        FHIRTYPE=1
            CALL      FHRENC00
            GOTO      CBEDA999
          ENDIF
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          IF        STBYFLAG=0
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center>",WBED,"&nbsp;</td>"
          ELSE
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center class=StandbyCell>":
                               WBED,"&nbsp;</td>"
          ENDIF
.
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td>",ADIAG1,ADIAG2,"&nbsp;</td>":
                             "<td nowrap><A HREF=",DLINKPRG,".pbl":
                             "?reportno=",DLINKREP:
                             "&template=",DLINKTEM:
                             "&doctcode=",DOCTCODE,">":
                             DOCFNAME,"</a></td>":
                             "<td nowrap align=center>",EXPCTDSC,"</td>":
                             "</tr>";
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
CBEDA999  RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
WRDROW00  MATCH     ZEROVISN,WADMNO
          GOTO      WRDROW90 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDA000         * Output Row Details
.------------------------------------------------------------
.
          MATCH     ZEROVISN,WSTBY
          GOTO      WRDROW99 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDA000         * Output Row Details
.
          GOTO      WRDROW99
.
WRDROW90  CALL      CEMPA000         * Current Admissions Empty Bed Row
.
WRDROW99  RETURN
.---------------------------------------------------------------------------
. Patient Details from master file to display in table c
.   Requires ADMISSNO & URNUMBER to be set.
.   URNUMBER can be blank if a Valid Admission Record is Expected.
.---------------------------------------------------------------------------
GETPAT00  MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      AURNO,URNUMBER
          ENDIF
          MOVE      OVRCD,MISSFLAG
.
          MATCH     "       0",URNUMBER
          IF        @EQUAL
            MOVE      ADMISSNO,KEY8    
            CALL      RDPRAM1
            BRANCH    OVRCD,GETPAT95
          ELSE
            PACK      KEY8,URNUMBER
            CALL      RDMAST1
            BRANCH    OVRCD,GETPAT95
            PACK      KEY8,URNUMBER
            CALL      RDPMPX21
            BRANCH    OVRCD,GETPAT95
          ENDIF
.
          CALL      PATINT00                * Format Patient Name with Initial
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,ADOCTA
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
            PACK      SDOCFNAM,DOCFNAME
...         CALL      SDOCNM00
          ENDIF
.
GETPAT10  MOVE      SP70,DESCDPST
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          MATCH     SP70,PMWODPST
          IF        !@EQUAL
            PACK      KEY5,CATLVI,PMWODPST,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      PMWODPST,TDESC
            ENDIF
            MOVE     TDESC,DESCDPST
          ENDIF
.
          COMPARE   "999",ASTAY
          IF        @EQUAL
            PACK      EXPCTDSC,HYPHEN,SP70
            GOTO      GETPAT20
          ENDIF
.
          MATCH     SP70,PMWOEDAT 
          IF        !@EQUAL
            UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMWOEDTM
            MATCH     SP70,PMWOEDTM
            IF        @EQUAL
              PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
            ELSE
              PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY,ANST,PMWOEDTM,TIMEZONE,SP70
            ENDIF
            GOTO      GETPAT20
          ENDIF
.
          MOVE      CCC,CCENT
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY  
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
.
. Find if expected disch date is =,<, or > current date and set bgcolor flag
.
GETPAT20  MOVE      SP70,COLRFLAG
          PACK      EXPCDATE,CCENT,CYEAR,CMON,CDAY
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,EXPCDATE
          IF        @EQUAL
            MOVE      "CurrDischDate",COLRFLAG        * Set bgcolor to Current  
          ENDIF
          IF        @LESS 
            MOVE      "PastDischDate",COLRFLAG          * set bgcolor to past
          ENDIF
.
          PACK      KEY3,SP70
          PACK      KEY8,URNUMBER
          CALL      RDPMPX21
          BRANCH    OVRCD,GETPAT95
 
          MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXVALW
            MOVE      SP70,PMVXPALW
            MOVE      SP70,PMVXUDF2
            MOVE      SP70,PMVXPOWD
            MOVE      SP70,PMVXPOBD
          ENDIF
.
          GOTO      GETPAT99  
.
GETPAT95  MOVE      "Invalid Record",PSNAME 
          MOVE      SP70,PGNAME 
          MOVE      SP70,PTITL
          CALL      PATNAM00
.
GETPAT99  RETURN
.---------------------------------------------------------------------------
. Get Diet detailS from CATCOM record, using most recent record (not future)
.---------------------------------------------------------------------------
GTDIET00  MOVE      NBSP,DTDTTYPE
          MOVE      NBSP,DTASSLEV
          MOVE      NBSP,DTDTNNAM
          MOVE      NBSP,DTFASTNG
          CALL      CLPMSNUT                      * Clear record variables
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY16,ADMISSNO,CURRDATE,SP70  * set key to Admno + date
GTDIET10  CALL      RDPMNUT1 
          BRANCH    OVRCD,GTDIET99                * no data found - exit   
.
GTDIET20  MATCH     PMNUDTYP,SP3                  * is there a diet type
          GOTO      GTDIET30 IF EQUAL             * n - try next category code
          MOVE      CATMJ,CATEGORY                * y - translate the MJ cat.
          MOVE      PMNUDTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTDTTYPE                *   - store diet type desc
.
GTDIET30  MATCH     PMNUALVL,SP3                  * is there an assitance level
          GOTO      GTDIET40 IF EQUAL             * n - try next category code
          MOVE      CATMK,CATEGORY                * y - translate the MK cat.
          MOVE      PMNUALVL,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTASSLEV                *   - store assistance level
.
GTDIET40  MATCH     PMNUDCDE,SP10                 * is there a Dietitian ?     
          GOTO      GTDIET50 IF EQUAL
          PACK      KEY10,PMNUDCDE                * Yes get them from HCP file
          CALL      RDPMHCP1
          BRANCH    OVRCD,GTDIET50                
          MOVE      PMHCTITL,FMTTITLE             * Got them - set up name flds
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                      * Format name
          MOVE      DOCFNAME,DTDTNNAM             * Save name in work field
.
GTDIET50  MATCH     "1",PMNUFAST       
          GOTO      GTDIET99 IF NOT EQUAL
          MOVE      "Yes",DTFASTNG                * Patient is Fasting
.
GTDIET99  RETURN
.------------------------------------------------------------
. Get Anaesthetist info from Theatre tables                           *I-174468
.------------------------------------------------------------
GETAN000  UNPACK    SP70,ANATCODE,ANATNAME
          MOVE      ZERO,ANATFLAG
          CALL      IBACLOCK
          PACK      DIM8,CCC,CYY,CMM,CDD
          REP       " 0",DIM8
.
          MOVE      "2",KEY1
          PACK      KEY31,DAADMNO,KEY1,DIM8,Z20
          CALL      RSOPDEA2
GETAN100  CALL      RPOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,GETAN999
.
          MATCH     OPDAADMN,DAADMNO
          GOTO      GETAN999 IF NOT EQUAL
.
          COMPARE   TWO,OPDASTAT
          GOTO      GETAN999 IF NOT EQUAL
.
GETAN110  COMPARE   PTCNHDPS,ONE
          IF        !@EQUAL
            MATCH     DIM8,OPDADATE
            GOTO      GETAN999 IF NOT EQUAL
          ENDIF
.
          MOVE      ONE,ANATFLAG
.                                                * read Theatre Session for Ana.
          PACK      KEY22,OPDAHOSP,OPDADATE,OPDATIME,OPDACLIN,SP20
          CALL      RDOPSES1
          BRANCH    OVRCD,GETAN200
.
          MATCH     SP6,OPSEANAE                 * check Anaesthetist not blank
          GOTO      GETAN200 IF EQUAL
.
          MOVE      OPSEANAE,ANATCODE            * save "Anaesthetist" code
          GOTO      GETAN500
.                                                * if Anaesthetist was blank
GETAN200  MATCH     SP3,OPSEHOSP                 * read the Theatre Master for
.                                                * "Usual Anaesthetist"
          PACK      KEY21,OPSEHOSP,OPDACLIN,OPSEDAY,OPDATIME,OPSETHET,SP20
          CALL      RSOPSEM1
          CALL      RKOPSEM1
          BRANCH    OVRCD,GETAN999
.
          MATCH     OPSEHOSP,OPSMHOSP
          GOTO      GETAN999 IF NOT EQUAL
.
          MATCH     OPDACLIN,OPSMCLIN
          GOTO      GETAN999 IF NOT EQUAL
.
          MOVE      OPSEDAY,D1
          MATCH     D1,DOPSMDAY
          GOTO      GETAN999 IF NOT EQUAL
.
          MATCH     OPDATIME,OPSMTIME 
          GOTO      GETAN999 IF NOT EQUAL
.
          MATCH     SP6,OPSMANAE
          GOTO      GETAN999 IF EQUAL
.
          MOVE      OPSMANAE,ANATCODE            * save "Usual Anaesthetist" 
.
.
GETAN500  PACK      KEY6,ANATCODE,SP10 
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                   * format Doctor's name
            MOVE      DOCFNAME,ANATNAME
....        MOVE      SDOCFNAM,SAVDIM35          * save old data
....        CALL      SDOCNM00                   * format Short Doctor's name
....        MOVE      SDOCFNAM,ANATNAME
....        MOVE      SAVDIM35,SDOCFNAM          * restore old data
            STRIP     ANATNAME
          ENDIF
.
GETAN999  RETURN
.------------------------------------------------------------
. Displays Discharges for a Ward
.------------------------------------------------------------
DTABA000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY30,WARDCODE,FRSTDATE,SP70
          CALL      RDSTRAN4
DTABA100  CALL      RDKTRAN4
          BRANCH    OVRCD,DTABA900
          MATCH     WARDCODE,TWARD
          GOTO      DTABA900 IF NOT EQUAL
          MATCH     TDATE,LASTDATE
          GOTO      DTABA900 IF LESS
          MATCH     "D",TMOVE
          GOTO      DTABA100 IF NOT EQUAL
.
          CALL      DROWA000
          GOTO      DTABA100
DTABA900  
DTABA999  RETURN
.------------------------------------------------------------
. Discharges     Patient Details
.------------------------------------------------------------
DROWA000  PACK      ADMISSNO,TADMN
          PACK      URNUMBER,TURNO
          CALL      GETPAT00 
          CALL      PATLN000
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
.
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMISDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "&discatdd=",PATLINK
          APPEND    DISCATDD,PATLINK
          RESET     PATLINK
.
          IF        DISCATDD=1
            MOVE      CATDD,CATEGORY          * Hard code to use cat.DD
            MOVE      DDEST,CODE
            GOTO      DROWA100
          ENDIF
.                                                                     *C-140164
          IF        PTCNDRSM=1
            MOVE      CATD,CATEGORY
            MOVE      DSTAT,CODE
          ELSE
            MOVE      CATDD,CATEGORY          * Get Discharge Dest. Descrip.
            MOVE      DDEST,CODE
          ENDIF
.
DROWA100  CALL      GETCOD00
          MOVE      TDESC,DESTDESC
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",DDIAG,DDIAG2,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADATE,"#",":
                             "#"",DESTDESC,"#",":
                             "#"",DDATE,"#",":
                             "#"",PATLINK,"#",":
                             "#"",ADIAG1,ADIAG2,"#");"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
          RETURN
.------------------------------------------------------------
. Next Day, Week, Month
.------------------------------------------------------------
NEXT0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          REP       " +",FILTCLAI
          REP       " +",WARDCODE
          REP       " +",FILTEXPD
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&wardcode=",WARDCODE:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&viewtype=",VIEWTYPE:
                             "&discatdd=",DISCATDD:
                             "&filtdpst=",FILTDPST:
                             "&deftview=",DEFTVIEW:
                             "&selprint=",SELPRINT:
                             "&filtclai=",FILTCLAI:
                             "&filtexpd=",FILTEXPD:
                             "&filtexdy=",FILTEXDY; 
          REP       "+ ",FILTCLAI
          REP       "+ ",WARDCODE
          REP       "+ ",FILTEXPD
.
NEXT9999  RETURN
.------------------------------------------------------------
. Previous Day, Week, Month
.------------------------------------------------------------
PREV0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          REP       " +",FILTCLAI
          REP       " +",WARDCODE
          REP       " +",FILTEXPD
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&wardcode=",WARDCODE:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&viewtype=",VIEWTYPE:
                             "&discatdd=",DISCATDD:
                             "&filtdpst=",FILTDPST:
                             "&deftview=",DEFTVIEW:
                             "&selprint=",SELPRINT:
                             "&filtclai=",FILTCLAI:
                             "&filtexpd=",FILTEXPD:
                             "&filtexdy=",FILTEXDY; 
          REP       "+ ",FILTCLAI
          REP       "+ ",WARDCODE
          REP       "+ ",FILTEXPD
.
PREV9999  RETURN
.-----------------------------------------------------------
. Select Date From
.-----------------------------------------------------------
SELDAT00  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      DOCTCODE,KEY6
          MOVE      VIEWTYPE,KEY1
          WRITE     HTMLFILE;"<form name=SelectPeriod ":
                         "action=",LINKPRG,".pbl ":
                         "method=POST >":
                         "<input type=hidden name=reportno value=",LINKREP,">":
                         "<input type=hidden name=template value=",LINKTEM,">":
                         "<input type=hidden name=wardcode value=",WARDCODE,">":
                         "<input type=hidden name=viewtype value=",KEY1,">";
.
          CALL      SELV0000
.
          WRITE     HTMLFILE;"<input type=submit value=View>":
                             "</form>"
.
SELDAT99  RETURN
.------------------------------------------------------------
. Displays Admissions for a Ward
.------------------------------------------------------------
ATABA000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
.
...          CALL      AHEDA000      * Output Table Heading
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY30,WARDCODE,FRSTDATE,SP70
          CALL      RDSTRAN4
ATABA100  CALL      RDKTRAN4
          BRANCH    OVRCD,ATABA900
          MATCH     WARDCODE,TWARD
          GOTO      ATABA900 IF NOT EQUAL
          MATCH     TDATE,LASTDATE
          GOTO      ATABA900 IF LESS
          MATCH     "A",TMOVE
          GOTO      ATABA100 IF NOT EQUAL
.
          CALL      AROWA000
          GOTO      ATABA100
ATABA900  
ATABA999  RETURN
.------------------------------------------------------------
. Current Discharge Table Heading
.------------------------------------------------------------
AHEDA000  MOVE      WBDESC,KEY20 
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATESTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEEND,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=5 align=center class=HeadingCell>":
                             "Admissions for ",KEY20,"<br>":
                              DATESTR," to ",DATEEND,"</td>":
                             "</tr>":
                             "<tr>":
                             "<td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Diagnoses</td>":
                             "<td class=HeadingCell>Att. Doct.</td>":
                             "<td class=HeadingCell>Admission Date</td>":
                             "<td class=HeadingCell>Discharge Date</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. Discharges     Patient Details
.------------------------------------------------------------
AROWA000  PACK      ADMISSNO,TADMN
          PACK      URNUMBER,TURNO
          CALL      GETPAT00 
          CALL      PATLN000
          UNPACK    ADMISSNO,KEY2,KEY6
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
.            MATCH     SP70,DDATE
.            IF        !@EQUAL
.              UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
.              MOVE      CMON,F2
.              LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
.                                   SEP,OCT,NOV,DEC
.              PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.            ENDIF
.          ENDIF
.
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMISDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADATE,"#",":
                             "#"",DDATE,"#",":
                             "#"",DESTDESC,"#",":
                             "#"",PATLINK,"#");"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
          RETURN
.
.------------------------------------------------------------
. Ward Pre-Admissions
.------------------------------------------------------------
PPRE0000  BRANCH    FLDITMNO,PPRE0100,PPRE0200,PPRE0300,PPRE0400,PPRE0500:
                             PPRE0600,PPRE0700,PPRE0800,PPRE0900,PPRE1000:
                             PPRE1100,PPRE1200
          GOTO      PPRE9999
.
PPRE0100  CALL      NEXT0000
          GOTO      PPRE9999
.
PPRE0200  CALL      PREV0000
          GOTO      PPRE9999
.
PPRE0300  CALL      CURSTD00
          GOTO      PPRE9999
.
PPRE0400  CALL      CUREND00
          GOTO      PPRE9999
.
PPRE0500  CALL      CURYR000
          GOTO      PPRE9999
.
PPRE0600  CALL      CURMON00
          GOTO      PPRE9999
.
PPRE0700  CALL      SELV0000
          GOTO      PPRE9999
.
PPRE0800  CALL      PTABA000        * Table 
          GOTO      PPRE9999
.
PPRE0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PPRE9999
.
PPRE1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PPRE9999
.
PPRE1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PPRE9999
.
PPRE1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      PPRE9999
.
PPRE9999  RETURN
.------------------------------------------------------------
. Displays Pre-Admissions for a Ward
.------------------------------------------------------------
PTABA000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
.
...          CALL      PHEDA000      * Output Table Heading
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY20,ONE,SP70
          CALL      RDSMISS6
PTABA100  CALL      RDKMISS6
          BRANCH    OVRCD,PTABA900
          COMPARE   ONE,ASTAT
          GOTO      PTABA900 IF NOT EQUAL
          MATCH     WARDCODE,PTMIXWRD
          GOTO      PTABA100 IF NOT EQUAL
          MATCH     FRSTDATE,ADATE
          GOTO      PTABA100 IF LESS
          MATCH     ADATE,LASTDATE
          GOTO      PTABA100 IF LESS
.
          CALL      PROWA000
          GOTO      PTABA100
.
PTABA900  
PTABA999  RETURN
.------------------------------------------------------------
. Current Discharge Table Heading
.------------------------------------------------------------
PHEDA000  MOVE      WBDESC,KEY20 
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATESTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEEND,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=5 align=center class=HeadingCell>":
                             "Pre-Admissions for ",KEY20,"<br>":
                              DATESTR," to ",DATEEND,"</td>":
                             "</tr>":
                             "<tr>":
                             "<td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Diagnoses</td>":
                             "<td class=HeadingCell>Att. Doct.</td>":
                             "<td class=HeadingCell>Admission Date</td>":
                             "<td class=HeadingCell>Discharge Date</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. Pre Admissions     Patient Details
.------------------------------------------------------------
PROWA000  PACK      ADMISSNO,AADMNO
          PACK      URNUMBER,AURNO
          CALL      GETPAT00 
          CALL      PATLN000
          UNPACK    ADMISSNO,KEY2,KEY6
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMISDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK          
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          WRITE     HTMLFILE;"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADATE,"#",":
                             "#"",PATLINK,"#");"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
          RETURN
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
.
          CALL      CHEDB000      * Output Table Heading
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    WINPUT,CTABB500
.
          PACK      KEY16,WARDCODE,SP70
          CALL      RDSWARD8
CTABB100  CALL      RDKWARD8
          BRANCH    OVRCD,CTABB700
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABB700 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABB100 IF EQUAL
.
          BRANCH    WACTIVE,CTABB100     *Do not display inactive bed
.
          CALL      CROWB000
          GOTO      CTABB100
.
. No Bed Ward
.------------------------------------------------------------
CTABB500  PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABB600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABB700
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABB700 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDB000         * Output Row Details
          GOTO      CTABB600
.
. On Leave Patients
.------------------------------------------------------------
CTABB700  MOVE      ONE,FIRSTONL
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABB800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABB950
          MATCH     OWARD,WARDCODE
          GOTO      CTABB950 IF NOT EQUAL
.
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABB800 IF EQUAL
.
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDB000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDB000         * Output Row Details
          GOTO      CTABB800
CTABB950  CALL      CENDB000
CTABB999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDB000  PACK      KEY5,CODECO,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20
          ELSE
            MOVE      SP70,KEY20
          ENDIF
          WRITE     HTMLFILE;"<tr>":
                               "<td colspan=5 align=center class=HeadingCell>":
                               "Current Admission for ":
                               WBDESC,"</td>":
                             "</tr>":
                             "<tr>":
                               "<td class=HeadingCell>Bed</td>":
                               "<td class=HeadingCell>Patient</td>":
                               "<td class=HeadingCell>",KEY20,"</td>":
                               "<td class=HeadingCell>Att. Doct.</td>":
                               "<td class=HeadingCell>Exp. Disch.</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. End of Table
.------------------------------------------------------------
CENDB000  BRANCH    FHIRTYPE,CENDB999
          WRITE     HTMLFILE;"<tr><td colspan=5>":
                             "<table border=0 align=center":
                             " width=100%>":
                             "<tr align=center><td width=40%></td>":
                             "<td class=AvailableCell align=center":
                             " width=10%>":
                             "Available Bed</td>":
                             "<td width=10% align=center class=StandbyCell>":
                             "Standby Patient":
                             "</td><td width=40%></td></tr>":
                             "</table></td></tr>"
CENDB999  RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDB000  BRANCH    FHIRTYPE,CRHDB999
          WRITE     HTMLFILE;"<tr height=35><td colspan=5 align=center ":
                               "class=HeadingCell>",ROWHEAD,"</td></tr>"
CRHDB999  RETURN
.------------------------------------------------------------
. Current Admissions Empty Bed Row
.------------------------------------------------------------
CEMPB000  BRANCH    FHIRTYPE,CEMPB999
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                    "<td align=center class=AvailableCell>":
                    WBED,"</td>":
                    "<td align=center>*** Available ***</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "</tr>";
CEMPB999  RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDB000  CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          IF        STBYFLAG=0
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center>",WBED,"&nbsp;</td>"
          ELSE
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center class=StandbyCell>":
                               WBED,"&nbsp;</td>"
          ENDIF
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>";
.
          CALL      GETCON00 * Get Patient Condition Details
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"<td>":
                             "<img src=../images/",IMGSRC," class=ListIcon ":
                             " onclick='UpdateCondition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             CONDESC,DISPDATE,SP1:
                             LPCONDD,"</TD>";
.
          WRITE     HTMLFILE;"<td nowrap><a href='":
                             "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                             DOCFNAME,"</a></td>":
                             "<td nowrap align=center class=",COLRFLAG,">":
                             EXPCTDSC,"</td>":
                             "</tr>";
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDB999  RETURN
+
.------------------------------------------------------------
.         Get Patient Condition Details
.------------------------------------------------------------
GETCON00  MOVE      SP70,CONDESC1
          MOVE      SP70,SAVKEY27
.
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          BRANCH    OVRCD,GETCON10
.
          MATCH     SP70,LPCONDC
          GOTO      GETCON15 IF EQUAL
.
          PACK      KEY5,CODECO,LPCONDC
          CALL      RDCODE1
          BRANCH    OVRCD,GETCON15
          MOVE      TDESC,CONDESC
          MOVE      TDESC,CONDESC1
          MATCH     SP70,TCINDC1
          IF        @EQUAL
            MOVE      ZERO,TCINDC1
          ENDIF
          GOTO      GETCON20
.
GETCON10  MOVE      SP70,LPCONDD
          MOVE      SP70,LPCONDC
          MOVE      SP70,LPCDATE
          MOVE      SP70,LPCTIME
          MOVE      SP70,LPCONAM
GETCON15  MOVE      SP70,CONDESC
          MOVE      ZERO,TCINDC1
.
GETCON20  CLEAR     IMGSRC
          APPEND    "ConditionIcon_",IMGSRC
          IF        PCEASE=1
            APPEND    "D",IMGSRC
            MOVE      "Deceased",CONDESC
          ELSE
            APPEND    TCINDC1,IMGSRC
          ENDIF
          APPEND    ".gif",IMGSRC
          RESET     IMGSRC
.
GETCON50  PACK      KEY8,AADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
            PACK      WORKDESC,SP70,SP70,SP70,SP70
            GOTO      GETCON80
          ENDIF
.
          PACK      WORKDESC,SP70,SP70,SP70,SP70
.
          MATCH     "1",STVVIEW
          GOTO      GETCON60 IF EQUAL
.
          CLEAR     WORKDESC
.
          MATCH     SP70,PMWOWDI1
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PMWOWDI1,WORKDESC
          ENDIF
.
          MATCH     SP70,PMWOWDI2
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PMWOWDI2,WORKDESC
          ENDIF
.
          MATCH     SP70,PMWOWDI3
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PMWOWDI3,WORKDESC
          ENDIF
.
          APPEND    "&nbsp;",WORKDESC
          RESET     WORKDESC
          GOTO      GETCON80
.
GETCON60  MOVE      AURNO,PTATR001
          MOVE      AADMNO,PTATR002
          MOVE      "002",PTATR005     * Stored Working Diagnosis
          CALL      GETPAN00           * Get Patient Attribute Notes
.
GETCON80  MOVE      ZERO,MVFLAG
          COMPARE   ONE,DISPMV
          GOTO      GETCON99 IF NOT EQUAL   * Not displaying Mechanical Vent.
.
          PACK      KEY27,DAADMNO,SP70
          CALL      RSPTVEN1
GETCON82  CALL      RKPTVEN1
          BRANCH    OVRCD,GETCON99
.
          MATCH     DAADMNO,PTVEVISN
          GOTO      GETCON99 IF NOT EQUAL
.
          MATCH     SP70,PTVEEDAT
          GOTO      GETCON88 IF EQUAL
.
          MATCH     SP70,PTVEETIM
          GOTO      GETCON82 IF NOT EQUAL    * completed
.
GETCON88  MOVE      ONE,MVFLAG
          PACK      SAVKEY27,PTVEVISN,PTVEVTYP,PTVESDAT,PTVESTIM,SP70
.
GETCON99  RETURN
+
.------------------------------------------------------------------------------
.         Get Patient Attribute Notes (Patient Condition Details list output)
.------------------------------------------------------------------------------
GETPAN00  CLEAR     WORKDESC
          MOVE      ZERO,F1
          PACK      KEY35,PTATR001,PTATR002,PTATR005,SP70
          CALL      RSPTATR3
GETPAN10  CALL      RKPTATR3
          BRANCH    OVRCD,GETPAN90
.
          MATCH     PTATR001,PTARURNO
          GOTO      GETPAN90 IF NOT EQUAL
.
          MATCH     PTATR002,PTARVISN
          GOTO      GETPAN90 IF NOT EQUAL
.
          MATCH     PTATR005,PTARTYPE
          GOTO      GETPAN10 IF NOT EQUAL
.
          MATCH     SP70,PTARTXT1
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PTARTXT1,WORKDESC
            MOVE      ONE,F1
          ENDIF
.
          MATCH     SP70,PTARTXT2
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PTARTXT2,WORKDESC
            MOVE      ONE,F1
          ENDIF
.
          MATCH     SP70,PTARTXT3
          IF        !@EQUAL
            APPEND    "<br>",WORKDESC
            APPEND    PTARTXT3,WORKDESC
            MOVE      ONE,F1
          ENDIF
.
          IF        F1=1
            APPEND    "<br>",WORKDESC
          ENDIF
.
GETPAN90  RESET     WORKDESC
          GOTO      GETPAN99
.
GETPAN99  RETURN
+
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWB000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWB900 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDB000         * Output Row Details
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWB999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDB000         * Output Row Details
.
          GOTO      CROWB999
.
CROWB900  CALL      CEMPB000         * Current Admissions Empty Bed Row
.
CROWB999  RETURN
.------------------------------------------------------------
. Update Patient Condition
.------------------------------------------------------------
UPDCON00  UNPACK    ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,UPDCON99
.
          BRANCH    UPWORKDG,UPDCON25  * only updating pmsworaf
.
          MATCH     "1",CALCEXLS
          IF        @EQUAL
            UNPACK    ADMISSNO,KEY8
            CALL      RDMISS1
            BRANCH    OVRCD,UPDCON99
.
            MATCH     SP70,PMSWO005
            IF        	!@EQUAL & !@EOS
              MATCH       SP70,ADATE
              IF          !@EQUAL & !@EOS
                MOVE        ADATE,CDYSFDTE
                MOVE        PMSWO005,CDYSTDTE
                CALL        CALCDAYS
                SUB         ONE,CDYSDAYS
                MOVE        CDYSDAYS,ASTAY
                CALL        UPMISS1
              ENDIF
            ENDIF 
          ENDIF
.
          MATCH     "1",NEXTPATF
          IF        !@EQUAL
            UNPACK    ADMISSNO,KEY8
            CALL      RDMISS1
            BRANCH    OVRCD,UPDCON99
            MOVE      AURNO,KEY8
.
            MATCH     Z70,PTMIS038
            IF        !@EQUAL
              MOVE      PTMIS038,AUSR2
              CALL      UPMISS1    
            ENDIF
.
          ELSE
            MOVE      URNUMBER,KEY8
            MOVE      ADMISSNO,AADMNO
            MOVE      SP10,ADATE
          ENDIF
          CALL      RDMAST1
          CALL      RDPMPX21
.
          MOVE      SP70,LPCONDC
          MOVE      SP70,LPCONDD
          MOVE      SP70,LPCDATE
          MOVE      SP70,LPCTIME
          CALL      IBACLOCK
.
          PACK      KEY88,PTMASNAM,PMPXFNAM,AADMNO
          CALL      RDLOCA1
          IF        OVRCD=0
            MOVE      PATCONCD,LPCONDC
            MOVE      PATCONDS,LPCONDD
            MOVE      PATCONAM,LPCONAM         * Ambulatory status
            PACK      LPCDATE,CCC,CYY,CMM,CDD
            REP       " 0",LPCDATE
            MOVE      CTIMEIS,LPCTIME
            CALL      UPLOCA1
          ENDIF
.
          CALL      UPUDF000                * Update User Defined Comments
.
          COMPARE   ZERO,WDIGFLAG           * Do not update PMSWORFD
          GOTO      UPDCON30 IF EQUAL
.
          CALL      ADDWOR00                * Set working diagnosis comments
.
          CALL      ADDHIS00                * Set History Comments 
.
UPDCON25  PACK      KEY8,AADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
            MOVE      AADMNO,PMWOADMN
            CALL      MVPMWO00
            PACK      PMWOCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMWOCDAT
            CLOCK     TIME,PMWOCTIM
            MOVE      USERID,PMWOCUID
            CALL      WRPMWOR1
          ELSE
            CALL      MVPMWO00
            PACK      PMWOUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMWOUDAT
            CLOCK     TIME,PMWOUTIM
            MOVE      USERID,PMWOUUID
            CALL      UPPMWOR1
          ENDIF
          BRANCH    UPWORKDG,UPDCON99 * only updating pmsworaf
.
          MATCH     "1",PTCNBMAN            * update patbmdaf if in use
          IF        @EQUAL
            PACK      KEY30,AADMNO,SP70
            CALL      RDSTRAN2
            CALL      RDKTRAN2
            BRANCH    OVRCD,UPDCON30
.
            MATCH     DAADMNO,DTADMN
            GOTO      UPDCON30 IF NOT EQUAL
.
            MATCH     "A",TMOVE
            GOTO      UPDCON30 IF NOT EQUAL
.
            MOVE      TDATE,TRANDATE
            MOVE      TTIME,TRANTIME
            MOVE      TWARD,TRNTOWRD
            MOVE      TBED,TRNTOBED
.
            UNPACK    ADMISSNO,KEY8
            CALL      RDMISS1
            BRANCH    OVRCD,UPDCON30
.
            MATCH     SP70,PMWOEDAT
            IF        @EQUAL
              MOVE      ASTAY,STAYDAYS
            ELSE
              DAYSEP    TDATE,PMWOEDAT,STAYDAYS
            ENDIF
            CALL      UPPBMN00              * Write to bed management table
          ENDIF
.
UPDCON30  MOVE      SP70,PMVXVALW
          MOVE      SP70,PMVXPALW
.         MOVE      SP70,PMVXUDF2
          MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,UPDCON99
.
          MATCH     SP70,DISWAFIL
          IF        !@EQUAL
            CALL      DIDEUC00
          ENDIF
.
          MATCH     SP10,ADATE
          IF        !@EQUAL 
            MOVE      ADATE,PMVXVSDT
          ENDIF
          MOVE      PPOST,PMVXPOST
          MOVE      PPOST,D8
          SQUEEZE   D8
          MOVE      D8,F4
          MOVE      F4,D4
          REP       " 0",D4
          PACK      PPOST,D4,SP10
          PACK      KEY56,PPOST,PSUBRB,SP10,PADD4,SP70                *C-240184
          CALL      RDIBPOS1
          IF        OVRCD=0
            MOVE      IBPOASGC,PMVXASGC
          ELSE                                                        *I-240184
            PACK      KEY56,PPOST,PSUBRB,SP70
            CALL      RSIBPOS1
            CALL      RKIBPOS1
            BRANCH    OVRCD,UPDCON40
            MATCH     PPOST,IBPOPCOD
            IF        @EQUAL
              MATCH     PSUBRB,IBPOSUBR
              IF        @EQUAL
                MOVE      IBPOASGC,PMVXASGC
              ENDIF
            ENDIF
          ENDIF
.
UPDCON40  MOVE      PATCONVA,PMVXVALW
          MOVE      PATCONPA,PMVXPALW
          MATCH     PATCONTL,Z70
          IF        !@EQUAL
            MOVE      PATCONTL,PMVXUDF2
          ENDIF
          MOVE      PTMIS042,PMVXUD12
          CALL      MVVXTF00

          CALL      UPPMVX11
.
          CALL      UPATRA00
          CALL      UPATRB00
          CALL      UPDSC000
.
.         Get the discharge details (if available) prior to sending an A08
.
          CALL      CLPATDSC                     * clear discharge variables
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1
.
.         Get the last transfer record for the admission prior to
.         sending an A08
.
          PACK      KEY30,AADMNO,Z70
          CALL      RDSTRAN2                  * position on admission
          CALL      RDPTRAN2                  * read previous record
          BRANCH    OVRCD,UPDCON99            * eof - shouldn't happen
.
          MATCH     AADMNO,TADMN              * same admission still ?
          GOTO      UPDCON99 IF NOT EQUAL     * no - shouldn't happen
.
.         Get the PRA details prior to sending an A08
.
          CALL      CLRRES00
          MOVE      AADMNO,KEY8
          CALL      RDPTRES1
.
          CALL      PMIGTNID                  * get national id
          MOVE      NMPNUMB,PTNINMPI
          MOVE      TWO,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICAC                  * broadcast admission update
.
          CALL      VBCMN000
.
.         Update Patient Attribute notes (Working Diag, Relevant Med History,
.         Barriers to Discharge)
.
          MATCH     Z70,ATWDIAFN
          IF        !@EQUAL
            MOVE      ATWDIAFN,ATTMPFIL     * Working Diagnosis
            CALL      MOVATF00              * Read notes from temp file
            MOVE      URNUMBER,PTATR001
            MOVE      ADMISSNO,PTATR002
            MOVE      "002",PTATR005
            CALL      UPDNOT00              * Update Attribute Text Fields 1-3
            CLOSE     ATTMPFAF,DELETE
          ENDIF
.
          MATCH     Z70,ATMHISFN
          IF        !@EQUAL
            MOVE      ATMHISFN,ATTMPFIL     * Relevant Medical History
            CALL      MOVATF00              * Read notes from temp file
            MOVE      URNUMBER,PTATR001
            MOVE      ADMISSNO,PTATR002
            MOVE      "003",PTATR005
            CALL      UPDNOT00              * Update Attribute Text Fields 1-3
            CLOSE     ATTMPFAF,DELETE
          ENDIF
.
          MATCH     Z70,ATBDISFN
          IF        !@EQUAL
            MOVE      ATBDISFN,ATTMPFIL     * Barriers to Discharge
            CALL      MOVATF00              * Read notes from temp file
            MOVE      URNUMBER,PTATR001
            MOVE      ADMISSNO,PTATR002
            MOVE      "004",PTATR005
            CALL      UPDNOT00              * Update Attribute Text Fields 1-3
            CLOSE     ATTMPFAF,DELETE
          ENDIF
.
          CALL      UXDC0000
.
UPDCON99  CLOSE     PMHFILAF,DELETE
          CLOSE     WDIFILAF,DELETE
          CLOSE     CLNFILAF,DELETE
          CLOSE     WORCOMAF,DELETE
          CLOSE     HISCOMAF,DELETE
          CLOSE     COMFILDF,DELETE
          RETURN
.
.-------------------------------------------------------------------------------
. Update patient attribute details for attribute type "023"
.-------------------------------------------------------------------------------
UPATRA00  CALL      CLPATATR
          MOVE      AURNO,PTARURNO
          MOVE      DAADMNO,PTARVISN
          MOVE      "023",PTARTYPE
          PACK      PTARDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTARDATE
          CALL      IBACLOCK
          CLOCK     TIME,PTARTIME
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARTYPE,PTARDATE,PTARTIME,SP70
          CALL      RDPTATR3
          IF        OVRCD=1
            MOVE      "0",PTARDELR
            MOVE      USERID,PTARCUSR
            MOVE      PTARDATE,PTARCDTE
            MOVE      PTARTIME,PTARCTME
.
            CALL      MVATRA00
            CALL      WRPTATR3
          ELSE
            MOVE      "0",PTARDELR
            MOVE      USERID,PTARCUSR
            MOVE      PTARDATE,PTARCDTE
            MOVE      PTARTIME,PTARCTME
.
            CALL      MVATRA00
            CALL      UPPTATR3
          ENDIF
.
UPATRA99  RETURN
.-------------------------------------------------------------------------------
. Writing or updating patatraf - "028" 
.-------------------------------------------------------------------------------
DIDEUC00  MOVE      "028",ATRTYPE
          CALL      GPTATR00
          MOVE      SP70,DIDENEWR
.
          MATCH     SP70,PTATR014
          IF        !@EQUAL & !@EOS
            UNPACK    PTATR014,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00
            MOVE      SP70,PTATR014
            PACK      PTATR014,CCENT,CYEAR,CMON,CDAY
.           REP       " 0",PTATR014
          ENDIF
.

          IF        NOTFOUND = 1
.
            MATCH     SP70,PTATR014
            GOTO      DIDEUC99 IF EQUAL
            GOTO      DIDEUC99 IF EOS
.
            GOTO      DIDEUC50
          ELSE
            PACK      KEY35,PTARURNO,PTARVISN,PTARDATE,PTARTIME,PTARTYPE,SP70
            CALL      RDPTATR2
            BRANCH    OVRCD,DIDEUC99

            MATCH     SP70,PTARTXT1
            IF        @EQUAL
              MOVE      PTATR014,PTARTXT1
            ELSE
              MATCH     SP70,PTATR014
              IF        @EQUAL | @EOS
                MOVE      "1",PTARDELR
              ELSE
                MOVE      "1",PTARDELR
                MOVE      "1",DIDENEWR
              ENDIF
            ENDIF

            MATCH     SP70,PTARTXT2
            IF        @EQUAL
              MOVE      PTATR015,PTARTXT2
            ELSE
              MATCH     SP70,PTATR015
              IF        @EQUAL | @EOS
                MOVE      "1",PTARDELR
              ELSE
                MOVE      "1",PTARDELR
                MOVE      "1",DIDENEWR
              ENDIF
            ENDIF
.
            MATCH     SP70,PTARCOD1
            IF        !@EQUAL & !@EOS
              MATCH     SP70,PTDSC005
              IF        @EQUAL | @EOS
                MOVE      "1",PTARDELR
              ELSE
                MOVE      "1",PTARDELR
                MOVE      "1",DIDENEWR
              ENDIF
            ENDIF
.
            MATCH     SP70,PTARCOD2
            IF        !@EQUAL & !@EOS
              MATCH     SP70,PTDSC006
              IF        @EQUAL | @EOS
                MOVE      "1",PTARDELR
              ELSE
                MOVE      "1",PTARDELR
                MOVE      "1",DIDENEWR
              ENDIF
            ENDIF
.
            MATCH      "1",PTARDELR
            IF         @EQUAL
              MOVE      USERID,PTARFUSR
              CALL      IBACLOCK
              PACK      PTARFDTE,CCC,CYY,CMM,CDD
              REP       " 0",PTARFDTE
              CLOCK     TIME,PTARFTME
            ENDIF
.
.            MOVE      PTDSC005,PTARCOD1
.            MOVE      PTDSC006,PTARCOD2

            CALL      UPPTATR2

            MATCH     SP70,DIDENEWR
            IF        !@EQUAL
              GOTO      DIDEUC50
            ENDIF

            GOTO      DIDEUC99

          ENDIF

DIDEUC50  CALL      CLPATATR
          MOVE      URNUMBER,PTARURNO
          MOVE      ADMISSNO,PTARVISN
          CALL      IBACLOCK
          PACK      PTARDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTARDATE
          CLOCK     TIME,PTARTIME
.
          MOVE      USERID,PTARCUSR
          MOVE      PTARDATE,PTARCDTE
          MOVE      PTARTIME,PTARCTME
.
          MOVE      "028", PTARTYPE
.
          MOVE      PTATR014,PTARTXT1
          MOVE      PTATR015,PTARTXT2
          MOVE      PTDSC005,PTARCOD1
          MOVE      PTDSC006,PTARCOD2
          MOVE      "0",PTARDELR

          PACK      KEY35,PTARURNO,PTARVISN,PTARTYPE,PTARDATE,PTARTIME,SP70
          CALL      WRPTATR3

DIDEUC99  RETURN
.-------------------------------------------------------------------------------
. Setup changed data for patient attribute details for attribute type "023"
.-------------------------------------------------------------------------------
MVATRA00  MOVE      PTMIS039,PTARCOD1
.
          MATCH     PTMIS041,Z70
          IF        !@EQUAL
            MOVE      PTMIS041,PTARCOD2
          ENDIF
.
          MATCH     PTMIS043,Z70
          IF        !@EQUAL
            MOVE      PTMIS043,PTARCOD3
          ENDIF
.
          MATCH     PTMIS044,Z70
          IF        !@EQUAL
            MOVE      PTMIS044,PTARCOD4
          ENDIF
.
MVATRA99  RETURN
.
.-------------------------------------------------------------------------------
. Insert a new patient attribute details for attribute type "024"
.-------------------------------------------------------------------------------
UPATRB00  CALL      CLPATATR
          MOVE      AURNO,PTARURNO 
          MOVE      DAADMNO,PTARVISN
          MOVE      "024",PTARTYPE
          PACK      PTARDATE,CCC,CYY,CMM,CDD
          REP       " 0",PTARDATE
          CALL      IBACLOCK
          CLOCK     TIME,PTARTIME
.
          PACK      KEY35,PTARURNO,PTARVISN,PTARTYPE,PTARDATE,PTARTIME,SP70
          CALL      RDPTATR3
          IF        OVRCD=1
            MOVE      "0",PTARDELR
            MOVE      USERID,PTARCUSR
            MOVE      PTARDATE,PTARCDTE
            MOVE      PTARTIME,PTARCTME
.
            CALL      MVATRB00
            CALL      WRPTATR3
          ELSE
            MOVE      "0",PTARDELR
            MOVE      USERID,PTARCUSR
            MOVE      PTARDATE,PTARCDTE
            MOVE      PTARTIME,PTARCTME
.
            CALL      MVATRB00
            CALL      UPPTATR3
          ENDIF
.
UPATRB99  RETURN
.
.-------------------------------------------------------------------------------
. Setup changed data for patient attribute details for attribute type "024"
.-------------------------------------------------------------------------------
MVATRB00  MATCH     PTMIS040,Z70
          IF        !@EQUAL
            MOVE      PTMIS040,PTARCOD1
          ENDIF
.
MVATRB99  RETURN
.
.------------------------------------------------------------
. Update User Defined Comments
.------------------------------------------------------------
UPUDF000  MOVE      ZERO,F3
          CALL      IBACLOCK
          PACK      KEY8,CCC,CYY,CMM,CDD
          REP       " 0",KEY8

UPUDF100  ADD       ONE,F3
          LOAD      KEY100,F3,USERDF01,USERDF02,USERDF03,USERDF04,USERDF05:
                              USERDF06,USERDF07,USERDF08,USERDF09,USERDF10
          MOVE      "018",VSCTTYPE
          MOVE      F3,KEY3
          PACK      KEY14,ADMISSNO,VSCTTYPE,KEY3,SP70
          CALL      RDVSCMT1
          IF        OVRCD=0
            MOVE      KEY100,VSCTDATA
            PACK      VSCTUKEY,KEY8,CTIMEIS,WBSEUID,SP70
            CALL      UPVSCMT1
          ELSE
            PACK      VSCTDATA,SP70,SP70
            MATCH     VSCTDATA,KEY100
            IF        !@EQUAL
              UNPACK    KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
              MOVE      KEY100,VSCTDATA
              MOVE      SP70,VSCTSPAR
              CALL      WRVSCMT1
            ENDIF
          ENDIF
          IF       F3<10
            GOTO     UPUDF100
          ENDIF
.
UPUDF999  RETURN
.------------------------------------------------------------
. Output Patient Condition Form
.------------------------------------------------------------
PATCON00  MOVE      ZERO,MASTFLAG
          MOVE      ZERO,MISSFLAG
          MOVE      SP70,DOCTCODE
          UNPACK    URNUMBER,KEY2,KEY6
          MOVE      URNUMBER,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,PATCON90
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          MOVE      ADMISSNO,KEY8
          CALL      RDPMVX11
          IF        OVRCD=1
           CALL       CPVXTF00
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CPPMWO00
          ENDIF
.
          UNPACK    ADMISSNO,KEY2,KEY6
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,PATCON95
          BRANCH    ASTAT,PATCON96,PATCON10,PATCON96,PATCON10,PATCON96
.
PATCON10  CALL      RGMCOD00   * Get Regime Codes
          CALL      GETCON00   * Get Patients Current Condition
          CALL      PATNAA00   * Format Patient Name without bold
.
          CLEAR     WEBTITLE
          APPEND    "Update Patient Condition - ",WEBTITLE
          APPEND    SP1,WEBTITLE
          APPEND    PATFNAME,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PATCON99
.
          CALL      WEBBOD00   * Output Templated Body of HTML 
.
          CALL      WEBEND00   * Output End of Web Page
          GOTO      PATCON99
.
PATCON90  MOVE      "INVALID U/R NO",WEBTITLE
          CALL      WEBERR00
          GOTO      PATCON99
.
PATCON95  MOVE      "INVALID ADMISSION NO",WEBTITLE
          CALL      WEBERR00
          GOTO      PATCON99
.
PATCON96  MOVE      "ADMISSION IS NOT CURRENT",WEBTITLE
          CALL      WEBERR00
          GOTO      PATCON99
.
PATCON99  RETURN
+
.------------------------------------------------------------
. Patient Condition Form
.------------------------------------------------------------
CONF0000  BRANCH    FLDITMNO,CONF0100,CONF0200,CONF0300,CONF0400,CONF0500:
                             CONF0600,CONF0700,CONF0800,CONF0900,CONF1000:
                             CONF1100,CONF1200,CONF1300,CONF1400,CONF1500:
                             CONF1600,CONF1700,CONF1800,CONF1900,CONF2000:
                             CONF2100,CONF2200,CONF2300,CONF2400,CONF2500:
                             CONF2600,CONF2700,CONF2800,CONF2900,CONF3000:
                             CONF3100,CONF3200,CONF3300,CONF3400,CONF3500:
                             CONF3600 
.
          WRITE     HTMLFILE;"Invalid Tag in HTML";
          GOTO      CONF9999
.
CONF0100  WRITE     HTMLFILE;"action=#"patweb93.pbl#">":
                             "<input type=hidden name=reportno value=6>":
                             "<input type=hidden name=template ":
                             "value=",KEY3,">":
                             "<input type=hidden name=urnumber ":
                             "value=#"",URNUMBER,"#">":
                             "<input type=hidden name=admissno ":
                             "value=#"",ADMISSNO,"#">"
          GOTO      CONF9999
.
CONF0200  MOVE      CODECO,CATEGORY
          MOVE      LPCONDC,CODE
          CALL      CODSEL00
          GOTO      CONF9999
.
CONF0300  MATCH     SP70,LPCONDD
          GOTO      CONF9999 IF EQUAL 
          WRITE     HTMLFILE;LPCONDD;
          GOTO      CONF9999
.
CONF0400  WRITE     HTMLFILE;LPCONDC;
          GOTO      CONF9999
.
CONF0500  WRITE     HTMLFILE;CONDESC;
          GOTO      CONF9999
.
CONF0600  CALL      VISFLG00
          GOTO      CONF9999
.
CONF0700  MOVE      CODEAM,CATEGORY
          MOVE      LPCONAM,CODE
          CALL      CODSEL00
          GOTO      CONF9999
.
CONF0800  PACK      KEY16,LPCDATE,LPCTIME,SP10 * move t/stamp into parm
          CALL      TSTMP000                   * reformat t/stamp
          WRITE     HTMLFILE;KEY20;            * Output last update datetime
          GOTO      CONF9999
.
CONF0900  MOVE      "U2",CATEGORY
          MOVE      AUSR2,CODE
          CALL      CODITM00
          GOTO      CONF9999
.
CONF1000  CALL      MCMN0000
          GOTO      CONF9999
.
CONF1100  CALL      WCMN0000
          GOTO      CONF9999
.
CONF1200  CALL      CCMN0000
          GOTO      CONF9999
.
CONF1300  CALL      USDEF000
          GOTO      CONF9999
.
CONF1400  WRITE     HTMLFILE;RGMCOD01;  
          GOTO      CONF9999
.
CONF1500  WRITE     HTMLFILE;RGMCOD02;
          GOTO      CONF9999
.
CONF1600  WRITE     HTMLFILE;RGMCOD03;
          GOTO      CONF9999
.
CONF1700  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "5",ATTYPIND       * Attribute Type 5 ('Falls Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF1800  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "6",ATTYPIND       * Attr Type 6 ('Pressure Injury Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF1900  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "7",ATTYPIND       * Attr Type 7 ('Abscond Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF2000  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "8",ATTYPIND       * Attr Type 8 ('Malnutrition Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF2100  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "9",ATTYPIND       * Attr Type 9 ('Exp disch dest')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF2200  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "10",ATTYPIND      * Attr Type 10 ('Non Weight Bearing')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          WRITE     HTMLFILE;ATCODVAL;
          GOTO      CONF9999
.
CONF2300  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "9",ATTYPIND       * Attr Type 9 ('Expected Discharge Dest')
          MOVE      "1",ATCODIND       * Attribute Text Field 1
          CALL      GETTFV00           * Get Attribute Text Field value
          WRITE     HTMLFILE;ATTXTVAL;
          GOTO      CONF9999
.
CONF2400  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "002",PTATR005
          CALL      GETNTE00
          GOTO      CONF9999
.
CONF2500  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "003",PTATR005
          CALL      GETNTE00
          GOTO      CONF9999
.
CONF2600  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          MOVE      "004",PTATR005
          CALL      GETNTE00
          GOTO      CONF9999
.
CONF2700  CALL      PAEXST00
          GOTO      CONF9999
.
CONF2800  CALL      GETATD00      * Get time diff (mins) adm to last disch
          GOTO      CONF9999
.
CONF2900  CALL      LSTADM00      * Get last discharge admno
          GOTO      CONF9999
.
CONF3000  CALL      ATRFA000
          GOTO      CONF9999
.
CONF3100  CALL      ATRFB000 
          GOTO      CONF9999
.
CONF3200  CALL      VCMHTM00 
          GOTO      CONF9999
.
CONF3300  WRITE     HTMLFILE;FROMPATN;  
          GOTO      CONF9999
.
CONF3400  MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      ONE,VSDATIND            * Date Field index (1-10)
          CALL      GETVDT00
          MATCH     SP70,VSDATVAL
          IF        !@EQUAL
            UNPACK    VSDATVAL,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          ENDIF
          GOTO      CONF9999
.
CONF3500  MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      TWO,VSCODIND            * Code Field index (1-10)
          CALL      GETVCV00
.
          MATCH     SP70,VSCODVAL
          IF        !@EQUAL
            WRITE     HTMLFILE;VSCODVAL;
          ENDIF
          GOTO      CONF9999
.
CONF3600  CALL      ATRFC000
          GOTO      CONF9999
.
CONF9999  RETURN
+
.------------------------------------------------------------
. Get patient attribute details for admissno, urno, adm date,
. adm time and attribute type "023"
.------------------------------------------------------------
ATRFA000  UNPACK    DIM127,D1,SUBITMNO,DIM127
          MATCH     SP70,SUBITMNO
          GOTO      ATRFA999 IF EQUAL
          MOVE      SUBITMNO,SUBITMFO
.
          MOVE      "023",ATRTYPE
          PACK      KEY35,AURNO,DAADMNO,ATRTYPE,Z70
          CALL      RSPTATR3
ATRFA002  CALL      RPPTATR3
          BRANCH    OVRCD,ATRFA007
.
          MATCH     AURNO,PTARURNO
          GOTO      ATRFA007 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      ATRFA007 IF NOT EQUAL
.
          MATCH     ATRTYPE,PTARTYPE
          GOTO      ATRFA007 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      ATRFA002 IF EQUAL
.
          GOTO      ATRFA008
.
. No row found
.
ATRFA007  CALL      CLPATATR
.
ATRFA008  BRANCH    SUBITMFO,ATRFA010,ATRFA020,ATRFA030,ATRFA040,ATRFA050:
                             ATRFA060,ATRFA070,ATRFA080,ATRFA090,ATRFA100:
                             ATRFA110,ATRFA120
.
          GOTO      ATRFA999
.
ATRFA010  MOVE      PTARCOD1,DIM1
          WRITE     HTMLFILE;DIM1;
          GOTO      ATRFA999
.
ATRFA020  MOVE      "ZT",CATEGORY
          MOVE      PTARCOD2,CODE
          CALL      CODITM00
          GOTO      ATRFA999
.
ATRFA030  MOVE      PTARCOD3,DIM1
          WRITE     HTMLFILE;DIM1;
          GOTO      ATRFA999
.
ATRFA040  MOVE      "ZW",CATEGORY
          MOVE      PTARCOD4,CODE
          CALL      CODITM00
          GOTO      ATRFA999
.
ATRFA050  WRITE     HTMLFILE;PTARVAL1;
          GOTO      ATRFA999
.
ATRFA060  WRITE     HTMLFILE;PTARVAL2;
          GOTO      ATRFA999
.
ATRFA070  WRITE     HTMLFILE;PTARVAL3;
          GOTO      ATRFA999
.
ATRFA080  WRITE     HTMLFILE;PTARVAL4;
          GOTO      ATRFA999
.
ATRFA090  WRITE     HTMLFILE;PTARTXT1;
          GOTO      ATRFA999
.
ATRFA100  WRITE     HTMLFILE;PTARTXT2;
          GOTO      ATRFA999
.
ATRFA110  WRITE     HTMLFILE;PTARTXT3;
          GOTO      ATRFA999
.
ATRFA120  WRITE     HTMLFILE;PTARTXT4;
          GOTO      ATRFA999
.
ATRFA999  RETURN
.
.------------------------------------------------------------
. Get patient attribute details for admissno, urno, adm date,
. adm time and attribute type "024"
.------------------------------------------------------------
ATRFB000  UNPACK    DIM127,D1,SUBITMNO,DIM127
          MATCH     SP70,SUBITMNO
          GOTO      ATRFB999 IF EQUAL
          MOVE      SUBITMNO,SUBITMFO
.
          MOVE      "024",ATRTYPE
          PACK      KEY35,AURNO,DAADMNO,ATRTYPE,Z70
          CALL      RSPTATR3
ATRFB002  CALL      RPPTATR3
          BRANCH    OVRCD,ATRFB007
.
          MATCH     AURNO,PTARURNO
          GOTO      ATRFB007 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      ATRFB007 IF NOT EQUAL
.
          MATCH     ATRTYPE,PTARTYPE
          GOTO      ATRFB007 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      ATRFB002 IF EQUAL
.
          GOTO      ATRFB008
.
. No row found
.
ATRFB007  CALL      CLPATATR
.
ATRFB008  BRANCH    SUBITMFO,ATRFB010,ATRFB020,ATRFB030,ATRFB040,ATRFB050:
                             ATRFB060,ATRFB070,ATRFB080,ATRFB090,ATRFB100:
                             ATRFB110,ATRFB120
.
          GOTO      ATRFB999
.
ATRFB010  MOVE      "ZS",CATEGORY
          MOVE      PTARCOD1,CODE
          CALL      CODITM00
          GOTO      ATRFB999
.
ATRFB020  WRITE     HTMLFILE;PTARCOD2;
          GOTO      ATRFB999
.
ATRFB030  WRITE     HTMLFILE;PTARCOD3;
          GOTO      ATRFB999
.
ATRFB040  WRITE     HTMLFILE;PTARCOD4;
          GOTO      ATRFB999
.
ATRFB050  WRITE     HTMLFILE;PTARVAL1;
          GOTO      ATRFB999
.
ATRFB060  WRITE     HTMLFILE;PTARVAL2;
          GOTO      ATRFB999
.
ATRFB070  WRITE     HTMLFILE;PTARVAL3;
          GOTO      ATRFB999
.
ATRFB080  WRITE     HTMLFILE;PTARVAL4;
          GOTO      ATRFB999
.
ATRFB090  WRITE     HTMLFILE;PTARTXT1;
          GOTO      ATRFB999
.
ATRFB092  MATCH     SP70,PTARTXT1
          GOTO      ATRFB999 IF EQUAL
.
          UNPACK    PTARTXT1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          GOTO      ATRFB999
.
ATRFB100  WRITE     HTMLFILE;PTARTXT2;
          GOTO      ATRFB999
.
ATRFB110  WRITE     HTMLFILE;PTARTXT3;
          GOTO      ATRFB999
.
ATRFB120  WRITE     HTMLFILE;PTARTXT4;
          GOTO      ATRFB999
.
ATRFB999  RETURN
.
.------------------------------------------------------------
. Get patient attribute details for admissno, urno, adm date,
. adm time and attribute type "028"
.------------------------------------------------------------
ATRFC000  UNPACK    DIM127,D1,SUBITMNO,DIM127
          MATCH     SP70,SUBITMNO
          GOTO      ATRFC999 IF EQUAL
          RJUSTIFY  SUBITMNO          
          MOVE      SUBITMNO,SUBITMFO
.
          MOVE      "028",ATRTYPE                    
          PACK      KEY35,AURNO,DAADMNO,ATRTYPE,Z70
          CALL      RSPTATR3
ATRFC002  CALL      RPPTATR3
          BRANCH    OVRCD,ATRFC007
.
          MATCH     AURNO,PTARURNO
          GOTO      ATRFC007 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      ATRFC007 IF NOT EQUAL
.
          MATCH     ATRTYPE,PTARTYPE
          GOTO      ATRFC007 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      ATRFC002 IF EQUAL
.
          GOTO      ATRFC008
.
. No row found
.
ATRFC007  CALL      CLPATATR
.
ATRFC008  BRANCH    SUBITMFO,ATRFC010,ATRFC020,ATRFC030,ATRFC040,ATRFC050:
                             ATRFC060
.
          GOTO      ATRFC999
.
ATRFC010  MOVE      "z1",CATEGORY
          MOVE      PTARCOD1,CODE
          CALL      CODITM00
          GOTO      ATRFC999
.
ATRFC020  MOVE      "z1",CATEGORY
          MOVE      PTARCOD2,CODE
          CALL      CODITM00
          GOTO      ATRFC999
.
ATRFC030  MATCH     SP70,PTARTXT1
          GOTO      ATRFC999 IF EQUAL
.
          UNPACK    PTARTXT1,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
.
          GOTO      ATRFC999
.
ATRFC040  WRITE     HTMLFILE;PTARTXT2;
          GOTO      ATRFC999
.
ATRFC050  WRITE     HTMLFILE;PTARCOD1;
          GOTO      ATRFC999
.
ATRFC060  WRITE     HTMLFILE;PTARCOD2;
          GOTO      ATRFC999
.
ATRFC999  RETURN
.
.------------------------------------------------------------------------------
.         Check if Patient Attribute record exists for UR/Admno
.------------------------------------------------------------------------------
PAEXST00  PACK      KEY35,URNUMBER,SP70
          CALL      RSPTATR3
PAEXST10  CALL      RKPTATR3
          BRANCH    OVRCD,PAEXST91
.
          MATCH     PTARURNO,URNUMBER
          GOTO      PAEXST91 IF NOT EQUAL
.
          MATCH     PTARVISN,ADMISSNO
          GOTO      PAEXST10 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
          GOTO      PAEXST99
.
PAEXST91  WRITE     HTMLFILE;ZERO;
PAEXST99  RETURN
+
.------------------------------------------------------------------------------
.         Get the last discharge admission no.
.------------------------------------------------------------------------------
LSTADM00  PACK      KEY24,URNUMBER,Z70
          CALL      RDSDSCH3
LSTADM10  CALL      RDPDSCH3
          BRANCH    OVRCD,LSTADM99
.
          MATCH     DURNO,URNUMBER
          GOTO      LSTADM99 IF NOT EQUAL
.
          WRITE     HTMLFILE;DDADMNO;
.
LSTADM99  RETURN
+
.------------------------------------------------------------------------------
.         Get time difference (in minutes) between the current Admission and
.         last Discharge date/time.
.------------------------------------------------------------------------------
GETATD00  MOVE      ZERO,FORM4
          MOVE      ADMISSNO,KEY8
          CALL      RDMISS1
          BRANCH    OVRCD,GETATD99
.
          MATCH     "2",DASTAT
          GOTO      GETATD99 IF NOT EQUAL
.
          PACK      KEY24,URNUMBER,Z70
          CALL      RDSDSCH3
GETATD10  CALL      RDPDSCH3
          BRANCH    OVRCD,GETATD99
.
          MATCH     DURNO,URNUMBER
          GOTO      GETATD99 IF NOT EQUAL
.
          MOVE      DDATE,FIRSTDAT
          UNPACK    DTIME,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          MOVE      DIM5,FIRSTIME
.
          MOVE      ADATE,LASTDATE
          MOVE      ATIME,DIM5
          REP       ": ",DIM5
          SQUEEZE   DIM5
          MOVE      DIM5,LASTTIME
.
          CALL      TIMEDIFF
          MOVE      CALCTIME,MINSDIFF
          LJUSTIFY  MINSDIFF
          STRIP     MINSDIFF
          MOVELPTR  MINSDIFF,FORM6
          SFORMAT   VAR,FORM6
          MOVE      MINSDIFF,VAR
          WRITE     HTMLFILE;VAR;
.
GETATD99  RETURN
+
.------------------------------------------------------------
. Get User Defined Fields from Visit Comments
.------------------------------------------------------------
USDEF000  UNPACK    DIM127,D1,KEY3,DIM127
          MOVE      KEY3,F3
          MOVE      F3,KEY3
          MOVE      "018",VSCTTYPE
          PACK      KEY14,ADMISSNO,VSCTTYPE,KEY3,SP70
          CALL      RDVSCMT1
          IF        OVRCD=0
            WRITE     HTMLFILE;VSCTDATA;
          ENDIF
USDEF999  RETURN
.
.------------------------------------------------------------
. Get Visit Extension file flags.
.------------------------------------------------------------
VISFLG00  UNPACK    DIM127,D1,FLAGID,DIM127
          MATCH     SP1,FLAGID
          GOTO      VISFLG99 IF EQUAL
          MOVE      FLAGID,FLGITMNO
.
          MOVE      AADMNO,PMVXVISN            * Find Visit extension record
          PACK      KEY8,PMVXVISN,SP70
          CALL      RDPMVX11
          IF        OVRCD=1
            MOVE      SP70,PMVXVALW
            MOVE      SP70,PMVXPALW
            MOVE      SP70,PMVXUDF2
            GOTO      VISFLG99
          ENDIF
.
          BRANCH    FLGITMNO,VISFLG01,VISFLG02,VISFLG03,VISFLG04
.
          GOTO      VISFLG99
.
VISFLG01  WRITE     HTMLFILE;PMVXVALW;
          GOTO      VISFLG99
.
VISFLG02  WRITE     HTMLFILE;PMVXPALW;
          GOTO      VISFLG99
.
VISFLG03  WRITE     HTMLFILE;PMVXUDF2;
          GOTO      VISFLG99
.
VISFLG04  MOVE      "rT",CATEGORY
          MOVE      PMVXUD12,CODE
          CALL      CODITM00
          GOTO      CONF9999
.
VISFLG99  RETURN
.------------------------------------------------------------
. Ward Bookings 
.------------------------------------------------------------
PBOK0000  BRANCH    FLDITMNO,PBOK0100,PBOK0200,PBOK0300,PBOK0400,PBOK0500:
                             PBOK0600,PBOK0700,PBOK0800,PBOK0900,PBOK1000:
                             PBOK1100,PBOK1200,PBOK1300
          GOTO      PBOK9999
.
PBOK0100  CALL      NEXT0000
          GOTO      PBOK9999
.
PBOK0200  CALL      PREV0000
          GOTO      PBOK9999
.
PBOK0300  CALL      CURSTD00
          GOTO      PBOK9999
.
PBOK0400  CALL      CUREND00
          GOTO      PBOK9999
.
PBOK0500  CALL      CURYR000
          GOTO      PBOK9999
.
PBOK0600  CALL      CURMON00
          GOTO      PBOK9999
.
PBOK0700  CALL      SELV0000
          GOTO      PBOK9999
.
PBOK0800  CALL      BTABA000        * Table of Bookings Expected Discharge    
          GOTO      PBOK9999
.
PBOK0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      PBOK9999
.
PBOK1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      PBOK9999
.
PBOK1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      PBOK9999
.
PBOK1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      PBOK9999
.
PBOK1300  CALL      BTABB000        * Bookings Consultant and Diagnosis
          GOTO      PBOK9999
.
PBOK9999  RETURN
.------------------------------------------------------------
. Displays Bookings for a Ward with Expected Discharge
.------------------------------------------------------------
BTABA000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,OPTIONZ,DIM127
.
          CALL      BHEDA000      * Output Table  Heading
.
          CALL      IBACLOCK           
.          
          PACK      KEY19,WARDCODE,FRSTDATE,SP70
          CALL      RSBKREC7
BTABA100  CALL      RKBKREC7
          BRANCH    OVRCD,BTABA900
          MATCH     WARDCODE,BKREWARD
          GOTO      BTABA900 IF NOT EQUAL
          MATCH     BKREEDAT,LASTDATE
          GOTO      BTABA900 IF LESS
.
          MOVE      BKRESTAT,STATUS
.          
          PACK      BOOKSTAT,BOOKED,SP6
          MOVE      BKRESTAT,F1
          LOAD      BOOKSTAT,F1,PREADM,CANCEL,ADMITT,DISCHR
.
          REP       "aA",OPTIONZ 
          MATCH     "A",OPTIONZ
          GOTO      BTABA200 IF EQUAL 
.                
          MATCH     STATUS,OPTIONZ
          GOTO      BTABA100 IF NOT EQUAL  
.
BTABA200  PACK      KEY5,CAT,BKRETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,BTABA300
          MATCH     TCODE,CAT
          GOTO      BTABA300 IF NOT EQUAL
          MATCH     ACODE,BKRETYPE 
          GOTO      BTABA300 IF NOT EQUAL               
          MATCH     "THE ",THCSCOD
          IF        @EQUAL
            PACK      KEY31,BKREBOOK,SP70
            CALL      RSOPDEA2
            CALL      RKOPDEA2 
            BRANCH    OVRCD,BTABA300
            MOVE      BKREBOOK,DIM8
            MATCH     DIM8,OPDAADMN
            GOTO      BTABA300 IF NOT EQUAL
          ENDIF 
          MOVE      ZERO,TFLAG
          GOTO      BTABA400  
.
BTABA300  MOVE      ONE,TFLAG
.
BTABA400  CALL      BROWA000   * expected Bookings output 
          GOTO      BTABA100
.
BTABA900  
BTABA999  RETURN
.------------------------------------------------------------
. Displays Bookings for a Ward with Consultant and Diagnosis
.------------------------------------------------------------
BTABB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,OPTIONZ,DIM127
.
          CALL      IBACLOCK           
.          
          PACK      KEY16,FRSTDATE,SP70
          CALL      RSBKREC4
BTABB100  CALL      RKBKREC4
          BRANCH    OVRCD,BTABB900
.
          MATCH     BKREEDAT,LASTDATE
          GOTO      BTABB900 IF LESS
.
          PACK      KEY8,BKREBOOK,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,BTABB100
.
          MATCH     SP70,BKREWARD
          IF        @EQUAL
            MATCH     WARDCODE,BKRXPOWD
            GOTO      BTABB100 IF NOT EQUAL
          ELSE
            MATCH     WARDCODE,BKREWARD
            GOTO      BTABB100 IF NOT EQUAL
          ENDIF
.
          MOVE      BKRESTAT,STATUS
.          
          PACK      BOOKSTAT,BOOKED,SP6
          MOVE      BKRESTAT,F1
          LOAD      BOOKSTAT,F1,PREADM,CANCEL,ADMITT,DISCHR
.
          REP       "aA",OPTIONZ 
          MATCH     "A",OPTIONZ
          GOTO      BTABB200 IF EQUAL 
.                
          MATCH     STATUS,OPTIONZ
          GOTO      BTABB100 IF NOT EQUAL  
.
BTABB200  PACK      KEY5,CAT,BKRETYPE
          CALL      RDCODE1
          BRANCH    OVRCD,BTABB300
          MATCH     TCODE,CAT
          GOTO      BTABB300 IF NOT EQUAL
          MATCH     ACODE,BKRETYPE 
          GOTO      BTABB300 IF NOT EQUAL               
          MATCH     "THE ",THCSCOD
          GOTO       BTABB300 IF NOT EQUAL
.
          PACK      KEY31,BKREBOOK,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2 
          BRANCH    OVRCD,BTABB300
          MOVE      BKREBOOK,DIM8
          MATCH     DIM8,OPDAADMN
          GOTO      BTABB300 IF NOT EQUAL
.
          MOVE      ZERO,TFLAG
          GOTO      BTABB400  
.
BTABB300  MOVE      ONE,TFLAG
.
BTABB400  CALL      BROWB000   * consultant/diagnosis Bookings output 
          GOTO      BTABB100
.
BTABB900  
BTABB999  RETURN
.------------------------------------------------------------
. Current Booking Table Heading with Expected Dishcarge Date
.------------------------------------------------------------
BHEDA000  MOVE      WBDESC,KEY20 
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATESTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEEND,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=5 align=center class=HeadingCell>":
                             "Bookings for ",KEY20,"<br>":
                              DATESTR," to ",DATEEND,"</td>":
                             "</tr>":
                             "<tr>":
                             "<td class=HeadingCell>Bed</td>":
                             "<td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Booking Date/Time</td>":
                             "<td class=HeadingCell>Status></td>":
                             "<td class=HeadingCell>Exp.Discharge Date</td>":
                             "</tr>"
.         
BHEDA999  RETURN
.------------------------------------------------------------
. Current Booking Table Heading with Consultant and Diagnosis
.------------------------------------------------------------
BHEDB000  MOVE      WBDESC,KEY20 
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATESTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          UNPACK    LASTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DATEEND,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=6 align=center class=HeadingCell>":
                             "Bookings for ",KEY20,"<br>":
                              DATESTR," to ",DATEEND,"</td></tr>":
                             "<tr><td class=HeadingCell>Bed</td>":
                                 "<td class=HeadingCell>Patient</td>":
                                 "<td class=HeadingCell>Booking Date/Time</td>":
                                 "<td class=HeadingCell>Status</td>":
                                 "<td class=HeadingCell>Consultant</td>":
                                 "<td class=HeadingCell>Diagnosis</td>":
                                 "</tr>"
.         
BHEDB999  RETURN
.------------------------------------------------------------
. Bookings Patient Details
.------------------------------------------------------------
BROWA000  PACK      ADMISSNO,BKREBOOK
          PACK      URNUMBER,BKREURNO
          CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ABED,BED
.
          IF        BKRESTAT=4
            PACK      ADMISSNO,BKREBOOK
            CALL      RDDSCH1        
            BRANCH    OVRCD,BROWA200
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            PACK      FHRENDDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
          ENDIF
. 
BROWA200  IF        BKRESTAT=2
            MOVE      "&nbsp;",EXPCTDSC         
            PACK      FHRENDDT,SP70
          ENDIF           
. 
          IF        TFLAG=1          
            PACK     TIME,BKREATIM    
          ELSE
            PACK     TIME,OPDAEXPS
          ENDIF                
.
          MATCH      TIME,SP5
          IF         @EQUAL
            MOVE       SP2,ATTIME
          ELSE
            MOVE       AT,ATTIME       
          ENDIF   
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      BOOKNDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          WRITE     HTMLFILE;"<tr height=35><td align=center>":
                             BED,"&nbsp;</td>":
                             "<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td nowrap align=center>",BOOKNDAT,ATTIME:
                             TIME,"</td>":
                             "<td nowrap align=center>",BOOKSTAT,"</td>":
                             "<td nowrap align=center>",EXPCTDSC,"</td>":
                             "</tr>"
.
BROWA900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
BROWA999 RETURN
.------------------------------------------------------------
. Bookings Patient Details with Consultant/Diagnosis
.------------------------------------------------------------
BROWB000  PACK      ADMISSNO,BKREBOOK
          PACK      URNUMBER,BKREURNO
          CALL      GETPAT00 
          CALL      PATLN000 
          MOVE      ABED,BED
.
          IF        BKRESTAT=4
            PACK      ADMISSNO,BKREBOOK
            CALL      RDDSCH1        
            BRANCH    OVRCD,BROWB200
            UNPACK    DDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
. 
BROWB200  IF        BKRESTAT=2
            MOVE      "&nbsp;",EXPCTDSC         
          ENDIF           
. 
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      BOOKNDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          PACK      KEY6,BKREADOC
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE          * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                * end I CAR 13038            
          ENDIF
.
          PACK      KEY18,BKREBOOK,SP70      * Read the diagnosis file
          CALL      RSBKDIA1
          CALL      RKBKDIA1
          IF        OVRCD=1
            MOVE      SP70,BKDIDES1
            MOVE      SP70,BKDIDES2
          ELSE
            MATCH     BKREBOOK,BKDIBOOK
            IF        !@EQUAL
              MOVE      SP70,BKDIDES1
              MOVE      SP70,BKDIDES2
            ENDIF
          ENDIF
.
          CALL      DOSA0000                * Determine DOSA Status
.
          CLEAR     PATLINK
          APPEND    "javascript:patientLink('",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "','",PATLINK
          APPEND    ADMISSNO,PATLINK
          APPEND    "','",PATLINK
          APPEND    BKRESTAT,PATLINK
          APPEND    "')",PATLINK
          RESET     PATLINK
.
          REP       "+ ",URNUMBER
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          REP       "#" ",BKDIDES1
          REP       "#" ",BKDIDES2
          WRITE     HTMLFILE;"#",":
                             "#"",BKDIDES1,BKDIDES2,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",BOOKSTAT,"#",":
                             "#"",BKREEDAT,BKREATIM,"#",":
                             "#"",BKREEBED,"#",":
                             "#"",DOSASTAT,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",PATLINK,"#");"
.
BROWB900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
BROWB999 RETURN
.------------------------------------------------------------
. Determine DOSA Status
.------------------------------------------------------------
DOSA0000  MATCH     CANCEL,BOOKSTAT
          GOTO      DOSA9000 IF EQUAL
.
          COMPARE   ONE,TFLAG               * No theatre record
          GOTO      DOSA9000 IF EQUAL
.
          MATCH     "Y  ",OPDAUSR2
          GOTO      DOSA9000 IF NOT EQUAL
.
          MOVE      OPDAUSR2,DOSASTAT     * only show DOSA for non cancelled
          GOTO      DOSA9999
.
DOSA9000  MOVE      SP70,DOSASTAT
.
DOSA9999  RETURN
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABC000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          CALL      CHEDC000      * Output Table Heading
.
          CALL      IBACLOCK            * Calculate expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    WINPUT,CTABC500
.
          PACK      KEY16,WARDCODE,SP70
          CALL      RDSWARD8
CTABC100  CALL      RDKWARD8
          BRANCH    OVRCD,CTABC700
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABC700 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABC100 IF EQUAL
.
          BRANCH    WACTIVE,CTABC100     *Do not display inactive bed
.
          CALL      CROWC000
          GOTO      CTABC100
.
. No Bed Ward
.------------------------------------------------------------
CTABC500  PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABC600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABC700
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABC700 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDC000         * Output Row Details
          ADD       ONE,NUMOFPAT
          GOTO      CTABC600
.
. On Leave Patients
.------------------------------------------------------------
CTABC700  MOVE      ONE,FIRSTONL
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABC800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABC950
          MATCH     OWARD,WARDCODE
          GOTO      CTABC950 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABC800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDC000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDC000         * Output Row Details
          GOTO      CTABC800
CTABC950  CALL      CENDC000
CTABC999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDC000  PACK      KEY5,CODECO,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20
          ELSE
            MOVE      SP70,KEY20
          ENDIF
          WRITE     HTMLFILE;"<tr>":
                             "<td colspan=6 align=center class=HeadingCell>":
                             "Current Admission for ":
                              WBDESC,"</td></tr>":
                             "<tr align=center>":
                             "<td colspan=6 align=center class=HeadingCell>":
                             "Number of Patients : <input type=text readonly ":
                             "name=numofpat size=3 maxlength=3 value=",NUMOFPAT:
                             " class=TextCell></td></tr>":
                             "<tr><td class=HeadingCell>Bed</td>":
                                 "<td class=HeadingCell>Patient</td>":
                                 "<td class=HeadingCell>",KEY20,"</td>":
                                 "<td class=HeadingCell>Diet</td>":
                                 "<td class=HeadingCell>Att. Doct.</td>":
                                 "<td class=HeadingCell>Exp. Disch.</td></tr>"
                  RETURN
.------------------------------------------------------------
. End of Table
.------------------------------------------------------------
CENDC000  WRITE     HTMLFILE;"<tr><td colspan=6>":
                             "<table border=0 align=center":
                             " width=100%>":
                             "<tr align=center><td width=30%></td>":
                             "<td width=10% class=AvailableCell align=center>":
                             "Available Bed</td>":
                             "<td width=10% class=StandbyCell align=center>":
                             "Standby Patient":
                             "<td width=10% class=PastDischDate align=center>":
                             " Past Date </td>":
                             "<td width=10% class=CurrDischDate align=center>":
                             " Current Date </td>":
                             "</td><td width=30%></td></tr>":
                             "</table></td></tr>"
          RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDC000  WRITE     HTMLFILE;"<tr><td colspan=6 align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</b></td></tr>"
          RETURN
.------------------------------------------------------------
. Current Admissions Empty Bed Row
.------------------------------------------------------------
CEMPC000  WRITE     HTMLFILE;"<tr height=35 align=top>":
                    "<td align=center class=AvailableCell>":
                    WBED,"</td>":
                    "<td align=center>*** Available ***</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "<td>&nbsp;</td>":
                    "</tr>";
          RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDC000  CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          IF        STBYFLAG=0
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center>",WBED,"&nbsp;</td>"
          ELSE
            WRITE     HTMLFILE;"<tr height=35>":
                               "<td align=center class=StandbyCell>":
                               WBED,"&nbsp;</td>"
          ENDIF
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>";
.          CALL      WRTAGE00
.          WRITE     HTMLFILE;")</td>";
.
          CALL      GETCON00 * Get Patient Condition Details
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"<td>":
                             "<img src=../images/",IMGSRC," class=ListIcon ":
                             " onclick='UpdateCondition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             CONDESC,DISPDATE,SP1:
                             LPCONDD,"</TD>":
                             "<td><img src=../images/DietIcon.gif ":
                             " class=ListIcon ":
                             " onclick='UpdateDiet(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#")'>":
                             TDESC,"</td>";
.
          WRITE     HTMLFILE;"<td nowrap><a href='":
                             "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                             SDOCFNAM,"</a></td>":
                             "<td nowrap align=center class=",COLRFLAG,">":
                             EXPCTDSC,"</td>":
                             "</tr>"
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWC000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWC900 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDC000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWC999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDC000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWC999
.
CROWC900  CALL      CEMPC000         * Current Admissions Empty Bed Row
.
CROWC999  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABD000  MOVE      SP70,EXDIFLAG                * I CAR 38459
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          UNPACK    DIM127,D1,EXDIFLAG,DIM127    * I CAR 38459
          UNPACK    DIM127,D1,WORKFLAG,DIM127    * Display working diagnosis
          UNPACK    DIM127,D1,LEAVFLAG,DIM127    * On Leave Flag
          UNPACK    DIM127,D1,MHLSFLAG,DIM127    * MH Legal Status Flag
          UNPACK    DIM127,D1,STVVIEW,DIM127     * STV View
.
          MOVE      WORKFLAG,WORKDFLG            * Display working diagnosis
          MOVE      LEAVFLAG,ONLVFLAG            * Display type of onleave
          MOVE      MHLSFLAG,MEHLSFLG            * Display MH Legal Status
.
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WINPUT,NOBEDWRD
          MOVE      WCLASS,SAVCLASS
          IF        NOBEDWRD=1
            IF PTCNHDPS = ONE
              MOVE      "5",TCOLSPAN
            ELSE
              MOVE      "6",TCOLSPAN
            ENDIF
          ELSE
            MATCH     "1",EXDIFLAG               * I CAR 38459
            IF        @EQUAL
              IF PTCNHDPS = ONE
                MOVE      "5",TCOLSPAN
              ELSE
                MOVE      "6",TCOLSPAN
              ENDIF
            ELSE
              IF PTCNHDPS = ONE
                MOVE      "6",TCOLSPAN
              ELSE
                MOVE      "7",TCOLSPAN             * end I CAR 38459
              ENDIF
            ENDIF
          ENDIF
.
          CALL      CHEDD000      * Output Table Heading
.
          MOVE      "1",FILETYPE
          BRANCH    NOBEDWRD,CTABD500,CTABD500
.
          PACK      KEY16,WARDCODE,SP70
          CALL      RDSWARD8
CTABD100  CALL      RDKWARD8
          BRANCH    OVRCD,CTABD700
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABD700 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABD100 IF EQUAL
.
          BRANCH    WACTIVE,CTABD100     *Do not display inactive bed
.
          MOVE      PTWDBDST,CLOSEFLG    * Set Bed Closed flag (1 = Closed)
          CALL      CROWD000
          GOTO      CTABD100
.
. No Bed Ward
.------------------------------------------------------------
CTABD500  MOVE      ZERO,CLOSEFLG
          MOVE      "2",FILETYPE
          PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABD600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABD650
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABD650 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDD000                * Output Row Details
          ADD       ONE,NUMOFPAT
          GOTO      CTABD600
.
CTABD650  COMPARE   TWO,NOBEDWRD
          IF        @EQUAL
            PACK      KEY16,WARDCODE,SP70   * Display beds if this is a ward/bed
            CALL      RDSWARD8              * and ward only ward
            GOTO      CTABD100
          ENDIF
.
. On Leave Patients
.------------------------------------------------------------
CTABD700  MOVE      ONE,FIRSTONL
          MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABD800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABD950
          MATCH     OWARD,WARDCODE
          GOTO      CTABD950 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABD800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDD000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABD850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABD850  CALL      CBEDD000         * Output Row Details
          GOTO      CTABD800
CTABD950  CALL      CENDD000
CTABD999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDD000  PACK      KEY5,CODECO,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      TDESC,KEY20
          ELSE
            MOVE      SP70,KEY20
          ENDIF
.
          WRITE     HTMLFILE;"<table width=100% style=#"table-layout:fixed#"":
                             " cellpadding=1 cellspacing=0 border=1><tr>"
          IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell width=5%>Bed</td>";
          ENDIF
          MATCH     "1",EXDIFLAG                   * I CAR 38459
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell width=28%>Patient</td>":
                               "<td class=HeadingCell width=20%>",KEY20,"</td>":
                               "<td class=HeadingCell width=10%>Diet</td>";
.                                                                   * Car 235588
            IF        PTCNHDPS=ONE
              WRITE     HTMLFILE;"<td class=HeadingCell width=10%>Health ":
                                 "Speciality</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td class=HeadingCell width=15%>Att. Doct.</td>":
                               "<td class=HeadingCell width=8%>Prov. DRG</td>":
                               "</tr>"               * end I CAR 38459
          ELSE
            WRITE     HTMLFILE;"<td class=HeadingCell width=28%>Patient</td>":
                               "<td class=HeadingCell width=20%>",KEY20,"</td>":
                               "<td class=HeadingCell width=7%>Diet</td>";
.                                                                   * Car 235588
            IF        PTCNHDPS=ONE
              WRITE     HTMLFILE;"<td class=HeadingCell width=9%>Health ":
                                 "Speciality</td>";
            ENDIF
            WRITE     HTMLFILE;"<td class=HeadingCell width=14%>Att. Doct.</td>":
                               "<td class=HeadingCell width=8%>Prov. DRG</td>":
                               "<td class=HeadingCell width=9%>Exp. Disch</td>":
                               "</tr>"
          ENDIF
          RETURN
.------------------------------------------------------------
. End of Table
.------------------------------------------------------------
CENDD000  BRANCH    NOBEDWRD,CENDD900
          WRITE     HTMLFILE;"</table>":
                             "<table border=0 align=center width=100%>":
                             "<tr align=center height=35><td width=35%></td>":
                             "<td class=AvailableCell align=center width=10%>":
                             "Available Bed</td>":
                             "<td class=ClosedCell bgcolor=gray align=center ":
                             "width=10%>Closed Bed</td>":
                             "<td width=10% align=center class=StandbyCell>":
                             "Standby Patient":
                             "</td><td width=35%></td></tr>"
CENDD900  WRITE     HTMLFILE;"</table>"
CENDD999  RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDD000  WRITE     HTMLFILE;"<tr><td colspan=",TCOLSPAN," align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</b></td></tr>"
          RETURN
.------------------------------------------------------------
. Current Admissions Empty Bed Row
.------------------------------------------------------------
CEMPD000  WRITE     HTMLFILE;"<tr align=top height=35>";
          IF        NOBEDWRD<>1
            CALL      FBED0000
            WRITE     HTMLFILE;"<td align=center class=AvailableCell>":
                               *+,BEDTEXT,"</td>";
          ENDIF
          MATCH     "1",EXDIFLAG                  
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center>":
                               "*** Empty ***</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
.
            COMPARE   "1",PTCNHDPS
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>";
.
          ELSE
            WRITE     HTMLFILE;"<td align=center>":
                               "*** Empty ***</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
.
            COMPARE   "1",PTCNHDPS
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>";
.   
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Current Admissions Closed Bed Row
.------------------------------------------------------------
CCLSD000  WRITE     HTMLFILE;"<tr align=top height=35>";
          IF        NOBEDWRD<>1
            CALL      FBED0000
            WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                               "bgcolor=gray>",*+,BEDTEXT,"</td>";
          ENDIF
          MATCH     "1",EXDIFLAG                   * I CAR 38459
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center>":
                               "*** Closed ***</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
.
            COMPARE   "1",PTCNHDPS
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>";
.
          ELSE
            WRITE     HTMLFILE;"<td align=center>":
                               "*** Closed ***</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
            COMPARE   "1",PTCNHDPS
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ENDIF
.
            WRITE     HTMLFILE;"</tr>";
.
          ENDIF
.
          RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDD000  CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          IF        NOBEDWRD<>1
            CALL      FBED0000
            IF        STBYFLAG=0
              MATCH     "1",CLOSEFLG        * Is this Bed Closed
              IF        @EQUAL
                WRITE     HTMLFILE;"<tr valign=top>":
                                   "<td align=center class=ClosedCell ":
                                   "bgcolor=gray>",*+,BEDTEXT,"&nbsp;</td>";
              ELSE
                WRITE     HTMLFILE;"<tr valign=top>":
                                  "<td align=center>",*+,BEDTEXT,"&nbsp;</td>";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"<tr valign=top>":
                                "<td align=center class=StandbyCell>":
                                *+,BEDTEXT,"&nbsp;</td>";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<tr valign=top>"
          ENDIF
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDD020 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDD020 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDD020 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,PVIBILL
          PROC      TLEA0000
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31;
          GOTO      CBEDD040
.
CBEDD020  WRITE     HTMLFILE;FORMATNM,"</td>";
.
CBEDD040  REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          CALL      GETCON00      * Get Patient Condition Details
.
          WRITE     HTMLFILE;"<td>"

          MATCH     "1",STVVIEW
          IF        @EQUAL
            WRITE     HTMLFILE;"<table width=100% border=0":
                      " style='table-layout:fixed;'>":
                      "<tr><td style='overflow:hidden;text-overflow:ellipsis;":
                      "white-space:nowrap'>"
          ENDIF
.
          MATCH     "1",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                               " title='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBEDD100
          ENDIF
          MATCH     "2",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                               " title='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBEDD100
          ENDIF
.
          MATCH     "3",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                               " title='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBEDD100
          ENDIF
.
          MATCH     SP70,PTMXSIN1
          IF        !@EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                               PTMXSIN1,".gif'":
                               " title='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
.
CBEDD100  IF        MEHLSFLG=1
            CALL      CMHL0000              * Check for MH legal status icon
          ENDIF
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          IF        WORKDFLG=1
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>":
                                 CONDESC,DISPDATE,WORKDESC;
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>":
                                 CONDESC,DISPDATE,"<br><span class='pathis'>",PMVXUDF2,"</span>":
                                 WORKDESC;
            ENDIF
            GOTO      CBEDD200
          ENDIF
.
          MATCH     SP70,LPCONDD
          IF        @EQUAL
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>":
                                 CONDESC,DISPDATE;                 * C CAR 48209
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>":
                                 CONDESC,DISPDATE,"<br><span class='pathis'>",PMVXUDF2,"</span>"; * C CAR 48209
            ENDIF
          ELSE
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                  URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                  CONDESC,DISPDATE,"<br>":
                                  LPCONDD;                       * C CAR 48209
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon ":
                                 " onclick='UpdateCondition(#"":
                                  URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                  CONDESC,DISPDATE,"<br>":
                                  LPCONDD,"<br><span class='pathis'>",PMVXUDF2,"</span>";       * C CAR 48209
            ENDIF
          ENDIF
.
CBEDD200  MATCH     "1",STVVIEW
          IF        @EQUAL
            CALL      GETRIC00         * Get Risk icons
          ENDIF
.
          IF PTCNHDPS = ONE
            MOVE      ANSR,DIM1                                  * I CAR 48209
            MATCH     "1",PMVXVALW
            IF        @EQUAL
              MOVE ANSV,DIM1
            ENDIF
            WRITE     HTMLFILE;"<br>[",DIM1,COMMA,NBSP;
.
            MOVE      ANSN,DIM1
            MATCH     "1",PMVXPALW
            IF        @EQUAL
              MOVE ANSP,DIM1
            ENDIF
            WRITE     HTMLFILE;DIM1,"]";
.
            MATCH     SP3,LPCONAM
            IF        !@EQUAL
              MOVE      "AM",CATEGORY
              MOVE      LPCONAM,CODE
              CALL      GETCOD00
              WRITE     HTMLFILE;NBSP,NBSP,TDESC;
            ENDIF
          ENDIF
.
CBEDD500  MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
          MATCH     "1",STVVIEW
          IF        @EQUAL
            WRITE     HTMLFILE;"</td></tr></table>"
          ENDIF
          WRITE     HTMLFILE;"</td>";
.
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          IF PTCNHDPS = ONE
              WRITE     HTMLFILE;"<td><img src=../images/DietIcon.gif ":
                                 " class=ListIcon ":
                                 " onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 TDESC,"<br><span class='pathis'>",PMVXUDF4,"</span></td>"; * end I C 48209
          ELSE
            MATCH     SP70,ACOMM1
            IF        @EQUAL
              WRITE     HTMLFILE;"<td><img src=../images/DietIcon.gif ":
                                 " class=ListIcon ":
                                 " onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 TDESC,"</td>"
            ELSE
              WRITE     HTMLFILE;"<td><img src=../images/DietIcon.gif ":
                                 " class=ListIcon ":
                                 " onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 TDESC,"<br>":
                                 ACOMM1,"</td>"
            ENDIF
          ENDIF
.                                                                   * Car 235588
          IF        PTCNHDPS=ONE
            MOVE      "A ",CATEGORY
            MOVE      ATYPE,CODE
            CALL      GETCOD00
.
            MATCH     SP70,TDESC
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",TDESC,"</td>";
            ENDIF
          ENDIF
.
          COMPARE   "999",ASTAY
          IF        @EQUAL
            PACK      EXPCTDSC,HYPHEN,SP70
            GOTO      CBEDD600
          ENDIF
.
          MATCH     SP70,PMWOEDAT                                      *I-23312
          IF        !@EQUAL
            UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1,PMWOEDTM
            GOTO      CBEDD600
          ENDIF
.                                                                  *end I-23312
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      ASTAY,ADJDAYS
          CALL      ADJDAT00
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      EXPCTDSC,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR          *I-23312
.
CBEDD600  MATCH     "1",EXDIFLAG                   * I CAR 38459
          IF        @EQUAL
            WRITE     HTMLFILE;"<td nowrap><a href='":
                               "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                               SDOCFNAM,"</a></td>":
                               "<td align=center>":
                               "<a href='javascript:DrgViewFrame(#"":
                               PTMIPDRG,"#")'>":
                               PTMIPDRG,"&nbsp;</a></td>":
                               "</tr>"             * end I CAR 38459
          ELSE
            WRITE     HTMLFILE;"<td nowrap><a href='":
                               "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                               SDOCFNAM,"</a></td>":
                               "<td align=center>":
                               "<a href='javascript:DrgViewFrame(#"":
                               PTMIPDRG,"#")'>":
                               PTMIPDRG,"&nbsp;</a></td>":
                               "<td nowrap align=center>",EXPCTDSC:    *C-23312
                               "&nbsp;</td>":                          *C-23312
                               "</tr>"
          ENDIF
.
CBEDD999  RETURN
+
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWD000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWD900 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDD000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWD999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDD000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWD999
.
CROWD900  MATCH     "1",PTWDBDST       * Is this Bed Closed?
          IF        @EQUAL
            CALL      CCLSD000         * Closed Bed Row
          ELSE
            CALL      CEMPD000         * Current Admissions Empty Bed Row
          ENDIF
.
CROWD999  RETURN
.------------------------------------------------------------
.         SDOCNM00  Short Doctor Name (Title Initial. Surname)
.------------------------------------------------------------
SDOCNM00  CLEAR     DISPNAME
          MOVE      SP70,SDOCFNAM
.          PACK      NAME35,DTITL,SP70
.          CALL      NAMSTR00
.          PACK      NAME35,DGNAME,SP70
.          SQUEEZE   NAME35
.          MOVE      NAME35,KEY1
.          APPEND    KEY1,DISPNAME
.          APPEND    ". ",DISPNAME
.          PACK      NAME35,DSNAME,SP70
.          CALL      NAMSTR00
.          RESET     DISPNAME
          MOVE      DTITL,FMTTITLE
          MOVE      DGNAME,FMTGNAME
          MOVE      DSNAME,FMTSNAME
          MOVE      DISPNAME,SDOCFNAM
          STRIP     SDOCFNAM
.
SDOCNM99  RETURN
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABE000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WINPUT,NOBEDWRD
.
          CALL      CHEDE000      * Output Table Heading
.
          BRANCH    NOBEDWRD,CTABE500
.
          PACK      KEY16,WARDCODE,SP70
          CALL      RDSWARD8
CTABE100  CALL      RDKWARD8
          BRANCH    OVRCD,CTABE700
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABE700 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABE100 IF EQUAL
.
          BRANCH    WACTIVE,CTABE100     *Do not display inactive bed
.
          CALL      CROWE000
          GOTO      CTABE100
.
. No Bed Ward
.------------------------------------------------------------
CTABE500  PACK      KEY13,WARDCODE,SP20
          CALL      RDSNOBE1
CTABE600  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABE700
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABE700 IF NOT EQUAL
.
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDE000         * Output Row Details
          ADD       ONE,NUMOFPAT
          GOTO      CTABE600
.
CTABE700
CTABE999  RETURN
.------------------------------------------------------------
. Current Admission Table Heading
.------------------------------------------------------------
CHEDE000  WRITE     HTMLFILE;"<tr>":
                             "<td>Patient</td>":
                             "<td>Sex/Age</td>":
                             "<td>Att. Doct.</td>":
                             "</tr>"
          RETURN
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDE000  CALL      GETPAT00 
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
          CALL      PATNAA00
          STRIP     PATFNAME
          MOVELPTR  PATFNAME,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      PATFNAME,VAR   
          WRITE     HTMLFILE;"<tr>":
                             "<td nowrap><A HREF=",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,">":
                             VAR,"</a></td><td nowrap>",PSEX,",";
          SFORMAT   VAR,127
          CALL      WRTAGE00
          WRITE     HTMLFILE;"</td>";
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          REP       " +",DOCTCODE
          STRIP     SDOCFNAM
          MOVELPTR  SDOCFNAM,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      SDOCFNAM,VAR   
          WRITE     HTMLFILE;"<td nowrap><A HREF=",DLINKPRG,".pbl":
                             "?reportno=",DLINKREP:
                             "&template=",DLINKTEM:
                             "&doctcode=",DOCTCODE,">":
                             VAR,"</a></td>":
                             "</tr>"
          SFORMAT   VAR,127
          REP       "+ ",DOCTCODE
          RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWE000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWE999 IF EQUAL
.
          PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDE000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWE999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDE000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
CROWE999  RETURN
.
.------------------------------------------------------------
. Displays Transfers in/out for a Ward using Index on Date/Time
.------------------------------------------------------------
TTABA000  OPEN      PATTRAN5,"pattranf"
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          CALL      IBACLOCK            * Current Date
.
          PACK      KEY31,FRSTDATE,SP70
          CALL      RSPTTRN5
TTABA100  CALL      RKPTTRN5                                            * read by date
          BRANCH    OVRCD,TTABA900
.
          MOVE      ZERO,TRANOUT
.
          MATCH     WARDCODE,TWARD
          IF        !@EQUAL
            MOVE      TADMN,SAVEADMN
            PACK      SAVKEY30,TWARD,TBED,TDATE,TTIME,DTADMN,SP70
            PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
            CALL      RDSTRAN2
            CALL      RDPTRAN2                                          * read previous record to see if it's a transfer from
            BRANCH    OVRCD,TTABA100
.
            MATCH     SAVEADMN,TADMN
            GOTO      TTABA100 IF NOT EQUAL
.
            MATCH     TWARD,WARDCODE                                    * the previous ward matches the current ward
            IF        @EQUAL
              MOVE      SAVKEY30,KEY30                                   * re-read the transfer record
              CALL      RDTRAN1
              MOVE      ONE,TRANOUT                                     * is a transfer out
              GOTO      TTABA200                                        * continue to output
            ENDIF
.
            GOTO      TTABA100                                          * not related to this ward, get the next record
          ENDIF
.
TTABA200  MATCH     TDATE,LASTDATE
          GOTO      TTABA900 IF LESS
.
          CALL      TROWA000
          GOTO      TTABA100
.
TTABA900
TTABA999  RETURN
.
.------------------------------------------------------------
. Movement Patient Details
.------------------------------------------------------------
TROWA000  PACK      ADMISSNO,TADMN
          PACK      URNUMBER,TURNO
          CALL      GETPAT00 
          CALL      PATLN000
.
          MOVE      TADOCT,DOCTCODE
          MOVE      SP70,DOCFNAME
          PACK      KEY6,TADOCT
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE            * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                  * end I CAR 13038
            CALL      SDOCNM00
          ENDIF
.
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
.
          CALL      GETMOV00
          BRANCH    EXIT,TROWA999
.
          MOVE      SP70,TDESC
          MATCH     SP70,TATYPE
          IF        !@EQUAL
            PACK      KEY5,CODEA,TATYPE
            CALL      RDCODE1
          ENDIF
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":
                             "#"",TDATE,TTIME,"#",":
                             "#"",MOVEDESC,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",PATLINK,"#",":
                             "#"",TDESC,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",ADIAG1,SP1,ADIAG2,"#");"
.
TROWA999  RETURN
.------------------------------------------------------------
. Get Movement Type Description
.------------------------------------------------------------
GETMOV00  MOVE      TMOVE,ANS
          MOVE      ZERO,EXIT
          REP       "A1D2C3L4R5",ANS
          MOVE      SP70,MOVEDESC
          MOVE      ZERO,MOVETYPE
          MOVE      ANS,MOVETYPE
          LOAD      MOVEDESC,MOVETYPE,MOVEADM,MOVEDSC,MOVETIN,MOVELVO,MOVELVI
          COMPARE   "2",MOVETYPE
          GOTO      GETMOV60 IF EQUAL
          COMPARE   "3",MOVETYPE
          GOTO      GETMOV99 IF NOT EQUAL
          COMPARE   "1",TRANOUT
          GOTO      GETMOV50 IF EQUAL
.
          PACK      SAVKEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          PACK      KEY30,TADMN,TDATE,TTIME,TWARD,TBED,SP70
          MOVE      TADMN,SAVEADMN
          MOVE      TWARD,SAVEWARD
          MOVE      TBED,SAVEBED
          MOVE      TADOCT,SAVEDOCT
          MOVE      TATYPE,SAVETYPE
          CALL      RDTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,GETMOV40
          MATCH     TADMN,SAVEADMN
          GOTO      GETMOV40 IF NOT EQUAL
.
          MATCH     TWARD,SAVEWARD
          GOTO      GETMOV30 IF NOT EQUAL
          MATCH     TBED,SAVEBED
          GOTO      GETMOV35 IF NOT EQUAL
          MATCH     TADOCT,SAVEDOCT
          GOTO      GETMOV20 IF NOT EQUAL
          MATCH     TATYPE,SAVETYPE
          GOTO      GETMOV90 IF EQUAL
.
GETMOV20  MOVE      MOVESPC,MOVEDESC
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          GOTO      GETMOV99 
.
. Moved from Another Ward
.
GETMOV30  CLEAR     MOVEDESC
          PACK      KEY6,TWARD,TBED
          CALL      FWBD0000
          APPEND    MOVETIN,MOVEDESC
          APPEND    " (",MOVEDESC
.         APPEND    TWARD,MOVEDESC
.         MATCH     SP70,TBED
.         IF        !@EQUAL
.           APPEND    "/",MOVEDESC
.           APPEND    TBED,MOVEDESC
.         ENDIF
          STRIP     WBEDTEXT
          APPEND    WBEDTEXT,MOVEDESC
          APPEND    ")",MOVEDESC
          RESET     MOVEDESC
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          GOTO      GETMOV99 
.
. Move Bed Only
.
GETMOV35  CLEAR     MOVEDESC
          PACK      KEY6,TWARD,TBED
          CALL      FWBD0000
          APPEND    MOVEBED,MOVEDESC
          APPEND    " (",MOVEDESC
.          APPEND    TBED,MOVEDESC
          STRIP     BEDTEXT
          APPEND    BEDTEXT,MOVEDESC
          APPEND    ")",MOVEDESC
          RESET     MOVEDESC
          MOVE      SAVKEY30,KEY30
          CALL      RDTRAN2
          GOTO      GETMOV99 
.
. Problem can't find previous Transfer Record
.
GETMOV40  CLEAR     MOVEDESC
          APPEND    MOVETIN,MOVEDESC
          APPEND    " (Transfer Error)",MOVEDESC
          RESET     MOVEDESC
          GOTO      GETMOV99 
.   
. Transfer Out to Another Ward/Bed
.
GETMOV50  CLEAR     MOVEDESC
          PACK      KEY6,TWARD,TBED
          CALL      FWBD0000
          APPEND    MOVETOT,MOVEDESC
          APPEND    " (",MOVEDESC
.          APPEND    TWARD,MOVEDESC
.          MATCH     SP70,TBED
.          IF        !@EQUAL
.            APPEND    "/",MOVEDESC
.            APPEND    TBED,MOVEDESC
.          ENDIF
          STRIP     WBEDTEXT
          APPEND    WBEDTEXT,MOVEDESC
          APPEND    ")",MOVEDESC
          RESET     MOVEDESC
          GOTO      GETMOV99 
.   
. Discharge
.
GETMOV60  MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          BRANCH    OVRCD,GETMOV99
.                                                                     *C-140164
          IF        PTCNDRSM=1
            PACK      KEY3,DSTAT
            PACK      KEY5,CATD,DSTAT,SP5
          ELSE
            PACK      KEY3,DDEST
            PACK      KEY5,CATDD,DDEST,SP5
          ENDIF
.
          MATCH     SP3,KEY3
          GOTO      GETMOV99 IF EQUAL
          CALL      RDCODE1
          BRANCH    OVRCD,GETMOV99
.
          CLEAR     MOVEDESC
          APPEND    MOVEDSC,MOVEDESC
          APPEND    " (",MOVEDESC
          STRIP     TDESC
          MOVELPTR  TDESC,LENGTH
          SFORMAT   VAR,LENGTH
          MOVE      TDESC,VAR   
          APPEND    VAR,MOVEDESC
          SFORMAT   VAR,127
          APPEND    ")",MOVEDESC
          RESET     MOVEDESC
          GOTO      GETMOV99 
.
GETMOV90  MOVE      ONE,EXIT
GETMOV99  RETURN
.------------------------------------------------------------------------
. Format Patient Name with Second Name Initial
.------------------------------------------------------------------------
PATINT00  CLEAR     DISPNAME
          MOVE      PSNAME,SAVPSNAM
.
..        REP       "' ",PSNAME
          REP       "#" ",PSNAME
..        REP       "' ",PGNAME
          REP       "#" ",PGNAME
          MOVE      SP70,PATFNAME
          REP       UPPLOW,PSNAME
          APPEND    "<b>",DISPNAME
          APPEND    PSNAME,DISPNAME
          APPEND    "</b>",DISPNAME
          PACK      NAME35,PTITL,SP70
          CALL      NAMSTR00
.
          MOVELPTR  PGNAME,LENPTR
          MOVE      ONE,COUNT
PATINT10  BUMP      PGNAME
          GOTO      PATINT80 IF EOS
          ADD       ONE,COUNT
          MATCH     SP1,PGNAME
          GOTO      PATINT10 IF NOT EQUAL
          BUMP      PGNAME
          ADD       ONE,COUNT
PATINT80  RESET     PGNAME
          SETLPTR   PGNAME,COUNT
          PACK      NAME35,PGNAME,SP70
          CALL      NAMSTR00
          RESET     PGNAME,LENPTR
.
          APPEND    SP70,DISPNAME
          RESET     DISPNAME
          MOVE      DISPNAME,PATFNAME
          STRIP     PATFNAME
.
          MOVE      SAVPSNAM,PSNAME         * Original value with quotes etc
.
PATINT90  RESET     PGNAME
.
PATINT99  RETURN 
.
.------------------------------------------------------------
. Displays Chaplains Current Patient ward/bed details
.------------------------------------------------------------
CTABF000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WINPUT,NOBEDWRD              * Save Ward Hdr WO/BO status
.
          CALL      CHEADF00                     * Output headings         
.
. No Bed 
.
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABF100  CALL      RDKNOBE1                     * read next record
          BRANCH    OVRCD,CTABF190
          MATCH     WARDCODE,NBWARD              * same ward?
          GOTO      CTABF190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDF000         * Output Row Details
          GOTO      CTABF100
.
. Ward/Bed Details
.
CTABF190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABF200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABF290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABF290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABF200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CTABF220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CTABF200
            MATCH     OWARD,WWARD
            GOTO      CTABF200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CTABF200 IF NOT EQUAL
          ENDIF
           
CTABF220  BRANCH    WACTIVE,CTABF200     *Do not display inactive bed
          CALL      CROWF000
          GOTO      CTABF200
.
CTABF250  MOVE      "2",BEDMSGID      
          CALL      CBDMSF00
          GOTO      CTABF200
.
. On Leave Patients
.------------------
CTABF290  BRANCH    WBEDTYPE,CTABF300,CTABF9999
. 
CTABF300  MOVE      ONE,FIRSTONL
          MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABF800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABF999
          MATCH     OWARD,WARDCODE
          GOTO      CTABF999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABF800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDF000             * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDF000               * Output Row Details
          GOTO      CTABF800
.
CTABF999  RETURN
.------------------------------------------------------------
. Current Admissions (Chaplain view) - Output Table heading row.
.------------------------------------------------------------
CHEADF00  WRITE     HTMLFILE;"<tr>";
          IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center>Bed</td>";
          ENDIF
. 
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
.
          BRANCH    KIDSONLY,CHEADF50
.                                              * St. Vincents (standard)
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient Condition</td>":
                             "<td class=HeadingCell>Religion</td>":
                             "<td class=HeadingCell>Baptised</td>";
          GOTO      CHEADF90
.                                              * Royal Childrens (kids) 
.
CHEADF50  WRITE     HTMLFILE;"<td class=HeadingCell align=center>U/R</td>":
                             "<td class=HeadingCell>Patient Condition<br>":
                                                   "Diagnosis</td>":
                             "<td class=HeadingCell>Religion</td>":
                             "<td class=HeadingCell>Baptised</td>";
.
CHEADF90  WRITE     HTMLFILE;"<td class=HeadingCell>Days</td>":
                             "<td class=HeadingCell>Adm.Date Time<br>":
                                                   "Exp.Discharge</td>":
                             "</tr>";
CHEADF99  RETURN             
.
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWF000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWF800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (INGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,CROWF100,CROWF999
.
CROWF100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          CALL      CBEDF000                     * Output Row Details
          ADD       ONE,NUMOFPAT                 * count no. of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWF999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDF000                     * Output Row Details
          ADD       ONE,NUMOFPAT                 * count no. of patients in ward
.
          GOTO      CROWF999
.
CROWF800  MOVE      ONE,BEDMSGID                 * Assume Empty Bed
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWF810  CALL      RDKONLV1                     * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWF850
          MATCH     OWARD,WWARD
          GOTO      CROWF850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWF850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID                * Bed has patient on leave
.
CROWF850  CALL      CBDMSF00       
.
CROWF999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDF000  CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER 
.
CBEDF050  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDF090                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDF060,CBEDF070,CBEDF080
.
CBEDF060  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             " &nbsp;</td>";
          GOTO      CBEDF090
.
CBEDF070  CALL      FBED0000
          IF        STBYFLAG=0
            WRITE     HTMLFILE;"<td align=center>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell>";
          ENDIF
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>";
          GOTO      CBEDF090
.
CBEDF080  CALL      FBED0000
          WRITE     HTMLFILE;"<td align=center class=LeaveCell>";
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>";
.
CBEDF090  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>";
.  
                                        * Don't use URno col for St.Vincents
          IF        KIDSONLY=ONE 
            REP       "+ ",URNUMBER
            WRITE     HTMLFILE;"<td nowrap align=center>":
                                URNUMBER,"</td>";
            REP       " +",URNUMBER
          ENDIF
.
CBEDF100  CALL      GETCON00               * Get Patient Condition Details
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
.                                            * St. Vincents (standard)
          WRITE     HTMLFILE;"<td nowrap>":
                               CONDESC,DISPDATE,"<br>",LPCONDD;
          IF        KIDSONLY=1
            WRITE     HTMLFILE;"<br />",ADIAG1;
          ENDIF
.
          MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
. 
          MOVE      SP70,TDESC               * Get religion
          MOVE      "R ",CATEGORY
          MOVE      PREG,CODE
          CALL      GETCOD00
.
          MOVE      DNO,YESNO                * Set baptised status 
          IF        PUYN1 = 1
            MOVE      DYES,YESNO
          ENDIF
.
          WRITE     HTMLFILE;"<td nowrap>",TDESC,"&nbsp;</td>":      
                             "<td nowrap align=center>",YESNO,"</td>";
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CALL      IBACLOCK
          PACK      CURRDATE,CC,YY,MM,DD
          REP       " 0",CURRDATE
          DAYSEP    ADATE,CURRDATE,ADMITDAY
.
          WRITE     HTMLFILE;"<td nowrap align=right>",ADMITDAY,"</td>";
.
          WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                                  DISPDATE,ATIME,"<br>":
                                  EXPCTDSC,"</td>":
                             "</tr>"
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDF999  RETURN
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDF000  MOVE      SEVEN,CSPANUM           * RCH (kids)   
          BRANCH    KIDSONLY,CRHDF010       * Default View
          MOVE      SEVEN,CSPANUM           * RCH (kids)   
.
CRHDF010  IF        NOBEDWRD=1
            SUBTRACT  ONE,CSPANUM           * Remove 'bed' col for WardOnly Ward
          ENDIF
          MOVE      CSPANUM,CSPAN
          SQUEEZE   CSPAN
.
          WRITE     HTMLFILE;"<tr><td colspan=",CSPAN," align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</b></td></tr>"
.
CRHDF999  RETURN
.------------------------------------------------------------
. Current Admissions Bed Row message.
.------------------------------------------------------------
CBDMSF00  BRANCH    BEDMSGID,CBDMSF01,CBDMSF02
.
          MOVE      "LeaveCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSF10
.
CBDMSF01  MOVE      "AvailableCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSF10
.
CBDMSF02  BRANCH    WBEDTYPE,CBDMSF99 
          MOVE      "ClosedCell bgcolor=gray",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
.
CBDMSF10  CALL      FBED0000
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                             "<td align=center class=",BDMSGCLS,">":
                             *+,BEDTEXT:
                             "</td><td align=center>",BDMSGTXT,"</td>";
.
.                                           **** Default View ****
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "</tr>";
CBDMSF99  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABG000  MOVE      ZERO,RECNUMB
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          UNPACK    DIM127,D1,WORKFLAG,DIM127    * Working Diag.Flag 
          UNPACK    DIM127,D1,PRNTLABL,DIM127    * Print Labels Flag
          UNPACK    DIM127,D1,ANAESTFL,DIM127    * Anaesthetist Flag
          UNPACK    DIM127,D1,STVVIEW,DIM127     * Stv Flag         Car 262343
          UNPACK    DIM127,D1,LEAVFLAG,DIM127    * On Leave Flag
          UNPACK    DIM127,D1,MHLSFLAG,DIM127    * MH Legal Status Flag
          UNPACK    DIM127,D1,SKIPDIET,DIM127    * Skip DIet Text
.
          MOVE      ZERO,NUMBOUTL
          MOVE      ZERO,NUMBCNFD
          MOVE      ZERO,CRSRTCNT
.
          RESET     STVVIEW
          MATCH     STVVIEW,SP70
          IF        @EQUAL
            MOVE      ZERO,STVVIEW
          ENDIF
.
          MOVE      WORKFLAG,WORKDFLG            * Display working diagnosis
          MOVE      LEAVFLAG,ONLVFLAG            * Display type of onleave
          MOVE      MHLSFLAG,MEHLSFLG            * Display MH Legal Status
.
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WCLASS,SAVCLASS
.
          IF        EMRGVIEW=1
            MOVE      ZERO,EMVIFLAG              * redirect supervisor clinical
            PACK      KEY5,ANSB,ANST,WEFRBT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "S",THCSCOD              * EOU Unit
              IF        @EQUAL
                MATCH     ANSO,TCINDC8           * Display EOU on map
                IF        @EQUAL
                  MOVE      ONE,EMVIFLAG         * redirect supervisor clinical
                ENDIF
              ENDIF
            ENDIF
CTABG050    CALL      WARDET00                   * Calculate  ward statistics
          ENDIF
.
          MOVE      WINPUT,NOBEDWRD              * Save Ward Hdr WO/BO status
.
          IF        HEAONLY = ONE                
          ELSE
            IF        CABONLY = ONE
              CALL      CHEADK00                 * Output headings - CAB
            ELSE
              CALL      CHEADG00                 * Output headings
            ENDIF         
          ENDIF
.
. No Bed 
.
          MOVE      ZERO,CLOSEFLG
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABG100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABG190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABG190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          MOVE      WARDCODE,WWARD
          MOVE      SAVCLASS,WCLASS
          CALL      CBEDG000         * Output Row Details
          GOTO      CTABG100
.
. Ward/Bed Details
.
CTABG190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABG200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABG290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABG290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABG200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CTABG220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CTABG200
            MATCH     OWARD,WWARD
            GOTO      CTABG200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CTABG200 IF NOT EQUAL
          ENDIF
CTABG220  BRANCH    WACTIVE,CTABG200       * Do not display Inactive Beds
          CALL      CROWG000
          GOTO      CTABG200
.
. On Leave Patients
.------------------
CTABG290  BRANCH    WBEDTYPE,CTABG300,CTABG999
. 
CTABG300  MOVE      ONE,FIRSTONL
          MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABG800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABG999
          MATCH     OWARD,WARDCODE
          GOTO      CTABG999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABG800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDG000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABG850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABG850  MOVE      ONE,ONLEAVET
          CALL      CBEDG000         * Output Row Details
          MOVE      ZERO,ONLEAVET
          GOTO      CTABG800
.
CTABG999  RETURN
.
.------------------------------------------------------------
. Current Admissions - Output Table heading row.
.------------------------------------------------------------
CHEADG00  BRANCH    FHIRTYPE,CHEADG99
          WRITE     HTMLFILE;"<tr>";
.
          IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center>Bed</td>";
          ENDIF
. 
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
.
          IF        KIDSONLY=ONE
            WRITE     HTMLFILE;"<td class=HeadingCell align=center>U/R</td>";
          ENDIF
.
          IF        KIDSVEW2 = 1
            WRITE     HTMLFILE;"<td class=HeadingCell>Diagnosis</td>":
                               "<td class=HeadingCell>Procedure</td>":
                               "<td class=HeadingCell>Unit<br> Doctor</td>":
                               "<td class=HeadingCell>Ins <br> Class</td>":
                               "<td class=HeadingCell>Adm.Date Time<br>":
                                                     "Exp.Discharge":
                                                     "Exp.Return From Leave":
                                                     "</td>";
            COMPARE   "1",BULKDSCH
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=HeadingCell>Discharge<br>";
            ENDIF
            MATCH     "1",PRNTLABL
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=HeadingCell>Print Label<br>";
            ENDIF
          ELSE
            IF        ALTVIEW1 = 1
              WRITE     HTMLFILE;"<td class=HeadingCell>Diagnosis</td>":
                                 "<td class=HeadingCell>Unit<br> Doctor</td>":
                                 "<td class=HeadingCell>Adm.Date Time<br>":
                                                       "Exp.Discharge":
                                                       "Exp.Return From Leave":
                                                       "</td>";
              COMPARE   "1",BULKDSCH
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Discharge<br>";
              ENDIF
              MATCH     "1",PRNTLABL
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Print Label<br>";
              ENDIF
            ELSE
              MATCH     "1",STVVIEW
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell width='20%'>Patient Condition</td>";
              ELSE
                WRITE     HTMLFILE;"<td class=HeadingCell>Patient Condition</td>";
              ENDIF
.
              IF        DISPTHET=1 
                WRITE     HTMLFILE;"<td class=HeadingCell>":
                                   "Theatre <br> Status</td>";
              ENDIF
.
              IF        SJOGVIEW=1
                WRITE     HTMLFILE;"<td class=HeadingCell>Admission Diet</td>";
              ELSE
                WRITE     HTMLFILE;"<td class=HeadingCell>Diet</td>";
              ENDIF
.
              IF        FASTVIEW=ONE
.                                              * Stv Specific Heading Car 262343
                MATCH     "1",STVVIEW
                IF        @EQUAL
                  WRITE     HTMLFILE;"<td class=HeadingCell>":
                                     "Feeding<br />Assistance</td>";
                ELSE
                  WRITE     HTMLFILE;"<td class=HeadingCell>Fasting</td>";
                ENDIF
.
              ENDIF
.                                                                   * Car 235588
              IF        PTCNHDPS=ONE
                WRITE     HTMLFILE;"<td class=HeadingCell>Health Speciality</td>";
              ENDIF
.
              IF        SJOGVIEW=ONE
                MOVE      SP70,TDESC
                PACK      KEY5,ANSU,NINE,SP70
                CALL      RDCODE1
                WRITE     HTMLFILE;"<td class=HeadingCell>",TDESC,"</td>";
              ENDIF
.
              WRITE     HTMLFILE;"<td class=HeadingCell>Unit<br> Doctor</td>";
              MATCH     "1",ANAESTFL                                  *I-174468
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Anaesthetist</td>";
              ENDIF
              WRITE     HTMLFILE;"<td class=HeadingCell>Adm.Date Time<br>":
                                                       "Exp.Discharge<br>":
                                                       "Exp.Return From Leave":
                                                       "</td>";
.
              IF         SJOGVIEW=ONE
                WRITE     HTMLFILE;"<td class=HeadingCell>Post Op Ward/Bed</td>":
                                   "<td class=HeadingCell>Intended Stay</td>";
              ENDIF
.
              COMPARE   "1",BULKDSCH
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Discharge<br>";
              ENDIF
              MATCH     "1",PRNTLABL
              IF        @EQUAL
                WRITE     HTMLFILE;"<td class=HeadingCell>Print Label<br>";
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
CHEADG99  RETURN             
.
.
.------------------------------------------------------------
. Current Admissions - Output Table heading row.
.------------------------------------------------------------
CHEADJ00  BRANCH    FHIRTYPE,CHEADJ99
          WRITE     HTMLFILE;"<tr>";
.
          IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center Width=5%>Bed</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell Width=15%>Patient</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell width=15%>":
                             "Patient Condition</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=5%>":
                             "Theatre <br> Status</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=3%>Diet</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=5%>":
                             "Diagnosis</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Unit<br> Doctor</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Adm.Date Time<br>":
                             "Exp.Discharge<br>":
                             "Exp.Return From Leave":
                             "</td>";
.
          WRITE     HTMLFILE;"</tr>"
.
CHEADJ99  RETURN
.
.------------------------------------------------------------
. Current Admissions - Output Table heading row for CAB
.------------------------------------------------------------
CHEADK00  BRANCH    FHIRTYPE,CHEADK99
          WRITE     HTMLFILE;"<tr>";
.
         IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center>Bed</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient Condition</td>";
.
.
          MOVE      "U2",CATEGORY  
          PACK      KEY5,CATEGORY,SP70
          CALL      RDCODE1
.
          WRITE     HTMLFILE;"<td class=HeadingCell>",TDESC,"</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>":
                             "Theatre <br> Status</td>";
.
           WRITE     HTMLFILE;"<td class=HeadingCell>Diet</td>";
.
           WRITE     HTMLFILE;"<td class=HeadingCell>Fasting</td>";
.                                                                   
           IF        PTCNHDPS=ONE
             WRITE     HTMLFILE;"<td class=HeadingCell>Health Speciality</td>";
           ENDIF
.
           WRITE     HTMLFILE;"<td class=HeadingCell>Unit<br> Doctor</td>";
           MATCH     "1",ANAESTFL
           IF        @EQUAL
             WRITE     HTMLFILE;"<td class=HeadingCell>Anaesthetist</td>";
           ENDIF
           WRITE     HTMLFILE;"<td class=HeadingCell>Adm.Date Time<br>":
                                                    "Exp.Discharge<br>":
                                                     "Exp.Return From Leave":
                                                     "</td>";
.
           MATCH     "1",PRNTLABL
           IF        @EQUAL
             WRITE     HTMLFILE;"<td class=HeadingCell>Print Label<br>";
           ENDIF
.
          WRITE     HTMLFILE;"</tr>"
.
CHEADK99  RETURN
.
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWG000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWG800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (IGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,CROWG100,CROWG999
.
CROWG100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG
          CALL      CBEDG000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWG999 IF EQUAL
.
CROWG200  PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDG000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWG999
.
CROWG800  MATCH     "1",PTWDBDST     * Is this bed closed?
          IF        @EQUAL
            MOVE      TWO,BEDMSGID   * Yes, bed is closed
            GOTO      CROWG850
          ELSE
            MOVE      ONE,BEDMSGID   * Assume Empty Bed
          ENDIF
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWG810  CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWG850
          MATCH     OWARD,WWARD
          GOTO      CROWG850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWG850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID     * Bed has patient on leave
.
CROWG850  BRANCH    FHIRTYPE,CROWG999
          CALL      CBDMSG00
.
CROWG999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDG000  IF        HEAONLY = ONE
            CALL      CBEDK000
            GOTO      CBEDG999
          ENDIF
.
          CALL      FHRCLR00                * Clear FHIR Encounter Variable
          PACK      SECDOCDE,SP70
          CALL      GETPAT00
.
          IF        FHIRTYPE=1
            MATCH     SP70,FRSTDATE         * check frstdate available 
            GOTO      CBEDG005 IF EQUAL
            GOTO      CBEDG005 IF EOS
            MATCH     FRSTDATE,ADATE
            GOTO      CBEDG999 IF LESS
            MATCH     ADATE,LASTDATE
            GOTO      CBEDG999 IF LESS
.
          ENDIF
.
CBEDG005  COMPARE   ZERO,PTSTATUS          * fhir - Is there a status filter
            IF        !@EQUAL
              COMPARE   PTSTATUS,ASTAT       * fhir - Is the status selected
              IF        !@EQUAL
                GOTO      CBEDG999
              ENDIF
            ENDIF
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CBEDG010
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,CBEDG010
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          CLEAR     SECDOCDE
          APPEND    PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
          RESET     SECDOCDE

.
CBEDG010  CALL      GETAN000              * get Anaesthetist
          MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
          MOVE      SP70,CURSTATT
.
          IF        ANATFLAG = 1
            CALL      PATSTS00                * get theatre status      
          ENDIF
.
          MATCH     "1",WAHLFLAG
          IF        @EQUAL
            CALL      MEDCLR00  
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CALL      XRET0000                * Exp return from leave date/time 
.
          MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          IF        FHIRTYPE=1
            CALL      FHRENC00
            GOTO      CBEDG999
          ENDIF
.
CBEDG050  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDG090                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDG060,CBEDG070,CBEDG080
.
. Bed column
.
CBEDG060  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             "<img src='../images/EditIcon.gif'":
                             " class=ListIcon onclick='BedAllocation(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             "</td>"
          GOTO      CBEDG090
.
CBEDG070  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                                 "title=#"",PTWDCOMM,"#" ":
                                 "bgcolor=gray>";
            ELSE
              WRITE     HTMLFILE;"<td align=center ":
                                 "title=#"",PTWDCOMM,"#">";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell ":
                               "title=#"",PTWDCOMM,"#">";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
          GOTO      CBEDG090
.
CBEDG080  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                               "title=#"",PTWDCOMM,"#" ":
                               "bgcolor=gray>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=LeaveCell ":
                               "title=#"",PTWDCOMM,"#">";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
.
. Patient Column
.
CBEDG090  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
         IF        DISPDNAM=1
            REP       "+ ",ADMISSNO
            REP       "+ ",URNUMBER
            CALL      CHKD0000           * Duplicate Surnames?
            IF        DUPNMFLG=1
              WRITE     HTMLFILE;"<img src='../images/samename.gif'":
                                 " title='Patient Name Conflict'":
                                 " class=ListIcon>";
            ENDIF
            REP       " +",ADMISSNO
            REP       " +",URNUMBER
         ENDIF
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDG092 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDG092 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDG092 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
.
          MOVE      KEY8,PVIBILL
          PROC      TLEA0000
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31,"</td>";
          GOTO      CBEDG094
.
CBEDG092  WRITE     HTMLFILE;FORMATNM,"</td>";
.
                                        * Don't use URno col for St.Vincents
CBEDG094  IF        KIDSONLY=ONE
            REP       "+ ",URNUMBER
            WRITE     HTMLFILE;"<td nowrap align=center>":
                                URNUMBER,"</td>";
            REP       " +",URNUMBER
          ENDIF
.
          IF       KIDSVEW2 = 1
            MOVE      ADIAG1,DIM15
            WRITE     HTMLFILE;"<td nowrap align=left>":
                                DIM15,"&nbsp;</td>";
            MOVE      PMVXUDF1,DIM15
            WRITE     HTMLFILE;"<td nowrap align=left>":
                                DIM15,"&nbsp;</td>";
            GOTO     CBEDG154
          ENDIF
.
          IF       ALTVIEW1 = 1
            WRITE     HTMLFILE;"<td nowrap align=left>":
                                ADIAG1,"&nbsp;</td>";
            GOTO     CBEDG154
          ENDIF
.
. Patient Condition column
.
CBEDG100  CALL      GETCON00               * Get Patient Condition Details
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"<td>"
.
          WRITE     HTMLFILE;"<table border=0 width=100%><tr><td>"
.
          MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
.          
CBEDG110  MATCH     "1",PMPXSIN7
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                               " title='Medical Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          MATCH     "1",PMPXSIN8
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                               " title='Micro Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          MATCH     "1",PMPXSIN9
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                               " title='Risk Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          MATCH     "1",PMPXSN11
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                               " title='Chronic Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        EXIT=0 | EXIT=2 
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      CBEDG120
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      CBEDG120
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      CBEDG120
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
            ENDIF
          ENDIF
.
CBEDG120  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " title='Disability Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        MEHLSFLG=1
            CALL      CMHL0000              * Check for MH legal status icon
          ENDIF
.
          MATCH     "1",PTMXSIN2
          IF        @EQUAL
.            WRITE     HTMLFILE;"<img src=#"../images/ResultIcon.gif#"":
.                               " class=ListIcon onclick='PatientResults(#"":
.                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        EMRGVIEW=1
            CALL      GETE0000
            MATCH     ZEROVISN,EMVIADMN
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/DocumentIcon.gif'":
                                 " class=ListIcon ":
                                 " title=#"Update emergency clinic notes#"" :
                                 " onclick='UpdateEMR(#"":
                             URNUMBER,"#",#"",EMVIADMN,"#",#"",EMVIFLAG,"#");'>"
            ENDIF
          ENDIF
.
          IF        CNOTFLAG=1
            MATCH     SP70,PTMXSIN3
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/NotesIcon.gif'":
                                 " class=ListIcon ":
                                 " onclick='PatientNotes(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
            ENDIF
          ENDIF
.
.-------- Get Over flow description --------                         *C-0837181
          MOVE      SP70,OVFLDESC                               
          IF        HEAVIEW=1
            CALL      OVFDS000                         * Get OVFLDESC          
          ENDIF
.
          IF        WORKDFLG=1
            WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                               " class=ListIcon onclick='UpdateCondition(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#")'>":
                               CONDESC,DISPDATE,WORKDESC,OVFLDESC;
            GOTO      CBEDG130
          ENDIF
.
          MATCH     SP70,LPCONDD
          IF        @EQUAL
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC;
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",PMVXUDF2;
            ENDIF
          ELSE
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD;
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD:
                                 "<br>",PMVXUDF2;
            ENDIF
          ENDIF
. 
          MATCH     "1",WAHLFLAG
          IF        @EQUAL
            MATCH     SP70,MEDCLRDT
            IF        !@EQUAL
              WRITE     HTMLFILE;MEDCLRDT
            ENDIF
          ENDIF
.
CBEDG130  MATCH     "1",STVVIEW
          IF        @EQUAL
            CALL      GETRIC00         * Get Risk icons
          ENDIF
.
          MATCH     SP70,PMPXABRG           * Aboriginality (Cat VA) FLAG
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSA,PMPXABRG,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MATCH     ANSD,TCINDC3
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/aboriginality.png'":
                                 " title='aboriginalityIcon' ":
                                 " class='aboriginalityIcon' hidden='hidden' >";
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE ANSV,DIM1
          ENDIF
          WRITE     HTMLFILE;"<br>[",DIM1,COMMA,NBSP;
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE      ANSP,DIM1
          ENDIF
          WRITE     HTMLFILE;DIM1;
.
          MATCH     "1",PMVXPALW            * Phone Calls Allowed?
          GOTO      CBEDG131 IF  NOT EQUAL  * no; close off output
.
          IF        FILETYPE=1
.
.           No Bed...
.
            PACK      KEY6,NBWARD,NBROOM,SP20
            CALL      RDWARD1
            BRANCH    OVRCD,CBEDG131
          ENDIF
.
          IF        FILETYPE=1 | FILETYPE=3
.
.           No Bed/On Leave
.
            MATCH     SP70,PTWDNSTA
            IF        !@EQUAL
.
.             Has a linked Nursing Station
.
              MOVE      PTWDNSTA,NURSTCOD
              CALL      WNURN000            * get Nursing Station number
              MATCH     SP70,NURSTNUM
              IF        !@EQUAL
                STRIP     NURSTNUM
                WRITE     HTMLFILE;" - ",*+,NURSTNUM,*-;
              ELSE
                MATCH     SP70,WEXTN
                IF        !@EQUAL
                  STRIP     WEXTN
                  WRITE     HTMLFILE;" - ",*+,WEXTN,*-;
                ENDIF
              ENDIF
            ELSE
.
.             No linked Nursing Station
.
              MATCH     SP70,WEXTN
              IF        !@EQUAL
                STRIP     WEXTN
                WRITE     HTMLFILE;" - ",*+,WEXTN,*-;
              ENDIF
            ENDIF
          ELSE
.
.           Bed/Ward...
.
            MATCH     SP70,WEXTN
            IF        !@EQUAL
              STRIP     WEXTN
              WRITE     HTMLFILE;" - ",*+,WEXTN,*-;   * default ward/bed ext. no
            ELSE
              MOVE      PTWDNSTA,NURSTCOD
              CALL      WNURN000            * get Nursing Station number
              MATCH     SP70,NURSTNUM
              IF        !@EQUAL
                STRIP     NURSTNUM
                WRITE     HTMLFILE;" - ",*+,NURSTNUM,*-;
              ENDIF
            ENDIF
          ENDIF
.
CBEDG131  WRITE     HTMLFILE;"]";
.
          BRANCH    KIDSONLY,CBEDG140
          MATCH     SP3,LPCONAM
          IF        !@EQUAL
            MOVE      "AM",CATEGORY
            MOVE      LPCONAM,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,NBSP,TDESC;
          ENDIF
.
CBEDG140  MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
          MATCH     "1",STVVIEW
          IF        @EQUAL
            WRITE     HTMLFILE;"</td><td width=20 align=right valign=top>"
          ELSE
            WRITE     HTMLFILE;"</td><td align=right valign=top>"
          ENDIF
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO 
.
          UNPACK    SAVKEY27,PTVEVISN,PTVEVTYP,PTVESDAT,PTVESTIM
          WRITE     HTMLFILE;"<img src=../images/mv_",MVFLAG:
                             ".png class=ListIcon onclick='gotoMV(#"":
                             URNUMBER,"#",#"",PTVEVISN,"#",#"":
                             PTVEVTYP,"#",#"",PTVESDAT,"#",#"":
                             PTVESTIM,"#")'>";
.
          MOVE      ZERO,BORDICIN
          PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDG142  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDG142 IF LESS            * CAR 304926
                GOTO      CBEDG143 IF NOT EQUAL       * CAR 304926
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDG142 IF LESS          * CAR 304926
                ENDIF
              ENDIF
CBEDG143      ADD       ONE,BORDICIN 
              COMPARE   TWO,BORDICIN
              GOTO      CBEDG144 IF EQUAL
              GOTO      CBEDG142
            ENDIF
          ENDIF
.
CBEDG144  PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDG145  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL 
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDG145 IF LESS            * CAR 304926
                GOTO      CBEDG146 IF NOT EQUAL       * CAR 304926
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDG145 IF LESS          * CAR 304926
                ENDIF
              ENDIF
.
CBEDG146        MOVE      SP70,DISPBBDT
                MATCH     SP70,PTBRBDAT
                IF        !@EQUAL & !@EOS
                  UNPACK    PTBRBDAT,CCENT,CYEAR,CMON,CDAY
                  MOVE      CMON,F2
                  LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                       JUL,AUG,SEP,OCT,NOV,DEC
                  PACK      DISPBBDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR 
.
                  CALL      IBACLOCK
                  PACK      AGEDATE,CCC,CYY,CMM,CDD
                  PACK      PBDATE,PTBRBDAT
                  CALL      CALCAGE
                  MOVE      PSAGEYRS,PSAGEDIM
                ELSE
                  MOVE      SP70,PSAGEDIM
                ENDIF
.
                MOVE      SP70,DISPBSDT
                MATCH     SP70,PTBRSDAT
                IF        !@EQUAL & !@EOS
                  UNPACK    PTBRSDAT,CCENT,CYEAR,CMON,CDAY
                  MOVE      CMON,F2
                  LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                       JUL,AUG,SEP,OCT,NOV,DEC
                  PACK      DISPBSDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
                ENDIF
.
                IF        BORDICIN=2
                  MATCH     SP70,PTBRADR1
                  IF        @EQUAL | @EOS
                    MATCH     SP70,PTBRADR2
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRADR3
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRADR4
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRPOST
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRHPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRWPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRMPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBREMAL
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    MATCH     SP70,PTBRLURN
                    IF        @EQUAL | @EOS
                      GOTO      CBEDG147
                    ENDIF
.
                    PACK      KEY8,PTBRLURN,SP70
                    CALL      RDMAST1
                    IF        OVRCD
                      PACK      KEY8,URNUMBER,SP70
                      CALL      RDMAST1
.
                      GOTO      CBEDG147
                    ENDIF
.
                    CALL      RDPMPX21
.
                    REP       "'`",PTBRSNAM
                    REP       "'`",PTBRGNAM
                    REP       "'`",PADD1
                    REP       "'`",PADD2
                    REP       "'`",PSUBRB
                    REP       "'`",PADD4
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                  WRITE     HTMLFILE;"<img src='../images/PatientLink4.gif' class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PADD1,"'":
                                                  ",'",PADD2,"'":
                                                  ",'",PSUBRB,"'":
                                                  ",'",PADD4,"'":
                                                  ",'",PPOST,"'":
                                                  ",'",PTELEP,"'":
                                                  ",'",PTELEB,"'":
                                                  ",'",PTMXCELL,"'":
                                                  ",'",PMPXPEML,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
                    PACK      KEY8,URNUMBER,SP70
                    CALL      RDMAST1
                    CALL      RDPMPX21
.
                  ELSE
CBEDG147            REP       "'`",PTBRSNAM
                    REP       "'`",PTBRGNAM
                    REP       "'`",PTBRADR1
                    REP       "'`",PTBRADR2
                    REP       "'`",PTBRADR3
                    REP       "'`",PTBRADR4
.
                WRITE     HTMLFILE;"<img src='../images/PatientLink4.gif' class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'": 
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
                  ENDIF
.
.       MATCH     SP70,PTBRLURN
.       IF        @EQUAL | @EOS
.         WRITE     HTMLFILE;",'",PTBRURNO,"'";
.       ELSE
          WRITE     HTMLFILE;",'",PTBRLURN,"'";
.       ENDIF
.
        WRITE     HTMLFILE;",'",PTBRTITL,"'":
                           ",'",PTITL,"'":
                           ",'",PSNAME,"'":
                           ",'",PGNAME,"'":
                           ");#"":
                           " onmouseout=#"hideit();#">"
                ELSE
                  MATCH     SP70,PTBRADR1
                  IF        @EQUAL | @EOS
                    MATCH     SP70,PTBRADR2
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRADR3
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRADR4
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRPOST
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRHPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRWPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRMPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBREMAL
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    MATCH     SP70,PTBRLURN
                    IF        @EQUAL | @EOS
                      GOTO      CBEDG149
                    ENDIF
.
                    PACK      KEY8,PTBRLURN,SP70
                    CALL      RDMAST1
                    IF        OVRCD
                      PACK      KEY8,URNUMBER,SP70
                      CALL      RDMAST1
.
                      GOTO      CBEDG149
                    ENDIF
.
                    CALL      RDPMPX21
.
                    REP       "'`",PTBRSNAM
                    REP       "'`",PTBRGNAM
                    REP       "'`",PADD1
                    REP       "'`",PADD2
                    REP       "'`",PSUBRB
                    REP       "'`",PADD4
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                  WRITE     HTMLFILE;"<img src='../images/PatientLink1.gif' class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PADD1,"'":
                                                  ",'",PADD2,"'":
                                                  ",'",PSUBRB,"'":
                                                  ",'",PADD4,"'":
                                                  ",'",PPOST,"'":
                                                  ",'",PTELEP,"'":
                                                  ",'",PTELEB,"'":
                                                  ",'",PTMXCELL,"'":
                                                  ",'",PMPXPEML,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
                    PACK      KEY8,URNUMBER,SP70
                    CALL      RDMAST1
                    CALL      RDPMPX21
.
                  ELSE
CBEDG149            REP       "'`",PTBRSNAM
                    REP       "'`",PTBRGNAM
                    REP       "'`",PTBRADR1
                    REP       "'`",PTBRADR2
                    REP       "'`",PTBRADR3
                    REP       "'`",PTBRADR4
.
                WRITE     HTMLFILE;"<img src='../images/PatientLink1.gif' class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
                  ENDIF
.
.       MATCH     SP70,PTBRLURN
.       IF        @EQUAL | @EOS
.         WRITE     HTMLFILE;",'",PTBRURNO,"'";
.       ELSE
          WRITE     HTMLFILE;",'",PTBRLURN,"'";
.       ENDIF
.
        WRITE     HTMLFILE;",'",PTBRTITL,"'":
                           ",'",PTITL,"'":
                           ",'",PSNAME,"'":
                           ",'",PGNAME,"'":
                           ");#"":
                           " onmouseout=#"hideit();#">"
                ENDIF
            ENDIF
          ENDIF
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"</td></tr></table>"
          WRITE     HTMLFILE;"</td>";
.
. Discharge Direction column
.
          IF       CABONLY = ONE
            CALL     DSCHDI00 
          ENDIF    
.
. Theatre Status column
.
          IF       DISPTHET=1
            MATCH     "1",OPCNTHED
            IF        @EQUAL
              WRITE     HTMLFILE;"<td nowrap align=center>",CURSTATS;
              MATCH     SP70,CURSTATT
              IF        !@EQUAL & !@EOS
                WRITE      HTMLFILE;*+,"<br>",CURSTATT;
              ENDIF
              WRITE     HTMLFILE;"<br>",CURSTATB,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td nowrap align=center>":
                                  CURSTATS,"<br>",CURSTATB,"&nbsp;</td>";
            ENDIF
          ENDIF
.
. Diet column
.
          IF        HEAVIEW=1
            MOVE      "DC",CATEGORY
            MOVE      PMNUDIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDESC
          ELSE
            MOVE      "DC",CATEGORY
            MOVE      ADIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDESC
          ENDIF
.                                          * I CAR 48029
          IF        PTCNHDPS = ONE
            WRITE     HTMLFILE;"<td><img src='../images/DietIcon.gif' ":
                               " class=ListIcon onclick='UpdateDiet(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#")'>",DIETDESC,"<br> ";
.
            MATCH     "1",SKIPDIET
            IF        @EQUAL  
              WRITE     HTMLFILE;"</td>";
            ELSE
              WRITE     HTMLFILE;PMVXUDF4,"</td>";
            ENDIF
.
          ELSE
            IF        EXTRDIET = 1
              MOVE      "MJ",CATEGORY
              MOVE      PMNUML01,CODE
              CALL      GETCOD00
              MOVE      TDESC,DIETDSC2
              STRIP     DIETDSC2
.
              MOVE      "MJ",CATEGORY
              MOVE      PMNUML03,CODE
              CALL      GETCOD00
              MOVE      TDESC,DIETDSC3
              STRIP     DIETDSC3
.
              MOVE      "MJ",CATEGORY
              MOVE      PMNUML05,CODE
              CALL      GETCOD00
              MOVE      TDESC,DIETDSC4
              STRIP     DIETDSC4
.
              MOVE      "MJ",CATEGORY
              MOVE      PMNUML07,CODE
              CALL      GETCOD00
              MOVE      TDESC,DIETDSC5
              STRIP     DIETDSC5
.
              WRITE     HTMLFILE;"<td><img src='../images/DietIcon.gif' ":
                                 " class=ListIcon onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>";
.
              MATCH     "1",SKIPDIET
                IF        @EQUAL
                  WRITE     HTMLFILE;"</td>";
                ELSE
                  WRITE     HTMLFILE;DIETDESC,"<br>",DIETDSC2,"<br>",DIETDSC3,"<br>":
                            DIETDSC4,"<br>",DIETDSC5,"</td>";
                ENDIF
            ELSE
              WRITE     HTMLFILE;"<td><img src='../images/DietIcon.gif' ":
                                 " class=ListIcon onclick='UpdateDiet(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>";
.
              MATCH     "1",SKIPDIET
              IF        @EQUAL
                WRITE     HTMLFILE;"</td>";
              ELSE
                WRITE     HTMLFILE;DIETDESC,"</td>";
              ENDIF
            ENDIF
          ENDIF
.
. Fasting Column
.
          IF        FASTVIEW=ONE
            WRITE     HTMLFILE;"<td>",DTFASTNG,"</td>";
          ENDIF
.                                                                   * Car 235588
          IF        PTCNHDPS=ONE
            MOVE      "A ",CATEGORY
            MOVE      ATYPE,CODE
            CALL      GETCOD00
.
            MATCH     SP70,TDESC
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td>",TDESC,"</td>";
            ENDIF
          ENDIF
.
          IF        SJOGVIEW<>1
            GOTO      CBEDG154
          ENDIF
.
          MATCH     "1",PTCNDFAL            * Display Food Allergy
          IF        !@EQUAL
            MATCH     SP70,PTMIUSR9
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              PACK      KEY5,ANSU,NINE,PTMIUSR9,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;"<td>",TDESC,"</td>";
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;</td>";
              ENDIF
            ENDIF
            GOTO       CBEDG154
          ENDIF
.
.
          WRITE     HTMLFILE;"<td>";
          REPLACE   "+ ",URNUMBER
          PACK      KEY16,URNUMBER,CATH3,SP70
          CALL      RSPTALR1
          CALL      RKPTALR1                * Check if any H3 Alerts Exist?
          IF        OVRCD=1
            WRITE     HTMLFILE;"&nbsp;&nbsp;&nbsp; ";
            GOTO      CBEDG152
          ENDIF
.
          MATCH     URNUMBER,PTALURNO
          IF        !@EQUAL  
            WRITE     HTMLFILE;"&nbsp;&nbsp;&nbsp; ";
            GOTO      CBEDG152
          ENDIF 
.
          MATCH     CATH3,PTALCATG
          IF        @EQUAL
            WRITE     HTMLFILE;"Yes ";
          ELSE  
            WRITE     HTMLFILE;"&nbsp;&nbsp;&nbsp; ";
          ENDIF
.
CBEDG152  MATCH     SP70,PTMIUSR9
          IF        !@EQUAL
            PACK      KEY5,ANSU,NINE,PTMIUSR9,SP70  * Food Allergy flag at patient level?
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;" (",TDESC,")";
            ELSE
              WRITE     HTMLFILE;" (Unknown)";
            ENDIF
          ELSE
            WRITE     HTMLFILE;" (Unknown)";
          ENDIF
.
          REPLACE   " +",URNUMBER
          WRITE     HTMLFILE;"</td>"
.
CBEDG154  MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
          REP       " +",ADMISSNO
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
. Unit Doctor column
.
CBEDG155  WRITE     HTMLFILE;"<td nowrap>",TDESC,"<br>":
                             " <a href='":
                             "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                              SDOCFNAM,"</a>";
. 
          REP       "+ ",ADMISSNO
          MATCH     SP70,PMVXEDC1
          GOTO      CBEDG158 IF EQUAL
.
          PACK     KEY24,ADMISSNO,Z70
          CALL     RSPMDTC1
CBEDG156  CALL     RPPMDTC1
          BRANCH   OVRCD,CBEDG157
.
          MATCH    ADMISSNO,PMDTVISN
          GOTO     CBEDG157 IF NOT EQUAL
.
          MATCH    PMDTDOCT,PMVXEDC1
          GOTO     CBEDG156 IF NOT EQUAL
.
          MATCH    PMDTUNIT,PMVXEDU1
          GOTO     CBEDG156 IF NOT EQUAL
.
          MATCH    SP70,PMDTEDAT
          GOTO     CBEDG157 IF EQUAL
.
          MOVE     SP70,KEY8A
          MOVE     PMDTETIM,KEY8A
          MATCH    SP70,KEY8A
          IF       @EQUAL
            PACK     KEY8A,ZERO,ZERO,COLON,ZERO,ZERO,COLON,ZERO,ZERO
          ENDIF
.
          PACK     KEY16,PMDTEDAT,KEY8A,SP70
.
          CALL     IBACLOCK
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
          PACK     KEY16A,KEY8,CTIMEIS,SP70
.
          MATCH    KEY16A,KEY16
          GOTO     CBEDG158 IF LESS
.
CBEDG157  WRITE     HTMLFILE;SP1,SLASH,SP1,"<a href='":
                             "javascript:DoctorViewFrame(#"",PMVXEDC1,"#")'>":
                              SECDOCDE,"</a></td>";
.
CBEDG158  REP       " +",ADMISSNO
          MATCH     "1",ANAESTFL                                      *I-174468
          IF        @EQUAL
            MATCH     SP6,ANATNAME
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE 
              WRITE     HTMLFILE;"<td nowrap> <a href='":
                               "javascript:DoctorViewFrame(#"",ANATCODE,"#")'>":
                                ANATNAME,"</a></td>";
            ENDIF
          ENDIF
.
          IF        KIDSVEW2 = 1
            WRITE     HTMLFILE;"<td nowrap align=left>":
                                ACLAIM,"&nbsp;</td>";
          ENDIF
.
. Adm Date/Time, Exp Discharge, Exp Return From Leave column
.
CBEDG160  WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                               DISPDATE,ATIME,"<br>":
                               EXPCTDSC,"<br>";

          CALL      CHKMUL000
          IF        EXIT=0
            WRITE     HTMLFILE;"Current IP - ",MULTHOSP,"<br>";
          ENDIF 
.
          IF        FILETYPE=3
            WRITE     HTMLFILE;EXPLRETN;
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;</td>";
.
          COMPARE   "1",BULKDSCH
          GOTO      CBEDG300 IF NOT EQUAL
.
          PACK      KEY16,AADMNO,SP70
          CALL      RSPMRCB2
          CALL      RKPMRCB2
          BRANCH    OVRCD,CBEDG200
.
          MATCH     DAADMNO,PMRCADMN
          GOTO      CBEDG200 IF NOT EQUAL
.
          REP       " +",DAADMNO
          REP       " +",EXPCTDSC
.
          WRITE     HTMLFILE;"<td><input type=button name=discharg id=discharg value=":
         "'Discharge' onclick='dischargeAdm(this,#"",DAADMNO,"#",#"",EXPCTDSC,"#");'":
                             "></td>";
.
          REP       "+ ",DAADMNO
          REP       "+ ",EXPCTDSC
.
          GOTO      CBEDG300
.
CBEDG200  WRITE     HTMLFILE;"<td>&nbsp;</td>";
.
CBEDG300  MATCH     "1",PRNTLABL
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><input type=checkbox name=inplabar ":
                               "print-key='",AURNO,"|",AADMNO,"'":
                               "value='",AADMNO,"' ></td>";
          ENDIF
.
          IF     SJOGVIEW=ONE
            MOVE    SP70,DIM20
            MATCH     "1",PTCNWBDS
            IF        @EQUAL
              PACK      SAVKEY6,WWARD,WBED
              PACK      KEY6,PMVXPOWD,PMVXPOBD,SP70
              CALL      RDWARD1
              IF        OVRCD=1
                MOVE      "&nbsp;",WBDESC
              ELSE
               PACK    DIM20,PMVXPOWD,FRBRACK,WBDESC
               MOVE    DIM20,WBDESC
               MOVE    SP70,DIM20
              ENDIF
.
            ELSE
               MOVE    "&nbsp;",WBDESC

               MATCH   SP70,PMVXPOWD
               IF        !@EQUAL
                 MATCH   SP70,PMVXPOBD
                 IF        !@EQUAL
                   PACK    WBDESC,PMVXPOWD,FRBRACK,PMVXPOBD
                 ELSE
                   PACK    WBDESC,PMVXPOWD
                 ENDIF
               ELSE
                  MATCH   SP70,PMVXPOBD
                  IF        !@EQUAL
                    PACK      WBDESC,WBDESC,PMVXPOBD
                  ENDIF
               ENDIF
            ENDIF
.
            MATCH   SP70,PMVXIDUS
            IF      @EQUAL
              MOVE    "&nbsp;",DIM20
            ELSE
              PACK    KEY5,CATVI,PMVXIDUS
              CALL    RDCODE1
              IF      OVRCD=1
                MOVE    "&nbsp;",DIM20
              ENDIF
              MOVE    TDESC,DIM20
            ENDIF
.
            WRITE     HTMLFILE;"<td>",WBDESC,"</td>":
                               "<td>",DIM20,"</td>";
.
            MATCH     "1",PTCNWBDS
            IF      @EQUAL
              MOVE     SAVKEY6,KEY6
              CALL     RDWARD1
            ENDIF

          ENDIF
.
.
CBEDG900  WRITE     HTMLFILE;"</tr>"
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
CBEDG999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details - healthscope
.------------------------------------------------------------
CBEDJ000  CALL      FHRCLR00                * Clear FHIR Encounter Variable
          PACK      SECDOCDE,SP70
.
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CBEDJ010
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,CBEDJ010
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          CLEAR     SECDOCDE
          APPEND    PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
          RESET     SECDOCDE
.
CBEDJ010  CALL      GETAN000              * get Anaesthetist
          MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
          MOVE      SP70,CURSTATT
.
          IF        ANATFLAG = 1
            CALL      PATSTS00                * get theatre status
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CALL      XRET0000                * Exp return from leave date/time
.
          MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          IF        FHIRTYPE=1
            CALL      FHRENC00
            GOTO      CBEDJ999
          ENDIF
.
. Bed Column
.
CBEDJ050  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDJ090                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDJ060,CBEDJ070,CBEDJ080
.
CBEDJ060  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             "<img src='../images/EditIcon.gif'":
                             " class=ListIcon onclick='BedAllocation(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             "</td>"
          GOTO      CBEDJ090
.
CBEDJ070  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"<td align=center class=DarkGreyCell ":
                                 "title=#"",PTWDCOMM,"#" ":
                                 "bgcolor=gray>";
            ELSE
              WRITE     HTMLFILE;"<td align=center ":
                                 "title=#"",PTWDCOMM,"#">";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell ":
                               "title=#"",PTWDCOMM,"#">";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
          GOTO      CBEDJ090
.
CBEDJ080  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center class=DarkGreyCell ":
                               "title=#"",PTWDCOMM,"#" ":
                               "bgcolor=gray>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=RedCell ":
                               "title=#"",PTWDCOMM,"#">";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
.
.Patient Folder Column
. 
CBEDJ090  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
          IF        DISPDNAM=1
            REP       "+ ",ADMISSNO
            REP       "+ ",URNUMBER
            CALL      CHKD0000           * Duplicate Surnames?
            IF        DUPNMFLG=1
              WRITE     HTMLFILE;"<img src='../images/samename.gif'":
                                 " title='Patient Name Conflict'":
                                 " class=ListIcon>";
            ENDIF
            REP       " +",ADMISSNO
            REP       " +",URNUMBER
          ENDIF
.
          CALL      CLSBED00
          MOVE      SAVCLASS,WCLASS
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDJ092 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDJ092 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDJ092 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31,CLBEDDET,"</td>";
          GOTO      CBEDJ100
.
CBEDJ092  WRITE     HTMLFILE;FORMATNM,CLBEDDET,"</td>";
.
. Patient condition column
.       
CBEDJ100  CALL      GETCON00               * Get Patient Condition Details
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"<td>"
.
          WRITE     HTMLFILE;"<table border=0 width=100%><tr><td>"
.
          MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
.
CBEDJ110  MATCH     "1",PMPXSIN7
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                               " title='Medical Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          MATCH     "1",PMPXSIN8
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                               " title='Micro Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          MATCH     "1",PMPXSIN9
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                               " title='Risk Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          MATCH     "1",PMPXSN11
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                               " title='Chronic Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        EXIT=0 | EXIT=2
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      CBEDJ120
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      CBEDJ120
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      CBEDJ120
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
            ENDIF
          ENDIF
.
CBEDJ120  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " title='Disability Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        MEHLSFLG=1
            CALL      CMHL0000              * Check for MH legal status icon
          ENDIF
.
          IF        CNOTFLAG=1
            MATCH     SP70,PTMXSIN3
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/NotesIcon.gif'":
                                 " class=ListIcon ":
                                 " onclick='PatientNotes(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
            ENDIF
          ENDIF
.
.-------- Get Over flow description -------- 
.
          MOVE      SP70,OVFLDESC
.
          IF        WORKDFLG=1
            WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                               " class=ListIcon onclick='UpdateCondition(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#")'>":
                               CONDESC,DISPDATE,WORKDESC,OVFLDESC;
            GOTO      CBEDJ130
          ENDIF
.
          MATCH     SP70,LPCONDD
          IF        @EQUAL
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC;
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",PMVXUDF2;
            ENDIF
          ELSE
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD;
            ELSE
              WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                                 " class=ListIcon onclick='UpdateCondition(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#")'>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD:
                                 "<br>",PMVXUDF2;
            ENDIF
          ENDIF
.
CBEDJ130  MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE      ANSV,DIM1
          ENDIF
          WRITE     HTMLFILE;"<br>[",DIM1,COMMA,NBSP;
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE      ANSP,DIM1
          ENDIF
          WRITE     HTMLFILE;DIM1;
.
          MATCH     "1",PMVXPALW            * Phone Calls Allowed?
          GOTO      CBEDJ131 IF  NOT EQUAL  * no; close off output
.
.           No Bed...
.
          IF        FILETYPE=1
            PACK      KEY6,NBWARD,NBROOM,SP20
            CALL      RDWARD1
            BRANCH    OVRCD,CBEDJ131
          ENDIF
.
.           No Bed/On Leave
.
          IF        FILETYPE=1 | FILETYPE=3
            MATCH     SP70,PTWDNSTA
            IF        !@EQUAL
.
.             Has a linked Nursing Station
.
              MOVE      PTWDNSTA,NURSTCOD
              CALL      WNURN000            * get Nursing Station number
              MATCH     SP70,NURSTNUM
              IF        !@EQUAL
                STRIP     NURSTNUM
                WRITE     HTMLFILE;" - ",*+,NURSTNUM,*-;
              ELSE
                MATCH     SP70,WEXTN
                IF        !@EQUAL
                  STRIP     WEXTN
                  WRITE     HTMLFILE;" - ",*+,WEXTN,*-;
                ENDIF
              ENDIF
            ELSE
.
.             No linked Nursing Station
.
              MATCH     SP70,WEXTN
              IF        !@EQUAL
                STRIP     WEXTN
                WRITE     HTMLFILE;" - ",*+,WEXTN,*-;
              ENDIF
            ENDIF
          ELSE
.
.           Bed/Ward...
.
            MATCH     SP70,WEXTN
            IF        !@EQUAL
              STRIP     WEXTN
              WRITE     HTMLFILE;" - ",*+,WEXTN,*-;   * default ward/bed ext. no
            ELSE
              MOVE      PTWDNSTA,NURSTCOD
              CALL      WNURN000            * get Nursing Station number
              MATCH     SP70,NURSTNUM
              IF        !@EQUAL
                STRIP     NURSTNUM
                WRITE     HTMLFILE;" - ",*+,NURSTNUM,*-;
              ENDIF
            ENDIF
          ENDIF
.
CBEDJ131  WRITE     HTMLFILE;"]";
.
          MATCH     SP3,LPCONAM
          IF        !@EQUAL
            MOVE      "AM",CATEGORY
            MOVE      LPCONAM,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,NBSP,TDESC;
          ENDIF
.
CBEDJ140  MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
. Discharge desstination
.
          CALL      DSCHDS00 
          MATCH     SP70,DSCHDDET
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;DSCHDDET
          ENDIF
.
          WRITE     HTMLFILE;"</td>"
.
          WRITE     HTMLFILE;"<td align=right valign=top>"
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          UNPACK    SAVKEY27,PTVEVISN,PTVEVTYP,PTVESDAT,PTVESTIM
          WRITE     HTMLFILE;"<img src=../images/mv_",MVFLAG:
                             ".png class=ListIcon onclick='gotoMV(#"":
                             URNUMBER,"#",#"",PTVEVISN,"#",#"":
                             PTVEVTYP,"#",#"",PTVESDAT,"#",#"":
                             PTVESTIM,"#")'>";
.
          MOVE      ZERO,BORDICIN
          PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDJ142  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDJ142 IF LESS          
                GOTO      CBEDJ143 IF NOT EQUAL   
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDJ142 IF LESS     
                ENDIF
              ENDIF
CBEDJ143      ADD       ONE,BORDICIN
              COMPARE   TWO,BORDICIN
              GOTO      CBEDJ144 IF EQUAL
              GOTO      CBEDJ142
            ENDIF
          ENDIF
.
CBEDJ144  PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDJ145  CALL      RKPTBRD3
          BRANCH    OVRCD,CBEDJ350
.
          MATCH     ADMISSNO,PTBRVISN
          GOTO      CBEDJ350 IF NOT EQUAL
.
          MATCH     SP70,PTBREDAT
          IF        !@EQUAL & !@EOS
            MATCH     TODAYDAT,PTBREDAT
            GOTO      CBEDJ145 IF LESS      
            GOTO      CBEDJ146 IF NOT EQUAL
.
            MATCH     SP70,PTBRETIM
            IF        !@EQUAL & !@EOS
              MATCH     CTIMEIS,PTBRETIM
              GOTO      CBEDJ145 IF LESS  
            ENDIF
          ENDIF
.
CBEDJ146  MOVE      SP70,DISPBBDT
          MATCH     SP70,PTBRBDAT
          IF        !@EQUAL & !@EOS
            UNPACK    PTBRBDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                 JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPBBDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            CALL      IBACLOCK
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            PACK      PBDATE,PTBRBDAT
            CALL      CALCAGE
            MOVE      PSAGEYRS,PSAGEDIM
          ELSE
            MOVE      SP70,PSAGEDIM
          ENDIF
.
          MOVE      SP70,DISPBSDT
          MATCH     SP70,PTBRSDAT
          IF        !@EQUAL & !@EOS
            UNPACK    PTBRSDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                 JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPBSDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          IF        BORDICIN=2
            MATCH     SP70,PTBRADR1
            IF        @EQUAL | @EOS
              MATCH     SP70,PTBRADR2
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ147
              ENDIF
.
              MATCH     SP70,PTBRADR3
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ147
              ENDIF
.
              MATCH     SP70,PTBRADR4
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ147
              ENDIF
.
              MATCH     SP70,PTBRPOST
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ147
              ENDIF
.
              MATCH     SP70,PTBRHPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ147
              ENDIF
.
              MATCH     SP70,PTBRWPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ147
              ENDIF
.
              MATCH     SP70,PTBRMPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ147
              ENDIF
.
              MATCH     SP70,PTBREMAL
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ147
              ENDIF
.
              MATCH     SP70,PTBRLURN
              IF        @EQUAL | @EOS
                GOTO      CBEDJ147
              ENDIF
.
              PACK      KEY8,PTBRLURN,SP70
              CALL      RDMAST1
              IF        OVRCD
                PACK      KEY8,URNUMBER,SP70
                CALL      RDMAST1
.
                GOTO      CBEDJ147
              ENDIF
.
              CALL      RDPMPX21
.
              REP       "'`",PTBRSNAM
              REP       "'`",PTBRGNAM
              REP       "'`",PADD1
              REP       "'`",PADD2
              REP       "'`",PSUBRB
              REP       "'`",PADD4
              REP       "'`",PTELEP
              REP       "'`",PTELEB
.
              WRITE     HTMLFILE;"<img src='../images/PatientLink4.gif'":
                        " class=ListIcon":
                        " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                        "','",PTBRBRDN,"');#"":
                        " onmouseover=#"showit('",PTBRSNAM,"'":
                                               ",'",PTBRGNAM,"'":
                                               ",'",PTBRGEND,"'":
                                               ",'",DISPBBDT,"'":
                                               ",'",PSAGEDIM,"'":
                                               ",'",PADD1,"'":
                                               ",'",PADD2,"'":
                                               ",'",PSUBRB,"'":
                                               ",'",PADD4,"'":
                                               ",'",PPOST,"'":
                                               ",'",PTELEP,"'":
                                               ",'",PTELEB,"'":
                                               ",'",PTMXCELL,"'":
                                               ",'",PMPXPEML,"'":
                                               ",'",DISPBSDT,"'":
                                               ",'",PTBRSTIM,"'";
              PACK      KEY8,URNUMBER,SP70
              CALL      RDMAST1
              CALL      RDPMPX21
.
            ELSE
CBEDJ147      REP       "'`",PTBRSNAM
              REP       "'`",PTBRGNAM
              REP       "'`",PTBRADR1
              REP       "'`",PTBRADR2
              REP       "'`",PTBRADR3
              REP       "'`",PTBRADR4
.
              WRITE     HTMLFILE;"<img src='../images/PatientLink4.gif'":
                          " class=ListIcon":
                          " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                          "','",PTBRBRDN,"');#"":
                          " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
            ENDIF
            WRITE     HTMLFILE;",'",PTBRLURN,"'";
.
            WRITE     HTMLFILE;",'",PTBRTITL,"'":
                               ",'",PTITL,"'":
                               ",'",PSNAME,"'":
                               ",'",PGNAME,"'":
                               ");#"":
                               " onmouseout=#"hideit();#">"
          ELSE     
. BORDICIN <> 2
            MATCH     SP70,PTBRADR1
            IF        @EQUAL | @EOS
              MATCH     SP70,PTBRADR2
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ149
              ENDIF
.
              MATCH     SP70,PTBRADR3
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ149
              ENDIF
.
              MATCH     SP70,PTBRADR4
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ149
              ENDIF
.
              MATCH     SP70,PTBRPOST
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ149
              ENDIF
.
              MATCH     SP70,PTBRHPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ149
              ENDIF
.
              MATCH     SP70,PTBRMPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ149
              ENDIF
.
              MATCH     SP70,PTBREMAL
              IF        !@EQUAL & !@EOS
                GOTO      CBEDJ149
              ENDIF
.
              MATCH     SP70,PTBRLURN
              IF        @EQUAL | @EOS
                GOTO      CBEDJ149
              ENDIF
.
              PACK      KEY8,PTBRLURN,SP70
              CALL      RDMAST1
              IF        OVRCD
                PACK      KEY8,URNUMBER,SP70
                CALL      RDMAST1
.
                GOTO      CBEDJ149
              ENDIF
.
              CALL      RDPMPX21
.
              REP       "'`",PTBRSNAM
              REP       "'`",PTBRGNAM
              REP       "'`",PADD1
              REP       "'`",PADD2
              REP       "'`",PSUBRB
              REP       "'`",PADD4
              REP       "'`",PTELEP
              REP       "'`",PTELEB
.
              WRITE     HTMLFILE;"<img src='../images/PatientLink1.gif'":
                           " class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PADD1,"'":
                                                  ",'",PADD2,"'":
                                                  ",'",PSUBRB,"'":
                                                  ",'",PADD4,"'":
                                                  ",'",PPOST,"'":
                                                  ",'",PTELEP,"'":
                                                  ",'",PTELEB,"'":
                                                  ",'",PTMXCELL,"'":
                                                  ",'",PMPXPEML,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
              PACK      KEY8,URNUMBER,SP70
              CALL      RDMAST1
              CALL      RDPMPX21
.
            ELSE
CBEDJ149      REP       "'`",PTBRSNAM
              REP       "'`",PTBRGNAM
              REP       "'`",PTBRADR1
              REP       "'`",PTBRADR2
              REP       "'`",PTBRADR3
              REP       "'`",PTBRADR4
.
              WRITE     HTMLFILE;"<img src='../images/PatientLink1.gif'":
                           " class=ListIcon":
                           " onclick=#"gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');#"":
                           " onmouseover=#"showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
            ENDIF
.
            WRITE     HTMLFILE;",'",PTBRLURN,"'";
.
            WRITE     HTMLFILE;",'",PTBRTITL,"'":
                               ",'",PTITL,"'":
                               ",'",PSNAME,"'":
                               ",'",PGNAME,"'":
                               ");#"":
                               " onmouseout=#"hideit();#">"
          ENDIF
.            
CBEDJ350  WRITE     HTMLFILE;"</td></tr></table>"
          WRITE     HTMLFILE;"</td>";
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
. Theatre Status
.
CBEDJ400  IF       DISPTHET=1
            MATCH     "1",OPCNTHED
            IF        @EQUAL
              WRITE     HTMLFILE;"<td nowrap align=center>",CURSTATS;
              MATCH     SP70,CURSTATT
              IF        !@EQUAL & !@EOS
                WRITE      HTMLFILE;*+,"<br>",CURSTATT;
              ENDIF
              WRITE     HTMLFILE;"<br>",CURSTATB,"&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td nowrap align=center>":
                                  CURSTATS,"<br>",CURSTATB,"&nbsp;</td>";
            ENDIF
          ENDIF
.
. Diet Column
.
CBEDJ500  MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIETDESC
.                  
          IF        EXTRDIET = 1
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML01,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC2
            STRIP     DIETDSC2
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML03,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC3
            STRIP     DIETDSC3
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML05,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC4
            STRIP     DIETDSC4
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML07,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC5
            STRIP     DIETDSC5
.
            WRITE     HTMLFILE;"<td><img src='../images/DietIcon.gif' ":
                               " class=ListIcon onclick='UpdateDiet(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#")'>";
.
            WRITE     HTMLFILE;"</td>";
          ELSE
            WRITE     HTMLFILE;"<td><img src='../images/DietIcon.gif' ":
                               " class=ListIcon onclick='UpdateDiet(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#")'>";
.
            WRITE     HTMLFILE;"</td>";
          ENDIF
.
. Fasting Column
.
CBEDJ510  IF        FASTVIEW=ONE
            WRITE     HTMLFILE;"<td>",DTFASTNG,"</td>";
          ENDIF
.                                            
CBEDJ520  REP       "+ ",ADMISSNO
          MOVE      ADIAG1,DIADESC1
          MOVE      ADIAG2,DIADESC2
          STRIP     DIADESC1
          STRIP     DIADESC2 
          CALL      OUTLR000
          MATCH     ANSY,MISMTFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>",DIADESC1,"<br>",DIADESC2:
                               "<img src='../images/Mismatch.jpg' ":
                               "class=Icon align=right></td>"
            ADD       ONE,NUMBOUTL
          ELSE
            WRITE     HTMLFILE;"<td>",DIADESC1,"<br>",DIADESC2
          ENDIF
.
. Unit Doctor
.
CBEDJ700  MOVE      SP70,TDESC
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
CBEDJ750  WRITE     HTMLFILE;"<td nowrap>",TDESC,"<br>":
                             " <a href='":
                             "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                              SDOCFNAM,"</a>";
.
          MATCH     SP70,PMVXEDC1
          GOTO      CBEDJ780 IF EQUAL
.
          PACK     KEY24,ADMISSNO,Z70
          CALL     RSPMDTC1
CBEDJ760  CALL     RPPMDTC1
          BRANCH   OVRCD,CBEDJ770
.
          MATCH    ADMISSNO,PMDTVISN
          GOTO     CBEDJ770 IF NOT EQUAL
.
          MATCH    PMDTDOCT,PMVXEDC1
          GOTO     CBEDJ760 IF NOT EQUAL
.
          MATCH    PMDTUNIT,PMVXEDU1
          GOTO     CBEDJ760 IF NOT EQUAL
.
          MATCH    SP70,PMDTEDAT
          GOTO     CBEDJ770 IF EQUAL
.
          MOVE     SP70,KEY8A
          MOVE     PMDTETIM,KEY8A
          MATCH    SP70,KEY8A
          IF       @EQUAL
            PACK     KEY8A,ZERO,ZERO,COLON,ZERO,ZERO,COLON,ZERO,ZERO
          ENDIF
.
          PACK     KEY16,PMDTEDAT,KEY8A,SP70
.
          CALL     IBACLOCK
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
          PACK     KEY16A,KEY8,CTIMEIS,SP70
.
          MATCH    KEY16A,KEY16
          GOTO     CBEDJ780 IF LESS
.
CBEDJ770  WRITE     HTMLFILE;SP1,SLASH,SP1,"<a href='":
                             "javascript:DoctorViewFrame(#"",PMVXEDC1,"#")'>":
                              SECDOCDE,"</a></td>";
.
CBEDJ780  REP       " +",ADMISSNO
          MATCH     "1",ANAESTFL                                      *I-174468
          IF        @EQUAL
            MATCH     SP6,ANATNAME
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;</td>";
            ELSE
              WRITE     HTMLFILE;"<td nowrap> <a href='":
                               "javascript:DoctorViewFrame(#"",ANATCODE,"#")'>":
                                ANATNAME,"</a></td>";
            ENDIF
          ENDIF
.
. Adm Date/Time Column
.
CBEDJ800  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CALL      SEXPCL00
          WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                               DISPDATE,ATIME,"<br>":
                               EXPCTDSC,"<br>";
.
          CALL      CHKMUL000
          IF        EXIT=0
            WRITE     HTMLFILE;"Current IP - ",MULTHOSP,"<br>";
          ENDIF
.
          IF        FILETYPE=3
            WRITE     HTMLFILE;EXPLRETN;
          ENDIF
.
          WRITE     HTMLFILE;"&nbsp;</td>";
.
CBEDJ900  WRITE     HTMLFILE;"</tr>"
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDJ999  RETURN
.
.--------------------------------------------------------------------
. Current Admissions Patient Details - healthscope (sorted addcolumn)
.--------------------------------------------------------------------
CBEDK000  CALL      FHRCLR00                * Clear FHIR Encounter Variable
          PACK      SECDOCDE,SP70
.
          CALL      GETPAT00
.
          IF        FHIRTYPE=1
            MATCH     SP70,FRSTDATE         * check frstdate available
            GOTO      CBEDK005 IF EQUAL
            GOTO      CBEDK005 IF EOS
            MATCH     FRSTDATE,ADATE
            GOTO      CBEDK999 IF LESS
            MATCH     ADATE,LASTDATE
            GOTO      CBEDK999 IF LESS
          ENDIF
.
CBEDK005  CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CBEDK010
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,CBEDK010
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          CLEAR     SECDOCDE
          APPEND    PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
          RESET     SECDOCDE
.
CBEDK010  CALL      GETAN000              * get Anaesthetist
          MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
          MOVE      SP70,CURSTATT
.
          IF        ANATFLAG = 1
            CALL      PATSTS00                * get theatre status
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CALL      XRET0000                * Exp return from leave date/time
.
          MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          IF        FHIRTYPE=1
            CALL      FHRENC00
            GOTO      CBEDK999
          ENDIF
.
. Bed Column
.
CBEDK050  CALL      FBED0000
          REP       UPPLOW,BEDTEXT
          ADD       ONE,CRSRTCNT
          MOVE      SP70,DIM3
          MOVE      CRSRTCNT,DIM3
          REP       " +",DIM3
.
          BRANCH    FILETYPE,CBEDK060,CBEDK070,CBEDK080
.
CBEDK060  WRITE     HTMLFILE;"t.addRow(#"UnallocatedCell":
                             "#",#"":
                             "<input type=hidden name='",DIM3,"'>":
                             "<img src='../images/EditIcon.gif'":
                             " class=ListIcon onclick=BedAllocation('":
                             URNUMBER,"','",ADMISSNO,"')> ",BEDTEXT,"#",";
          GOTO      CBEDK090
.
CBEDK070  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"t.addRow(#"DarkGreyCell ":
                                 "bgcolor=gray":
                                 "#",#"":
                                 "<input type=hidden name='",DIM3,"'>":
                                 BEDTEXT,"#",";
            ELSE
              WRITE     HTMLFILE;"t.addRow(#"":
                                 "#",#"":
                                 "<input type=hidden name='",DIM3,"'>":
                                 BEDTEXT,"#",";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"StandbyCell":
                               "#",#"":
                               "<input type=hidden name='",DIM3,"'>":
                               BEDTEXT,"#",";
          ENDIF
.
          GOTO      CBEDK090
.
CBEDK080  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"t.addRow(#"DarkGreyCell ":
                               "bgcolor=gray":
                               "#",#"":
                               "<input type=hidden name='",DIM3,"'>":
                               BEDTEXT,"#",";
          ELSE
            IF        ONLEAVET = 1
              WRITE     HTMLFILE;"t.addRow(#"YellowCell ":
                                 "#",#"":
                                 "<input type=hidden name='",DIM3,"'>":
                                 BEDTEXT,"#",";
              
            ELSE
              WRITE     HTMLFILE;"t.addRow(#"RedCell ":
                                 "#",#"":
                                 "<input type=hidden name='",DIM3,"'>":
                                 BEDTEXT,"#",";
            ENDIF
          ENDIF
.
.Patient Folder Column
.
CBEDK090  PACK      DIM127A,SP70,SP70
          MOVE      FORMATNM,DIM127A
          REPLACE   "' ",DIM127A
.
          WRITE     HTMLFILE;"#"":
                "<input type=hidden value='",DIM127A,"' name='",ADMISSNO,"'>":
                           "<img src='../images/PatientFolder",FOLDERSF,".gif'":
                             " class=ListIcon ":
                             " onclick=PatFolLink('",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"');>";
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          CALL      CHKD0000           * Duplicate Surnames?
          IF        DUPNMFLG=1
            WRITE     HTMLFILE;"<img src='../images/samename.gif'":
                               " title='Patient Name Conflict'":
                               " class=ListIcon>";
          ENDIF
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CALL      CLSBED00
          MOVE      SAVCLASS,WCLASS
          STRIP     FORMATNM
          STRIP     CLBEDDET 
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDK092 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDK092 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDK092 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31,CLBEDDET,"#",";
          GOTO      CBEDK100
.
CBEDK092  WRITE     HTMLFILE;FORMATNM,CLBEDDET,"#",";
.
. Patient condition column
.
CBEDK100  CALL      GETCON00               * Get Patient Condition Details
          STRIP     IMGSRC 
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"#"";
.
          REP       " +",CONDESC1
          WRITE     HTMLFILE;"<input type=hidden name='",CONDESC1,"'>";
          REP       "+ ",CONDESC1
.
          MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
.
CBEDK110  MATCH     "1",PMPXSIN7
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                               " title='Medical Alerts'":
                               " class=ListIcon onclick=PatientAlerts('":
                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
          MATCH     "1",PMPXSIN8
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                               " title='Micro Alerts'":
                               " class=ListIcon onclick=PatientAlerts('":
                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
          MATCH     "1",PMPXSIN9
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                               " title='Risk Alerts'":
                               " class=ListIcon onclick=PatientAlerts('":
                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
          MATCH     "1",PMPXSN11
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                               " title='Chronic Alerts'":
                               " class=ListIcon onclick=PatientAlerts('":
                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
          IF        EXIT=0 | EXIT=2
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
              GOTO      CBEDK120
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
              GOTO      CBEDK120
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
              GOTO      CBEDK120
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
          ENDIF
.
CBEDK120  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " title='Disability Alerts'":
                               " class=ListIcon onclick=PatientAlerts('":
                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
          IF        MEHLSFLG=1
            CALL      CMHL0000              * Check for MH legal status icon
          ENDIF
.
          MATCH     SP70,PTMXSIN3
          IF        !@EQUAL
            WRITE     HTMLFILE;"<img src='../images/NotesIcon.gif'":
                               " class=ListIcon ":
                               " onclick=PatientNotes('":
                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
.-------- Get Over flow description --------
.
          MOVE      SP70,OVFLDESC
          CALL      OVFDS000                         * Get OVFLDESC
.
          IF        WORKDFLG=1
            WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                               "' class=ListIcon onclick=UpdateCondition('":
                               URNUMBER,"','",ADMISSNO,"')>":
                               CONDESC,DISPDATE,WORKDESC,OVFLDESC;
            GOTO      CBEDK130
          ENDIF
.
          MATCH     SP70,LPCONDD
          IF        @EQUAL
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC;
            ELSE
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",PMVXUDF2;
            ENDIF
          ELSE
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD;
            ELSE
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD:
                                 "<br>",PMVXUDF2;
            ENDIF
          ENDIF
.
CBEDK130  MATCH     SP70,PMPXABRG           * Aboriginality (Cat VA) FLAG
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSA,PMPXABRG,SP70 
            CALL      RDCODE1
            IF        OVRCD = 0
              MATCH     ANSD,TCINDC3
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/aboriginality.png'":
                                   " title='aboriginalityIcon' >"; 
              ENDIF 
            ENDIF
          ENDIF
.
          MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE      ANSV,DIM1
          ENDIF
          WRITE     HTMLFILE;"<br>[",DIM1,COMMA,NBSP;
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE      ANSP,DIM1
          ENDIF
          WRITE     HTMLFILE;DIM1;
.
          MATCH     "1",PMVXPALW            * Phone Calls Allowed?
          GOTO      CBEDK131 IF  NOT EQUAL  * no; close off output
.
.           No Bed...
.
          IF        FILETYPE=1
            PACK      KEY6,NBWARD,NBROOM,SP20
            CALL      RDWARD1
            BRANCH    OVRCD,CBEDK131
          ENDIF
.
.           No Bed/On Leave
.
          IF        FILETYPE=1 | FILETYPE=3
            MATCH     SP70,PTWDNSTA
            IF        !@EQUAL
.
.             Has a linked Nursing Station
.
              MOVE      PTWDNSTA,NURSTCOD
              CALL      WNURN000            * get Nursing Station number
              MATCH     SP70,NURSTNUM
              IF        !@EQUAL
                STRIP     NURSTNUM
                WRITE     HTMLFILE;" - ",*+,NURSTNUM,*-;
              ELSE
                MATCH     SP70,WEXTN
                IF        !@EQUAL
                  STRIP     WEXTN
                  WRITE     HTMLFILE;" - ",*+,WEXTN,*-;
                ENDIF
              ENDIF
            ELSE
.
.             No linked Nursing Station
.
              MATCH     SP70,WEXTN
              IF        !@EQUAL
                STRIP     WEXTN
                WRITE     HTMLFILE;" - ",*+,WEXTN,*-;
              ENDIF
            ENDIF
          ELSE
.
.           Bed/Ward...
.
            MATCH     SP70,WEXTN
            IF        !@EQUAL
              STRIP     WEXTN
              WRITE     HTMLFILE;" - ",*+,WEXTN,*-;   * default ward/bed ext. no
            ELSE
              MOVE      PTWDNSTA,NURSTCOD
              CALL      WNURN000            * get Nursing Station number
              MATCH     SP70,NURSTNUM
              IF        !@EQUAL
                STRIP     NURSTNUM
                WRITE     HTMLFILE;" - ",*+,NURSTNUM,*-;
              ENDIF
            ENDIF
          ENDIF
.
CBEDK131  WRITE     HTMLFILE;"]";
.
          MATCH     SP3,LPCONAM
          IF        !@EQUAL
            MOVE      "AM",CATEGORY
            MOVE      LPCONAM,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,NBSP,TDESC;
          ENDIF
.
          MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
. Discharge desstination
.
          CALL      DSCHDS00
          MATCH     SP70,DSCHDDET
          IF        !@EQUAL & !@EOS
            WRITE     HTMLFILE;DSCHDDET;
          ENDIF
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
CBEDK140  UNPACK    SAVKEY27,PTVEVISN,PTVEVTYP,PTVESDAT,PTVESTIM
          REP       " +",URNUMBER
          REP       " +",PTVEVISN
          REP       " +",PTVEVTYP
          REP       " +",PTVESDAT
          REP       " +",PTVESTIM
.
          WRITE     HTMLFILE;"<img src='../images/mv_",MVFLAG:
                             ".png' class=ListIcon style='float:right'":
                             " onclick=gotoMV(#'":
                             URNUMBER,"','",PTVEVISN,"','":
                             PTVEVTYP,"','",PTVESDAT,"','":
                             PTVESTIM,"');>";
.
          REP       "+ ",URNUMBER
          REP       "+ ",PTVEVISN
          REP       "+ ",PTVEVTYP
          REP       "+ ",PTVESDAT
          REP       "+ ",PTVESTIM
.
          MOVE      ZERO,BORDICIN
          PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDK142  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDK142 IF LESS
                GOTO      CBEDK143 IF NOT EQUAL
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDK142 IF LESS
                ENDIF
              ENDIF
CBEDK143      ADD       ONE,BORDICIN
              COMPARE   TWO,BORDICIN
              GOTO      CBEDK144 IF EQUAL
              GOTO      CBEDK142
            ENDIF
          ENDIF
.
CBEDK144  PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDK145  CALL      RKPTBRD3
          BRANCH    OVRCD,CBEDK350
.
          MATCH     ADMISSNO,PTBRVISN
          GOTO      CBEDK350 IF NOT EQUAL
.
          MATCH     SP70,PTBREDAT
          IF        !@EQUAL & !@EOS
            MATCH     TODAYDAT,PTBREDAT
            GOTO      CBEDK145 IF LESS
            GOTO      CBEDK146 IF NOT EQUAL
.
            MATCH     SP70,PTBRETIM
            IF        !@EQUAL & !@EOS
              MATCH     CTIMEIS,PTBRETIM
              GOTO      CBEDK145 IF LESS
            ENDIF
          ENDIF
.
CBEDK146  MOVE      SP70,DISPBBDT
          MATCH     SP70,PTBRBDAT
          IF        !@EQUAL & !@EOS
            UNPACK    PTBRBDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                 JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPBBDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
            CALL      IBACLOCK
            PACK      AGEDATE,CCC,CYY,CMM,CDD
            PACK      PBDATE,PTBRBDAT
            CALL      CALCAGE
            MOVE      PSAGEYRS,PSAGEDIM
          ELSE
            MOVE      SP70,PSAGEDIM
          ENDIF
.
          MOVE      SP70,DISPBSDT
          MATCH     SP70,PTBRSDAT
          IF        !@EQUAL & !@EOS
            UNPACK    PTBRSDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                 JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DISPBSDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          IF        BORDICIN=2
            MATCH     SP70,PTBRADR1
            IF        @EQUAL | @EOS
              MATCH     SP70,PTBRADR2
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK147
              ENDIF
.
              MATCH     SP70,PTBRADR3
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK147
              ENDIF
.
              MATCH     SP70,PTBRADR4
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK147
              ENDIF
.
              MATCH     SP70,PTBRPOST
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK147
              ENDIF
.
              MATCH     SP70,PTBRHPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK147
              ENDIF
.
              MATCH     SP70,PTBRWPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK147
              ENDIF
.
              MATCH     SP70,PTBRMPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK147
              ENDIF
.
              MATCH     SP70,PTBREMAL
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK147
              ENDIF
.
              MATCH     SP70,PTBRLURN
              IF        @EQUAL | @EOS
                GOTO      CBEDK147
              ENDIF
.
              PACK      KEY8,PTBRLURN,SP70
              CALL      RDMAST1
              IF        OVRCD = 1
                PACK      KEY8,URNUMBER,SP70
                CALL      RDMAST1
.
                GOTO      CBEDK147
              ENDIF
.
              CALL      RDPMPX21
.
              REP       "'`",PTBRSNAM
              REP       "'`",PTBRGNAM
              REP       "'`",PADD1
              REP       "'`",PADD2
              REP       "'`",PSUBRB
              REP       "'`",PADD4
              REP       "'`",PTELEP
              REP       "'`",PTELEB
.
              REP       " +",ADMISSNO
              REP       " +",URNUMBER
              REP       " +",PTBRBRDN
.
              WRITE     HTMLFILE;"<img src='../images/PatientLink4.gif'":
                        " class=ListIcon align=right":
                        " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                        "','",PTBRBRDN,"')";
.
              CALL      SHOWHD00
.
              REP       "+ ",ADMISSNO
              REP       "+ ",URNUMBER
              REP       "+ ",PTBRBRDN
.
              PACK      KEY8,URNUMBER,SP70
              CALL      RDMAST1
              CALL      RDPMPX21
.
            ELSE
CBEDK147      REP       "'`",PTBRSNAM
              REP       "'`",PTBRGNAM
              REP       "'`",PTBRADR1
              REP       "'`",PTBRADR2
              REP       "'`",PTBRADR3
              REP       "'`",PTBRADR4
.
              REP       " +",ADMISSNO
              REP       " +",URNUMBER
              REP       " +",PTBRBRDN
.
              WRITE     HTMLFILE;"<img src='../images/PatientLink4.gif'":
                        " class=ListIcon align=right":
                        " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                        "','",PTBRBRDN,"')";
.
              CALL      SHOWHD10
.
              REP       "+ ",ADMISSNO
              REP       "+ ",URNUMBER
              REP       "+ ",PTBRBRDN
. 
            ENDIF
          ELSE
. BORDICIN <> 2
            MATCH     SP70,PTBRADR1
            IF        @EQUAL | @EOS
              MATCH     SP70,PTBRADR2
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK149
              ENDIF
.
              MATCH     SP70,PTBRADR3
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK149
              ENDIF
.
              MATCH     SP70,PTBRADR4
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK149
              ENDIF
.
              MATCH     SP70,PTBRPOST
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK149
              ENDIF
.
              MATCH     SP70,PTBRHPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK149
              ENDIF
.
              MATCH     SP70,PTBRMPHN
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK149
              ENDIF
.
              MATCH     SP70,PTBREMAL
              IF        !@EQUAL & !@EOS
                GOTO      CBEDK149
              ENDIF
.
              MATCH     SP70,PTBRLURN
              IF        @EQUAL | @EOS
                GOTO      CBEDK149
              ENDIF
.
              PACK      KEY8,PTBRLURN,SP70
              CALL      RDMAST1
              IF        OVRCD = 1
                PACK      KEY8,URNUMBER,SP70
                CALL      RDMAST1
.
                GOTO      CBEDK149
              ENDIF
.
              CALL      RDPMPX21
.
              REP       "'`",PTBRSNAM
              REP       "'`",PTBRGNAM
              REP       "'`",PADD1
              REP       "'`",PADD2
              REP       "'`",PSUBRB
              REP       "'`",PADD4
              REP       "'`",PTELEP
              REP       "'`",PTELEB
.
              REP       " +",ADMISSNO
              REP       " +",URNUMBER
              REP       " +",PTBRBRDN
.
              WRITE     HTMLFILE;"<img src='../images/PatientLink1.gif'":
                           " class=ListIcon align=right":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"')";
.
              CALL      SHOWHD00
.
              REP       "+ ",ADMISSNO
              REP       "+ ",URNUMBER
              REP       "+ ",PTBRBRDN
.
              PACK      KEY8,URNUMBER,SP70
              CALL      RDMAST1
              CALL      RDPMPX21
.
            ELSE
CBEDK149      REP       "'`",PTBRSNAM
              REP       "'`",PTBRGNAM
              REP       "'`",PTBRADR1
              REP       "'`",PTBRADR2
              REP       "'`",PTBRADR3
              REP       "'`",PTBRADR4
.
              REP       " +",ADMISSNO
              REP       " +",URNUMBER
              REP       " +",PTBRBRDN
.
              WRITE     HTMLFILE;"<img src='../images/PatientLink1.gif'":
                           " class=ListIcon align=right":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"')";
.
              CALL      SHOWHD10 
.
              REP       "+ ",ADMISSNO
              REP       "+ ",URNUMBER
              REP       "+ ",PTBRBRDN
            ENDIF
          ENDIF
.
CBEDK350  WRITE     HTMLFILE;"#",";
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
. Theatre Status
.
CBEDK400  MATCH     "1",OPCNTHED
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",CURSTATS;
            MATCH     SP70,CURSTATT
            IF        !@EQUAL & !@EOS
              WRITE      HTMLFILE;*+,"<br>",CURSTATT;
            ENDIF
            WRITE     HTMLFILE;"<br>",CURSTATB,"&nbsp;#",";
          ELSE
            WRITE     HTMLFILE;"#"":
                               CURSTATS,"<br>",CURSTATB,"&nbsp;#",";
          ENDIF
.
. Diet Column
.
CBEDK500  WRITE     HTMLFILE;"#"";
.
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIETDESC
.
          IF        EXTRDIET = 1
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML01,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC2
            STRIP     DIETDSC2
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML03,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC3
            STRIP     DIETDSC3
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML05,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC4
            STRIP     DIETDSC4
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML07,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC5
            STRIP     DIETDSC5
.
            WRITE     HTMLFILE;"<img src='../images/DietIcon.gif' ":
                               " class=ListIcon onclick=UpdateDiet('":
                               URNUMBER,"','",ADMISSNO,"')>";
.
            WRITE     HTMLFILE;"#",";
          ELSE
            WRITE     HTMLFILE;"<img src='../images/DietIcon.gif' ":
                               " class=ListIcon onclick=UpdateDiet('":
                               URNUMBER,"','",ADMISSNO,"')>";
.
            WRITE     HTMLFILE;"#",";

          ENDIF
.
CBEDK520  REP       "+ ",ADMISSNO
          MOVE      ADIAG1,DIADESC1
          MOVE      ADIAG2,DIADESC2
          STRIP     DIADESC1
          STRIP     DIADESC2
          CALL      OUTLR000
          MATCH     ANSY,MISMTFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DIADESC1,"<br>",DIADESC2:
                               "<img src='../images/Mismatch.jpg' ":
                               "class=Icon align=right>#",";
            ADD       ONE,NUMBOUTL
          ELSE
            WRITE     HTMLFILE;"#"",DIADESC1,"<br>",DIADESC2,"#",";
          ENDIF
.
. Unit Doctor
.
CBEDK700  MOVE      SP70,TDESC
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
CBEDK750  REP       " +",DOCTCODE 
          WRITE     HTMLFILE;"#"",TDESC,"<br>":
                             " <a href=":
                             "javascript:DoctorViewFrame('",DOCTCODE,"')>":
                              SDOCFNAM,"</a>";
          REP       "+ ",DOCTCODE
.
          MATCH     SP70,PMVXEDC1
          GOTO      CBEDK780 IF EQUAL
.
          PACK     KEY24,ADMISSNO,Z70
          CALL     RSPMDTC1
CBEDK760  CALL     RPPMDTC1
          BRANCH   OVRCD,CBEDK770
.
          MATCH    ADMISSNO,PMDTVISN
          GOTO     CBEDK770 IF NOT EQUAL
.
          MATCH    PMDTDOCT,PMVXEDC1
          GOTO     CBEDK760 IF NOT EQUAL
.
          MATCH    PMDTUNIT,PMVXEDU1
          GOTO     CBEDK760 IF NOT EQUAL
.
          MATCH    SP70,PMDTEDAT
          GOTO     CBEDK770 IF EQUAL
.
          MOVE     SP70,KEY8A
          MOVE     PMDTETIM,KEY8A
          MATCH    SP70,KEY8A
          IF       @EQUAL
            PACK     KEY8A,ZERO,ZERO,COLON,ZERO,ZERO,COLON,ZERO,ZERO
          ENDIF
.
          PACK     KEY16,PMDTEDAT,KEY8A,SP70
.
          CALL     IBACLOCK
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
          PACK     KEY16A,KEY8,CTIMEIS,SP70
.
          MATCH    KEY16A,KEY16
          GOTO     CBEDK780 IF LESS
.
CBEDK770  REP       " +",PMVXEDC1
          WRITE     HTMLFILE;SP1,SLASH,SP1,"<a href=":
                             "javascript:DoctorViewFrame('",PMVXEDC1,"')>":
                             SECDOCDE,"</a>";
          REP       "+ ",PMVXEDC1
.
CBEDK780  REP       " +",ADMISSNO
          WRITE     HTMLFILE;"#",";
.
. Adm Date/Time Column
.
CBEDK800  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          CALL      SEXPCL00
          WRITE     HTMLFILE;"#"",DISPDATE,ATIME,"<br>":
                              EXPCTDSC,"<br>";
.
          CALL      CHKMUL000
          IF        EXIT=0
            WRITE     HTMLFILE;"Current IP - ",MULTHOSP,"<br>";
          ENDIF
.
          IF        FILETYPE=3
            WRITE     HTMLFILE;EXPLRETN;
          ENDIF
.
          WRITE     HTMLFILE;"#",";
.
          MATCH     SP70,COLRFLAG
          IF        @EQUAL
            WRITE     HTMLFILE;"#"#",";
          ELSE
             WRITE     HTMLFILE;"#"",COLRFLAG,"#",";
          ENDIF
.
          MOVE      SP70,SRTEDDAT      * Expected discharge date CCYYMMDD
          MATCH     SP70,EXPCTDSC
          IF        !@EQUAL | !@EOS
            UNPACK    EXPCTDSC,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR
            CALL      SETMTH00              * Set CMON from MTHNAM3
            PACK      SRTEDDAT,CCENT,CYEAR,CMON,CDAY
          ENDIF
.
          WRITE     HTMLFILE;"#"",SRTEDDAT,"#",";
          WRITE     HTMLFILE;"#"",BEDTEXT,"#",";
.
. Cabrini extra row fields TSK 0955098
.
          MATCH     PMWOUDF1,SP70
          IF        !@EQUAL
            PACK      KEY5,CATVA,PMWOUDF1,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;"#"",PTCDLDES,"#",";                   * 12
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 12
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 12
          ENDIF
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP2,ONE,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 13
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 13
          ENDIF
.
          MATCH     LPCONAM,SP70
          IF        !@EQUAL
            PACK      KEY5,ANSA,ANSM,LPCONAM,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;"#"",PTCDLDES,"#",";                   * 14
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 14
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 14
          ENDIF
.
          WRITE     HTMLFILE;"#"";
          MOVE      ONE,CNTR1
          PACK      KEY16,URNUMBER,SP70
          CALL      RSALREF2
CBEDK810  CALL      RKALREF2
          BRANCH    OVRCD,CBEDK815
.
          MATCH     URNUMBER,ALREURNO
          GOTO      CBEDK815 IF NOT EQUAL
.
          MATCH     ADMISSNO,ALRELINK
          GOTO      CBEDK810 IF NOT EQUAL
.
          MATCH     "3",ALRESTAT
          GOTO      CBEDK810 IF EQUAL
          MATCH     "4",ALRESTAT
          GOTO      CBEDK810 IF EQUAL
          MATCH     "5",ALRESTAT
          GOTO      CBEDK810 IF EQUAL
.
          MATCH     ALREDEPT,SP70
          GOTO      CBEDK810 IF EQUAL
          PACK      KEY5,CATCG,ALREDEPT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CBEDK810
.
          MOVE      SP70,KEY22
          IF        CNTR1=1
            PACK      KEY22,TDESC
          ELSE
            PACK      KEY22,COMMA,SP1,TDESC
          ENDIF
          STRIP     KEY22
          WRITE     HTMLFILE;*+,KEY22;
          ADD       ONE,CNTR1
          GOTO      CBEDK810 
.
CBEDK815  WRITE     HTMLFILE;"#",";                                     * 15
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP2,TWO,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 16
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 16
          ENDIF
.
          MATCH     AUSR2,SP70
          IF        !@EQUAL
            MOVE      "U2",CATEGORY
            PACK      KEY5,CATEGORY,AUSR2,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      AUSR2,TDESC
            ENDIF
          ELSE
            MOVE      SP70,TDESC  
          ENDIF
          WRITE     HTMLFILE;"#"",TDESC,"#",";                            * 17
.
          MATCH     PMWOUDF2,SP70
          IF        !@EQUAL
            PACK      KEY5,CATVB,PMWOUDF2,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;"#"",PTCDLDES,"#",";                   * 18
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 18
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 18
          ENDIF
.
          MATCH     PMWOUDF3,SP70
          IF        !@EQUAL
            PACK      KEY5,CATVC,PMWOUDF3,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;"#"",PTCDLDES,"#",";                   * 19
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 19
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 19
          ENDIF
.
          MATCH     PMWOUDF4,SP70
          IF        !@EQUAL
            PACK      KEY5,CATVD,PMWOUDF4,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;"#"",PTCDLDES,"#",";                   * 20
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 20
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 20
          ENDIF
.
          MATCH     PMWOUDF5,SP70
          IF        !@EQUAL
            PACK      KEY5,CATVE,PMWOUDF5,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;"#"",PTCDLDES,"#",";                   * 21
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 21
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 21
          ENDIF
.
          MATCH     PMWOUDF6,SP70
          IF        !@EQUAL
            PACK      KEY5,CATVF,PMWOUDF6,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;"#"",PTCDLDES,"#",";                   * 22
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 22
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 22
          ENDIF
.
          MATCH     PMWOUDF7,SP70
          IF        !@EQUAL
            PACK      KEY5,CATVG,PMWOUDF7,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;"#"",PTCDLDES,"#",";                   * 23
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 23
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 23
          ENDIF
.
          MATCH     PMWOUDF8,SP70
          IF        !@EQUAL
            PACK      KEY5,CATVH,PMWOUDF8,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;"#"",PTCDLDES,"#",";                   * 24
            ELSE
              WRITE     HTMLFILE;"#"",SP1,"#",";                        * 24
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 24
          ENDIF
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP2,THREE,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 25
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 25
          ENDIF
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP2,FOUR,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 26
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 26
          ENDIF
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP2,FIVE,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 27
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 27
          ENDIF
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP2,SIX,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 28
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 28
          ENDIF
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP2,SEVEN,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 29
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 29
          ENDIF
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP2,EIGHT,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 30
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 30
          ENDIF
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP2,NINE,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 31
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 31
          ENDIF
.
          PACK      KEY14,ADMISSNO,ZERO,ONE,EIGHT,SP1,ONE,ZERO,SP70
          CALL      RDVSCMT1
          IF        OVRCD=1
            WRITE     HTMLFILE;"#"",SP1,"#",";                          * 32
          ELSE
            WRITE     HTMLFILE;"#"",VSCTDATA,"#",";                     * 32
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER 
.
          WRITE     HTMLFILE;"#"";
.
          MOVE      "MJ",CATEGORY
          MOVE      PMNUDTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIETDESC
.
          MATCH     "1",PMNUFAST                                        * 33
          IF        @EQUAL
            WRITE    HTMLFILE;"<img src='../images/DietIcon.gif' ":
                               " class=ListIcon onclick=UpdateDiet('":
                      URNUMBER,"','",ADMISSNO,"')> ",DIETDESC,"<br>":
                      "Fasting","#",";
          ELSE
            WRITE     HTMLFILE;"<img src='../images/DietIcon.gif' ":
                               " class=ListIcon onclick=UpdateDiet('":
                               URNUMBER,"','",ADMISSNO,"')> ",DIETDESC,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",SP1,"#");"                            * XX
.
CBEDK900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDK999  RETURN
.
.---------------------------------------------------------------------------
. Setup mouseover.mouseout for patient link
.---------------------------------------------------------------------------
SHOWHD00  CLEAR     SHOWTEXT
          APPEND    " onmouseover=\#"showit('",SHOWTEXT
          APPEND    PTBRSNAM,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRGNAM,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRGEND,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    DISPBBDT,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PSAGEDIM,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PADD1,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PADD2,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PSUBRB,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PADD4,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PPOST,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTELEP,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTELEB,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTMXCELL,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PMPXPEML,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    DISPBSDT,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRSTIM,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRLURN,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRTITL,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTITL,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PSNAME,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PGNAME,SHOWTEXT
          APPEND    "')\#" onmouseout=\#"hideit()\#">",SHOWTEXT
          RESET     SHOWTEXT
.
SHOWHD08  STRIP     SHOWTEXT
          WRITE     HTMLFILE;SHOWTEXT;
.
SHOWHD09  RETURN
.
.---------------------------------------------------------------------------
. Setup mouseover.mouseout for patient link
.---------------------------------------------------------------------------
SHOWHD10  CLEAR     SHOWTEXT
          APPEND    " onmouseover=\#"showit('",SHOWTEXT
          APPEND    PTBRSNAM,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRGNAM,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRGEND,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    DISPBBDT,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PSAGEDIM,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRADR1,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRADR2,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRADR3,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRADR4,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRPOST,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRHPHN,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRWPHN,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRMPHN,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBREMAL,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    DISPBSDT,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRSTIM,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRLURN,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTBRTITL,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PTITL,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PSNAME,SHOWTEXT
          APPEND    "','",SHOWTEXT
          APPEND    PGNAME,SHOWTEXT
          APPEND    "')\#" onmouseout=\#"hideit()\#">",SHOWTEXT
          RESET     SHOWTEXT
.
SHOWHD18  STRIP     SHOWTEXT
          WRITE     HTMLFILE;SHOWTEXT;
.
SHOWHD19  RETURN
.
.---------------------------------------------------------------------------
. Get patatraf row for ur/admission/type
.---------------------------------------------------------------------------
GPTATR00  MOVE      ONE,NOTFOUND
          PACK      KEY35,URNUMBER,ADMISSNO,ATRTYPE,Z70
          CALL      RSPTATR3
GPTATR20  CALL      RPPTATR3
          BRANCH    OVRCD,GPTATR80
.
          MATCH     URNUMBER,PTARURNO
          GOTO      GPTATR80 IF NOT EQUAL
.
          MATCH     ADMISSNO,PTARVISN
          GOTO      GPTATR80 IF NOT EQUAL
.
          MATCH     ATRTYPE,PTARTYPE
          GOTO      GPTATR80 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      GPTATR20 IF EQUAL
.
          MOVE      ZERO,NOTFOUND
          GOTO      GPTATR99
.
GPTATR80  CALL      CLPATATR
.
GPTATR99  RETURN
.
.---------------------------------------------------------------------------
. Set tentative and confirmed color
.---------------------------------------------------------------------------
SEXPCL00  MOVE      SP70,COLRFLAG
.
          MATCH     "2",DASTAT
          GOTO      SEXPCL99 IF NOT EQUAL
.
          MOVE      "023",ATRTYPE
          CALL      GPTATR00
          IF        NOTFOUND=1
            CALL      CLPATATR
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          MATCH     SP70,PMWOEDAT
          GOTO      SEXPCL99 IF EQUAL
.
          IF        NOTFOUND=1
            GOTO      SEXPCL50      
          ENDIF
.
          MATCH     "1",PTARCOD1
          IF        @EQUAL
            MATCH     PMWOEDAT,CURRDATE
            IF        @EQUAL
              MOVE      "ExtraSess",COLRFLAG         * Confirm
              ADD       ONE,NUMBCNFD
            ENDIF
.
            MATCH     CURRDATE,PMWOEDAT
            IF        @LESS
              MOVE      "RedCell",COLRFLAG           * past discharge
            ENDIF
          ELSE
            MATCH     CURRDATE,PMWOEDAT
            IF        @LESS
              MOVE      "RedCell",COLRFLAG           * past discharge
            ENDIF
.
            MATCH     CURRDATE,PMWOEDAT
            IF        @EQUAL 
              MOVE      "CurrDischDate",COLRFLAG     * Tentative
            ENDIF
          ENDIF
.
          GOTO      SEXPCL99
.
SEXPCL50  MATCH     CURRDATE,PMWOEDAT 
          IF        @LESS
            MOVE      "RedCell",COLRFLAG             * past discharge
          ENDIF
.
          MATCH     CURRDATE,PMWOEDAT
          IF        @EQUAL 
            MOVE      "CurrDischDate",COLRFLAG       * Tentative
          ENDIF
.
SEXPCL99  RETURN
.
.------------------------------------------------------------------------------
. Get closed bed details
. Return: CLBEDDET
.------------------------------------------------------------------------------
CLSBED00  MOVE      SP256,CLBEDDET
.
          PACK      KEY6,WWARD,WBED,SP70         * read ward/bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CLSBED99
.
          MATCH     "1",PTWDBDST
          GOTO      CLSBED99 IF NOT EQUAL
.
          PACK      KEY22,AWARD,ABED,Z70
          CALL      RSPMBDC1
CLSBED20  CALL      RPPMBDC1
          BRANCH    OVRCD,CLSBED99
.
          MATCH     AWARD,PMBCWARD
          GOTO      CLSBED99 IF NOT EQUAL
.
          MATCH     ABED,PMBCBED
          GOTO      CLSBED99 IF NOT EQUAL
.
          MOVE      PMBCREAS,TDESC
          MATCH     SP70,PMBCREAS
          IF        !@EQUAL
            PACK      KEY5,CATBU,PMBCREAS,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      PMBCREAS,TDESC
            ENDIF
          ENDIF
.
          CLEAR     CLBEDDET
          APPEND    "<br>*** Closed ***  ",CLBEDDET
          APPEND    TDESC,CLBEDDET
.
          STRIP     PMBCFTRC
          MATCH     SP70,PMBCFTRC
          IF        !@EQUAL
            APPEND    "<br>",CLBEDDET
            APPEND    PMBCFTRC,CLBEDDET
          ENDIF
.
          STRIP     PMBCDOCT 
          MOVE      PMBCDOCT,DOCFNAME
          MATCH     SP70,PMBCDOCT 
          IF        !@EQUAL
            PACK      KEY10,PMBCDOCT,SP70
            CALL      RDPMHCP1
            IF        OVRCD = 0
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME 
            ENDIF
            APPEND    "<br>",CLBEDDET
            APPEND    DOCFNAME,CLBEDDET
          ENDIF
.
          MATCH     SP70,PMBCTODT
          IF        !@EQUAL
            UNPACK    PMBCTODT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            APPEND    "<br>Closed Until ",CLBEDDET
            APPEND    DISPDATE,CLBEDDET
            APPEND    SP1,CLBEDDET
            APPEND    PMBCTOTM,CLBEDDET
         ENDIF
.
         RESET     CLBEDDET
.
CLSBED99  RETURN

.------------------------------------------------------------------------------
. Get closed bed details
. Return: CLBEDDET
.------------------------------------------------------------------------------
CLSDBD00  MOVE      SP70,CLBEDDET
.
          PACK      KEY6,WWARD,WBED,SP70         * read ward/bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CLSDBD99
.
          PACK      KEY22,WWARD,WBED,Z70
          CALL      RSPMBDC1
CLSDBD20  CALL      RPPMBDC1
          BRANCH    OVRCD,CLSDBD99
.
          MATCH     WWARD,PMBCWARD
          GOTO      CLSDBD99 IF NOT EQUAL
.
          MATCH     WBED,PMBCBED
          GOTO      CLSDBD99 IF NOT EQUAL
.
          MOVE      PMBCREAS,TDESC
          MATCH     SP70,PMBCREAS
          IF        !@EQUAL
            PACK      KEY5,CATBU,PMBCREAS,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      PMBCREAS,TDESC
            ENDIF
          ENDIF
.
          CLEAR     CLBEDDET
          APPEND    "<br>",CLBEDDET
          APPEND    TDESC,CLBEDDET
.
          STRIP     PMBCFTRC
          MATCH     SP70,PMBCFTRC
          IF        !@EQUAL
            APPEND    "<br>",CLBEDDET
            APPEND    PMBCFTRC,CLBEDDET
          ENDIF
.
          STRIP     PMBCDOCT
          MOVE      PMBCDOCT,DOCFNAME
          MATCH     SP70,PMBCDOCT
          IF        !@EQUAL
            PACK      KEY10,PMBCDOCT,SP70
            CALL      RDPMHCP1
            IF        OVRCD = 0
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
            ENDIF
            APPEND    "<br>",CLBEDDET
            APPEND    DOCFNAME,CLBEDDET
          ENDIF
.
          MATCH     SP70,PMBCTODT
          IF        !@EQUAL
            UNPACK    PMBCTODT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
            PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
            APPEND    "<br>Closed Until ",CLBEDDET
            APPEND    DISPDATE,CLBEDDET
            APPEND    SP1,CLBEDDET
            APPEND    PMBCTOTM,CLBEDDET
         ENDIF
.
         RESET     CLBEDDET
.
CLSDBD99  RETURN
.
.-----------------------------------------------------------------------------
. Get discharge destination details
. Return: DSCHDDET
.-----------------------------------------------------------------------------
DSCHDS00  MOVE      SP70,DSCHDDET
          CLEAR     DSCHDDET 
.
          MOVE      "023",ATRTYPE
          MOVE      AURNO,URNUMBER
          MOVE      DAADMNO,ADMISSNO    
          CALL      GPTATR00
          IF        NOTFOUND=1
            CALL      CLPATATR
          ENDIF
.
          MATCH     SP70,PTARCOD2
          IF        !@EQUAL
            MOVE      "ZT",CATEGORY
            MOVE      PTARCOD2,CODE
            PACK      KEY5,CATEGORY,CODE,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              MOVE      PTARCOD2,TDESC
            ENDIF
            APPEND    "<br>",DSCHDDET
            APPEND    TDESC,DSCHDDET  
          ENDIF
.
DSCHDS50  MATCH     SP70,PMWODDES
          GOTO      DSCHDS80 IF EQUAL
.
          PACK      KEY5,PMWODDES,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            MOVE      PMWODDES,PTVADESC
          ENDIF
.
          MATCH     "2",PTARCOD3                  * Trans status - Accepted
          IF        @EQUAL
            APPEND    "<br><b style='color:Green'>",DSCHDDET
            APPEND    PTVADESC,DSCHDDET
            APPEND    "</b>",DSCHDDET
          ELSE
            APPEND    "<br>",DSCHDDET
            APPEND    PTVADESC,DSCHDDET
          ENDIF
.
DSCHDS80  RESET     DSCHDDET
          STRIP     DSCHDDET
.
DSCHDS99  RETURN
.
.------------------------------------------------------------------------------
. Get diagnosis mismatch icon / Outlier count
.------------------------------------------------------------------------------
OUTLR000  MOVE      ANSN,MISMTFLG
.
          MATCH     "2",DASTAT
          GOTO      OUTLR999 IF NOT EQUAL
.
          MATCH     SP70,ACLSSFT
          GOTO      OUTLR999 IF EQUAL
.
          MATCH     SP70,WCLASS
          GOTO      OUTLR999 IF EQUAL
.
OUTLR100  PACK      KEY5,CATCG,WCLASS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLR999
.
          MATCH     SP70,TCINDC1
          GOTO      OUTLR999 IF EQUAL
.
          MOVE      TCINDC1,WOUTIND1
.
          PACK      KEY5,CATAC,ACLSSFT,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLR999
.
.          MATCH     SP70,TCINDC1
.          GOTO      OUTLR999 IF EQUAL
.
          MOVE      TCINDC1,PSPCIND1
.
          MATCH     PSPCIND1,WOUTIND1
          IF        @EQUAL
            GOTO      OUTLR999
          ENDIF
.
. Check multiple ward
.
OUTLR200  PACK      KEY12,PMVXMHOS,WWARD,WBED,SP70
          CALL      RSPMMSW1
OUTLR220  CALL      RKPMMSW1
          BRANCH    OVRCD,OUTLR500
.
          MATCH     PMVXMHOS,PMMWHOSP
          GOTO      OUTLR500 IF NOT EQUAL
.
          MATCH     WWARD,PMMWWARD
          GOTO      OUTLR500 IF NOT EQUAL
.
          MATCH     WBED,PMMWBEDC
          GOTO      OUTLR500 IF NOT EQUAL
.
          MATCH     SP70,PMMWWCLS
          GOTO      OUTLR220 IF EQUAL
.
          PACK      KEY5,CATCG,PMMWWCLS,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OUTLR220
.
.          MATCH     SP70,TCINDC1
.          GOTO      OUTLR220 IF EQUAL
.
          MATCH     PSPCIND1,TCINDC1
          GOTO      OUTLR999 IF EQUAL
.
          GOTO      OUTLR220
.
OUTLR500  MOVE      ANSY,MISMTFLG
.
OUTLR999  RETURN
.
.------------------------------------------------------------------------------
.         Get Risk icons (Patient Attributes)
.------------------------------------------------------------------------------
GETRIC00  MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          REP       "+ ",PTATR001
          REP       "+ ",PTATR002
.
          MOVE      "5",ATTYPIND       * Attribute Type 5 ('Falls Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          MOVE      ZERO,F1
          MOVE      ATCODVAL,F1
          IF        F1=1
            WRITE     HTMLFILE;"<a title='Falls Risk'>":
                               "<img class=ListIcon src='../images/risk_f.png'":
                               " title='Falls Risk'></a>"
          ENDIF
.
          MOVE      "6",ATTYPIND       * Attr Type 6 ('Pressure Injury Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          MOVE      ZERO,F1
          MOVE      ATCODVAL,F1
          IF        F1=1
            WRITE     HTMLFILE;"<a title='Pressure Injury Risk'>":
                               "<img class=ListIcon src='../images/risk_p.png'":
                               " title='Pressure Injury Risk'></a>"
          ENDIF
.
          MOVE      "7",ATTYPIND       * Attr Type 7 ('Abscond Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          MOVE      ZERO,F1
          MOVE      ATCODVAL,F1
          IF        F1=1
            WRITE     HTMLFILE;"<a title='Abscond Risk'>":
                               "<img class=ListIcon src='../images/risk_a.png'":
                               " title='Abscond Risk'></a>"
          ENDIF
.
          MOVE      "8",ATTYPIND       * Attr Type 8 ('Malnutrition Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          MOVE      ZERO,F1
          MOVE      ATCODVAL,F1
          IF        F1=1
            WRITE     HTMLFILE;"<a title='Malnutrition Risk'>":
                               "<img class=ListIcon src='../images/risk_m.png'":
                               " title='Malnutrition Risk'></a>"
          ENDIF
.
GETRIC99  RETURN
+
.------------------------------------------------------------------------------
.         Check if MH Legal status icon to be displayed
.------------------------------------------------------------------------------
CMHL0000  MATCH     SP70,SAVCLASS
          GOTO      CMHL9999 IF EQUAL         * blank ward classification
.
          PACK      KEY5,ANSC,ANSG,SAVCLASS
          CALL      RDCODE1
          BRANCH    OVRCD,CMHL9999
.
          MATCH     "M",TCINDC2
          GOTO      CMHL9999 IF NOT EQUAL
.
          REP       "+ ",URNUMBER
          PROC      CHKLEGST
          REP       " +",URNUMBER
          IF        EXIT=1
            WRITE     HTMLFILE;"<img src=../images/target1.gif":
                                   " title='Legal Status'":
                                   " class=ListIcon onclick='MHLegStat(#"":
                                   URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
CMHL9999  RETURN
+
.------------------------------------------------------------------------------
.         Check if MH Legal status icon to be displayed for ward map
.------------------------------------------------------------------------------
CMHLM000  MATCH     SP70,SAVCLASS
          GOTO      CMHLM999 IF EQUAL         * blank ward classification
.
          PACK      KEY5,ANSC,ANSG,SAVCLASS
          CALL      RDCODE1
          BRANCH    OVRCD,CMHLM999
.
          MATCH     "M",TCINDC2
          GOTO      CMHLM999 IF NOT EQUAL
.
          REP       "+ ",URNUMBER
          PROC      CHKLEGST
          REP       " +",URNUMBER
          IF        EXIT=1
              WRITE     HTMLFILE;"<img src='../images/target1.gif'":
                                 "' class=ListIcon onclick=MHLegStat('":
                                 URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
CMHLM999  RETURN
+
.------------------------------------------------------------------------------
.         Get the Nursing Station extension number (for a Nursing Station code)
.
.         Parameters:
.           NURSTCOD - Nursing Station code
.
.         Returns:
.           NURSTNUM - Nursing Station extension number
.------------------------------------------------------------------------------
WNURN000  MOVE      SP70,NURSTNUM

          MATCH     SP70,NURSTCOD         * Nursing Station code specified?
          GOTO      WNURN999 IF EQUAL
.
          PACK      KEY6,NURSTCOD,SP70    * we don't use the ward number
                                          * therefore just pack with space
          CALL      RDNURS1
          IF        OVRCD=0
            MATCH     NSTAT,NURSTCOD
            IF        @EQUAL
              MATCH     SP70,NSEXTN
              IF        !@EQUAL
                MOVE      NSEXTN,NURSTNUM
              ENDIF
            ENDIF
          ENDIF
.
WNURN999  RETURN
+
.---------------------------------------------------------------------
.      Check if this admission is currently admitted at another hospital
.---------------------------------------------------------------------
CHKMUL00  MOVE      ZERO,EXIT
          PACK      MULTHOSP,SP70
          PACK      DIM8,AURNO,SP70
          PACK      DIM3,PMVXMHOS,SP70
          PACK      SAVKEY9,ASTAT,DAADMNO,SP70
          MOVE      "2",DIM1
          PACK      KEY17,AURNO,TWO,SP70
          CALL      RSPTMI18
CHKMUL10  CALL      RKPTMI18
          BRANCH    OVRCD,CHKMUL90
.
          MATCH     AURNO,DIM8
          GOTO      CHKMUL90 IF NOT EQUAL
.
          MATCH     DIM1,DASTAT
          GOTO      CHKMUL90 IF NOT EQUAL
.
          MATCH     PMVXMHOS,DIM3
          GOTO      CHKMUL10 IF EQUAL
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,CHKMUL90
          CALL      RDPMPX21
.
          PACK      KEY3,PMVXMHOS
          CALL      RDPTHSP1
          IF        OVRCD<>1
            PACK      MULTHOSP,PTHSNAME,SP70
          ENDIF
          GOTO      CHKMUL99
.
CHKMUL90  MOVE      ONE,EXIT
          MATCH     "2",DIM1
          IF        @EQUAL
            MOVE      "4",DIM1
            PACK      KEY17,AURNO,FOUR,SP70
            CALL      RSPTMI18
            GOTO      CHKMUL10
          ENDIF

.
CHKMUL99  PACK      KEY9,SAVKEY9,SP70
          CALL      RDMISS2
          RETURN
+
.------------------------------------------------------------
. Heading Row
.------------------------------------------------------------
CRHDG000  BRANCH    FHIRTYPE,CRHDG999
          MOVE      NINE,CSPANUM            * Default View
.         
          IF        NOBEDWRD=1
            SUBTRACT  ONE,CSPANUM           * Remove 'bed' col for WardOnly Ward
          ENDIF
          MOVE      CSPANUM,CSPAN
          SQUEEZE   CSPAN
.
          IF        HEAONLY = ONE
            GOTO      CRHDG999
          ENDIF 
.        
          WRITE     HTMLFILE;"<tr><td colspan=",CSPAN," align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</b></td></tr>"
CRHDG999  RETURN
.
.------------------------------------------------------------
. Current Admissions Bed Row message.
.------------------------------------------------------------
CBDMSG00  IF        HEAONLY = ONE
            CALL      CBDMSK00
            GOTO      CBDMSG99
          ENDIF
.   
          BRANCH    BEDMSGID,CBDMSG01,CBDMSG02
.
          MOVE      "LeaveCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSG10
.
CBDMSG01  MOVE      "AvailableCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSG10
.
CBDMSG02  BRANCH    WBEDTYPE,CBDMSG99
          MOVE      "ClosedCell bgcolor=gray",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
          GOTO      CBDMSG10
.
CBDMSG03  MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                             "<td align=center class=",BDMSGCLS,"":
                             " title=#"",PTWDCOMM,"#">";
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT;
          WRITE     HTMLFILE;"</td><td align=center>",CLBEDDE1,"</td>";
          GOTO      CBDMSG20
.
CBDMSG10  MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                             "<td align=center class=",BDMSGCLS,"":
                             " title=#"",PTWDCOMM,"#">";
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT;
          WRITE     HTMLFILE;"</td><td align=center>",BDMSGTXT,"</td>";
.
.                                           **** Default View ****
CBDMSG20  MATCH     "1",ANAESTFL                                      *I-212073
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF

          IF        KIDSONLY=ONE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF

          IF        KIDSVEW2 = 1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        ALTVIEW1 = 1
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          IF        DISPTHET = 1 
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        FASTVIEW = 1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.                                                                   * Car 235588
          IF        PTCNHDPS=ONE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        SJOGVIEW = 1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          COMPARE   "1",BULKDSCH
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
          MATCH     "1",PRNTLABL
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          IF        CABONLY = ONE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
CBDMSG99  RETURN
.------------------------------------------------------------
. Current Admissions Bed Row message.
.------------------------------------------------------------
CBDMSK00  ADD       ONE,CRSRTCNT
          MOVE      SP70,DIM3
          MOVE      CRSRTCNT,DIM3
          REP       " +",DIM3
          MOVE      SP256,CLBEDDET
          STRIP     CLBEDDET
          REP       UPPLOW,BEDTEXT
.
          BRANCH    BEDMSGID,CBDMSK01,CBDMSK02
.
CBDMSKA1  MOVE      "YellowCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSK10
.
CBDMSK01  MOVE      "BlueCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSK10
.
CBDMSK02  BRANCH    WBEDTYPE,CBDMSK99
          MOVE      "DarkGreyCell",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
          CALL      CLSDBD00
          STRIP     CLBEDDET
.
          MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",BDMSGCLS,"";
          CALL      FBED0000
          REP       UPPLOW,BEDTEXT
          WRITE     HTMLFILE;*+,BEDTEXT;
          WRITE     HTMLFILE;"#",";
.
...       WRITE     HTMLFILE;"<tr height=35 align=top>":
...                          "<td align=center class=",BDMSGCLS,"":
...                          " title=#"",PTWDCOMM,"#">";
...       CALL      FBED0000
...       WRITE     HTMLFILE;*+,BEDTEXT;
...       WRITE     HTMLFILE;"</td><td align=center>",CLBEDDE1,"</td>";
          GOTO      CBDMSK20
.
CBDMSK10  MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          WRITE     HTMLFILE;"t.addRow(#"",BDMSGCLS,"";
          CALL      FBED0000
          REP       UPPLOW,BEDTEXT
          WRITE     HTMLFILE;*+,BEDTEXT;
          WRITE     HTMLFILE;"#",";
.
.                                           **** Default View ****
CBDMSK20  WRITE     HTMLFILE;"#"","<input type=hidden name='",DIM3,"'>":
                             BEDTEXT,"#",":
                             "#"",BDMSGTXT,CLBEDDET,"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"",BEDTEXT,"#"";
.
          WRITE     HTMLFILE;");"
.
CBDMSK99  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details (Nutrition)
.------------------------------------------------------------
CTABN000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          UNPACK    DIM127,D1,STVVIEW,DIM127     * STV flag           Car 262343
          UNPACK    DIM127,D1,LEAVFLAG,DIM127    * On Leave Flag
.
          RESET     STVVIEW
          MATCH     STVVIEW,SP70
          IF        @EQUAL
            MOVE      ZERO,STVVIEW
          ENDIF
          MOVE      LEAVFLAG,ONLVFLAG            * Display type of onleave
.
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
.
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WINPUT,NOBEDWRD              * Save Ward Header WO/BO status
.
          MATCH     "2",PWDVTYPE
          IF        @EQUAL
            CALL      CHEADQ00                   * Output heading CAB view 2
          ELSE
            MATCH     "1",PTCNUTOM
            IF        @EQUAL
              CALL      CHEADH00                 * Output headings (hea diet)
            ELSE
              CALL      CHEADN00                 * Output headings
            ENDIF
          ENDIF
.
          MOVE      ONE,DIETFILT                 * Assume no filtering (1=no)
          PACK      KEY30,DIETTYPE,DIETNCDE,SP70 * Inspect filter fields
          MATCH     SP30,KEY30                   * Anything in filter fields ?
          GOTO      CTABN050 IF EQUAL            * N - bypass
          MOVE      ZERO,DIETFILT                * Y - set filtering on (0=yes)
.
. No Bed 
.
CTABN050  PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABN100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABN190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABN190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
.
          MATCH     "2",PWDVTYPE
          IF        @EQUAL
            CALL      CBEDQ000                * Output Row CAB View 2
          ELSE
            MATCH     "1",PTCNUTOM
            IF        @EQUAL
              CALL      CBEDP000              * Output Row Details (hea diet)
            ELSE
              CALL      CBEDN000              * Output Row Details
            ENDIF
          ENDIF
          GOTO      CTABN100
.
. Ward/Bed Details
.
CTABN190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABN200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABN290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABN290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABN200 IF EQUAL
.
          BRANCH    WACTIVE,CTABN200       * Display Closed Bed Row PR 172
          CALL      CROWN000
          GOTO      CTABN200
.
CTABN250  MOVE      "2",BEDMSGID
          CALL      CBDMSN00
          GOTO      CTABN200
.
. On Leave Patients
.------------------
CTABN290  BRANCH    WBEDTYPE,CTABN300,CTABN999
. 
CTABN300  MOVE      ONE,FIRSTONL
          MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABN800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABN999
          MATCH     OWARD,WARDCODE
          GOTO      CTABN999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABN800 IF EQUAL
          IF        FIRSTONL=1
            MOVE      ZERO,FIRSTONL
            MOVE      "Patients On Leave",ROWHEAD
            CALL      CRHDN000       * Output Heading Row for On-Leave
          ENDIF
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED 
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABN850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABN850  MATCH     "2",PWDVTYPE
          IF        @EQUAL
            CALL      CBEDQ000                * Output Row CAB View 2
          ELSE
            MATCH     "1",PTCNUTOM
            IF        @EQUAL
              CALL      CBEDP000              * Output Row Details (hea diet)
            ELSE
              CALL      CBEDN000              * Output Row Details
            ENDIF
          ENDIF
.
          GOTO      CTABN800
.
CTABN999  RETURN
.
.------------------------------------------------------------
. Current Admissions - Nutrition View - output heading row.
.------------------------------------------------------------
CHEADN00  IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center>Bed</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
.
          BRANCH    KIDSONLY,CHEADN50
.
.
.                                                * St. Vincents (standard)
          IF        SJOGVIEW=1
            WRITE     HTMLFILE;"<td class=HeadingCell>Admission Diet</td>":
                               "<td class=HeadingCell>Food Allergy</td>":
                               "<td class=HeadingCell>Ward Diet</td>";
          ELSE
            MATCH     "0",STVVIEW
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=HeadingCell>Alerts</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td class=HeadingCell>Diet</td>";
.                                              * Stv Specific Heading Car 262343
            MATCH     "1",STVVIEW
            IF        @EQUAL
              WRITE     HTMLFILE;"<td class=HeadingCell>Feeding Assistance</td>";
            ELSE
              WRITE     HTMLFILE;"<td class=HeadingCell>Fasting</td>";
            ENDIF
.
            WRITE     HTMLFILE;"<td class=HeadingCell>BMI</td>";
            IF        HEAVIEW=1
              WRITE     HTMLFILE;"<td class=HeadingCell>Supplements</td>";
            ELSE
              WRITE     HTMLFILE;"<td class=HeadingCell>Diet Type</td>";
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=200>Comment</td>":
                             "<td class=HeadingCell>Menu/<br>":
                                                   "Assistance<br></td>";
          MATCH     "1",PWDVTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>Post Op Ward";
          ELSE
            WRITE     HTMLFILE;"<td class=HeadingCell>Dietitian Name<br>":
                                                     "& Pager no.";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Last Update<br>":
                                                   "Date Time</td>":
                             "<td class=HeadingCell>Adm.Date Time<br>":
                                                   "Exp.Discharge</td>";
          WRITE     HTMLFILE;"</tr>";
          GOTO      CHEADN99
.
.                                                * RCH (kids) 
CHEADN50  WRITE     HTMLFILE;"<td class=HeadingCell align=center>U/R</td>":
                             "<td class=HeadingCell>Patient Condition</td>":
                             "<td class=HeadingCell>Diet</td>":
                             "<td class=HeadingCell>Fasting</td>":
                             "<td class=HeadingCell>Diet Type</td>":
                             "<td class=HeadingCell>Other Diet<br>Details</td>":
                             "<td class=HeadingCell>Comment</td>":
                             "<td class=HeadingCell>Unit</td>":
                             "<td class=HeadingCell>Unit<br> Doctor</td>":
                             "<td class=HeadingCell>Adm.Date Time<br>":
                                                   "Exp.Discharge</td>":
                             "</tr>";
CHEADN99  RETURN
+
.------------------------------------------------------------
. Current Admissions - Nutrition View - output heading row. (hea - ptcnutom=1)
.------------------------------------------------------------
CHEADH00  IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                                   "align=center>Bed</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Alerts</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>BMI</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Fasting</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Breakfast Diet</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Lunch Diet</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Dinner Diet</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Supplements</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=200>Comment</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Menu/<br>":
                                                   "Assistance<br></td>";
          MATCH     "1",PWDVTYPE
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class=HeadingCell>Post Op Ward</td>";
          ELSE
            WRITE     HTMLFILE;"<td class=HeadingCell>Dietitian Name<br>":
                                                     "& Pager no.</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Adm.Date Time<br>":
                                                   "Exp.Discharge<br>":
                                                   "Last Update Time</td>";
          WRITE     HTMLFILE;"</tr>";
.
CHEADH99  RETURN
+
.------------------------------------------------------------
. Output Ward/Bed Row (Nutrition)
.------------------------------------------------------------
CROWN000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWN800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (INGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,CROWN100,CROWN999
.
CROWN100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG                                 *I-273956
.
          MATCH     "2",PWDVTYPE
          IF        @EQUAL
            CALL      CBEDQ000                * Output Row CAB View 2
          ELSE
            MATCH     "1",PTCNUTOM
            IF        @EQUAL
              CALL      CBEDP000              * Output Row Details (hea diet)
            ELSE
              CALL      CBEDN000              * Output Row Details
            ENDIF
          ENDIF
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWN999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
.
          MATCH     "2",PWDVTYPE
          IF        @EQUAL
            CALL      CBEDQ000                * Output Row CAB View 2
          ELSE
            MATCH     "1",PTCNUTOM
            IF        @EQUAL
              CALL      CBEDP000              * Output Row Details (hea diet)
            ELSE
              CALL      CBEDN000              * Output Row Details
            ENDIF
          ENDIF
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWN999
.
CROWN800  MATCH     "1",PTWDBDST     * Is this bed closed?
          IF        @EQUAL
            MOVE      TWO,BEDMSGID   * Yes, bed is closed
            GOTO      CROWN850
          ELSE
            MOVE      ONE,BEDMSGID   * Assume Empty Bed
          ENDIF
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWN810  CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWN850
          MATCH     OWARD,WWARD
          GOTO      CROWN850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWN850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID     * Bed has patient on leave
.
CROWN850  CALL      CBDMSN00
.
CROWN999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details (Nutrition)
.------------------------------------------------------------
CBEDN000  CALL      GETPAT00 
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER 
.                                           * Perform filtering if applicable
          BRANCH    DIETFILT,CBEDN400       * 1=no filtering
          MATCH     SP30,DIETTYPE           *   Diet Type filtering requested ?
          GOTO      CBEDN300 IF EQUAL       *   N - bypass (try Nutritionist)
          IF        EXTRDIET=1
            MATCH     DIETTYPE,ADIET          *   Y - correct diet type
          ELSE
            MATCH     DIETTYPE,PMNUDTYP       *   Y - correct diet type
          ENDIF
          GOTO      CBEDN900 IF NOT EQUAL   *       N - ignore this record
.
CBEDN300  MATCH     SP30,DIETNCDE           *   Nutritionist filtering reqstd ?
          GOTO      CBEDN400 IF EQUAL       *   N - bypass (process the row)  
          MATCH     DIETNCDE,PMNUDCDE       *   Y - correct doctor name ?
          GOTO      CBEDN900 IF NOT EQUAL   *       N - ignore this record
.
CBEDN400  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDN500                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDN410,CBEDN420,CBEDN430
.
CBEDN410  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             "<img src=#"../images/EditIcon.gif#"":
                             " class=ListIcon onclick='BedAllocation(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             "</td>"
          GOTO      CBEDN500
.
CBEDN420  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                                 "title=#"",PTWDCOMM,"#" ":
                                 "bgcolor=gray>";
            ELSE
              WRITE     HTMLFILE;"<td align=center ":
                                 "title=#"",PTWDCOMM,"#">";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell>";
          ENDIF
.
          CALL      FBED0000       
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
          GOTO      CBEDN500
.
CBEDN430  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                               "title=#"",PTWDCOMM,"#" ":
                               "bgcolor=gray>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=LeaveCell>";
          ENDIF
.
          CALL      FBED0000       
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
.
CBEDN500  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDN520 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDN520 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDN520 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,PVIBILL
          PROC      TLEA0000
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31,"</td>";
          GOTO      CBEDN540
.
CBEDN520  WRITE     HTMLFILE;FORMATNM,"</td>";
.
CBEDN540  IF        KIDSONLY=ONE
            REP       "+ ",URNUMBER
            WRITE     HTMLFILE;"<td nowrap align=center>":
                                    URNUMBER,NBSP,"</td>";
            REP       " +",URNUMBER
          ENDIF
.
CBEDN575  IF        HEAVIEW=1
            CALL      H6ALR000             * Get H6 alert Code description
          ENDIF
.
          CALL      GETCON00               * Get Patient Condition Details
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          BRANCH    KIDSONLY,CBEDN650
.
          CALL      CBDNSV00                   * St Vincent's specifics (stnd)
          GOTO      CBEDN700
.
CBEDN650  CALL      CBDNRC00                   * Royal Children's (kids)
.
CBEDN700  MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
          REP       " +",ADMISSNO
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.                                                * no doctor col for St.V's
          IF        KIDSONLY=ONE 
            WRITE     HTMLFILE;"<td nowrap>",TDESC,NBSP,"</td>":
                               "<td><a href='":
                               "javascript:DoctorViewFrame(#"",DOCTCODE,"#")'>":
                                SDOCFNAM,NBSP,"</a></td>";
          ENDIF
.
CBEDN850  WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                                 DISPDATE,ATIME,"<br>":
                                 EXPCTDSC,"</td>";
          WRITE     HTMLFILE;"</tr>"
CBEDN900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDN999  RETURN
+
.------------------------------------------------------------
. Current Admissions Patient Details (Nutrition) hea diet (ptcnutom=1)
.------------------------------------------------------------
CBEDP000  CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.                                           * Perform filtering if applicable
          BRANCH    DIETFILT,CBEDP400       * 1=no filtering
          MATCH     SP30,DIETTYPE           *   Diet Type filtering requested ?
          GOTO      CBEDP300 IF EQUAL       *   N - bypass (try Nutritionist)
          IF        EXTRDIET=1
            MATCH     DIETTYPE,ADIET          *   Y - correct diet type
          ELSE
            MATCH     DIETTYPE,PMNUDTYP       *   Y - correct diet type
          ENDIF
          GOTO      CBEDP900 IF NOT EQUAL   *       N - ignore this record
.
CBEDP300  MATCH     SP30,DIETNCDE           *   Nutritionist filtering reqstd ?
          GOTO      CBEDP400 IF EQUAL       *   N - bypass (process the row)
          MATCH     DIETNCDE,PMNUDCDE       *   Y - correct doctor name ?
          GOTO      CBEDP900 IF NOT EQUAL   *       N - ignore this record
.
CBEDP400  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDP500                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDP410,CBEDP420,CBEDP430
.
CBEDP410  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             "<img src=#"../images/EditIcon.gif#"":
                             " class=ListIcon onclick='BedAllocation(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             "</td>"
          GOTO      CBEDP500
.
CBEDP420  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                                 "title=#"",PTWDCOMM,"#" ":
                                 "bgcolor=gray>";
            ELSE
              WRITE     HTMLFILE;"<td align=center ":
                                 "title=#"",PTWDCOMM,"#">";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell>";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
          GOTO      CBEDP500
.
CBEDP430  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                               "title=#"",PTWDCOMM,"#" ":
                               "bgcolor=gray>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=LeaveCell>";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
.
CBEDP500  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDP520 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDP520 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDP520 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,PVIBILL
          PROC      TLEA0000
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31,"</td>";
          GOTO      CBEDP540
.
CBEDP520  WRITE     HTMLFILE;FORMATNM,"</td>";
.
CBEDP540
.
CBEDP575  IF        HEAVIEW=1
            CALL      H6ALR000             * Get H6 alert Code description
          ENDIF
.
          CALL      GETCON00               * Get Patient Condition Details
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          CALL      CBDHEA00                   * HEA Extra Diet (ptcnutom=1)
.
CBEDP700  MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
          REP       " +",ADMISSNO
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
CBEDP850  WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                                 DISPDATE,ATIME,"<br>":
                                 EXPCTDSC,"<br>":
                                 DISPLUPD,DISPLUTM,"</td>";
          WRITE     HTMLFILE;"</tr>"
CBEDP900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDP999  RETURN
+
.---------------------------------------------------------------------
.         Output Patient Alert icons
.---------------------------------------------------------------------
ALERTI00  MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
          IF        EXIT=0 | EXIT=2
            MATCH     "1",PMPXSIN7
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                                 " title='Medical Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSIN8
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                                 " title='Micro Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSIN9
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                                 " title='Risk Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSN11
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                                 " title='Chronic Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      ALERTI90
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      ALERTI90
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
              GOTO      ALERTI90
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick='PatientAlerts(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>"
            ENDIF
          ENDIF
.
ALERTI90  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " title='Disability Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
          IF        DISPDNAM=1
            REP       "+ ",ADMISSNO
            REP       "+ ",URNUMBER
            CALL      CHKD0000           * Duplicate Surnames?
            IF        DUPNMFLG=1
              WRITE     HTMLFILE;"<img src='../images/samename.gif'":
                                 " title='Patient Name Conflict'":
                                 " class=ListIcon>";
            ENDIF
            REP       " +",ADMISSNO
            REP       " +",URNUMBER
          ENDIF
.
ALERTI99  RETURN
+
.------------------------------------------------------------------------------
.         Checks to see if there are other patients with the same Surname
.         in the same hospital/ward as us; using Current Patient Location
.         table (pmscuraf).
.------------------------------------------------------------------------------
CHKD0000  BRANCH    IBCNMHOS,CHKD3000
.
          PACK      KEY96,PTMASNAM,SP70,SP70
          CALL      RSPMCUR2
CHKD1000  CALL      RKPMCUR2
          BRANCH    OVRCD,CHKD9000
.
          MATCH     PTMASNAM,PMCUSURN       * same surname ?
          GOTO      CHKD9000 IF NOT EQUAL   * no; we're finished here
.
          MATCH     "0       ",PMCUURNO
          GOTO      CHKD1200 IF EQUAL
.
          MATCH     URNUMBER,PMCUURNO       * same UR as ours ?
          GOTO      CHKD1000 IF EQUAL       * yes; skip
.
CHKD1200  MATCH     ADMISSNO,PMCUVISN       * same admission no. as ours ?
          GOTO      CHKD1000 IF EQUAL       * yes; skip
.
          PACK      KEY30,PMCUVISN,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CHKD1000
.
          MATCH     PMCUVISN,DTADMN
          GOTO      CHKD1000 IF NOT EQUAL
.
.  Task  0840055 - only show conflict if currently admitted
.
          MATCH     ANSD,TMOVE
          GOTO      CHKD1000 IF EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      CHKD1000 IF EQUAL
.
          MATCH     WARDCODE,TWARD          * same ward ?
          GOTO      CHKD1000 IF NOT EQUAL
.
          MATCH     PTMASNAM,PMCUSURN       * same surname ?
          GOTO      CHKD9100 IF EQUAL
.
          GOTO      CHKD9000
.
.
.         Multi Hospital...
.
CHKD3000  PACK      KEY99,PTWDHOSN,PTMASNAM,SP70,SP70
          CALL      RSPMCUR6
CHKD3100  CALL      RKPMCUR6
          BRANCH    OVRCD,CHKD9000
.
          MATCH     PTWDHOSN,PMCUHOSP       * same hospital ?
          GOTO      CHKD9000 IF NOT EQUAL   * no; we're finished here
.
          MATCH     PTMASNAM,PMCUSURN       * same surname ?
          GOTO      CHKD9000 IF NOT EQUAL   * no; we're finished here
.
          MATCH     "0       ",PMCUURNO
          GOTO      CHKD3200 IF EQUAL
.
          MATCH     URNUMBER,PMCUURNO       * same UR as ours ?
          GOTO      CHKD3100 IF EQUAL       * yes; skip
.
CHKD3200  MATCH     ADMISSNO,PMCUVISN       * same admission no. as ours ?
          GOTO      CHKD3100 IF EQUAL       * yes; skip
.
          PACK      KEY30,PMCUVISN,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,CHKD3100
.
          MATCH     PMCUVISN,DTADMN
          GOTO      CHKD3100 IF NOT EQUAL
.
.  Task  0840055 - only show conflict if currently admitted
.
          MATCH     ANSD,TMOVE
          GOTO      CHKD3100 IF EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      CHKD3100 IF EQUAL
.
          MATCH     WARDCODE,TWARD          * same ward ?
          GOTO      CHKD3100 IF NOT EQUAL
.
          MATCH     PTMASNAM,PMCUSURN       * same surname ?
          GOTO      CHKD9100 IF EQUAL
.
          GOTO      CHKD9000
.
CHKD9000  MOVE      ZERO,DUPNMFLG
          GOTO      CHKD9999
.
CHKD9100  MOVE      ONE,DUPNMFLG
          GOTO      CHKD9999
.
CHKD9999  RETURN
+
.------------------------------------------------------------------------------
. Check if MH Legal status icon to be displayed
.------------------------------------------------------------------------------
CHKLST00  MOVE      "0",LSFLAG
          MATCH     SP70,SAVCLASS
          GOTO      CHKLST99 IF EQUAL   
.
CHKLST20  PACK      KEY5,ANSC,ANSG,SAVCLASS
          CALL      RDCODE1
          BRANCH    OVRCD,CHKLST99
.
          MATCH     "M",TCINDC2
          GOTO      CHKLST99 IF NOT EQUAL
.
          REP       "+ ",URNUMBER
          PROC      CHKLEGST
          REP       " +",URNUMBER
CHKLST80  IF        EXIT=1
            MOVE      "1",LSFLAG
          ENDIF
.
CHKLST99  RETURN
.
.---------------------------------------------------------------------
.         Output Row details (Nutrition) specific St. Vincents (stnd)      
.---------------------------------------------------------------------
CBDNSV00  MATCH     "0",STVVIEW
          IF        @EQUAL
            IF        SJOGVIEW<>1
              WRITE     HTMLFILE;"<td>&nbsp;";
              CALL      ALERTI00
              IF        HEAVIEW=1
                CALL      DALR0000             * Display alerts
              ENDIF
              WRITE     HTMLFILE;"</td>";
            ENDIF
          ENDIF
          WRITE     HTMLFILE;"<td><table><tr><td>":
                             "<img src=../images/DietIcon.gif ":
                             " class=ListIcon onclick='UpdateNutrition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#")'></td>";
.
          IF        HEAVIEW=1
            MOVE      "DC",CATEGORY
            MATCH     SP70,PMNUDIET
            IF        !@EQUAL
              MOVE      PMNUDIET,CODE
            ELSE
              MOVE      ADIET,CODE
            ENDIF
            CALL      GETCOD00
            WRITE     HTMLFILE;"<td>",TDESC;
            CALL      DDIET000            * Healthscope Diet column
          ELSE
            MOVE      "DC",CATEGORY
            MOVE      ADIET,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;"<td>",TDESC;
          ENDIF
.
          COMPARE   ONE,DISPUDF4          * don't display pmvxudf4 (CAR 305129)
          GOTO      CBDNSV05 IF EQUAL
.
          MATCH     "2",STVVIEW
          IF        @EQUAL
            WRITE     HTMLFILE;"&nbsp;";
          ELSE
            WRITE     HTMLFILE;"<br>",PMVXUDF4;
          ENDIF
.
CBDNSV05  WRITE     HTMLFILE;"</td></tr></table></td>";
.
          IF        SJOGVIEW<>1
            GOTO      CBDNSV20
          ENDIF
.
          MATCH     "1",PTCNDFAL            * Display Food Allergy
          IF        !@EQUAL
            MATCH     SP70,PTMIUSR9
            IF        @EQUAL
              WRITE     HTMLFILE;"<td>&nbsp;";
            ELSE
              PACK      KEY5,ANSU,NINE,PTMIUSR9,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;"<td>",TDESC;
              ELSE
                WRITE     HTMLFILE;"<td>&nbsp;";
              ENDIF
            ENDIF
            GOTO    CBDNSV16
          ENDIF
.
          WRITE     HTMLFILE;"<td>";
          REPLACE   "+ ",URNUMBER
          PACK      KEY16,URNUMBER,CATH3,SP70
          CALL      RSPTALR1
CBDNSV10  CALL      RKPTALR1                * Check if any H3 Alerts Exist?
          IF        OVRCD=1
            WRITE     HTMLFILE;"&nbsp;&nbsp;&nbsp; ";
            GOTO      CBDNSV15
          ENDIF
.
          MATCH     URNUMBER,PTALURNO
          GOTO      CBDNSV15 IF NOT EQUAL
.
          MATCH     CATH3,PTALCATG
          GOTO      CBDNSV15 IF NOT EQUAL
.
          WRITE     HTMLFILE;"Yes"; 
.
CBDNSV15  MATCH     SP70,PTMIUSR9
          IF        !@EQUAL
            PACK      KEY5,ANSU,NINE,PTMIUSR9,SP70  * Food Allergy flag at patient level?
            CALL      RDCODE1
            IF        OVRCD<>1
              WRITE     HTMLFILE;" (",TDESC,")";
            ELSE
              WRITE     HTMLFILE;" (Unknown)";
            ENDIF
          ELSE
            WRITE     HTMLFILE;" (Unknown)";
          ENDIF
.
          REPLACE   " +",URNUMBER
.
CBDNSV16  CALL      ALERTI00
          WRITE     HTMLFILE;"</td>";
          GOTO      CBDNSV25
.
CBDNSV20  WRITE     HTMLFILE;"<td>",DTFASTNG,"</td>";
CBDNSV25  IF        SJOGVIEW<>1
            REP       "+ ",URNUMBER
            REP       "+ ",ADMISSNO
            CALL      PATATR00
.
            MATCH     SP70,PTARVAL3
            IF        @EQUAL
              CALL      CLCBMI00
            ELSE
              PACK      BODMASIN,PTARVAL3,SP70
            ENDIF
.
            CALL      RNGBMI00
            WRITE     HTMLFILE;"<td>";
            WRITE     HTMLFILE;"<img src=#"../images/MaintenanceIcon.gif#"":
                               " class=ListIcon onclick='PatientAttribute(#"":
                                 URNUMBER,"#",#"",ADMISSNO,"#");'>";
            WRITE     HTMLFILE;BODMASRN,"</td>";
            REP       " +",URNUMBER
            REP       " +",ADMISSNO
          ENDIF
.
          IF        HEAVIEW=1
            CALL      DSUP0000             * HEA - Display Supplements
            GOTO      CBDNSV26
          ENDIF
.
          IF        EXTRDIET=1
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML01,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC2
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML03,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC3
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML05,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC4
.
            MOVE      "MJ",CATEGORY
            MOVE      PMNUML07,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDSC5
.
            WRITE     HTMLFILE;"<td>",DIETDSC2,"<br>":
                                 DIETDSC3,"<br>":
                                 DIETDSC4,"<br>":
                                 DIETDSC5,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DTDTTYPE,"</td>";
          ENDIF
.
CBDNSV26  WRITE     HTMLFILE;"<td>";
.
.         * removed the following two lines for 0321554
.         MATCH     "1",STVVIEW
.         GOTO      CBDNSV28 IF EQUAL
.
          MATCH     SP70,PMNUCOM5
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            WRITE     HTMLFILE;"<br>",PMNUCOM5;
            GOTO      CBDNSV29
          ENDIF
.
          MATCH     SP70,PMNUCOM4
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            GOTO      CBDNSV29
          ENDIF
.
          MATCH     SP70,PMNUCOM3
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            GOTO      CBDNSV29
          ENDIF
.
          MATCH     SP70,PMNUCOM2
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            GOTO      CBDNSV29
          ENDIF
.
CBDNSV28  MATCH     SP70,PMNUCOM1
          IF        @EQUAL
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;PMNUCOM1;
          ENDIF
.
CBDNSV29  WRITE     HTMLFILE;"</td>";
.
CBDNSV30  WRITE     HTMLFILE;"<td>",DTASSLEV,"</td>";
.
          MOVE      SP70,KEY30
          MATCH     "1",PWDVTYPE
          IF        @EQUAL
            PACK      KEY30,PMVXPOWD,PMVXPOBD
            MATCH     SP70,KEY30
            GOTO      CBDNSV32 IF NOT EQUAL
            WRITE     HTMLFILE;"<td>",NBSP,"</td>";
            GOTO      CBDNSV40
CBDNSV32    PACK      KEY30,PMVXPOWD,NBSP,SLASH,NBSP,PMVXPOBD
            WRITE     HTMLFILE;"<td nowrap>",KEY30,"</td>";
          ELSE
            PACK      KEY30,PMNUDCDE,PMNUPAGN
            MATCH     KEY30,SP70
            GOTO      CBDNSV35 IF NOT EQUAL
            WRITE     HTMLFILE;"<td>",NBSP,"</td>";
            GOTO      CBDNSV40
CBDNSV35    WRITE     HTMLFILE;"<td nowrap>":
                               "<a href='javascript:HCPViewFrame(#"":
                               PMNUDCDE,"#")'>",DTDTNNAM,"</a>":
                               "<br>",PMNUPAGN,"</td>";
          ENDIF
.
CBDNSV40  MATCH     SP70,PMNUUPDD
          GOTO      CBDNSV45 IF EQUAL
          MOVE      PMNUUPDD,KEY16
          CALL      TSTMP000
          UNPACK    KEY20,KEY12,KEY8
          WRITE     HTMLFILE;"<td nowrap>",KEY12,"<br>",KEY8,"</td>"
          GOTO      CBDNSV99
CBDNSV45  WRITE     HTMLFILE;"<td>",NBSP,"</td>"; 
.
CBDNSV99  RETURN
.
.---------------------------------------------------------------------
.         Output Row details (Nutrition) hea diet (ptcnutom=1)
.---------------------------------------------------------------------
CBDHEA00  WRITE     HTMLFILE;"<td>&nbsp;";
          CALL      ALERTI00
          CALL      DALR0000             * Display alerts
          WRITE     HTMLFILE;"</td>";
.
.----  BMI
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
          CALL      PATATR00
.
          MATCH     SP70,PTARVAL3
          IF        @EQUAL
            CALL      CLCBMI00
          ELSE
            PACK      BODMASIN,PTARVAL3,SP70
          ENDIF
.
          CALL      RNGBMI00
          WRITE     HTMLFILE;"<td>";
          WRITE     HTMLFILE;"<img src=#"../images/MaintenanceIcon.gif#"":
                             " class=ListIcon onclick='PatientAttribute(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>";
          WRITE     HTMLFILE;BODMASRN,"</td>";
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
.----  Fasting
          MATCH     "Yes",DTFASTNG
          IF        @EQUAL
            WRITE     HTMLFILE;"<td class='PastDischDate'>",DTFASTNG,"<br>";
          ELSE
            WRITE     HTMLFILE;"<td>",DTFASTNG,"<br>";
          ENDIF
          WRITE     HTMLFILE;"<img src=../images/DietIcon.gif ":
                             " class=ListIcon onclick='UpdateNutrition(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#")'></td>";
.
          MOVE      ONE,F1
          WHILE     F1 <= 5
            PACK      KEY17,AADMNO,CURRDATE,F1
            CALL      RDCTCOM1
            IF        OVRCD=1
              CALL      CLCATCOM
            ENDIF
            MOVE      CATDC,CATEGORY               // Diet 1
            MOVE      CTCODIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML01
.
            MOVE      CATMJ,CATEGORY               // Diet 2
            MOVE      CTCOIT02,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML02
.
            MOVE      CATMJ,CATEGORY               // Diet 3
            MOVE      CTCOIT03,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML03
.
            MOVE      CATMJ,CATEGORY               // Diet 4
            MOVE      CTCOIT04,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML04
.
            MOVE      CATMJ,CATEGORY               // Diet 5
            MOVE      CTCOIT05,CODE
            CALL      GETCOD00
            MOVE      TDESC,DESCML05
.
.----  Breakfast/Lunch/Dinner
            WRITE     HTMLFILE;"<td nowrap>",DESCML01,"&nbsp;<br>":
                                      DESCML02,"&nbsp;<br>":
                                      DESCML03,"&nbsp;<br>":
                                      DESCML04,"&nbsp;<br>":
                                      DESCML05,"&nbsp;</td>";
            ADD         TWO,F1
          DO
.
.----  Supplements
CBDHEA15  CALL      DSUP0000             * HEA - Display Supplements
.
.----  Comments
          WRITE     HTMLFILE;"<td>";
.
          MATCH     SP70,PMNUCOM5
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            WRITE     HTMLFILE;"<br>",PMNUCOM5;
            GOTO      CBDHEA29
          ENDIF
.
          MATCH     SP70,PMNUCOM4
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            GOTO      CBDHEA29
          ENDIF
.
          MATCH     SP70,PMNUCOM3
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            GOTO      CBDHEA29
          ENDIF
.
          MATCH     SP70,PMNUCOM2
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            GOTO      CBDHEA29
          ENDIF
.
          MATCH     SP70,PMNUCOM1
          IF        @EQUAL
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;PMNUCOM1;
          ENDIF
.
CBDHEA29  WRITE     HTMLFILE;"</td>";
.
CBDHEA30  WRITE     HTMLFILE;"<td>",DTASSLEV,"</td>";
.
          MOVE      SP70,KEY30
          MATCH     "1",PWDVTYPE
          IF        @EQUAL
            PACK      KEY30,PMVXPOWD,PMVXPOBD
            MATCH     SP70,KEY30
            GOTO      CBDHEA32 IF NOT EQUAL
            WRITE     HTMLFILE;"<td>",NBSP,"</td>";
            GOTO      CBDHEA40
CBDHEA32    PACK      KEY30,PMVXPOWD,NBSP,SLASH,NBSP,PMVXPOBD
            WRITE     HTMLFILE;"<td nowrap>",KEY30,"</td>";
          ELSE
            PACK      KEY30,PMNUDCDE,PMNUPAGN
            MATCH     KEY30,SP70
            GOTO      CBDHEA35 IF NOT EQUAL
            WRITE     HTMLFILE;"<td>",NBSP,"</td>";
            GOTO      CBDHEA40
CBDHEA35    WRITE     HTMLFILE;"<td nowrap>":
                               "<a href='javascript:HCPViewFrame(#"":
                               PMNUDCDE,"#")'>",DTDTNNAM,"</a>":
                               "<br>",PMNUPAGN,"</td>";
          ENDIF
.
CBDHEA40  MOVE      SP70,DISPLUPD
          MOVE      SP70,DISPLUTM
          MATCH     SP70,PMNUUPDD
          GOTO      CBDHEA99 IF EQUAL
          MOVE      PMNUUPDD,KEY16
          CALL      TSTMP000
          UNPACK    KEY20,KEY12,KEY8
          MOVE      KEY12,DISPLUPD
          MOVE      KEY8,DISPLUTM
.
CBDHEA99  RETURN
.
.------------------------------------------------------------
. Current Admissions - Nutrition output heading - CAB View 2
.------------------------------------------------------------
CHEADQ00  IF        NOBEDWRD<>1
            WRITE     HTMLFILE;"<td class=HeadingCell ":
                               "align=center>Bed</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Patient</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell>Alerts</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell>Fasting</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Diet Type 1</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell>Diet Type 2</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell>Diet Type 3</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell>Diet Type 4</td>";
          WRITE     HTMLFILE;"<td class=HeadingCell>Diet Type 5</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=200>Comment</td>"
          WRITE     HTMLFILE;"<td class=HeadingCell>Menu/<br>":
                             "Assistance<br></td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Last Update<br>":
                                                   "Date Time</td>":
                             "<td class=HeadingCell>Adm.Date Time<br>":
                                                   "Exp.Discharge</td>";
          WRITE     HTMLFILE;"</tr>";
.
CHEADQ99  RETURN
.
.-----------------------------------------------------------------
. Current Admissions Patient Details (Nutrition) - CAB View 2
.-----------------------------------------------------------------
CBEDQ000  CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
.
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.                                           * Perform filtering if applicable
          BRANCH    DIETFILT,CBEDQ400       * 1=no filtering
          MATCH     SP30,DIETTYPE           *   Diet Type filtering requested ?
          GOTO      CBEDQ300 IF EQUAL       *   N - bypass (try Nutritionist)
          IF        EXTRDIET=1
            MATCH     DIETTYPE,ADIET          *   Y - correct diet type
          ELSE
            MATCH     DIETTYPE,PMNUDTYP       *   Y - correct diet type
          ENDIF
          GOTO      CBEDQ900 IF NOT EQUAL   *       N - ignore this record
.
CBEDQ300  MATCH     SP30,DIETNCDE           *   Nutritionist filtering reqstd ?
          GOTO      CBEDQ400 IF EQUAL       *   N - bypass (process the row)
          MATCH     DIETNCDE,PMNUDCDE       *   Y - correct doctor name ?
          GOTO      CBEDQ900 IF NOT EQUAL   *       N - ignore this record
.
CBEDQ400  WRITE     HTMLFILE;"<tr height=35>"
.
          IF        NOBEDWRD=1
            GOTO      CBEDQ500                * Bypass bed col for Wardonly Ward
          ENDIF
.
          BRANCH    FILETYPE,CBEDQ410,CBEDQ420,CBEDQ430
.
CBEDQ410  WRITE     HTMLFILE;"<td align=center class=UnallocatedCell>":
                             "<img src=#"../images/EditIcon.gif#"":
                             " class=ListIcon onclick='BedAllocation(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#");'>":
                             "</td>"
          GOTO      CBEDQ500
.
CBEDQ420  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                                 "title=#"",PTWDCOMM,"#" ":
                                 "bgcolor=gray>";
            ELSE
              WRITE     HTMLFILE;"<td align=center ":
                                 "title=#"",PTWDCOMM,"#">";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"<td align=center class=StandbyCell>";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
          GOTO      CBEDQ500
.
CBEDQ430  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"<td align=center class=ClosedCell ":
                               "title=#"",PTWDCOMM,"#" ":
                               "bgcolor=gray>";
          ELSE
            WRITE     HTMLFILE;"<td align=center class=LeaveCell>";
          ENDIF
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT,"&nbsp;</td>"
.
CBEDQ500  WRITE     HTMLFILE;"<td nowrap>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>";
.
          COMPARE   ONE,ONLVFLAG
          GOTO      CBEDQ520 IF NOT EQUAL
          COMPARE   THREE,FILETYPE
          GOTO      CBEDQ520 IF NOT EQUAL
.
          MATCH     "1",PTCNHLEA             * Check Parameter Disp.On Leave
          GOTO      CBEDQ520 IF NOT EQUAL
.
          MOVE      ADMISSNO,KEY8
          REP       "+ ",KEY8
          SQUEEZE   KEY8
          MOVE      KEY8,PVIBILL
          PROC      TLEA0000
.
          MOVE      "TL",CATEGORY            * Output Type of Leave
          CALL      GETCOD00
          MOVE      "On Leave - ",KEY11
          PACK      KEY31,KEY11,TDESC,SP70
          WRITE     HTMLFILE;FORMATNM,"<br>",KEY31,"</td>";
          GOTO      CBEDQ575
.
CBEDQ520  WRITE     HTMLFILE;FORMATNM,"</td>";
.
CBEDQ575  CALL      GETCON00               * Get Patient Condition Details
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          CALL      CBDNSQ00
          GOTO      CBEDQ700
.
CBEDQ700  MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
          REP       " +",ADMISSNO
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
CBEDQ850  WRITE     HTMLFILE;"<td nowrap class=",COLRFLAG,">":
                                 DISPDATE,ATIME,"<br>":
                                 EXPCTDSC,"</td>";
          WRITE     HTMLFILE;"</tr>"
CBEDQ900  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDQ999  RETURN
.
.---------------------------------------------------------------------
.         Output Row details (Nutrition)
.---------------------------------------------------------------------
CBDNSQ00  WRITE     HTMLFILE;"<td>&nbsp;";
.
          CALL      ALERT000 
          CALL      DSPICO00
          CALL      DALR0000             * Display alerts
          WRITE     HTMLFILE;"</td>";
.
          WRITE     HTMLFILE;"<td>",DTFASTNG,"</td>";
.
          WRITE     HTMLFILE;"<td><table><tr><td>":
                             "<img src=../images/DietIcon.gif ":
                             " class=ListIcon onclick='UpdateNutrition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#")'></td>";
.
          MOVE      "MJ",CATEGORY
          MOVE      PMNUDTYP,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC;
          WRITE     HTMLFILE;"</td></tr></table></td>";
.
          MOVE      "MJ",CATEGORY
          MOVE      PMNUML01,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"</td>";
.
          MOVE      "MJ",CATEGORY
          MOVE      PMNUML03,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"</td>";
.
          MOVE      "MJ",CATEGORY
          MOVE      PMNUML05,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"</td>";
.
          MOVE      "MJ",CATEGORY
          MOVE      PMNUML07,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"<td>",TDESC,"</td>";
.
CBDNSQ20  WRITE     HTMLFILE;"<td>";
.
          MATCH     SP70,PMNUCOM5
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            WRITE     HTMLFILE;"<br>",PMNUCOM5;
            GOTO      CBDNSQ29
          ENDIF
.
          MATCH     SP70,PMNUCOM4
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            WRITE     HTMLFILE;"<br>",PMNUCOM4;
            GOTO      CBDNSQ29
          ENDIF
.
          MATCH     SP70,PMNUCOM3
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            WRITE     HTMLFILE;"<br>",PMNUCOM3;
            GOTO      CBDNSQ29
          ENDIF
.
          MATCH     SP70,PMNUCOM2
          IF        !@EQUAL
            WRITE     HTMLFILE;PMNUCOM1;
            WRITE     HTMLFILE;"<br>",PMNUCOM2;
            GOTO      CBDNSQ29
          ENDIF
.
CBDNSQ28  MATCH     SP70,PMNUCOM1
          IF        @EQUAL
            WRITE     HTMLFILE;NBSP;
          ELSE
            WRITE     HTMLFILE;PMNUCOM1;
          ENDIF
.
CBDNSQ29  WRITE     HTMLFILE;"</td>";
.
CBDNSQ30  WRITE     HTMLFILE;"<td>";
          MOVE      ZERO,F1
          MOVE      SP70,ARYDESC[1]
          MOVE      SP70,ARYDESC[2]
          MOVE      SP70,ARYDESC[3]
          MOVE      SP70,ARYDESC[4]
          MOVE      SP70,ARYDESC[5]
.   
          MATCH     SP70,PMNUALVL 
          IF        !@EQUAL
            MOVE      "MK",CATEGORY
            MOVE      PMNUALVL,CODE
            CALL      GETCOD00
            IF        OVRCD = 1
              MOVE      PMNUALVL,TDESC
            ENDIF
            ADD       ONE,F1
            MOVE      TDESC,ARYDESC[F1]
          ENDIF
.
          MATCH     SP70,PMNUUDF1
          IF        !@EQUAL
            MOVE      "MK",CATEGORY
            MOVE      PMNUUDF1,CODE
            CALL      GETCOD00
            IF        OVRCD = 1
              MOVE      PMNUUDF1,TDESC
            ENDIF
            ADD       ONE,F1
            MOVE      TDESC,ARYDESC[F1]
          ENDIF
.
          MATCH     SP70,PMNUUDF2
          IF        !@EQUAL
            MOVE      "MK",CATEGORY
            MOVE      PMNUUDF2,CODE
            CALL      GETCOD00
            IF        OVRCD = 1
              MOVE      PMNUUDF2,TDESC
            ENDIF
            ADD       ONE,F1
            MOVE      TDESC,ARYDESC[F1]
          ENDIF
.
          MATCH     SP70,PMNUUDF3
          IF        !@EQUAL
            MOVE      "MK",CATEGORY
            MOVE      PMNUUDF3,CODE
            CALL      GETCOD00
            IF        OVRCD = 1
              MOVE      PMNUUDF3,TDESC
            ENDIF
            ADD       ONE,F1
            MOVE      TDESC,ARYDESC[F1]
          ENDIF
.
          MATCH     SP70,PMNUUDF4
          IF        !@EQUAL
            MOVE      "MK",CATEGORY
            MOVE      PMNUUDF4,CODE
            CALL      GETCOD00
            IF        OVRCD = 1
              MOVE      PMNUUDF4,TDESC
            ENDIF
            ADD       ONE,F1
            MOVE      TDESC,ARYDESC[F1]
          ENDIF
.
          MATCH     SP70,ARYDESC[1]
          IF        !@EQUAL
             WRITE     HTMLFILE;ARYDESC[1];
          ENDIF
.
          MATCH     SP70,ARYDESC[2]
          IF        !@EQUAL
             WRITE     HTMLFILE;"<br>",ARYDESC[2];
          ENDIF
.
          MATCH     SP70,ARYDESC[3]
          IF        !@EQUAL
             WRITE     HTMLFILE;"<br>",ARYDESC[3];
          ENDIF
.
          MATCH     SP70,ARYDESC[4]
          IF        !@EQUAL
             WRITE     HTMLFILE;"<br>",ARYDESC[4];
          ENDIF
.
          MATCH     SP70,ARYDESC[5]
          IF        !@EQUAL
             WRITE     HTMLFILE;"<br>",ARYDESC[5];
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
CBDNSQ40  MOVE      SP70,COLRFLG1
          MATCH     SP70,PMNUUPDD
          GOTO      CBDNSQ45 IF EQUAL
.
CBDNSQ41  MOVE      PMNUUPDD,KEY16
          CALL      TSTMP000
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          CLOCK     TIME,CTIMEIS           
.
          UNPACK    PMNUUPDD,TEMPDATE,TEMPTIME
          MOVE      TEMPDATE,DTFRSDTE
          MOVE      TEMPTIME,DTFRSTIM
          MOVE      CURRDATE,DTLSTDTE
          MOVE      CTIMEIS,DTLSTTIM
          CALL      TIMEDIFS
.
          IF        DTODAYS > 0
            GOTO      CBDNSQ43
          ENDIF
.
          IF        DTOHOUR > 12
            GOTO      CBDNSQ43
          ENDIF
.
CBDNSQ42  MOVE      "PastDischDate",COLRFLG1 
          UNPACK    KEY20,KEY12,KEY8
          WRITE     HTMLFILE;"<td nowrap class=",COLRFLG1,">":
                             KEY12,"<br>",KEY8,"</td>"
          GOTO      CBDNSQ99
.           
CBDNSQ43  UNPACK    KEY20,KEY12,KEY8
          WRITE     HTMLFILE;"<td nowrap>",KEY12,"<br>",KEY8,"</td>"
          GOTO      CBDNSQ99
.
CBDNSQ45  WRITE     HTMLFILE;"<td>",NBSP,"</td>";
.
CBDNSQ99  RETURN
+
.*******************************************************************************
.         Initialise Alert code array
.*******************************************************************************
IALR0000  MOVE      ZERO,FORM2
          WHILE     FORM2 < 99
            ADD       ONE,FORM2
            MOVE      SP70,ALRTCODE[FORM2]
            MOVE      SP70,ALRTICON[FORM2]
          DO
.
          MOVE      ZERO,ALRTICNT
.
IALR9999  RETURN
+
.------------------------------------------------------------
.         Display H6 alert Code description
.------------------------------------------------------------
H6ALR000  CALL      IALR0000                * Initialise variables
          MOVE      ZERO,FORM2
          REPLACE   "+ ",URNUMBER
          PACK      KEY16,URNUMBER,SP70
          CALL      RSPTALR1
H6ALR100  CALL      RKPTALR1                * Check if any H6 Alerts Exist?
          BRANCH    OVRCD,H6ALR900
.
          MATCH     URNUMBER,PTALURNO
          GOTO      H6ALR900 IF NOT EQUAL
.
          MATCH     SP70,PTALCODE
          GOTO      H6ALR100 IF EQUAL
.
          PACK      KEY5,PTALCATG,PTALCODE
          CALL      RDCODE1
          BRANCH    OVRCD,H6ALR100
.
          MATCH     "F",TCINDC20
          GOTO      H6ALR100 IF NOT EQUAL
.
          COMPARE   "99",FORM2
          GOTO      H6ALR900 IF NOT LESS
.
          ADD       ONE,FORM2
          MOVE      TDESC,ALRTCODE[FORM2]
          GOTO      H6ALR100
.
H6ALR900  REPLACE   " +",URNUMBER
.
H6ALR999  RETURN
+
.------------------------------------------------------------
. Get all the H6 alert description - TCINDC20 = "F" only 
.------------------------------------------------------------
ALERT000  CALL      IALR0000                * Initialise variables
          MOVE      ZERO,ALRTDCNT
          REPLACE   "+ ",URNUMBER
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY16,URNUMBER,SP70
          CALL      RSPTALR1
ALERT100  CALL      RKPTALR1                * Check if any H6 Alerts Exist?
          BRANCH    OVRCD,ALERT900
.
          MATCH     URNUMBER,PTALURNO
          GOTO      ALERT900 IF NOT EQUAL
.
          MATCH     SP70,PTALCODE
          GOTO      ALERT100 IF EQUAL
.
          MATCH     SP70,PTALEDAT
          IF        !@EQUAL
            MATCH     PTALEDAT,CURRDATE            * future end date
            GOTO      ALERT200 IF LESS
.
            GOTO      ALERT100                     * show alert as inactive
          ENDIF
.
ALERT200  PACK      KEY5,PTALCATG,PTALCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,ALERT100
.
          MATCH     "F",TCINDC20
          GOTO      ALERT100 IF NOT EQUAL
.
          COMPARE   "99",ALRTDCNT
          GOTO      ALERT900 IF NOT LESS
.
          ADD       ONE,ALRTDCNT
          MOVE      TDESC,ALRTCODE[ALRTDCNT]
.
          REP       "S2 1",TCINDC4           * Security Alert
.
          MATCH     SP1,TCINDC5              * using indc5 for alert icons?
          IF        !@EQUAL
            PACK      ICONNAME,TCINDC5,SP70
          ELSE
            PACK      ICONNAME,TCINDC4,SP70  * if not, default to indc4
          ENDIF
          SQUEEZE   ICONNAME
.
          CALL      ADDICO00
.
          GOTO      ALERT100
.
ALERT900  REPLACE   " +",URNUMBER
.
ALERT999  RETURN
.
.-----------------------------------------------------------------------
. Add Icon name to alert icon array if it does not already exists
.-----------------------------------------------------------------------
ADDICO00  MOVE      0,FORM2
          WHILE     FORM2 < 99 & FORM2 < ALRTICNT 
            ADD       ONE,FORM2
            MATCH     ICONNAME,ALRTICON[FORM2]  
            GOTO      ADDICO99 IF EQUAL
          DO
.
          ADD       ONE,ALRTICNT
          MOVE      ICONNAME,ALRTICON[ALRTICNT]
.
ADDICO99  RETURN
.
.-----------------------------------------------------------------------
. Display alert icon
.-----------------------------------------------------------------------
DSPICO00  MOVE      0,FORM2
          MOVE      0,FORM1
          WHILE     FORM2 < ALRTICNT
            ADD       ONE,FORM2
            ADD       ONE,FORM1
            MOVE      ALRTICON[FORM2],ICONNAME
            CLEAR     ICONFILE
DSPICO20    APPEND    "AlertIcon",ICONFILE
            APPEND    ICONNAME,ICONFILE
            APPEND    ".gif'",ICONFILE   
            RESET     ICONFILE 
            SQUEEZE   ICONFILE
.
            CLEAR     HTMLLINK
            APPEND    "<img src='../images/",HTMLLINK
            APPEND    ICONFILE,HTMLLINK
            APPEND    " class=ListIcon onclick=PatientAlerts('",HTMLLINK
            APPEND    URNUMBER,HTMLLINK
            APPEND    "','",HTMLLINK
            APPEND    ADMISSNO,HTMLLINK
            APPEND    "')>",HTMLLINK
            RESET     HTMLLINK
            IF        FORM1 = 1
              IF        FORM2 = 1
                WRITE     HTMLFILE;HTMLLINK;
              ELSE
                WRITE     HTMLFILE;"<br>",HTMLLINK;
              ENDIF
            ELSE
              WRITE     HTMLFILE;HTMLLINK;
              IF        FORM1 = 4
                MOVE      0,FORM1
              ENDIF
            ENDIF
          DO
.
DSPICO99  RETURN
+
.------------------------------------------------------------
.         Display Alert for Healthscope
.------------------------------------------------------------
DALR0000  MOVE      ZERO,FORM2
DALR1000  COMPARE   "99",FORM2
          GOTO      DALR9999 IF NOT LESS
.
          ADD       ONE,FORM2
DALR200   MATCH     SP70,ALRTCODE[FORM2]
          GOTO      DALR9999 IF EQUAL
.
DALR300   WRITE     HTMLFILE;"<br>",ALRTCODE[FORM2],NBSP;
          GOTO      DALR1000
.
DALR9999  RETURN
+
.------------------------------------------------------------
.         Display Diet types for Healthscope
.------------------------------------------------------------
DDIET000  
.         COMPARE   ONE,EXTRDIET
.         GOTO      DDIET2000 IF NOT EQUAL
.
          MATCH     SP70,PMNUML01
          IF        !@EQUAL
            PACK      KEY5,ANSM,ANSJ,PMNUML01
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<br>",TDESC,NBSP;
            ENDIF
          ENDIF
.
          MATCH     SP70,PMNUML03
          IF        !@EQUAL
            PACK      KEY5,ANSM,ANSJ,PMNUML03
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<br>",TDESC,NBSP;
            ENDIF
          ENDIF
.
          MATCH     SP70,PMNUML05
          IF        !@EQUAL
            PACK      KEY5,ANSM,ANSJ,PMNUML05
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<br>",TDESC,NBSP;
            ENDIF
          ENDIF
.
          MATCH     SP70,PMNUML07
          IF        !@EQUAL
            PACK      KEY5,ANSM,ANSJ,PMNUML07
            CALL      RDCODE1
            IF        OVRCD=0
              WRITE     HTMLFILE;"<br>",TDESC,NBSP;
            ENDIF
          ENDIF
          GOTO      DDIET9999
.
DDIET2000 WRITE     HTMLFILE;"<br>",DTDTTYPE,NBSP;
.
DDIET999  RETURN
.
.------------------------------------------------------------
.         Display Supplements for Healthscope
.------------------------------------------------------------
DSUP0000  MATCH     "1",PTCNUESD
          IF        @EQUAL
            REP       "+ ",URNUMBER
            WRITE     HTMLFILE;"<td><input class='button' type=button value='Supplements' onClick='SupplementLink(#"":
                   URNUMBER,"#");'></td>";
            REP       " +",URNUMBER
          ELSE
            WRITE     HTMLFILE;"<td><br>B-",PMNUBSUP,NBSP;
            WRITE     HTMLFILE;"<br>M-",PMNUMSUP,NBSP;
            WRITE     HTMLFILE;"<br>L-",PMNULSUP,NBSP;
            WRITE     HTMLFILE;"<br>A-",PMNUASUP,NBSP;
            WRITE     HTMLFILE;"<br>D-",PMNUDSUP,NBSP;
            WRITE     HTMLFILE;"<br>S-",PMNUSSUP,NBSP,"</td>";
          ENDIF
.
DSUP9999  RETURN
+
.------------------------------------------------------------
.         Output Row details (Nutrition) specific RCH (kids)      
.------------------------------------------------------------
CBDNRC00  WRITE     HTMLFILE;"<td>"
.
          MATCH     "1",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                               " title='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBDNRC05
          ENDIF
          MATCH     "2",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                               " title='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBDNRC05
          ENDIF
.
          MATCH     "3",PTMXSIN1
          IF        @EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                               " title='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
            GOTO      CBDNRC05
          ENDIF
.
          MATCH     SP70,PTMXSIN1
          IF        !@EQUAL
            WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                               PTMXSIN1,".gif'":
                               " title='Alerts'":
                               " class=ListIcon onclick='PatientAlerts(#"":
                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
.
CBDNRC05  MATCH     "1",PTMXSIN2
          IF        @EQUAL
.            WRITE     HTMLFILE;"<img src=#"../images/ResultIcon.gif#"":
.                               " class=ListIcon onclick='PatientResults(#"":
.                               URNUMBER,"#",#"",ADMISSNO,"#");'>"
          ENDIF
          WRITE     HTMLFILE;"<img src=../images/",IMGSRC:
                             " class=ListIcon onclick='UpdateCondition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#")'>":
                             CONDESC,DISPDATE,"<br>",LPCONDD,"</td>";
.
CBDNRC10  WRITE     HTMLFILE;"<td><img src=../images/DietIcon.gif ":
                             " class=ListIcon onclick='UpdateNutrition(#"":
                             URNUMBER,"#",#"",ADMISSNO,"#")'>":
                             TDESC,"</td>";
.
CBDNRC20  WRITE     HTMLFILE;"<td>",DTFASTNG,"</td>";
          WRITE     HTMLFILE;"<td>",DTDTTYPE,"</td>";
          WRITE     HTMLFILE;"<td>","Other Details","</td>";
CBDNRC25  WRITE     HTMLFILE;"<td>",PMNUCOM1,NBSP,"</td>";
.
....CBDNRC40  WRITE     HTMLFILE;"<td>",ACLSSFT,"</td>":
....                             "<td nowrap>":
....                               DISPDATE,ATIME,"<br>":
....                               EXPCTDSC,"</td>";
.
CBDNRC99  RETURN
.------------------------------------------------------------
. Heading Row (nutrition view)
.------------------------------------------------------------
CRHDN000  MOVE      TEN1,CSPANUM             * St. Vincents (stnd)
          IF        KIDSONLY=ONE         
            MOVE      TEN2,CSPANUM          * RCH (kids)      
          ENDIF
          MATCH     "2",PWDVTYPE
          IF        @EQUAL
            MOVE      TEN3,CSPANUM          * CAB view 2
          ELSE
            MATCH     "1",PTCNUTOM
            IF        @EQUAL
              MOVE      TEN3,CSPANUM        * HEA diet
            ENDIF  
          ENDIF
.
CRHDN500  IF        NOBEDWRD=1
            SUBTRACT  ONE,CSPANUM           * Remove 'bed' col for WardOnly Ward
          ENDIF
          MOVE      CSPANUM,CSPAN
          SQUEEZE   CSPAN
          WRITE     HTMLFILE;"<tr><td colspan=",CSPAN," align=center ":
                               "class=HeadingCell><b>",ROWHEAD,"</b></td></tr>"
CRHDN999  RETURN
.------------------------------------------------------------
. Current AdmissIons (nutrition) Bed Row message.
.------------------------------------------------------------
CBDMSN00  MATCH     "2",PWDVTYPE
          IF        @EQUAL
            CALL      CBDMSQ00
            GOTO      CBDMSN99 
          ENDIF
.
          BRANCH    BEDMSGID,CBDMSN01,CBDMSN02
.
          MOVE      "LeaveCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSN10
.
CBDMSN01  MOVE      "AvailableCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSN10
.
CBDMSN02  BRANCH    WBEDTYPE,CBDMSN99                                 *I-273956
          MOVE      "ClosedCell bgcolor=gray",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
.
CBDMSN10
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                             "<td align=center class=",BDMSGCLS,">";
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT;

          WRITE     HTMLFILE;"</td><td align=center>",BDMSGTXT,"</td>";
.
                                                 * RCH (kids) has extra 2 cols
CBDMSN40  IF        KIDSONLY=ONE
            WRITE     HTMLFILE;"<td>&nbsp;</td>":
                               "<td>&nbsp;</td>";
          ENDIF
.
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";     * hea diet has extra col
          ENDIF
CBDMSN60
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
          IF        SJOGVIEW<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
CBDMSN99  RETURN
.
.------------------------------------------------------------
. Current AdmissIons (nutrition) Bed Row message - CAB
.------------------------------------------------------------
CBDMSQ00  BRANCH    BEDMSGID,CBDMSQ01,CBDMSQ02
.
          MOVE      "LeaveCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSQ10
.
CBDMSQ01  MOVE      "AvailableCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSQ10
.
CBDMSQ02  BRANCH    WBEDTYPE,CBDMSQ99                                 *I-273956
          MOVE      "ClosedCell bgcolor=gray",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
.
CBDMSQ10
          WRITE     HTMLFILE;"<tr height=35 align=top>":
                             "<td align=center class=",BDMSGCLS,">";
.
          CALL      FBED0000
          WRITE     HTMLFILE;*+,BEDTEXT;

          WRITE     HTMLFILE;"</td><td align=center>",BDMSGTXT,"</td>";
.
          MATCH     "1",PTCNUTOM
          IF        @EQUAL
            WRITE     HTMLFILE;"<td>&nbsp;</td>";     * hea diet has extra col
          ENDIF
.
CBDMSQ60
          WRITE     HTMLFILE;"<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>":
                             "<td>&nbsp;</td>";
.
          IF        SJOGVIEW<>1
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
CBDMSQ99  RETURN
.
.-------------------------------------------------------------------------
. Calculate number of patients,empty beds and patients not allocated a bed
.-------------------------------------------------------------------------
WARDET00  BRANCH    WINPUT,WARDET50,WARDET70
.
WARDET20  COMPARE   ZERO,WINPUT 
          GOTO      WARDET99 IF NOT EQUAL
.
          CALL      WARBED00           * Details for ward/bed
          GOTO      WARDET99
.
WARDET50  CALL      WARONL00           * Details for ward only
          GOTO      WARDET99
.
WARDET70  CALL      WARBED00           * Details for ward only and ward/bed
.
          MOVE      NUMBPATS,SAVBPATS  * Save Ward/bed details
          MOVE      NUMEMBED,SAVEMBED
          MOVE      NUMNOBED,SAVNOBED
.
          CALL      WARONL00
.
          ADD       SAVBPATS,NUMBPATS  * Add ward bedtotals to ward only 
          ADD       SAVEMBED,NUMEMBED
          ADD       SAVNOBED,NUMNOBED 
.
          GOTO      WARDET99
.
WARDET99  RETURN
+
.-------------------------------------------------------------------------
. Calculate ward/bed details
.-------------------------------------------------------------------------
WARBED00  MOVE      ZERO,NUMBPATS
          MOVE      ZERO,NUMEMBED
          MOVE      ZERO,NUMNOBED
WARBED10  CALL      RDKWARD1
          BRANCH    OVRCD,WARBED90
          MATCH     WARDCODE,WWARD
          GOTO      WARBED90 IF NOT EQUAL
          BRANCH    WACTIVE,WARBED10     * Do not include inactive bed
.
          MATCH     ZEROVISN,WADMNO
          IF        !@EQUAL
            ADD       ONE,NUMBPATS
          ENDIF
.
          MATCH     ZEROVISN,WSTBY
          IF        !@EQUAL
            ADD       ONE,NUMBPATS
          ENDIF
.
          MATCH     ZEROVISN,WADMNO
          IF        @EQUAL
            ADD       ONE,NUMEMBED
          ENDIF
. 
          GOTO      WARBED10
.
WARBED90  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,WARBED99
          GOTO      WARBED99
.
WARBED99  RETURN
.
.-------------------------------------------------------------------------
. Calculate ward only details
.-------------------------------------------------------------------------
WARONL00  MOVE      ZERO,NUMBPATS
          MOVE      ZERO,NUMEMBED
          MOVE      ZERO,NUMNOBED
          PACK      KEY13,WARDCODE,SP70
          CALL      RDSNOBE1
WARONL10  CALL      RDKNOBE1
          BRANCH    OVRCD,WARONL90
          MATCH     WARDCODE,NBWARD
          GOTO      WARONL90 IF NOT EQUAL
.
          ADD       ONE,NUMBPATS
          ADD       ONE,NUMNOBED
          GOTO      WARONL10
.
WARONL90  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,WARONL99 
          ASSIGN    (WOCCBED - NUMBPATS),NUMEMBED

WARONL99  RETURN
.
.-------------------------------------------------------------------------
. Close patient dependency list
.-------------------------------------------------------------------------
CLDEP000  MATCH     SP70,WARDCODE
          GOTO      CLDEP999 IF EQUAL
.
          MATCH     SP70,SHIFTNUM
          GOTO      CLDEP999 IF EQUAL
.
          PACK      KEY20,WARDCODE,LASTDATE,SHIFTNUM,SP70
          CALL      RSPMPDP2
CLDEP100  CALL      RKPMPDP2
          BRANCH    OVRCD,CLDEP999
.
          MATCH     WARDCODE,PMPDWARD
          GOTO      CLDEP999 IF NOT EQUAL 
.
          MATCH     LASTDATE,PMPDDATE
          GOTO      CLDEP999 IF NOT EQUAL 
.
          MATCH     SHIFTNUM,PMPDSHIF
          GOTO      CLDEP999 IF NOT EQUAL 
.
          MOVE      ANSY,PMPDCLOS
          CALL      UPPMPDP2
          GOTO      CLDEP100
.
CLDEP999  RETURN
+
.*******************************************************************************
. Get working diagnosis Comments
.*******************************************************************************
GETWOR00  PREP      WORCOMAF,WORCOMNM
          MOVE      ONE,F3
          WRITE     WORCOMAF,SEQ;QRYDATA
          MOVE      ONE,WORCOMFL
          MOVE      ONE,WDIGFLAG       * Set update file flag to yes
.
GETWOR10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETWOR90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETWOR80 IF NOT EQUAL
          MATCH     SP70,QRYDATA
          GOTO      GETWOR10 IF EQUAL
          GOTO      GETWOR10 IF EOS
          ADD       ONE,F3
          WRITE     WORCOMAF,SEQ;QRYDATA
.
          GOTO      GETWOR10
.
GETWOR80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETWOR90  OPEN      WORCOMAF,WORCOMNM
GETWOR99  RETURN
+
.-------------------------------------------------------------------
.   Add working diagnosis text
.------------------------------------------------------------------
ADDWOR00  COMPARE   ZERO,WORCOMFL     * No Comments in Update Ignore
          GOTO      ADDWOR99 IF EQUAL
          MOVE      ZERO,F3
          MOVE      SP70,PMSWO002
          MOVE      SP70,PMSWO003
          MOVE      SP70,PMSWO004
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WORCOMAF,WORCOMNM
          TRAPCLR   IO
          BRANCH    OVRCD,ADDWOR99
.
ADDWOR10  ADD       ONE,F3
          COMPARE   F3,THREE
          GOTO      ADDWOR99 IF LESS
.
          READ      WORCOMAF,SEQ;DIM35
          GOTO      ADDWOR99 IF OVER
          STORE     DIM35,F3,PMSWO002,PMSWO003,PMSWO004
.
          GOTO      ADDWOR10
.
ADDWOR99  RETURN
+
.*******************************************************************************
. Get history Comments
.*******************************************************************************
GETHIS00  PREP      HISCOMAF,HISCOMNM
          MOVE      ONE,F3
          WRITE     HISCOMAF,SEQ;QRYDATA
          MOVE      ONE,HISCOMFL
.
GETHIS10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETHIS90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETHIS80 IF NOT EQUAL
          MATCH     SP70,QRYDATA
          GOTO      GETHIS10 IF EQUAL
          GOTO      GETHIS10 IF EOS
          ADD       ONE,F3
          WRITE     HISCOMAF,SEQ;QRYDATA
.
          GOTO      GETHIS10
.
GETHIS80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETHIS90  OPEN      HISCOMAF,HISCOMNM
GETHIS99  RETURN
+
.-------------------------------------------------------------------
.   Add working diagnosis text
.------------------------------------------------------------------
ADDHIS00  COMPARE   ZERO,HISCOMFL     * No Comments in Update Ignore
          GOTO      ADDHIS99 IF EQUAL
          MOVE      ZERO,F3
          MOVE      SP70,PMSVX052
          MOVE      SP70,PMSVX053
          MOVE      SP70,PMSVX054
          MOVE      SP70,PMSVX055
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      HISCOMAF,HISCOMNM
          TRAPCLR   IO
          BRANCH    OVRCD,ADDHIS99
.
ADDHIS10  ADD       ONE,F3
          COMPARE   F3,FOUR
          GOTO      ADDHIS99 IF LESS
.
          READ      HISCOMAF,SEQ;DIM50
          GOTO      ADDHIS99 IF OVER
          STORE     DIM50,F3,PMSVX052,PMSVX053,PMSVX054,PMSVX055
.
          GOTO      ADDHIS10
.
ADDHIS99  RETURN
+
.-------------------------------------------------------------------
.   Get emergency visit number for this admission
.------------------------------------------------------------------
GETE0000  PACK      KEY16,AURNO,Z70
          CALL      RSEMVIS3
GETE1000  CALL      RPEMVIS3
          BRANCH    OVRCD,GETE9000
.
          MATCH     AURNO,EMVIURNO
          GOTO      GETE9000 IF NOT EQUAL
.
          MATCH     DAADMNO,EMVIPADM       * Check for matching linked visit
          GOTO      GETE1000 IF NOT EQUAL
.
          GOTO      GETE9999
.
GETE9000  CALL      CLEMRVIS
.
GETE9999  RETURN
.
.------------------------------------------------------------
. Ward selection
.------------------------------------------------------------
EMUW0000  MATCH     "1",DEFTFLAG
          IF        !@EQUAL
            MOVE      SP3,WARDCODE
          ENDIF
.
          PACK      KEY29,SP70
          IF        IBCNMHOS = 1
            PACK      KEY29,SP3,WBSEHOSP,SP70
          ENDIF
          CALL      RDSWARD7
EMUW0100  CALL      RDKWARD7
          BRANCH    OVRCD,EMUW9999
.
.                         if we have a bed number we have passed all the ward
.                         master records, so exit
          MATCH     SP70,WBED
          GOTO      EMUW9999 IF NOT EQUAL
.
          COMPARE   WACTIVE,ZERO                 *List only active wards
          GOTO      EMUW0100 IF NOT EQUAL
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        !@EQUAL
              MATCH     WBSEHOSP,PTWDHOSN
              GOTO      EMUW9999 IF NOT EQUAL
            ENDIF
          ENDIF
.
.      * if no default ward, set it as the first EOU ward 
          MATCH     SP70,WARDCODE
          IF        @EQUAL
            PACK      KEY5,ANSB,ANST,WEFRBT,SP70
            CALL      RDCODE1
            IF        OVRCD=0.
              MATCH     "S",THCSCOD             * EOU Unit
              IF        @EQUAL
                MATCH     ANSO,TCINDC8
                IF        @EQUAL
                  MOVE      WWARD,WARDCODE      * Set wardcode cgi
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
.                       write the select option.
          WRITE     HTMLFILE;"<option value=#"",WWARD,"#"";
          MATCH     WARDCODE,WWARD
          IF        @EQUAL
            WRITE     HTMLFILE;" selected";
          ENDIF
          WRITE     HTMLFILE;">",WBDESC;
.
          IF        IBCNMHOS = 1
            MATCH      SP3,WBSEHOSP
            IF        @EQUAL
              WRITE     HTMLFILE;" - ",PTWDHOSN;
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"</option>"
          GOTO      EMUW0100
.
EMUW9999  RETURN
.
.------------------------------------------------------------
. Expected Discharges
.------------------------------------------------------------
EXPDIS00  CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          MOVE      "Expected Discharges",WEBTITLE 
.
          CALL      WEBHED00
          BRANCH    EXIT,EXPDIS99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      EXPDIS99
.
EXPDIS99  RETURN
.
.------------------------------------------------------------
. Ward Admissions
.------------------------------------------------------------
EXPD0000  BRANCH    FLDITMNO,EXPD0100,EXPD0200,EXPD0300,EXPD0400,EXPD0500:
                             EXPD0600,EXPD0700,EXPD0800,EXPD0900,EXPD1000:
                             EXPD1100,EXPD1200,EXPD1300,EXPD1400,EXPD1500:
                             EXPD1600,EXPD1700,EXPD1800,EXPD1900,EXPD2000:
                             EXPD2100,EXPD2200,EXPD2300
          GOTO      EXPD9999
.
EXPD0100  CALL      NEXT0000
          GOTO      EXPD9999
.
EXPD0200  CALL      PREV0000
          GOTO      EXPD9999
.
EXPD0300  CALL      CURSTD00
          GOTO      EXPD9999
.
EXPD0400  CALL      CUREND00
          GOTO      EXPD9999
.
EXPD0500  CALL      CURYR000
          GOTO      EXPD9999
.
EXPD0600  CALL      CURMON00
          GOTO      EXPD9999
.
EXPD0700  CALL      SELV0000
          GOTO      EXPD9999
.
EXPD0800  CALL      ETABD000        * Table of Expected Discharges
          GOTO      EXPD9999
.
EXPD0900  WRITE     HTMLFILE;TEMPLATE;
          GOTO      EXPD9999
.
EXPD1000  WRITE     HTMLFILE;REPORTNO;
          GOTO      EXPD9999
.
EXPD1100  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      EXPD9999
.
EXPD1200  PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000        * Ward Select Options
          GOTO      EXPD9999
.
EXPD1300  MOVE      "vi",CATEGORY
          MOVE      FILTDPST,CODE
          CALL      CODITM00
          GOTO      EXPD9999
.
EXPD1400  MOVE      "CL",CATEGORY
          MOVE      FILTCLAI,CODE
          CALL      CODITM00
          GOTO      EXPD9999
.
EXPD1500  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MATCH     "1",DEFTFLAG
            IF        @EQUAL
              MOVE      WBSEWRD,WARDCODE    * default to user id ward
            ENDIF
          ENDIF
          PACK      DFLTWARD,WARDCODE
          CALL      WSEL0000                * Ward selection list
          GOTO      EXPD9999
.
EXPD1600  WRITE     HTMLFILE;DEFTVIEW;
          GOTO      EXPD9999
.
EXPD1700  WRITE     HTMLFILE;SELPRINT;
          GOTO      EXPD9999
.
EXPD1800  CALL      EXABD000    * Table of Expected Discharges blank exp date
          GOTO      EXPD9999
.
EXPD1900  WRITE     HTMLFILE;SHOWFLAG;
          GOTO      EXPD9999
.
EXPD2000  MOVE      "ZT",CATEGORY
          MOVE      FILTEXPD,CODE
          CALL      CODITM00
          GOTO      EXPD9999
.
EXPD2100  WRITE     HTMLFILE;FILTEXDY;
          GOTO      EXPD9999
.
EXPD2200  WRITE     HTMLFILE;TENTACNT;
          GOTO      EXPD9999
.
EXPD2300  WRITE     HTMLFILE;CONFMCNT;
          GOTO      EXPD9999
.
EXPD9999  RETURN
.
.------------------------------------------------------------
. Displays Expected discharges from the working diagnosis
. expected discharge date.
.------------------------------------------------------------
ETABD000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,TENTACNT
          MOVE      ZERO,CONFMCNT   
.
          MOVE      ZERO,DISNUMB
          PACK      KEY16,FRSTDATE,SP70
          CALL      RSPMWOR2
ETABD100  CALL      RKPMWOR2
          BRANCH    OVRCD,ETABD900
.
          MATCH     PMWOEDAT,LASTDATE
          GOTO      ETABD900 IF LESS
.
          COMPARE   ONE,IBCNMHOS
          GOTO      ETABD150 IF NOT EQUAL
.
          MOVE      PMWOADMN,KEY8
          CALL      RDPMVX11                  * Check hosital
          BRANCH    OVRCD,ETABD100
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      ETABD100 IF NOT EQUAL
.
ETABD150  MOVE      PMWOADMN,KEY8
          CALL      RDMISS1                   * Get Admission file rec
          BRANCH    OVRCD,ETABD100
.
          COMPARE   TWO,ASTAT                 * Current Adm
          GOTO      ETABD200 IF EQUAL
.
          COMPARE   FOUR,ASTAT                * On Leave
          GOTO      ETABD200 IF EQUAL
.
          GOTO      ETABD100
.
ETABD200  CALL      EROWD000
          GOTO      ETABD100
ETABD900
ETABD999  RETURN
.
.------------------------------------------------------------
. Displays Expected discharges from the working diagnosis
. expected discharge date.
.------------------------------------------------------------
EXABD000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          MOVE      ZERO,TENTACNT
          MOVE      ZERO,CONFMCNT   
.
          PACK      KEY16,SP70
          CALL      RSPMWOR2
EXABD100  CALL      RKPMWOR2
          BRANCH    OVRCD,EXABD900
.
          MATCH     SP70,PMWOEDAT
          GOTO      EXABD999 IF NOT EQUAL
.
          MOVE      PMWOADMN,KEY8
          CALL      RDMISS1                   * Get Admission file rec
          BRANCH    OVRCD,EXABD100
.
          COMPARE   "999",ASTAY
          GOTO      EXABD100 IF NOT EQUAL
.
EXABD120  COMPARE   ONE,IBCNMHOS
          GOTO      EXABD150 IF NOT EQUAL
.         
          MOVE      PMWOADMN,KEY8           
          CALL      RDPMVX11                  * Check hosital
          BRANCH    OVRCD,EXABD100
.
          MATCH     WBSEHOSP,PMVXMHOS
          GOTO      EXABD100 IF NOT EQUAL
.
EXABD150  COMPARE   TWO,ASTAT                 * Current Adm
          GOTO      EXABD200 IF EQUAL
.
          COMPARE   FOUR,ASTAT                * On Leave
          GOTO      EXABD200 IF EQUAL
.
          GOTO      EXABD100
.
EXABD200  CALL      EROWD000
          GOTO      EXABD100
EXABD900
EXABD999  RETURN
.
.------------------------------------------------------------
. Expected Discharge row
.------------------------------------------------------------
EROWD000  MOVE      PMWOADMN,ADMISSNO       * set admission number
.
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          CALL      GETCON00                * Get Patients Current Condition
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
.
          MATCH     SP70,FILTDPST           * Preparation status filter
          IF        !@EQUAL
            MATCH     FILTDPST,PMWODPST
            GOTO      EROWD999 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTCLAI           * Claim code filter
          IF        !@EQUAL
            MATCH     FILTCLAI,ACLAIM
            GOTO      EROWD999 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,WARDCODE           * Ward filter
          IF        !@EQUAL
            MATCH     WARDCODE,AWARD
            GOTO      EROWD999 IF NOT EQUAL
          ENDIF
.
          MOVE      "023",ATRTYPE
          CALL      GPTATR00
          IF        NOTFOUND=1
            CALL      CLPATATR
          ENDIF
.
EROWD020  COMPARE   TWO,DEFTVIEW
          GOTO      EROWD100 IF NOT EQUAL
.
          MATCH     SP70,FILTEXPD
          GOTO      EROWD080 IF EQUAL
.
          IF        NOTFOUND=1
            GOTO      EROWD999
          ENDIF
.
          MATCH     FILTEXPD,PTARCOD2
          GOTO      EROWD999 IF NOT EQUAL 
.
EROWD080  PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EROWD100
.
          MATCH     SP70,WCLASS
          GOTO      EROWD100 IF EQUAL
.
          MOVE      "CG",CATEGORY
          MOVE      WCLASS,CODE
          CALL      GETCOD00
          IF        OVRCD=1
            GOTO      EROWD100
          ENDIF
.
          IF        FILTEXDY = 1                    
            MATCH     "D",PTCDUDF3                * Exclude Day Ward 
            GOTO      EROWD999 IF EQUAL
          ENDIF
.
EROWD100  ADD       ONE,DISNUMB
          MOVE      SP70,DIM5
          MOVE      ZERO,FORM5
          MOVE      DISNUMB,FORM5
          MOVE      FORM5,DIM5
          REP       " 0",DIM5
.
          MOVE      "U2",CATEGORY
          MOVE      AUSR2,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPUSR2
.
          MOVE      "vi",CATEGORY
          MOVE      PMWODPST,CODE
          CALL      GETCOD00
          MOVE      TDESC,DISPPREP
.
          MOVE      SP70,VISPHONE
          CLEAR     VISPHONE
.
          MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE ANSV,DIM1
          ENDIF
          APPEND    LBRACKT,VISPHONE
          APPEND    DIM1,VISPHONE
          APPEND    COMMA,VISPHONE
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE ANSP,DIM1
          ENDIF
          APPEND    DIM1,VISPHONE
          APPEND    RBRACKT,VISPHONE
          RESET     VISPHONE
.
          MOVE      ZERO,MEDDEXST
          CALL      CLMRTMAS
          PACK      KEY20,URNUMBER,SP70 
          CALL      RSMRMAS1
EROWD110  CALL      RKMRMAS1
          BRANCH    OVRCD,EROWD150
.
          MATCH     MRMAURNO,URNUMBER
          GOTO      EROWD150 IF NOT EQUAL
.
          MOVE      ONE,MEDDEXST
.
EROWD150  CALL      EXPDSC00
.
          CLEAR     CONLINK                 * Link for Patient Condition
          APPEND    "javascript:UpdateCondition('",CONLINK
          APPEND    URNUMBER,CONLINK
          APPEND    "','",CONLINK
          APPEND    ADMISSNO,CONLINK
          APPEND    "','",CONLINK
          APPEND    "')",CONLINK
          RESET     CONLINK
.
          UNPACK    ADMISSNO,KEY2,KEY6
          MOVE      ADMISSNO,KEY8
          CALL      RDDSCH1
          IF        OVRCD=1
            CALL      CLPATDSC
          ENDIF
.
          MOVE      ADOCTA,DOCTCODE
          REP       " +",DOCTCODE
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      ADMISDAT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,COLRFLAG
          MATCH     SP70,PMWOEDAT
          IF        @EQUAL
            PACK      PMWOEDAT,HYPHEN,SP70
            PACK      PMWOEDTM,SP70
            GOTO      EROWD200
          ENDIF
.
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MATCH     CURRDATE,PMWOEDAT
          IF        @LESS
            MOVE      "PastDischDate",COLRFLAG          * set bgcolor to past
          ENDIF
.
EROWD200  CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
. 
          PACK      KEY6,AWARD,ABED
          CALL      FWBD0000
.
          MOVE      SP70,KEY15
          MATCH     SP70,AFUNDH
          IF        !@EQUAL
            PACK      KEY15,AFUNDH,SLASH,AFNDTB,SP70
          ENDIF
.
          REP       "+ ",ADMISSNO
          CALL      GPAY0000              * Get any payment received
          MOVE      ADMISSNO,KEY8
          CALL      RDPTELG1
          IF        OVRCD=1
            MOVE      ZERO,PTELTOOP         * Total OOPS
          ENDIF
          REP       " +",ADMISSNO
.
          WRITE     HTMLFILE;"t.addRow(#"",FORMATNM,"#",":         * 0
                             "#"",PSEX,"#",":                      * 1
                             "#"";

          CALL      WRTAGE00                                       * 2
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2                                  
          WRITE     HTMLFILE;"#",":
                             "#"",ADIAG1,ADIAG2,"#",":             * 3  
                             "#"",DOCFNAME,"#",":                  * 4
                             "#"",ADATE,"#",":                     * 5
                             "#"",DDATE,"#",":                     * 6
                             "#"",DESTDESC,"#",":                  * 7
                             "#"",PATLINK,"#",":                   * 8
                             "#"",PMWOEDAT,PMWOEDTM,"#",":         * 9
                             "#"",PURNO,"#",":                     * 10
                             "#"",WBEDTEXT,"#",":                  * 11
                             "#"",CONLINK,"#",":                   * 12
                           "#"",CONDESC,DISPDATE,SP1,LPCONDD,SP1,VISPHONE,"#",":
                           "#"",IMGSRC,"#",":                      * 14 
                           "#"",FOLDERSF,"#",":                    * 15
                           "#"",COLRFLAG,"#",":                    * 16
                           "#"",DISPPREP,"#",":          * 17
                           "#"",DISPUSR2,"#",":          * 18
                           "#"",ACLAIM,"#",":            * 19
                           "#"",KEY15,"#",":             * 20
                           "#"",PTELTOOP,"#",":          * 21
                           "#"",FORM12P2,"#",";          * 22
.
          MOVE      "prt",KEY3
          PACK      KEY8,KEY3,DIM5
          WRITE     HTMLFILE;"#"<input type=checkbox name=prt",DIM5:
                      " value='",PMWOADMN,"' onclick=NotPrintAll();>#",";
.
          UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MATCH     "1",PTARCOD1
          IF        @EQUAL
            MATCH     CURRDATE,PMWOEDAT
            IF        @EQUAL
              CLEAR     DIM100
              APPEND    "<b style='color:Green'>",DIM100
              APPEND    DISPDATE,DIM100
              APPEND    " at ",DIM100
              APPEND    PMWOEDTM,DIM100
              APPEND    "</b>",DIM100
              RESET     DIM100
              WRITE     HTMLFILE;"#"",DIM100,"#",";                   * 24
            ELSE
              WRITE     HTMLFILE;"#"",DISPDATE," at ",PMWOEDTM,"#","; * 24
            ENDIF
          ELSE
            WRITE     HTMLFILE;"#"",DISPDATE," at ",PMWOEDTM,"#",";   * 24
          ENDIF
.
EROWD600  WRITE     HTMLFILE;"#"",EXPDSTDS,"#",";                  * 25
.
          WRITE     HTMLFILE;"#"<input type=button class=button":  * 26
                    " name=bt",DIM5:
                    " value='Update' onclick=ShowUpdateCatVI('":
                    URNUMBER,"','":
                    ADMISSNO,"')><br><br>",DISPPREP,"#","
.
          CALL      CLIDOC00 
.
EROWD700  MOVE      "1",DOCEXIST
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",DOCEXIST,"#",":                * 27
                                "#"",LINKDOC,"#",":                * 28
                                "#"#");"                           * 29
          ELSE
            WRITE     HTMLFILE;"#"","0","#",":                     * 27
                               "#"#",":                            * 28
                               "#"#");"                            * 29
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          REP       "+ ",DOCTCODE
          GOTO      EROWD999
.
EROWD999  RETURN
.
.---------------------------------------------------------------------------
. Get expected discharge description, tentative and confirmed count
.---------------------------------------------------------------------------
EXPDSC00  PACK      SP70,SP70,SP70,SP70,EXPDSTDS
          CLEAR     EXPDSTDS
          APPEND    " ",EXPDSTDS
.
          MOVE      "023",ATRTYPE
          CALL      GPTATR00
          IF        NOTFOUND=1
            CALL      CLPATATR
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
            IF        NOTFOUND=1
              GOTO      EXPDSC80 
            ENDIF 
          ENDIF
.
          IF        NOTFOUND=1
            GOTO      EXPDSC60
          ENDIF
.
          MATCH     SP70,PMWOEDAT
          GOTO      EXPDSC50 IF EQUAL
.
          MATCH     "1",PTARCOD1
          IF        @EQUAL
            MATCH     PMWOEDAT,CURRDATE
            IF        @EQUAL
              ADD       ONE,CONFMCNT             * Confirmed count
            ENDIF
          ELSE
            MATCH     CURRDATE,PMWOEDAT
            IF        @EQUAL | @LESS
              ADD       ONE,TENTACNT             * Tentative count
            ENDIF
          ENDIF
.
. Get expected discharge description 
.
EXPDSC50  MATCH     SP70,PTARCOD2
          IF        !@EQUAL & !@EOS
            PACK      KEY5,ANSZ,ANST,PTARCOD2,SP70
            CALL      RDCODE1
            IF        OVRCD=1
              MOVE      SP70,TDESC
            ENDIF
            APPEND      TDESC,EXPDSTDS  
          ENDIF
.
EXPDSC60  MATCH     SP70,PMWODDES
          GOTO      EXPDSC80 IF EQUAL
.
          PACK      KEY5,PMWODDES,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            MOVE      PMWODDES,PTVADESC
          ENDIF
.
          MATCH     "2",PTARCOD3                  * Trans status - Accepted
          IF        @EQUAL
            APPEND    "<br><b style='color:Green'>",EXPDSTDS
            APPEND    PTVADESC,EXPDSTDS
            APPEND    "</b>",EXPDSTDS
          ELSE
            APPEND    "<br>",EXPDSTDS
            APPEND    PTVADESC,EXPDSTDS
          ENDIF
.
EXPDSC80  RESET     EXPDSTDS
          STRIP     EXPDSTDS
.
EXPDSC99  RETURN 
.
.---------------------------------------------------------------------------
. Get clinical document details
.---------------------------------------------------------------------------
CLIDOC00  MOVE      "0",DOCEXIST
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
          CLEAR     LINKDOC
          APPEND    "javascript:openDocument('",LINKDOC
          APPEND    URNUMBER,LINKDOC
          APPEND    "','",LINKDOC
          MOVE      ADMISSNO,DIM8
          MATCH     "00000000",DIM8
          IF        @EQUAL
            MOVE      SP70,DIM8
          ENDIF
          APPEND    DIM8,LINKDOC
          APPEND    "');",LINKDOC
          RESET     LINKDOC
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          OPEN      OBSPCOA1,"obspcoaf"
          OPEN      OBSPCOA2,"obspcoaf"
          PACK      ADMISSNO,ADMISSNO,SP70
          MATCH     SP70,ADMISSNO
          GOTO      CLIDOC40 IF NOT EQUAL
.
.         Clinical documents not associated with a visit
.
          MOVE      ADMISSNO,DIM8
          REP       " 0",DIM8
          PACK      KEY20,URNUMBER,DIM8,SP70
          CALL      RSOBPC1
CLIDOC30  CALL      RKOBPC1
          BRANCH    OVRCD,CLIDOC90
.
          MATCH     URNUMBER,OBPCURNO
          GOTO      CLIDOC90 IF NOT EQUAL
          MATCH     DIM8,OBPCCVIS
          GOTO      CLIDOC90 IF NOT EQUAL
.
          MOVE      CATwi,CATEGORY           * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
          MATCH     "C",TCINDC3              * Ind3 not equal to "C" so exclude
          GOTO      CLIDOC30 IF NOT EQUAL
.
          GOTO      CLIDOC50
.
.         Clinical documents associated with a particular visit
.
CLIDOC40  PACK      KEY28,ADMISSNO,SP70
          CALL      RSOBPC2
CLIDOC42  CALL      RKOBPC2
          BRANCH    OVRCD,CLIDOC90
.
          MATCH     ADMISSNO,OBPCCVIS        * Same visit number
          GOTO      CLIDOC90 IF NOT EQUAL
.
          MOVE      CATwi,CATEGORY           * Get description
          MOVE      OBPCCTYP,CODE
          CALL      GETCOD00
          MATCH     "C",TCINDC3              * Ind3 not equal to "C" so exclude
          GOTO      CLIDOC42 IF NOT EQUAL
.
CLIDOC50  MOVE      "1",DOCEXIST
.
CLIDOC90  CLOSE     OBSPCOA1
          CLOSE     OBSPCOA2 
.
CLIDOC99  RETURN
+
.----------------------------------------------------------------------
.         Get payment recieved
.----------------------------------------------------------------------
GPAY0000  MOVE      ZERO,FORM12P2
          PACK      KEY25,ADMISSNO,SP70
          CALL      RSRCDTE6
GPAY1000  CALL      RKRCDTE6
          BRANCH    OVRCD,GPAY9999
.
          MATCH     ADMISSNO,RCDTVIST
          GOTO      GPAY9999 IF NOT EQUAL
.
          PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,GPAY2000
.
          MATCH     "1",RCBNSTAT
          GOTO      GPAY1000 IF EQUAL            * Already cancelled
.
GPAY2000  ADD       RCDTAMNT,FORM12P2
          GOTO      GPAY1000
.
GPAY9999  RETURN
+
.------------------------------------------------------------------------------
. Schedule Group Label Printing
.------------------------------------------------------------------------------
PRTGPL00  MATCH     SP70,UPDATETY
          GOTO      PRTGPL70 IF EQUAL
.
          MATCH     "1",UPDATETY
          GOTO      PRTGPL20 IF EQUAL
.
          GOTO      PRTGPL90
.
.         ************ Schedule Print Labels **********
.
PRTGPL20  CALL      SGPL0000                * Schedule group label printing
          MOVE      "Printing Complete",WEBTITLE
          CALL      PREDIR00
          GOTO      PRTGPL99
.
.         ************ DISPLAY FORMACTION **********
.
PRTGPL70  CLEAR     WEBTITLE
          MOVE      "Group Label Printing",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,PRTGPL99
          CALL      WEBBOD00   * Process Web Body
          CALL      WEBEND00   * Process End of HTML File
          MOVE      ONE,EXIT
          GOTO      PRTGPL99
.
PRTGPL90  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      PRTGPL99
.
PRTGPL99  RETURN
+
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PREDIR00  CALL      OPENHTML
          BRANCH    EXIT,PREDIR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");":
                             " location.href=#"",REDIRECT,"#";":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PREDIR99
.
PREDIR90  DISPLAY   "*** Fifo Not Found ***"
.
PREDIR99  RETURN
.------------------------------------------------------------------------------
. Schedule Group Label Printing
.------------------------------------------------------------------------------
SGPL0000  MOVE      ZERO,PTCOUNT
          MOVE      ZERO,COUNT
.
SGPL0100  ADD       ONE,PTCOUNT
          ADD       ONE,COUNT
          IF        PTCOUNT>PTKEYCNT
            GOTO       SGPL9999
          ENDIF
.
          MATCH     SP70,INPLABAR[PTCOUNT]
          GOTO      SGPL0100 IF EQUAL
.
          CALL      PRNT0000
.
          GOTO      SGPL0100
.
SGPL9999  RETURN
+
.*******************************************************************************
.                        Print Request Processing
.*******************************************************************************
PRNT0000  CALL      CLRPRT00
          PACK      KEY8,INPLABAR[PTCOUNT],SP70
          CALL      RDMISS1
          IF        OVRCD=1
            MOVE      "Invalid admission ",WEBTITLE
            GOTO      PRNT9000
          ENDIF
          PACK      KEY8,AURNO,SP70
          CALL      RDMAST1
          IF        OVRCD=1
            MOVE      "Invalid patient ",WEBTITLE
            GOTO      PRNT9000
          ENDIF
.
          MOVE      PURNO,URNUMBER
          MOVE      AADMNO,ADMISSNO
          MOVE      SP70,SUBSYSKY
          MOVE      SP70,STATNCOD
          MOVE      SP70,FREETXT1
          MOVE      SP70,FREETXT2
          MOVE      SP70,FREETXT3
          MOVE      SP70,FREETXT4
          MOVE      SP70,FREETXT5
          MOVE      SP70,FREETXT6
          MOVE      SP70,FREETXT7
.
          MATCH     "1",LABPRT01
          GOTO      PRNT0010 IF NOT EQUAL
          MOVE      LABPSL01,SCHDPRNT
          MOVE      LABPNO01,SCHDCOPY
          PACK      LABELTYP,LABELADD,ZERO,ONE,SP70
.
          MOVE      LABELADD,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRNT0010  MATCH     "1",LABPRT02
          GOTO      PRNT0020 IF NOT EQUAL
          MOVE      LABPSL02,SCHDPRNT
          MOVE      LABPNO02,SCHDCOPY
          PACK      LABELTYP,LABELPMI,ZERO,ONE,SP70
.
          MOVE      LABELPMI,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRNT0020  MATCH     "1",LABPRT03
          GOTO      PRNT0030 IF NOT EQUAL
          MOVE      LABPSL03,SCHDPRNT
          MOVE      LABPNO03,SCHDCOPY
          PACK      LABELTYP,LABELINP,ZERO,ONE,SP70
.
          MOVE      LABELINP,SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00
.
          CALL      ADDPRN00
.
PRNT0030  MATCH     "1",FRMPRT01
          GOTO      PRNT0040 IF NOT EQUAL
          MOVE      FRMPSL01,SCHDPRNT
          MOVE      FRMPNO01,SCHDCOPY
          MOVE      FRMCOD01,STATNCOD
          PACK      LABELTYP,SP70
.
.         MOVE      "PATWEB70",SETDFPRG
.         MOVE      "1",SETDFRPT
.         CALL      SETDEF00           * set default printer
.
          CALL      ADDPRN00
.
PRNT0040  MATCH     "1",FRMPRT02
          GOTO      PRNT0050 IF NOT EQUAL
          MOVE      FRMPSL02,SCHDPRNT
          MOVE      FRMPNO02,SCHDCOPY
          MOVE      FRMCOD02,STATNCOD
          PACK      LABELTYP,SP70
.
.         MOVE      "PATWEB70",SETDFPRG
.         MOVE      "1",SETDFRPT
.         CALL      SETDEF00           * set default printer
.
          CALL      ADDPRN00
.
PRNT0050  MATCH     "1",FRMPRT03
          GOTO      PRNT0700 IF NOT EQUAL
          MOVE      FRMPSL03,SCHDPRNT
          MOVE      FRMPNO03,SCHDCOPY
          MOVE      FRMCOD03,STATNCOD
          PACK      LABELTYP,SP70
.
.         MOVE      "PATWEB70",SETDFPRG
.         MOVE      "1",SETDFRPT
.         CALL      SETDEF00           * set default printer
.
          CALL      ADDPRN00
.
PRNT0700  MOVE      ZERO,EXIT
          GOTO      PRNT9999
.
PRNT9000  
....      CALL      WEBERR00              * removed for CAR 290467
....      MOVE      ONE,EXIT
          GOTO      PRNT9999
.
PRNT9999  RETURN
+
.*******************************************************************************
.                 Clear Variables for Printing Control Table
.*******************************************************************************
CLRPRT00  MOVE      Z70,IBLPSCHE
          MOVE      Z70,IBLPURNO
          MOVE      Z70,IBLPVISN
          MOVE      Z70,IBLPSKEY
          MOVE      Z70,IBLPPRNT
          MOVE      ZERO,IBLPCOPY
          MOVE      Z70,IBLPSTAT
          MOVE      Z70,IBLPLAPR
          MOVE      Z70,IBLPLASC
          MOVE      Z70,IBLPFRE1
          MOVE      Z70,IBLPFRE2
          MOVE      Z70,IBLPFRE3
          MOVE      Z70,IBLPFRE4
          MOVE      Z70,IBLPFRE5
          MOVE      Z70,IBLPFRE6
          MOVE      Z70,IBLPFRE7
          MOVE      Z70,IBLPRUID
          MOVE      Z70,IBLPRDAT
          MOVE      Z70,IBLPRTIM
.
CLRPRT99  RETURN
.
.------------------------------------------------------------
. Set Default Printer
.------------------------------------------------------------
SETDEF00  MOVE      PRGID,SAVPRGID
          MOVE      REPORTNO,SAVREPTN
.
          MOVE      SCHDPRNT,SELPRINT
          MOVE      SETDFPRG,PRGID
          MOVE      SETDFRPT,REPORTNO
          CALL      UPDFPT00
.
          MOVE      SAVPRGID,PRGID
          MOVE      SAVREPTN,REPORTNO
          RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
BDMN0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      BMAR0000                     * Set values in time array 
          CALL      BDMH0000                     * Output headings
.
. Ward/Bed Details
.
BDMN1000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
BDMN2000  CALL      RDKWARD1
          BRANCH    OVRCD,BDMN9999
          MATCH     WARDCODE,WWARD
          GOTO      BDMN9999 IF NOT EQUAL
.
          BRANCH    WACTIVE,BDMN2000       * Do not display Inactive Beds
.
          IF        STVCVIEW=1
            WRITE   HTMLFILE;"<tr>";
          ELSE
            WRITE   HTMLFILE;"<tr><td nowrap class=HeadingCell>",WBDESC,"</td>";
          ENDIF
          CALL      BDMR0000
          WRITE     HTMLFILE;"</tr>";
.
          GOTO      BDMN2000
.
BDMN9999  RETURN
.
.------------------------------------------------------------
. Displays Day oncology Outliers
.------------------------------------------------------------
DOUT0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>Extn.</td>":
                             "<td class=HeadingCell>Ward</td>":
                             "<td class=HeadingCell>Adm Date</td>":
                             "<td class=HeadingCell>Attending Doctor</td>":
.                            "<td class=HeadingCell>Health Fund</td>":
                             "<td class=HeadingCell>Regime Code 1</td>":
                             "<td class=HeadingCell>Regime Code 2</td>":
                             "<td class=HeadingCell>Regime Code 3</td>":
                             "</tr>";
.
          MATCH     SP70,OUTLTYPE
          GOTO      DOUT0500 IF NOT EQUAL
.
          PACK      KEY5,ANSB,ANSK,SP70
          CALL      RDSCODE1
DOUT0200  CALL      RDKCODE1
          BRANCH    OVRCD,DOUT9999
.
          MATCH     "BK",TCODE
          GOTO      DOUT9999 IF NOT EQUAL
.
          MATCH     ANSO,TCINDC1
          GOTO      DOUT0200 IF NOT EQUAL
.
          PACK      OUTLTYPE,ACODE,SP70
.
DOUT0500  PACK      KEY16,LASTDATE,SP70
          CALL      RSBKREC4
DOUT1000  CALL      RKBKREC4
          BRANCH    OVRCD,DOUT0200
.
          MATCH     BKREEDAT,LASTDATE       * mathing date?
          GOTO      DOUT0200 IF NOT EQUAL   * no; get next booking
.
          MATCH     BKRETYPE,OUTLTYPE       * same booking type?
          GOTO      DOUT1000 IF NOT EQUAL   * no; get next booking
.
. ***** STV use this tag to show bookings IN this ward on oncology view *****
.
. ***** Standard uses this as an outlier list - and shows patients NOT  *****
. ***** in this ward  *****
          IF        STVCVIEW=1
            MATCH     WARDCODE,BKREWARD       * NOT the same ward?
            GOTO      DOUT1000 IF NOT EQUAL   * no; get next booking
.
            MATCH    SP70,BKREEBED
            GOTO     DOUT1000 IF NOT EQUAL
          ELSE
            MATCH     WARDCODE,BKREWARD       * IS the same ward?
            GOTO      DOUT1000 IF EQUAL      * no; get next booking
          ENDIF
.
          COMPARE   TWO,BKRESTAT            * cancelled?
          GOTO      DOUT1000 IF EQUAL       * yes; get next booking
.
          COMPARE   FOUR,BKRESTAT           * discharged?
          GOTO      DOUT1000 IF EQUAL       * yes; get next booking
.
          PACK      KEY8,BKREURNO
          CALL      RDMAST1
          CALL      RDPMPX21
          BRANCH    OVRCD,DOUT1000
          PACK      URNUMBER,BKREURNO,SP70
          PACK      ADMISSNO,BKREBOOK,SP70
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1
          IF        OVRCD<>1
            IF        ASTAT=1
              PACK      BKREWARD,PTMIXWRD
              PACK      BKREEBED,PTMIEBED
            ELSE
              PACK      BKREWARD,AWARD
              PACK      BKREEBED,ABED
            ENDIF
            PACK      BKREEDAT,ADATE
            PACK      BKREADOC,ADOCTA
            PACK      PFUNDH,AFUNDH
            PACK      PFNDTB,AFNDTB
          ENDIF
.
          UNPACK    BKREEDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,WEXTN
          PACK      KEY6,BKREWARD,BKREEBED,SP70
          CALL      RDWARD1
.
          PACK      KEY6,BKREADOC
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE          * I CAR 13038
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000                * end I CAR 13038
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td nowrap>";
          IF        STVCVIEW=1
            WRITE     HTMLFILE;"<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                             " onclick='javascript:updateBed(#"",URNUMBER:
                             "#",#"",ADMISSNO,"#");'>";
          ENDIF
          WRITE     HTMLFILE;"<img src=../images/PatientFolder",KEY3,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td>",WEXTN,"&nbsp;</td>";
          IF        BKRESTAT<2
            WRITE     HTMLFILE;"<td><font color=Red>",BKREWARD,SLASH:
                               BKREEBED,"</td>":
                               "<td><font color=Red>",DISPDATE,"</td>";
          ELSE
            WRITE     HTMLFILE;"<td>",BKREWARD,SLASH:
                               BKREEBED,"</td>":
                               "<td>",DISPDATE,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",DOCFNAME,"&nbsp;</td>";
.                             "<td>",PFUNDH,SLASH,PFNDTB,"&nbsp;</td>";
.
          PACK      KEY10,ADMISSNO,SP1,ONE,DIM127
          CALL      RDPTRGM1
          IF        OVRCD<>1
            WRITE     HTMLFILE;"<td>",PTRGREGM,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          PACK      KEY10,ADMISSNO,SP1,TWO,DIM127
          CALL      RDPTRGM1
          IF        OVRCD<>1
            WRITE     HTMLFILE;"<td>",PTRGREGM,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          PACK      KEY10,ADMISSNO,SP1,THREE,DIM127
          CALL      RDPTRGM1
          IF        OVRCD<>1
            WRITE     HTMLFILE;"<td>",PTRGREGM,"&nbsp;</td>";
          ELSE
            WRITE     HTMLFILE;"<td>&nbsp;</td>";
          ENDIF
.
          GOTO      DOUT1000
.
DOUT9999  RETURN
+
.------------------------------------------------------------
. Displays Bed Management Ward View Heading
.------------------------------------------------------------
BDMH0000  WRITE     HTMLFILE;"<tr>";
          MOVE      ZERO,FORM3
.
          IF        STVCVIEW<>1
            WRITE     HTMLFILE;"<td class=HeadingCell>Time</td>";
          ENDIF
.
.         MOVE      TEN7,TMARRCNT
          MATCH     SP70,PTCNDOST
          IF        @EQUAL|@EOS
            MOVE      ONE,TMARRCNT
          ELSE
            MATCH     "00",PTCNDOST
            IF        @EQUAL
              MOVE      ONE,TMARRCNT
            ELSE
              SQUEEZE   PTCNDOST
              MOVE      PTCNDOST,TMARRCNT
            ENDIF
          ENDIF  
.
BDMH1000  UNPACK    TIMEARRY[TMARRCNT],DIM5
          WRITE   HTMLFILE;"<td class=HeadingCell>",DIM5,"</td>";
.
          IF        STVCVIEW=1
            IF        TMARRCNT=25
              WRITE     HTMLFILE;"<td class=HeadingCell>&nbsp;</td>";
            ENDIF
          ENDIF
            
 
.         COMPARE   THREE6,TMARRCNT
          MATCH     SP70,PTCNDOET
          IF        @EQUAL|@EOS
            COMPARE   FOUR8,TMARRCNT
          ELSE
            MATCH     "00",PTCNDOET
            IF        @EQUAL
              COMPARE   FOUR8,TMARRCNT
            ELSE
              SQUEEZE   PTCNDOET
              MOVE      PTCNDOET,FORM3
              COMPARE   FORM3,TMARRCNT
            ENDIF
          ENDIF
          GOTO      BDMH5000 IF EQUAL
.
          ADD       ONE,TMARRCNT
          GOTO      BDMH1000
.
BDMH5000  WRITE     HTMLFILE;"</tr>";
.
BDMH9999  RETURN
.
.------------------------------------------------------------
. Displays Bed Management Ward View Rows
.------------------------------------------------------------
BDMR0000  CALL      CLBM0000                   * Clear Bed Management Array
          MOVE      ZERO,FORM3
.
          MOVE      ZERO,OVERRIND
          CALL      BDAR0000                   * Populate Bed Management Array
.
          MOVE      ONE,OVERRIND
          CALL      BDAR0000                   * Populate Bed Management Array
.
          MOVE      TWO,OVERRIND
          CALL      BDAR0000                   * Populate Bed Management Array
.
.         MOVE      TEN7,TMARRCNT
          MATCH     SP70,PTCNDOST
          IF        @EQUAL|@EOS
            MOVE      ONE,TMARRCNT
          ELSE
            MATCH     "00",PTCNDOST
            IF        @EQUAL
              MOVE      ONE,TMARRCNT
            ELSE
              SQUEEZE   PTCNDOST
              MOVE      PTCNDOST,TMARRCNT
            ENDIF
          ENDIF
.
BDMR1000  CALL      CLBD0000                      * Find out if bed is closed
          CALL      BMRW0000
.
          IF        STVCVIEW=1
            COMPARE   TWENTY5,TMARRCNT
            IF        @EQUAL
            WRITE   HTMLFILE;"<td nowrap class=HeadingCell>",WBDESC,"</td>";
            ENDIF
          ENDIF
.         COMPARE   THREE6,TMARRCNT
          MATCH     SP70,PTCNDOET
          IF        @EQUAL|@EOS
            COMPARE   FOUR8,TMARRCNT
          ELSE      
            MATCH     "00",PTCNDOET
            IF        @EQUAL
              COMPARE   FOUR8,TMARRCNT
            ELSE
              SQUEEZE   PTCNDOET
              MOVE      PTCNDOET,FORM3
              COMPARE   FORM3,TMARRCNT
            ENDIF
          ENDIF
          GOTO      BDMR9999 IF EQUAL
.
          ADD       ONE,TMARRCNT
          GOTO      BDMR1000                     
.
BDMR9999  RETURN
.
.------------------------------------------------------------
. Set time array fields for appointment time classes
.------------------------------------------------------------
BMAR0000  MOVE      "00:00-00:29",TIMEARRY[1]
          MOVE      "00:30-00:59",TIMEARRY[2]
          MOVE      "01:00-01:59",TIMEARRY[3]
          MOVE      "01:30-01:59",TIMEARRY[4]
          MOVE      "02:00-02:29",TIMEARRY[5]
          MOVE      "02:30-02:59",TIMEARRY[6]
          MOVE      "03:00-03:29",TIMEARRY[7]
          MOVE      "03:30-03:59",TIMEARRY[8]
          MOVE      "04:00-04:29",TIMEARRY[9]
          MOVE      "04:30-04:59",TIMEARRY[10]
          MOVE      "05:00-05:29",TIMEARRY[11]
          MOVE      "05:30-05:59",TIMEARRY[12]
          MOVE      "06:00-06:29",TIMEARRY[13]
          MOVE      "06:30-06:59",TIMEARRY[14]
          MOVE      "07:00-07:29",TIMEARRY[15]
          MOVE      "07:30-07:59",TIMEARRY[16]
          MOVE      "08:00-08:29",TIMEARRY[17]
          MOVE      "08:30-08:59",TIMEARRY[18]
          MOVE      "09:00-09:29",TIMEARRY[19]
          MOVE      "09:30-09:59",TIMEARRY[20]
          MOVE      "10:00-10:29",TIMEARRY[21]
          MOVE      "10:30-10:59",TIMEARRY[22]
          MOVE      "11:00-11:29",TIMEARRY[23]
          MOVE      "11:30-11:59",TIMEARRY[24]
          MOVE      "12:00-12:29",TIMEARRY[25]
          MOVE      "12:30-12:59",TIMEARRY[26]
          MOVE      "13:00-13:29",TIMEARRY[27]
          MOVE      "13:30-13:59",TIMEARRY[28]
          MOVE      "14:00-14:29",TIMEARRY[29]
          MOVE      "14:30-14:59",TIMEARRY[30]
          MOVE      "15:00-15:29",TIMEARRY[31]
          MOVE      "15:30-15:59",TIMEARRY[32]
          MOVE      "16:00-16:29",TIMEARRY[33]
          MOVE      "16:30-16:59",TIMEARRY[34]
          MOVE      "17:00-17:29",TIMEARRY[35]
          MOVE      "17:30-17:59",TIMEARRY[36]
          MOVE      "18:00-18:29",TIMEARRY[37]
          MOVE      "18:30-18:59",TIMEARRY[38]
          MOVE      "19:00-19:29",TIMEARRY[39]
          MOVE      "19:30-19:59",TIMEARRY[40]
          MOVE      "20:00-20:29",TIMEARRY[41]
          MOVE      "20:30-20:59",TIMEARRY[42]
          MOVE      "21:00-21:29",TIMEARRY[43]
          MOVE      "21:30-21:59",TIMEARRY[44]
          MOVE      "22:00-22:29",TIMEARRY[45]
          MOVE      "22:30-22:59",TIMEARRY[46]
          MOVE      "23:00-23:29",TIMEARRY[47]
          MOVE      "23:30-23:59",TIMEARRY[48]
.
BMAR9999  RETURN
.
.------------------------------------------------------------
. Clear the Bed Management Array
.------------------------------------------------------------
CLBM0000  MOVE      ONE,TMARRCNT
.
CLBM1000  MOVE      SP70,TMBDARRY[TMARRCNT]
.
          COMPARE   FOUR8,TMARRCNT
          GOTO      CLBM9999 IF EQUAL
.
          ADD       ONE,TMARRCNT
.
          GOTO      CLBM1000
.
CLBM9999  RETURN
.
.------------------------------------------------------------
. Populate Bed Management Array
.------------------------------------------------------------
BDAR0000  PACK      KEY30,WWARD,WBED,LASTDATE,SP70
          CALL      RSPTBMD1
BDAR1000  CALL      RKPTBMD1
          BRANCH    OVRCD,BDAR9999
.
          MATCH     WWARD,PTBDWARD
          GOTO      BDAR9999 IF NOT EQUAL
.
          MATCH     WBED,PTBDWBED
          GOTO      BDAR9999 IF NOT EQUAL
.
          MATCH     PTBDDATE,LASTDATE
          GOTO      BDAR9999 IF NOT EQUAL
.
.         MATCH     "4",PTBDSTAT
.         GOTO      BDAR1000 IF EQUAL
.
          MOVE      SP70,TEMPURNO
          MATCH     "1",PTBDSTAT
          IF        @EQUAL
            PACK      KEY8,PTBDADMN,SP70
            CALL      RDBKREC1
            IF        OVRCD=0
              COMPARE   TWO,BKRESTAT
              GOTO      BDAR1000 IF EQUAL
              MOVE      BKREURNO,TEMPURNO
            ENDIF
          ELSE
            PACK      KEY8,PTBDADMN,SP70
            CALL      RDMISS1
            IF        OVRCD=0
              MATCH     "5",DASTAT
              GOTO      BDAR1000 IF EQUAL
              MOVE      AURNO,TEMPURNO
            ENDIF
          ENDIF 
.
          CALL      GETRGM00
.
          IF        OVERRIND=1
            MATCH     "0",PTBDOVER
            GOTO      BDAR1000 IF NOT EQUAL
          ENDIF
.
          IF        OVERRIND=2
            PACK      KEY10,PTBDADMN,SP70
            CALL      RSPTRGM1
BDAR2000    CALL      RKPTRGM1 
            BRANCH    OVRCD,BDAR1000
.
            MATCH     PTBDADMN,PTRGADMN
            GOTO      BDAR1000 IF NOT EQUAL
.
            MATCH     SP70,PTRGREGM
            GOTO      BDAR2000 IF EQUAL
            GOTO      BDAR2000 IF EOS
.
            PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
            CALL      RDPMREG1
            BRANCH    OVRCD,BDAR2000
.
            MATCH     SP70,PMRESNCD
            GOTO      BDAR2000 IF EQUAL
            GOTO      BDAR2000 IF EOS
.
            PACK      KEY5,CODS,CODN,PMRESNCD,SP70
            CALL      RDCODE1
            BRANCH    OVRCD,BDAR2000            
.
            MATCH     "M",TCINDC1
            IF        @EQUAL
              MOVE      "5",TEMPSTAT
              GOTO      BDAR3000
            ENDIF
.
            MATCH     "B",TCINDC1
            IF        @EQUAL
              MOVE      "6",TEMPSTAT
              GOTO      BDAR3000
            ENDIF
.
            MATCH     "A",TCINDC1
            IF        @EQUAL
              MOVE      "7",TEMPSTAT
              GOTO      BDAR3000
            ENDIF
.
          ENDIF
.
          MOVE      PTBDSTAT,TEMPSTAT
.
BDAR3000  MATCH     "00:00",PTBDADTM
          IF        @EQUAL
            GOTO      BDAR1000
          ELSE
            MATCH     SP70,PTBDLOSM
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,FORM5
              MOVE      PTBDLOSM,FORM5
.
              IF        FORM5=0
                GOTO      BDAR1000
              ENDIF
            ELSE
              GOTO      BDAR1000
            ENDIF
          ENDIF
.
          CALL      GEND0000
.
          CALL      BARY0000
.
          GOTO      BDAR1000
.
BDAR9999  RETURN 
.
.------------------------------------------------------------
. Populate Bed Management Array Detail
.------------------------------------------------------------
BARY0000  MOVE      ONE,TMARRCNT
          MOVE      ZERO,FIRSTCEL
.
BARY1000  UNPACK    TIMEARRY[TMARRCNT],DIM5,DIM1,DIM5A
.
          MATCH     DIM5,PTBDADTM
          GOTO      BARY1100 IF LESS
.
          MATCH     PTBDADTM,DIM5A
          GOTO      BARY3000 IF LESS
.
          GOTO      BARY2000
.
BARY1100  MATCH     DIM5,EXPDSTME
          GOTO      BARY3000 IF LESS
.
BARY2000  MOVE      FIRSTCEL,DIM2
          REP       " 0",DIM2
      PACK      TMBDARRY[TMARRCNT],PTBDADMN,TEMPSTAT,DIM2,TEMPURNO,PTBDSTAT,SAVEREGM,PTBDBRQN,SP70
          ADD       ONE,FIRSTCEL
.
BARY3000  COMPARE   FOUR8,TMARRCNT
          GOTO      BARY9999 IF EQUAL
.
          ADD       ONE,TMARRCNT
          GOTO      BARY1000
.
BARY9999  RETURN
.
.------------------------------------------------------------
. Get end time
.------------------------------------------------------------
GEND0000  MATCH     SP70,PTBDLOSM
          IF        !@EQUAL & !@EOS
            MOVE      ZERO,FORM5
            MOVE      PTBDLOSM,FORM5
.
            IF        FORM5>0
              GOTO      GEND5000
            ENDIF
          ENDIF
.
          MATCH     SP70,PTBDLOSD
          IF        !@EQUAL|!@EOS
            MATCH     "  0",PTBDLOSD
            IF        !@EQUAL
              MOVE      "23:59",EXPDSTME
              GOTO      GEND9999
            ENDIF
          ENDIF
.
GEND5000  MOVE      PTBDADTM,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          CALL      CLDUR000
          MOVE      KEY5,EXPDSTME
.
GEND9999  RETURN
.
.-----------------------------------------------------------------------------
. CLDUR000 - Calculate Expected Discharge Time
.-----------------------------------------------------------------------------
.
CLDUR000  UNPACK    STRTTIME,CHOUR,ANS,CMIN * unpack the start time
          MOVE      CMIN,FORM2              * minutes as a form2
          MOVE      FORM2,FORM4A            * set up work variable
          ADD       ADJTIME,FORM4A          * the total minutes to add
.
CLDUR200  COMPARE   ZERO,FORM4A
          GOTO      CLDUR300 IF NOT LESS    * positve amount
.
          ADD       "60",FORM4A             * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
          GOTO      CLDUR200
.
CLDUR300  MOVE      FORM4A,FORM4B           * save the minutes
.
          DIV       "60",FORM4A             * the total hours to add
          MOVE      CHOUR,FORM2             * hours as a form
          ADD       FORM4A,FORM2            * add the hours
.
CLDUR400  COMPARE   "24",FORM2
          GOTO      CLDUR500 IF LESS        * below 24 hours
.
          SUB       "24",FORM2              * get back to 24 hour time
          GOTO      CLDUR400
.
CLDUR500  MOVE      FORM2,CHOUR             * set up the hours
.
          MULT      "60",FORM4A             * the total minutes added
          SUB       FORM4A,FORM4B           * the minutes to add
          MOVE      FORM4B,FORM2            * get minutes as form2
.
          COMPARE   ZERO,FORM2
          GOTO      CLDUR800 IF NOT LESS    * not negative
.
          ADD       "60",FORM2              * make it positive
          MOVE      CHOUR,OPTION
          SUB       ONE,OPTION
          MOVE      OPTION,CHOUR            * sub 1 hour off time
.
CLDUR800  MOVE      FORM2,CMIN              * the minutes
.
          PACK      KEY5,CHOUR,COLON,CMIN * the end time
          REP       " 0",KEY5
.
CLDUR999  RETURN
.
.-----------------------------------------------------------------------------
. BMRW0000 - Display Bed Management Row
.-----------------------------------------------------------------------------
BMRW0000  UNPACK  SP70,DIM8,DIM1,DIM2,TEMPURNO,CELLCOLR,DIM1B,DIM10,DIM8A
          UNPACK  TMBDARRY[TMARRCNT],DIM8,DIM1,DIM2,TEMPURNO,DIM1B,DIM10,DIM8A
.
          MOVE      "WhiteCell",CELLCOLR
.
          PACK    KEY8,TEMPURNO,SP70
          CALL    RDMAST1
          IF      OVRCD=0
            MOVE    PGNAME,DIM1A
            PACK    DIM30,DIM1A,FULLSTOP,PSNAME
            REP     "'`@ * / : \ $ % & # ",DIM30
            UNPACK  PBDATE,CCENT,CYEAR,CMON,CDAY
            PACK    AGEDATE,CCC,CYY,CMM,CDD    * Today's date
            REP       " 0",AGEDATE
            CALL    CALCAGE
            CALL    FMTA0000
          ENDIF
.
          PACK    KEY8,DIM8,SP70
          CALL    RDBKREC1
          IF      OVRCD=1
            CALL    CLBOKRC1
          ENDIF
          CALL    RDMISS1
          IF      OVRCD=1
            CALL    CLPATMIS
            PACK    ADATE,BKREEDAT
            PACK    ATIME,BKREATIM
            PACK    ACLSSFT,BKREDEPT
            PACK    ADOCTA,BKREADOC
            PACK    AFUNDH,PFUNDH
            PACK    AFNDTB,PFNDTB
          ENDIF
.
          PACK      KEY18,DIM8,SP70
          CALL      RABKDIA1
          CALL      RKBKDIA1
          IF        OVRCD<>1
            MATCH   DIM8,DBKDIBOO
            IF      @EQUAL
              MOVE    BKDIDES1,ADIAG1
            ENDIF
          ENDIF
.
          MOVE    ONE,FORM1
          MOVE    SP70,DIM40A
          CALL    GRGM0000
          MOVE    DIM40,DIM40A
.
          MOVE    TWO,FORM1
          MOVE    SP70,DIM40B
          CALL    GRGM0000
          MOVE    DIM40,DIM40B
.
          MOVE    THREE,FORM1
          MOVE    SP70,DIM40C
          CALL    GRGM0000
          MOVE    DIM40,DIM40C
.
BMRW0100  MATCH   "1",DIM1
          IF      @EQUAL
            MOVE    "ExpectedCell",CELLCOLR
          ENDIF
.
          MATCH   "2",DIM1
          IF      @EQUAL
            MOVE    "ExpectedCell",CELLCOLR
          ENDIF
.
          MATCH   "3",DIM1
          IF      @EQUAL
            MOVE    "AdmittedCell",CELLCOLR
          ENDIF
.
          MATCH   SP70,DIM8A
          IF      !@EQUAL & !@EOS
            MOVE    "BedReqCell",CELLCOLR
          ENDIF
.
          MATCH   "5",DIM1
          IF      @EQUAL
            MOVE    "BoneMarCell",CELLCOLR
          ENDIF
.
          MATCH   "6",DIM1
          IF      @EQUAL
            MOVE    "BladderCell",CELLCOLR
          ENDIF
.
          MATCH   "7",DIM1
          IF      @EQUAL
            MOVE    "AutoVenCell",CELLCOLR
          ENDIF
.
          MOVE      PURNO,URNUMBER
          REP       " +",URNUMBER
.
.------------------------------------------------------------------------------
. Patient's 00 Cell: Demographics Folder and Edit Icon
.------------------------------------------------------------------------------
          MATCH     "00",DIM2
          IF        @EQUAL
.
            CALL    FLDR0000              * set foldrnam - with icon filename
.
            WRITE   HTMLFILE;"<td nowrap class=",CELLCOLR,">":
                             "<img src=../images/",FOLDRNAM:
                             " class=ListIcon ":
                             " onmouseover='status=#"Patient Name: ",DIM30:
                             "    UR Number:",PURNO:
                             "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;"    Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"    Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;"#";show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            PACK      KEY5,ANSG,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MATCH     SP70,TDESC
              IF        @EQUAL
                MOVE      "Gender",TDESC
              ENDIF
              STRIP     TDESC
            ENDIF
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/",*+,TDESC,": ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"<br>Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#");'" :
                             " onmouseout='hide_it(); status=#" #"'":
                             " onclick='status=#"#";location.href=#"",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",DIM8:
                             "#";'>";
            BRANCH    VIEWONLY,BMRW9999
.
            WRITE     HTMLFILE;"<img src=../images/EditIcon.gif":
                             " class=ListIcon ":
                       " onmouseover='show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/",*+,TDESC,": ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;" <br>   Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#"); status=#"Patient Name: ",DIM30,"":
                             "    UR Number: ",PURNO,"":
                             "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;"     Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"    Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;"#"'" :
                             " onmouseout='hide_it();status=#" #"'";
.
            MATCH   "1",DIM1B
            IF      @EQUAL
              WRITE   HTMLFILE;" onclick='status=#"#";":
                               " SetCookie(#"BMRDCookie#",location.href);":
                               " location.href=#"oprweb01.pbl":
                               "?reportno=07":
                               "&template=001":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'>":
                               "</td>";
              GOTO    BMRW9999
            ENDIF
.
            MATCH   "2",DIM1B
            IF      @EQUAL
              WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                               "?reportno=01":
                               "&template=032":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'>":
                               "</td>";
              GOTO    BMRW9999
            ENDIF
.
            MATCH   "3",DIM1B
            IF      @EQUAL
              WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                               "?reportno=01":
                               "&template=030":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'>":
                               "</td>";
              GOTO    BMRW9999
            ENDIF
.
            WRITE   HTMLFILE;" onclick='location.href=#"patweb98.pbl":
                             "?reportno=01":
                             "&template=001":
                             "&urnumber=",URNUMBER:
                             "&admissno=",DIM8:
                             "#";'>":
                             "</td>";
            GOTO    BMRW9999
          ENDIF
.
.------------------------------------------------------------------------------
. Patient's 02 Cell: UR Number
.------------------------------------------------------------------------------
.
          MATCH     "02",DIM2
          IF        @EQUAL
            WRITE   HTMLFILE;"<td class=",CELLCOLR:
                     " onmouseover='show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;"<br> Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL  
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#"); status=#"Patient Name: ",DIM30,"":
                     "    UR Number: ",PURNO,"":
                     "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;"    Admission Date:";
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
.
            WRITE   HTMLFILE;"#"'" :
                     " onmouseout='hide_it();status=#" #"'";

           MATCH   "1",DIM1B
           IF      @EQUAL
             IF      VIEWONLY<>1
             WRITE   HTMLFILE;" onclick='status=#"#";":
                              " SetCookie(#"BMRDCookie#",location.href);":
                              " location.href=#"oprweb01.pbl":
                              "?reportno=07":
                              "&template=001":
                              "&urnumber=",URNUMBER:
                              "&admissno=",DIM8:
                              "#";'";
             GOTO    BMRW0500
             ENDIF
           ENDIF
.
           MATCH   "2",DIM1B
           IF      @EQUAL
             IF      VIEWONLY<>1
             WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                              "?reportno=01":
                              "&template=032":
                              "&urnumber=",URNUMBER:
                              "&admissno=",DIM8:
                              "#";'";
             GOTO    BMRW0500
             ENDIF
           ENDIF
.
           MATCH   "3",DIM1B
           IF      @EQUAL
             IF      VIEWONLY<>1
             WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                              "?reportno=01":
                              "&template=030":
                              "&urnumber=",URNUMBER:
                              "&admissno=",DIM8:
                              "#";'";
             GOTO    BMRW0500
             ENDIF
           ENDIF
.
           WRITE   HTMLFILE;" onclick='location.href=#"patweb98.pbl":
                            "?reportno=01":
                            "&template=001":
                            "&urnumber=",URNUMBER:
                            "&admissno=",DIM8:
                            "#";'";

BMRW0500             MATCH   "1",DIM1B
                     IF      @EQUAL
                       WRITE   HTMLFILE;"><b>",DIM10,"&nbsp;</b></td>";
                     ELSE
                       WRITE   HTMLFILE;">",DIM10,"&nbsp;</td>";
                     ENDIF
            GOTO    BMRW9999
          ENDIF
.
.------------------------------------------------------------------------------
. Patient's 01 Cell: Patient Name
.------------------------------------------------------------------------------
.
          MATCH     "01",DIM2
          IF        @EQUAL
            WRITE   HTMLFILE;"<td class=",CELLCOLR:
                       " onmouseover='show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;"  <br>  Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL  
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#"); status=#"Patient Name: ",DIM30,"":
                             "    UR Number: ",PURNO,"":
                             "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"    Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;"#"'" :
                             " onmouseout='hide_it();status=#" #"'";

             MATCH   "1",DIM1B
             IF      @EQUAL
               IF      VIEWONLY<>1
               WRITE   HTMLFILE;" onclick='status=#"#";":
                                " SetCookie(#"BMRDCookie#",location.href);":
                                " location.href=#"oprweb01.pbl":
                                "?reportno=07":
                                "&template=001":
                                "&urnumber=",URNUMBER:
                                "&admissno=",DIM8:
                                "#";'";
               GOTO    BMRW1000
               ENDIF
             ENDIF
.
             MATCH   "2",DIM1B
             IF      @EQUAL
               IF      VIEWONLY<>1
               WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                                "?reportno=01":
                                "&template=032":
                                "&urnumber=",URNUMBER:
                                "&admissno=",DIM8:
                                "#";'";
               GOTO    BMRW1000
               ENDIF
             ENDIF
.
             MATCH   "3",DIM1B
             IF      @EQUAL
               IF      VIEWONLY<>1
               WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                                "?reportno=01":
                                "&template=030":
                                "&urnumber=",URNUMBER:
                                "&admissno=",DIM8:
                                "#";'";
               GOTO    BMRW1000
               ENDIF
             ENDIF
.
             WRITE   HTMLFILE;" onclick='location.href=#"patweb98.pbl":
                              "?reportno=01":
                              "&template=001":
                              "&urnumber=",URNUMBER:
                              "&admissno=",DIM8:
                              "#";'";
.
BMRW1000    MATCH   "1",DIM1B
            IF      @EQUAL
              WRITE   HTMLFILE;"><b>",DIM30,"&nbsp;</b></td>";
            ELSE
              WRITE   HTMLFILE;">",DIM30,"&nbsp;</td>";
            ENDIF
            GOTO    BMRW9999
          ENDIF
.
.------------------------------------------------------------------------------
. Empty cells and patient's subsequent cells
.------------------------------------------------------------------------------
.
BMRW1300  MATCH     "WhiteCell",CELLCOLR
          IF        @EQUAL
            IF      CLBDINDC=1
              MOVE    "ClosedCell",CELLCOLR
              WRITE   HTMLFILE;"<td class=",CELLCOLR:
                               "><font color=white>CLOSED</font></td>";
            ELSE
               IF      VIEWONLY=1
                 WRITE   HTMLFILE;"<td class=",CELLCOLR:
                       " onmouseover='show_it(#"Bed: <b>",WBED,"</b>":
                               " <br>Time: <b>",TIMEARRY[TMARRCNT],"</b>":
                               "#")'; status=#"Patient Name: ",DIM30,"#"":
                               " onmouseout='hide_it();status=#" #"'":
                               "#";'":
                               ">&nbsp;</td>";
               ELSE               
                 WRITE   HTMLFILE;"<td class=",CELLCOLR:
                       " onmouseover='show_it(#"Bed: <b>",WBED,"</b>":
                               " <br>Time: <b>",TIMEARRY[TMARRCNT],"</b>":
                               "#")'; status=#"Patient Name: ",DIM30,"#"":
                               " onmouseout='hide_it();status=#" #"'":
                           " onclick='status=#"#";location.href=#"watweb01.pbl":
                               "?reportno=02":
                               "&template=023":
                               "&bookward=",WWARD:
                               "&bookebed=",WBED:
                               "&bookdate=",LASTDATE:
                               "&booktime=",TIMEARRY[TMARRCNT]:
                               "#";'":
                               ">&nbsp;</td>";
               ENDIF
            ENDIF
          ELSE
            WRITE   HTMLFILE;"<td class=",CELLCOLR:
                       " onmouseover='show_it(#"Patient Name: <b>",DIM30,"</b>":
                             " <br>UR Number: <b>",PURNO,"</b>":
                             " <br>Vis Number: ",DIM8;
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" <br>Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" <br>Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
            WRITE   HTMLFILE;"<br>Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"<br>Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"<br>Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"<br>Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"<br>Doctor: <b>";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"</b>";
.           WRITE    HTMLFILE;"</b><br>Health Fund: ";
.
.           MATCH     SP70,AFUNDH
.           IF        !@EQUAL
.             PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.             PACK      KEY14,AFUNDH,AFNDTB,SP70
.             CALL      RDFUND1
.             IF        OVRCD<>1
.               WRITE     HTMLFILE;HFNAME;
.             ENDIF
.           ENDIF
.
            WRITE   HTMLFILE;"<br>Patient Tel: ";
.
            MATCH   SP70,PTELEP
            IF      !@EQUAL  
              REP       "'`",PTELEP
              WRITE   HTMLFILE;PTELEP;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 1: ";
.
            MATCH   SP70,DIM40A
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40A;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 2: ";
.
            MATCH   SP70,DIM40B
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40B;
            ENDIF
.
            WRITE   HTMLFILE;"<br>Regime 3: ";
.
            MATCH   SP70,DIM40C
            IF      !@EQUAL
              WRITE   HTMLFILE;DIM40C;
            ENDIF
.
            MOVE    DIM8,BMCMDIM8
            CALL    BMCM0000
.
            WRITE   HTMLFILE;"#"); status=#"Patient Name: ",DIM30,"":
                             "    UR Number: ",PURNO,"":
                             "    Vis Number: ",DIM8," ";
.
            MATCH   SP70,DIM8A
            IF      !@EQUAL & !@EOS
              WRITE   HTMLFILE;" Linked Admno: ",DIM8A;
            ELSE
              WRITE   HTMLFILE;" Age/Gender: ",FMTPATAG,COMMA,PSEX," ";
            ENDIF
.
            WRITE   HTMLFILE;"    Admission Date:";
.
            MATCH     SP70,ADATE
            IF        !@EQUAL
              UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
              MOVE      CMON,F2
              LOAD    MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
              PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
              WRITE     HTMLFILE;DISPDATE;
            ENDIF
.
            WRITE     HTMLFILE;"Exp.Discharge Date: ";
            PACK      KEY8,DIM8,SP70
            CALL      RDPMWOR1
            IF        OVRCD<>1
              MATCH     SP70,PMWOEDAT
              IF        !@EQUAL
                UNPACK    PMWOEDAT,CCENT,CYEAR,CMON,CDAY
                MOVE      CMON,F2
                LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG:
                                     SEP,OCT,NOV,DEC
                WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
              ENDIF
            ENDIF
.
            REP       "#" ",ADIAG1
            REP       "#' ",ADIAG1
.
            WRITE     HTMLFILE;"Diagnosis: ",ADIAG1;
.
            WRITE     HTMLFILE;"Speciality: ";
            MATCH     SP70,ACLSSFT
            IF        !@EQUAL
              PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
              CALL      RDCODE1
              IF        OVRCD<>1
                WRITE     HTMLFILE;TDESC;
              ENDIF
            ENDIF
.
            WRITE     HTMLFILE;"Doctor: ";
            MATCH     SP70,ADOCTA
            IF        !@EQUAL
              MOVE      SP70,DOCFNAME
              PACK      KEY10,ADOCTA,SP70
              CALL      RDPMHCP1
              IF        OVRCD<>1
                MOVE      PMHCTITL,FMTTITLE
                MOVE      PMHCGNAM,FMTGNAME
                MOVE      PMHCSNAM,FMTSNAME
                CALL      DOCNM000
                REP       "'`",DOCFNAME
                WRITE     HTMLFILE;DOCFNAME;
              ENDIF
            ENDIF
.
            WRITE    HTMLFILE;"Health Fund: ";
.
            MATCH     SP70,AFUNDH
            IF        !@EQUAL
              PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
              PACK      KEY14,AFUNDH,AFNDTB,SP70
              CALL      RDFUND1
              IF        OVRCD<>1
                WRITE     HTMLFILE;HFNAME;
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;"#"'" :
                             " onmouseout='hide_it();status=#" #"'";
.
            MATCH   "1",DIM1B
            IF      @EQUAL
              IF      VIEWONLY<>1
              WRITE   HTMLFILE;" onclick='status=#"#";":
                               " SetCookie(#"BMRDCookie#",location.href);":
                               " location.href=#"oprweb01.pbl":
                               "?reportno=07":
                               "&template=001":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'";
              GOTO    BMRW1500
              ENDIF
            ENDIF
.
            MATCH   "2",DIM1B
            IF      @EQUAL
              IF      VIEWONLY<>1
              WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                               "?reportno=01":
                               "&template=032":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'";
              GOTO    BMRW1500
              ENDIF
            ENDIF
.
            MATCH   "3",DIM1B
            IF      @EQUAL
              IF      VIEWONLY<>1
              WRITE   HTMLFILE;" onclick='location.href=#"patweb89.pbl":
                               "?reportno=01":
                               "&template=030":
                               "&urnumber=",URNUMBER:
                               "&admissno=",DIM8:
                               "#";'";
              GOTO    BMRW1500
              ENDIF
            ENDIF
.
            WRITE   HTMLFILE;" onclick='location.href=#"patweb98.pbl":
                             "?reportno=01":
                             "&template=001":
                             "&urnumber=",URNUMBER:
                             "&admissno=",DIM8:
                             "#";'";
.
BMRW1500    WRITE   HTMLFILE;">&nbsp;</td>";
          ENDIF
.
          MOVE      "WhiteCell",CELLCOLR
.
BMRW9999  RETURN
.
.------------------------------------------------------------
. Bed Management
.------------------------------------------------------------
BEDMAN00  MATCH     SP70,WARDCODE
          IF        @EQUAL
            MOVE      WBSEWRD,WARDCODE
          ENDIF
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,BEDMAN90
.
          MATCH     SP70,LASTDATE
          IF        @EQUAL | @EOS
            CALL      IBACLOCK
            PACK      LASTDATE,CCC,CYY,CMM,CDD
            REP       " 0",LASTDATE
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.
          CLEAR     WEBTITLE
          MOVE      WBDESC,KEY20       * EC changes
          APPEND    KEY20,WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,BEDMAN99
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          GOTO      BEDMAN99
.
BEDMAN90  MOVE      "INVALID WARDCODE SPECIFIED",WEBTITLE
          CALL      WEBERR00
.
BEDMAN99  RETURN
.------------------------------------------------------------
. Get First available regime code
.------------------------------------------------------------
GETRGM00    MOVE      SP70,SAVEREGM
. 
            PACK      KEY10,PTBDADMN,SP70
            CALL      RSPTRGM1
GETRGM10    CALL      RKPTRGM1
            BRANCH    OVRCD,GETRGM99
.
            MATCH     PTBDADMN,PTRGADMN
            GOTO      GETRGM99 IF NOT EQUAL
.
            MATCH     SP70,PTRGREGM
            GOTO      GETRGM10 IF EQUAL
            GOTO      GETRGM10 IF EOS
.
            MOVE      PTRGREGM,SAVEREGM
.
GETRGM99  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
BDBD0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      BDDR0000                     * Set values in date array
          CALL      BDBH0000                     * Output headings
.
. Ward/Bed Details
.
BDBD1000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
BDBD2000  CALL      RDKWARD1
          BRANCH    OVRCD,BDBD9999
          MATCH     WARDCODE,WWARD
          GOTO      BDBD9999 IF NOT EQUAL
.
          BRANCH    WACTIVE,BDBD2000       * Do not display Inactive Beds
          MATCH     "1",PTWDBDST           * Do not display closed beds
          GOTO      BDBD2000 IF EQUAL
.
          WRITE     HTMLFILE;"<tr><td nowrap class=HeadingCell>",WBDESC,"</td>";
          CALL      BBRW0000
          WRITE     HTMLFILE;"</tr>";
.
          GOTO      BDBD2000
.
BDBD9999  RETURN
.
.------------------------------------------------------------
. Displays Bed Board View Heading
.------------------------------------------------------------
BDBH0000  WRITE     HTMLFILE;"<tr>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell>Date</td>";
.
          MOVE      ONE,DMARRCNT
.
BDBH1000  UNPACK    DATEARRY[DMARRCNT],DIM8
          UNPACK    DIM8,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          WRITE     HTMLFILE;"<td class=HeadingCell>",DISPDATE,"</td>";
.
          COMPARE   SEVEN,DMARRCNT
          GOTO      BDBH5000 IF EQUAL
.
          ADD       ONE,DMARRCNT
          GOTO      BDBH1000
.
BDBH5000  WRITE     HTMLFILE;"</tr>";
.
BDBH9999  RETURN
.
.------------------------------------------------------------
. Displays Bed Board Rows
.------------------------------------------------------------
BBRW0000  CALL      CLBB0000                   * Clear Bed Management Array
.
          CALL      BBAR0000                   * Populate Bed Management Array
.
          MOVE      ONE,DMARRCNT
.
BBRW1000  CALL      WMRW0000
.
          COMPARE   SEVEN,DMARRCNT
          GOTO      BBRW9999 IF EQUAL
.
          ADD       ONE,DMARRCNT
          GOTO      BBRW1000
.
BBRW9999  RETURN
.
.------------------------------------------------------------
. Set date array fields for classes
.------------------------------------------------------------
BDDR0000  MOVE      FRSTDATE,DATE8
          MOVE      DATE8,DATEARRY[1]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[2]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[3]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[4]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[5]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[6]
          ADD       ONE,DATE8
          MOVE      DATE8,DATEARRY[7]
.
BDDR9999  RETURN
.
.------------------------------------------------------------
. Clear the Bed Board Array
.------------------------------------------------------------
CLBB0000  MOVE      ONE,DMARRCNT
.
CLBB1000  MOVE      SP70,DMBDARRY[DMARRCNT]
.
          COMPARE   SEVEN,DMARRCNT
          GOTO      CLBB9999 IF EQUAL
.
          ADD       ONE,DMARRCNT
.
          GOTO      CLBB1000
.
CLBB9999  RETURN
.
.------------------------------------------------------------
. Populate Bed Board Array
.------------------------------------------------------------
BBAR0000  PACK      KEY30,WWARD,WBED,FRSTDATE,SP70
          CALL      RSPTBMD1
BBAR1000  CALL      RKPTBMD1
          BRANCH    OVRCD,BBAR9999
.
          MATCH     WWARD,PTBDWARD
          GOTO      BBAR9999 IF NOT EQUAL
.
          MATCH     WBED,PTBDWBED
          GOTO      BBAR9999 IF NOT EQUAL
.
          MATCH     PTBDDATE,LASTDATE
          GOTO      BBAR9999 IF LESS
.
          MATCH     "4",PTBDSTAT                  * Discharged
          GOTO      BBAR1000 IF EQUAL
.
          MOVE      SP70,TEMPURNO
          MATCH     "1",PTBDSTAT                  * Booked
          IF        @EQUAL
            PACK      KEY8,PTBDADMN,SP70
            CALL      RDBKREC1
            IF        OVRCD=0
              COMPARE   TWO,BKRESTAT              * Cancelled
              GOTO      BBAR1000 IF EQUAL
              MOVE      BKREURNO,TEMPURNO
              MOVE      BKREADOC,DOCTORC
            ENDIF
          ELSE
            PACK      KEY8,PTBDADMN,SP70
            CALL      RDMISS1
            IF        OVRCD=0
              MATCH     "5",DASTAT                * Cancelled
              GOTO      BBAR1000 IF EQUAL
              MOVE      AURNO,TEMPURNO
              MOVE      ADOCTA,DOCTORC
            ENDIF
          ENDIF
.
BBAR3000  CALL      DARY0000
.
          GOTO      BBAR1000
.
BBAR9999  RETURN
.
.------------------------------------------------------------
. Populate Bed Board Array Detail
.------------------------------------------------------------
DARY0000  DAYSEP    FRSTDATE,PTBDDATE,F1
          MOVE      ONE,DMARRCNT
          LOAD      DMARRCNT,F1,TWO,THREE,FOUR,FIVE,SIX,SEVEN
.
          UNPACK    DMBDARRY[DMARRCNT],DIM8
          MATCH     SP70,DIM8
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
          UNPACK    DMBDARRY[DMARRCNT],DIM8,DIM8A
          MATCH     SP70,DIM8A
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],DIM8,PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
.
          UNPACK    DMBDARRY[DMARRCNT],DIM16,DIM8A
          MATCH     SP70,DIM8A
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],DIM16,PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
.
          UNPACK    DMBDARRY[DMARRCNT],DIM24,DIM8A
          MATCH     SP70,DIM8A
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],DIM24,PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
.
          UNPACK    DMBDARRY[DMARRCNT],DIM32,DIM8A
          MATCH     SP70,DIM8A
          IF        @EQUAL
            PACK      DMBDARRY[DMARRCNT],DIM32,PTBDADMN,SP70
            GOTO      DARY9999
          ENDIF
.
DARY9999  RETURN
.
.-----------------------------------------------------------------------------
. WMRW0000 - Display Bed Board Row
.-----------------------------------------------------------------------------
WMRW0000  UNPACK    SP70,DIM8,DIM8A,DIM8B,DIM8C,DIM8D,DOCTORC
          UNPACK    DMBDARRY[DMARRCNT],DIM8,DIM8A,DIM8B,DIM8C,DIM8D
          MOVE      ZERO,F1
.
          MOVE      "AvailableCell",CELLCOLR
.
WMRW1000  MOVE      SP70,TEMPURNO
          MOVE      SP70,DOCTORC
          MOVE      ZERO,ADMSTAT
          MOVE      SP70,DIM30
          MATCH     SP70,DIM8
          GOTO      WMRW1300 IF EQUAL
.
          IF        EMPTONLY=1
            MOVE     "WhiteCell",CELLCOLR
            WRITE     HTMLFILE;"<td class=",CELLCOLR:
                               ">&nbsp;</td>";
            GOTO      WMRW9999
          ENDIF
.
          PACK      KEY8,DIM8,SP70
          CALL      RDBKREC1
          IF        OVRCD=0
            MOVE      BKREURNO,TEMPURNO
            MOVE      BKREADOC,DOCTORC
          ENDIF
          PACK      KEY8,DIM8,SP70
          CALL      RDMISS1
          IF        OVRCD=0
            MOVE      AURNO,TEMPURNO
            MOVE      ADOCTA,DOCTORC
            IF        ASTAT=2
              MOVE      ONE,ADMSTAT
            ENDIF
          ENDIF
.
          PACK    KEY8,TEMPURNO,SP70
          CALL    RDMAST1
          IF      OVRCD=0
            MOVE    PGNAME,DIM1A
            PACK    DIM30,DIM1A,FULLSTOP,PSNAME
            REP     "'`@ * / : \ $ % & # ",DIM30
            UNPACK  PBDATE,CCENT,CYEAR,CMON,CDAY
            MOVE    "WhiteCell",CELLCOLR
          ENDIF
.
          MOVE      PURNO,URNUMBER
          REP       " +",URNUMBER
.
          MATCH     SP70,DIM8A
          IF        !@EQUAL
            MOVE      "OverlapCell",CELLCOLR
          ELSE
            MOVE      "WhiteCell",CELLCOLR
            GOTO      WMRW1100
          ENDIF
.
          PACK      KEY8,DIM8,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
          PACK      KEY8,DIM8A,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
          PACK      KEY8,DIM8B,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
          PACK      KEY8,DIM8C,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
          PACK      KEY8,DIM8D,SP70
          CALL      RDPMWOR1
          IF        OVRCD<>1
            MATCH     SP70,PMWOEDTM
            IF        !@EQUAL
              MOVE      "OverlapExpDisCell",CELLCOLR
              GOTO      WMRW1100
            ENDIF
          ENDIF
.------------------------------------------------------------------------------
. Patient's 00 Cell: Demographics Folder and Edit Icon
.------------------------------------------------------------------------------
.
WMRW1100  PACK      KEY5,ANSG,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            MATCH     SP70,TDESC
            IF        @EQUAL
              MOVE      "Gender",TDESC
            ENDIF
            STRIP     TDESC
          ENDIF
.
          IF      F1=0
            WRITE   HTMLFILE;"<td nowrap class=",CELLCOLR,">";
          ELSE
            WRITE   HTMLFILE;"<br>";
          ENDIF
          WRITE   HTMLFILE;"<img src=../images/PatientFolder.gif":
                           " class=ListIcon ":
                           " onmouseover='status=#" Patient Name: ",DIM30:
                           "    UR Number: ",PURNO," ":
                           "    Vis Number: ",DIM8," ":
                           "    ",*+,TDESC,": ",PSEX," ":
                           "    DOB: ",CDAY,"/",CMON,"/",CCENT,CYEAR:
                           "    Doctor: ",DOCTORC:
                           "#";show_it(#"Patient Name: ",DIM30:
                           " <br>UR Number:",PURNO:
                           " <br>Vis Number: ",DIM8:
                           " <br>",*+,TDESC,": ",PSEX," ":
                           " <br>DOB: ",CDAY,"/",CMON,"/",CCENT,CYEAR:
                           " <br>Doctor: ",DOCTORC:
                           "#");'" :
                           " onmouseout='hide_it();status=#" #"'":
                           " onclick='status=#"#";location.href=#"",LINKPRG,".pbl":
                           "?reportno=",LINKREP:
                           "&template=",LINKTEM:
                           "&urnumber=",URNUMBER:
                           "&admissno=",DIM8:
                           "#";'>":
                           "<img src=../images/EditIcon.gif":
                           " class=ListIcon ":
                           " onmouseover='show_it(#"Patient Name: ",DIM30:
                           " <br>UR Number: ",PURNO:
                           " <br>Vis Number: ",DIM8:
                           " <br>",*+,TDESC,": ",PSEX," ":
                           " <br>DOB: ",CDAY,"/",CMON,"/",CCENT,CYEAR:
                           " <br>Doctor: ",DOCTORC:
                           "#");status=#"Patient Name: ",DIM30:
                           "    UR Number: ",PURNO," ":
                           "    Vis Number: ",DIM8," ":
                           "    ",*+,TDESC,": ",PSEX," ":
                           "    DOB: ",CDAY,"/",CMON,"/",CCENT,CYEAR:
                           "    Doctor: ",DOCTORC:
                           "#"'" :
                           " onmouseout='hide_it();status=#" #"'";
.
          WRITE   HTMLFILE;" onclick='status=#"#";location.href=#"patweb89.pbl":
                           "?reportno=01":
                           "&template=032":
                           "&urnumber=",URNUMBER:
                           "&admissno=",DIM8:
                           "#";'>";
          IF       ADMSTAT<>1
            WRITE    HTMLFILE;"<b>";
          ENDIF
          WRITE    HTMLFILE;DIM30,DOCTORC;
          IF       ADMSTAT<>1
            WRITE    HTMLFILE;"</b>";
          ENDIF
.
          ADD       ONE,F1
          COMPARE   F1,FOUR
          GOTO      WMRW1300 IF LESS
          LOAD      DIM8,F1,DIM8A,DIM8B,DIM8C,DIM8D
          GOTO      WMRW1000
.------------------------------------------------------------------------------
. Empty cells and patient's subsequent cells
.------------------------------------------------------------------------------
.
WMRW1300  MATCH     "AvailableCell",CELLCOLR
          IF        @EQUAL
            WRITE   HTMLFILE;"<td class=",CELLCOLR:
                             ">&nbsp;</td>";
            GOTO    WMRW9999
          ENDIF
.
          COMPARE   ZERO,F1
          GOTO      WMRW9000 IF NOT EQUAL
          WRITE     HTMLFILE;">&nbsp;</td>";
          GOTO      WMRW9999
.
.
WMRW9000  WRITE     HTMLFILE;"</td>";
WMRW9999  RETURN
.
.------------------------------------------------------------------------------
. Count the Number of patients for the Day Oncology Ward View
.------------------------------------------------------------------------------
CNPBMV00  MOVE      ZERO,FORM5A
          PACK      KEY30,WARDCODE,LASTDATE,SP70
          CALL      RSPTBMD4
CNPBMV10  CALL      RKPTBMD4
          BRANCH    OVRCD,CNPBMV90
.
          MATCH     WARDCODE,PTBDWARD
          GOTO      CNPBMV90 IF NOT EQUAL
.
          MATCH     LASTDATE,PTBDDATE
          GOTO      CNPBMV90 IF NOT EQUAL
.
          MATCH     SP70,PTBDWBED
          GOTO      CNPBMV10 IF EQUAL
          GOTO      CNPBMV10 IF EOS
.
          MATCH     "00:00",PTBDADTM
          IF        @EQUAL
            GOTO      CNPBMV10
          ELSE
            MATCH     SP70,PTBDLOSM
            IF        !@EQUAL & !@EOS
              MOVE      ZERO,FORM5
              MOVE      PTBDLOSM,FORM5
.
              IF        FORM5=0
                GOTO      CNPBMV10
              ENDIF
            ELSE
              GOTO      CNPBMV10
            ENDIF
          ENDIF
.
          ADD       ONE,FORM5A
          GOTO      CNPBMV10
.
CNPBMV90  WRITE     HTMLFILE;FORM5A;
.
CNPBMV99  RETURN
.
.------------------------------------------------------------------------------
. Find out if the bed is closed Day Oncology Ward View
.------------------------------------------------------------------------------
.------------------------------------------------------------------------------
. Find out if the bed is closed Day Oncology Ward View
.------------------------------------------------------------------------------
CLBD0000  MOVE      SP70,DIM5
          MOVE      ZERO,CLBDINDC
          UNPACK    TIMEARRY[TMARRCNT],DIM5,DIM1,DIM5A
.
          PACK      KEY22,WWARD,WBED,LASTDATE,DIM5A,SP70
          CALL      RDPMBDC1
          IF        OVRCD<>1
            GOTO     CLBD1200
          ENDIF
.
CLBD1000  CALL      RPPMBDC1
          BRANCH    OVRCD,CLBD9999
.
CLBD1200  MATCH     PMBCWARD,WWARD
          GOTO      CLBD9999 IF NOT EQUAL
.
          MATCH     PMBCBED,WBED
          GOTO      CLBD9999 IF NOT EQUAL
.
          MATCH     LASTDATE,PMBCTODT
          GOTO      CLBD9999 IF LESS
.
          IF        @EQUAL
            MATCH     DIM5,PMBCTOTM
            GOTO      CLBD9999 IF LESS
          ENDIF
.
          MOVE      ONE,CLBDINDC
.
CLBD9999  RETURN
.
.------------------------------------------------------------------------------
. Return the category code long description for the first code in cat sn
. where indicator 1 = KEY1
.------------------------------------------------------------------------------
CATD0000  UNPACK    DIM127,D1,KEY1,DIM127
.
          PACK      KEY5,CATSN,SP70
          CALL      RDSCODE1
CATD1000  CALL      RDKCODE1
          BRANCH    OVRCD,CATD9999
.
          MATCH    TCODE,CATSN
          GOTO     CATD9999 IF NOT EQUAL
.
          MATCH    KEY1,TCINDC1
          GOTO     CATD1000 IF NOT EQUAL
.
          WRITE    HTMLFILE;PTCDLDES;
.
CATD9999  RETURN
.------------------------------------------------------------
. Eclipse Claim Enquiries
.------------------------------------------------------------
ECCE0000  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECCE6000 IF EQUAL

          MATCH     "V",UPDATETY                         
          GOTO      ECCE1000 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      ECCE2000 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      ECCE3000 IF EQUAL
.
          MATCH     "P",UPDATETY
          GOTO      ECCE4000 IF EQUAL
.
          MATCH     "S",UPDATETY
          GOTO      ECCE5000 IF EQUAL
.
          GOTO      ECCE9000
.
ECCE1000  CALL      MINV0000
          GOTO      ECCE9999 
.
ECCE2000  CALL      RSUB0000
          GOTO      ECCE9999
.
ECCE3000  CALL      WDEL0000
          GOTO      ECCE9999
.
ECCE4000  CALL      OTPC0000
          GOTO      ECCE9999
.
ECCE5000  CALL      RSET0000
          GOTO      ECCE9999 
.
ECCE6000  MOVE      TEMPLATE,FORM3
          IF        FOUR=FORM3
            PACK      KEY8,URNUMBER,SP70
            CALL      RDMAST1
            BRANCH    OVRCD,ECFD9100
.
            CALL      GETPAT00
            CALL      PATLN000
            CALL      PATFLD00                * Use standard Patient Folder sub
.
            MOVE      URNUMBER,FILTURNO
.           MOVE      ADMISSNO,FILTADMN
.
            IF        ALLHFLAG=0
              COMPARE   ONE,IBCNMHOS  
              IF        @EQUAL
                MOVE      TWO,VIEWTYPE
                MOVE      ZERO,EXDTBLNK
              ELSE
                MOVE      ZERO,VIEWTYPE
                MOVE      ONE,EXDTBLNK  
              ENDIF
            ENDIF
          ENDIF
.
          CALL      CURPER00
          CALL      CALCDT00   * Calculate Next and Last Period Dates
.          
          CLEAR     WEBTITLE
.
          MOVE      TEMPLATE,FORM3
          IF        THREE=FORM3
            MOVE      "Eclipse Outstanding Assessment Reports Enquiry",WEBTITLE
          ELSE
            MOVE      "Eclipse Claim Enquiry",WEBTITLE
          ENDIF
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,ECCE9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ECCE9999
.
ECCE9000  MOVE      "Invalid Form Action.",WEBTITLE
          MOVE      ONE,EXIT
          CALL      WEBERR00
          GOTO      ECCE9999
.
ECCE9999  RETURN
.------------------------------------------------------------
. Eclipse Claim Enquiries tags
.------------------------------------------------------------
ECCL0000  BRANCH    FLDITMNO,ECCL0100,ECCL0200,ECCL0300,ECCL0400,ECCL0500:
                             ECCL0600,ECCL0700,ECCL0800,ECCL0900,ECCL1000:
                             ECCL1100,ECCL1200,ECCL1300,ECCL1400,ECCL1500:
                             ECCL1600,ECCL1700,ECCL1800,ECCL1900,ECCL2000:
                             ECCL2100,ECCL2200,ECCL2300,ECCL2400,ECCL2500
.
          GOTO      ECCL9999
.
ECCL0100  CALL      ECCT0000
          GOTO      ECCL9999
.
ECCL0200  WRITE     HTMLFILE;IBCNMHOS;    * Multihospital Indicator
          GOTO      ECCL9999
.
ECCL0300  CALL      HOSPID00              * Hospital ID option field
          GOTO      ECCL9999
.
ECCL0400  CALL      SELHFN00              * Health Fund option field
          GOTO      ECCL9999
.
ECCL0500  WRITE     HTMLFILE;HLFDCLTY; 
          GOTO      ECCL9999
.
ECCL0600  MOVE      CATCL,CATEGORY
          MOVE      HLTHFUND,CODE
          CALL      CODITM00
          GOTO      ECCL9999
.
ECCL0700  WRITE     HTMLFILE;EXCLWAIT;
          GOTO      ECCL9999
.
ECCL0800  WRITE     HTMLFILE;FILTURNO;
          GOTO      ECCL9999
.
ECCL0900  WRITE     HTMLFILE;FILTADMN;
          GOTO      ECCL9999
.
ECCL1000  WRITE     HTMLFILE;BATCHNUM;
          GOTO      ECCL9999
.
ECCL1100  WRITE     HTMLFILE;CLAIMSTA;
          GOTO      ECCL9999
.
ECCL1200  WRITE     HTMLFILE;INVNUMBR;
          GOTO      ECCL9999
.
ECCL1300  CALL      SELP0000
          GOTO      ECCL9999
.
ECCL1400  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ECCL9999
.
ECCL1500  WRITE     HTMLFILE;EXDTBLNK;
          GOTO      ECCL9999
.
ECCL1600  WRITE     HTMLFILE;HLTHFUND;
          GOTO      ECCL9999
.
ECCL1700  CALL      PRVE0000
          GOTO      ECCL9999
.
ECCL1800  CALL      NXTE0000
          GOTO      ECCL9999
.
ECCL1900  CALL      BATTB000
          GOTO      ECCL9999
.
ECCL2000  CALL      PREVBT00
          GOTO      ECCL9999
.
ECCL2100  CALL      NEXTBT00
          GOTO      ECCL9999
.
ECCL2200  CALL      ECOT0000
          GOTO      ECCL9999
.
ECCL2300  WRITE     HTMLFILE;PROCSTAT;
          GOTO      ECCL9999
.
ECCL2400  CALL      ECCP0000
          GOTO      ECCL9999
.
ECCL2500  WRITE     HTMLFILE;EXCLCLOS;
          GOTO      ECCL9999
.
ECCL9999  RETURN
.------------------------------------------------------------
. Table of Eclipse Claim Enquiries
.------------------------------------------------------------
ECCT0000  MOVE      ZERO,LOOPCNTR
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,RECCNT
.
          PACK      KEY18,WBSEUID,PRGID,SP70
          CALL      RDWBST1                 * check server security level
          IF        OVRCD=1
            MOVE      ZERO,WBSTLEV
          ENDIF
          IF        WBSTLEV=99
            MOVE      ONE,SUPERECL          * eclipse supervisor = yes
          ELSE
            MOVE      ZERO,SUPERECL         * eclipse supervisor = no
          ENDIF
.
          MATCH     FRSTDATE,SP70
          GOTO      ECCT9999 IF EQUAL
          MATCH     LASTDATE,SP70
          GOTO      ECCT9999 IF EQUAL
.
          PACK      KEY16,FRSTDATE,SP70
          CALL      RSPMEBH2
ECCT0500  CALL      RKPMEBH2
          BRANCH    OVRCD,ECCT2000
          MATCH     PMEBDTBC,LASTDATE
          GOTO      ECCT2000 IF LESS
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 500)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
          PACK      KEY24,PMEBBTHN,SP70     
          CALL      RSPMECT3
ECCT1000  CALL      RKPMECT3
          BRANCH    OVRCD,ECCT0500          
          MATCH     PMEBBTHN,PMECBATN
          GOTO      ECCT0500 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 500)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
.
          IF        IBCNMHOS=ONE
            MATCH     SP70,HOSPCODE
            IF        !@EQUAL & !@EOS
              MATCH     HOSPCODE,PMECHOSP
              GOTO      ECCT1000 IF NOT EQUAL
            ELSE
              IF        ALLHFLAG<>ONE
                MATCH     WBSEHOSP,PMECHOSP
                GOTO      ECCT1000 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,HLFDCLTY
          IF        !@EQUAL & !@EOS
            MATCH     HLFDCLTY,DPMECEET
            GOTO      ECCT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HLTHFUND
          IF        !@EQUAL & !@EOS
            PACK      HLTHFUND,HLTHFUND,SP70
            MATCH     HLTHFUND,PMECHFND
            GOTO      ECCT1000 IF NOT EQUAL
          ENDIF
.
          IF        EXCLCLOS=ONE
            COMPARE   TEN5,PMECFLAG
            GOTO      ECCT1000 IF EQUAL
          ENDIF
.
.         IF        EXCLWAIT=ONE
.           IF        PMECFLAG=ZERO
.             GOTO      ECCT1000
.           ENDIF
.         ENDIF
.
          MATCH     SP70,FILTURNO
          IF        !@EQUAL & !@EOS
            MATCH     FILTURNO,PMECURNO
            GOTO      ECCT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTADMN
          IF        !@EQUAL & !@EOS
            MATCH     FILTADMN,PMECADMN
            GOTO      ECCT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,BATCHNUM
          IF        !@EQUAL & !@EOS
            MATCH     BATCHNUM,PMECBATN
            GOTO      ECCT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMSTA
          IF        !@EQUAL & !@EOS
            MATCH     CLAIMSTA,DPMECFLG
            GOTO      ECCT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,INVNUMBR
          IF        !@EQUAL & !@EOS
            MATCH     INVNUMBR,PMECINVN
            GOTO      ECCT1000 IF NOT EQUAL
          ENDIF
.
.         IF        EXDTBLNK=0
.
.           PACK      KEY8,PMECBATN,SP70
.           CALL      RDPMEBH1
.           BRANCH    OVRCD,ECCT1000
.
.           MATCH     FRSTDATE,PMEBDTBC
.           GOTO      ECCT1000 IF LESS
.
.           MATCH     PMEBDTBC,LASTDATE
.           GOTO      ECCT1000 IF LESS
.
.         ENDIF
.
          MOVE      ZERO,VIEWINDI
          PACK      KEY34,PMECINVN,Z70
          CALL      RSPMECA3
          CALL      RPPMECA3
          IF        OVRCD=0
            MATCH     PMECINVN,PMEAINVN
            IF        @EQUAL
              MATCH     " 5",PMEATYPE
              IF        @EQUAL
                MOVE      ONE,VIEWINDI
              ENDIF
            ENDIF 
          ENDIF
.
          MOVE      STATUS00,STATDESC
          LOAD      STATDESC,PMECFLAG,STATUS01,STATUS02,STATUS03,STATUS04:
                                      STATUS05,STATUS06,STATUS07,STATUS08:
                                      STATUS09,STATUS10,STATUS11,STATUS12:
                                      STATUS13,STATUS14,STATUS15
.
          CALL      RSBI0000
.
          CALL      GBAL0000
.
          MOVE      PMECURNO,URNUMBER
          MOVE      PMECADMN,ADMISSNO
          CALL      GETPAT00  
          CALL      PATLN000
          MOVE      SP70,KEY3
          CALL      PATFLD00
.
          REP       " +",PMECURNO
          REP       " +",PMECADMN
          REP       " +",PMECBATN
          REP       " +",PMECINVN
.
          CLEAR     UPDLINK
          APPEND    "patweb93",UPDLINK
          APPEND    ".pbl?reportno=",UPDLINK
          APPEND    "16",UPDLINK
          APPEND    "&template=",UPDLINK
          APPEND    "001",UPDLINK
          APPEND    "&urnumber=",UPDLINK
          APPEND    PMECURNO,UPDLINK
          APPEND    "&admissno=",UPDLINK
          APPEND    PMECADMN,UPDLINK
          APPEND    "&mavbatch=",UPDLINK
          APPEND    PMECBATN,UPDLINK
          APPEND    "&mavinvce=",UPDLINK
          APPEND    PMECINVN,UPDLINK
          RESET     UPDLINK  
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    PMECURNO,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    PMECADMN,PATLINK
          RESET     PATLINK
.
          REP       "+ ",PMECURNO
          REP       "+ ",PMECADMN
          REP       "+ ",PMECBATN
          REP       "+ ",PMECINVN
.
          WRITE     HTMLFILE;"t.addRow(#"",PMECBATN,"#",":
                             "#"",PMECADMN,"#",":
                             "#"",PMECINVN,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",PMECHFND,"#",";
.
          IF        PMECFLAG=ZERO
            WRITE     HTMLFILE;"#"<font color=red>",FORM7P2O,"&nbsp;*</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",PMECAMTC,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",STATDESC,"#",":
                             "#"",PMECPBAT,"#",":
                             "#"",PMECNBAT,"#",":
                             "#"#",":
                             "#"",UPDLINK,"#",":
                             "#"#",":
                             "#"",PATLINK,"#",";
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMECBATN
          IF        @EQUAL|@EOS
            WRITE     HTMLFILE;"#"#",";
          ELSE
            MATCH     SP70,PMECNBAT
            IF        @EQUAL|@EOS
              IF        VIEWINDI=ONE
                WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                                   " value='",PMECBATN,PMECINVN:
                                   "' onclick=MarkAsViewed(this); checked>":
                                   "#",";
              ELSE
                WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                                   " value='",PMECBATN,PMECINVN:
                                   "' onclick=MarkAsViewed(this);>":
                                   "#",";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"#"#",";
            ENDIF
          ENDIF
.
.         IF        RSUBINDI=ZERO
            WRITE     HTMLFILE;"#"<input type=checkbox name=rsb",DRECCNT:
                               " value='",PMECBATN,PMECINVN:
                               "' onclick=reSubmit(this);>":
                               "#",";
.         ELSE
.           WRITE     HTMLFILE;"#"#",";
.         ENDIF
.
          IF        PMECFLAG=ZERO
            WRITE     HTMLFILE;"#"<input type=checkbox name=del",DRECCNT:
                               " value='",PMECBATN,PMECINVN:
                               "' onclick=delWaitn(this);>":
                               "#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",KEY3,"#",";
.
          MOVE      PMECBATN,DIM8
          REP       " +",PMECURNO
          REP       " +",PMECADMN
          REP       " +",PMECBATN
          REP       " +",PMECINVN
          WRITE     HTMLFILE;"#"","<img src='../images/InvoiceIcon.gif'":
                               " class=ListIcon onclick=displayClaim('":
      PMECBATN,"','",PMECADMN,"','",PMECURNO,"','",PMECINVN,"');> ",DIM8,"#",";
          REP       "+ ",PMECURNO
          REP       "+ ",PMECADMN
          REP       "+ ",PMECBATN
          REP       "+ ",PMECINVN
.
. Allow status reset if applicable security level applies (column 18)
.
          IF        SUPERECL=ONE & (PMECFLAG=5 | PMECFLAG=7 | PMECFLAG=8)
            WRITE     HTMLFILE;"#"<input type=checkbox name=rst",DRECCNT:
                               " value='",PMECBATN,PMECINVN:
                               "' onclick=resetStatus(this);>":
                               "#");"
          ELSE                     
            WRITE     HTMLFILE;"#"#");"
          ENDIF
.
          MOVE      ZERO,LOOPCNTR
.
          GOTO      ECCT1000
.
ECCT2000  MOVE      ZERO,LOOPCNTR
.
          IF        EXCLWAIT=1 & EXCLCLOS=1
            GOTO      ECCT9000
          ENDIF
.     
          PACK      KEY24,SP70
          CALL      RSPMECT3
ECCT3000  CALL      RKPMECT3
          BRANCH    OVRCD,ECCT9000
          MATCH     SP70,PMECBATN
          GOTO      ECCT9000 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 500)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
.
          IF        IBCNMHOS=ONE
            MATCH     SP70,HOSPCODE
            IF        !@EQUAL & !@EOS
              MATCH     HOSPCODE,PMECHOSP
              GOTO      ECCT3000 IF NOT EQUAL
            ELSE
              IF        ALLHFLAG<>ONE
                MATCH     WBSEHOSP,PMECHOSP
                GOTO      ECCT3000 IF NOT EQUAL
              ENDIF
            ENDIF
          ENDIF
.
          MATCH     SP70,HLFDCLTY
          IF        !@EQUAL & !@EOS
            MATCH     HLFDCLTY,DPMECEET
            GOTO      ECCT3000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HLTHFUND
          IF        !@EQUAL & !@EOS
            PACK      HLTHFUND,HLTHFUND,SP70
            MATCH     HLTHFUND,PMECHFND
            GOTO      ECCT3000 IF NOT EQUAL
          ENDIF
.
          IF        EXCLCLOS=ONE
            IF        PMECFLAG=TEN5
              GOTO      ECCT3000
            ENDIF
          ENDIF
.
          IF        EXCLWAIT=ONE
            IF        PMECFLAG=ZERO
              GOTO      ECCT3000
            ENDIF
          ENDIF
 
          MATCH     SP70,FILTURNO
          IF        !@EQUAL & !@EOS
            MATCH     FILTURNO,PMECURNO
            GOTO      ECCT3000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,FILTADMN
          IF        !@EQUAL & !@EOS
            MATCH     FILTADMN,PMECADMN
            GOTO      ECCT3000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,BATCHNUM
          IF        !@EQUAL & !@EOS
            MATCH     BATCHNUM,PMECBATN
            GOTO      ECCT3000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMSTA
          IF        !@EQUAL & !@EOS
            MATCH     CLAIMSTA,DPMECFLG
            GOTO      ECCT3000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,INVNUMBR
          IF        !@EQUAL & !@EOS
            MATCH     INVNUMBR,PMECINVN
            GOTO      ECCT3000 IF NOT EQUAL
          ENDIF
.
.         IF        EXDTBLNK=0
.
.           PACK      KEY8,PMECBATN,SP70
.           CALL      RDPMEBH1
.           BRANCH    OVRCD,ECCT1000
.
.           MATCH     FRSTDATE,PMEBDTBC
.           GOTO      ECCT1000 IF LESS
.
.           MATCH     PMEBDTBC,LASTDATE
.           GOTO      ECCT1000 IF LESS
.
.         ENDIF
.
          MOVE      ZERO,VIEWINDI
          PACK      KEY34,PMECINVN,Z70
          CALL      RSPMECA3
          CALL      RPPMECA3
          IF        OVRCD=0
            MATCH     PMECINVN,PMEAINVN
            IF        @EQUAL
              MATCH     " 5",PMEATYPE
              IF        @EQUAL
                MOVE      ONE,VIEWINDI
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      STATUS00,STATDESC
          LOAD      STATDESC,PMECFLAG,STATUS01,STATUS02,STATUS03,STATUS04:
                                      STATUS05,STATUS06,STATUS07,STATUS08:
                                      STATUS09,STATUS10,STATUS11,STATUS12:
                                      STATUS13,STATUS14,STATUS15
.
          CALL      RSBI0000
.
          CALL      GBAL0000
.
          MOVE      PMECURNO,URNUMBER
          MOVE      PMECADMN,ADMISSNO
          CALL      GETPAT00
          CALL      PATLN000
          MOVE      SP70,KEY3
          CALL      PATFLD00
.
          REP       " +",PMECURNO
          REP       " +",PMECADMN
          REP       " +",PMECBATN
          REP       " +",PMECINVN
.
          CLEAR     UPDLINK
          APPEND    "patweb93",UPDLINK
          APPEND    ".pbl?reportno=",UPDLINK
          APPEND    "16",UPDLINK
          APPEND    "&template=",UPDLINK
          APPEND    "001",UPDLINK
          APPEND    "&urnumber=",UPDLINK
          APPEND    PMECURNO,UPDLINK
          APPEND    "&admissno=",UPDLINK
          APPEND    PMECADMN,UPDLINK
          APPEND    "&mavbatch=",UPDLINK
          APPEND    PMECBATN,UPDLINK
          APPEND    "&mavinvce=",UPDLINK
          APPEND    PMECINVN,UPDLINK
          RESET     UPDLINK
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    PMECURNO,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    PMECADMN,PATLINK
          RESET     PATLINK
.
          REP       "+ ",PMECURNO
          REP       "+ ",PMECADMN
          REP       "+ ",PMECBATN
          REP       "+ ",PMECINVN
.
          WRITE     HTMLFILE;"t.addRow(#"",PMECBATN,"#",":
                             "#"",PMECADMN,"#",":
                             "#"",PMECINVN,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",PMECHFND,"#",";
.
          IF        PMECFLAG=ZERO
            WRITE     HTMLFILE;"#"<font color=red>",FORM7P2O,"&nbsp;*</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",PMECAMTC,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",STATDESC,"#",":
                             "#"",PMECPBAT,"#",":
                             "#"",PMECNBAT,"#",":
                             "#"#",":
                             "#"",UPDLINK,"#",":
                             "#"#",":
                             "#"",PATLINK,"#",";
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMECBATN
          IF        @EQUAL|@EOS
            WRITE     HTMLFILE;"#"#",";
          ELSE
            MATCH     SP70,PMECNBAT
            IF        @EQUAL|@EOS
              IF        VIEWINDI=ONE
                WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                                   " value='",PMECBATN,PMECINVN:
                                   "' onclick=MarkAsViewed(this); checked>":
                                   "#",";
              ELSE
                WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                                   " value='",PMECBATN,PMECINVN:
                                   "' onclick=MarkAsViewed(this);>":
                                   "#",";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"#"#",";
            ENDIF
          ENDIF
.
.         IF        RSUBINDI=ZERO
            WRITE     HTMLFILE;"#"<input type=checkbox name=rsb",DRECCNT:
                               " value='",PMECBATN,PMECINVN:
                               "' onclick=reSubmit(this);>":
                               "#",";
.         ELSE
.           WRITE     HTMLFILE;"#"#",";
.         ENDIF
.
          IF        PMECFLAG=ZERO
            WRITE     HTMLFILE;"#"<input type=checkbox name=del",DRECCNT:
                               " value='",PMECBATN,PMECINVN:
                               "' onclick=delWaitn(this);>":
                               "#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",KEY3,"#",";
.
          MOVE      PMECBATN,DIM8
          REP       " +",PMECURNO
          REP       " +",PMECADMN
          REP       " +",PMECBATN
          REP       " +",PMECINVN
          WRITE     HTMLFILE;"#"","<img src='../images/InvoiceIcon.gif'":
                               " class=ListIcon onclick=displayClaim('":
      PMECBATN,"','",PMECADMN,"','",PMECURNO,"','",PMECINVN,"');> ",DIM8,"#",";
          REP       "+ ",PMECURNO
          REP       "+ ",PMECADMN
          REP       "+ ",PMECBATN
          REP       "+ ",PMECINVN
.
. Allow status reset if applicable security level applies (column 18)
.
          IF        SUPERECL=ONE & (PMECFLAG=5 | PMECFLAG=7 | PMECFLAG=8)
            WRITE     HTMLFILE;"#"<input type=checkbox name=rst",DRECCNT:
                               " value='",PMECBATN,PMECINVN:
                               "' onclick=resetStatus(this);>":
                               "#");"
          ELSE
            WRITE     HTMLFILE;"#"#");"
          ENDIF
.
          MOVE      ZERO,LOOPCNTR
.
          GOTO      ECCT3000
.
ECCT9000 
ECCT9999  RETURN
.------------------------------------------------------------
. Hospital ID
.------------------------------------------------------------
HOSPID00  PACK      KEY3,SP10
          CALL      RSPTHSP1
HOSPID10  CALL      RKPTHSP1
          BRANCH    OVRCD,HOSPID90
.
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          BRANCH    IBCNMHOS,HOSPID20
          WRITE     HTMLFILE;"<option value=",KEY5,">":
                             PTHSNAME,"</option>"
          GOTO      HOSPID10
.
.         Mult-Hospital
.
HOSPID20  BRANCH    ALLHFLAG,HOSPID30            * don't default to user's hosp
          MATCH     SP70,HOSPCODE                                      *C-125462
          IF        @EQUAL
            MOVE      WBSEHOSP,HOSPCODE          * default to user's Hosp code
          ENDIF
HOSPID30  MATCH     HOSPCODE,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               PTHSNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">":
                               PTHSNAME,"</option>"
          ENDIF
          GOTO      HOSPID10
.
HOSPID90
HOSPID99  RETURN
+
.------------------------------------------------------------
. Health fund Selection
.------------------------------------------------------------
SELHFN00  PACK      KEY14,SP70
          CALL      RDSFUND1
SELHFN10  CALL      RDKFUND1
          BRANCH    OVRCD,SELHFN99
.
          MATCH     SP8,HFTABL           * Check health fund table
          GOTO      SELHFN10 IF EQUAL
.
          MATCH     "0000    ",HFTABL
          GOTO      SELHFN10 IF NOT EQUAL
.
          BRANCH    PHFTACT,SELHFN10     * ignore inactive HF
.
          PACK      KEY8,QUOTE,HCODE,QUOTE
          MATCH     HLTHFUND,HCODE
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY8," selected>":
                               HFNAME,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY8,">":
                               HFNAME,"</option>"
          ENDIF
          GOTO      SELHFN10
.
SELHFN99  RETURN
.
.--------------------------------------------------------------------------
. Remote Scripting 
.               1. Validate Batch Number
.               2. Get Patient Attribute flags (Falls/Pressure Injury/Abscond/
.                  Malnutrition Risk and Non Weight Bearing)
.               3. Get Patient Attribute text value
.               4. Get Patient Attribute notes (specify type)
.--------------------------------------------------------------------------
REMOTE00  BRANCH    VALDTYPE,REMOTE10,REMOTE20,REMOTE30,REMOTE40
          GOTO      REMOTE90
.
REMOTE10  CALL      VALBAT00     * Validate Batch Number
          GOTO      REMOTE99
.
REMOTE20  CALL      GETPAF00     * Get Patient Attributes flags
          GOTO      REMOTE99
.
REMOTE30  CALL      GETATV00     * Get Patient Attributes text value
          GOTO      REMOTE99
.
REMOTE40  CALL      GETANT00     * Get Patient Attributes notes (specify type)
          GOTO      REMOTE99
.
REMOTE90  CALL      XMLHED00
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Invalid Validation Type":
                             "</RETURN_VALUE>"
          CALL      XMLEND00
          GOTO      REMOTE99
.
REMOTE99  RETURN
+
.------------------------------------------------------------
. Validate Batch Number
. INPUTS: BATCHNUM - Batch Number
.------------------------------------------------------------
VALBAT00  CALL      XMLHED00
          BRANCH    EXIT,VALBAT99
.
          PACK      KEY24,BATCHNUM,SP70
          CALL      RSPMECT3
          CALL      RKPMECT3
          BRANCH    OVRCD,VALBAT90
.
          MATCH     PMECBATN,BATCHNUM         
          GOTO      VALBAT90 IF NOT EQUAL
.
.  Dummy ouput for valid Code
.
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                              ONE:
                             "</RETURN_VALUE>"
.
          GOTO      VALBAT98
.
VALBAT90  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "Batch number not on file. ":
                             "</RETURN_VALUE>"
          GOTO      VALBAT98
.
VALBAT98  CALL      XMLEND00
VALBAT99  RETURN
+
.------------------------------------------------------------------------------
.         Remote call to return Patient Attributes flags 
.         (Falls/Pressure Injury/Abscond/Malnutrition Risk and
.         Non Weight Bearing).
.------------------------------------------------------------------------------
GETPAF00  CALL      XMLHED00
          BRANCH    EXIT,GETPAF99
.
          CLEAR     DIM10
.
          REP       "+ ",PATATURN
          REP       "+ ",PATATVIS
          MOVE      PATATURN,PTATR001
          MOVE      PATATVIS,PTATR002
.
          MOVE      "5",ATTYPIND       * Attribute Type 5 ('Falls Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
          APPEND    PIPE,DIM10
.
          MOVE      "6",ATTYPIND       * Attribute Type 6 ('Pressure Injury')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
          APPEND    PIPE,DIM10
.
          MOVE      "7",ATTYPIND       * Attribute Type 7 ('Abscond Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
          APPEND    PIPE,DIM10
.
          MOVE      "8",ATTYPIND       * Attribute Type 8 ('Malnutrition Risk')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
          APPEND    PIPE,DIM10
.
          MOVE      "10",ATTYPIND      * Attr Type 10 ('Non Weight Bearing')
          MOVE      "1",ATCODIND       * Attribute Coded Field 1
          CALL      GETACV00           * Get Attribute Coded Field value
          IF        EXIT=1
            APPEND    ZERO,DIM10
          ELSE
            SQUEEZE   ATCODVAL
            APPEND    ATCODVAL,DIM10
          ENDIF
.
          RESET     DIM10
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DIM10:
                             "</RETURN_VALUE>"
.
          GOTO      GETPAF98
.
GETPAF91  WRITE     HTMLFILE;"<RETURN_VALUE TYPE=ERROR>":
                             "No Patient Attribute records for visist. ":
                             "</RETURN_VALUE>"
          GOTO      GETPAF98
.
GETPAF98  CALL      XMLEND00
GETPAF99  RETURN
+
.------------------------------------------------------------------------------
.         Remote call to return Patient Attribute Text value for Expected
.         Discharge Destination.
.------------------------------------------------------------------------------
GETATV00  CALL      XMLHED00
          BRANCH    EXIT,GETATV99
.
          CLEAR     DIM127
.
          REP       "+ ",PATATURN
          REP       "+ ",PATATVIS
          MOVE      PATATURN,PTATR001
          MOVE      PATATVIS,PTATR002
.
          MOVE      "9",ATTYPIND       * Attr Type 9 ('Expected Discharge Dest')
          MOVE      "1",ATCODIND       * Attribute Text Field 1
          CALL      GETTFV00           * Get Attribute Text Field value
          IF        EXIT=1
            APPEND    SP1,DIM127
            SQUEEZE   DIM127
          ELSE
            MOVELPTR  ATTXTVAL,FORM2
            SFORMAT   DIM127,FORM2
            APPEND    ATTXTVAL,DIM127
          ENDIF
.
          RESET     DIM127
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             DIM127:
                             "</RETURN_VALUE>"
.
          GOTO      GETATV98
.
GETATV98  CALL      XMLEND00
GETATV99  RETURN
+
.------------------------------------------------------------------------------
.         Remote call to return Patient Attribute Notes (specify Type)
.------------------------------------------------------------------------------
GETANT00  CALL      XMLHED00
          BRANCH    EXIT,GETANT99
.
          CLEAR     ATTRNOTE
.
          REP       "+ ",PATATURN
          REP       "+ ",PATATVIS
          MOVE      PATATURN,PTATR001
          MOVE      PATATVIS,PTATR002
          MOVE      PATATNOT,PTATR005
.
          PACK      KEY35,PTATR001,PTATR002,PTATR005,SP70
          CALL      RSPTATR3
GETANT10  CALL      RKPTATR3
          BRANCH    OVRCD,GETANT91
.
          MATCH     PTATR001,PTARURNO
          GOTO      GETANT91 IF NOT EQUAL
.
          MATCH     PTATR002,PTARVISN
          GOTO      GETANT91 IF NOT EQUAL
.
          MATCH     PTATR005,PTARTYPE
          GOTO      GETANT10 IF NOT EQUAL
.
          STRIP     PTARTXT1
          MOVELPTR  PTARTXT1,LENGTH
          IF        LENGTH > 0
            APPEND    PTARTXT1,ATTRNOTE
          ENDIF
          APPEND    "\n",ATTRNOTE
.          
          STRIP     PTARTXT2
          MOVELPTR  PTARTXT2,LENGTH
          IF        LENGTH > 0
            APPEND    PTARTXT2,ATTRNOTE
          ENDIF
          APPEND    "\n",ATTRNOTE
.          
          STRIP     PTARTXT3
          MOVELPTR  PTARTXT3,LENGTH
          IF        LENGTH > 0
            APPEND    PTARTXT3,ATTRNOTE
          ENDIF
.          
GETANT91  RESET     ATTRNOTE
          WRITE     HTMLFILE;"<RETURN_VALUE TYPE=SIMPLE>":
                             ATTRNOTE:
                             "</RETURN_VALUE>"
.
          GOTO      GETANT98
.
GETANT98  CALL      XMLEND00
GETANT99  RETURN
+
.------------------------------------------------------------
. Selects Day, Week or Month from Viewtype
.------------------------------------------------------------
SELP0000  MATCH     "1",VIEWTYPE
          GOTO      SELP2000 IF EQUAL
          MATCH     "2",VIEWTYPE
          GOTO      SELP4000 IF EQUAL
.
.Defaults to Daily Viewtype
.--------------------------
.
          WRITE     HTMLFILE;"<select name=lastdate class=DaySelect":
                             " onchange='exdtblankchange();FilterSubmit();'>";
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "8",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
.
          MOVE      "-7",ADJDAYS
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value='",SP8,"' selected>":
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value='",SP8,"'>":
                               "</option>";
          ENDIF
.
SELP1000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
          LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          IF        EXDTBLNK=1
              WRITE     HTMLFILE;"<option value=",STRTDATE,">":
                                 DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "</option>";
          ELSE
            MATCH     STRTDATE,FRSTDATE
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",STRTDATE," selected>":
                                 DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "</option>";
            ELSE
              WRITE     HTMLFILE;"<option value=",STRTDATE,">":
                                 DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR:
                                 "</option>";
            ENDIF
          ENDIF
.
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          MATCH     ENDDATE,STRTDATE
          GOTO      SELP1000 IF NOT EQUAL
          GOTO      SELP9000
.
.Select Weekly Viewtype
.--------------------------
SELP2000  WRITE     HTMLFILE;"<select name=lastdate class=WeekSelect":
                             " onchange='exdtblankchange();FilterSubmit();'>";
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "42",ADJDAYS
          CALL      ADJDAT00
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDATE
.
          UNPACK    FRSTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "-42",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          REP       " 0",FRSTDATE
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value='",SP8,"' selected>":
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value='",SP8,"'>":
                               "</option>";
          ENDIF
.
SELP3000  UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value=",STRTDATE,">Week of ":
                               CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
          ELSE
            MATCH     STRTDATE,FRSTDATE
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",STRTDATE," selected>Week of ":
                                 CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
            ELSE
              WRITE     HTMLFILE;"<option value=",STRTDATE,">Week of ":
                                 CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,"</option>";
            ENDIF
          ENDIF
.
          MOVE      "7",ADJDAYS
          CALL      ADJDAT00
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
          MATCH     ENDDATE,STRTDATE
          GOTO      SELP3000 IF NOT EQUAL
          GOTO      SELP9000
.
.
.Select Monthly Viewtype
.------------------------
.
SELP4000  WRITE     HTMLFILE;"<select name=vyearmth class=MonthSelect":
                             " onchange='exdtblankchange();FilterSubmit();'>";
          UNPACK    FRSTDATE,KEY4,CMON,CDAY
          MOVE      KEY4,F4
          MOVE      CMON,F2
          MOVE      CMON,ENDMTH
          ADD       SIX,ENDMTH
          IF        ENDMTH>12
            SUB       "12",ENDMTH
          ENDIF
          SUB       SIX,F2
          IF        F2<0
            SUB       ONE,F4
            ADD       "12",F2
          ENDIF
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value='",SP6,"' selected>":
                               "</option>";
          ELSE
            WRITE     HTMLFILE;"<option value='",SP6,"'>":
                               "</option>";
          ENDIF   
.
SELP5000  LOAD      MTHNAM,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY6,F4,F2
          REP       " 0",KEY6
.
          IF        EXDTBLNK=1
            WRITE     HTMLFILE;"<option value=",KEY6,">":
                               MTHNAM,SP1,F4,"</option>";
          ELSE
            MATCH     KEY6,FRSTDATE
            IF        @EQUAL
              WRITE     HTMLFILE;"<option value=",KEY6," selected>":
                                 MTHNAM,SP1,F4,"</option>";
            ELSE
              WRITE     HTMLFILE;"<option value=",KEY6,">":
                                 MTHNAM,SP1,F4,"</option>";
            ENDIF
          ENDIF
.
          ADD       ONE,F2
          IF        F2>12
            ADD      ONE,F4
            SUB      "12",F2
          ENDIF
          COMPARE   ENDMTH,F2
          GOTO      SELP5000 IF NOT EQUAL
.
SELP9000  WRITE     HTMLFILE;"</select>"
          RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month      
.------------------------------------------------------------
NXTE0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",HLTHFUND
          REP       " +",HLFDCLTY
          REP       " +",BATCHNUM
          REP       " +",INVNUMBR
          REP       " +",CLAIMSTA
          REP       " +",HOSPCODE
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.         
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&allhflag=",ALLHFLAG:
                             "&hlthfund=",HLTHFUND:
                             "&exclwait=",EXCLWAIT:
                             "&exdtblnk=",EXDTBLNK:
                             "&hlfdclty=",HLFDCLTY:
                             "&batchnum=",BATCHNUM:
                             "&invnumbr=",INVNUMBR:
                             "&claimsta=",CLAIMSTA:
                             "&hospcode=",HOSPCODE:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&exclclos=",EXCLCLOS;
.
          REP       "+ ",HLTHFUND
          REP       "+ ",HLFDCLTY
          REP       "+ ",BATCHNUM
          REP       "+ ",INVNUMBR
          REP       "+ ",CLAIMSTA
          REP       "+ ",HOSPCODE
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
NXTE9999  RETURN
.
.--------------------------------------------------------
.
PRVE0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",HLTHFUND
          REP       " +",HLFDCLTY
          REP       " +",BATCHNUM
          REP       " +",INVNUMBR
          REP       " +",CLAIMSTA
          REP       " +",HOSPCODE
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.                            
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&allhflag=",ALLHFLAG:
                             "&hlthfund=",HLTHFUND:
                             "&exclwait=",EXCLWAIT:
                             "&exdtblnk=",EXDTBLNK:
                             "&hlfdclty=",HLFDCLTY:
                             "&batchnum=",BATCHNUM:
                             "&invnumbr=",INVNUMBR:
                             "&claimsta=",CLAIMSTA:
                             "&hospcode=",HOSPCODE:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&exclclos=",EXCLCLOS;
.
          REP       "+ ",HLTHFUND
          REP       "+ ",HLFDCLTY
          REP       "+ ",BATCHNUM
          REP       "+ ",INVNUMBR
          REP       "+ ",CLAIMSTA
          REP       "+ ",HOSPCODE
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
PRVE9999  RETURN
.------------------------------------------------------------
. Table of Batch Numbers
.------------------------------------------------------------
BATTB000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
.
          CALL      BATHD000      * Output Table Heading
.
          IF        NORECORD=0
            MOVE      "17",NORECORD       * Set Default No Records to Display
          ENDIF
          MOVE      ZERO,RECNUMB
          MOVE      ZERO,DISNUMB
.
          PACK      KEY8,Z70
          CALL      RSPMEBH1                     * position in file
BATTB100  CALL      RPPMEBH1                     * read previous record
          BRANCH    OVRCD,BATTB999
.
          ADD       ONE,RECNUMB
          IF        STARTNUM>=RECNUMB
            GOTO      BATTB100
          ENDIF
.
          CALL      BATRW000      * Display Row
          BRANCH    EXIT,BATTB100
.
          ADD       ONE,DISNUMB
          COMPARE   NORECORD,DISNUMB
          GOTO      BATTB100 IF NOT EQUAL
.
BATTB999  RETURN
.------------------------------------------------------------
. Batch Numbers by Code (TABLE HEADING)
.------------------------------------------------------------
BATHD000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=15%>":
                             "Batch Number</td>";
.
          IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<td class=HeadingCell width=25%>":
                               "Hospital</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=15%>":
                             "Health Fund</td>":
                             "<td class=HeadingCell width=15%>":
                             "Date</td>":
                             "<td class=HeadingCell width=15%>":
                             "Time</td>":
.                            "<td class=HeadingCell width=15%>":
.                            "Status</td>":
                             "</tr>"
.
BATHD999  RETURN
.------------------------------------------------------------
. Batch Numbers (TABLE ROW)
.------------------------------------------------------------
BATRW000  MOVE      ZERO,EXIT
          PACK      BTSCHOSP,BTSCHOSP,SP70
.
          UNPACK    PMEBDTBC,CCENT,CYEAR,CMON,CDAY  * Batch Created Date
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      KEY11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.         MOVE      "Extracted     ",BSTATDES
.         LOAD      BSTATDES,PTEHFLAG,BSTATDS1,BSTATDS2,BSTATDS3
.
          UNPACK    PMEBTMBC,DIM5,ANS,ANS,ANS
.
          MOVE      SP70,HOSPNAME
          COMPARE   ONE,IBCNMHOS
          GOTO      BATRW500 IF NOT EQUAL
.
          PACK      KEY24,PMEBBTHN,SP30         * get Hospital for given Batch
          CALL      RSPMECT3
          CALL      RKPMECT3
          IF        OVRCD=1
            MOVE      ONE,EXIT
            GOTO      BATRW999
          ENDIF
.
          MATCH     PMEBBTHN,PMECBATN
          IF        @EQUAL
            MOVE      PMECHOSP,KEY3
            CALL      RDPTHSP1            * read Hospital name for visit
            IF        OVRCD=1
              MOVE      PMECHOSP,HOSPNAME
            ELSE
              MOVE      PTHSNAME,HOSPNAME
            ENDIF
.
            MATCH     SP70,BTSCHOSP
            IF        !@EQUAL&!@EOS
              MATCH     BTSCHOSP,PMECHOSP
              IF        !@EQUAL
                MOVE      ONE,EXIT
                GOTO      BATRW999
              ENDIF
            ENDIF
          ELSE
            MOVE      ONE,EXIT
            GOTO      BATRW999
          ENDIF
.
BATRW500  WRITE     HTMLFILE;"<tr><td nowrap>":
                             "<A HREF='javascript:updateParent":
                             "(#"",PMEBBTHN,"#")'>":
                             PMEBBTHN,"</a></td>";
.
          IF        IBCNMHOS=1
            WRITE     HTMLFILE;"<td>",HOSPNAME,"&nbsp;</td>";
          ENDIF
.
          WRITE     HTMLFILE;"<td>",PMEBHFND,"&nbsp;</td>":
                             "<td>",KEY11,"</td>":
                             "<td>",DIM5,"</td>":
                             "</tr>";
.
BATRW999  RETURN
.-------------------------------------------------------------
. Link to Prev Group
.-------------------------------------------------------------
PREVBT00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM-NORECORD,F3
          IF        F3<0
            MOVE      ZERO,F3
          ENDIF
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",F2:
                             "&template=",FLDPARA:
                             "&startnum=",KEY3:
                             "&norecord=",KEY2:
                             "&btschosp=",BTSCHOSP;
.
PREVBT99  RETURN
.-----------------------------------------------------------
. Link to Next Group
.-----------------------------------------------------------
NEXTBT00  MOVE      NORECORD,KEY2
          REP       " +",KEY2
          ASSIGN    STARTNUM+NORECORD,F3
          MOVE      F3,KEY3
          REP       " +",KEY3
          UNPACK    DIM127,D1,FLDPARA,DIM127
          MOVE      REPORTNO,F2
.
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",F2:
                             "&template=",FLDPARA:
                             "&startnum=",KEY3:
                             "&norecord=",KEY2:
                             "&btschosp=",BTSCHOSP;
.
NEXTBT99  RETURN
.------------------------------------------------------------
. Output Next Page Based on CGI Parameter nextpage
.------------------------------------------------------------
NXTPAG00  MOVE      ZERO,F1
          MOVE      NEXTPAGE,F1
          BRANCH    F1,NXTPAG10,NXTPAG20,NXTPAG30,NXTPAG40,NXTPAG50:
                       NXTPAG60,NXTPAG70,NXTPAG80,NXTPAG90
.  
          CALL      WINCLS00
          GOTO      NXTPAG99
.         
NXTPAG10  CALL      RDIREC00
          GOTO      NXTPAG99
.                            
NXTPAG20  CALL      GOBACK00      * Go Back 1 Html page
          GOTO      NXTPAG99 
.         
NXTPAG30  CALL      DAH20000      * Go Back 2 html pages
          GOTO      NXTPAG99
.
NXTPAG40  CALL      GOBACK00
          GOTO      NXTPAG99
.
NXTPAG50  CALL      PREDIR00
          GOTO      NXTPAG99
.
NXTPAG60  CALL      RELOAD00
          GOTO      NXTPAG99
.
NXTPAG70  CALL      WINEXT00
          GOTO      NXTPAG99
.
NXTPAG80  CALL      RELSKC00
          GOTO      NXTPAG99
.
NXTPAG90  CALL      PAREDR00
          GOTO      NXTPAG99
.
NXTPAG99  RETURN
.
.-------------------------------------------------------------------------------
.  Goes back 1 page
.-------------------------------------------------------------------------------
GOBACK00  CALL      OPENHTML
          BRANCH    EXIT,GOBACK99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#"",WEBTITLE,"#");":
                             "    self.close();":
                             "    opener.history.go(-1);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
GOBACK99  RETURN
.*****************************************************************************
.*                          MINV0000                                         *
.*****************************************************************************
.
.         First, get the last EDI History record for this invoice
.
MINV0000  PACK      KEY26,MAVINVCE,Z70
          CALL      RSPMECA1                     * position on last history rec
          CALL      RPPMECA1                     * read previous record
          BRANCH    OVRCD,MINV3000               * eof - finished
.
          MATCH     MAVINVCE,PMEAINVN            * same invoice still ?
          GOTO      MINV3000 IF NOT EQUAL        * no - finished
.
.         Read pmsectaf
.
          PACK      KEY16,MAVINVCE,MAVBATCH,SP70
          CALL      RDPMECT2
          BRANCH    OVRCD,MINV3000
.
.         The last EDI history record has been found for the invoice, so
.         write a new record, defaulting some of the values from the read
.         record.
.
          MOVE      MAVBATCH,PMEABATN
          MOVE      MAVINVCE,PMEAINVN
.
MINV1000  CALL      IBACLOCK                     * get current date/time
          PACK      PMEADATE,CCC,CYY,CMM,CDD
          REP       " 0",PMEADATE
          MOVE      CTIMEIS,PMEATIME
          REP       " 0",PMEATIME
.
          MOVE      " 5",PMEATYPE
          MOVE      WBSEUID,PMEAOPER
          MOVE      SP70,PMEASPAR
.
          PACK      KEY26,PMEAINVN,PMEADATE,PMEATIME,PMEATYPE,SP70
          CALL      RAPMECA1
          IF        OVRCD = 1
            CALL      WRPMECA1                   * write EDI History record
          ELSE
            GOTO      MINV1000
          ENDIF
.
.         If the record has a status of "Health Fund Unverified",
.         "Error (SA validation)" or "Health Fund Rejected - Reported"
.         then update the status to "Closed", as the claim cannot go any
.         further (unless resubmitted after closing).
.
          IF        PMECFLAG = 3 | PMECFLAG = 5 | PMECFLAG = 12
      PACK      KEY35,PMECHOSP,PMECFLAG,PMECHFND,PMECADMN,PMECINVN,PMECBATN,SP70
            CALL      RDPMECT1                   * read selected record
            BRANCH    OVRCD,MINV3000             * shouldn't happen
.
            MOVE      TEN5,PMECFLAG              * update to "closed"
            CALL      UPPMECT1
.
.           Also write an EDI History record (pmsecaaf) for the close
.
            MOVE      PMECINVN,PMEAINVN
            MOVE      PMECBATN,PMEABATN
            MOVE      TEN5,PMEASTAT
            MOVE      " 5",PMEATYPE
            MOVE      WBSEUID,PMEAOPER
            MOVE      PMECTRID,PMEATRID
            MOVE      SP30,PMEASPAR
.
MINV2000    CALL      IBACLOCK                   * get current time
            PACK      PMEADATE,CCC,CYY,CMM,CDD
            REP       " 0",PMEADATE
            MOVE      CTIMEIS,PMEATIME
            REP       " 0",PMEATIME
.
            PACK      KEY26,PMEAINVN,PMEADATE,PMEATIME,PMEATYPE,SP70
            CALL      RAPMECA1
            IF        OVRCD = 1
              CALL      WRPMECA1
            ELSE
              GOTO      MINV2000
            ENDIF
.
            GOTO      MINV9000
          ELSE
            GOTO      MINV9000
          ENDIF
.
MINV3000  MOVE      "Claim not yet extracted.",WEBTITLE
          CALL      WEBERR00
          GOTO      MINV9100
.
MINV9000  MOVE      ZERO,EXIT
          GOTO      MINV9999
.
MINV9100  MOVE      ONE,EXIT
.
MINV9999  RETURN
+
.*****************************************************************************
.*                          RSET0000                                         *
.*****************************************************************************
.
.         First, get the last EDI History record for this invoice
.
RSET0000  PACK      KEY26,MAVINVCE,Z70
          CALL      RSPMECA1                     * position on last history rec
          CALL      RPPMECA1                     * read previous record
          BRANCH    OVRCD,RSET3000               * eof - finished
.
          MATCH     MAVINVCE,PMEAINVN            * same invoice still ?
          GOTO      RSET3000 IF NOT EQUAL        * no - finished
.
.         Read pmsectaf
.
          PACK      KEY16,MAVINVCE,MAVBATCH,SP70
          CALL      RDPMECT2
          BRANCH    OVRCD,RSET3000
.
.         If the record has a status of "Health Fund Unverified", then allow
.         the status to be set to "Verified" so it can be processed.
.         If the record has a status of "Assessing" or "Int. Ready", then allow
.         the status to be set to "Closed".
.
          IF        PMECFLAG = 5 | PMECFLAG = 7 | PMECFLAG = 8
      PACK      KEY35,PMECHOSP,PMECFLAG,PMECHFND,PMECADMN,PMECINVN,PMECBATN,SP70
            CALL      RDPMECT1                   * read selected record
            BRANCH    OVRCD,RSET3000             * shouldn't happen
.
            IF        PMECFLAG = 5
              MOVE      SIX,PMECFLAG             * reset to "verified"
            ELSE
              MOVE      TEN5,PMECFLAG            * reset to "closed"
            ENDIF
            CALL      UPPMECT1
.
.           Also write an EDI History record (pmsecaaf) for the reset
.
            MOVE      PMECINVN,PMEAINVN
            MOVE      PMECBATN,PMEABATN
            IF        PMECFLAG = 6
              MOVE      SIX,PMEASTAT
            ELSE
              MOVE      TEN5,PMEASTAT
            ENDIF
            MOVE      " 0",PMEATYPE
            MOVE      WBSEUID,PMEAOPER
            MOVE      PMECTRID,PMEATRID
            MOVE      SP30,PMEAEROR
            IF        PMECFLAG = 6
              MOVE      "Claim reset manually",PMEAEROT
            ELSE
              MOVE      "Claim closed manually",PMEAEROT
            ENDIF
            MOVE      SP30,PMEASPAR
.
RSET2000    CALL      IBACLOCK                   * get current time
            PACK      PMEADATE,CCC,CYY,CMM,CDD
            REP       " 0",PMEADATE
            MOVE      CTIMEIS,PMEATIME
            REP       " 0",PMEATIME
.
            PACK      KEY26,PMEAINVN,PMEADATE,PMEATIME,PMEATYPE,SP70
            CALL      RAPMECA1
            IF        OVRCD = 1
              CALL      WRPMECA1
            ELSE
              GOTO      RSET2000
            ENDIF
.
            GOTO      RSET9000
          ELSE
            GOTO      RSET9000
          ENDIF
.
RSET3000  MOVE      "Claim not yet extracted.",WEBTITLE
          CALL      WEBERR00
          GOTO      RSET9100
.
RSET9000  MOVE      ZERO,EXIT
          GOTO      RSET9999
.
RSET9100  MOVE      ONE,EXIT
.
RSET9999  RETURN
+
.*****************************************************************************
.*                          RSBI0000                                         *
.*****************************************************************************
RSBI0000  MOVE      ZERO,RSUBINDI
.
          MATCH     SP8,PMECNBAT                 * next batch blank ?
          GOTO      RSBI9000 IF NOT EQUAL
.
.         Only allow resubmission of claims with a "closed" status, or a
.         status of "SA Validation Error"
.
          IF        PMECFLAG <> 15 & PMECFLAG <> 3
            GOTO      RSBI9000
          ENDIF
.
.         Only allow resubmission of claims which have an outstanding amount
.         owing on the invoice
.
          PACK      KEY8,PMECINVN,SP70
          CALL      RDINV1
          BRANCH    OVRCD,RSBI9000
.
          CALL      GBAL0000                     * get outstanding inv. balance
.
.         If the invoice is balanced or overpaid and it is not a zero invoice,
.         then don't allow resubmission
.
          IF        (FORM7P2O <= 0) & (PINVAMT > 0)
            GOTO      RSBI9000
          ENDIF
.
          PACK      KEY16,PMECINVN,SP70
          CALL      RAPMECT2                     * claim already waiting ?
          IF        OVRCD = 0
            GOTO      RSBI9000
          ENDIF
.
          GOTO      RSBI9999
.
RSBI9000  MOVE      ONE,RSUBINDI
RSBI9999  RETURN
.*****************************************************************************
.*                          GBAL0000               Called by: Lots           *
.*                Get the current invoice outstanding balance                *
.* Requires:  Valid read on pmsectaf record                                  *
.* Returns:   FORM7P2O - Outstanding invoice amount                          *
.*****************************************************************************
.
GBAL0000  MOVE      ZERO,FORM7P2O                * initialise outst. amount
.
.         Get the invoice record
.
          MOVE      PMECINVN,KEY8
          CALL      RDINV1
          IF        OVRCD = 1
            GOTO      GBAL9999
          ENDIF
.
.         Calculate the current amount outstanding from the invoice details
.
          ASSIGN    (PINVAMT+PINVPATA+PINVHFDA+PINVOTHA+PINVJOUR+PTINCRTT),FORM7P2O
          IF        IBCNUGST=2
            ADD       PTINGSTJ,FORM7P2O
          ENDIF      
.
GBAL9999  RETURN
+
.*****************************************************************************
.*                               RSUB0000                                    *
.*                  Process resubmission selection                           *
.*****************************************************************************
RSUB0000  MOVE      ZERO,EXIT
.
          PACK      KEY16,MAVINVCE,MAVBATCH,SP70
          CALL      RDPMECT2
          BRANCH    OVRCD,RSUB7000
.
.         Check if the record has already been resubmitted
.
          MATCH     SP8,PMECNBAT                 * next batch blank ?
          IF        !@EQUAL
            GOTO      RSUB8000
          ENDIF
.
.         Only allow resubmission of claims with a "closed" status, or a
.         status of "SA Validation Error"
.
.         IF        PMECFLAG <> 15 & PMECFLAG <> 3
.           GOTO      RSUB7000
.         ENDIF
.
          IF        PMECFLAG = 15 | PMECFLAG = 3
.
            PACK      KEY26,PMECINVN,Z70
            CALL      RSPMECA1
RSUB2100    CALL      RPPMECA1
            BRANCH    OVRCD,RSUB2500
.
            MATCH     PMECINVN,PMEAINVN
            GOTO      RSUB2500 IF NOT EQUAL
.
            MATCH     PMECTRID,PMEATRID
            GOTO      RSUB2100 IF NOT EQUAL
.
            COMPARE   THREE,PMEASTAT
            GOTO      RSUB2100 IF NOT EQUAL
.
            MATCH     " 6",PMEATYPE
            GOTO      RSUB2100 IF NOT EQUAL
.
            MATCH     "3002",PMEAEROR
            GOTO      RSUB2100 IF NOT EQUAL
.
            MOVE      ZERO,FORM8A
.
            CALL      IBACLOCK
.
            PACK      CURRDATE,CCC,CYY,CMM,CDD
            REP       " 0",CURRDATE
.
            DAYSEP    PMEADATE,CURRDATE,FORM8A
.
            COMPARE   FORM8A,ONE
            GOTO      RSUB2500 IF EQUAL
            GOTO      RSUB2500 IF LESS
.
            GOTO      RSUB7500
.
          ENDIF
.
.         Only allow resubmission of claims which have an outstanding amount
.         owing on the invoice
.
RSUB2500  PACK      KEY8,PMECINVN,SP70
          CALL      RDINV1
          IF        OVRCD = 1
            GOTO      RSUB6000
          ENDIF
.
          CALL      GBAL0000                     * get outstanding inv. balance
.
.         If the invoice is balanced or overpaid and it is not a zero invoice,
.         then don't allow resubmission (CAR 181439)
.
.         IF        (FORM7P2O <= 0) & (PINVAMT > 0)
.           GOTO      RSUB5000
.         ENDIF
.
          PACK      KEY16,PMECINVN,SP8
          CALL      RAPMECT2                     * claim already waiting ?
          IF        OVRCD = 0
            GOTO      RSUB4000
          ENDIF
.
          MOVE      ZERO,PMECFLAG
          MOVE      SP8,PMECBATN
          MOVE      MAVBATCH,PMECPBAT
          MOVE      SP8,PMECNBAT
          MOVE      SP1,PMECCCFL
          MOVE      SP30,PMECTRID
          MOVE      ZERO,PMECAMTC
          MOVE      ZERO,PMECAMTP
          MOVE      SP8,PMECPDAT
          MOVE      SP2,PMECSTAT
          MOVE      SP30,PMECFTID
          MOVE      SP30,PMECSPAR
.
          PACK      KEY16,PMECINVN,PMECBATN,SP70 
          CALL      RAPMECT2                     
          IF        OVRCD = 1
            CALL      WRPMECT1                   * write record
          ELSE      
            GOTO      RSUB4000
          ENDIF     
.
.         Update the selected record with the next batch no. of "00000000".
.         The record will either have a status of "closed" already, or
.         "SA Validation Error".  If it's the latter, then update the status to
.         "closed" as well"
.
.         PACK      KEY35,PMECHOSP,TEN5,PMECHFND,PMECADMN,PMECINVN,MAVBATCH,SP70
.         CALL      RDPMECT1
.         IF        OVRCD = 1
.    PACK      KEY35,PMECHOSP,SP1,THREE,PMECHFND,PMECADMN,PMECINVN,MAVBATCH,SP70
.           CALL      RDPMECT1
.           IF        OVRCD = 1
.             GOTO      RSUB3000
.           ELSE
.             MOVE      TEN5,PMECFLAG            * set status to closed
.           ENDIF
.         ENDIF
.
          PACK      KEY16,PMECINVN,MAVBATCH,SP70
          CALL      RDPMECT2
          IF        OVRCD = 1
            CALL      RSUB3000                   * write record
          ELSE
            MOVE      TEN5,PMECFLAG            * set status to closed
          ENDIF
.
          MOVE      "00000000",PMECNBAT
          CALL      UPPMECT2
.
          GOTO      RSUB9999
.
RSUB3000  CLEAR     WEBTITLE
          APPEND    "Error updating Invoice ",WEBTITLE
          APPEND    PMECINVN,WEBTITLE
          APPEND    " Batch ",WEBTITLE
          APPEND    PMECBATN,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      RSUB9000
.
RSUB4000  MOVE      "Invoice already waiting for extraction.",WEBTITLE
          CALL      WEBERR00
          GOTO      RSUB9000
.
RSUB5000  MOVE      "Claim fully paid.",WEBTITLE
          CALL      WEBERR00
          GOTO      RSUB9000
.
RSUB6000  CLEAR     WEBTITLE
          APPEND    "Invoice ",WEBTITLE
          APPEND    PMECINVN,WEBTITLE
          APPEND    " not found.",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      RSUB9000
.
RSUB7000  MOVE      "Claim not not available for resubmission.",WEBTITLE
          CALL      WEBERR00
          GOTO      RSUB9000
.
RSUB7500  MOVE      "Error 3002. Claim not available for resubmission.",WEBTITLE
          CALL      WEBERR00
          GOTO      RSUB9000
.
RSUB8000  MOVE      "Invoice already resubmitted.",WEBTITLE
          CALL      WEBERR00
          GOTO      RSUB9000
.
RSUB9000  MOVE      ONE,EXIT
RSUB9999  RETURN
.*****************************************************************************
.*                               WDEL0000                                    *
.*                  Process delete records waiting                           *
.*****************************************************************************
WDEL0000  MOVE      ZERO,EXIT
.
          PACK      KEY16,MAVINVCE,MAVBATCH,SP70
          CALL      RDPMECT2
          BRANCH    OVRCD,WDEL8000          
.
          MOVE      PMECINVN,TEMPINVN            
          MOVE      PMECBATN,TEMPBATN            
          MOVE      PMECADMN,TEMPADMN
          MOVE      PMECURNO,TEMPURNO
          MOVE      PMECHFND,TEMPHFND
          MOVE      PMECPBAT,TEMPPBAT
          MOVE      PMECHOSP,TEMPHOSP
.
          MATCH     SP70,TEMPPBAT
          GOTO      WDEL1000 IF EQUAL
          GOTO      WDEL1000 IF EOS
.
          PACK      KEY35,TEMPHOSP,TEN5,TEMPHFND,TEMPADMN,TEMPINVN,TEMPPBAT,SP70
          CALL      RDPMECT1
          IF        OVRCD = 1
            GOTO      WDEL7000
          ELSE
            MOVE      SP70,PMECNBAT
            CALL      UPPMECT1
          ENDIF 
.
.         Delete the selected record
.
WDEL1000  PACK      KEY35,TEMPHOSP,SP1,ZERO,TEMPHFND,TEMPADMN,TEMPINVN,TEMPBATN
          CALL      DEPMECT1
.
          GOTO      WDEL9999
.
WDEL7000  CLEAR     WEBTITLE
          APPEND    "Error updating previous claim ",WEBTITLE
          APPEND    PMECINVN,WEBTITLE
          APPEND    " Batch ",WEBTITLE
          APPEND    PMECBATN,WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          GOTO      WDEL9000
.
WDEL8000  MOVE      "Record cannot be deleted.",WEBTITLE
          CALL      WEBERR00 
          GOTO      WDEL9000
.
WDEL9000  MOVE      ONE,EXIT
WDEL9999  RETURN
.*******************************************************************************
.                         Goes back 1 page
.*******************************************************************************
RELOAD00  CALL      OPENHTML
          BRANCH    EXIT,RELOAD99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
.                            "    alert(#"",WEBTITLE,"#");":
                             "    history.go(-1);":
.                            "    location.reload();":
                             "}":
                             "</script>"
          CALL      CLOSHTML
RELOAD99  RETURN
.------------------------------------------------------------
. Eclipse Claim Full Details
.------------------------------------------------------------
ECFD0000  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECFD5000 IF EQUAL
.
          MATCH     ANSC,UPDATETY
          GOTO      ECFD6000 IF EQUAL
.
          GOTO      ECFD9000
.
ECFD5000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,ECFD9100
.
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub 
.
          PACK      KEY16,MAVINVCE,MAVBATCH,SP70
          CALL      RDPMECT2
          BRANCH    OVRCD,ECFD9200
.
          CALL      DFUL0000
.
          CLEAR     WEBTITLE
          MOVE      "Eclipse Claim Full Details",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00
          BRANCH    EXIT,ECFD9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ECFD9999
.
ECFD6000  PACK      KEY16,MAVINVCE,MAVBATCH,SP70
          CALL      RDPMECT2
          BRANCH    OVRCD,ECFD9200
.
          MOVE      TEN5,PMECFLAG
          CALL      UPPMECT2 
.
.         Write a new history (pmsecaaf) record
.
          MOVE      PMECINVN,PMEAINVN
          MOVE      PMECBATN,PMEABATN
          MOVE      TEN5,PMEASTAT
          MOVE      " 5",PMEATYPE
          MOVE      WBSEUID,PMEAOPER
          MOVE      PMECTRID,PMEATRID
          MOVE      SP70,PMEAEROR
          MOVE      SP70,PMEAEROT
          MOVE      SP70,PMEASPAR
.
          CALL      IBACLOCK                     * get current date/time
          PACK      PMEADATE,CCC,CYY,CMM,CDD
          REP       " 0",PMEADATE
          MOVE      CTIMEIS,PMEATIME
          REP       " 0",PMEATIME
.
          PACK      KEY26,PMEAINVN,PMEADATE,PMEATIME,PMEATYPE,SP70
          CALL      RAPMECA1
          IF        OVRCD = 1
            CALL      WRPMECA1
          ENDIF
.
          MOVE      SP70,TTYPEARG
          MOVE      " 1",TTYPEARG
          CALL      DELETR00
.
          MOVE      " 3",TTYPEARG
          CALL      DELETR00
.
          MOVE      " 4",TTYPEARG
          CALL      DELETR00
.
          MOVE      " 5",TTYPEARG
          CALL      DELETR00
.
          CALL      DELECO00
.
          MOVE      ZERO,EXIT
          GOTO      ECFD9999
.
ECFD9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECFD9999
.
ECFD9100  MOVE      "Can't find Patient Master details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECFD9999
.
ECFD9200  MOVE      "Can't find Eclipse Claim details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECFD9999
.
ECFD9999  RETURN
.------------------------------------------------------------
. Eclipse Claim Full Details tags
.------------------------------------------------------------
ECFL0000  BRANCH    FLDITMNO,ECFL0100,ECFL0200,ECFL0300,ECFL0400,ECFL0500:
                             ECFL0600,ECFL0700,ECFL0800,ECFL0900,ECFL1000:
                             ECFL1100,ECFL1200,ECFL1300,ECFL1400,ECFL1500:
                             ECFL1600,ECFL1700,ECFL1800,ECFL1900,ECFL2000:
                             ECFL2100,ECFL2200,ECFL2300,ECFL2400,ECFL2500:
                             ECFL2600,ECFL2700,ECFL2800,ECFL2900
.
          GOTO      ECFL9999
.
ECFL0100  WRITE     HTMLFILE;FORM7P2O;
          GOTO      ECFL9999
.
ECFL0200  WRITE     HTMLFILE;STATDESC;
          GOTO      ECFL9999
.
ECFL0300  WRITE     HTMLFILE;CONTDESC;
          GOTO      ECFL9999
.
ECFL0400  MATCH     SP70,PMECPDAT
          GOTO      ECFL9999 IF EQUAL
          UNPACK    PMECPDAT,CCENT,CYEAR,CMON,CDAY  * Payment Date
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ECFL9999
.
ECFL0500  WRITE     HTMLFILE;PMECEETP;
          GOTO      ECFL9999
.
ECFL0600  IF        PMECEETP=0
            UNPACK    DIM127,D1,KEY1,DIM127
            PACK      KEY14,PMECHFND,ZERO,ZERO,ZERO,ZERO,SP70
            CALL      RDFUND1
            IF        OVRCD=0
            WRITE     HTMLFILE;HFNAME;
            ELSE
              WRITE     HTMLFILE;AFUNDH;
            ENDIF
            WRITE     HTMLFILE;" / ";
            PACK      KEY14 WITH PMECHFND,AFNDTB,SP70
            CALL      RDFUND1
            IF        OVRCD=0
              WRITE     HTMLFILE;HFNAME;      * Description of Table
            ELSE
              WRITE     HTMLFILE;AFNDTB;      * Table code
            ENDIF
          ELSE
            MOVE      "CL",CATEGORY
            MOVE      PMECHFND,CODE
            CALL      CODITM00
          ENDIF
          GOTO      ECFL9999
.
ECFL0700  WRITE     HTMLFILE;PMECINVN;
          GOTO      ECFL9999
.
ECFL0800  WRITE     HTMLFILE;PMECBATN;
          GOTO      ECFL9999
.
ECFL0900  WRITE     HTMLFILE;PMECPBAT;
          GOTO      ECFL9999
.
ECFL1000  WRITE     HTMLFILE;PMECNBAT;
          GOTO      ECFL9999
.
ECFL1100  WRITE     HTMLFILE;PMECTRID;
          GOTO      ECFL9999
.
ECFL1200  WRITE     HTMLFILE;PMECFTID;
          GOTO      ECFL9999
.
ECFL1300  WRITE     HTMLFILE;PMECAMTC;
          GOTO      ECFL9999
.
ECFL1400  WRITE     HTMLFILE;PINVAMT;
          GOTO      ECFL9999
.
ECFL1500  WRITE     HTMLFILE;PINVPATA;
          GOTO      ECFL9999
.
ECFL1600  WRITE     HTMLFILE;PINVHFDA;
          GOTO      ECFL9999
.
ECFL1700  WRITE     HTMLFILE;PINVOTHA;
          GOTO      ECFL9999
.
ECFL1800  WRITE     HTMLFILE;PINVJOUR;
          GOTO      ECFL9999
.
ECFL1900  WRITE     HTMLFILE;PMECAMTP;
          GOTO      ECFL9999
.
ECFL2000  MATCH     SP70,PMECSTAT                 * blank status ?
          GOTO      ECFL9999 IF EQUAL            * yes - don't display anything
          GOTO      ECFL9999 IF EOS 
.
          MATCH     " 0",PMECSTAT                * closed without pymt or w/o
          IF        @EQUAL
            WRITE     HTMLFILE;"No Payment or Write-Off";
            GOTO      ECFL9999
          ENDIF
.
          MATCH     " 1",PMECSTAT                * closed with write-off only
          IF        @EQUAL
            WRITE     HTMLFILE;"Write-Off Only";
            GOTO      ECFL9999
          ENDIF
.
          MATCH     " 2",PMECSTAT                * closed with payment only
          IF        @EQUAL
            WRITE     HTMLFILE;"Payment Only";
            GOTO      ECFL9999
          ENDIF
.
          MATCH     " 3",PMECSTAT                * closed with payment & w/o
          IF        @EQUAL
            WRITE     HTMLFILE;"Payment & Write-Off";
            GOTO      ECFL9999
          ENDIF
.
          GOTO      ECFL9999
.
ECFL2100  CALL      EDIH0000
          GOTO      ECFL9999
.
ECFL2200  CALL      EDIP0000
          GOTO      ECFL9999
.
ECFL2300  CALL      EDCE0000
          GOTO      ECFL9999
.
ECFL2400  CALL      EDSD0000
          GOTO      ECFL9999
.
ECFL2500  CALL      EDSE0000
          GOTO      ECFL9999
.
ECFL2600  WRITE     HTMLFILE;PTINCRTT;
          GOTO      ECFL9999
.
ECFL2700  WRITE     HTMLFILE;CFEETYP;
          GOTO      ECFL9999
.
ECFL2800  WRITE     HTMLFILE;PMECFLAG;
          GOTO      ECFL9999
.
ECFL2900  PACK      SAVKEY24,PMECADMN,PMECINVN,PMECBATN,SP70
          MOVE      PMECADMN,SAVEVISN
          MOVE      PMECTRID,SAVETRID
.
          PACK      KEY24,PMECADMN,SP70
          CALL      RSPMECT4
ECFL2910  CALL      RKPMECT4
          BRANCH    OVRCD,ECFL2999
.
          MATCH     SAVEVISN,PMECADMN
          GOTO      ECFL2999 IF NOT EQUAL                    
.
          MATCH     SAVETRID,PMECPCTI
          GOTO      ECFL2910 IF NOT EQUAL
.
          WRITE     HTMLFILE;ONE;
.
ECFL2999  PACK      KEY24,SAVKEY24,SP70
          CALL      RDPMECT4
.
          GOTO      ECFL9999
.
ECFL9999  RETURN
.*****************************************************************************
.*                          DFUL0000                                         *
.*****************************************************************************
.
DFUL0000  CALL      GBAL0000                     * get outstanding inv. balance
.
          MOVE      STATUS00,STATDESC
          LOAD      STATDESC,PMECFLAG,STATUS01,STATUS02,STATUS03,STATUS04:
                                      STATUS05,STATUS06,STATUS07,STATUS08:
                                      STATUS09,STATUS10,STATUS11,STATUS12:
                                      STATUS13,STATUS14,STATUS15
.
          MOVE      "Unknown         ",CONTDESC
          MOVE      PMECCCFL,ANS
          REP       "N1F2L3M4",ANS
          MOVE      ANS,FORM1
          LOAD      CONTDESC,FORM1,CONTDES1,CONTDES2,CONTDES3,CONTDES4
.
DFUL9999  RETURN
+
.------------------------------------------------------------
. Table of EDI History
.------------------------------------------------------------
EDIH0000  MOVE      ZERO,LOOPCNTR
.
          CALL      EDIHD000      * Output Table Heading
.
          PACK      KEY34,MAVINVCE,Z70
          CALL      RSPMECA3
EDIH1000  CALL      RPPMECA3
          BRANCH    OVRCD,EDIH9999
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 500)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
          MATCH     MAVINVCE,PMEAINVN
          GOTO      EDIH9999 IF NOT EQUAL
.
          CALL      EDIRW000
.
          GOTO      EDIH1000
.
EDIH9999  RETURN
.------------------------------------------------------------
. EDI History (TABLE HEADING)
.------------------------------------------------------------
EDIHD000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=10%>":
                             "Date</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Time</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Status</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=15%>":
                             "Transaction Type</td>":
                             "<td class=HeadingCell width=5%>":
                             "Batch</td>":
                             "<td class=HeadingCell width=15%>":
                             "Reviewed By</td>":
                             "<td class=HeadingCell width=35%>":
                             "Error Code Description</td>":
                             "</tr>"
.
EDIHD999  RETURN
.------------------------------------------------------------
. EDI History (Detail Row)
.------------------------------------------------------------
EDIRW000  MOVE      SP70,DIM11
          MATCH     SP70,PMEADATE
          IF        !@EQUAL & !@EOS
            UNPACK    PMEADATE,CCENT,CYEAR,CMON,CDAY                 
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP70
          ENDIF
.
          MOVE      STATUS00,STATDESC
          LOAD      STATDESC,PMEASTAT,STATUS01,STATUS02,STATUS03,STATUS04:
                                      STATUS05,STATUS06,STATUS07,STATUS08:
                                      STATUS09,STATUS10,STATUS11,STATUS12:
                                      STATUS13,STATUS14,STATUS15
.
          MOVE      SP30,TYPEDESC
          MOVE      PMEATYPE,TYPOFREQ
          LOAD      TYPEDESC,TYPOFREQ,TYPEDES1,TYPEDES2,TYPEDES3,TYPEDES4:
                                      TYPEDES5,TYPEDES6,TYPEDES7
          IF        TYPOFREQ = 6 | TYPOFREQ = 7
            STRIP     TYPEDESC
            ENDSET    TYPEDESC
            APPEND    SP1,TYPEDESC
            APPEND    PMEAEROR,TYPEDESC
            APPEND    SP20,TYPEDESC
            RESET     TYPEDESC
          ENDIF
.
          MOVE      SP70,DIM30
          PACK      KEY10,PMEAOPER,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMEAOPER,DIM30
          ELSE
            MATCH     PMEAOPER,WBSEUID
            IF        @EQUAL
              MOVE      WBSENAM,DIM30
            ELSE
              MOVE      PMEAOPER,DIM30
            ENDIF
          ENDIF
.
          CMATCH    NULL,PMEAEROT
          IF        @EQUAL
            PACK      PMEAEROT,SP70,SP70
          ENDIF
.
          WRITE     HTMLFILE;"<tr><td>",DIM11 ,"</td>";
          WRITE     HTMLFILE;"<td>",PMEATIME,"</td>";
          WRITE     HTMLFILE;"<td>",STATDESC,"</td>":
                             "<td>",TYPEDESC,"</td>":
                             "<td>",PMEABATN,"</td>":
                             "<td>",DIM30,"</td>":
                             "<td>",PMEAEROT,"</td>":
                             "</tr>";
.
EDIRW999  RETURN
.------------------------------------------------------------
. Table of EDI Assessment Report
.------------------------------------------------------------
EDIP0000  CALL      EDIPHD00      * Output Table Heading
.
          PACK      KEY62,PMECTRID,Z70
          CALL      RSPMEAH2
EDIP1000  CALL      RPPMEAH2
          BRANCH    OVRCD,EDIP9999
.
          MATCH     PMECTRID,PMAHFTID
          GOTO      EDIP9999 IF NOT EQUAL
.
          CALL      EDIPRW00
.
          GOTO      EDIP1000
.
EDIP9999  RETURN
.------------------------------------------------------------
. EDI Assessment Report (TABLE HEADING)
.------------------------------------------------------------
EDIPHD00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=10%>":
                             "Status</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Code</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Reference Id</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Claimed Amt</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Benefit Amount</td>":
                             "<td class=HeadingCell width=10%>":
                             "Excess Amt</td>":
                             "<td class=HeadingCell width=10%>":
                             "CoPayment Amt</td>":
                             "<td class=HeadingCell width=10%>":
                             "Explanations</td>":
                             "<td class=HeadingCell width=10%>":
                             "Service Details</td>":
                             "</tr>"
.                            
EDIPHD99  RETURN
.
.------------------------------------------------------------
. EDI Assessment Report (Detail Row)
.------------------------------------------------------------
EDIPRW00  MOVE      ZERO,FORM1
          MOVE      "Unknown",ASESDESC
          MOVE      PMAHCFAC,ANS
          REP       "A1R2W3C4I5",ANS
          MOVE      ANS,FORM1
          LOAD      ASESDESC,FORM1,ASESDES1,ASESDES2,ASESDES3,ASESDES4,ASESDES5
. 
          WRITE     HTMLFILE;"<tr><td>",PMAHFSCD,"</td>";
          WRITE     HTMLFILE;"<td>",ASESDESC,"</td>";
          WRITE     HTMLFILE;"<td>",PMAHFRID,"</td>";
.
          UNPACK    PMAHTCAM,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
.
          UNPACK    PMAHTBAM,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
.
          UNPACK    PMAHEXAM,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
.
          UNPACK    PMAHCPAM,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
.
          WRITE     HTMLFILE;"<td><img src=#"../images/CommentIcon.gif#"":
                             " onclick='location.href=#"patweb93.pbl":
                             "?reportno=16":
                             "&template=004":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&mavinvce=",MAVINVCE:
                             "&mavbatch=",MAVBATCH:
                             "&ecclfbid=",PMAHFBID:
                             "&ecclarid=",PMAHARID:
                             "&ecclfrid=",PMAHFRID:
                             "&ecclrptc=",PMAHRPTC,"#";'>":
                             "</td>";
.
          WRITE     HTMLFILE;"<td><img src=#"../images/CommentIcon.gif#"":
                             " onclick='location.href=#"patweb93.pbl":
                             "?reportno=16":
                             "&template=005":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&mavinvce=",MAVINVCE:
                             "&mavbatch=",MAVBATCH:
                             "&ecclfbid=",PMAHFBID:
                             "&ecclarid=",PMAHARID:
                             "&ecclfrid=",PMAHFRID:
                             "&ecclrptc=",PMAHRPTC,"#";'>":
                             "</td>":
                             "</tr>";
.
EDIPRW99  RETURN
.------------------------------------------------------------
. Table of EDI Claim Explanation
.------------------------------------------------------------
EDCE0000  CALL      EDCEHD00      * Output Table Heading
.
          PACK      KEY45,ECCLFBID,ECCLARID,ECCLFRID,ECCLRPTC,SP70
          CALL      RSPMEAD1                     * position in file
EDCE1000  CALL      RKPMEAD1                     * read next record
          BRANCH    OVRCD,EDCE9999               * end of file
.
          MATCH     ECCLFBID,PMADFBID            * same fund brand id ?
          GOTO      EDCE9999 IF NOT EQUAL        * no - finished listing
.
          MATCH     ECCLARID,PMADARID            * same account ref. id ?
          GOTO      EDCE9999 IF NOT EQUAL        * no - finished listing
.
          PACK      PMADFRID,PMADFRID,SP70
.
          MATCH     ECCLFRID,PMADFRID            * same fund ref. id ?
          GOTO      EDCE1000 IF NOT EQUAL        * no - finished listing
.
          PACK      PMADRPTC,PMADRPTC,SP70
.
          MATCH     ECCLRPTC,PMADRPTC            * same report counter ?
          GOTO      EDCE1000 IF NOT EQUAL        * no - finished listing
.
          CALL      EDCERW00
.
          GOTO      EDCE1000
.
EDCE9999  RETURN
.
.------------------------------------------------------------
. EDI Claim Explanation (TABLE HEADING)
.------------------------------------------------------------
EDCEHD00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=10%>":
                             "Code</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Part Id</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=20%>":
                             "Element Name</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=60%>":
                             "Explanation Description</td>":
                             "</tr>"
.
EDCEHD99  RETURN
.------------------------------------------------------------
. EDI Assessment Report (Detail Row)
.------------------------------------------------------------
EDCERW00  WRITE     HTMLFILE;"<tr><td>",PMADCFEC,"</td>";
          WRITE     HTMLFILE;"<td>",PMADMPID,"</td>";
          WRITE     HTMLFILE;"<td>",PMADELNM,"</td>";
          WRITE     HTMLFILE;"<td>",PMADCFET,"</td>":
                             "</tr>";
.
EDCERW99  RETURN
.------------------------------------------------------------
. Table of EDI Service Details  
.------------------------------------------------------------
EDSD0000  CALL      EDSDHD00      * Output Table Heading
.           
          PACK      KEY52,ECCLFBID,ECCLARID,ECCLFRID,ECCLRPTC,SP70
          CALL      RSPMESH1                     * position in file
EDSD1000  CALL      RKPMESH1                     * read next record
          BRANCH    OVRCD,EDSD9999               * end of file
.
          MATCH     ECCLFBID,PMSHFBID            * same fund brand id ?
          GOTO      EDSD9999 IF NOT EQUAL        * no - finished listing
.
          MATCH     ECCLARID,PMSHARID            * same account ref. id ?
          GOTO      EDSD9999 IF NOT EQUAL        * no - finished listing
.
          MATCH     ECCLFRID,PMSHFRID            * same fund ref. id ?
          GOTO      EDSD9999 IF NOT EQUAL        * no - finished listing
.
          MATCH     ECCLRPTC,PMSHRPTC            * same report counter ?
          GOTO      EDSD9999 IF NOT EQUAL        * no - finished listing
.
          CALL      EDSDRW00
.
          GOTO      EDSD1000
.
EDSD9999  RETURN
.------------------------------------------------------------
. EDI Service Details (TABLE HEADING)
.------------------------------------------------------------
EDSDHD00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=10%>":
                             "Service Code</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=5%>":
                             "Services</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Charge Amt</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Benefit Amt</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "From Date</td>":
                             "<td class=HeadingCell width=10%>":
                             "To Date</td>":
                             "<td class=HeadingCell width=10%>":
                             "Service Date</td>":
                             "<td class=HeadingCell width=30%>":
                             "Service Description</td>":
                             "<td class=HeadingCell width=5%>":
                             "Explanation</td>":
                             "</tr>"
.
EDSDHD99  RETURN
.------------------------------------------------------------
. EDI Service Details (Detail Row)
.------------------------------------------------------------
EDSDRW00  WRITE     HTMLFILE;"<tr><td>",PMSHSCOD,"</td>";
          WRITE     HTMLFILE;"<td>",PMSHNOSV,"</td>";
.
          UNPACK    PMSHCAMT,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
.
          UNPACK    PMSHFBAM,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
.
          MOVE      SP70,DIM11
          MATCH     SP70,PMSHFDTE
          IF        !@EQUAL & !@EOS
            UNPACK    PMSHFDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
          MOVE      SP70,DIM11
          MATCH     SP70,PMSHTDTE
          IF        !@EQUAL & !@EOS
            UNPACK    PMSHTDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
          MOVE      SP70,DIM11
          MATCH     SP70,PMSHSDTE
          IF        !@EQUAL & !@EOS
            UNPACK    PMSHSDTE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
          WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
          WRITE     HTMLFILE;"<td>",PMSHSDSC,"</td>";
.
          WRITE     HTMLFILE;"<td><img src=#"../images/CommentIcon.gif#"":
                             " onclick='location.href=#"patweb93.pbl":
                             "?reportno=16":
                             "&template=006":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO:
                             "&mavinvce=",MAVINVCE:
                             "&mavbatch=",MAVBATCH:
                             "&ecclfbid=",PMSHFBID:
                             "&ecclarid=",PMSHARID:
                             "&ecclfrid=",PMSHFRID:
                             "&ecclrptc=",PMSHRPTC:
                             "&ecclscod=",PMSHSCOD:
                             "&ecclsrvc=",PMSHSRVC,"#";'>":
                             "</td>":
                             "</tr>";
.
EDSDRW99  RETURN
.------------------------------------------------------------
. Table of EDI Services Explanations
.------------------------------------------------------------
EDSE0000  CALL      EDSEHD00      * Output Table Heading
.
          PACK      KEY59,ECCLFBID,ECCLARID,ECCLFRID,ECCLRPTC,ECCLSCOD,ECCLSRVC:
                          SP70
          CALL      RSPMESD1                     * position in file
EDSE1000  CALL      RKPMESD1                     * read next record
          BRANCH    OVRCD,EDSE9999               * end of file
.
          MATCH     ECCLFBID,PMSDFBID            * same fund brand id ?
          GOTO      EDSE9999 IF NOT EQUAL        * no - finished listing
.
          MATCH     ECCLARID,PMSDARID            * same account ref. id ?
          GOTO      EDSE9999 IF NOT EQUAL        * no - finished listing
.
          MATCH     ECCLFRID,PMSDFRID            * same fund ref. id ?
          GOTO      EDSE9999 IF NOT EQUAL        * no - finished listing
.
          MATCH     ECCLRPTC,PMSDRPTC            * same report counter ?
          GOTO      EDSE9999 IF NOT EQUAL        * no - finished listing
.
          MATCH     ECCLSCOD,PMSDSCOD            * same service code ?
          GOTO      EDSE9999 IF NOT EQUAL        * no - finished listing
.
          MATCH     ECCLSRVC,PMSDSRVC            * same service counter ?
          GOTO      EDSE9999 IF NOT EQUAL        * no - finished listing
.
          CALL      EDSERW00
.
          GOTO      EDSE1000
.
EDSE9999  RETURN
.------------------------------------------------------------
. EDI Service Explanation (TABLE HEADING)
.------------------------------------------------------------
EDSEHD00  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=10%>":
                             "Service Code</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Explanation Code</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Explanation Description</td>":
                             "</tr>"
.
EDSEHD99  RETURN
.------------------------------------------------------------
. EDI Services Explanations (Detail Row)
.------------------------------------------------------------
EDSERW00  WRITE     HTMLFILE;"<tr><td>",PMSDSCOD,"</td>";
          WRITE     HTMLFILE;"<td>",PMSDSFEC,"</td>";
          WRITE     HTMLFILE;"<td>",PMSDSFET,"</td>":
                             "</tr>";
.
EDSERW99  RETURN
.------------------------------------------------------------
. Table of Outstanding Assessment Reports
.------------------------------------------------------------
ECOT0000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,RECCNT
.
          PACK      KEY31,SP70
          CALL      RSPMECO1                     * position in file
ECOT1000  CALL      RKPMECO1                     * read next record
          BRANCH    OVRCD,ECOT9999               * end of file
.
          RJUSTIFY  PMEOINVN
          RJUSTIFY  PMEOBATN
          MOVE      SP70,FORMATNM
          MOVE      SP70,KEY3
          MOVE      SP70,URNUMBER
          MOVE      SP70,ADMISSNO
          PACK      KEY16,PMEOINVN,PMEOBATN,SP70
          CALL      RDPMECT2
          IF        OVRCD=0
            MOVE      PMECURNO,URNUMBER
            MOVE      PMECADMN,ADMISSNO
            CALL      GETPAT00
            CALL      PATLN000
            CALL      PATFLD00
          ELSE
            GOTO      ECOT1000
          ENDIF
.
          MATCH     SP70,HLFDCLTY
          IF        !@EQUAL & !@EOS
            MATCH     HLFDCLTY,PMEOCTYP
            GOTO      ECOT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HLTHFUND
          IF        !@EQUAL & !@EOS
            PACK      HLTHFUND,HLTHFUND,SP70
            MATCH     HLTHFUND,PMEOHFND
            GOTO      ECOT1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,PROCSTAT
          IF        !@EQUAL & !@EOS
            MATCH     PROCSTAT,PMEODFLG
            GOTO      ECOT1000 IF NOT EQUAL
          ENDIF
.
          CALL      ECOTRW00
.
          GOTO      ECOT1000
.
ECOT9999  RETURN
.------------------------------------------------------------
. Table of Outstanding Assessment Reports (Detail Row)
.------------------------------------------------------------
ECOTRW00  REP       " +",URNUMBER
          REP       " +",ADMISSNO
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    URNUMBER,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    ADMISSNO,PATLINK
          RESET     PATLINK
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          WRITE     HTMLFILE;"t.addRow(#"",PMEOHFND,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",URNUMBER,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",PMEOINVN,"#",";
.
          MATCH     "1",PMEODFLG
          IF        @EQUAL
            WRITE     HTMLFILE;"#"<font color=red>closed</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"<input type=checkbox name=otp",DRECCNT:
                               " value='",PMEOHFND,PMEODFLG,PMEOTRID:
                               "' onclick=outprocr(this);>":
                               "#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",PATLINK,"#",";
          WRITE     HTMLFILE;"#"",PMEOTRID,"#",";
          WRITE     HTMLFILE;"#"",KEY3,"#");";
.
ECOTRW99  RETURN
.*****************************************************************************
.*                               OTPC0000                                    *
.*                  Process delete outstanding processing reports            *
.*****************************************************************************
OTPC0000  MOVE      ZERO,EXIT
.
          PACK      KEY31,ECOTFUND,ECOTTYPE,ECOTTRID,SP70
          CALL      RDPMECO1
          BRANCH    OVRCD,OTPC8000
.
          PACK      KEY16,PMEOINVN,PMEOBATN,SP70
          CALL      RDPMECT2
          BRANCH    OVRCD,OTPC7000
.
.         MATCH     PMEOTRID,PMECTRID            * same transaction id still ?
.         GOTO      OTPC7000 IF NOT EQUAL        * no
.
          CALL      CLOS0000
.
          GOTO      OTPC9999
.
OTPC7000  MOVE      "Unable to locate claim record.  ",WEBTITLE
          CALL      WEBERR00
          GOTO      OTPC9000
.
OTPC8000  MOVE      "Unable to locate record to close.  ",WEBTITLE
          CALL      WEBERR00
          GOTO      OTPC9000
.
OTPC9000  MOVE      ONE,EXIT
OTPC9999  RETURN
.
.*****************************************************************************
.*                              CLOS0000           Called by: DOUT0000       *
.*             Close a claim that is still waiting for an outstanding        *
.*             report and for which a remittance report has been received.   *
.*****************************************************************************
.
.         Update the outstanding processing report (pmsecoaf) record
.
CLOS0000  PACK      SKEY31,PMEOHFND,PMEODFLG,PMEOTRID,SP70
.
.         We should only have one record with flag of Open or Closed
.
          MOVE      "1",PMEODFLG                 * set status to "Closed"
          PACK      KEY31,PMEOHFND,PMEODFLG,PMEOTRID,SP70
          CALL      RAPMECO1
          IF        OVRCD=1
            MOVE      SKEY31,KEY31
            CALL      RDPMECO1                    * reposition
            IF        OVRCD=0
              MOVE      "1",PMEODFLG              * set status to "Closed"
              CALL      UPPMECO1                  * update record
            ENDIF
          ELSE
            MOVE      "0",PMEODFLG                * set status to "Open"
            PACK      KEY31,PMEOHFND,PMEODFLG,PMEOTRID,SP70
            CALL      DEPMECO1
          ENDIF
.
.         Update the pmsectaf record
.
          MOVE      TEN5,PMECFLAG                * set status to closed
          PACK      PMECSTAT,SP1,TWO             * set closed with payment
          CALL      UPPMECT2                     * update claim
.
.         Write a new history (pmsecaaf) record
.
          MOVE      PMECINVN,PMEAINVN
          MOVE      PMECBATN,PMEABATN
          MOVE      TEN5,PMEASTAT
          MOVE      " 5",PMEATYPE
          MOVE      WBSEUID,PMEAOPER
          MOVE      PMECTRID,PMEATRID
          MOVE      SP70,PMEAEROR
          MOVE      SP70,PMEAEROT
          MOVE      SP70,PMEASPAR
.
CLOS5000  CALL      IBACLOCK                     * get current date/time
          PACK      PMEADATE,CCC,CYY,CMM,CDD
          REP       " 0",PMEADATE
          MOVE      CTIMEIS,PMEATIME
          REP       " 0",PMEATIME
.
          PACK      KEY26,PMEAINVN,PMEADATE,PMEATIME,PMEATYPE,SP70
          CALL      RAPMECA1
          IF        OVRCD = 1
            CALL      WRPMECA1
          ELSE
            GOTO      CLOS5000
          ENDIF
.
CLOS9999 RETURN
.------------------------------------------------------------
. Eclipse Remittance Advice Enquiries
.------------------------------------------------------------
ECRE0000  RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECRE5000 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      ECRE4000 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      ECRE3000 IF EQUAL
.
          MATCH     "L",UPDATETY
          GOTO      ECRE2000 IF EQUAL
.
          MATCH     "P",UPDATETY
          GOTO      ECRE1000 IF EQUAL
.
          MATCH     "C",UPDATETY
          GOTO      ECRE7000 IF EQUAL
.
          GOTO      ECRE9000 
.
ECRE1000  MOVE      "1",DIM1C
          CALL      PRNREM00
          MOVE      "Print Remittance Report scheduled.",WEBTITLE 
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRE9999
.
ECRE2000  CALL      CREA0000
          CALL      RPAY0000
          CALL      KILL0000
          GOTO      ECRE9999
.
ECRE3000  PACK      KEY61,HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO,SP70
          CALL      RDPMERH1
          BRANCH    OVRCD,ECRE9100
.
          PACK      KEY82,FUNDTRID,ECREADVC,ECREPTNO,ECRETRID,SP70
          CALL      RDPMERD1
          BRANCH    OVRCD,ECRE9200
.
          GOTO      ECRE6000
.
ECRE4000  PACK      KEY61,HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO,SP70
          CALL      RDPMERH1
          BRANCH    OVRCD,ECRE9100
.
          GOTO      ECRE6000
.
ECRE5000  MOVE      TEMPLATE,KEY3
          RJUSTIFY  KEY3
          REP       " 0",KEY3
.
          IF        DEFTALLH=0 & IBCNMHOS=1
            MATCH     SP70,FILTHOSP        
            IF        @EQUAL
              MOVE      WBSEHOSP,FILTHOSP   * Default hospital filter to users
              MOVE      ONE,DEFTALLH        * logged in hospital if this is the
            ENDIF                           * first time opening the page from 
          ENDIF                             * a menu
.
          MATCH     "001",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased Remittance Advice Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "005",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Released Remittance Advice Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "007",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased Remittance Advice Enquiry Only",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
ECRE6000  CALL      WEBHED00
          BRANCH    EXIT,ECRE9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ECRE9999
.
ECRE7000  MATCH     SP70,REMITKEY
          GOTO      ECRE9100 IF EQUAL
          GOTO      ECRE9100 IF EOS
.
          PACK      KEY61,REMITKEY,SP70
          CALL      RDPMERH1
          BRANCH    OVRCD,ECRE9100
.
          MOVE      "2",PMEHSTAT
.
          CALL      UPPMERH1
.       
          MOVE      "ERA Closed without Releasing",WEBTITLE
.         CALL      WEBERR00
          MOVE      ZERO,EXIT
          GOTO      ECRE9999
.
ECRE9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRE9999
.
ECRE9100  MOVE      "Can't find ERA Header details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRE9999 
.
ECRE9200  MOVE      "Can't find ERA Payment details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRE9999 
.
ECRE9999  RETURN
.
.------------------------------------------------------------
. Eclipse Remittance Advice Enquiry tags
.------------------------------------------------------------
ECRL0000  BRANCH    FLDITMNO,ECRL0100,ECRL0200,ECRL0300,ECRL0400,ECRL0500:
                             ECRL0600,ECRL0700,ECRL0800,ECRL0900,ECRL1000:
                             ECRL1100,ECRL1200,ECRL1300,ECRL1400,ECRL1500:
                             ECRL1600,ECRL1700,ECRL1800,ECRL1900,ECRL2000:
                             ECRL2100,ECRL2200,ECRL2300,ECRL2400,ECRL2500:
                             ECRL2600,ECRL2700,ECRL2800,ECRL2900,ECRL3000:
                             ECRL3100,ECRL3200,ECRL3300,ECRL3400,ECRL3500
.
          GOTO      ECRL9999
.
ECRL0100  UNPACK    DIM127,D1,UNRELREM,DIM127
          UNPACK    DIM127,D1,UNRELINQ,DIM127
          UNPACK    DIM127,D1,ERASTATS,DIM127
.
          CALL      ECRH0000           * Set hospital filter and call ECRT0000
          GOTO      ECRL9999
.
ECRL0200  CALL      ECRD0000
          GOTO      ECRL9999
.
ECRL0300  WRITE     HTMLFILE;PMEHRADV;
          GOTO      ECFL9999
.
ECRL0400  WRITE     HTMLFILE;PMEHPNUM;
          GOTO      ECFL9999
.
ECRL0500  WRITE     HTMLFILE;PMEHPTOT;
          GOTO      ECFL9999
.
ECRL0600  MATCH     SP70,PMEHDATE
          GOTO      ECRL9999 IF EQUAL
          UNPACK    PMEHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ECRL9999
.
ECRL0700  WRITE     HTMLFILE;PMEHNAME;
          GOTO      ECRL9999
.
ECRL0800  WRITE     HTMLFILE;PMEHPLID;
          GOTO      ECRL9999
.
ECRL0900  WRITE     HTMLFILE;PMEHBNUM;
          GOTO      ECRL9999
.
ECRL1000  WRITE     HTMLFILE;PMEHBNAM;
          GOTO      ECRL9999
.
ECRL1100  WRITE     HTMLFILE;PMEHBBSB;
          GOTO      ECRL9999
.
ECRL1200  WRITE     HTMLFILE;PMEHPREF;
          GOTO      ECRL9999
.
ECRL1300  UNPACK    PMEHDAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ECRL9999
.
ECRL1400  WRITE     HTMLFILE;PMEHFTID;
          GOTO      ECRL9999
.
ECRL1500  MATCH     "0",PMEHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ECRL9999
          ENDIF
.
          MATCH     "1",PMEHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Partial";
            GOTO      ECRL9999
          ENDIF
.
          MATCH     "2",PMEHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ECRL9999
          ENDIF
.
          MATCH     "3",PMEHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Processing";
            GOTO      ECRL9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ECRL9999
.
ECRL1600  CALL      GCLM0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ECRL9999
.
ECRL1700  CALL      GCLD0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ECRL9999
.
ECRL1800  WRITE     HTMLFILE;PMEDRADV;
          GOTO      ECRL9999
.
ECRL1900  WRITE     HTMLFILE;PMEDPNUM;
          GOTO      ECRL9999
.
ECRL2000  WRITE     HTMLFILE;PMEDTRID;
          GOTO      ECRL9999
.
ECRL2100  WRITE     HTMLFILE;PMEDARID;
          GOTO      ECRL9999
.
ECRL2200  UNPACK    PMEDBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ECRL9999
.
ECRL2300  WRITE     HTMLFILE;PMEDCCOD;
          GOTO      ECRL9999
.
ECRL2400  MATCH     SP70,PMEDLDAT
          GOTO      ECRL9999 IF EQUAL
          UNPACK    PMEDLDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ECRL9999
.
ECRL2500  WRITE     HTMLFILE;PMEDPARI;
          GOTO      ECRL9999
.
ECRL2600  WRITE     HTMLFILE;PMEDPTID;
          GOTO      ECRL9999
.
ECRL2700  MATCH     "0",PMEDSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ECRL9999
          ENDIF     
.
          MATCH     "1",PMEDSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ECRL9999
          ENDIF     
.
          MATCH     "2",PMEDSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ECRL9999
          ENDIF    
.
          MATCH     "3",PMEDSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense";
            GOTO      ECRL9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ECRL9999
.
ECRL2800  UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,FORM1
          MOVE      DIM1,FORM1
          BRANCH    FORM1,ECRL2810
.
          WRITE     HTMLFILE;PARTCODE;
          GOTO      ECRL9999
.
ECRL2810  PACK      KEY3,PARTCODE,SP70
          CALL      RDPTPAR1
          BRANCH    OVRCD,ECRL9999
.
          WRITE     HTMLFILE;PTPRNAME;
          GOTO      ECRL9999
.
ECRL2900  WRITE     HTMLFILE;HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO;
          GOTO      ECRL9999
.
ECRL3000  CALL      SELP0000
          GOTO      ECRL9999
.
ECRL3100  CALL      PRVR0000
          GOTO      ECRL9999
.
ECRL3200  CALL      NXTR0000
          GOTO      ECRL9999
.
ECRL3300  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ECRL9999
.
ECRL3400  WRITE     HTMLFILE;EXDTBLNK;
          GOTO      ECRL9999
.
ECRL3500  CALL      HSPSEL00
          GOTO      ECRL9999
.
ECRL9999  RETURN
.***************************************************************************
.*                             ECRH0000                                    *
.*   Set the hospital filter and call ECRT0000                             *
.*   If multi hospital call ECRT0000 for each of the users hositals        *
.***************************************************************************
ECRH0000  IF        IBCNMHOS<>1
            MOVE      SP70,FILTHOSP         * Not multi hospital so blank
            CALL      ECRT0000              
            GOTO      ECRH9999
          ENDIF
.
.   Multi Hospital
.
          MATCH     SP70,FILTHOSP           * User has selected a hospital
          IF        !@EQUAL
            CALL      ECRT0000             
            GOTO      ECRH9999
          ENDIF
.
          PACK      KEY3,SP70               * Show all users available
          CALL      RSPTHSP1                * hospitals
ECRH5000  CALL      RKPTHSP1
          BRANCH    OVRCD,ECRH9000
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,ECRH5000
          ENDIF
.
          MOVE      PTHSHOSP,FILTHOSP
          CALL      ECRT0000
.
          PACK      KEY3,FILTHOSP,SP70               * reposition
          CALL      RSPTHSP1
          GOTO      ECRH5000
.
ECRH9000  MOVE      SP70,FILTHOSP           * Restore all hospitals filter
.
ECRH9999  RETURN
.***************************************************************************
.*                             ECRT0000                                    *
.*   Display all the remittance batches received from a given participant  *
.***************************************************************************
ECRT0000  MOVE      ZERO,LOOPCNTR
.
. * released views use date index
          MATCH     "2",ERASTATS
          IF        @EQUAL
            PACK      KEY69,FILTHOSP,LASTDATE,Z70
            CALL      RSPMERH2
          ELSE
. * un-released views use status index
            PACK      KEY70,FILTHOSP,ERASTATS,Z70
            CALL      RSPMERH3
          ENDIF
.
ECRT1000  MATCH     "2",ERASTATS
          IF        @EQUAL
. * released views use date index
            CALL      RPPMERH2
          ELSE
. * un-released views use status index
            CALL      RPPMERH3
          ENDIF
          BRANCH    OVRCD,ECRT9999               * end of file 
.
          MATCH     FILTHOSP,PMEHHOSP
          GOTO      ECRT9999 IF NOT EQUAL
.
          MATCH     "2",ERASTATS
          IF        @EQUAL
. * released views use date - unreleased doesn't always have it
            MATCH     FRSTDATE,PMEHDATE
            GOTO      ECRT9999 IF LESS
.
            MATCH     ERASTATS,PMEHSTAT
            GOTO      ECRT1000 IF NOT EQUAL
.
          ELSE   
.
            MATCH     ERASTATS,PMEHSTAT
            GOTO      ECRT9999 IF NOT EQUAL
.
          ENDIF
.
          MATCH     ERASTATS,PMEHSTAT
          GOTO      ECRT9999 IF NOT EQUAL
. 
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
           ADD       ONE,LOOPCNTR
 
           IF        (LOOPCNTR > 250)
             WRITE     HTMLFILE;"// ",LOOPCNTR
             MOVE      ZERO,LOOPCNTR
           ENDIF
.
. -----------------------------------------------------
.
          MATCH     "1",PTCNUIMC
          IF        @EQUAL
.
            PACK      KEY82,PMEHFTID,PMEHRADV,PMEHPNUM,SP70
            CALL      RSPMERD1                     
            CALL      RKPMERD1                     
            BRANCH    OVRCD,ECRT1000               
.
            MATCH     PMEHFTID,PMEDFTID
            GOTO      ECRT1000 IF NOT EQUAL
.
            MATCH     PMEHRADV,PMEDRADV
            GOTO      ECRT1000 IF NOT EQUAL
.
            MATCH     PMEHPNUM,PMEDPNUM
            GOTO      ECRT1000 IF NOT EQUAL
.
.           A payment for the ERA has been found, so now if it belongs
.           to pmsectaf
.
            PACK      KEY40,PMEDTRID,SP30,SP10
            CALL      RSPMECT6     
            CALL      RKPMECT6     
            BRANCH    OVRCD,ECRT1000        
.
            MATCH     PMEDTRID,PMECTRID            * if its not in pmsectaf
            GOTO      ECRT1000 IF NOT EQUAL        * then its probably an imc 
.                                                  * claim
          ENDIF
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
            MATCH     "2",PMEHSTAT
            GOTO      ECRT1000 IF NOT EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,PMEHDATE
              GOTO      ECRT1000 IF LESS
.
              MATCH     PMEHDATE,LASTDATE
              GOTO      ECRT1000 IF LESS
            ENDIF
.
          ELSE
            MATCH     "2",PMEHSTAT
            GOTO      ECRT1000 IF EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,PMEHDATE
              GOTO      ECRT1000 IF LESS
.         
              MATCH     PMEHDATE,LASTDATE
              GOTO      ECRT1000 IF LESS
            ENDIF
.
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,PMEHDATE
          IF        !@EQUAL & !@EOS
            UNPACK    PMEHDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",PMEHSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",PMEHSTAT
          IF        @EQUAL
            MOVE      "Partial  ",DIM9
          ENDIF
.
          MATCH     "2",PMEHSTAT
          IF        @EQUAL
            MOVE      "Released ",DIM9
          ENDIF
.
          MATCH     "3",PMEHSTAT
          IF        @EQUAL
            MOVE      "Processng ",DIM9
          ENDIF
.
          UNPACK    PMEHDAMT,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
.
          CALL      GCLM0000
.
          REP       " +",PMEHFTID
          REP       " +",PMEHRADV
          REP       " +",PMEHPNUM
          REP       " +",PMEHHOSP
.
          MOVE      ZERO,LOOPCNTR
.
          IF        IBCNMHOS=1
.
            MATCH     "+++",PMEHHOSP
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"t.addRow(#"",DIM11,"#",";
            ELSE
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
      PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','002');> ",DIM11," ",PMEHNAME,"#",";
            ENDIF
.
          ELSE
.
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
      PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','002');> ",DIM11," ",PMEHNAME,"#",";
          ENDIF
.
          REP       "+ ",PMEHFTID
          REP       "+ ",PMEHRADV
          REP       "+ ",PMEHPNUM
          REP       "+ ",PMEHHOSP
.
          WRITE     HTMLFILE;"#"",PMEHPNUM," of ",PMEHPTOT,"#",":
                             "#"",DIM9,"#",":
                             "#"",FORM7P2C,"#",":
                             "#"",CLAMTOTL,"#",";
.
          REP       " +",PMEHFTID
          REP       " +",PMEHRADV
          REP       " +",PMEHPNUM
          REP       " +",PMEHHOSP
          MOVE      PMEHPREF,DIM30
          MOVE      PMEHDAMT,DIM9
          REP       " +",DIM30
          REP       " +",DIM9
.
          MOVE      FORM7P2C,DIM10A
          MOVE      CLAMTOTL,DIM10B
          REP       " +",DIM10A
          REP       " +",DIM10B
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",PMEHHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",PMEHPREF;
              ELSE
            WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
              PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                               PMEHPREF;
              ENDIF
.
            ELSE
.
            WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
              PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                               PMEHPREF;
            ENDIF
          ELSE
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",PMEHHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",PMEHPREF;
              ELSE
                MATCH     "3",PMEHSTAT
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                            PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                            PMEHPREF,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
                ELSE
                  MATCH     "1",UNRELINQ
                  IF        @EQUAL
                    WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                              " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                              PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                              PMEHPREF;
                  ELSE
                    WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                              " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                              PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                              PMEHPREF,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                  ENDIF
                ENDIF
              ENDIF
.
            ELSE
              MATCH     "3",PMEHSTAT
              IF        @EQUAL
                WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                          " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                          PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                          PMEHPREF,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
              ELSE
                MATCH     "1",UNRELINQ
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                            PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                            PMEHPREF;
                ELSE
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                            PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                            PMEHPREF,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",PMEHNAME;
          MOVE      PMEHRADV,DIM30
          REP       "+ ",PMEHRADV
          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
      PMEHFTID,"','",DIM30,"','",PMEHPNUM,"','",PMEHHOSP,"','002');> ",PMEHRADV;
.
          REP       "+ ",PMEHHOSP
.
          WRITE     HTMLFILE;"#",#"",PMEHFTID;
          WRITE     HTMLFILE;"#",#"",DIM11;
.
          MOVE      SP70,DIM50
          MATCH     SP70,PMEHHOSP
          IF        !@EQUAL & !@EOS
            PACK      KEY3,PMEHHOSP,SP70
            CALL      RDPTHSP1 
            IF        OVRCD=0
              MOVE      PTHSNAME,DIM50
            ELSE
              MOVE      PMEHHOSP,DIM50
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",DIM50;
.
          WRITE     HTMLFILE;"#");"
.
          REP       "+ ",PMEHFTID
          REP       "+ ",PMEHRADV
          REP       "+ ",PMEHPNUM
.
          GOTO      ECRT1000
.
ECRT9999  RETURN
.*****************************************************************************
.*                            GCLM0000                                       *
.*              Get the claimed amount total for the ERA                     *
.* Requires:  Valid read on pmserhaf record (ERA Header)                     *
.* Returns:   CLAMTOTL - total claimed amount for the ERA batch              *
.*****************************************************************************
.
GCLM0000  MOVE      ZERO,CLAMTOTL                * initialise total amount
.
.         Loop through pmserdaf looking for payments from the selected ERA
.
          PACK      KEY82,PMEHFTID,PMEHRADV,PMEHPNUM,SP30,SP30,SP1
          CALL      RSPMERD1                     * position in file
GCLM1000  CALL      RKPMERD1                     * read next record
          BRANCH    OVRCD,GCLM9999               * end of file
.
          MATCH     PMEHFTID,PMEDFTID            * same participant still ?
          GOTO      GCLM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     PMEHRADV,PMEDRADV            * same remittance advice still?
          GOTO      GCLM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     PMEHPNUM,PMEDPNUM            * same part number still ?
          GOTO      GCLM9999 IF NOT EQUAL        * no - finished ERA
.
.         A payment for the ERA has been found, so now get the claimed amount
.         from pmsectaf
.
          PACK      KEY40,PMEDTRID,SP30,SP10
          CALL      RSPMECT6                     * position on trans. id
          CALL      RKPMECT6                     * read next record
          BRANCH    OVRCD,GCLM1000               * eof - not found
.
          MATCH     PMEDTRID,PMECTRID            * same transaction id still ?
          GOTO      GCLM1000 IF NOT EQUAL        * no - not found
.
          ADD       PMECAMTC,CLAMTOTL            * update ERA claim total
          GOTO      GCLM1000                     * get next payment
.
GCLM9999  RETURN
+
.------------------------------------------------------------
. Eclipse Remittance Payment Details
.------------------------------------------------------------
ECRD0000  CALL      ECRDH000
.
          PACK      KEY82,PMEHFTID,PMEHRADV,PMEHPNUM,SP70
          CALL      RSPMERD1
ECRD1000  CALL      RKPMERD1
          BRANCH    OVRCD,ECRD9999
.
          MATCH     PMEHFTID,PMEDFTID
          GOTO      ECRD9999 IF NOT EQUAL
.
          MATCH     PMEHRADV,PMEDRADV
          GOTO      ECRD9999 IF NOT EQUAL
.
          MATCH     PMEHPNUM,PMEDPNUM
          GOTO      ECRD9999 IF NOT EQUAL
.
          MOVE      SP70,DIFCINDC
          IF        IBCNMHOS=1
            PACK      KEY40,PMEDTRID,SP70
            CALL      RSPMECT6
            CALL      RKPMECT6
            BRANCH    OVRCD,ECRD5000
.
            MATCH     PMEDTRID,PMECTRID
            GOTO      ECRD5000 IF NOT EQUAL
.
            MATCH     SP70,PMECHOSP
            IF        !@EQUAL & !@EOS
              MATCH     PMECHOSP,WBSEHOSP
              IF        !@EQUAL
                PACK      KEY3,PMECHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSLOCN,SAVELOCN
                ELSE
                  MOVE      SP70,SAVELOCN
                ENDIF
.
                PACK      KEY3,WBSEHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SAVELOCN,PTHSLOCN
                  GOTO      ECRD1000 IF NOT EQUAL

                  MOVE      "1",DIFCINDC
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
ECRD5000  CALL      ECRDR000
.
          GOTO      ECRD1000
.
ECRD9999  RETURN
.
.------------------------------------------------------------
. ERA Payment Details (TABLE HEADING)
.------------------------------------------------------------
ECRDH000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=15%>":
                             "Invoice<br>Number</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Benefit<br>Amount</td>";
.                            
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Claimed<br>Amount</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Batch<br>Number</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Status</td>":
                             "<td class=HeadingCell width=10%>":
                             "Claim<br>Channel<br>Code</td>":
                             "<td class=HeadingCell width=15% align=center>":
                             "Lodgement<br>Date</td>":
                             "<td class=HeadingCell width=15%>":
                             "Transaction ID<br>&nbsp;</td>":
                             "</tr>"
.
ECRDH999  RETURN
.------------------------------------------------------------
. Eclipse Payment Details (Detail Row)
.------------------------------------------------------------
ECRDR000  REP       " +",HOSPCODE
          REP       " +",PMEDFTID
          REP       " +",PMEDRADV
          REP       " +",PMEDPNUM
          REP       " +",PMEDTRID
          WRITE     HTMLFILE;"<tr><td><img src='../images/CommentIcon.gif'":
                             " class=ListIcon onclick=displayRemD('":
  HOSPCODE,"','",PMEDFTID,"','",PMEDRADV,"','",PMEDPNUM,"','",PMEDTRID,"','D');>&nbsp;";
          REP       "+ ",HOSPCODE
          REP       "+ ",PMEDFTID
          REP       "+ ",PMEDRADV
          REP       "+ ",PMEDPNUM
          REP       "+ ",PMEDTRID
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=red>";
          ENDIF
.
          WRITE     HTMLFILE;PMEDARID;
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"</font>";
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
          UNPACK    PMEDBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",FORM7P2C,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
          ENDIF
.
          MOVE      ZERO,CLAMTOTL
          PACK      KEY40,PMEDTRID,SP30,SP10     
          CALL      RSPMECT6                     * position on trans. id
          CALL      RKPMECT6                     * read next record
          BRANCH    OVRCD,ECRDR100                * eof - not found
.         
          MATCH     PMEDTRID,PMECTRID            * same transaction id still ?
          GOTO      ECRDR100 IF NOT EQUAL        * no - not found
.         
          MOVE      PMECAMTC,CLAMTOTL            * update ERA claim total
.
ECRDR100  MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",CLAMTOTL,"</font></td>";
.         
            WRITE     HTMLFILE;"<td><font color=red>",PMECBATN,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CLAMTOTL,"</td>";
.           
            WRITE     HTMLFILE;"<td>",PMECBATN,"</td>";
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",PMEDSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF     
.
          MATCH     "1",PMEDSTAT
          IF        @EQUAL 
            MOVE      "Locked   ",DIM9
          ENDIF
.
          MATCH     "2",PMEDSTAT
          IF        @EQUAL
            MOVE      "Released",DIM9
          ENDIF
.
          MATCH     "3",PMEDSTAT
          IF        @EQUAL
            MOVE      "Released*",DIM9
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM9,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",PMEDCCOD,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM9,"</td>";
.
            WRITE     HTMLFILE;"<td>",PMEDCCOD,"</td>";
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,PMEDLDAT
          IF        !@EQUAL & !@EOS
            UNPACK    PMEDLDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM11,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",PMEDTRID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
            WRITE     HTMLFILE;"<td>",PMEDTRID,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
ECRDR999  RETURN
.
.------------------------------------------------------------
. Get claim amount for a specific transactiom id
.------------------------------------------------------------
GCLD0000  MOVE      ZERO,CLAMTOTL
          PACK      KEY40,PMEDTRID,SP30,SP10
          CALL      RSPMECT6                     * position on trans. id
          CALL      RKPMECT6                     * read next record
          BRANCH    OVRCD,GCLD9999                * eof - not found
. 
          MATCH     PMEDTRID,PMECTRID            * same transaction id still ?
          GOTO      GCLD9999 IF NOT EQUAL        * no - not found
.
          MOVE      PMECAMTC,CLAMTOTL            * update ERA claim total
.
GCLD9999  RETURN
.*****************************************************************************
.*                              RPAY0000           Called by: KEYA0000       *
.*           Release all payments for the selected ERA batch                 *
.*****************************************************************************
.
.         Initialise counters
.         ERDCOUNT - is the total number of pmserdaf records associated
.                    with the selected ERA batch.
.         PRLCOUNT - is the number of pmserdaf records associated with the
.                    selected ERA batch, which have previously been "released".
.         RELCOUNT - is the number of pmserdaf records associated with the
.                    selected ERA batch for which payments have been released
.                    in this session.
.
RPAY0000  CALL      CLER0000
          MOVE      SP3,SAVEPART
.
          MOVE      ZERO,EXIT
          MOVE      ZERO,ERDCOUNT
          MOVE      ZERO,PRLCOUNT
          MOVE      ZERO,RELCOUNT
.
.         Start releasing payments for the ERA
.
RPAY0500  REP       "+ ",FUNDTRID
          REP       "+ ",REMITADV
          REP       "+ ",PARTNUMB
          REP       "+ ",HOSPCODE
.
          PACK      KEY61,HOSPCODE,FUNDTRID,REMITADV,PARTNUMB,SP70
          CALL      RDPMERH1
          BRANCH    OVRCD,RPAY9960
.
          MATCH     "3",PMEHSTAT
          GOTO      RPAY9950 IF EQUAL
.
          MOVE      "3",PMEHSTAT
          CALL      UPPMERH1
.
          CALL      LTMP0000
.
.         Start releasing payments for the ERA
.
          MOVE      SP30,KEY27
          CALL      RSTEMP2                      * position in file
RPAY1000  CALL      RKTEMP2                      * read next record
          BRANCH    OVRCD,RPAY9000               * end of file
.
.         Read the pmserdaf record as the record status will need to be
.         updated later
.
          PACK      KEY82,PMEDFTID,PMEDRADV,PMEDPNUM,PMEDTRID
          CALL      RDPMERD1                     * record found ?
          BRANCH    OVRCD,RPAY1000               * no - shouldn't happen
.
          UNPACK    PMEDBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         IF        FORM7P2C = 0 | FORM7P2C < 0
          IF        FORM7P2C = 0
            ADD       ONE,RELCOUNT
            MOVE      TWO,PMEDSTAT                 * set as released
            CALL      UPPMERD1
            GOTO      RPAY1000
          ENDIF
.
.         A payment for the ERA has been found, so check if it needs releasing
.
.         ADD       ONE,ERDCOUNT                 * increment pmserdaf count
          MATCH     "2",PMEDSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAY1000                   * get next payment
          ENDIF
.
          MATCH     "3",PMEDSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAY1000                   * get next payment
          ENDIF
.
.         A claim requiring payment releasing has been found, so
.         get the corresponding pmsectaf record and check if same hospital
.         
          MOVE      ZERO,ERASUSIN
          PACK      KEY40,PMEDTRID,SP70     
          CALL      RSPMECT6                     * position on trans. id/invoice
          CALL      RKPMECT6                     * read next record
.         BRANCH    OVRCD,RPAY6000               * eof
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    PMEDARID,SERDIM50
            APPEND    " - pmsectaf record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAY6000
          ENDIF
.         
          MATCH     PMEDTRID,PMECTRID            * same transaction id still ?
.         GOTO      RPAY6000 IF NOT EQUAL        * no 
          IF        !@EQUAL
            CLEAR     SERDIM50
            APPEND    PMEDARID,SERDIM50
            APPEND    " - tran id not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAY6000
          ENDIF

.
          MOVE      SP70,SAVELOCN
          IF        IBCNMHOS=1
            MATCH     PMEHHOSP,PMECHOSP
            IF        !@EQUAL
              PACK      KEY3,PMECHOSP,SP70       
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSLOCN,SAVELOCN      
              ELSE
                  SUB       ONE,ERDCOUNT
                  GOTO      RPAY1000
              ENDIF
.
              PACK      KEY3,PMEHHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MATCH     SAVELOCN,PTHSLOCN
                IF        !@EQUAL
                  SUB       ONE,ERDCOUNT
                  GOTO      RPAY1000
                ENDIF
              ELSE
                  SUB       ONE,ERDCOUNT
                  GOTO      RPAY1000
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY8,PMEDARID,SP70
          RJUSTIFY  KEY8
          CALL      RDPTINV1
.         IF        OVRCD = 1
.           GOTO      RPAY6000
.         ENDIF
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    PMEDARID,SERDIM50
            APPEND    " - patinvrf record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAY6000
          ENDIF

.
          MATCH     "1",PTINCRST
.         GOTO      RPAY6000 IF EQUAL
          IF        @EQUAL
            CLEAR     SERDIM50
            APPEND    PMEDARID,SERDIM50
            APPEND    "invoice is fully credited",SERDIM50
            RESET     SERDIM50
            GOTO      RPAY6000
          ENDIF
.
          UNPACK    SP70,KEY8,KEY12
          UNPACK    PMEDARID,KEY8,KEY12
          MATCH     SP70,KEY12
          GOTO      RPAY6000 IF NOT EQUAL
.
.         Validate  for adjusted claims
.
          PACK      SAVKEY24,PMECADMN,PMECINVN,PMECBATN,SP70
          MOVE      PMECADMN,SAVEVISN
          MOVE      PMECTRID,SAVETRID
.
          PACK      KEY24,PMECADMN,SP70
          CALL      RSPMECT4
RPAY1400  CALL      RKPMECT4
          BRANCH    OVRCD,RPAY1490
.
          MATCH     SAVEVISN,PMECADMN
          GOTO      RPAY1490 IF NOT EQUAL
.
          MATCH     SAVETRID,PMECPCTI
          GOTO      RPAY1400 IF NOT EQUAL
.
          PACK      KEY24,SAVKEY24,SP70
          CALL      RDPMECT4
.
          GOTO      RPAY6000
.
RPAY1490  PACK      KEY24,SAVKEY24,SP70
          CALL      RDPMECT4
.
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAY1500  MOVE      "HFR",PRXCODE   * System Lock Audits
          CALL      GETSLK00        * Get System Lock Audits
.
          PACK      KEY8,PMECINVN,SP70
          CALL      RDHFRE1                      * lock record found ?
          IF        OVRCD = 1
            MOVE      ONE,HFRSTAT                * no - write one with lock
            MOVE      PMECINVN,HFRINVR
            CALL      WRHFRE1
          ELSE
            COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
            IF        @EQUAL
              MOVE      ONE,HFRSTAT              * no - lock now
              CALL      UPHFRE1
            ELSE
              CALL      RELSLK00                 * Release System Lock Audits
              GOTO      RPAY8000                 * record already locked
            ENDIF
          ENDIF
          CALL      RELSLK00        * Release System Lock Audits
.
.         Now check the we can lock the invoice record
.
          MOVE      PMECINVN,KEY8
          CALL      RLPTINV1
          IF        OVRCD = 1
.           MOVE      THREE,UNLKFLAG
.           CALL      UNLK0000                   * unlock any locked records
.           GOTO      RPAY8000
            GOTO      RPAY6100
          ELSE
            IF        OVRCD = 2
              MOVE      THREE,UNLKFLAG
              CALL      UNLK0000                 * unlock any locked records
              GOTO      RPAY8000
            ENDIF
          ENDIF
.
.         Check that we can lock the visit record
.             
          PACK      KEY8,PMECADMN,SP70
          CALL      RLPTVIS1
          IF        OVRCD = 1
            MOVE      TWO,UNLKFLAG
            CALL      UNLK0000                   * unlock any locked records
            GOTO      RPAY8000
          ELSE      
            IF        OVRCD = 2
              MOVE      TWO,UNLKFLAG
              CALL      UNLK0000                 * unlock any locked records
              GOTO      RPAY8000
            ENDIF
          ENDIF
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.         
          MATCH     SAVEPART,PARTPANT            * same participant still ?
          IF        !@EQUAL
            CALL      ALLCRC00
.
            MOVE      PARTPANT,SAVEPART          * save new participant code
          ENDIF
.
.         Process the payment
.
          UNPACK    PMEDBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         MOVE      FORM7P2C,PMECAMTP
          ADD       FORM7P2C,PMECAMTP
          ASSIGN    (PINVHFDA-PMECAMTP),PINVHFDA
.         
          CALL      IBACLOCK                     * get current date
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME
.
.         Check if the invoice now balances
.
          MOVE      PINVAMT,FORM10P2             * Invoice amount +
          ADD       PINVPATA,FORM10P2            * Patient payments +
          ADD       PINVHFDA,FORM10P2            * H.F payments +
          ADD       PINVOTHA,FORM10P2            * Other payments +
          ADD       PINVJOUR,FORM10P2            * Journals +
          ADD       PTINGSTJ,FORM10P2            * Journal GST = amt outstanding
.
          MOVE      "99999999",PINVBLCD          * default to not balancing
.
          COMPARE   ZERO,FORM10P2                * Does invoice balance ?
          IF        @EQUAL
            MOVE      CURRDATE,PINVBLCD          * yes - record balanced date
.           MOVE      TWO,PTDTAPAY               * set A/P flag - balanced
          ELSE
.           MOVE      ZERO,PTDTAPAY              * set A/P flag - not balanced
          ENDIF
          MOVE      FORM10P2,PINVPCSH
.         CALL      UPINV1                       * update/unlock invoice record
.
.         PROC      FLAGDEBT
.
.         Create the patdtraf cash receipt record.
.
          MOVE      PMECADMN,TADMNO              * load admission number
.         
.         Get the next transaction number.  As we have already locked
.         the visit record, there should be no problem getting the
.         next transaction number.
.         
.RPAY3000  MOVE      PMECADMN,KEY8                * get next transaction number
.          CALL      TRVISA1
.         
.          PACK      KEY22,PMECADMN,PMECINVN,PVITRAN
.          CALL      RDADTRN1                     * patdtraf record on file ?
.          COMPARE   ZERO,OVRCD
.          GOTO      RPAY3000 IF EQUAL            * yes
.
.          MOVE      PVITRAN,TTRANSN1             * load transaction number
.          MOVE      ANSH,TTYPEDEB                * set to "patient" type of debt
.          MOVE      PMECHFND,TDCODE
.
.          ASSIGN    (PMECAMTP*SEQ),TPATAMTT
.          MOVE      TPATAMTT,TREBATE
.
.          MOVE      ZERO,TPATAMTG                * set $ amounts
.          MOVE      ZERO,TPATAMTH
.          MOVE      ZERO,TPATAMTI
.          MOVE      ZERO,TPATAMTP
.
.          MOVE      CCC,TFCENT                   * set payment date
.          MOVE      CYY,TFYEAR
.          MOVE      CMM,TFMONTH
.          MOVE      CDD,TFDAY
.
.          MOVE      ZERO,TTCENT                  * initialise accomm. to dates
.          MOVE      ZERO,TTYEAR
.          MOVE      ZERO,TTMONTH
.          MOVE      ZERO,TTDAY
.
.          PACK      TTYPE,ANSP,ANSY              * set for payment
.          MOVE      SP9,TITEMNO
.          MOVE      PMECINVN,TREF                * load invoice no.
.          MOVE      SIX,TPAYTYPE                 * direct deposit
.
          MOVE      HRECPT,TRECEIPT
.
.          IF        PMECEETP = 0
.            MOVE      "Unknown Health Fund           ",HFNAME
.            PACK      KEY14,PMECHFND,ZERO4,SP20
.            CALL      RDFUND1                    * HF on file ?
.            MOVE      HFNAME,TDDESC              * load HF description
.          ELSE
.            MOVE      "Unknown Claim Code  ",TDESC
.            PACK      KEY5,ANSC,ANSL,PINVCLM
.            CALL      RDCODE1
.            MOVE      TDESC,TDDESC               * load claim code description
.          ENDIF
.
.          MOVE      ONE,TINVPRT                  * invoice printed
.          MOVE      FIVE,TRECTYPE                * cash receipt
.          MOVE      ZERO,TNODAYS
.          MOVE      ZERO,TCLAIM
..         MOVE      ZERO,PTDTREBT
.          MOVE      SP6,TDOCTA
.          MOVE      ZERO,TSERVS
.          MOVE      SP6,TDOCTO
.          MOVE      SP2,TSESSION
.          MOVE      SP3,TMISGRP
.          MOVE      SP3,TDEPTYP
.          MOVE      SP3,TDWARD
.          MOVE      SP3,TCLMTYP
.          MOVE      SP3,TADMTYP
.          MOVE      PMECBATN,TBATCHN             * load batch number
.          MOVE      ZERO,TNINVS
.          MOVE      SP3,PTDTBTYP
.          MOVE      ZERO,PTDTLSPT
.          MOVE      ZERO,PTDTLSRB
.          MOVE      ZERO,PTDTDTYP
.          PACK      PTDTDES2,SP20,SP20
.          MOVE      ZERO,PTDTEPSD
.          MOVE      ZERO,PTDTCCU
..         MOVE      SP6,PTDTSURG
..         MOVE      SP1,PTDTDEPS
.
.          MOVE      CURRDATE,PTDTEFFD            * load payment date
.
.          MOVE      ZERO,PTDTGSTA
.          MOVE      SP6,PTDTGSTC
.          MOVE      ZERO,PTDTGSTM
.          MOVE      ZERO,PTDTADPT
.          MOVE      ZERO,PTDTADRB
.          MOVE      ZERO,PTDTGSTL
.          MOVE      SP70,PTDTTIME
.          MOVE      SP70,PTDTCRST
.          MOVE      SP70,PTDTUNIQ
.          MOVE      SP70,PTDTCNTR
.          MOVE      SP70,PTDTCPRC
.          MOVE      SP70,PTDTCONT
.          MOVE      SP70,PTDTSUNQ
.          MOVE      SP70,PTDTBTCH
..         MOVE      ANSN,PTDTSSAP
..         MOVE      ZERO,PTDTMVBR
.          MOVE      ZERO,PTDTEPSD
..         MOVE      SP1,PTDTMHDP
.          PACK      TSPARE,SP30,SP30
.
.          CALL      WRDTRN1                     * write patdtraf journal record
.
          ADD       ONE,RELCOUNT
.
.         Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.         
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C           
              MOVE       DIM10,FORM7P2C          
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE    
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      PMEHHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
            MOVE      "1",RCBNTTYP               * CAR 227986
            MOVE      PMECHFND,RCBNRCOD
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
              MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
.         Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      PMEHHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
            MOVE      PARTPANT,RCBDPAYD
            MOVE      SP70,RCBDCHQN
            MOVE      PMEHNAME,RCBDDRAW
            MOVE      PMEHBNAM,RCBDBANK
            MOVE      PMEHBBSB,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      PMEHPREF,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
.         Write to rcpdteaf
.
RPAY3500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDTE00
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDTE00
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDTE00
              ELSE
                GOTO      RPAY3500
              ENDIF
            ENDIF
          ENDIF
.
.         Now "close" the current claim (providing that a processing report
.         has been received) and update the payment amount and
.         the payment date
.
          MOVE      PMEDARID,DIM20               * CAR 227986
          SQUEEZE   DIM20
.         
          PACK      KEY62,PMECTRID,PARTPANT,DIM20,Z70
          CALL      RSPMEAH2                     * position on trans. id
RPAY4000  CALL      RPPMEAH2                     * read previous record
          BRANCH    OVRCD,RPAY4500               * eof - no proc. report
.         
          MATCH     PMECTRID,PMAHFTID            * same claim trans. id ?
          GOTO      RPAY4500 IF NOT EQUAL        * no - no proc. report 
.         
          MATCH     PARTPANT,PMAHFBID            * same fund brand. id ?
          GOTO      RPAY4500 IF NOT EQUAL        * no - no proc. report
.         
          MATCH     DIM20,PMAHARID               * same invoice number ?
          GOTO      RPAY4500 IF NOT EQUAL        * no - no proc. report
.
          MATCH     ANSA,PMAHCFAC                * assessment code "A" ?
          GOTO      RPAY4000 IF NOT EQUAL        * no - get next report
.
.         A processing report was found
.
          MOVE      TEN5,PMECFLAG                * set status to closed
.
RPAY4500  PACK      PMECSTAT,SP1,TWO             * set closed with payment
          MOVE      PMEDLDAT,PMECPDAT            * set payment date
.
          UNPACK    PMEDBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         MOVE      FORM7P2C,PMECAMTP
          ADD       FORM7P2C,PMECAMTP
          CALL      UPPMECT6                     * update claim
.
.         Finally, write an EDI History record (pmsecaaf)
.
          MOVE      PMECINVN,PMEAINVN
          CALL      IBACLOCK
          PACK      PMEADATE,CCC,CYY,CMM,CDD    
          REP       " 0",PMEADATE
          MOVE      CTIMEIS,PMEATIME
          MOVE      PMECBATN,PMEABATN
          MOVE      PMECFLAG,PMEASTAT
          MOVE      " 5",PMEATYPE
          MOVE      WBSEUID,PMEAOPER
          MOVE      PMECTRID,PMEATRID
          MOVE      SP4,PMEAEROR
          MOVE      SP70,PMEAEROT
          MOVE      SP30,PMEASPAR
.
RPAY5000  PACK      KEY26,PMEAINVN,PMEADATE,PMEATIME,PMEATYPE,SP70
          CALL      RAPMECA1
          IF        OVRCD = 1
            CALL      WRPMECA1
          ELSE
            CALL      IBACLOCK
            PACK      PMEADATE,CCC,CYY,CMM,CDD
            REP       " 0",PMEADATE
            MOVE      CTIMEIS,PMEATIME
            GOTO      RPAY5000
          ENDIF
.
.         Update the remittance table (pmserdaf) to indicate that
.         the claim payment has been released to the relevant ibaPAS tables
.
          MOVE      TWO,PMEDSTAT                 * set as released
          CALL      UPPMERD1
.
          MOVE      ONE,UNLKFLAG
          CALL      UNLK0000                     * unlock all locked records
.
          MOVE      PMECINVN,KEY8
          CALL      CREC0000              * Update Un-reconciled inv.file
.
          MOVE      SP70,TTYPEARG
          MOVE      " 1",TTYPEARG
          CALL      DELET200
.
          MOVE      " 3",TTYPEARG
          CALL      DELET200
.
          MOVE      " 4",TTYPEARG
          CALL      DELET200
.
          MOVE      " 5",TTYPEARG
          CALL      DELET200
.
          GOTO      RPAY1000
.
.*******************************************************************************
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.           
RPAY6000  MOVE      "HFR",PRXCODE   * System Lock Audits
          CALL      GETSLK00        * Get System Lock Audits
.           
          MOVE      PMEDARID,DIM8
          RJUSTIFY  DIM8
.
          PACK      KEY8,DIM8,SP70
          CALL      RDHFRE1                      * lock record found ?
          IF        OVRCD = 1
            MOVE      ONE,HFRSTAT                * no - write one with lock
            MOVE      DIM8,HFRINVR
            CALL      WRHFRE1
          ELSE
            COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
            IF        @EQUAL
              MOVE      ONE,HFRSTAT              * no - lock now
              CALL      UPHFRE1
            ELSE
              CALL      RELSLK00                 * Release System Lock Audits
              GOTO      RPAY8000                 * record already locked
            ENDIF
          ENDIF
          CALL      RELSLK00        * Release System Lock Audits
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number. 
.         
RPAY6100  MATCH     SAVEPART,PARTPANT            * same participant still ?
          IF        !@EQUAL
            CALL      ALLCRC00
.
            MOVE      PARTPANT,SAVEPART          * save new participant code
          ENDIF
.
          MOVE      HRECPT,TRECEIPT
.
          ADD       ONE,RELCOUNT
.
.         MOVE      ONE,PMECEETP
.         MATCH     "DVA",PMEDPART
.         IF        !@EQUAL
.           MOVE      ZERO,PMECEETP
.         ENDIF
.
          UNPACK    PMEDBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         MOVE      FORM7P2C,PMECAMTP
.
.         Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      PMEHHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
            MOVE      "1",RCBNTTYP               * CAR 227986
.
.           MOVE      PMECHFND,RCBNRCOD
.
            MOVE      SP70,RCBNRCOD
            MOVE      PMEDARID,DIM8
            RJUSTIFY  DIM8
.
            PACK      KEY16,DIM8,SP70
            CALL      RSPMECT2
            CALL      RKPMECT2
            BRANCH    OVRCD,RPAY6200
.
            MATCH     DIM8,PMECINVN
            GOTO      RPAY6200 IF NOT EQUAL
.
            MOVE      PMECHFND,RCBNRCOD
.
            GOTO      RPAY6300
.
RPAY6200    PACK      KEY23,DIM8,SP70
            CALL      RDSDTRN5
            CALL      RDKDTRN5
            IF        OVRCD=0
              MATCH     DIM8,TREF
              IF        @EQUAL
                PACK      KEY8,DTADMNO,SP70
                CALL      RDMISS1
                IF        OVRCD=0
                  MOVE      AFUNDH,RCBNRCOD
                ENDIF
              ENDIF
            ENDIF 
.
RPAY6300    MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
              MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
.         Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      PMEHHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
            MOVE      PARTPANT,RCBDPAYD
            MOVE      SP70,RCBDCHQN
            MOVE      PMEHNAME,RCBDDRAW
            MOVE      PMEHBNAM,RCBDBANK
            MOVE      PMEHBBSB,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      PMEHPREF,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
.         Write to rcpdteaf
.
RPAY6500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDTS00
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDTS00
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDTS00
              ELSE
                GOTO      RPAY6500
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      THREE,PMEDSTAT          * set as released to suspense acc
          CALL      UPPMERD1
.
          MOVE      THREE,UNLKFLAG
          CALL      UNLS0000
.
          MOVE      SP70,TTYPEARG
          MOVE      " 1",TTYPEARG
          CALL      DELET200
.
          MOVE      " 3",TTYPEARG
          CALL      DELET200
.
          MOVE      " 4",TTYPEARG
          CALL      DELET200
.
          MOVE      " 5",TTYPEARG
          CALL      DELET200
.
          GOTO      RPAY1000
.*******************************************************************************
.
.         A record was locked for this claim, so set the status to "locked"
.
RPAY8000  MOVE      "1",PMEDSTAT
          CALL      UPPMERD1
          GOTO      RPAY1000
.
.         Check if all the payment records for the ERA were released and
.         update the ERA header status accordingly.
.
RPAY9000  IF        ERDCOUNT = (PRLCOUNT+RELCOUNT)
            MOVE      "2",PMEHSTAT               * set to "released"
          ELSE
            MOVE      "1",PMEHSTAT               * set to "partial"
          ENDIF
          CALL      UPPMERH1
.
          IF        IBCNMHOS=1
            MATCH     "2",PMEHSTAT
            IF        @EQUAL
              CALL      CDERA000
            ENDIF
          ENDIF
.
.         Unlock general records.
.
          MATCH     "1",MULTLT01
          IF        @EQUAL
            MOVE      "2",DIM1C
            PACK      REMITKEY,PMEHHOSP,PMEHFTID,PMEHRADV,PMEHPNUM,SP70
            CALL      PRNREM00
          ENDIF
.
          MATCH     "1",PMEHSTAT
          IF        @EQUAL
            MOVE      "Payment record partially released.",WEBTITLE
          ELSE 
            MOVE      "Payment record released.",WEBTITLE
          ENDIF
.         CALL      WEBERR00
.         MOVE      ONE,EXIT
          MOVE      ZERO,EXIT
          GOTO      RPAY9999  
.
RPAY9950  MOVE      "Remittance Currently being processed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAY9999
.
RPAY9960  MOVE      "Cannot find pmserhaf record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAY9999
.
RPAY9999  RETURN
.
.*****************************************************************************
.         Get payment type for Direct deposit
.*****************************************************************************
DDEP0000  MOVE      "Py",KEY2
          PACK      KEY5,KEY2,SP70
          CALL      RDSCODE1
DDEP1000  CALL      RDKCODE1
          BRANCH    OVRCD,DDEP9000
.
          MATCH     "Py",TCODE
          GOTO      DDEP9000 IF NOT EQUAL
.
          MATCH     "I",PTCOACTV
          GOTO      DDEP1000 IF EQUAL       * Inactive
.
          MOVE      ZERO,F2
          SQUEEZE   PTCDNHCP
          MOVE      PTCDNHCP,F2
          COMPARE   FOUR,F2
          GOTO      DDEP1000 IF NOT EQUAL
.
          MOVE      ACODE,RCBDPCOD           * Payment code for Direct Deposit
          GOTO      DDEP9999
.
DDEP9000  MOVE      SP70,RCBDPCOD
DDEP9999  RETURN
+
.*****************************************************************************
.*                                UNLK0000         Called by: RPAY0000       *
.*               Unlock claim related records after releasing payments       *
.* Requires: UNLKFLAG - unlock flag                                          *
.*                      1 = patvisaf, patinvrf & pathfrec                    *
.*                      2 = patinvrf & pathfrec                              *
.*                      3 = pathfrec                                         *
.*****************************************************************************
.
UNLK0000  BRANCH    UNLKFLAG,UNLK1000:
                             UNLK2000:
                             UNLK3000
.
UNLK1000  CALL      UUPTVIS1                     * unlock visit record
.
UNLK2000  CALL      UUPTINV1                     * unlock invoice record
.
.         Unlock the pathfrec record
.
UNLK3000  MOVE      PMECINVN,KEY8
          CALL      RDHFRE1                      * HF receipts record found ?
          BRANCH    OVRCD,UNLK9999               * no
.
          MOVE      ZERO,HFRSTAT                 * set the status to 'free'
          CALL      UPHFRE1
.
UNLK9999  RETURN
+
.------------------------------------------------------------------------------
. Allocate New Receipt Number
.------------------------------------------------------------------------------
.
ALLCRC00  READ      CONTROLF,THIRTY6;*193,HRECPT
          ADD       ONE,HRECPT
          WRITAB    CONTROLF,THIRTY6;*193,HRECPT
          SUB       ONE,HRECPT
.
          MOVE      HRECPT,KEY12
          CALL      RDRCBNK1
          COMPARE   ZERO,OVRCD
          GOTO      ALLCRC00 IF EQUAL
.
ALLCRC99  RETURN
+
.------------------------------------------------------------------------------
.  Get Income account and Control Account
.------------------------------------------------------------------------------
GTACCT00  PACK      KEY3,RCDTREGI,SP70
          CALL      RDREGA1
          BRANCH    OVRCD,GTACCT80
.         MOVE      REGHOSP,RCDTMHOS       * Hospital id
          MOVE      REGGST,RCDTGSTC        * GST Code
.
          COMPARE   FIVE,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Integra Extended
          COMPARE   FOUR,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Comma Delimeted
          COMPARE   TWO,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Other FMS - get Acc.from Reg.
          COMPARE   THREE,HSYS1
          GOTO      GTACCT20 IF EQUAL      * Using Other FMS - for Integra
.
          MATCH     SP20,REGGENLD
          GOTO      GTACCT80 IF EQUAL
          GOTO      GTACCT80 IF EOS
.
          MOVE      REGGENLD,RCDTINCA
          MOVE      REGGENLD,INCMACCT
          CALL      GETC0000              * Get Control Account Details
          PACK      RCDTBNKA,FMLALEDG,FMCSBNK
          GOTO      GTACCT99
.
.         Get Credit and Bank Account from Register record
.
GTACCT20  MOVE      REGGENDB,RCDTINCA       * Debtors Control account as Crd.Acc
          MOVE      REGGENBK,RCDTBNKA       * Debit account
          GOTO      GTACCT99
.
GTACCT80  MOVE      SP70,RCDTINCA
          MOVE      PMEHBNUM,RCDTBNKA
          GOTO      GTACCT99
.
GTACCT99 RETURN
+
.------------------------------------------------------------------------
. Get Control Account Details
.------------------------------------------------------------------------
GETC0000  UNPACK    INCMACCT,LEDNO,ACCNO
          PACK      KEY2,LEDNO
          CALL      RDFMLA1              * Ledger Master Details
          MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
          PACK      KEY14,INCMACCT,SP70
          CALL      RDFMCS1              * Selected Control Accounts
          BRANCH    OVRCD,GETC9000
.
          MATCH     SP70,FMCSBNK
          GOTO      GETC0010 IF NOT EQUAL
.
          MOVE      FMLABNK,FMCSBNK
.
GETC0010  MATCH     SP70,FMCSDEB
          GOTO      GETC0020 IF NOT EQUAL
.
          MOVE      FMLADEB,FMCSDEB
.
GETC0020  MATCH     SP70,FMCSAGST
          GOTO      GETC9999 IF NOT EQUAL
.
          MOVE      FMLAAGST,FMCSAGST
.
          GOTO      GETC9999
.
GETC9000  MOVE      FMLABNK,FMCSBNK
          MOVE      FMLADEB,FMCSDEB
          MOVE      FMLAAGST,FMCSAGST
.
GETC9999  RETURN
+
.--------------------------------------------------------------------------
.*                             PRNREM00                                   *
.*               Schedule Eclipse Remittance Report (IBAPMS07)            *
.--------------------------------------------------------------------------
PRNREM00  MOVE      "IBAPMS07",SCHDPGID
          MOVE      "Eclipse Remittance Report",SCHDDESC
          CALL      IBACLOCK
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      ONE,SCHDCOPY
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAPMS07",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          UNPACK    REMITKEY,KEY3,KEY24,KEY30,KEY4
          MOVE      KEY3,KEYSTARR[1]        * key for pmserhaf
          MOVE      KEY24,KEYSTARR[2] 
          MOVE      KEY30,KEYSTARR[3]
          MOVE      KEY4,KEYSTARR[4]
          MOVE      USERID,KEYSTARR[5]
          MOVE      DIM1C,KEYSTARR[6]
          MOVE      SIX,KEYSTCNT            * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
PRNREM99  RETURN
+
.---------------------------------------------------------------------------
.         FLDR0000 - loads the patient folder icon base on alert active
.---------------------------------------------------------------------------
.
.FLDR0000  MOVE       TWO,FOLDRTYP                 * set to default folder
.          PACK       KEY13,PURNO,SP70
.          CALL       RSPTALR1
.          CALL       RKPTALR1
.          BRANCH     OVRCD,FLDR1000
.          MATCH      PTALURNO,PURNO               * alert exist?
.          GOTO       FLDR1000 IF NOT EQUAL
.
.          MOVE       ONE,FOLDRTYP
.
.          GOTO       FLDR2000
.
.FLDR1000  MOVE       TWO,FOLDRTYP
.
.FLDR2000  LOAD       FOLDRNAM,FOLDRTYP,FOLDER1:   * alert folder
.                                       FOLDER2    * normal folder
.
.FLDR9999  RETURN
.
FLDR0000  MOVE       FOLDER0,FOLDRNAM
          MOVE       ZERO,FOLDRTYP
          RESET      PTMXSIN1
          MOVE       PTMXSIN1,FOLDRTYP
.
          LOAD       FOLDRNAM,FOLDRTYP,FOLDER1:
                                       FOLDER2:
                                       FOLDER3:
                                       FOLDER4:
                                       FOLDER5:
                                       FOLDER6:
                                       FOLDER7:
                                       FOLDER8:
                                       FOLDER9
.
FLDR9999  RETURN
+
.---------------------------------------------------------------------------
.         WRRDTE00 - Write to rcpdteaf
.---------------------------------------------------------------------------
.
WRRDTE00  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.         MOVE      PMEDARID,RCDTINVN
          PACK      RCDTINVN,PMEDARID,SP70
          RJUSTIFY  RCDTINVN
          MOVE      PMECADMN,RCDTVIST
          MOVE      PMECURNO,RCDTURNO
          MOVE      PMECURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD = 0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,RCDTNAME
            MOVE      PADD1,RCDTADD1
            MOVE      PADD2,RCDTADD2
            MOVE      PSUBRB,RCDTADD3
            MOVE      PADD4,RCDTADD4
            MOVE      PPOST,RCDTPOST
          ELSE
            MOVE      SP70,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
          ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      PMEHPREF,RCDTREFR
          MOVE      PMEHHOSP,RCDTMHOS
.
          MOVE      RCCNERRE,RCDTREGI
          IF        IBCNMHOS=1
.
            MATCH     SP70,RCDTMHOS
            IF        !@EQUAL & !@EOS
              PACK      KEY3,RCDTMHOS,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MATCH     SP70,PTHSERRE
                IF        !@EQUAL & !@EOS
                  MOVE      PTHSERRE,RCDTREGI
                ENDIF
              ENDIF
            ENDIF
.
            PACK      KEY8,PMECADMN,SP70
            CALL      RDPMVX11
            IF        OVRCD=0
              MATCH     SP70,PMVXMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,PMVXMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERRE
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERRE,RCDTREGI
                    MOVE      PMVXMHOS,RCDTMHOS
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
          ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCT00
.
          UNPACK    PMEDBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      SP70,RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      PMECBATN,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDTE99  RETURN
+
.------------------------------------------------------------
. Format Patient Age in Y,M,W or D -
.------------------------------------------------------------
FMTA0000  MOVE      SP70,FMTPATAG
.
          MATCH     "y",PSAGETYP
          GOTO      FMTA1000 IF NOT EQUAL
.
          CLEAR     FMTPATAG
          APPEND    PSAGEYRS,FMTPATAG
          APPEND    " yrs",FMTPATAG
          RESET     FMTPATAG
          GOTO      FMTA9999
.
FMTA1000  MATCH     "d",PSAGETYP
          GOTO      FMTA2000 IF NOT EQUAL
.
          CLEAR     FMTPATAG
          APPEND    PSAGEDAY,FMTPATAG
          APPEND    " days",FMTPATAG
          RESET     FMTPATAG
          GOTO      FMTA9999
.
FMTA2000  MATCH     "m",PSAGETYP
          GOTO      FMTA3000 IF NOT EQUAL
.
          CLEAR     FMTPATAG
          APPEND    PSAGEMNT,FMTPATAG
          APPEND    " mths",FMTPATAG
          RESET     FMTPATAG
          GOTO      FMTA9999
.
FMTA3000  MATCH     "w",PSAGETYP
          GOTO      FMTA9999 IF NOT EQUAL
.
          CLEAR     FMTPATAG
          APPEND    PSAGEWKS,FMTPATAG
          APPEND    " wks",FMTPATAG
          RESET     FMTPATAG
.
FMTA9999  RETURN
.
.------------------------------------------------------------
. Next Day, Week, Month       
.------------------------------------------------------------                
NXTR0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3  
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2  
          REP       " 0",KEY2
.
          REP       " +",FILTHOSP
.                            
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:  
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",NXTFDATE:
                             "&lastdate=",NXTLDATE:
                             "&exdtblnk=",EXDTBLNK:
                             "&filthosp=",FILTHOSP:
                             "&deftallh=",DEFTALLH;
.
          REP       "+ ",FILTHOSP
.
NXTR9999  RETURN
.
.--------------------------------------------------------
.
PRVR0000  MOVE      TEMPLATE,F3
          MOVE      F3,KEY3
          REP       " 0",KEY3
          MOVE      REPORTNO,F2
          MOVE      F2,KEY2
          REP       " 0",KEY2
.
          REP       " +",FILTHOSP
.                            
          WRITE     HTMLFILE;"patweb93.pbl":
                             "?reportno=",KEY2:
                             "&template=",KEY3:
                             "&viewtype=",VIEWTYPE:
                             "&frstdate=",PREFDATE:
                             "&lastdate=",PRELDATE:
                             "&exdtblnk=",EXDTBLNK:
                             "&filthosp=",FILTHOSP:
                             "&deftallh=",DEFTALLH;
.
          REP       "+ ",FILTHOSP
.
PRVR9999  RETURN
.
.--------------------------------------------------------------------
. Set the expected return date/time value and the font to red
. if the patient is overdue from the expected return date/time
.--------------------------------------------------------------------
XRET0000  MOVE      SP70,EXPLRETN           * Exp return from leave date/time
.
          COMPARE   THREE,FILETYPE          * Leave
          GOTO      XRET9999 IF NOT EQUAL
.
          MATCH     SP70,OERDATE            * Expected return from leave
          GOTO      XRET9999 IF EQUAL
.
          PACK      KEY8,CTIMEIS
          REP       ": ",KEY8
          SQUEEZE   KEY8
          PACK      TESTDAT1,CCC,CYY,CMM,CDD,KEY8
          REP       " 0",TESTDAT1
.
          MATCH     SP70,OERTIME
          IF        @EQUAL
            MOVE      "99:99:99",KEY8
          ELSE
            MOVE      OERTIME,KEY8
          ENDIF
          REP       ": ",KEY8
          SQUEEZE   KEY8
.
          PACK      TESTDAT2,OERDATE,KEY8
          REP       " 0",TESTDAT2
.
          MATCH     TESTDAT2,TESTDAT1
          GOTO      XRET8000 IF LESS
.
          UNPACK    OERDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                NOV,DEC
          PACK      EXPLRETN,FONTRSTR,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1:
                             OERTIME,FONTREND,SP70
          GOTO      XRET9999
.
XRET8000  UNPACK    OERDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT:
                                NOV,DEC
          PACK      EXPLRETN,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR,SP1:
                             OERTIME,SP70
.
XRET9999  RETURN
+
.-------------------------------------------------------------------
.Check for duplicate remittance in multi hospital remittance release
.-------------------------------------------------------------------
CDERA000  PACK      KEY61,SP3,PMEHFTID,PMEHRADV,PMEHPNUM,SP70
          CALL      RDPMERH1
          BRANCH    OVRCD,CDERA999
.         
          MOVE      "2",PMEHSTAT
.         
          CALL      UPPMERH1
.         
CDERA999  RETURN
.---------------------------------------------------------------------------
.         WRRDTS00 - Write to rcpdteaf suspense account
.---------------------------------------------------------------------------
.
WRRDTS00  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.         MOVE      PMEDARID,RCDTINVN
.         PACK      RCDTINVN,PMEDARID,SP70
.         RJUSTIFY  RCDTINVN
          MOVE      SP70,RCDTINVN
          MOVE      SP70,RCDTVIST
          MOVE      SP70,RCDTURNO
.         MOVE      PMECURNO,KEY8
.         CALL      RDMAST1
.         IF        OVRCD = 0
.           MOVE      PSNAME,PACSNAME
.           MOVE      PGNAME,PACGNAME
.           MOVE      PTITL,PACTITLE
.           MOVE      TWO,PACFRMT
.           CALL      PACNAME
.           MOVE      PACFNAME,RCDTNAME
.           MOVE      PADD1,RCDTADD1
.           MOVE      PADD2,RCDTADD2
.           MOVE      PSUBRB,RCDTADD3
.           MOVE      PADD4,RCDTADD4
.           MOVE      PPOST,RCDTPOST
.         ELSE
            REP       "#" ",SERDIM50
            MOVE      SERDIM50,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
.         ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      PMEHPREF,RCDTREFR
          MOVE      PMEHHOSP,RCDTMHOS
.
          MOVE      RCCNERRS,RCDTREGI
.         IF        IBCNMHOS=1
.           MATCH     SP70,RCDTMHOS
.           IF        !@EQUAL & !@EOS
.             PACK      KEY3,RCDTMHOS,SP70
.             CALL      RDPTHSP1
.             IF        OVRCD=0
.               MATCH     SP70,PTHSERRE
.               IF        !@EQUAL & !@EOS
.                 MOVE      PTHSERRE,RCDTREGI
.               ENDIF
.             ENDIF
.           ENDIF
.         ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCT00
.
          MOVE      SP70,DIM2
          MOVE      SP70,DIM7
          MOVE      SP70,DIM10
.
          UNPACK    PMEDBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      "2",RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      SP70,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDTS99  RETURN
.
.*****************************************************************************
.*                                UNLS0000         Called by: RPAY0000       *
.*               Unlock claim related records after releasing payments       *
.* Requires: UNLKFLAG - unlock flag                                          *
.*                      1 = patvisaf, patinvrf & pathfrec                    *
.*                      2 = patinvrf & pathfrec                              *
.*                      3 = pathfrec                                         *
.*****************************************************************************
.
UNLS0000  BRANCH    UNLKFLAG,UNLS1000:
                             UNLS2000:
                             UNLS3000
.
UNLS1000  CALL      UUPTVIS1                     * unlock visit record
.
UNLS2000  CALL      UUPTINV1                     * unlock invoice record
.
.         Unlock the pathfrec record
.
UNLS3000  MOVE      PMEDARID,DIM8
          RJUSTIFY  DIM8
          MOVE      DIM8,KEY8
          CALL      RDHFRE1                      * HF receipts record found ?
          BRANCH    OVRCD,UNLS9999               * no
.
          MOVE      ZERO,HFRSTAT                 * set the status to 'free'
          CALL      UPHFRE1
.
UNLS9999  RETURN
+
.*****************************************************************************
.*                              CREA0000               Called by: MAIN0000   *
.*             Create a new temporary file                                   *
.*****************************************************************************
.
CREA0000  CALL      KILL0000                     * remove existing file
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ISBUILD,TEMPFILE,UKEY
          EXECUTE   CMDLINE,TASKID               * create temporary index file
.
          OPEN      ECLTEMP1,TEMPFILE            * open temp index 1
          OPEN      ECLTEMP2,TEMPFILE            * open temp index 2
.
CREA9999  RETURN
+
.****************************************************************************
.*                              KILL0000               Called by: MAIN0000  *
.*               Close and erase the temporary file                         *
.****************************************************************************
.
KILL0000  CLOSE     ECLTEMP1                     * close file
          CLOSE     ECLTEMP2
.
          CLEAR     CMDLINE
          PACK      CMDLINE,ERASE,TEMPFILE       * set file erase command
          EXECUTE   CMDLINE,TASKID               * erase temp file
.
KILL9999 RETURN
+
.****************************************************************************
.*                              CLER0000               Called by: MAIN0000  *
.*               Close and erase the temporary file                         *
.****************************************************************************
.
CLER0000  MOVE      SP30,KEY24
          CALL      RSTEMP1                      * position at start of file
          CALL      RKTEMP1                      * read next record
          BRANCH    OVRCD,CLER9999               * eof - finished
.
          MOVE      PMEDTRID,KEY24
          CALL      DETEMP1                      * delete current record
          GOTO      CLER0000                     * get next record
.
CLER9999  RETURN
+
.*****************************************************************************
.*                                 LTMP0000        Called by: RPAY0000       *
.*    Load the temp file with the pmserdaf records which correspond to the   *
.*    selected pmserhaf record.                                              *
.*    We need to use the temp file so that we can sort by participant code.  *
.*    Some health fund groups (e.g. BUPA), may send payments in a single     *
.*    remittance, relating to more than one participant (e.g HBA & MBF).     *
.*    When processing the payments, a receipt number needs to be generated   *
.*    for each participant.                                                  *
.* Requires:  Valid read on pmserhaf record                                  *
.*            ERDCOUNT - initialised to zero                                 *
.* Returns:   ERDCOUNT - total number of pmserdaf records related to the     *
.*                       selected remittance.                                *
.*****************************************************************************
.
LTMP0000  PACK      KEY82,PMEHFTID,PMEHRADV,PMEHPNUM,SP30,SP30,SP30
          CALL      RSPMERD1                     * position in file
LTMP0500  CALL      RKPMERD1                     * read next record
          BRANCH    OVRCD,LTMP9999               * end of file
.
          MATCH     PMEHFTID,PMEDFTID            * same fund trans. id still ?
          GOTO      LTMP9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     PMEHRADV,PMEDRADV            * same remittance advice still?
          GOTO      LTMP9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     PMEHPNUM,PMEDPNUM            * same part number still ?
          GOTO      LTMP9999 IF NOT EQUAL        * no - finished ERA
.
          ADD       ONE,ERDCOUNT                 * increment pmserdaf count
.
.         A payment requiring releasing has been found, so get the
.         corresponding pmsectaf record.
.
          PACK      KEY40,PMEDTRID,SP30,SP10
          CALL      RSPMECT6                     * position on trans. id/invoice
          CALL      RKPMECT6                     * read next record
          BRANCH    OVRCD,LTMP1100               * eof
.
          MATCH     PMEDTRID,PMECTRID            * same transaction id still ?
          GOTO      LTMP1500 IF EQUAL            * yes
.
LTMP1100  
.         DISPLAY   *P1:24,*EL,*B,"Missing pmsectaf record for ":
.                   *V2LON,PMEDTRID,*HOFF,".  ";
.         CALL      HITENTER
          GOTO      LTMP3000
.
.         Get the participant code for the claim
.
LTMP1500  MOVE      CVETINS,PARTPANT             * default part. to DVA
          BRANCH    PMECEETP,LTMP5000            * DVA claim
.
.         This is a Health Fund claim
.
          PACK      KEY14,PMECHFND,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1
          IF        OVRCD = 1
.           DISPLAY   *P1:24,*EL,*B,"Missing patfundf record for ":
.                     *V2LON,PMECHFND,*HOFF,".  ";
.           CALL      HITENTER
            GOTO      LTMP8000
          ENDIF
.
          PACK      KEY6,PMECHFND,SP70
          CALL      RDPTFX11
          IF        OVRCD=1
            GOTO      LTMP2000
          ENDIF
.
          MATCH     SP3,PTFXECLP
          GOTO      LTMP2000 IF EQUAL
          GOTO      LTMP2000 IF EOS
.
          MOVE      PTFXECLP,PARTPANT
          GOTO      LTMP5000
.
.         The health fund group equates to the participant
.
LTMP2000  MATCH     SP3,PTHFHGRP
          IF        @EQUAL
.           DISPLAY   *P1:24,*EL,*B,"Participant code blank for ":
.                     *V2LON,PMECHFND,*HOFF,".  ";
.           CALL      HITENTER
            GOTO      LTMP8000
          ENDIF
          MOVE      PTHFHGRP,PARTPANT            * load participant code
          GOTO      LTMP5000
.
LTMP3000  MOVE      PMEDARID,KEY8
          RJUSTIFY  KEY8
          PACK      KEY8,KEY8,SP70
          CALL      RDPTINV1
          COMPARE   OVRCD,ONE
          GOTO      LTMP3500 IF EQUAL
.
          MATCH     SP70,DPINVADM
          GOTO      LTMP8000 IF EQUAL
          GOTO      LTMP8000 IF EOS
.
          PACK      KEY8,DPINVADM,SP70
          CALL      RDPTMIS1
          IF        OVRCD=1
            GOTO      LTMP8000
          ENDIF
.
.         Get the participant code for the claim
.
LTMP3500  MOVE      CVETINS,PARTPANT
          PACK      KEY5,ANSC,ANSL,ACLAIM
          CALL      RDCODE1
          IF        OVRCD=0
            MOVE      ZERO,FORM1
            WHILE     FORM1 < 5
              ADD       ONE,FORM1
              LOAD      ANS,FORM1,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
              MATCH     ANSV,ANS
              IF        @EQUAL
                GOTO      LTMP5000
              ENDIF
            DO
          ENDIF
.
          MATCH     SP70,AFUNDH
          GOTO      LTMP8000 IF EQUAL
          GOTO      LTMP8000 IF EOS
.
.         This is a health fund claim
.
          PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1
          IF        OVRCD=1
            GOTO      LTMP8000
          ENDIF
.
          PACK      KEY6,AFUNDH,SP70
          CALL      RDPTFX11
          IF        OVRCD=1
            GOTO      LTMP4000
          ENDIF
.
          MATCH     SP3,PTFXECLP
          GOTO      LTMP4000 IF EQUAL
          GOTO      LTMP4000 IF EOS
.
          MOVE      PTFXECLP,PARTPANT
          GOTO      LTMP5000
.
.         The health fund group equates to the participant
.
LTMP4000  MATCH     SP3,PTHFHGRP
          IF        @EQUAL
            GOTO      LTMP8000
          ENDIF
.
          MOVE      PTHFHGRP,PARTPANT
          GOTO      LTMP5000
.
.         Write the pmserdaf details to the temp file
.
LTMP5000  CALL      WRTEMP1
          GOTO      LTMP0500                     * get next payment
.
.         There was a problem processing this record, so set the pmserdaf
.         payment status to "locked"
.
LTMP8000  MOVE      "1",PMEDSTAT
          CALL      UPPMERD1
          GOTO      LTMP0500
.
LTMP9999  RETURN
+
.-------------------------------------------------------------------------------
.         Check if invoice is reconciled after input journal
.-------------------------------------------------------------------------------
CREC0000  MOVE      ZERO,FORM10P2
          CALL      RDPTINV1
          BRANCH    OVRCD,CREC9999
.
          MOVE      PINVNO,FORM12
          MOVE      FORM12,SAVKEY12
          PACK      KEY29,SAVKEY12,SP70
          CALL      RSRCDTE3
CREC1000  CALL      RKRCDTE3
          BRANCH    OVRCD,CREC2000
.
          MATCH     SAVKEY12,RCDTINVN       * Same invoice number?
          GOTO      CREC2000 IF NOT EQUAL
.
          MOVE      RCDTREGI,KEY3
          CALL      RDREGA1
          BRANCH    OVRCD,CREC1000
.
          BRANCH    REGIBACD,CREC1200      * Patient billing
          COMPARE   "97",REGIBACD
          GOTO      CREC1000 IF NOT EQUAL  * NOT IP Deposits
.
CREC1200  PACK      KEY12,RCDTRECN,SP70
          CALL      RDRCBNK1
          BRANCH    OVRCD,CREC1000
          MATCH     "1",RCBNSTAT
          GOTO      CREC1000 IF EQUAL       * Receipt cancelled
.
          ADD       RCDTAMNT,FORM10P2       * payment
          GOTO      CREC1000
.
CREC2000  MOVE      PINVAMT,FORM12P2      * Invoice amount +
          SUB       FORM10P2,FORM12P2     * Payments
          ADD       PTINCRTT,FORM12P2     * Credit Notes +
          ADD       PINVJOUR,FORM12P2     * Journals = amount outstanding
          ADD       PTINGSTJ,FORM12P2     * Journal GST = amount outstanding
.
          CALL      GDET0000              * Get patient's Claim and Health Fund
          CALL      RECN0000              * Update Unreconciled invoice
.
CREC9999  RETURN
+
.-------------------------------------------------------------------------------
.         Get patient's Claim and Health fund
.-------------------------------------------------------------------------------
GDET0000  MOVE      PINVUR,KEY8
          CALL      RDMAST1
          BRANCH    OVRCD,GDET9999

          BRANCH    PINVSYS OF GDET1000,GDET2000,GDET3000
          GOTO      GDET9999
.
.         Emergency invoice
.
GDET1000  OPEN      AAEDE1A1,"aaede1af"
          MOVE      PINVADM,KEY8
          CALL      RDEMVIS1
          BRANCH    OVRCD,GDET9999
.
          CALL      RDDETA1
          BRANCH    OVRCD,GDET9999
.
          MOVE      EMVICOMP,ACLAIM
          MOVE      PFUNDH,AFUNDH
          MOVE      PFNDTB,AFNDTB
          GOTO      GDET9999
.
.         Outpatient invoice
.
GDET2000  MOVE      "out",OSTFILE
          MOVE      PINVSITE,KEY6
          CALL      RDSITA1                 * Get the file header for this site
.
          PACK      CFNAME WITH OSTFILE,FILBB1A1
          CALL      OPOTBB11
.
          MOVE      PINVADM,KEY8
          CALL      RDBOKB1
          BRANCH    OVRCD,GDET9999
.
          MOVE      OBACOMP,ACLAIM
          MOVE      OTBBFUND,AFUNDH
          MOVE      OTBBTBLE,AFNDTB
          GOTO      GDET9999

GDET3000  MOVE      PINVADM,KEY8
          CALL      RDPTMIS1
.
GDET9999  RETURN
+
.-------------------------------------------------------------------------------
.         If invoice balanced, removed record from Unreconciled invoice file
.         if invoice not balanced, write or update the Unreconciled invoice file
.-------------------------------------------------------------------------------
RECN0000  PACK      KEY8,PINVNO
          CALL      RDPTURE1
.
          CALL      IBACLOCK
          IF        FORM12P2=0
            IF        OVRCD=0
              CALL      DEPTURE1              * Delete Un-reconciled record
            ENDIF
          ELSE
            IF        OVRCD=0
              MOVE      PTINCRTT,PTURJRNL     * Credit Notes +
              ADD       PINVJOUR,PTURJRNL     * Journals = amount outstanding
              ADD       PTINGSTJ,PTURJRNL     * Journal GST = amount outstanding
              MOVE      FORM12P2,PTUROSTD     * Outstanding amount
.
.          Update PTURCDAT/PTURCTIME when updating intead of PTURUDAT/PTURUTIM
.
              PACK      PTURCDAT,CCC,CYY,CMM,CDD
              REP       " 0",PTURCDAT
              MOVE      CTIMEIS,PTURCTIM
              MOVE      WBSEUID,PTURCUID        * WEB user id
              CALL      UPPTURE1              * Update outstanding amount
            ELSE
              CALL      SETU0000              * Setup Unreconciled inv.fields
              CALL      WRPTURE1
            ENDIF
          ENDIF
.
RECN9999  RETURN
+
.------------------------------------------------------------
.         Setup fields for the Unreconciled invoices file
.------------------------------------------------------------
SETU0000  MOVE      PINVNO,PTURINVN
          MOVE      PINVADM,PTURVISN
          MOVE      "0",PTURSTAT                * New status
          MOVE      PINVSYS,PTURSYST
          MOVE      ACLAIM,PTURCLMN
          MOVE      AFUNDH,PTURHFND
          MOVE      AFNDTB,PTURHTAB
.
          MOVE      PINVAMT,PTURINVT     * Invoice total
          MOVE      PINVPATA,PTURPAYM    * Patient payments +
          ADD       PINVHFDA,PTURPAYM    * H.F payments +
          ADD       PINVOTHA,PTURPAYM    * Other payments +
.
          MOVE      PTINCRTT,PTURJRNL    * Credit Notes +
          ADD       PINVJOUR,PTURJRNL    * Journals = amount outstanding
          ADD       PTINGSTJ,PTURJRNL    * Journal GST = amount outstanding
          MOVE      FORM12P2,PTUROSTD    * Outstanding amount
.
          CALL      IBACLOCK
          PACK      PTURCDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURCDAT
          MOVE      CTIMEIS,PTURCTIM
          MOVE      WBSEUID,PTURCUID        * WEB user id
.
          PACK      PTURUDAT,CCC,CYY,CMM,CDD
          REP       " 0",PTURUDAT
          MOVE      CTIMEIS,PTURUTIM
          MOVE      WBSEUID,PTURUUID        * WEB user id
.
SETU9999  RETURN
+
.-------------------------------------------------------------------------
.UPPBMN00 - Write/update the bed management table
.-------------------------------------------------------------------------
UPPBMN00  MOVE      ZERO,CNTREADS            * Counter for Debug Performance Issue
          PACK      TRNTOWRD,TRNTOWRD,SP70
          PACK      TRNTOBED,TRNTOBED,SP70
          MATCH     SP70,TRNTOWRD
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
          MOVE      SP70,SAVEBRQN
          CALL      DELBMD00                   * Delete Existing Bed Manageemnt Records
.
          MOVE      ZERO,LOSDINDC              * Write/update patbmdaf
          MOVE      TRANDATE,SAVEDATE          * Bed management Detail Tab
          MOVE      TRANTIME,SAVETIME          * Length of Stay days
.
          MOVE      ZERO,LOOPDAYS
          MOVE      STAYDAYS,LOOPDAYS
.
. Restrict to latest 12 weeks to avoid timeout error from old admissions etc.
.
          IF        LOOPDAYS>84    
            UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
            ASSIGN    LOOPDAYS-84,ADJDAYS
            CALL      ADJDAT00
            PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      84,LOOPDAYS
          ENDIF
.
UPPBMN30  COMPARE   ZERO,LOOPDAYS
          GOTO      UPPBMN50 IF EQUAL
          MOVE      TWO,LOSDINDC
.
          PACK      KEY30,AADMNO,SAVEDATE,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,UPPBMN35
.
          MATCH     DAADMNO,DTADMN
          GOTO      UPPBMN35 IF NOT EQUAL
.
          MOVE      TWARD,PTBDWARD
          MOVE      TBED,PTBDWBED
          GOTO      UPPBMN38
.
UPPBMN35  MOVE      TRNTOWRD,PTBDWARD
          MOVE      TRNTOBED,PTBDWBED
.
UPPBMN38  MOVE      SAVEDATE,PTBDDATE
          MOVE      SAVETIME,PTBDADTM
          MOVE      LOOPDAYS,PTBDLOSD
.
          CALL      GTTOTM00
          MOVE      ADJTIME,PTBDLOSM
.
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
          MOVE      "3",PTBDSTAT
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            TRAP      OVERCOND IF IO
            CALL      WRPTBMD1
            TRAPCLR   IO
          ELSE
            CALL      UPPTBMD1
          ENDIF
.
          SUB       ONE,LOOPDAYS
          UNPACK    SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "1",ADJDAYS
          CALL      ADJDAT00
          PACK      SAVEDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      "00:00",SAVETIME
          ADD       ONE,CNTREADS
          GOTO      UPPBMN30
.
UPPBMN50  CALL      GTTOTM00                       * Write/update patbmdaf
          MOVE      ZERO,CNTREADS
          COMPARE   TWO,LOSDINDC
          IF        @EQUAL
            MOVE      SAVEDATE,PTBDDATE
            MOVE      SAVETIME,PTBDADTM
          ELSE
            MOVE      TRANDATE,PTBDDATE
            MOVE      TRANTIME,PTBDADTM
            MOVE      ONE,LOSDINDC
          ENDIF
.
.
          PACK      KEY30,AADMNO,PTBDDATE,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          BRANCH    OVRCD,UPPBMN55
.
          MATCH     DAADMNO,DTADMN
          GOTO      UPPBMN55 IF NOT EQUAL
.
          MOVE      TWARD,PTBDWARD
          MOVE      TBED,PTBDWBED
          GOTO      UPPBMN58
.
UPPBMN55  MOVE      TRNTOWRD,PTBDWARD
          MOVE      TRNTOBED,PTBDWBED
.
UPPBMN58  MOVE      ADJTIME,PTBDLOSM
          MOVE      "  0",PTBDLOSD
          MOVE      SP70,PTBDOPPE
          MOVE      AADMNO,PTBDADMN
.
          MOVE      "3",PTBDSTAT
.
          MOVE      "0",PTBDOVER
          MOVE      SAVEBRQN,PTBDBRQN
          MOVE      SP70,PTBDSPAR
.
          PACK      KEY30,PTBDWARD,PTBDWBED,PTBDDATE,PTBDADTM,SP3,PTBDADMN,SP70
          CALL      RAPTBMD1
          IF        OVRCD=1
            TRAP      OVERCOND IF IO
            CALL      WRPTBMD1
            TRAPCLR   IO
          ELSE
            CALL      UPPTBMD1
          ENDIF
.
          MOVE      PTBDDATE,SAVEDATE
.
UPPBMN70  COMPARE   ZERO,LOSDINDC                         * Override previous
          GOTO      UPPBMN99 IF EQUAL                     * Records in patbmdaf
.
          MATCH     SP70,TRNTOBED
          GOTO      UPPBMN99 IF EQUAL
          GOTO      UPPBMN99 IF EOS
.
          MOVE      TRANTIME,DIM5
          PACK      KEY30,TRNTOWRD,TRNTOBED,TRANDATE,DIM5,SP3,AADMNO,SP70
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
.
          MOVE      PTBDDATE,SAVEDATE
          MOVE      PTBDADTM,SAVETIME
          MOVE      PTBDLOSD,SAVELOSD
          MOVE      PTBDLOSM,SAVELOSM
.
UPPBMN73  CALL      RPPTBMD1
          BRANCH    OVRCD,UPPBMN80
          ADD       ONE,CNTREADS
.
          MATCH     TRNTOWRD,PTBDWARD
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     TRNTOBED,PTBDWBED
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MATCH     SAVEDATE,PTBDDATE
          GOTO      UPPBMN80 IF NOT EQUAL
.
          MOVE      PTBDDATE,STRTDATE
          MOVE      PTBDADTM,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      PTBDLOSD,ADJDAYS
          CALL      GETEDT00
.
          MATCH     EXPDSDTE,SAVEDATE
          IF        @LESS
            GOTO      UPPBMN78
          ENDIF
          GOTO      UPPBMN73 IF NOT EQUAL
.
          MATCH     EXPDSTME,SAVETIME
          IF        @EQUAL | @LESS
            GOTO      UPPBMN78
          ENDIF
.
          GOTO      UPPBMN73
.
UPPBMN78  MOVE      ONE,PTBDOVER
          CALL      UPPTBMD1
          GOTO      UPPBMN73
.
.-------------------------------------------------------------------------
.
UPPBMN80  PACK      KEY30,TRNTOWRD,TRNTOBED,AADMNO,Z70    * Override following
          CALL      RSPTBMD3                              * Records in patbmdaf
          CALL      RPPTBMD3
          BRANCH    OVRCD,UPPBMN99
          MATCH     DAADMNO,PTBDADMN
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MOVE      ZERO,CNTREADS
          MOVE      SAVEDATE,STRTDATE
          MOVE      SAVETIME,STRTTIME
          MOVE      PTBDLOSM,ADJTIME
          MOVE      SAVELOSD,ADJDAYS
          CALL      GETEDT00
.
          PACK      KEY30,TRNTOWRD,TRNTOBED,SAVEDATE,SAVETIME,SP3,DAADMNO,SP70
          CALL      RDPTBMD1
          BRANCH    OVRCD,UPPBMN99
UPPBMN85  CALL      RKPTBMD1
          BRANCH    OVRCD,UPPBMN99
          ADD       ONE,CNTREADS
          MATCH     TRNTOWRD,PTBDWARD
          GOTO      UPPBMN99 IF NOT EQUAL
          MATCH     TRNTOBED,PTBDWBED
          GOTO      UPPBMN99 IF NOT EQUAL
.
          MATCH     DAADMNO,PTBDADMN
          GOTO      UPPBMN85 IF EQUAL
.
          MATCH     EXPDSDTE,PTBDDATE
          IF        @LESS
            GOTO      UPPBMN88
          ENDIF
          GOTO      UPPBMN85 IF NOT EQUAL
.
          MATCH     EXPDSTME,PTBDADTM
          IF        @EQUAL | @LESS
            GOTO      UPPBMN88
          ENDIF
.
          GOTO      UPPBMN85
.
UPPBMN88  MOVE      "1",PTBDOVER
          CALL      UPPTBMD1
          GOTO      UPPBMN85
.
UPPBMN99  RETURN
.
.-------------------------------------------------------------------------
.DELBMN00 - Delete old patbmdaf records
.-------------------------------------------------------------------------
DELBMD00  MOVE      SP70,SAVEBRQN
DELBMD05  PACK      KEY30,AADMNO,SP70
          CALL      RSPTBMD2
          CALL      RKPTBMD2
          BRANCH    OVRCD,DELBMD99
          MATCH     DAADMNO,PTBDADMN
          GOTO      DELBMD99 IF NOT EQUAL
.
          MOVE      PTBDBRQN,SAVEBRQN
          PACK      KEY30,PTBDADMN,PTBDDATE,PTBDADTM,PTBDWARD,PTBDWBED,PTBDOPPE,SP70
          CALL      DEPTBMD2
          GOTO      DELBMD05
.
DELBMD99  RETURN
.-------------------------------------------------------------------------
.GETEDT00 - Get Expected Discharge Date and Time
.-------------------------------------------------------------------------
GETEDT00  COMPARE   ZERO,ADJDAYS
          IF        @EQUAL
            MOVE      STRTDATE,EXPDSDTE
            GOTO      GETEDT50
          ENDIF
.
          UNPACK    STRTDATE,CCENT,CYEAR,CMON,CDAY
          CALL      ADJDAT00
          PACK      EXPDSDTE,CCENT,CYEAR,CMON,CDAY
.
GETEDT50  COMPARE   ZERO,ADJTIME
          IF        @EQUAL
            MOVE      STRTTIME,EXPDSTME
            GOTO      GETEDT99
          ENDIF
.
          CALL      CLDUR000
          MOVE      KEY5,EXPDSTME
.
GETEDT99  RETURN
.
.-------------------------------------------------------------------------
.GTTOTM00 - Get total time for regime codes
.-------------------------------------------------------------------------
GTTOTM00  MOVE      ZERO,ADJTIME
          MOVE      ONE,F1
          MOVE      SP70,DIM10
GTTOTM10  COMPARE   F1,FOUR
          GOTO      GTTOTM99 IF EQUAL
          LOAD      DIM10,F1,PTRGM001,PTRGM002,PTRGM003
.
          PACK      DIM10,DIM10,SP70
          MATCH     SP70,DIM10
          IF        @EQUAL|@EOS
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          PACK      KEY13,DIM10,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1
          IF        OVRCD=1
            ADD       ONE,F1
            GOTO      GTTOTM10
          ENDIF
.
          MOVE      ZERO,FORM3
          SQUEEZE   PMREELOS
          MOVE      PMREELOS,FORM3
          ADD       FORM3,ADJTIME
          ADD       ONE,F1
          GOTO      GTTOTM10
.
GTTOTM99  RETURN
.
.-------------------------------------------------------------------------
. SPRGM000 - Set Parameters for Admission Multiple Regime Codes
. Returns:    EXIT   0
.                    1
.-------------------------------------------------------------------------
.
SPRGM000  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,F3
          BRANCH    F3,SPRGM010,SPRGM020,SPRGM030
.
          GOTO      SPRGM910
.
SPRGM010  MOVE      QRYDATA,PTRGM001
          GOTO      SPRGM900
.
SPRGM020  MOVE      QRYDATA,PTRGM002
          GOTO      SPRGM900
.
SPRGM030  MOVE      QRYDATA,PTRGM003
          GOTO      SPRGM900
.
SPRGM900  MOVE      ZERO,EXIT
          GOTO      SPRGM999
.
SPRGM910  MOVE      ONE,EXIT
.
SPRGM999  RETURN
+
.-------------------------------------------------------------------------
. GRGM0000 - Get regime code description
. Parameters: FORM1 - Regime code description to be retrieved
. Returns:    DIM40 - Regime code description
.-------------------------------------------------------------------------
GRGM0000  MOVE      ZERO,FORM1A
          MOVE      SP70,DIM40
.
          PACK      KEY10,DIM8,SP70
          CALL      RSPTRGM1
GRGM0010  CALL      RKPTRGM1
          BRANCH    OVRCD,GRGM9999
.
          MATCH     DIM8,PTRGADMN
          GOTO      GRGM9999 IF NOT EQUAL
.
          ADD       ONE,FORM1A
.
          COMPARE   FORM1,FORM1A
          GOTO      GRGM0010 IF NOT EQUAL 
.
          PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1 
          BRANCH    OVRCD,GRGM9999
.
          MOVE      PMREDESC,DIM40
.
GRGM9999  RETURN
+
.-------------------------------------------------------------------------
. FWBD0000 - Format ward/bed text                
.-------------------------------------------------------------------------
FWBD0000  MOVE      SP70,WBEDTEXT                                               
          MOVE      SP70,WARDTEXT                                               
          MOVE      SP70,BEDTEXT                                                
          MATCH     SP70,KEY6                                                   
          GOTO      FWBD9999 IF EQUAL                                           
.                                                                               
          PACK      KEY8,WWARD,WBED,SP70   * save current patwr1af key          
          UNPACK    KEY6,WARDKEY,BEDKEY                                         
.                                                                               
          IF        WBEDDESC = 0                                                
            GOTO      FWBD5000                                                  
          ENDIF                                                                 
.                                                                               
          PACK      KEY6,WARDKEY,SP70                                           
          CALL      RDWARD1                                                     
          BRANCH    OVRCD,FWBD5000                                              
.                                                                               
          IF        WBEDDESC = 2                                                
            PACK      WARDTEXT,PTWDSDES,SP70                                    
          ELSE                                                                  
            PACK      WARDTEXT,WBDESC,SP70                                      
          ENDIF                                                                 
.                                                                               
          MATCH     SP70,BEDKEY                                                 
          GOTO      FWBD8000 IF EQUAL                                           
          PACK      KEY6,WARDKEY,BEDKEY                                         
          CALL      RDWARD1                                                     
          IF        OVRCD<>0                                                    
            APPEND    BEDKEY,BEDTEXT                                            
            GOTO      FWBD8000                                                  
          ENDIF                                                                 
          IF        WBEDDESC = 2                                                
            PACK      BEDTEXT,PTWDSDES,SP70                                   
          ELSE                                                                  
            PACK      BEDTEXT,WBDESC,SP70                                            
          ENDIF                                                                 
          GOTO      FWBD8000                                                    
.                                                                               
FWBD5000  MOVE      WARDKEY,WARDTEXT                                            
.         MATCH     SP70,BEDKEY                                                 
.         GOTO      FWBD9999 IF EQUAL                                           
          MOVE      BEDKEY,BEDTEXT                                              
          GOTO      FWBD9000                                                    
.                                                                               
FWBD8000  PACK      KEY6,KEY8                                                   
          CALL      RDWARD1           * reset Ward file just in case            
.                                                                               
FWBD9000  CLEAR     WBEDTEXT                                                    
          STRIP     WARDTEXT                                                    
          APPEND    WARDTEXT,WBEDTEXT                                           
.                                                                               
          MATCH     SP3,BEDKEY                                                  
          IF        !@EQUAL                                                      
            APPEND    "/",WBEDTEXT                                              
            APPEND    BEDTEXT,WBEDTEXT                                          
          ENDIF                                                                 
          RESET     WBEDTEXT                                                    
.                                                                               
FWBD9999  RETURN                                                                
+ 
.-------------------------------------------------------------------------
. FBED0000 - Format bed text                
.            Assumes we are postioned on correct patwr1af row
.-------------------------------------------------------------------------
FBED0000  MOVE      SP70,BEDTEXT  
          CLEAR     BEDTEXT
          MATCH     SP70,WBED
          GOTO      FBED9000 IF EQUAL
.
          IF        WBEDDESC > 0
            IF        WBEDDESC = 2                                                
              APPEND    PTWDSDES,BEDTEXT                                          
            ELSE                                                                  
              APPEND    WBDESC,BEDTEXT                                            
            ENDIF
          ELSE
            APPEND    WBED,BEDTEXT
          ENDIF
.
FBED9000  RESET     BEDTEXT
          STRIP     BEDTEXT
FBED9999  RETURN
.------------------------------------------------------------
. Format FHIR Ward Display Name
.------------------------------------------------------------
FWDNAM00  CLEAR     FRWRDTXT
          MOVE      SP70,FRWRDTXT
.
          MATCH     SP70,AWARD
          GOTO      FWDNAM99 IF EQUAL
.
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=0
            STRIP     WBDESC
            MOVE      WBDESC,FRWRDTXT
          ELSE
            STRIP     AWARD
            MOVE      AWARD,FRWRDTXT
          ENDIF
.
FWDNAM99  RETURN
.
.------------------------------------------------------------
. Format FHIR Bed Display Name
.------------------------------------------------------------
FBDNAM00  CLEAR     FRBEDTXT
          MOVE      SP70,FRBEDTXT
.
          MATCH     SP70,ABED
          GOTO      FBDNAM99 IF EQUAL
.
          PACK      KEY6,AWARD,ABED
          CALL      RDWARD1
          IF        OVRCD=0
            STRIP     WBDESC
            MOVE      WBDESC,FRBEDTXT
          ELSE
            STRIP     ABED
            MOVE      ABED,FRBEDTXT
          ENDIF
.
FBDNAM99  RETURN
+                                                
.****************************************************************************
.*        IO ROUTINES FOR TEMPORARY FILE                                    *
.****************************************************************************
.
.         Index 1
.
RSTEMP1   READ      ECLTEMP1,KEY24;;
          RETURN
.
RDTEMP1   MOVE      ZERO,OVRCD
          READ      ECLTEMP1,KEY24;PMEDTRID,PMEDFTID,PMEDRADV,PMEDPNUM,PARTPANT
          GOTO      OVERCOND IF OVER
          RETURN
.
RKTEMP1   MOVE      ZERO,OVRCD
          READKS    ECLTEMP1;PMEDTRID,PMEDFTID,PMEDRADV,PMEDPNUM,PARTPANT
          GOTO      OVERCOND IF OVER
          RETURN
.
RPTEMP1   MOVE      ZERO,OVRCD
          READKP    ECLTEMP1;PMEDTRID,PMEDFTID,PMEDRADV,PMEDPNUM,PARTPANT
          GOTO      OVERCOND IF OVER
          RETURN
.
WRTEMP1   WRITE     ECLTEMP1,KEY24;PMEDTRID,PMEDFTID,PMEDRADV,PMEDPNUM,PARTPANT
          RETURN
.
UPTEMP1   UPDATE    ECLTEMP1;PMEDTRID,PMEDFTID,PMEDRADV,PMEDPNUM,PARTPANT
          RETURN
.
DETEMP1   DELETE    ECLTEMP1,KEY24
          RETURN
.
.         Index 2
.
RSTEMP2   READ      ECLTEMP2,KEY27;;
          RETURN
.
RKTEMP2   MOVE      ZERO,OVRCD
          READKS    ECLTEMP2;PMEDTRID,PMEDFTID,PMEDRADV,PMEDPNUM,PARTPANT
          GOTO      OVERCOND IF OVER
          RETURN
+
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABH000  MOVE      ZERO,NUMOFPAT                * Number of patients in ward
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
.
          MOVE      WINPUT,NOBEDWRD              * Save Ward Hdr WO/BO status
.
. No Bed 
.
          MOVE      ZERO,CLOSEFLG
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABH100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABH190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABH190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDH000         * Output Row Details
          GOTO      CTABH100
.
. Ward/Bed Details
.
CTABH190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABH200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABH290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABH290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABH200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CTABH220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CTABH200
            MATCH     OWARD,WWARD
            GOTO      CTABH200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CTABH200 IF NOT EQUAL
          ENDIF
CTABH220  BRANCH    WACTIVE,CTABH200       * Do not display Inactive Beds
          CALL      CROWH000
          GOTO      CTABH200
.
. On Leave Patients
.------------------
CTABH290  BRANCH    WBEDTYPE,CTABH300,CTABH999
. 
CTABH300  MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABH800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABH999
          MATCH     OWARD,WARDCODE
          GOTO      CTABH999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABH800 IF EQUAL
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABH850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABH850  CALL      CBEDH000         * Output Row Details
          GOTO      CTABH800
.
CTABH999  RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWH000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWH800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (IGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,CROWH100,CROWH999
.
CROWH100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG
          CALL      CBEDH000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWH999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDH000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWH999
.
CROWH800  MOVE      SP70,PATFNAME
          MATCH     "1",PTWDBDST     * Is this bed closed?
          IF        @EQUAL
            MOVE      "Bed Closed",PATFNAME
            GOTO      CROWH850
          ELSE
            MOVE      "Empty Bed",PATFNAME
          ENDIF
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWH810  CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWH850
          MATCH     OWARD,WWARD
          GOTO      CROWH850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWH850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID     * Bed has patient on leave
          MOVE      "Patient On Leave",PATFNAME
.
CROWH850  WRITE     HTMLFILE;"t.addRow(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"#",":
                             "#"#",":
                             "#"",PATFNAME,"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#");"

CROWH999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDH000  PACK      SECDOCDE,SP70
.
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CBEDH010
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,CBEDH010
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          MOVE      PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
.
CBEDH010  MATCH     "1",ANAESTFL                                      *I-174468
          IF        @EQUAL
            CALL      GETAN000              * get Anaesthetist
          ENDIF
.
          CALL      XRET0000                * Exp return from leave date/time 
.
          MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIETDESC
.
          CALL      GETCON00               * Get Patient Condition Details
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
          UNPACK    IMGSRC,KEY10,CONDINDC
.
          WRITE     HTMLFILE;"t.addRow(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"",PURNO,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          WRITE     HTMLFILE;"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",DOCFNAME,"#",":
                             "#"",ADATE,"#",":
                             "#"",DDATE,"#",":
                             "#"",DESTDESC,"#",":
                             "#"",ADIET,"#",":
                             "#"",DIETDESC,"#",":
                             "#"",PATLINK,"#",":
                             "#"",PMWOEDAT,PMWOEDTM,"#",":
                             "#"",CONLINK,"#",":
                             "#"",CONDESC,DISPDATE,SP1,LPCONDD,SP1,VISPHONE,"#",":
                             "#"",CONDINDC,"#",":
                             "#"",FOLDERSF,"#",":
                             "#"",COLRFLAG,"#",":
                             "#"",CLOSEFLG,"#",":
                             "#"",STBYFLAG,"#",":
                             "#"",PTWDCOMM,"#",":
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4,PTMXSIN5,"#",":
                             "#"",FILETYPE,"#");"

.
CBEDH999  RETURN
.------------------------------------------------------------
. Output Bed Management View
.------------------------------------------------------------
BEDMV000  PACK      KEY30,WARDCODE,LASTDATE,SP70
          CALL      RSPTBMD4
BEDMV100  CALL      RKPTBMD4
          BRANCH    OVRCD,BEDMV999
          MATCH     WARDCODE,PTBDWARD
          GOTO      BEDMV999 IF NOT EQUAL
          MATCH     PTBDDATE,LASTDATE
          GOTO      BEDMV999 IF NOT EQUAL
.
          PACK    KEY8,PTBDADMN,SP70
          CALL    RDBKREC1
          IF      OVRCD=0
            COMPARE   TWO,BKRESTAT
            GOTO      BEDMV100 IF EQUAL
            MOVE      BKREURNO,TEMPURNO
          ELSE
            CALL    CLBOKRC1
          ENDIF
.
          PACK    KEY8,PTBDADMN,SP70
          CALL    RDBKRX11
          IF      OVRCD=1
            CALL    CLBOKRX1
          ENDIF
.
          CALL    RDMISS1
          IF      OVRCD=0
            MATCH     "5",DASTAT
            GOTO      BEDMV100 IF EQUAL
            MOVE      AURNO,TEMPURNO
          ELSE
            CALL    CLPATMIS
            PACK    ADATE,BKREEDAT
            PACK    ATIME,BKREATIM
            PACK    ACLSSFT,BKREDEPT
            PACK    ADOCTA,BKREADOC
            PACK    AFUNDH,SP70
            PACK    AFNDTB,SP70
            PACK    KEY8,TEMPURNO,SP70
            CALL    RDMAST1
            IF      OVRCD=0
              PACK    AFUNDH,PFUNDH
              PACK    AFNDTB,PFNDTB
            ENDIF
          ENDIF
.
          PACK      KEY18,DIM8,SP70
          CALL      RABKDIA1
          CALL      RKBKDIA1
          IF        OVRCD<>1
            MATCH   DIM8,DBKDIBOO
            IF      @EQUAL
              MOVE    BKDIDES1,ADIAG1
            ENDIF
          ENDIF
.
          MOVE      TEMPURNO,URNUMBER
          PACK      ADMISSNO,PTBDADMN
.
          PACK      KEY6,PTBDWARD,PTBDWBED,SP70  * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,BEDMV100
.
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
          CALL      GETPAT00
          CALL      PATLN000
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,BEDMV110
.
BEDMV110  
          CALL      RGMCOD00                     * Get 3 Reg Codes
          CALL      GETSP000                     * Get Speciality
          CALL      GETAD000                     * Get Attending Doctor
          CALL      GETHF000                     * Get Health Fund
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            MOVE      SP70,PMWOEDAT
            MOVE      SP70,PMWOEDTM
          ENDIF
          REP       "#" ",ADIAG1
          REP       "#' ",ADIAG1
          WRITE     HTMLFILE;"mapView.addEvent(#"",PTBDWARD,"#",":
                             "#"",PTBDWBED,"#",":  *1
                             "#"",PURNO,"#",":     *2
                             "#"",ADMISSNO,"#",":  *3
                             "#"",PATFNAME,"#",":  *4
                             "#"",PSEX,"#",":      *5
                             "#"";
          CALL      WRTAGE00                       *6
          WRITE     HTMLFILE;"#",":
                             "#"",PTBDADTM,"#",":  *7
                             "#"",PTBDLOSM,"#",":  *8
                             "#"",PTBDLOSD,"#",":  *9
                             "#"",PTBDOPPE,"#",":  *10
                             "#"",PTBDSTAT,"#",":  *11
                             "#"",PTBDOVER,"#",":  *12
                             "#"",PTBDBRQN,"#",":  *13
                             "#"",ADIAG1,"#",":  *14
                             "#"",DOCFNAME,"#",":  *15
                             "#"",ADATE,"#",":     *16
                             "#"",DDATE,"#",":     *17
                             "#"",PMWOEDAT,PMWOEDTM,"#",":   *18
                             "#"",SPECDESC,"#",":  *19
                             "#"",FUNDDESC,"#",":  *20
                             "#"",RGMNAM01,"#",":  *21
                             "#"",RGMNAM02,"#",":  *22
                             "#"",RGMNAM03,"#",":  *23
                             "#"",RGMSTA01,"#",":  *24
                             "#"",RGMSTA02,"#",":  *25
                             "#"",RGMSTA03,"#",":  *26
                             "#"",PTELEP,"#",":  *27
                             "#"",PTBDWARD,PTBDWBED,PTBDADTM,"#",":  *28 Sort Order
                             "#"",RGMCOD01,"#",":  *29
                             "#"",RGMCOD02,"#",":  *30
                             "#"",RGMCOD03,"#",":  *31
                             "#"";
.
          MOVE      ADMISSNO,KEY8                    *32 3xComment Lines
          CALL      VSCMNT00                    
.
BEDMV290  MOVE      SP70,TDESC
          MATCH     SP70,BKRXDROR
          IF        !@EQUAL
            MOVE      BKRXDROR,TDESC
            MOVE      "Ba",CATEGORY
            MOVE      BKRXDROR,CODE
            CALL      GETCOD00
          ENDIF
          WRITE     HTMLFILE;"#",":
                             "#"",TDESC;  *33
.
          WRITE     HTMLFILE;"#");"
          GOTO      BEDMV100
.
BEDMV999  RETURN
.
.----------------------------------------------------------------------
. Retrieve the 1st 3 comment text lines of the latest active visit
. comment details
.----------------------------------------------------------------------
.
VSCMNT00  PACK      KEY17,KEY8,VSCMTTYP,Z70      * Key for start of comment
          CALL      RSVSMDT1
VSCMNT20  CALL      RPVSMDT1
          BRANCH    OVRCD,VSCMNT99
.
          MATCH     KEY8,VSMDVISN
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSCMTTYP,VSMDTYPE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     "1",VSMDDELT          * is comment deleted
          GOTO      VSCMNT20 IF EQUAL
.
. Retrieve the comment text line details
.
          MOVE      ZERO,F1
          PACK      KEY20,VSMDVISN,VSMDTYPE,VSMDNOTE,SP70
          CALL      RSVSMTX1
VSCMNT60  CALL      RKVSMTX1
          BRANCH    OVRCD,VSCMNT99
.
          MATCH     VSMDVISN,VSMTVISN
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSMDTYPE,VSMTTYPE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          MATCH     VSMDNOTE,VSMTNOTE
          GOTO      VSCMNT99 IF NOT EQUAL
.
          ADD       ONE,F1
          REP       "#" ",VSMTCMNT
          REP       "#' ",VSMTCMNT
          WRITE     HTMLFILE;VSMTCMNT;
          COMPARE   THREE,F1               * only 3 comment text is  used     
          GOTO      VSCMNT60 IF NOT EQUAL 
.
VSCMNT99  RETURN
.
.----------------------------------------------------------------------
BEDLO000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
BEDLO100  CALL      RDKWARD1
          BRANCH    OVRCD,BEDLO999
          MATCH     WARDCODE,WWARD
          GOTO      BEDLO999 IF NOT EQUAL
.
          BRANCH    WACTIVE,BEDLO100       * Do not display Inactive Beds
.
          WRITE     HTMLFILE;"mapView.addBed(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"",WBDESC,"#",":
                             "#"",WEXTN,"#",":
                             "#"",WACTIVE,"#",":
                             "#"",PTWDBDST,"#",":
                             "#"",PTWDHKST,"#");"
          GOTO     BEDLO100
.
BEDLO999  RETURN
.
BEDCL000  PACK     KEY22,WARDCODE,SP70
          CALL     RSPMBDC1
BEDCL010  CALL     RKPMBDC1
          BRANCH   OVRCD,BEDCL999
.
          MATCH    WARDCODE,PMBCWARD
          GOTO     BEDCL999 IF NOT EQUAL
.
          MATCH    PMBCFRDT,LASTDATE
          GOTO     BEDCL010 IF LESS
.
          MATCH    LASTDATE,PMBCTODT
          GOTO     BEDCL010 IF LESS
.
          WRITE     HTMLFILE;"mapView.addClosure(#"",PMBCWARD,"#",":
                             "#"",PMBCBED,"#",":
                             "#"",PMBCFRDT,"#",":
                             "#"",PMBCFRTM,"#",":
                             "#"",PMBCTODT,"#",":
                             "#"",PMBCTOTM,"#");"
.
          GOTO     BEDCL010
.
BEDCL999  RETURN
.
GETSP000  MOVE      SP70,SPECDESC
          MATCH     SP70,ACLSSFT
          IF        !@EQUAL
            PACK      KEY5,ANSA,ANSC,ACLSSFT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      TDESC,SPECDESC
            ENDIF
          ENDIF
          RETURN
.
GETAD000  MOVE      SP70,DOCFNAME
          MATCH     SP70,ADOCTA
          IF        !@EQUAL
            MOVE      SP70,DOCFNAME
            PACK      KEY10,ADOCTA,SP70
            CALL      RDPMHCP1
            IF        OVRCD<>1
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
              REP       "'`",DOCFNAME
            ENDIF
          ENDIF
          RETURN
.
GETHF000  CLEAR     FUNDDESC
          MATCH     SP70,AFUNDH
          IF        !@EQUAL
            PACK      KEY14,AFUNDH,ZERO,ZERO,ZERO,ZERO,SP70
            CALL      RDFUND1
            IF        OVRCD<>1
              APPEND    HFNAME,FUNDDESC
            ENDIF
            PACK      KEY14,AFUNDH,AFNDTB,SP70
            CALL      RDFUND1
            IF        OVRCD<>1
              APPEND    " - ",FUNDDESC
              APPEND    HFNAME,FUNDDESC
            ENDIF
         ENDIF
         APPEND   SP1,FUNDDESC
         RESET    FUNDDESC
         RETURN
.
RGMCOD00  MOVE      ZERO,FORM1A 
          MOVE      SP70,RGMCOD01
          MOVE      SP70,RGMCOD02
          MOVE      SP70,RGMCOD03
          MOVE      SP70,RGMNAM01
          MOVE      SP70,RGMNAM02
          MOVE      SP70,RGMNAM03
          MOVE      SP70,RGMSTA01
          MOVE      SP70,RGMSTA02
          MOVE      SP70,RGMSTA03
.    
          PACK      KEY10,ADMISSNO,SP70
          CALL      RSPTRGM1
RGMCOD10  CALL      RKPTRGM1
          BRANCH    OVRCD,RGMCOD99
          MATCH     ADMISSNO,PTRGADMN
          GOTO      RGMCOD99 IF NOT EQUAL
.
          PACK      KEY13,PTRGREGM,SP1,SP1,ZERO,SP70
          CALL      RDPMREG1 
          BRANCH    OVRCD,RGMCOD10
.
          ADD       ONE,FORM1A
          STORE     PMREREGM,FORM1A,RGMCOD01,RGMCOD02,RGMCOD03
          STORE     PMREDESC,FORM1A,RGMNAM01,RGMNAM02,RGMNAM03
          PACK      KEY5,CODS,CODN,PMRESNCD,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            STORE     TCINDC1,FORM1A,RGMSTA01,RGMSTA02,RGMSTA03
          ENDIF
.
          COMPARE   THREE,FORM1A
          GOTO      RGMCOD10 IF NOT EQUAL
.
RGMCOD99  RETURN
.------------------------------------------------------------------------------
. Special Needs Ledgend
.------------------------------------------------------------------------------
SNLD0000  PACK      KEY50,SP70
          PACK      KEY5,CATSN,SP70
          CALL      RDSCODE1
SNLD1000  CALL      RDKCODE1
          BRANCH    OVRCD,SNLD9999
          MATCH     TCODE,CATSN
          GOTO      SNLD9999 IF NOT EQUAL
          MATCH     "I",PTCOACTV
          GOTO      SNLD1000 IF EQUAL
          MATCH     SP70,TCINDC1
          GOTO      SNLD1000 IF EQUAL
          SCAN      TCINDC1,KEY50
          GOTO      SNLD1000 IF EQUAL
          STRIP     KEY50
          PACK      KEY50,KEY50,TCINDC1,SP70
.
          WRITE     HTMLFILE;"mapView.addRegime(#"",TCINDC1,"#",":
                             "#"",TDESC,"#",":
                             "#"",PTCDLDES,"#");"
          GOTO      SNLD1000
.
SNLD9999  RETURN
.
.------------------------------------------------------------
. Displays Current Patient ward/bed details
.------------------------------------------------------------
CTABI000  UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          UNPACK    DIM127,D1,DLINKPRG,DIM127
          UNPACK    DIM127,D1,DLINKREP,DIM127
          UNPACK    DIM127,D1,DLINKTEM,DIM127
          UNPACK    DIM127,D1,WORKFLAG,DIM127    * Working Diag Flag
          UNPACK    DIM127,D1,PRNTLABL,DIM127    * Print Labels Flag
          UNPACK    DIM127,D1,ANAESTFL,DIM127    * Anaesthetist Flag
          UNPACK    DIM127,D1,SKIPDIET,DIM127    * Skip DIet Text
          UNPACK    DIM127,D1,MHLSFLAG,DIM127    * MH Legal Status Flag
.
          MOVE      WORKFLAG,WORKDFLG            * Display working diagnosis
          MOVE      MHLSFLAG,MEHLSFLG            * Display MH Legal Status 
.
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WCLASS,SAVCLASS
.
          MOVE      ZERO,NUMOFPAT                * Number of patients in ward
          MOVE      ZERO,CRSRTCNT
.
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
.
          IF        EMRGVIEW=1
            MOVE      ZERO,EMVIFLAG              * redirect supervisor clinical
            PACK      KEY5,ANSB,ANST,WEFRBT,SP70
            CALL      RDCODE1
            IF        OVRCD=0
              MATCH     "S",THCSCOD              * EOU Unit
              IF        @EQUAL
                MATCH     ANSO,TCINDC8           * Display EOU on map
                IF        @EQUAL
                  MOVE      ONE,EMVIFLAG         * redirect supervisor clinical
                ENDIF
              ENDIF
            ENDIF
            CALL      WARDET00                   * Calculate  ward statistics
          ENDIF
.
. No Bed
.
          MOVE      ZERO,CLOSEFLG
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CTABI100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CTABI190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CTABI190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
          CALL      CBEDI000         * Output Row Details
          GOTO      CTABI100
.
. Ward/Bed Details
.
CTABI190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CTABI200  CALL      RDKWARD8
          BRANCH    OVRCD,CTABI290
.
          MATCH     WARDCODE,WWARD
          GOTO      CTABI290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CTABI200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CTABI220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CTABI200
            MATCH     OWARD,WWARD
            GOTO      CTABI200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CTABI200 IF NOT EQUAL
          ENDIF
CTABI220  BRANCH    WACTIVE,CTABI200       * Do not display Inactive Beds
          CALL      CROWI000
          GOTO      CTABI200
.
. On Leave Patients
.------------------
CTABI290  BRANCH    WBEDTYPE,CTABI300,CTABI999
.
CTABI300  MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CTABI800  CALL      RDKONLV1
          BRANCH    OVRCD,CTABI999
.
          MATCH     OWARD,WARDCODE
          GOTO      CTABI999 IF NOT EQUAL
.
          MATCH     ZEROVISN,OADMNO
          GOTO      CTABI800 IF EQUAL
.
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CTABI850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CTABI850  CALL      CBEDI000         * Output Row Details
          GOTO      CTABI800
.
CTABI999  RETURN
.
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
CBEDI000  PACK      SECDOCDE,SP70
.
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
          CALL      GTDIET00
          MOVE      ADOCTA,DOCTCODE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,CBEDI010
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,CBEDI010
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          MOVE      PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
.
CBEDI010  MATCH     "1",ANAESTFL                                      *I-174468
          IF        @EQUAL
            CALL      GETAN000              * get Anaesthetist
          ENDIF
.
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          CALL      XRET0000                * Exp return from leave date/time
.
          MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
.
CBEDI050  CALL      FBED0000
          ADD       ONE,CRSRTCNT
          MOVE      SP70,DIM3
          MOVE      CRSRTCNT,DIM3
          REP       " +",DIM3
.
          BRANCH    FILETYPE,CBEDI060,CBEDI070,CBEDI080
.
CBEDI060  WRITE     HTMLFILE;"t.addRow(#"UnallocatedCell":
                             "#",#"":
                             "<input type=hidden name='",DIM3,"'> ":
                             "<img src='../images/EditIcon.gif'":
                             " class=ListIcon onclick=BedAllocation('":
                             URNUMBER,"','",ADMISSNO,"')> ",BEDTEXT,"#",";
.
          GOTO      CBEDI090
.
CBEDI070  IF        STBYFLAG=0
            MATCH     "1",CLOSEFLG     * Is this Bed Closed?
            IF        @EQUAL
              WRITE     HTMLFILE;"t.addRow(#"ClosedCell":
                                 "#",#"":
                                 "<input type=hidden name='",DIM3,"'> ":
                                 BEDTEXT,"#",";
            ELSE
              WRITE     HTMLFILE;"t.addRow(#"":
                                 "#",#"":
                                 "<input type=hidden name='",DIM3,"'> ":
                                 BEDTEXT,"#",";
            ENDIF
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"StandbyCell":
                               "#",#"":
                               "<input type=hidden name='",DIM3,"'> ":
                               BEDTEXT,"#",";
          ENDIF
.
          GOTO      CBEDI090
.
CBEDI080  MATCH     "1",CLOSEFLG     * Is this Bed Closed?
          IF        @EQUAL
            WRITE     HTMLFILE;"t.addRow(#"ClosedCell":
                               "#",#"":
                               "<input type=hidden name='",DIM3,"'> ":
                               BEDTEXT,"#",";
          ELSE
            WRITE     HTMLFILE;"t.addRow(#"LeaveCell":
                               "#",#"":
                               "<input type=hidden name='",DIM3,"'> ":
                               BEDTEXT,"#",";
          ENDIF
.
CBEDI090  PACK      DIM127A,SP70,SP70
          MOVE      FORMATNM,DIM127A
          REPLACE   "' ",DIM127A
.
          WRITE     HTMLFILE;"#"":
                "<input type=hidden value='",DIM127A,"' name='",ADMISSNO,"'> ":
                           "<img src='../images/PatientFolder",FOLDERSF,".gif'":
                             " class=ListIcon ":
                             " onclick=PatFolLink('",LINKPRG,".pbl":
                             "?reportno=",LINKREP:
                             "&template=",LINKTEM:
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"');>";
.
          IF        DISPDNAM=1
            REP       "+ ",ADMISSNO
            REP       "+ ",URNUMBER
            CALL      CHKD0000           * Duplicate Surnames?
            IF        DUPNMFLG=1
              WRITE     HTMLFILE;"<img src='../images/samename.gif'":
                                 " title='Patient Name Conflict'":
                                 " class=ListIcon>";
            ENDIF
            REP       " +",ADMISSNO
            REP       " +",URNUMBER
.
          ENDIF
.
          WRITE     HTMLFILE;FORMATNM,"#",";
.
CBEDI100  CALL      GETCON00               * Get Patient Condition Details
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT
          ELSE
            CLEAR     DISPDATE
          ENDIF
.
          WRITE     HTMLFILE;"#"";
.
          REP       " +",CONDESC1
          WRITE     HTMLFILE;"<input type=hidden name='",CONDESC1,"'>";
          REP       "+ ",CONDESC1
.
.
.
          MOVE      ZERO,EXIT
          PROC      DISPALRT                * check for Disability Alerts
          IF        EXIT=0 | EXIT=2
            MATCH     "1",PMPXSIN7
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconM.gif'":
                                 " title='Medical Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSIN8
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconB.gif'":
                                 " title='Micro Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSIN9
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconR.gif'":
                                 " title='Risk Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PMPXSN11
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconC.gif'":
                                 " title='Chronic Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
.
            MATCH     "1",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
              GOTO      CBEDI120
            ENDIF
.
            MATCH     "2",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconBlack.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
              GOTO      CBEDI120
            ENDIF
.
            MATCH     "3",PTMXSIN1
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIconDelete.gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
              GOTO      CBEDI120
            ENDIF
.
            MATCH     SP70,PTMXSIN1
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/AlertIcon":
                                 PTMXSIN1,".gif'":
                                 " title='Alerts'":
                                 " class=ListIcon onclick=PatientAlerts('":
                                 URNUMBER,"','",ADMISSNO,"')>";
            ENDIF
          ENDIF
.
CBEDI120  IF        EXIT=1 | EXIT=2
            WRITE     HTMLFILE;"<img src='../images/AlertIconDIS.gif'":
                               " title='Disability Alerts'":
                               " class=ListIcon onclick=PatientAlerts('":
                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
          MATCH     "1",PTMXSIN2
          IF        @EQUAL
.            WRITE     HTMLFILE;"<img src='../images/ResultIcon.gif'":
.                               " class=ListIcon onclick=PatientResults('":
.                               URNUMBER,"','",ADMISSNO,"')>";
          ENDIF
.
          IF        EMRGVIEW=1
            CALL      GETE0000
            MATCH     ZEROVISN,EMVIADMN
            IF        !@EQUAL
              WRITE     HTMLFILE;"<img src='../images/DocumentIcon.gif'":
                                 " class=ListIcon ":
                                 " title='Update emergency clinic notes'" :
                                 " onclick=UpdateEMR('":
                             URNUMBER,"','",EMVIADMN,"','",EMVIFLAG,"')>";
            ENDIF
          ENDIF
.
.-------- Get Over flow description --------                         *C-0837181
          MOVE      SP70,OVFLDESC
          IF        HEAVIEW=1
            CALL      OVFDS000                         * Get OVFLDESC
          ENDIF
.
CBEDI122  IF        MEHLSFLG=1
            CALL      CMHLM000              * Check for MH legal status icon
          ENDIF
.
          IF        WORKDFLG=1
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,WORKDESC,OVFLDESC; 
            ELSE
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",PMVXUDF2:
                                 WORKDESC; 
            ENDIF
            GOTO      CBEDI130
          ENDIF
.
          MATCH     SP70,LPCONDD
          IF        @EQUAL
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC; 
            ELSE
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",PMVXUDF2;  
            ENDIF
          ELSE
            MATCH     SP70,PMVXUDF2
            IF        @EQUAL
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD; 
            ELSE
              WRITE     HTMLFILE;"<img src='../images/",IMGSRC:
                                 "' class=ListIcon onclick=UpdateCondition('":
                                 URNUMBER,"','",ADMISSNO,"')>":
                                 CONDESC,DISPDATE,OVFLDESC,"<br>",LPCONDD:
                                 "<br>",PMVXUDF2; 
            ENDIF
          ENDIF
.
CBEDI130  MATCH     SP70,PMPXABRG           * Aboriginality (Cat VA) FLAG
          IF        !@EQUAL
            PACK      KEY5,ANSV,ANSA,PMPXABRG,SP70
            CALL      RDCODE1
            IF        OVRCD = 0
              MATCH     ANSD,TCINDC3
              IF        @EQUAL
                WRITE     HTMLFILE;"<img src='../images/aboriginality.png'":
                                   " title='aboriginalityIcon' >";
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE ANSV,DIM1
          ENDIF
          WRITE     HTMLFILE;"<br>[",DIM1,COMMA,NBSP;
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE ANSP,DIM1
          ENDIF
          WRITE     HTMLFILE;DIM1,"]";
.
          BRANCH    KIDSONLY,CBEDI140
          MATCH     SP3,LPCONAM
          IF        !@EQUAL
            MOVE      "AM",CATEGORY
            MOVE      LPCONAM,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,NBSP,TDESC;
          ENDIF
.
CBEDI140  MATCH     SP3,PMWODPST
          IF        !@EQUAL
            MOVE      "vi",CATEGORY
            MOVE      PMWODPST,CODE
            CALL      GETCOD00
            WRITE     HTMLFILE;NBSP,TDESC;
          ENDIF
.
          REP       "+ ",URNUMBER
          REP       "+ ",ADMISSNO
.
          MOVE      ZERO,BORDICIN
          PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDI142  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDI142 IF LESS            * CAR 304926
                GOTO      CBEDI143 IF NOT EQUAL       * CAR 304926
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDI142 IF LESS          * CAR 304926
                ENDIF
              ENDIF
CBEDI143      ADD       ONE,BORDICIN
              COMPARE   TWO,BORDICIN
              GOTO      CBEDI144 IF EQUAL
              GOTO      CBEDI142
            ENDIF
          ENDIF
.
CBEDI144  PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
CBEDI145  CALL      RKPTBRD3
          IF        OVRCD=0
            MATCH     ADMISSNO,PTBRVISN
            IF        @EQUAL
              MATCH     SP70,PTBREDAT
              IF        !@EQUAL & !@EOS
                MATCH     TODAYDAT,PTBREDAT
                GOTO      CBEDI145 IF LESS            * CAR 304926
                GOTO      CBEDI146 IF NOT EQUAL       * CAR 304926
.
                MATCH     SP70,PTBRETIM
                IF        !@EQUAL & !@EOS
                  MATCH     CTIMEIS,PTBRETIM
                  GOTO      CBEDI145 IF LESS          * CAR 304926
                ENDIF
              ENDIF
.
CBEDI146        MOVE      SP70,DISPBBDT
                MATCH     SP70,PTBRBDAT
                IF        !@EQUAL & !@EOS
                  UNPACK    PTBRBDAT,CCENT,CYEAR,CMON,CDAY
                  MOVE      CMON,F2
                  LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                       JUL,AUG,SEP,OCT,NOV,DEC
                  PACK      DISPBBDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
                  CALL      IBACLOCK
                  PACK      AGEDATE,CCC,CYY,CMM,CDD
                  PACK      PBDATE,PTBRBDAT
                  CALL      CALCAGE
                  MOVE      PSAGEYRS,PSAGEDIM
                ELSE
                  MOVE      SP70,PSAGEDIM
                ENDIF
.
                MOVE      SP70,DISPBSDT
                MATCH     SP70,PTBRSDAT
                IF        !@EQUAL & !@EOS
                  UNPACK    PTBRSDAT,CCENT,CYEAR,CMON,CDAY
                  MOVE      CMON,F2
                  LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN:
                                       JUL,AUG,SEP,OCT,NOV,DEC
                  PACK      DISPBSDT,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
                ENDIF
.
                IF        BORDICIN=2
                  MATCH     SP70,PTBRADR1
                  IF        @EQUAL | @EOS
                    MATCH     SP70,PTBRADR2
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRADR3
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRADR4
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRPOST
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRHPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRWPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRMPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBREMAL
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    MATCH     SP70,PTBRLURN
                    IF        @EQUAL | @EOS
                      GOTO      CBEDI147
                    ENDIF
.
                    PACK      KEY8,PTBRLURN,SP70
                    CALL      RDMAST1
                    IF        OVRCD
                      PACK      KEY8,URNUMBER,SP70
                      CALL      RDMAST1
.
                      GOTO      CBEDI147
                    ENDIF
.
                    CALL      RDPMPX21
.
                    REP       " +",URNUMBER
                    REP       " +",ADMISSNO
                    REP       " +",PTBRBRDN
.
                    WRITE     HTMLFILE;"&nbsp;&nbsp;<img src='../images/PatientLink4.gif' class=ListIcon":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');";
.
                    REP       "+ ",URNUMBER
                    REP       "+ ",ADMISSNO
                    REP       "+ ",PTBRBRDN
.
                    REP       "'` +",PTBRSNAM
                    REP       "'` +",PTBRGNAM
                    REP       " +",PTBRGEND
                    REP       " +",DISPBBDT
                    REP       " +",PSAGEDIM
                    REP       "'` +",PADD1
                    REP       "'` +",PADD2
                    REP       "'` +",PSUBRB
                    REP       "'` +",PADD4
                    REP       " +",PPOST
                    REP       " +",PTELEP
                    REP       " +",PTELEB
                    REP       " +",PTMXCELL
                    REP       " +",PMPXPEML
                    REP       " +",DISPBSDT
                    REP       " +",PTBRSTIM
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                    WRITE     HTMLFILE;" onmouseover=showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PADD1,"'":
                                                  ",'",PADD2,"'":
                                                  ",'",PSUBRB,"'":
                                                  ",'",PADD4,"'":
                                                  ",'",PPOST,"'":
                                                  ",'",PTELEP,"'":
                                                  ",'",PTELEB,"'":
                                                  ",'",PTMXCELL,"'":
                                                  ",'",PMPXPEML,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
.
                    REP       "`'+ ",PTBRSNAM
                    REP       "`'+ ",PTBRGNAM
                    REP       "+ ",PTBRGEND
                    REP       "+ ",DISPBBDT
                    REP       "+ ",PSAGEDIM
                    REP       "`'+ ",PADD1
                    REP       "`'+ ",PADD2
                    REP       "`'+ ",PSUBRB
                    REP       "`'+ ",PADD4
                    REP       "+ ",PPOST
                    REP       "+ ",PTELEP
                    REP       "+ ",PTELEB
                    REP       "+ ",PTMXCELL
                    REP       "+ ",PMPXPEML
                    REP       "+ ",DISPBSDT
                    REP       "+ ",PTBRSTIM
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                    PACK      KEY8,URNUMBER,SP70
                    CALL      RDMAST1
                    CALL      RDPMPX21
.
                  ELSE
.
CBEDI147            REP       " +",URNUMBER
                    REP       " +",ADMISSNO 
                    REP       " +",PTBRBRDN
.                   
                    WRITE     HTMLFILE;"&nbsp;&nbsp;<img src='../images/PatientLink4.gif' class=ListIcon":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');";
.
                    REP       "+ ",URNUMBER
                    REP       "+ ",ADMISSNO
                    REP       "+ ",PTBRBRDN
.
                    REP       "'` +",PTBRSNAM
                    REP       "'` +",PTBRGNAM
                    REP       " +",PTBRGEND
                    REP       " +",DISPBBDT
                    REP       " +",PSAGEDIM
                    REP       "'` +",PTBRADR1
                    REP       "'` +",PTBRADR2
                    REP       "'` +",PTBRADR3
                    REP       "'` +",PTBRADR4
                    REP       " +",PTBRPOST
                    REP       " +",PTBRHPHN
                    REP       " +",PTBRWPHN
                    REP       " +",PTBRMPHN
                    REP       " +",PTBREMAL
                    REP       " +",DISPBSDT
                    REP       " +",PTBRSTIM
.
                    WRITE     HTMLFILE;" onmouseover=showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
.
                    REP       "`'+ ",PTBRSNAM
                    REP       "`'+ ",PTBRGNAM
                    REP       "+ ",PTBRGEND
                    REP       "+ ",DISPBBDT
                    REP       "+ ",PSAGEDIM
                    REP       "`'+ ",PTBRADR1
                    REP       "`'+ ",PTBRADR2
                    REP       "`'+ ",PTBRADR3
                    REP       "`'+ ",PTBRADR4
                    REP       "+ ",PTBRPOST
                    REP       "+ ",PTBRHPHN
                    REP       "+ ",PTBRWPHN
                    REP       "+ ",PTBRMPHN
                    REP       "+ ",PTBREMAL
                    REP       "+ ",DISPBSDT
                    REP       "+ ",PTBRSTIM
.
                  ENDIF
.
        REP       " +",PTBRLURN
        REP       " +",PTBRTITL
        REP       " +",PTITL   
        REP       " +",PSNAME  
        REP       " +",PGNAME  
.
        WRITE     HTMLFILE;",'",PTBRLURN,"'";
.
        WRITE     HTMLFILE;",'",PTBRTITL,"'":
                           ",'",PTITL,"'":
                           ",'",PSNAME,"'":
                           ",'",PGNAME,"'":
                           ");";
.
        REP       "+ ",PTBRLURN
        REP       "+ ",PTBRTITL
        REP       "+ ",PTITL
        REP       "+ ",PSNAME
        REP       "+ ",PGNAME
.
        WRITE     HTMLFILE;" onmouseout=hideit();>";
                ELSE
                  MATCH     SP70,PTBRADR1
                  IF        @EQUAL | @EOS
                    MATCH     SP70,PTBRADR2
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRADR3
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRADR4
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRPOST
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRHPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRWPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRMPHN
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBREMAL
                    IF        !@EQUAL & !@EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    MATCH     SP70,PTBRLURN
                    IF        @EQUAL | @EOS
                      GOTO      CBEDI149
                    ENDIF
.
                    PACK      KEY8,PTBRLURN,SP70
                    CALL      RDMAST1
                    IF        OVRCD
                      PACK      KEY8,URNUMBER,SP70
                      CALL      RDMAST1
.
                      GOTO      CBEDI149
                    ENDIF
.
                    CALL      RDPMPX21
.
                    REP       " +",URNUMBER
                    REP       " +",ADMISSNO
                    REP       " +",PTBRBRDN
.
                  WRITE     HTMLFILE;"&nbsp;&nbsp;<img src='../images/PatientLink1.gif' class=ListIcon":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');";
.
                    REP       "+ ",URNUMBER
                    REP       "+ ",ADMISSNO
                    REP       "+ ",PTBRBRDN
.
                    REP       "'` +",PTBRSNAM
                    REP       "'` +",PTBRGNAM
                    REP       " +",PTBRGEND
                    REP       " +",DISPBBDT
                    REP       " +",PSAGEDIM
                    REP       "'` +",PADD1
                    REP       "'` +",PADD2
                    REP       "'` +",PSUBRB
                    REP       "'` +",PADD4
                    REP       " +",PPOST
                    REP       " +",PTELEP
                    REP       " +",PTELEB
                    REP       " +",PTMXCELL
                    REP       " +",PMPXPEML
                    REP       " +",DISPBSDT
                    REP       " +",PTBRSTIM
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                    WRITE     HTMLFILE;" onmouseover=showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PADD1,"'":
                                                  ",'",PADD2,"'":
                                                  ",'",PSUBRB,"'":
                                                  ",'",PADD4,"'":
                                                  ",'",PPOST,"'":
                                                  ",'",PTELEP,"'":
                                                  ",'",PTELEB,"'":
                                                  ",'",PTMXCELL,"'":
                                                  ",'",PMPXPEML,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
.
                    REP       "`'+ ",PTBRSNAM
                    REP       "`'+ ",PTBRGNAM
                    REP       "+ ",PTBRGEND
                    REP       "+ ",DISPBBDT
                    REP       "+ ",PSAGEDIM
                    REP       "`'+ ",PADD1
                    REP       "`'+ ",PADD2
                    REP       "`'+ ",PSUBRB
                    REP       "`'+ ",PADD4
                    REP       "+ ",PPOST
                    REP       "+ ",PTELEP
                    REP       "+ ",PTELEB
                    REP       "+ ",PTMXCELL
                    REP       "+ ",PMPXPEML
                    REP       "+ ",DISPBSDT
                    REP       "+ ",PTBRSTIM
                    REP       "'`",PTELEP
                    REP       "'`",PTELEB
.
                    PACK      KEY8,URNUMBER,SP70
                    CALL      RDMAST1
                    CALL      RDPMPX21
.
                  ELSE
.
CBEDI149        REP       " +",URNUMBER
                REP       " +",ADMISSNO 
                REP       " +",PTBRBRDN
.
                WRITE     HTMLFILE;"&nbsp;&nbsp;<img src='../images/PatientLink1.gif' class=ListIcon":
                           " onclick=gotoBoarder('",URNUMBER,"','",ADMISSNO:
                           "','",PTBRBRDN,"');";
.
                REP       "+ ",URNUMBER
                REP       "+ ",ADMISSNO
                REP       "+ ",PTBRBRDN
.
                REP       "'` +",PTBRSNAM
                REP       "'` +",PTBRGNAM
                REP       " +",PTBRGEND
                REP       " +",DISPBBDT
                REP       " +",PSAGEDIM
                REP       "'` +",PTBRADR1
                REP       "'` +",PTBRADR2
                REP       "'` +",PTBRADR3
                REP       "'` +",PTBRADR4
                REP       " +",PTBRPOST
                REP       " +",PTBRHPHN
                REP       " +",PTBRWPHN
                REP       " +",PTBRMPHN
                REP       " +",PTBREMAL
                REP       " +",DISPBSDT
                REP       " +",PTBRSTIM

.
                WRITE     HTMLFILE;" onmouseover=showit('",PTBRSNAM,"'":
                                                  ",'",PTBRGNAM,"'":
                                                  ",'",PTBRGEND,"'":
                                                  ",'",DISPBBDT,"'":
                                                  ",'",PSAGEDIM,"'":
                                                  ",'",PTBRADR1,"'":
                                                  ",'",PTBRADR2,"'":
                                                  ",'",PTBRADR3,"'":
                                                  ",'",PTBRADR4,"'":
                                                  ",'",PTBRPOST,"'":
                                                  ",'",PTBRHPHN,"'":
                                                  ",'",PTBRWPHN,"'":
                                                  ",'",PTBRMPHN,"'":
                                                  ",'",PTBREMAL,"'":
                                                  ",'",DISPBSDT,"'":
                                                  ",'",PTBRSTIM,"'";
.
                REP       "`'+ ",PTBRSNAM
                REP       "`'+ ",PTBRGNAM
                REP       "+ ",PTBRGEND
                REP       "+ ",DISPBBDT
                REP       "+ ",PSAGEDIM
                REP       "`'+ ",PTBRADR1
                REP       "`'+ ",PTBRADR2
                REP       "`'+ ",PTBRADR3
                REP       "`'+ ",PTBRADR4
                REP       "+ ",PTBRPOST
                REP       "+ ",PTBRHPHN
                REP       "+ ",PTBRWPHN
                REP       "+ ",PTBRMPHN
                REP       "+ ",PTBREMAL
                REP       "+ ",DISPBSDT
                REP       "+ ",PTBRSTIM
.
                  ENDIF
.
        REP       " +",PTBRLURN
        REP       " +",PTBRTITL
        REP       " +",PTITL
        REP       " +",PSNAME
        REP       " +",PGNAME
.
        WRITE     HTMLFILE;",'",PTBRLURN,"'";
.
        WRITE     HTMLFILE;",'",PTBRTITL,"'":
                           ",'",PTITL,"'":
                           ",'",PSNAME,"'":
                           ",'",PGNAME,"'":
                           ");":
                           " onmouseout=hideit();>";
.
        REP       "+ ",PTBRLURN
        REP       "+ ",PTBRTITL
        REP       "+ ",PTITL
        REP       "+ ",PSNAME
        REP       "+ ",PGNAME
.
                ENDIF
            ENDIF
          ENDIF
          REP       " +",ADMISSNO
          REP       " +",URNUMBER
.
          WRITE     HTMLFILE;"#",";
.
.------------------------------------------------------------------------------
.
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
.
          WRITE     HTMLFILE;"#"";
.
          REP       " +",TDESC
          WRITE     HTMLFILE;"<input type=hidden name='",TDESC,"'>";
          REP       "+ ",TDESC
.
          REP       " +",URNUMBER
          REP       " +",ADMISSNO
.                                          * I CAR 48029
          IF        PTCNHDPS = ONE
            WRITE     HTMLFILE;"<img src=../images/DietIcon.gif ":
                               " class=ListIcon onclick=UpdateDiet('":
                               URNUMBER,"','",ADMISSNO,"')>";
. 
            MATCH     "1",SKIPDIET
            IF        !@EQUAL
              WRITE     HTMLFILE;TDESC,"<br> ",PMVXUDF4;
            ENDIF
.
          ELSE
            WRITE     HTMLFILE;"<img src=../images/DietIcon.gif ":
                               " class=ListIcon onclick=UpdateDiet('":
                               URNUMBER,"','",ADMISSNO,"')>";

            MATCH     "1",SKIPDIET
            IF        !@EQUAL
              WRITE     HTMLFILE;TDESC;
            ENDIF
          ENDIF
.
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
          WRITE     HTMLFILE;"#",";
.
.------------------------------------------------------------------------------
.
          WRITE     HTMLFILE;"#"";
          WRITE     HTMLFILE;DTFASTNG;
          WRITE     HTMLFILE;"#",";
.          
.------------------------------------------------------------------------------
.
CBEDI150  MOVE      SP70,TDESC
          REP       "+ ",ADMISSNO
          PACK      KEY30,ADMISSNO,Z70
          CALL      RDSTRAN2
          CALL      RDPTRAN2
          IF        OVRCD = 0
            MATCH     ADMISSNO,DTADMN
            IF        @EQUAL
              MOVE      "AC",CATEGORY
              MOVE      TDEPT,CODE
              CALL      GETCOD00
             ENDIF
          ENDIF
          REP       " +",ADMISSNO
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
.-------------------------------------------------------------------------------
.
CBEDI155  WRITE     HTMLFILE;"#"";
.
          REP       " +",DOCTCODE
.
          WRITE     HTMLFILE;TDESC;
          WRITE     HTMLFILE;"#",";
.
.------------------------------------------------------------------------------
.
          WRITE     HTMLFILE;"#"";
          WRITE     HTMLFILE;" <a href=":
                             "javascript:funcDoctorViewFrame('",DOCTCODE,"')>":
                              SDOCFNAM,"</a>";
.
          REP       "+ ",DOCTCODE
.
          MATCH     SP70,PMVXEDC1
          GOTO      CBEDI158 IF EQUAL
.
          REP       " +",PMVXEDC1
.
          WRITE     HTMLFILE;SP1,SLASH,SP1,"<a href=":
                             "javascript:funcDoctorViewFrame('",PMVXEDC1,"')>":
                              SECDOCDE,"</a>";
.
          REP       "+ ",PMVXEDC1
.
CBEDI158  MATCH     "1",ANAESTFL                                      *I-174468
          IF        @EQUAL
            MATCH     SP6,ANATNAME
            IF        @EQUAL
              WRITE     HTMLFILE;"&nbsp;";
            ELSE
.
              REP       " +",ANATCODE
.
              WRITE     HTMLFILE;"<a href=":
                              "javascript:funcDoctorViewFrame('",ANATCODE,"')>":
                                ANATNAME,"</a>";
.
              REP       "+ ",ANATCODE
.
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",";
.
.
.-------------------------------------------------------------------------------
.
CBEDI160  WRITE     HTMLFILE;"#"":
                             ADATE,ATIME:
                             "#",";
.
.-------------------------------------------------------------------------------
.         
          MOVE      SP70,DIM8
          MOVE      SP70,DIM8A
          UNPACK    EXPCTDSC,CDAY,KEY1,MTHNAM3,KEY1,CCENT,CYEAR,KEY1,DIM8A
          CALL      SETMTH00
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DIM8
.
          WRITE     HTMLFILE;"#"":
                             DIM8,DIM8A:
                             "#",";
.
.-------------------------------------------------------------------------------
.
          WRITE     HTMLFILE;"#"";
.
          REP       " +",OERDATE
          WRITE     HTMLFILE;"&nbsp;<input type=hidden name='",OERDATE,"'>";
          REP       "+ ",OERDATE
.
          CALL      CHKMUL000
          IF        EXIT=0
            WRITE     HTMLFILE;"Current IP - ",MULTHOSP,"<br>";
          ENDIF
.
          IF        FILETYPE=3
            WRITE     HTMLFILE;EXPLRETN;
          ENDIF
.
          WRITE     HTMLFILE;"#",";
.
.-------------------------------------------------------------------------------
.
CBEDI900  WRITE     HTMLFILE;"#"",COLRFLAG,"#");"
          REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
CBEDI999  RETURN
+
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
CROWI000  MATCH     ZEROVISN,WADMNO
          GOTO      CROWI800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (IGNORE),2 = Empty
.
          BRANCH    WBEDTYPE,CROWI100,CROWI999
.
CROWI100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG
          CALL      CBEDI000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      CROWI999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      CBEDI000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      CROWI999
.
CROWI800  MATCH     "1",PTWDBDST     * Is this bed closed?
          IF        @EQUAL
            MOVE      TWO,BEDMSGID   * Yes, bed is closed
            GOTO      CROWI850
          ELSE
            MOVE      ONE,BEDMSGID   * Assume Empty Bed
          ENDIF
.
          PACK      KEY14,WWARD,WBED,SP70
          CALL      RDSONLV1
CROWI810  CALL      RDKONLV1         * Try to find correct Ward/Bed
          BRANCH    OVRCD,CROWI850
          MATCH     OWARD,WWARD
          GOTO      CROWI850 IF NOT EQUAL
          MATCH     OBED,WBED
          GOTO      CROWI850 IF NOT EQUAL
          MOVE      ZERO,BEDMSGID     * Bed has patient on leave
.
CROWI850  CALL      CBDMSI00
.
CROWI999  RETURN
+
.------------------------------------------------------------
. Current Admissions Bed Row message.
.------------------------------------------------------------
CBDMSI00  BRANCH    BEDMSGID,CBDMSI01,CBDMSI02
.
          MOVE      "LeaveCell",BDMSGCLS
          MOVE      "*** On Leave ***",BDMSGTXT
          GOTO      CBDMSI10
.
CBDMSI01  MOVE      "AvailableCell",BDMSGCLS
          MOVE      "*** Empty ***",BDMSGTXT
          GOTO      CBDMSI10
.
CBDMSI02  BRANCH    WBEDTYPE,CBDMSI99
          MOVE      "ClosedCell bgcolor=gray",BDMSGCLS
          MOVE      "*** Closed ***",BDMSGTXT
.
CBDMSI10  MATCH     SP70,PTWDCOMM
          IF        @EQUAL
            CLEAR     PTWDCOMM
            APPEND    "Bed ",PTWDCOMM
            APPEND    WBED,PTWDCOMM
            RESET     PTWDCOMM
          ENDIF
.
.         WRITE     HTMLFILE;"<tr height=35 align=top>":
.                            "<td align=center class=",BDMSGCLS,"":
.                            " title=#"",PTWDCOMM,"#">";
.
          ADD       ONE,CRSRTCNT
          MOVE      SP70,DIM3
          MOVE      CRSRTCNT,DIM3
          REP       " +",DIM3
.
          MATCH     "1",DEBDINDC
          GOTO      CBDMSI99 IF NOT EQUAL
.
          WRITE     HTMLFILE;"t.addRow(#"",BDMSGCLS:
                             "#",#"";
.
          WRITE     HTMLFILE;"<input type=hidden name='",DIM3,"'> ";
.
CBDMSI25  CALL      FBED0000
          WRITE     HTMLFILE;BEDTEXT;
          WRITE     HTMLFILE;"#",";                    
.
          WRITE     HTMLFILE;"#"": 
                             BDMSGTXT:
                             "#",";
.
CBDMSI20  WRITE     HTMLFILE;"#"#",":
                             "#"#",":
                             "#"#",": 
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",":
                             "#"#",";
.
          WRITE     HTMLFILE;"#"","","#");"
.
CBDMSI99  RETURN
+
.------------------------------------------------------------
. Displays Current Patient ward/bed details for Map View
.------------------------------------------------------------
CMAPH000  MOVE      ZERO,NUMOFPAT                * Number of patients in ward
          CALL      IBACLOCK                     * Calc expected discharge date
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          MOVE      WCLASS,SAVCLASS
.
          MOVE      WINPUT,NOBEDWRD              * Save Ward Hdr WO/BO status
.
. No Bed 
.
          MOVE      ZERO,CLOSEFLG
          PACK      KEY13,WARDCODE,SP20
          MOVE      "1",FILETYPE
          CALL      RDSNOBE1
CMAPH100  CALL      RDKNOBE1                * read next record
          BRANCH    OVRCD,CMAPH190
          MATCH     WARDCODE,NBWARD         * same ward?
          GOTO      CMAPH190 IF NOT EQUAL
          PACK      ADMISSNO,NBADMNO
          MOVE      NBROOM,WBED
          MOVE      ZERO,STBYFLAG
.
          CALL      MBEDH000         * Output Row Details
          GOTO      CMAPH100
.
. Ward/Bed Details
.
CMAPH190  PACK      KEY16,WARDCODE,SP70
          MOVE      "2",FILETYPE
          CALL      RDSWARD8
CMAPH200  CALL      RDKWARD8
          BRANCH    OVRCD,CMAPH290
.
          MATCH     WARDCODE,WWARD
          GOTO      CMAPH290 IF NOT EQUAL
.
          MATCH     SP70,WBED
          GOTO      CMAPH200 IF EQUAL
.
          IF        WBEDTYPE=3
            MATCH     ZEROVISN,WADMNO
            GOTO      CMAPH220 IF NOT EQUAL
            PACK      KEY14,WWARD,WBED,SP70
            CALL      RDSONLV1
            CALL      RDKONLV1
            BRANCH    OVRCD,CMAPH200
            MATCH     OWARD,WWARD
            GOTO      CMAPH200 IF NOT EQUAL
            MATCH     OBED,WBED
            GOTO      CMAPH200 IF NOT EQUAL
          ENDIF
CMAPH220  BRANCH    WACTIVE,CMAPH200       * Do not display Inactive Beds
          CALL      MROWH000
          GOTO      CMAPH200
.
. On Leave Patients
.------------------
CMAPH290  BRANCH    WBEDTYPE,CMAPH300,CMAPH999
. 
CMAPH300  MOVE      "3",FILETYPE
          PACK      KEY14,WARDCODE,SP70
          CALL      RDSONLV1
CMAPH800  CALL      RDKONLV1
          BRANCH    OVRCD,CMAPH999
          MATCH     OWARD,WARDCODE
          GOTO      CMAPH999 IF NOT EQUAL
          MATCH     ZEROVISN,OADMNO
          GOTO      CMAPH800 IF EQUAL
          PACK      ADMISSNO,OADMNO
          MOVE      OBED,WBED
          MOVE      ZERO,STBYFLAG
.
          MOVE      ZERO,CLOSEFLG                * Reset 'Closed Bed' flag
          PACK      KEY6,WARDCODE,WBED,SP70      * Read Ward/Bed file
          CALL      RDWARD1
          BRANCH    OVRCD,CMAPH850
          MOVE      PTWDBDST,CLOSEFLG            * Set 'Closed Bed' flag
.
CMAPH850  CALL      MBEDH000         * Output Row Details
          GOTO      CMAPH800
.
CMAPH999  RETURN
.------------------------------------------------------------
. Output Ward/Bed Row
.------------------------------------------------------------
MROWH000  MATCH     ZEROVISN,WADMNO
          GOTO      MROWH800 IF EQUAL
.
. WBEDTYPE 0= All,1 = OPEN (IGNORE),2 = Empty 
.
          BRANCH    WBEDTYPE,MROWH100,MROWH999
.
MROWH100  PACK      ADMISSNO,WADMNO
          MOVE      ZERO,STBYFLAG
          MOVE      PTWDBDST,CLOSEFLG
          CALL      MBEDH000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          MATCH     ZEROVISN,WSTBY
          GOTO      MROWH999 IF EQUAL
.
          PACK      ADMISSNO,WSTBY
          MOVE      ONE,STBYFLAG
          CALL      MBEDH000         * Output Row Details
          ADD       ONE,NUMOFPAT     * count number of patients in ward
.
          GOTO      MROWH999
.
MROWH800  
MROWH999  RETURN
.
.------------------------------------------------------------
. Get Boarder Count
.------------------------------------------------------------
GETBRD00  MOVE      ZERO,BOARDERS
          PACK      KEY26,ADMISSNO,SP70
          CALL      RSPTBRD3
GETBRD10  CALL      RKPTBRD3
          BRANCH    OVRCD,GETBRD99
          MATCH     ADMISSNO,PTBRVISN
          GOTO      GETBRD99 IF NOT EQUAL
          ADD       ONE,BOARDERS
          GOTO      GETBRD10 
GETBRD99  RETURN
+
.------------------------------------------------------------
. Current Admissions Patient Details
.------------------------------------------------------------
MBEDH000  PACK      SECDOCDE,SP70
          MOVE      SP70,PATLINK
          CALL      GETPAT00
          CALL      PATLN000
          CALL      PATFLD00           * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF      * and store suffix
          CALL      GETSP000           * Get Speciality
          MOVE      ADOCTA,DOCTCODE
          CALL      GETDS000           * Get Doctor Short Name
          CALL      GTDIET00
          CALL      GETVX000
          CALL      GETAN000           * get Anaesthetist
          CALL      GETANN00           * get Anaesthetist Name
          CALL      XRET0000           * Exp return from leave date/time
          CALL      GETOBS00           * Get Last Basic Observation Set
          CALL      GETCFL00           * Get Condition and Diet Flags
          CALL      GETUDC00           * Get Condition User Defined
          CALL      GETBRD00           * Get Boarder Flag
          CALL      CHKD0000           * Get surname conflict/duplicate flag
          CALL      CHKLST00
.
          REP       "\|'`",ANATDES1
          WRITE     HTMLFILE;"anatdes1='",ANATDES1,"';"
          WRITE     HTMLFILE;"anatdes1=anatdes1.replace(/\|/g,'\\');"
.
          REP       "\|'`",ANATDES2
          WRITE     HTMLFILE;"anatdes2='",ANATDES2,"';"
          WRITE     HTMLFILE;"anatdes2=anatdes2.replace(/\|/g,'\\');"
.
          REP       "\|'`",ANATDES3
          WRITE     HTMLFILE;"anatdes3='",ANATDES3,"';"
          WRITE     HTMLFILE;"anatdes3=anatdes3.replace(/\|/g,'\\');"
.
          WRITE     HTMLFILE;*+,"t.addRow(#"",WWARD,"#",":
                             "#"",WBED,"#",":
                             "#"",PURNO,"#",":
                             "#"",ADMISSNO,"#",":
                             "#"",PATFNAME,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
          STRIP     PMWOWDI1
          STRIP     PMWOWDI2
          STRIP     PMWOWDI3
          STRIP     DESTDESC
          STRIP     CONDESC
          STRIP     DIETDESC
          STRIP     SPECDESC
          STRIP     PSNAME
          STRIP     PGNAME
          STRIP     PTITL
.
MBEDH100  MOVE      SP70,KEY1
          PACK      KEY5,PTMXSIN1,PMPXSIN7,PMPXSIN8,PMPXSIN9,PMPXSN11,SP70
          MATCH     SP70,KEY5
          IF        !@EQUAL
            MOVE      "1",KEY1              * Display alert on Ward Whiteboard
          ENDIF
          WRITE     HTMLFILE;*+,"#",":
                             "#"",ADIAG1,ADIAG2,"#",":
                             "#"",SDOCFNAM,"#",":
                             "#"",ADATE,"#",":
                             "#"",DDATE,"#",":                             * 10
                             "#"",DESTDESC,"#",":
                             "#"",ADIET,"#",":
                             "#"",DIETDESC,"#",":
                             "#"",PATLINK,"#",":
                             "#"",PMWOEDAT,PMWOEDTM,"#",":
                             "#"",CONLINK,"#",":
                             "#"",CONDESC,"#",":
                             "#"",CONDINDC,"#",":
                             "#"",LPCDATE,LPCTIME,"#",":
                             "#"",LPCONDD,"#",":                           * 20
                             "#"",VISPHONE,"#",":
                             "#"",FOLDERSF,"#",":
                             "#"",COLRFLAG,"#",":
                             "#"",CLOSEFLG,"#",":
                             "#"",STBYFLAG,"#",":
                             "#"",PTWDCOMM,"#",":
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                             PTMXSIN5,KEY1,"#",":
                             "#"",DOCTCODE,"#",":
                             "#"",PMVXEDC1,"#",":
                             "#"",SECDOCDE,"#",":                          * 30
                             "#"",EXPLRETN,"#",":
                             "#"",SPECDESC,"#",":
                             "#"",FILETYPE,"#",":
                             "#"",PMWOWDI1,"#",":
                             "#"",PMWOWDI2,"#",":
                             "#"",PMWOWDI3,"#",":
                             "#"",OBDEDATE,OBDETIME,"#",":
                             "#"",OBDEPULS,"#",":
                             "#"",OBDETEMP,"#",":
                             "#"",OBDERESP,"#",":                          * 40
                             "#"",OBDEBPSY,"#",":
                             "#"",OBDEBPDI,"#",":
                             "#"",OBDEPOX,"#",":
                             "#"",OBDECOM1,"#",":
                             "#"",ANATDATE,ANATEXPS,"#",":
                             "#"",ANATEXPD,"#",":
                             "#"",ANATCODE,"#",":
                             "#"",ANATNAME,"#",":
                             "#"",ANATTHET,"#",":
                             "#"",ANATANAE,"#",":                          * 50
                             "#"",ANATTYPE,"#",":
                             "#"",ANATTRAN,"#",":
                             "anatdes1,":
                             "anatdes2,":
                             "anatdes3,":
                             "#"",BKRXPOWD,"#",":
                             "#"",BKRXPOBD,"#",":
                             "#"",CURSTATS,"#",":
                             "#"",NAMECTVA,"#",":
                             "#"",NAMECTVB,"#",":                          * 60
                             "#"",NAMECTVC,"#",":
                             "#"",NAMECTVD,"#",":
                             "#"",NAMECTVE,"#",":
                             "#"",NAMECTVF,"#",":
                             "#"",NAMECTVG,"#",":
                             "#"",NAMECTVH,"#",":
                             "#"",USERDF01,"#",":
                             "#"",USERDF02,"#",":
                             "#"",USERDF03,"#",":
                             "#"",USERDF04,"#",":                          * 70
                             "#"",USERDF05,"#",":
                             "#"",USERDF06,"#",":
                             "#"",USERDF07,"#",":
                             "#"",USERDF08,"#",":
                             "#"",USERDF09,"#",":
                             "#"",USERDF10,"#",":
                             "#"",PTITL,"#",":
                             "#"",PGNAME,"#",":
                             "#"",PSNAME,"#",":
                             "#"",BOARDERS,"#",":                          * 80
                             "#"",PMNUFAST,"#",":
                             "#"",DUPNMFLG,"#",":
                             "#"",ASTAY,"#",":
                             "#"",ACLAIM,"#",":
                             "#"",AFUNDH,"#",":                            * 85
                             "#"",CURSTATS,CURSTATB,"#",":    
                             "#"",WEXTN,"#",":    
                             "#"",DESCDPST,"#","; 

.
          CALL      THET0000                          * Check Theatre Today
.
          UNPACK    SAVKEY27,PTVEVISN,PTVEVTYP,PTVESDAT,PTVESTIM
          WRITE     HTMLFILE;"#"",THETODAY,"#",":
                             "#"",MVFLAG,"#",":                            * 90
                             "#"",PTVEVTYP,"#",":
                             "#"",PTVESDAT,"#",":
                             "#"",PTVESTIM,"#",";              
.
          CALL      OVFDS000                           * Get OVFLDESC *C-0837181
          WRITE     HTMLFILE;"#"",OVFLDESC,"#",":                   
                             "#"",LSFLAG,"#",":        * Legal status flag
                             "#"",PMPXPFGN,"#",":      * Preferred F Name 
                             "#"",PMPXPFSN,"#",";      * Preferred L Name 
          MOVE      "Gi",CATEGORY
          MOVE      PMPXUCC4,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"#"",TDESC,"#",";         * ID Gender 
          MOVE      "Gp",CATEGORY
          MOVE      PMPXUCC5,CODE
          CALL      GETCOD00
          WRITE     HTMLFILE;"#"",TDESC,"#",":      * ID Pronoun
                             "#"",PBDATE,"#",";     * Patient BDate    * 100 
          MATCH     SP70,PMPXABRG
          IF        @EQUAL
            WRITE     HTMLFILE;"#"",SP1,"#","     * Aboriginality (Cat VA) FLAG
          ELSE
            PACK      KEY5,ANSV,ANSA,PMPXABRG,SP70
            CALL      RDCODE1
            IF        OVRCD = 1
              WRITE     HTMLFILE;"#"",SP1,"#","
            ELSE
              WRITE     HTMLFILE;"#"",TCINDC3,"#","
            ENDIF
          ENDIF
.
          MATCH     "1",PTCNDAUR                    * use Alternate ID
          IF        @EQUAL
            PACK      KEY20,SP70
            PROC      GETALIDS                      * get Alternate ID
            WRITE     HTMLFILE;"#"",KEY20,"#");"    * Alternate ID
          ELSE
            PACK      KEY20,SP70
            WRITE     HTMLFILE;"#"",KEY20,"#");"    * Alternate ID
          ENDIF
.        
.
MBEDH999  RETURN
+
.------------------------------------------------------------
. Check if patient has any theatre bookings for today
. with a status of booked
.------------------------------------------------------------
THET0000  MOVE      ZERO,THETODAY
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY31,ADMISSNO,TWO,CURRDATE,SP70
          CALL      RSOPDEA2
          CALL      RKOPDEA2
          BRANCH    OVRCD,THET9999
.
          MATCH     ADMISSNO,OPDAADMN
          GOTO      THET9999 IF NOT EQUAL
.
          COMPARE   TWO,OPDASTAT
          GOTO      THET9999 IF NOT EQUAL
.
          MATCH     CURRDATE,OPDADATE
          GOTO      THET9999 IF NOT EQUAL
.
          MOVE      ONE,THETODAY
.
THET9999  RETURN
.------------------------------------------------------------
. Get Condition User Defined
.------------------------------------------------------------
GETUDC00  MOVE      ZERO,F1
GETUDC10  ADD       ONE,F1
          STORE     SP70,F1,NAMECTVA,NAMECTVB,NAMECTVC,NAMECTVD,NAMECTVE,NAMECTVF,NAMECTVG,NAMECTVH
          LOAD      KEY2,F1,CATVA,CATVB,CATVC,CATVD,CATVE,CATVF,CATVG,CATVH
          LOAD      KEY3,F1,PMWOUDF1,PMWOUDF2,PMWOUDF3,PMWOUDF4,PMWOUDF5,PMWOUDF6,PMWOUDF7,PMWOUDF8
          MATCH     SP70,KEY3
          GOTO      GETUDC19 IF EQUAL
.
          PACK      KEY5,KEY2,KEY3
          CALL      RDCODE1
          IF        OVRCD=0
            STORE     TDESC,F1,NAMECTVA,NAMECTVB,NAMECTVC,NAMECTVD,NAMECTVE,NAMECTVF,NAMECTVG,NAMECTVH
          ENDIF
GETUDC19  IF        F1<8
            GOTO      GETUDC10
          ENDIF
          STRIP     NAMECTVA
          STRIP     NAMECTVB
          STRIP     NAMECTVC
          STRIP     NAMECTVD
          STRIP     NAMECTVE
          STRIP     NAMECTVF
          STRIP     NAMECTVG
          STRIP     NAMECTVH
.
          PACK      USERDF01,SP70,SP70
          PACK      USERDF02,SP70,SP70
          PACK      USERDF03,SP70,SP70
          PACK      USERDF04,SP70,SP70
          PACK      USERDF05,SP70,SP70
          PACK      USERDF06,SP70,SP70
          PACK      USERDF07,SP70,SP70
          PACK      USERDF08,SP70,SP70
          PACK      USERDF09,SP70,SP70
          PACK      USERDF10,SP70,SP70
          MOVE      "018",VSCTTYPE
          PACK      KEY14,ADMISSNO,VSCTTYPE,SP70
          CALL      RSVSCMT1
GETUDC40  CALL      RKVSCMT1
          BRANCH    OVRCD,GETUDC49
          MATCH     ADMISSNO,VSCTVIST
          GOTO      GETUDC49 IF NOT EQUAL
          MATCH     "018",VSCTTYPE
          GOTO      GETUDC49 IF NOT EQUAL
          MOVE      VSCTLINE,F3
          STORE     VSCTDATA,F3,USERDF01,USERDF02,USERDF03,USERDF04,USERDF05:
                                USERDF06,USERDF07,USERDF08,USERDF09,USERDF10
          GOTO      GETUDC40
GETUDC49  STRIP     USERDF01
          STRIP     USERDF02
          STRIP     USERDF03
          STRIP     USERDF04
          STRIP     USERDF05
          STRIP     USERDF06
          STRIP     USERDF07
          STRIP     USERDF08
          STRIP     USERDF09
          STRIP     USERDF10
GETUDC99  RETURN
.
GETDS000  PACK      KEY6,DOCTCODE
          CALL      RDDOCT1
          IF        OVRCD=0
            CALL      SDOCNM00
            CLEAR     SDOCFNAM
            SQUEEZE   DTITL
            SQUEEZE   DSNAME
            MOVE      DGNAME,DIM1
            APPEND    DTITL,SDOCFNAM
            APPEND    SP1,SDOCFNAM
            APPEND    DIM1,SDOCFNAM
            APPEND    DOT,SDOCFNAM
            APPEND    SP1,SDOCFNAM
            APPEND    DSNAME,SDOCFNAM
            RESET     SDOCFNAM
            STRIP     SDOCFNAM
          ENDIF
          RETURN
.
GETVX000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,GETVX999
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GETVX999
.
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
.
          CLEAR     SECDOCDE
          APPEND    PMHCTITL,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    DIM1,SECDOCDE
          APPEND    DOT,SECDOCDE
          APPEND    SP1,SECDOCDE
          APPEND    PMHCSNAM,SECDOCDE
          RESET     SECDOCDE
.
GETVX999  RETURN
.
GETANN00  COMPARE   ONE,ANATFLAG
          IF        @EQUAL
            CALL      PATSTS00
            CLEAR     ANATNAME
            SQUEEZE   DTITL
            SQUEEZE   DSNAME
            MOVE      DGNAME,DIM1
            APPEND    DTITL,ANATNAME
            APPEND    SP1,ANATNAME
            APPEND    DIM1,ANATNAME
            APPEND    DOT,ANATNAME
            APPEND    SP1,ANATNAME
            APPEND    DSNAME,ANATNAME
            RESET     ANATNAME
            STRIP     ANATNAME

            MOVE      OPDADATE,ANATDATE
            MOVE      OPDATIME,ANATTIME
            MOVE      OPDAEXPS,ANATEXPS
            MOVE      OPDAEXPD,ANATEXPD
            MOVE      OPDADES1,ANATDES1
            MOVE      OPDADES2,ANATDES2
            MOVE      OPDADES3,ANATDES3
            MOVE      OPDATHET,ANATTHET
.
            MOVE      "OA",CATEGORY
            MOVE      OPDAANAE,CODE
            CALL      GETCOD00
            MOVE      TDESC,ANATANAE
.
            MOVE      "OY",CATEGORY
            MOVE      OPDATYPE,CODE
            CALL      GETCOD00
            MOVE      TDESC,ANATTYPE
.
            MOVE      "OR",CATEGORY
            MOVE      OPDATRAN,CODE
            CALL      GETCOD00
            MOVE      TDESC,ANATTRAN
            PACK      KEY8,BKREBOOK,SP70
.
            CALL      RDBKRX11
            IF        OVRCD=1
              MOVE      SP70,BKRXPOWD
              MOVE      SP70,BKRXPOBD
            ENDIF
.
          ELSE
            MOVE      SP70,CURSTATS
            MOVE      SP70,CURSTATB
            MOVE      SP70,CURSTATC
            MOVE      SP70,CURSTATT
            MOVE      SP70,ANATDATE
            MOVE      SP70,ANATTIME
            MOVE      SP70,ANATEXPS
            MOVE      SP70,ANATEXPD
            MOVE      SP70,ANATTHET
            MOVE      SP70,ANATTYPE
            MOVE      SP70,ANATANAE
            MOVE      SP70,ANATTRAN
            MOVE      SP70,ANATDES1
            MOVE      SP70,ANATDES2
            MOVE      SP70,ANATDES3
            MOVE      SP70,BKRXPOWD
            MOVE      SP70,BKRXPOBD
          ENDIF
          STRIP    CURSTATS
          STRIP    CURSTATB
          STRIP    CURSTATC
          STRIP    CURSTATT
          STRIP    ANATDATE
          STRIP    ANATTIME
          STRIP    ANATEXPS
          STRIP    ANATEXPD
          STRIP    ANATTHET
          STRIP    ANATTYPE
          STRIP    ANATANAE
          STRIP    ANATTRAN
          STRIP    ANATDES1
          STRIP    ANATDES2
          STRIP    ANATDES3
          STRIP    BKRXPOWD
          STRIP    BKRXPOBD
          RETURN
.--------------------------------------------------
. Get Condition and Diet Flags
.--------------------------------------------------
GETCFL00  MATCH     SP70,ADIET
          IF        @EQUAL
            MOVE      "DC",CATEGORY
            MOVE      PMNUDIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDESC
          ELSE
            MOVE      "DC",CATEGORY
            MOVE      ADIET,CODE
            CALL      GETCOD00
            MOVE      TDESC,DIETDESC
          ENDIF
.
          CALL      GETCON00                * Get Patients Current Condition
          UNPACK    IMGSRC,KEY14,CONDINDC
          MOVE      SP70,VISPHONE
          CLEAR     VISPHONE
.
          MOVE      ANSR,DIM1
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE      ANSV,DIM1
          ENDIF
          APPEND    LBRACKT,VISPHONE
          APPEND    DIM1,VISPHONE
          APPEND    COMMA,VISPHONE
.
          MOVE      ANSN,DIM1
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE ANSP,DIM1
          ENDIF
          APPEND    DIM1,VISPHONE
          APPEND    RBRACKT,VISPHONE
          RESET     VISPHONE
.
          CLEAR     CONLINK                 * Link for Patient Condition
          APPEND    "javascript:UpdateCondition('",CONLINK
          APPEND    URNUMBER,CONLINK
          APPEND    "','",CONLINK
          APPEND    ADMISSNO,CONLINK
          APPEND    "','",CONLINK
          APPEND    "')",CONLINK
          RESET     CONLINK
.
          REP       "#" ",ADIAG1
          REP       "#" ",ADIAG2
.
GETCFL99  RETURN
.--------------------------------------------------
. Get Last Observation
.--------------------------------------------------
GETOBS00  PACK      KEY24,ADMISSNO,Z70
          CALL      RSOBDE1
GETOBS10  CALL      RPOBDE1
          BRANCH    OVRCD,GETOBS90
          MATCH     ADMISSNO,OBDEVIST
          GOTO      GETOBS90 IF NOT EQUAL
          COMPARE   ZERO,OBDEPULS
          GOTO      GETOBS99 IF NOT EQUAL
          COMPARE   ZERO,OBDETEMP
          GOTO      GETOBS99 IF NOT EQUAL
          COMPARE   ZERO,OBDERESP
          GOTO      GETOBS99 IF NOT EQUAL
          GOTO      GETOBS10
GETOBS90  CALL      CLOBSDET
GETOBS99  RETURN
.------------------------------------------------------------
. Clear Basic Observation Details
.------------------------------------------------------------
CLOBSDET  MOVE      SP70,OBDEDATE
          MOVE      SP70,OBDETIME
          MOVE      SP70,OBDEVIST
          MOVE      SP70,OBDETYP
          MOVE      ZERO,OBDEPULS
          MOVE      ZERO,OBDETEMP
          MOVE      ZERO,OBDEBPSY
          MOVE      ZERO,OBDEBPDI
          MOVE      ZERO,OBDERESP
          MOVE      ZERO,OBDEPOX   * Pulse / Oximeter Sa O2
          MOVE      ZERO,OBDEO2F   * Oxygen Flow Litres per Min
          MOVE      ZERO,OBDEPFL   * Peak Flow
          MOVE      SP70,OBDEFOC   * Fluid Output Type (Cat wq)
          MOVE      SP70,OBDEFIC   * Fluid Intake Type (Cat wr)
          MOVE      ZERO,OBDEFOT   * Fluids Output
          MOVE      ZERO,OBDEFIN   * Fluid Intake
          MOVE      SP70,OBDEEYEO  * Eyes Open
          MOVE      SP70,OBDEVERB  * Best Verbal Response
          MOVE      SP70,OBDEMOTO  * Best Motor Response
          MOVE      SP70,OBDEPSL   * Pupil Size Left
          MOVE      SP70,OBDEPSR   * Pupil Size Right
          MOVE      SP70,OBDEPRL   * Pupil Reaction Left
          MOVE      SP70,OBDEPRR   * Pupil Reaction Right
          MOVE      SP70,OBDELMLA  * Limb Movement Left Arm
          MOVE      SP70,OBDELMRM  * Limb Movement Right Arm
          MOVE      SP70,OBDELMLL  * Limb Movement Left Leg
          MOVE      SP70,OBDELMRL  * Limb Movement Right Leg
          MOVE      SP70,OBDEACT   * Action/Comment Code (ws)
          MOVE      SP70,OBDEUY1   * User Def Y/N 1
          MOVE      SP70,OBDEUY2   * User Def Y/N 2
          MOVE      SP70,OBDEUY3   * User Def Y/N 3
          MOVE      SP70,OBDEUY4   * User Def Y/N 4
          MOVE      SP70,OBDEUC1   * User Def Code 1 (wt)
          MOVE      SP70,OBDEUC2   * User Def Code 2 (wu)
          MOVE      ZERO,OBDEUN1   * User Def Num 1
          MOVE      ZERO,OBDEUN2   * User Def Bum 2
          MOVE      ZERO,OBDEUN3   * User Def Num 3
          MOVE      ZERO,OBDEUN4   * User Def Num 4
          MOVE      SP70,OBDEUID   * Web User ID
          MOVE      SP70,OBDEMDAT  * Last Modified Date
          MOVE      SP70,OBDEMTIM  * Last Modified Time
          MOVE      SP70,OBDECOM1  * Comment 1
          MOVE      SP70,OBDECOM2  * Comment 2
          MOVE      SP70,OBDECOM3  * Comment 3
          MOVE      SP70,OBDEPNSC  * Pain Score (0-10)       * I CAR 10484
          MOVE      SP70,OBDECVPS  * CVP (1-8)               * I CAR 10485
          MOVE      SP70,OBDESPA   * Spare
.
          RETURN
.
.------------------------------------------------------------
. Table of Eclipse Claim Enquiries
.------------------------------------------------------------
ECCP0000  MOVE      ZERO,LOOPCNTR
.
          UNPACK    DIM127,D1,LINKPRG,DIM127
          UNPACK    DIM127,D1,LINKREP,DIM127
          UNPACK    DIM127,D1,LINKTEM,DIM127
          MOVE      ZERO,RECCNT
.
          PACK      KEY18,WBSEUID,PRGID,SP70
          CALL      RDWBST1                 * check server security level
          IF        OVRCD=1
            MOVE      ZERO,WBSTLEV
          ENDIF
          IF        WBSTLEV=99
            MOVE      ONE,SUPERECL          * eclipse supervisor = yes
          ELSE
            MOVE      ZERO,SUPERECL         * eclipse supervisor = no
          ENDIF
.
.          IF        EXDTBLNK = 0
.            PACK      KEY16,FRSTDATE,SP70
.          ELSE
.            PACK      KEY16,SP70
.          ENDIF
.
.          CALL      RSPMEBH2
.ECCP0500  CALL      RKPMEBH2
.          BRANCH    OVRCD,ECCP9999
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
.          ADD       ONE,LOOPCNTR
.
.          IF        (LOOPCNTR = 500)
.            WRITE     HTMLFILE;"// ",LOOPCNTR
.            MOVE      ZERO,LOOPCNTR
.          ENDIF
.
. -----------------------------------------------------
.
.         IF        EXDTBLNK = 0
.           MATCH     PMEBDTBC,LASTDATE
.           GOTO      ECCP9999 IF LESS
.         ENDIF
.
          MATCH     SP70,HOSPCODE
          IF        @EQUAL 
            MOVE      WBSEHOSP,HOSPCODE
          ENDIF
.
          PACK      KEY35,HOSPCODE,FILTURNO,SP70
          CALL      RSPMECT5
ECCP1000  CALL      RKPMECT5
          BRANCH    OVRCD,ECCP9999
          MATCH     FILTURNO,PMECURNO
          GOTO      ECCP9999 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
          ADD       ONE,LOOPCNTR
.
          IF        (LOOPCNTR = 500)
            WRITE     HTMLFILE;"// ",LOOPCNTR
            MOVE      ZERO,LOOPCNTR
          ENDIF
.
. -----------------------------------------------------
.
.         MATCH     PMEBBTHN,PMECBATN
.         GOTO      ECCP9999 IF NOT EQUAL
.
          IF        IBCNMHOS=ONE
            MATCH     SP70,HOSPCODE
            IF        !@EQUAL & !@EOS
              MATCH     HOSPCODE,PMECHOSP
              GOTO      ECCP9999 IF NOT EQUAL
            ELSE
              IF        ALLHFLAG<>ONE
                MATCH     WBSEHOSP,PMECHOSP
                GOTO      ECCP9999 IF NOT EQUAL
              ENDIF
            ENDIF
.
            MATCH     SP70,FILTURNO
            IF        !@EQUAL & !@EOS
              MATCH     FILTURNO,PMECURNO
              GOTO      ECCP1000 IF NOT EQUAL
            ENDIF
.
          ELSE
.
            MATCH     SP70,FILTURNO
            IF        !@EQUAL & !@EOS
              MATCH     FILTURNO,PMECURNO
              GOTO      ECCP9999 IF NOT EQUAL
            ENDIF
.
          ENDIF
.
          MATCH     SP70,HLFDCLTY
          IF        !@EQUAL & !@EOS
            MATCH     HLFDCLTY,DPMECEET
            GOTO      ECCP1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,HLTHFUND
          IF        !@EQUAL & !@EOS
            PACK      HLTHFUND,HLTHFUND,SP70
            MATCH     HLTHFUND,PMECHFND
            GOTO      ECCP1000 IF NOT EQUAL
          ENDIF
.
          IF        EXCLWAIT=ONE
            IF        PMECFLAG=ZERO
              GOTO      ECCP1000
            ENDIF
          ENDIF
.
.         MATCH     SP70,FILTURNO
.         IF        !@EQUAL & !@EOS
.           MATCH     FILTURNO,PMECURNO
.           GOTO      ECCP1000 IF NOT EQUAL
.         ENDIF
.
          MATCH     SP70,FILTADMN
          IF        !@EQUAL & !@EOS
            MATCH     FILTADMN,PMECADMN
            GOTO      ECCP1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,BATCHNUM
          IF        !@EQUAL & !@EOS
            MATCH     BATCHNUM,PMECBATN
            GOTO      ECCP1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,CLAIMSTA
          IF        !@EQUAL & !@EOS
            MATCH     CLAIMSTA,DPMECFLG
            GOTO      ECCP1000 IF NOT EQUAL
          ENDIF
.
          MATCH     SP70,INVNUMBR
          IF        !@EQUAL & !@EOS
            MATCH     INVNUMBR,PMECINVN
            GOTO      ECCP1000 IF NOT EQUAL
          ENDIF
.
          IF        EXDTBLNK=0
.
            PACK      KEY8,PMECBATN,SP70
            CALL      RDPMEBH1
            BRANCH    OVRCD,ECCP1000
.
            MATCH     FRSTDATE,PMEBDTBC
            GOTO      ECCP1000 IF LESS
.
            MATCH     PMEBDTBC,LASTDATE
            GOTO      ECCP1000 IF LESS
.
          ENDIF
.
          MOVE      ZERO,VIEWINDI
          PACK      KEY34,PMECINVN,Z70
          CALL      RSPMECA3
          CALL      RPPMECA3
          IF        OVRCD=0
            MATCH     PMECINVN,PMEAINVN
            IF        @EQUAL
              MATCH     " 5",PMEATYPE
              IF        @EQUAL
                MOVE      ONE,VIEWINDI
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      STATUS00,STATDESC
          LOAD      STATDESC,PMECFLAG,STATUS01,STATUS02,STATUS03,STATUS04:
                                      STATUS05,STATUS06,STATUS07,STATUS08:
                                      STATUS09,STATUS10,STATUS11,STATUS12:
                                      STATUS13,STATUS14,STATUS15
.
          CALL      RSBI0000
.
          CALL      GBAL0000
.
          MOVE      PMECURNO,URNUMBER
          MOVE      PMECADMN,ADMISSNO
          CALL      GETPAT00
          CALL      PATLN000
          MOVE      SP70,KEY3
          CALL      PATFLD00
.
          REP       " +",PMECURNO
          REP       " +",PMECADMN
          REP       " +",PMECBATN
          REP       " +",PMECINVN
.
          CLEAR     UPDLINK
          APPEND    "patweb93",UPDLINK
          APPEND    ".pbl?reportno=",UPDLINK
          APPEND    "16",UPDLINK
          APPEND    "&template=",UPDLINK
          APPEND    "001",UPDLINK
          APPEND    "&urnumber=",UPDLINK
          APPEND    PMECURNO,UPDLINK
          APPEND    "&admissno=",UPDLINK
          APPEND    PMECADMN,UPDLINK
          APPEND    "&mavbatch=",UPDLINK
          APPEND    PMECBATN,UPDLINK
          APPEND    "&mavinvce=",UPDLINK
          APPEND    PMECINVN,UPDLINK
          RESET     UPDLINK
.
          CLEAR     PATLINK
          APPEND    LINKPRG,PATLINK
          APPEND    ".pbl?reportno=",PATLINK
          APPEND    LINKREP,PATLINK
          APPEND    "&template=",PATLINK
          APPEND    LINKTEM,PATLINK
          APPEND    "&urnumber=",PATLINK
          APPEND    PMECURNO,PATLINK
          APPEND    "&admissno=",PATLINK
          APPEND    PMECADMN,PATLINK
          RESET     PATLINK
.
          REP       "+ ",PMECURNO
          REP       "+ ",PMECADMN
          REP       "+ ",PMECBATN
          REP       "+ ",PMECINVN
.
          WRITE     HTMLFILE;"t.addRow(#"",PMECBATN,"#",":
                             "#"",PMECADMN,"#",":
                             "#"",PMECINVN,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",PMECHFND,"#",";
.
          IF        PMECFLAG=ZERO
            WRITE     HTMLFILE;"#"<font color=red>",FORM7P2O,"&nbsp;*</font>#",";
          ELSE
            WRITE     HTMLFILE;"#"",PMECAMTC,"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",STATDESC,"#",":
                             "#"",PMECPBAT,"#",":
                             "#"",PMECNBAT,"#",":
                             "#"#",":
                             "#"",UPDLINK,"#",":
                             "#"#",":
                             "#"",PATLINK,"#",";
.
          ADD       ONE,RECCNT
          MOVE      RECCNT,DRECCNT
          REP       " 0",DRECCNT
.
          MATCH     SP70,PMECBATN
          IF        @EQUAL|@EOS
            WRITE     HTMLFILE;"#"#",";
          ELSE
            MATCH     SP70,PMECNBAT
            IF        @EQUAL|@EOS
              IF        VIEWINDI=ONE
                WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                                   " value='",PMECBATN,PMECINVN:
                                   "' onclick=MarkAsViewed(this); checked>":
                                   "#",";
              ELSE
                WRITE     HTMLFILE;"#"<input type=checkbox name=prc",DRECCNT:
                                   " value='",PMECBATN,PMECINVN:
                                   "' onclick=MarkAsViewed(this);>":
                                   "#",";
              ENDIF
            ELSE
              WRITE     HTMLFILE;"#"#",";
            ENDIF
          ENDIF
.
.         IF        RSUBINDI=ZERO
            WRITE     HTMLFILE;"#"<input type=checkbox name=rsb",DRECCNT:
                               " value='",PMECBATN,PMECINVN:
                               "' onclick=reSubmit(this);>":
                               "#",";
.         ELSE
.           WRITE     HTMLFILE;"#"#",";
.         ENDIF
.
          IF        PMECFLAG=ZERO
            WRITE     HTMLFILE;"#"<input type=checkbox name=del",DRECCNT:
                               " value='",PMECBATN,PMECINVN:
                               "' onclick=delWaitn(this);>":
                               "#",";
          ELSE
            WRITE     HTMLFILE;"#"#",";
          ENDIF
.
          WRITE     HTMLFILE;"#"",KEY3,"#",";
.
          MOVE      PMECBATN,DIM8
          REP       " +",PMECURNO
          REP       " +",PMECADMN
          REP       " +",PMECBATN
          REP       " +",PMECINVN
          WRITE     HTMLFILE;"#"","<img src='../images/InvoiceIcon.gif'":
                               " class=ListIcon onclick=displayClaim('":
      PMECBATN,"','",PMECADMN,"','",PMECURNO,"','",PMECINVN,"');> ",DIM8,"#",";
          REP       "+ ",PMECURNO
          REP       "+ ",PMECADMN
          REP       "+ ",PMECBATN
          REP       "+ ",PMECINVN
.
. Allow status reset if applicable security level applies (column 18)
.
          IF        SUPERECL=ONE & (PMECFLAG=5 | PMECFLAG=7 | PMECFLAG=8)
            WRITE     HTMLFILE;"#"<input type=checkbox name=rst",DRECCNT:
                               " value='",PMECBATN,PMECINVN:
                               "' onclick=resetStatus(this);>":
                               "#");"
          ELSE
            WRITE     HTMLFILE;"#"#");"
          ENDIF
.
          MOVE      ZERO,LOOPCNTR
.
          GOTO      ECCP1000
.
ECCP9999  RETURN
.
.------------------------------------------------------------------------------
. Close pmsetraf records
.------------------------------------------------------------------------------
DELETR00  PACK      KEY51,SP1,TTYPEARG,SP70
          CALL      RSPMETR1
DELETR10  CALL      RKPMETR1
          BRANCH    OVRCD,DELETR99
.
          MATCH     SP70,PMETSTAT
          GOTO      DELETR99 IF NOT EQUAL
.
          MATCH     TTYPEARG,PMETTYPE
          GOTO      DELETR99 IF NOT EQUAL
.
          MATCH     PMECTRID,PMETTRID
          GOTO      DELETR10 IF NOT EQUAL
.
          MOVE      "1",PMETSTAT
.
          CALL       UPPMETR1
.
DELETR99  RETURN
.
.------------------------------------------------------------------------------
. Close pmsecoaf records
.------------------------------------------------------------------------------
DELECO00  PACK      KEY31,PMECHFND,ZERO,PMECTRID,SP70
          CALL      RDPMECO1
          BRANCH    OVRCD,DELECO99
.
.         We should only have one record with flag either 'Open' or 'Closed'
.
          PACK      SKEY31,PMEOHFND,PMEODFLG,PMEOTRID,SP70
.
          MOVE      ONE,PMEODFLG
          PACK      KEY31,PMEOHFND,PMEODFLG,PMEOTRID,SP70
          CALL      RAPMECO1
          IF        OVRCD=1
            MOVE      SKEY31,KEY31
            CALL      RDPMECO1                     * reposition
            IF        OVRCD=0
              MOVE      ONE,PMEODFLG
              CALL      UPPMECO1                   * update record
            ENDIF
          ELSE
            MOVE      "0",PMEODFLG                 * set to Open
            PACK      KEY31,PMEOHFND,PMEODFLG,PMEOTRID,SP70
            CALL      DEPMECO1
          ENDIF
.
DELECO99  RETURN
.
.------------------------------------------------------------
. Display Past Medical History Comments
.------------------------------------------------------------
MCMN0000  MOVE      "015",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
MCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,MCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      MCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      MCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      MCMN1000
.
MCMN9999  RETURN
+
.------------------------------------------------------------
. Display Working Diagnosis Comments
.------------------------------------------------------------
WCMN0000  MOVE      "016",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
WCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,WCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      WCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      WCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      WCMN1000
.
WCMN9999  RETURN
+
.------------------------------------------------------------
. Display Clinical Notes Comments
.------------------------------------------------------------
CCMN0000  MOVE      "017",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
CCMN1000  CALL      RKVSCMT1
          BRANCH    OVRCD,CCMN9999          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      CCMN9999 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      CCMN9999 IF NOT EQUAL
          WRITE     HTMLFILE;VSCTDATA
          GOTO      CCMN1000
.
CCMN9999  RETURN
+
.------------------------------------------------------------
. GETPMH00 - Get patient medical history
.------------------------------------------------------------
GETPMH00  PREP      PMHFILAF,PMHFILNM
          MOVE      ONE,F3
          WRITE     PMHFILAF,SEQ;QRYDATA
.
GETPMH10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETPMH90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETPMH80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     PMHFILAF,SEQ;QRYDATA
          GOTO      GETPMH10
.
GETPMH80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETPMH90  MOVE      F3,LASTITEM
          OPEN      PMHFILAF,PMHFILNM
GETPMH99  RETURN
+
.------------------------------------------------------------
. GETWDI00 - Get working diagnosis
.------------------------------------------------------------
GETWDI00  PREP      WDIFILAF,WDIFILNM
          MOVE      ONE,F3
          WRITE     WDIFILAF,SEQ;QRYDATA
.
GETWDI10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETWDI90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETWDI80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     WDIFILAF,SEQ;QRYDATA
          GOTO      GETWDI10
.
GETWDI80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETWDI90  MOVE      F3,LASTITM2
          OPEN      WDIFILAF,WDIFILNM
GETWDI99  RETURN
+
.------------------------------------------------------------
. GETCLN00 - Get clinical notes
.------------------------------------------------------------
GETCLN00  PREP      CLNFILAF,CLNFILNM
          MOVE      ONE,F3
          WRITE     CLNFILAF,SEQ;QRYDATA
.
GETCLN10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETCLN90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETCLN80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     CLNFILAF,SEQ;QRYDATA
          GOTO      GETCLN10
.
GETCLN80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETCLN90  MOVE      F3,LASTITM3
          OPEN      CLNFILAF,CLNFILNM
GETCLN99  RETURN
+
.------------------------------------------------------------
.  Visit based comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
VBCMN000  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
.
.         Past Medical History
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      PMHFILAF,PMHFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,VBCMN700
.
          MOVE      "015",KEY3
          PACK      KEY14,ADMISSNO,KEY3,SP70
VBCMN400  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,VBCMN500          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      VBCMN500 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      VBCMN500 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      VBCMN400
.
.         now write the new comments back
.
VBCMN500  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
VBCMN510  ADD       ONE,F3
          READ      PMHFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      VBCMN600 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITEM
              GOTO      VBCMN700
            ENDIF
.
            BRANCH    F3,VBCMN510             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITEM
            GOTO      VBCMN700
          ELSE
            GOTO      VBCMN510
          ENDIF
.
VBCMN600  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITEM
            GOTO      VBCMN700
          ENDIF
          GOTO      VBCMN510
.
.         Working Diagnosis
.
VBCMN700  MOVE      "016",KEY3
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      WDIFILAF,WDIFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,VBCMN800
.
          PACK      KEY14,ADMISSNO,KEY3,SP70
VBCMN710  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,VBCMN720          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      VBCMN720 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      VBCMN720 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      VBCMN710
.
.         now write the new comments back
.
VBCMN720  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
VBCMN730  ADD       ONE,F3
          READ      WDIFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      VBCMN750 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITM2
              GOTO      VBCMN800
            ENDIF
.
            BRANCH    F3,VBCMN730             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITM2
            GOTO      VBCMN800
          ELSE
            GOTO      VBCMN730
          ENDIF
.
VBCMN750  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITM2
            GOTO      VBCMN800
          ENDIF
          GOTO      VBCMN730
.
.         Clinical Notes
.
VBCMN800  MOVE      "017",KEY3
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      CLNFILAF,CLNFILNM
          TRAPCLR   IO
          BRANCH    OVRCD,VBCMN999
.
          PACK      KEY14,ADMISSNO,KEY3,SP70
VBCMN810  CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,VBCMN820          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      VBCMN820 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      VBCMN820 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      VBCMN810
.
.         now write the new comments back
.
VBCMN820  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
VBCMN830  ADD       ONE,F3
          READ      CLNFILAF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      VBCMN850 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITM3
              GOTO      VBCMN999
            ENDIF
.
            BRANCH    F3,VBCMN830             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITM3
            GOTO      VBCMN999
          ELSE
            GOTO      VBCMN830
          ENDIF
.
VBCMN850  MOVE      F3,VSCTLINE
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      WRVSCMT1
          IF        F3>=LASTITM3
            GOTO      VBCMN999
          ENDIF
          GOTO      VBCMN830
.
VBCMN999  RETURN
+
.------------------------------------------------------------
. Display Error Message, Refresh Parent and Close Window
.------------------------------------------------------------
WINCLE00  CALL      OPENHTML
          BRANCH    EXIT,WINCLE99
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#" ":
                             "src=#"../js/Standard.js#"></script>":
                             "<script type=#"text/javascript#" ":
                             "src=#"../js/Custom.js#"></script>":
                             "<script type=#"text/javascript#">  ":
                             "  alert(#"",WEBTITLE,"#");":
                             " if (self.name.match(/PopUpFrame/)) {":
                             " reloadParentFrame();}":
                             " else { ":
                             "  opener.history.go(0);":
                             "  self.close(); }":
                             "</script>"
          CALL      CLOSHTML     * End of Document
WINCLE99  RETURN
.
.-----------------------------------------------------------
.        Get Patient Attributes (BMI indicator & PTARVAL3)
.-----------------------------------------------------------
PATATR00  MOVE      SP70,BMIINDIC
.
          COMPARE   ONE,NOATTRIB
          GOTO      PATATR99 IF EQUAL
.
          MATCH     SP70,URNUMBER
          GOTO      PATATR99 IF EQUAL
          GOTO      PATATR99 IF EOS
.
.         MATCH     SP70,ADMISSNO
.         GOTO      PATATR99 IF EQUAL
.         GOTO      PATATR99 IF EOS
.
          PACK      KEY35,URNUMBER,Z70
          CALL      RSPTATR1
PATATR10  CALL      RPPTATR1
          BRANCH    OVRCD,PATATR90
.
          MATCH     URNUMBER,PTARURNO
          GOTO      PATATR90 IF NOT EQUAL
.
.         MATCH     ADMISSNO,PTARVISN
.         GOTO      PATATR90 IF NOT EQUAL
.
          MATCH     "1",PTARDELR
          GOTO      PATATR10 IF EQUAL
.
          MATCH     "001",PTARTYPE
          GOTO      PATATR10 IF NOT EQUAL
.
          MOVE      "1",BMIINDIC
.
          GOTO      PATATR99
.
PATATR90  CALL      CLPATATR
PATATR99  RETURN
.
.-----------------------------------------------------------
.        Bed Management Comments
.-----------------------------------------------------------
.
BMCM0000    WRITE   HTMLFILE;"<br>Comments: ";
.
            PACK      KEY18,BMCMDIM8,SP70
            CALL      RSBKDIA1
            CALL      RKBKDIA1
            BRANCH    OVRCD,BMCM0050
.
            MATCH     BMCMDIM8,DBKDIBOO
            GOTO      BMCM0050 IF NOT EQUAL
.
            MATCH     SP70,BKDICOMM
            GOTO      BMCM0050 IF EQUAL
.
            WRITE     HTMLFILE;"<br>",BKDICOMM;
.
BMCM0050    MOVE      BMCMDIM8,KEY8                  *32 3xComment Lines
            CALL      VSCMNT00 
.
BMCM9999    RETURN
.-----------------------------------------------------------------------------
. Current Status of Patient
.-----------------------------------------------------------------------------
PATSTS00  MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
          MOVE      SP70,CURSTATT
.
          COMPARE   THREE,OPDASTAT
          GOTO      PATSTS05 IF NOT EQUAL
.
          MOVE      "SC",CATEGORY
          MOVE      OPDACANC,CODE
          CALL      GETCOD00
          MATCH     ANST,TCINDC3
          IF        @EQUAL
            MOVE      "Transferred",CURSTATS
          ELSE
            MOVE      "Cancelled",CURSTATS
          ENDIF
          GOTO      PATSTS90
.
PATSTS05  CALL      CLOPRARD
          PACK      KEY10,OPDAUNIQ,SP70
          CALL      RDOPARD1
          BRANCH    OVRCD,PATSTS90
.
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          IF        OVRCD=1
            CALL      CLOPRSRG
          ENDIF
.
          MATCH     SP70,OPARATIM
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Holding",CURSTATS
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARANAS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Anaes",CURSTATS
            ENDIF
          ENDIF
.
          PACK      CURSTATC,OPARUC03,SP70
.
          MATCH     SP70,OPARUC03
          IF        !@EQUAL
            SQUEEZE   OPARUC03
            PACK      CURSTATB,LBRACK,OPARUC03,RBRACK,SP70
            RESET     OPARUC03
          ENDIF
.
PATSTS10  CALL      CLOPRSRG
          PACK      KEY11,OPDAUNIQ,ONE,SP70
          CALL      RDOPSRG1
          BRANCH    OVRCD,PATSTS90
.
          MATCH     SP70,OPSGTIPS
          IF        !@EQUAL
            MATCH     "1",OPSGUY05
            IF        @EQUAL
              MOVE      "Abandoned",CURSTATS
            ELSE
              MOVE      "Theatre",CURSTATS
            ENDIF
          ENDIF
.
          MATCH     SP70,OPARTIRF
          IF        !@EQUAL
            MOVE      "Recovery-Front",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIRB
          IF        !@EQUAL
            MOVE      "Recovery-Back",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIRD
          IF        !@EQUAL
            MOVE      "Recovery-Day",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTIDP 
          IF        !@EQUAL
            MOVE      "Ready To Depart",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTETC
          IF        !@EQUAL
            MOVE      "Exit",CURSTATS
          ENDIF
.
          MATCH     SP70,OPARTICU
          IF        !@EQUAL
            MOVE      "ICU",CURSTATS
          ENDIF
.
PATSTS90  MATCH     SP70,OPARTEXP
          IF        !@EQUAL
            MATCH     SP70,CURSTATS              * Is current status blank?
            IF        @EQUAL
              MOVE      "Deceased",CURSTATS      * Yes, set status to "Deceased"
            ELSE
              MOVE      CURSTATS,DIM15           * No, save current status
              PACK      CURSTATS,STAPRFIX,DIM15  * Build new status with prefix
            ENDIF
          ENDIF
.
          MATCH     SP70,CURSTATS           * Theatre status blank?
          GOTO      PATSTS99 IF EQUAL
.
          MATCH     "1",OPCNTHED            * Display theatre location/banner
          IF        @EQUAL
            PACK      KEY6,OPDATHET,SP70
            CALL      RDOPOPR1
            IF         OVRCD<>1
              MOVE      OPRMDESC,CURSTATT
              STRIP     CURSTATT
            ENDIF
          ENDIF
.
PATSTS99  RETURN
.
.------------------------------------------------------------
. Patient Level Nutrition Maintenance
.------------------------------------------------------------
.
NUTR0000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,NUTR9100
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          BRANCH    OVRCD,NUTR9100
.
          MATCH     SP70,UPDATETY
          GOTO      NUTR8000 IF EQUAL
.
          MATCH     "A",UPDATETY
          GOTO      NUTR1000 IF EQUAL
.
          GOTO      NUTR9000
.
NUTR1000  PACK      KEY16,PMNUT001,PMNUT002,SP70
          CALL      RDPMNUT1                  * Read nutrition record
          IF        OVRCD=1
            CALL      CLRNUT00
          ENDIF
.
          CALL      MVNUT000                  * Move CGIs into record vars.
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          CLOCK     TIME,CTIMEIS              * Set update timestamp and userid
          PACK      PMNUUPDU,WBSEUID,SP70
          PACK      PMNUUPDD,CURRDATE,CTIMEIS
.
          PACK      KEY16,PMNUADMN,PMNUDATE,SP70
          CALL      RAPMNUT1                  * Is nutrition record there ?
          BRANCH    OVRCD,NUTR1100
.
          CALL      UPPMNUT1 
          GOTO      NUTR1500
.
NUTR1100  MOVE      PMNUUPDU,PMNUCRTU         * No - set up create t/stamp
          MOVE      PMNUUPDD,PMNUCRTD         *      and userid
          CALL      WRPMNUT1                  *      then write record
.
NUTR1500  PACK      KEY8,PMNUADMN,SP70
          CALL      RDBKREC1                  * Read booking
          BRANCH    OVRCD,NUTR1700
.
          COMPARE   ZERO,OBASTAT              * Booked only
          GOTO      NUTR1700 IF NOT EQUAL
.
          PACK      KEY8,PMNUADMN,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,NUTR1700
.
          MOVE      PMNUDIET,BKRXDIET         * Update booking diet
.
          CALL      UPBKRX11
          GOTO      NUTR1950
.
NUTR1700  PACK      KEY8,PMNUADMN,SP70
          CALL      RDMISS1  
          BRANCH    OVRCD,NUTR1950
.
          COMPARE   ONE,ASTAT                 * Pre admission only
          GOTO      NUTR1950 IF NOT EQUAL
.
          MOVE      PMNUDIET,ADIET            * Update pre admission diet
.
          CALL      UPMISS1
.
          CALL      PMIGTNID                  * get national id
          MOVE      NMPNUMB,PTNINMPI
          MOVE      THREE,HL7TRGID
          MOVE      SP8,HL7INCLD
          PROC      DGCLICCP                  * broadcast pre adm update
          GOTO      NUTR1950
.
NUTR1950  MOVE      ZERO,EXIT
          GOTO      NUTR9999
.
NUTR8000  CALL      CURPER00
          CALL      CALCDT00
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1                 * Read visit
          IF        OVRCD=1
            CALL      RDBKREC1
            BRANCH    OVRCD,NUTR9200
.
            COMPARE   ZERO,BKRESTAT          * Booking with a status booked
            GOTO      NUTR9500 IF NOT EQUAL
.
            GOTO      NUTR8500
          ENDIF
.
          COMPARE   THREE,PVITYPE           * IP visits only
          GOTO      NUTR9300 IF NOT EQUAL     
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1                 * Read admission
          BRANCH    OVRCD,NUTR9200
.
          COMPARE   "5",ASTAT               * Cancelled admission
          GOTO      NUTR9400 IF EQUAL 
.
NUTR8500  PACK      KEY16,PMNUT001,PMNUT002,SP70
          CALL      RDPMNUT1                     * Read nutrition table
          IF        OVRCD=1
            CALL      CLPMSNUT
          ENDIF
.
          MOVE      "Visit Nutrition Details", WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,NUTR9999
.
          CALL      WEBBOD00   * Output Templated Body of HTML
          CALL      WEBEND00   * Output End of Web Page
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9000  MOVE      "Invalid Update Type",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9100  MOVE      "Invalid U/R Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9200  MOVE      "Invalid Visit Number",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9300  CLEAR     WEBTITLE
          APPEND    "Nutrition details only available for ",WEBTITLE
          APPEND    "inpatient visits",WEBTITLE
          RESET     WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9400  MOVE      "Visit is cancelled, no nutrition data available",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9500  MOVE      "Invalid booking status - Booked only",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      NUTR9999
.
NUTR9999  RETURN
.
.------------------------------------------------------------
. Nutrition list for an IP visit
.------------------------------------------------------------
NUTL0000  CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD     * Current date
          REP       " 0",CURRDATE
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDMISS1                      * Read admission
          MOVE      OVRCD,MISSFLAG
          COMPARE   ONE,OVRCD     
          GOTO      NUTL0500 IF NOT EQUAL
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDBKREC1
          BRANCH    OVRCD,NUTL9999
.
NUTL0500  PACK      KEY16,ADMISSNO,Z70
          CALL      RSPMNUT1
NUTL1000  CALL      RPPMNUT1
          BRANCH    OVRCD,NUTL9999
.
          MATCH     ADMISSNO,PMNUADMN
          GOTO      NUTL9999 IF NOT EQUAL
.
          MOVE      ZERO,EDITFLAG                // No Maintenance icon
          MOVE      SP70,DISPDATE                // Clear date 
          MOVE      SP70,MEALDATE                // Clear meal date
.
          IF        BKRESTAT=0 & MISSFLAG=1
            MATCH     SP70,PMNUDATE              // Booking
            GOTO      NUTL1000 IF NOT EQUAL
.
            MOVE      ONE,EDITFLAG               // Show Maintenance icon
            MOVE      "Booked",MEALDATE
          ENDIF
.
          IF        ASTAT=1 & MISSFLAG<>1
            MATCH     SP70,PMNUDATE              // Pre admission
            GOTO      NUTL1000 IF NOT EQUAL
.
            MOVE      ONE,EDITFLAG               // Show Maintenance icon
            MOVE      "Preadmission",MEALDATE
          ENDIF
.
          IF        ASTAT=2 & MISSFLAG<>1
            MATCH     CURRDATE,PMNUDATE          // Current admission
            IF        !@LESS
              MOVE      ONE,EDITFLAG             // Show Maintenance icon
            ENDIF                                // for current date only
          ENDIF
.
          IF        ASTAT=3 & MISSFLAG<>1
            MOVE     ZERO,EDITFLAG               // No Maintenance icon
          ENDIF                                  // when discharged
.
          MATCH     SP70,PMNUDATE
          IF        !@EQUAL
            UNPACK    PMNUDATE,CCENT,CYEAR,CMON,CDAY
            CALL      DAYOFWEK
            LOAD      DAYNAM3,WEEKDAY,MON,TUE,WED,THU,FRI,SAT,SUN
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      MEALDATE,DAYNAM3,SP1,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ELSE
            IF        MISSFLAG<>1
              MOVE      "Preadmission",MEALDATE
            ELSE
              MOVE      "Booked",MEALDATE
            ENDIF
          ENDIF
.
          MOVE      "DC",CATEGORY                // Diet
          MOVE      PMNUDIET,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIETDESC
.
          MOVE      SP70,DTFASTNG                // Fasting
          MATCH     "1",PMNUFAST
          IF        @EQUAL
            MOVE      "Yes",DTFASTNG       
          ENDIF
.
          MOVE      CATMJ,CATEGORY               // Diet Type
          MOVE      PMNUDTYP,CODE
          CALL      GETCOD00
          MOVE      TDESC,DTDTTYPE
.
          MOVE      SP70,DOCFNAME               // Dietician
          MATCH     PMNUDCDE,SP10
          IF        !@EQUAL 
            PACK      KEY10,PMNUDCDE
            CALL      RDPMHCP1
            IF        OVRCD<>1        
              MOVE      PMHCTITL,FMTTITLE
              MOVE      PMHCGNAM,FMTGNAME
              MOVE      PMHCSNAM,FMTSNAME
              CALL      DOCNM000
            ENDIF
          ENDIF
.
          MOVE      CATMJ,CATEGORY               // Meal 1
          MOVE      PMNUML01,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML01
.
          MOVE      CATMM,CATEGORY               // Meal 2
          MOVE      PMNUML02,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML02
.
          MOVE      CATMJ,CATEGORY               // Meal 3
          MOVE      PMNUML03,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML03
.
          MOVE      CATMM,CATEGORY               // Meal 4
          MOVE      PMNUML04,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML04
.
          MOVE      CATMJ,CATEGORY               // Meal 5
          MOVE      PMNUML05,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML05
.
          MOVE      CATMM,CATEGORY               // Meal 6
          MOVE      PMNUML06,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML06
.
          MOVE      CATMJ,CATEGORY               // Meal 7
          MOVE      PMNUML07,CODE
          CALL      GETCOD00
          MOVE      TDESC,DESCML07
.
          PACK      CREATEDB,SP70,SP70
          MATCH     SP70,PMNUCRTU                // Created By
          GOTO      NUTL2000 IF EQUAL
.
          MATCH     SP70,PMNUCRTD                // Created date and time
          GOTO      NUTL2000 IF EQUAL
.
          PACK      KEY10,PMNUCRTU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMNUCRTU,WBSENAM
          ENDIF
.
          UNPACK    PMNUCRTD,TEMPDATE,TEMPTIME   // Created date and time
.
          UNPACK    TEMPDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     CREATEDB
          APPEND    "Created ",CREATEDB
          APPEND    DISPDATE,CREATEDB
          APPEND    " @ ",CREATEDB
          APPEND    TEMPTIME,CREATEDB
          APPEND    " by ",CREATEDB
          APPEND    WBSENAM,CREATEDB
          RESET     CREATEDB
.
NUTL2000  PACK      UPDATEDB,SP70,SP70
          MATCH     SP70,PMNUUPDU                // Updated By
          GOTO      NUTL3000 IF EQUAL
.
          MATCH     SP70,PMNUUPDD                // Updated date and time
          GOTO      NUTL3000 IF EQUAL
.
          PACK      KEY10,PMNUUPDU,SP70
          CALL      RDWBSE1
          IF        OVRCD=1
            MOVE      PMNUUPDU,WBSENAM
          ENDIF
.
          UNPACK    PMNUUPDD,TEMPDATE,TEMPTIME   // Created date and time
.
          UNPACK    TEMPDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     UPDATEDB
          APPEND    "Updated ",UPDATEDB
          APPEND    DISPDATE,UPDATEDB
          APPEND    " @ ",UPDATEDB
          APPEND    TEMPTIME,UPDATEDB
          APPEND    " by ",UPDATEDB
          APPEND    WBSENAM,UPDATEDB
          RESET     UPDATEDB
.         
NUTL3000  CLEAR     HTMLLINK
          APPEND    "javascript:UpdateNutrition('",HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMNUADMN,HTMLLINK
          APPEND    "','",HTMLLINK
          APPEND    PMNUDATE,HTMLLINK
          APPEND    "')",HTMLLINK
          RESET     HTMLLINK
.
          WRITE     HTMLFILE;"t.addRow(#"",HTMLLINK,"#",":           * 0
                             "#"",EDITFLAG,"#",":                    * 1
                             "#"",MEALDATE,"#",":                    * 2
                             "#"",DIETDESC,"#",":                    * 3
                             "#"",DTFASTNG,"#",":                    * 4
                             "#"",DTDTTYPE,"#",":                    * 5
                             "#"",DOCFNAME,"#",":                    * 6
                             "#"",PMNUCOM1,"<br>":                   * 7
                                  PMNUCOM2,"<br>":
                                  PMNUCOM3,"<br>":
                                  PMNUCOM4,"<br>":
                                  PMNUCOM5,"#",":
                             "#"",DESCML01,"<br>":                   * 8
                                  DESCML02,"<br>":
                                  DESCML03,"<br>":
                                  DESCML04,"<br>":
                                  DESCML05,"<br>":
                                  DESCML06,"<br>":
                                  DESCML07,"#",":                    
                             "#"",CREATEDB,"<br>",UPDATEDB,"#",":    *9
                             "#"",DIETDESC,"<br>":                   *10
                                  DESCML01,"<br>":
                                  DESCML03,"<br>":
                                  DESCML05,"<br>":
                                  DESCML07,"#",": 
                             "#"","B-",PMNUBSUP,"<br>":                     *11
                                  "M-",PMNUMSUP,"<br>":
                                  "L-",PMNULSUP,"<br>":
                                  "A-",PMNUASUP,"<br>":
                                  "D-",PMNUDSUP,"<br>":
                                  "S-",PMNUSSUP,"#",":
                             "#"",PMNUDATE,"#"":
                             ");"
.
          GOTO      NUTL1000

.
NUTL9999  RETURN
.------------------------------------------------------------
. General tags
.------------------------------------------------------------
GTAG0000  BRANCH    FLDITMNO,GTAG0010,GTAG0020
.
          WRITE     HTMLFILE;"Invalid IBA Tag";
          GOTO      GTAG9999
.
GTAG0010  CALL      NUTL0000          * Nutrition list for an IP visit
          GOTO      GTAG9999
.
GTAG0020  WRITE     HTMLFILE;DEFTVIEW;      * Default table sort view
          GOTO      GTAG9999
.
GTAG9999  RETURN
+
.------------------------------------------------------------------------------
. Update Patient Attribute Coded Field value
.------------------------------------------------------------------------------
UPCVAL00  MOVE      QRYDATA,ATCODVAL
          UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,ATTYPIND
          MOVE      "1",ATCODIND       * Coded Field 1
.
          MOVE      URNUMBER,PTATR001
          MOVE      ADMISSNO,PTATR002
          CALL      UPDACV00
.
UPCVAL99  RETURN
+
.------------------------------------------------------------------------------
. Save Patient Attribute text into temp file; KEY3 determines Attribute Type
.------------------------------------------------------------------------------
SAVATF00  UNPACK    QRYNAME,KEY5,KEY3
          MOVE      KEY3,ATTYPIND
.
          BRANCH    ATTYPIND,SAVATF99,SAVATF20,SAVATF30,SAVATF40
          GOTO      SAVATF99
.
SAVATF20  CALL      TFILENAM           * Get temp file name
          MOVE      TFILNAME,ATWDIAFN  * Save as 'Working Diagnosis' filename
          MOVE      ATWDIAFN,ATTMPFIL
          GOTO      SAVATF90
.
SAVATF30  CALL      TFILENAM           * Get temp file name
          MOVE      TFILNAME,ATMHISFN  * Save as 'Relevant Medical History'
          MOVE      ATMHISFN,ATTMPFIL
          GOTO      SAVATF90
.
SAVATF40  CALL      TFILENAM           * Get temp file name
          MOVE      TFILNAME,ATBDISFN  * Save as 'Barriers to Discharge'
          MOVE      ATBDISFN,ATTMPFIL
          GOTO      SAVATF90
.
SAVATF90  CALL      GETATN00           * Write notes to temp file
          GOTO      SAVATF99
.
SAVATF99  RETURN
+
.*******************************************************************************
. Get Attribute Notes from Text Area (cgi) and write to temp file
.*******************************************************************************
GETATN00  PREP      ATTMPFAF,ATTMPFIL
          MOVE      ONE,F3
          WRITE     ATTMPFAF,SEQ;QRYDATA
.
GETATN10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GETATN90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GETATN80 IF NOT EQUAL
.
          MATCH     SP70,QRYDATA
          GOTO      GETATN11 IF NOT EQUAL
          GOTO      GETATN11 IF NOT EOS
.
          PACK      DIM80,SP70,SP70
          MOVE      DIM80,QRYDATA                * write blank line to file
.
GETATN11  ADD       ONE,F3
          WRITE     ATTMPFAF,SEQ;QRYDATA
.
          GOTO      GETATN10
.
GETATN80  MOVE      ONE,TEXTAREA                 * Flag for Next CGI Parameter
GETATN90  OPEN      ATTMPFAF,ATTMPFIL
GETATN99  RETURN
+
.------------------------------------------------------------------------------
.   Read Patient Attribute notes (max 3 lines) from temp file and move them to
.   corresponding Patient Attribute work vars.
.------------------------------------------------------------------------------
MOVATF00  MOVE      ZERO,F3
          MOVE      SP70,PTATR014
          MOVE      SP70,PTATR015
          MOVE      SP70,PTATR016
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      ATTMPFAF,ATTMPFIL
          TRAPCLR   IO
          BRANCH    OVRCD,MOVATF99
.
MOVATF10  ADD       ONE,F3
          COMPARE   F3,THREE
          GOTO      MOVATF99 IF LESS
.
          READ      ATTMPFAF,SEQ;DIM80
          GOTO      MOVATF99 IF OVER
          STORE     DIM80,F3,PTATR014,PTATR015,PTATR016
.
          GOTO      MOVATF10
.
MOVATF99  RETURN
+
.------------------------------------------------------------------------------
. Show expected post op patients and bed requests for the selected ward view
.------------------------------------------------------------------------------
EXPT0000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EXPT9999
. 
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          COMPARE   ONE,TOGGLEXP            * Displaying expected patients
          GOTO      EXPT0500 IF NOT EQUAL

          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>":
                             "Post Op/Bed Request Ward/Bed</td>":
                             "<td class=HeadingCell>Adm Date</td>":
                             "<td class=HeadingCell>Exp Los</td>":
                             "<td class=HeadingCell>Attending Doctor</td>":
                             "<td class=HeadingCell>Theatre Status</td>":
                             "<td class=HeadingCell>Recovery Bay</td>":
                             "</tr>"
.
EXPT0500  PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
EXPT1000  CALL      RDKMISS2                * Check admissions for post op ward
          BRANCH    OVRCD,EXPT5000
.
          COMPARE   TWO,ASTAT               * Admitted only
          GOTO      EXPT5000 IF NOT EQUAL
.
          MATCH     AWARD,WARDCODE          * Already admitted to this ward
          GOTO      EXPT1000 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,EXPT1000
.
          MOVE      ONE,EXPTTYPE            * Admission
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11                * read visit extn
          BRANCH    OVRCD,EXPT1000
.
          MATCH     PMVXPOWD,WARDCODE       * Correct post op ward
          GOTO      EXPT2000 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKRX11                * read booking extn
          BRANCH    OVRCD,EXPT1000
.
          MATCH     BKRXPOWD,WARDCODE       * Correct post op ward
          GOTO      EXPT1000 IF NOT EQUAL
.
          MOVE      THREE,EXPTTYPE          * Admission/Booking
.
EXPT2000  MOVE      "2",KEY1
          PACK      KEY31,DAADMNO,KEY1,CURRDATE,Z70
          CALL      RSOPDEA2
          CALL      RPOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,EXPT1000
.
          MATCH     OPDAADMN,DAADMNO
          GOTO      EXPT1000 IF NOT EQUAL
.
          COMPARE   TWO,OPDASTAT                 * Theatre status admitted
          GOTO      EXPT1000 IF NOT EQUAL
.
          MATCH     CURRDATE,OPDADATE            * Skip if not theatre today
          GOTO      EXPT1000 IF NOT EQUAL
.
          MOVE      AURNO,URNUMBER          * Populate U/R
          MOVE      AADMNO,ADMISSNO         * Populate Visit
.
          CALL      EXPR0000                * Display row
          GOTO      EXPT1000
.
EXPT5000  PACK      KEY24,CURRDATE,SP70
          CALL      RSPMBRQ3                * Todays bed requests
EXPT6000  CALL      RKPMBRQ3
          BRANCH    OVRCD,EXPT9999
.
          MATCH     CURRDATE,PMBRREQD
          GOTO      EXPT9999 IF NOT EQUAL
.
          MATCH     "1",PMBRRSTA              * Requested
          IF        !@EQUAL
            MATCH     "2",PMBRRSTA            * Allocated
            GOTO      EXPT6000 IF NOT EQUAL
          ENDIF
.
          MATCH     PMBREWRD,WARDCODE         * Expected ward
          GOTO      EXPT6000 IF NOT EQUAL
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDMISS1                   * Read admission
          BRANCH    OVRCD,EXPT6000
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDVISA1                   * Read visit
          BRANCH    OVRCD,EXPT6000
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDPMVX11                  * Read visit extn
          BRANCH    OVRCD,EXPT6000
.
          MOVE      PVIURNO,URNUMBER        * Populate U/R
          MOVE      PVIBILL,ADMISSNO        * Populate Visit
.
          MOVE      TWO,EXPTTYPE            * Bed Request
          CALL      EXPR0000                * Display row
          GOTO      EXPT6000
.
EXPT9999  RETURN
+
.------------------------------------------------------------------------------
. Show expected post op patients and bed requests row
.------------------------------------------------------------------------------
EXPR0000  ADD       ONE,NUMBREXP            * Number of expected patients count
.
          COMPARE   ONE,TOGGLEXP            * Displaying expected patients
          GOTO      EXPR9999 IF NOT EQUAL
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,EXPR9999
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXPR9999
.
          CALL      PATINT00
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000

          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          CALL      GETAN000                * get Anaesthetist
          MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
.
          IF        ANATFLAG = 1
            CALL      PATSTS00                * get theatre status
          ENDIF
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,PVIDOCT,SP70
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            PACK      SDOCFNAM,DOCFNAME
          ENDIF
.
          MOVE      SP70,POSTWBED
          IF        EXPTTYPE=2
            MOVE      PMBREWRD,PMVXPOWD
            MOVE      PMBREBED,PMVXPOBD
          ENDIF
.
          IF        EXPTTYPE=3
            MOVE      BKRXPOWD,PMVXPOWD       * Use post OP ward/bed from
            MOVE      BKRXPOBD,PMVXPOBD       * booking
            MOVE      ONE,EXPTTYPE
          ENDIF
.
          MATCH     SP70,PMVXPOWD
          IF        !@EQUAL
            PACK      KEY6,PMVXPOWD,PMVXPOBD,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,EXPR2000
.
            CLEAR     POSTWBED
            MATCH     ZEROVISN,WADMNO
            IF        !@EQUAL
              APPEND    BODMASFT,POSTWBED
            ENDIF
.
            IF        EXPTTYPE=2
              APPEND    LABREQST,POSTWBED
            ENDIF
.
            APPEND    PMVXPOWD,POSTWBED
.
            MATCH     SP70,PMVXPOBD
            IF        !@EQUAL
              APPEND    FRBRACK,POSTWBED
              APPEND    PMVXPOBD,POSTWBED
            ENDIF
.
            MATCH     ZEROVISN,WADMNO
            IF        !@EQUAL
              APPEND    ENDFONT,POSTWBED
            ENDIF
.
            RESET     POSTWBED
          ENDIF
.
EXPR2000  WRITE     HTMLFILE;"<tr><td height=25>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"patweb98.pbl":
                             "?reportno=01&template=001":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td>",POSTWBED,"</td>":
                             "<td>",DISPDATE,"</td>":
                             "<td>",ASTAY,"</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",CURSTATS,"</td>":
                             "<td>",CURSTATC,"</td>":
                             "</tr>"

.
EXPR9999  RETURN
.
.------------------------------------------------------------------------------
. Show expected post op patients and bed requests for the selected ward view
. - Healthscope
.------------------------------------------------------------------------------
EXPTA000  PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,EXPTA999
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          COMPARE   ONE,TOGGLEXP            * Displaying expected patients
          GOTO      EXPTA050 IF NOT EQUAL
.
          WRITE     HTMLFILE;"<tr><td class=HeadingCell>Patient</td>":
                             "<td class=HeadingCell>":
                             "Post Op/Bed Request Ward/Bed</td>":
                             "<td class=HeadingCell>Adm Date</td>":
                             "<td class=HeadingCell>Exp Los</td>":
                             "<td class=HeadingCell>Attending Doctor</td>":
                             "<td class=HeadingCell>Theatre Status</td>":
                             "<td class=HeadingCell>Recovery Bay</td>":
                             "</tr>"
.
EXPTA050  CALL      EXPTB000                * Bookings/Pre
.
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
EXPTA100  CALL      RDKMISS2                * Check admissions for post op ward
          BRANCH    OVRCD,EXPTA300
.
          COMPARE   TWO,ASTAT               * Admitted only
          GOTO      EXPTA300 IF NOT EQUAL
.
          MATCH     AWARD,WARDCODE          * Already admitted to this ward
          GOTO      EXPTA100 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,EXPTA100
.
          MOVE      ONE,EXPTTYPE            * Admission
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11                * read visit extn
          BRANCH    OVRCD,EXPTA100
.
          MATCH     PMVXPOWD,WARDCODE       * Correct post op ward
          GOTO      EXPTA200 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKRX11                * read booking extn
          BRANCH    OVRCD,EXPTA100
.
          MATCH     BKRXPOWD,WARDCODE       * Correct post op ward
          GOTO      EXPTA100 IF NOT EQUAL
.
          MOVE      THREE,EXPTTYPE          * Admission/Booking
.
EXPTA200  MOVE      "2",KEY1
          PACK      KEY31,DAADMNO,KEY1,CURRDATE,Z70
          CALL      RSOPDEA2
          CALL      RPOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,EXPTA100
.
          MATCH     OPDAADMN,DAADMNO
          GOTO      EXPTA100 IF NOT EQUAL
.
          MATCH     CURRDATE,OPDADATE            * Skip if not theatre today
          GOTO      EXPTA100 IF NOT EQUAL
.
          MOVE      AURNO,URNUMBER          * Populate U/R
          MOVE      AADMNO,ADMISSNO         * Populate Visit
.
          MOVE      ONE,EXPTTYPE            * Admission
.
.         MATCH     SP70,PMVXPOWD
.         IF        @EQUAL
.           MOVE      FIVE,EXPTTYPE            * Exp Post Op
.         ENDIF
.
.         MATCH     PMVXPOWD,PTMIXWRD
.         IF        !@EQUAL
.           MOVE      SIX,EXPTTYPE             * Exp Post Op
.         ENDIF
.
          CALL      EXPRA000                * Display row
          GOTO      EXPTA100
.
EXPTA300  PACK      KEY16,CURRDATE,SP70
          CALL      RDSMISS3
EXPTA320  CALL      RDKMISS3                * Check admissions for post op ward
          BRANCH    OVRCD,EXPTA500
.
          MATCH     CURRDATE,ADATE
          GOTO      EXPTA500 IF NOT EQUAL
.
          COMPARE   ONE,ASTAT               * pre-Admission
          GOTO      EXPTA320 IF NOT EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,EXPTA320
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11                * read visit extn
          BRANCH    OVRCD,EXPTA320
.
          MATCH     PMVXPOWD,WARDCODE       * Correct post op ward
          GOTO      EXPTA400 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKRX11                * read booking extn
          BRANCH    OVRCD,EXPTA320
.
          MATCH     BKRXPOWD,WARDCODE       * Correct post op ward
          GOTO      EXPTA320 IF NOT EQUAL
.
EXPTA400  MOVE      AURNO,URNUMBER          * Populate U/R
          MOVE      AADMNO,ADMISSNO         * Populate Visit
.
          MOVE      FIVE,EXPTTYPE           * Admission
          CALL      EXPRA000                * Display row
          GOTO      EXPTA320
.
EXPTA500  PACK      KEY24,CURRDATE,SP70
          CALL      RSPMBRQ3                * Todays bed requests
EXPTA600  CALL      RKPMBRQ3
          BRANCH    OVRCD,EXPTA999
.
          MATCH     CURRDATE,PMBRREQD
          GOTO      EXPTA999 IF NOT EQUAL
.
          MATCH     "1",PMBRRSTA              * Requested
          IF        !@EQUAL
            MATCH     "2",PMBRRSTA            * Allocated
            GOTO      EXPTA600 IF NOT EQUAL
          ENDIF
.
          MATCH     PMBREWRD,WARDCODE         * Expected ward
          GOTO      EXPTA600 IF NOT EQUAL
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDMISS1                   * Read admission
          BRANCH    OVRCD,EXPTA600
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDVISA1                   * Read visit
          BRANCH    OVRCD,EXPTA600
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDPMVX11                  * Read visit extn
          BRANCH    OVRCD,EXPTA600
.
          MOVE      PVIURNO,URNUMBER        * Populate U/R
          MOVE      PVIBILL,ADMISSNO        * Populate Visit
.
          MOVE      SEVEN,EXPTTYPE            * Bed Request
EXPTA800  CALL      EXPRA000                * Display row
          GOTO      EXPTA600
.
EXPTA999  RETURN
+
.------------------------------------------------------------------------------
. Show expected post op patients and bed requests row
.------------------------------------------------------------------------------
EXPRA000  ADD       ONE,NUMBREXP            * Number of expected patients count
.
          COMPARE   ONE,TOGGLEXP            * Displaying expected patients
          GOTO      EXPRA999 IF NOT EQUAL
.
          PACK      KEY8,URNUMBER,SP70      * Reads Patient Master File
          CALL      RDMAST1
          BRANCH    OVRCD,EXPRA999
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,EXPRA999
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,EXPRA999
.
          CALL      PATINT00                * Format Patient Name
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000

          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          CALL      GETAN000                * get Anaesthetist
          MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
.
          IF        ANATFLAG = 1
            CALL      PATSTS00                * get theatre status
          ENDIF
.
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,PVIDOCT,SP70
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            PACK      SDOCFNAM,DOCFNAME
          ENDIF
.
          MOVE      SP70,POSTWBED
.
          IF        EXPTTYPE=2
            MOVE      PMBREWRD,PMVXPOWD       * Use post Op ward/bed from
            MOVE      PMBREBED,PMVXPOBD       * bed request
            CALL      BREQLK00
            GOTO      EXPRA300
          ENDIF
.
          IF        EXPTTYPE=7
            MOVE      PMBREWRD,PMVXPOWD       * Use post Op ward/bed from
            MOVE      PMBREBED,PMVXPOBD       * bed request
            MOVE      FIVE,EXPTTYPE
            CALL      BREQLK00
            GOTO      EXPRA300
          ENDIF
.
          IF        EXPTTYPE=3
            MOVE      BKRXPOWD,PMVXPOWD       * Use post OP ward/bed from
            MOVE      BKRXPOBD,PMVXPOBD       * booking
            MOVE      ONE,EXPTTYPE
          ENDIF
.
EXPRA200  CLEAR     HTMLLINK
          APPEND    "<img src=../images/EditIcon.gif",HTMLLINK
          APPEND    " class=ListIcon onclick='",HTMLLINK
          APPEND    "UpdateExpected(",HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    ",",HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    ADMISSNO,HTMLLINK 
          APPEND    QUOTE,HTMLLINK
          APPEND    ")'>",HTMLLINK 
          RESET     HTMLLINK
          STRIP     HTMLLINK

EXPRA300  MATCH     SP70,PMVXPOWD                     * Post-Op Ward Empty
          IF        !@EQUAL
            PACK      KEY6,PMVXPOWD,PMVXPOBD,SP70     * Get Ward Details
            CALL      RDWARD1
            BRANCH    OVRCD,EXPRA500
.
            CLEAR     POSTWBED
            MATCH     ZEROVISN,WADMNO               
            IF        !@EQUAL
              APPEND    BODMASFT,POSTWBED
            ENDIF
.
            IF        EXPTTYPE=2
              APPEND    LABREQST,POSTWBED
            ENDIF
.
            APPEND    PMVXPOWD,POSTWBED
.
            MATCH     SP70,PMVXPOBD                  * Post-Op Bed Empty
            IF        !@EQUAL
              APPEND    FRBRACK,POSTWBED
              APPEND    PMVXPOBD,POSTWBED
            ENDIF
.
            MATCH     ZEROVISN,WADMNO
            IF        !@EQUAL
              APPEND    ENDFONT,POSTWBED
            ENDIF
.
            RESET     POSTWBED
          ENDIF
.
EXPRA500  IF        EXPTTYPE = 4
            GOTO      EXPRA700
          ENDIF
.
          IF        EXPTTYPE = 5
            GOTO      EXPRA700
          ENDIF
.
          IF        EXPTTYPE = 6
            GOTO      EXPRA700
          ENDIF
.
EXPRA600  WRITE     HTMLFILE;"<tr><td height=25>":
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"patweb98.pbl":
                             "?reportno=01&template=001":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td>",HTMLLINK,POSTWBED,"</td>":
                             "<td>",DISPDATE,"</td>":
                             "<td>",ASTAY,"</td>":
                             "<td>",DOCFNAME,"</td>":
                             "<td>",CURSTATS,"</td>":
                             "<td>",CURSTATC,"</td>":
                             "</tr>"
          GOTO      EXPRA999
.
EXPRA700  WRITE     HTMLFILE;"<tr><td height=25>",BODMASFT:
                             "<img src=../images/PatientFolder",FOLDERSF,".gif":
                             " class=ListIcon ":
                             " onclick='location.href=#"patweb98.pbl":
                             "?reportno=01&template=001":
                             "&urnumber=",URNUMBER:
                             "&admissno=",ADMISSNO,"#";'>":
                             FORMATNM,"</td>":
                             "<td>",BODMASFT,HTMLLINK,POSTWBED,ENDFONT,"</td>":
                             "<td>",BODMASFT,DISPDATE,ENDFONT,"</td>":
                             "<td>",BODMASFT,ASTAY,ENDFONT,"</td>":
                             "<td>",BODMASFT,DOCFNAME,ENDFONT,"</td>":
                             "<td>",BODMASFT,CURSTATS,ENDFONT,"</td>":
                             "<td>",BODMASFT,CURSTATC,ENDFONT,"</td>":
                             "</tr>"
          GOTO      EXPRA999
.
EXPRA999  RETURN
.
.------------------------------------------------------------
. Get booking and preadmission patient for today
.------------------------------------------------------------
EXPTB000  PACK      KEY16,CURRDATE,SP70
          CALL      RSBKREC4
EXPTB100  CALL      RKBKREC4
          BRANCH    OVRCD,EXPTB500
.
          MATCH     BKREEDAT,CURRDATE
          GOTO      EXPTB500 IF NOT EQUAL
.
          COMPARE   ZERO,BKRESTAT                * Booked only
          GOTO      EXPTB100 IF NOT EQUAL
.
EXPTB110  PACK      KEY8,DBKREBOO,SP70           
          CALL      RDBKRX11
          BRANCH    OVRCD,EXPTB100
.
          MATCH     SP70,BKRXPOWD                * If Post Op ward is empty
          GOTO      EXPTB150 IF EQUAL            * then check expected ward
.
. Post Op ward is not empty
.
          MATCH     BKRXPOWD,BKREWARD            * Post Op and Exp Ward Same 
          GOTO      EXPTB100 IF EQUAL            * In Booking

          PACK      KEY8,DBKREBOO,SP70           * Checks for Pre-Adm Record
          CALL      RDMISS1
          BRANCH    OVRCD,EXPTB140
.
          COMPARE   ONE,ASTAT                    * One = Pre-Admiss
          GOTO      EXPTB140 IF NOT EQUAL
.
          MATCH     SP70,PTMIXWRD                * Expected Ward Empty
          GOTO      EXPTB140 IF EQUAL
.
          MATCH     BKRXPOWD,PTMIXWRD            * Booking Post-Op Ward
                                                 * Doesn't Match Pre-Admiss
                                                 * Expected Ward
          IF        !@EQUAL
            MOVE      AURNO,URNUMBER           * Populate U/R
            MOVE      DAADMNO,ADMISSNO         * Populate Visit
            MOVE      BKRXPOWD,PMVXPOWD
            MOVE      BKRXPOBD,PMVXPOBD
            MOVE      SIX,EXPTTYPE             * Exp Post Op
            CALL      EXPRA000                 * Display row
            GOTO      EXPTB100
          ENDIF
.
EXPTB140  MATCH     WARDCODE,BKRXPOWD          * post OP ward/bed - Booking
          IF        @EQUAL
            MOVE      AURNO,URNUMBER           * Populate U/R
            MOVE      DAADMNO,ADMISSNO         * Populate Visit
            MOVE      BKRXPOWD,PMVXPOWD        
            MOVE      BKRXPOBD,PMVXPOBD         
            MOVE      FOUR,EXPTTYPE            * Booking
            CALL      EXPRA000                 * Display row
          ENDIF
          GOTO      EXPTB100
.
EXPTB150  MATCH     WARDCODE,BKREWARD          * Check Expected ward - Booking
          IF        @EQUAL
            MOVE      BKREURNO,URNUMBER        * Populate U/R
            MOVE      DBKREBOO,ADMISSNO        * Populate Visit
            MOVE      BKREWARD,PMVXPOWD        
            MOVE      BKREEBED,PMVXPOBD 
            MOVE      BKREEDAT,ADATE       
            MOVE      DBKREELO,ASTAY
            MOVE      FOUR,EXPTTYPE            * Booking
            CALL      EXPRA000                 * Display row
          ENDIF
          GOTO      EXPTB100
.
. Calculate Preadmissions for Ward for Today
. Once Booking Tables Completed
.
EXPTB500  PACK      KEY16,CURRDATE,SP70
          CALL      RDSMISS3
EXPTB600  CALL      RDKMISS3
          BRANCH    OVRCD,EXPTB999
          MATCH     ADATE,CURRDATE                   * Exclude non-today
          GOTO      EXPTB999 IF NOT EQUAL
.
          COMPARE   ONE,ASTAT                        * Exclude non-Preadmiss
          GOTO      EXPTB600 IF NOT EQUAL
.
EXPTB610  MATCH     WARDCODE,PTMIXWRD                * Check Expected Ward
          GOTO      EXPTB600 IF NOT EQUAL
.
. Check Post Op ward
.
EXPTB620  PACK      KEY8,DAADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,EXPTB680
.
          MATCH     SP70,PMVXPOWD              * Postop Ward Blank      
          GOTO      EXPTB680 IF EQUAL
.
          MATCH     PMVXPOWD,PTMIXWRD          * Exclude Same Ward
          IF        !@EQUAL
            MOVE      AURNO,URNUMBER           * Populate U/R
            MOVE      DAADMNO,ADMISSNO         * Populate Visit
            MOVE      SIX,EXPTTYPE             * Exp Post Op
            CALL      EXPRA000                 * Display row
            GOTO      EXPTB600
          ELSE
            GOTO      EXPTB600
          ENDIF
.
EXPTB680  MOVE      AURNO,URNUMBER             * Populate U/R
          MOVE      DAADMNO,ADMISSNO           * Populate Visit
          MOVE      PTMIXWRD,PMVXPOWD
          MOVE      PTMIEBED,PMVXPOBD
          MOVE      FIVE,EXPTTYPE               * Exp Post Op
          CALL      EXPRA000                   * Display row
          GOTO      EXPTB600
.
EXPTB999  RETURN
.
.------------------------------------------------------------------------------
. Setup bed reueqts update link
.------------------------------------------------------------------------------
BREQLK00  UNPACK    PMBRREQD,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          CLEAR     HTMLLINK
          APPEND    "<img src=../images/EditIcon.gif",HTMLLINK
          APPEND    " class=ListIcon onclick='",HTMLLINK
          APPEND    "UpdateRequest(",HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    ADMISSNO,HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    ",",HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    DISPDATE,HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    ",",HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    PMBRREQT,HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    ",",HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    URNUMBER,HTMLLINK
          APPEND    QUOTE,HTMLLINK
          APPEND    ")'>",HTMLLINK
          RESET     HTMLLINK
          STRIP     HTMLLINK
.
BREQLK99  RETURN
.
+
.------------------------------------------------------------------------------
. Show expected post op patients and bed requests for the map view
.------------------------------------------------------------------------------
MEXP0000  MATCH     SP70,WARDCODE           * Exit if no ward code
          GOTO      MEXP9999 IF EQUAL
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          PACK      KEY6,WARDCODE,SP70
          CALL      RDWARD1
          BRANCH    OVRCD,MEXP9999
.
          PACK      KEY9,TWO,SP70
          CALL      RDSMISS2
MEXP1000  CALL      RDKMISS2                * Check admissions for post op ward
          BRANCH    OVRCD,MEXP5000
.
          COMPARE   TWO,ASTAT               * Admitted only
          GOTO      MEXP5000 IF NOT EQUAL
.
          MATCH     AWARD,WARDCODE          * Already admitted to this ward
          GOTO      MEXP1000 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDVISA1                 * Read visit
          BRANCH    OVRCD,MEXP1000
.
          MOVE      ONE,EXPTTYPE            * Admission
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMVX11                * read visit extn
          BRANCH    OVRCD,MEXP1000
.
          MATCH     PMVXPOWD,WARDCODE       * Correct post op ward
          GOTO      MEXP2000 IF EQUAL
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDBKRX11                * read booking extn
          BRANCH    OVRCD,MEXP1000
.
          MATCH     BKRXPOWD,WARDCODE       * Correct post op ward
          GOTO      MEXP1000 IF NOT EQUAL
.
          MOVE      THREE,EXPTTYPE            * Admission/booking
.
MEXP2000  MOVE      "2",KEY1
          PACK      KEY31,DAADMNO,KEY1,CURRDATE,Z70
          CALL      RSOPDEA2
          CALL      RPOPDEA2                     * read Theatre Booking
          BRANCH    OVRCD,MEXP1000
.
          MATCH     OPDAADMN,DAADMNO
          GOTO      MEXP1000 IF NOT EQUAL
.
          COMPARE   TWO,OPDASTAT                 * Theatre status admitted
          GOTO      MEXP1000 IF NOT EQUAL
.
          MATCH     CURRDATE,OPDADATE            * Skip if not theatre today
          GOTO      MEXP1000 IF NOT EQUAL
.
          MOVE      AURNO,URNUMBER          * Populate U/R
          MOVE      AADMNO,ADMISSNO         * Populate Visit
.
          CALL      MEXR0000                * Display row
          GOTO      MEXP1000
.
MEXP5000  PACK      KEY24,CURRDATE,SP70
          CALL      RSPMBRQ3                * Todays bed requests
MEXP6000  CALL      RKPMBRQ3
          BRANCH    OVRCD,MEXP9999
.
          MATCH     CURRDATE,PMBRREQD
          GOTO      MEXP9999 IF NOT EQUAL
.
          MATCH     "1",PMBRRSTA              * Requested
          IF        !@EQUAL
            MATCH     "2",PMBRRSTA            * Allocated
            GOTO      MEXP6000 IF NOT EQUAL
          ENDIF
.
          MATCH     PMBREWRD,WARDCODE         * Expected ward
          GOTO      MEXP6000 IF NOT EQUAL
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDMISS1                   * Read admission
          BRANCH    OVRCD,MEXP6000
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDVISA1                   * Read visit
          BRANCH    OVRCD,MEXP6000
.
          PACK      KEY8,PMBRVISN,SP70
          CALL      RDPMVX11                  * Read visit extn
          BRANCH    OVRCD,MEXP6000
.
          MOVE      PVIURNO,URNUMBER        * Populate U/R
          MOVE      PVIBILL,ADMISSNO        * Populate Visit
.
          MOVE      TWO,EXPTTYPE            * Bed Request
          CALL      MEXR0000                * Display row
          GOTO      MEXP6000
.
MEXP9999  RETURN
+
.------------------------------------------------------------------------------
. Show expected post op patient and bed request rows for map view
.------------------------------------------------------------------------------
MEXR0000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,MEXR9999
.
          PACK      KEY8,URNUMBER,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,MEXR9999
.
          CALL      PATINT00
.
          IF        PCEASE=1
            MOVE      PDECDTE,AGEDATE            * Date of Death
          ELSE
            PACK      AGEDATE,CCC,CYY,CMM,CDD    * Today's date
          ENDIF
          REP       " 0",AGEDATE
          CALL      CALCAGE
          CALL      PATLN000

          CALL      PATFLD00                * Use standard Patient Folder sub
          MOVE      KEY3,FOLDERSF           * and store suffix
.
          CALL      GETAN000                * get Anaesthetist
          MOVE      SP70,CURSTATS
          MOVE      SP70,CURSTATB
          MOVE      SP70,CURSTATC
.
          IF        ANATFLAG = 1
            CALL      PATSTS00                * get theatre status
          ENDIF
.
          UNPACK    PVIDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          PACK      DISPDATE,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.
          MOVE      SP70,DOCFNAME
          PACK      KEY6,PVIDOCT,SP70
          CALL      RDDOCT1
          IF        OVRCD=0
            MOVE      DTITL,FMTTITLE
            MOVE      DGNAME,FMTGNAME
            MOVE      DSNAME,FMTSNAME
            CALL      DOCNM000
            PACK      SDOCFNAM,DOCFNAME
          ENDIF
.
          MOVE      SP70,POSTWBED
          IF        EXPTTYPE=2
            MOVE      PMBREWRD,PMVXPOWD
            MOVE      PMBREBED,PMVXPOBD
          ENDIF
.
          IF        EXPTTYPE=3
            MOVE      BKRXPOWD,PMVXPOWD       * Use post OP ward/bed from
            MOVE      BKRXPOBD,PMVXPOBD       * booking
            MOVE      ONE,EXPTTYPE
          ENDIF
.
          MATCH     SP70,PMVXPOWD
          IF        !@EQUAL
            PACK      KEY6,PMVXPOWD,PMVXPOBD,SP70
            CALL      RDWARD1
            BRANCH    OVRCD,MEXR2000
.
            CLEAR     POSTWBED
.
            APPEND    PMVXPOWD,POSTWBED
.
            MATCH     SP70,PMVXPOBD
            IF        !@EQUAL
              APPEND    FRBRACK,POSTWBED
              APPEND    PMVXPOBD,POSTWBED
            ENDIF
.
            RESET     POSTWBED
          ENDIF
.
          MOVE      "DC",CATEGORY
          MOVE      ADIET,CODE
          CALL      GETCOD00
          MOVE      TDESC,DIETDESC
.
          CALL      GETCON00               * Get Patient Condition Details
          UNPACK    IMGSRC,KEY10,CONDINDC
.
MEXR2000  WRITE     HTMLFILE;*+,"t.AddExpected(#"",URNUMBER,"#",":        * 0
                             "#"",ADMISSNO,"#",":
                             "#"",FORMATNM,"#",":
                             "#"",PSEX,"#",":
                             "#"";
          CALL      WRTAGE00
.
          WRITE     HTMLFILE;*+,"#",":
                             "#"",FOLDERSF,"#",":                         * 5 
                             "#"",PTMXSIN1,PTMXSIN2,PTMXSIN3,PTMXSIN4:
                                  PTMXSIN5,"#",":
                             "#"",LPCONDD,"#",":
                             "#"",CONDINDC,"#",":
                             "#"",CONDESC,"#",":
                             "#"",LPCDATE,LPCTIME,"#",":                  * 10
                             "#"",DIETDESC,"#",":
                             "#"",POSTWBED,"#",":
                             "#"",PMVXPOWD,"#",":
                             "#"",PMVXPOBD,"#",":
                             "#"",DISPDATE,"#",":                         * 15
                             "#"",ADOCTA,"#",":
                             "#"",EXPTTYPE,"#",":
                             "#"",ASTAY,"#",":
                             "#"",AWARD,"#",":
                             "#"",DOCFNAME,"#",":                         * 20
                             "#"",CURSTATS,"#",":                         
                             "#"",CURSTATC,"#");"
.
MEXR9999  RETURN
+
.------------------------------------------------------------
. Eclipse IMC Remittance Advice Enquiries
.------------------------------------------------------------
ECRM0000  MATCH     "1",PTCNUIMC
          GOTO      ECRM9300 IF NOT EQUAL
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECRM5000 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      ECRM4000 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      ECRM3000 IF EQUAL
.
          MATCH     "L",UPDATETY
          GOTO      ECRM2000 IF EQUAL
.
          MATCH     "P",UPDATETY
          GOTO      ECRM1000 IF EQUAL
.
          GOTO      ECRM9000
.
ECRM1000  MOVE      "1",DIM1C
          CALL      PRNRMM00
          MOVE      "Print Remittance Report scheduled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM2000  CALL      CREA0000
          CALL      RPAM0000
          CALL      KILL0000
          GOTO      ECRM9999
.
ECRM3000  PACK      KEY61,HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO,SP70
          CALL      RDPMERH1
          BRANCH    OVRCD,ECRM9100
.
          PACK      KEY82,FUNDTRID,ECREADVC,ECREPTNO,ECRETRID,SP70
          CALL      RDPMERD1
          BRANCH    OVRCD,ECRM9200
.
          GOTO      ECRM6000
.
ECRM4000  PACK      KEY61,HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO,SP70
          CALL      RDPMERH1
          BRANCH    OVRCD,ECRM9100
.
          GOTO      ECRM6000
.
ECRM5000  MOVE      TEMPLATE,KEY3
          RJUSTIFY  KEY3
          REP       " 0",KEY3
.
          IF        DEFTALLH=0 & IBCNMHOS=1
            MATCH     SP70,FILTHOSP
            IF        @EQUAL
              MOVE      WBSEHOSP,FILTHOSP   * Default hospital filter to users
              MOVE      ONE,DEFTALLH        * logged in hospital if this is the
            ENDIF                           * first time opening the page from
          ENDIF                             * a menu
.
          MATCH     "001",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased IMC Remittance Advice Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "005",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Released IMC Remittance Advice Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "007",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased IMC Remittance Advice Enquiry Only",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
ECRM6000  CALL      WEBHED00
          BRANCH    EXIT,ECRM9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM9100  MOVE      "Can't find ERA Header details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM9200  MOVE      "Can't find ERA Payment details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM9300  MOVE      "Not using Eclipse IMC Module.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRM9999
.
ECRM9999  RETURN
.
.--------------------------------------------------------------------------
.*                             PRNRMM00                                   *
.*               Schedule Eclipse IMC Remittance Report (IBAPRI11)            *
.--------------------------------------------------------------------------
PRNRMM00  MOVE      "IBAPRI11",SCHDPGID
          MOVE      "Eclipse IMC Remittance Report",SCHDDESC
          CALL      IBACLOCK
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      ONE,SCHDCOPY
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAPRI11",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          UNPACK    REMITKEY,KEY3,KEY24,KEY30,KEY4
          MOVE      KEY3,KEYSTARR[1]        * key for pmserhaf
          MOVE      KEY24,KEYSTARR[2]
          MOVE      KEY30,KEYSTARR[3]
          MOVE      KEY4,KEYSTARR[4]
          MOVE      USERID,KEYSTARR[5]
          MOVE      DIM1C,KEYSTARR[6]
          MOVE      SIX,KEYSTCNT            * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
PRNRMM99  RETURN
+
.------------------------------------------------------------
. Eclipse IMC Remittance Advice Enquiry tags
.------------------------------------------------------------
ERLM0000  BRANCH    FLDITMNO,ERLM0100,ERLM0200,ERLM0300,ERLM0400,ERLM0500:
                             ERLM0600,ERLM0700,ERLM0800,ERLM0900,ERLM1000:
                             ERLM1100,ERLM1200,ERLM1300,ERLM1400,ERLM1500:
                             ERLM1600,ERLM1700,ERLM1800,ERLM1900,ERLM2000:
                             ERLM2100,ERLM2200,ERLM2300,ERLM2400,ERLM2500:
                             ERLM2600,ERLM2700,ERLM2800,ERLM2900,ERLM3000:
                             ERLM3100,ERLM3200,ERLM3300,ERLM3400,ERLM3500
.
          GOTO      ERLM9999
.
ERLM0100  UNPACK    DIM127,D1,UNRELREM,DIM127
          UNPACK    DIM127,D1,UNRELINQ,DIM127
          UNPACK    DIM127,D1,ERASTATS,DIM127
.
          CALL      ERTH0000           * Set hospital filter and call ERTM0000
          GOTO      ERLM9999
.
ERLM0200  CALL      ERDM0000
          GOTO      ERLM9999
.
ERLM0300  WRITE     HTMLFILE;PMEHRADV;
          GOTO      ECFL9999
.
ERLM0400  WRITE     HTMLFILE;PMEHPNUM;
          GOTO      ECFL9999
.
ERLM0500  WRITE     HTMLFILE;PMEHPTOT;
          GOTO      ECFL9999
.
ERLM0600  MATCH     SP70,PMEHDATE
          GOTO      ERLM9999 IF EQUAL
          UNPACK    PMEHDATE,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLM9999
.
ERLM0700  WRITE     HTMLFILE;PMEHNAME;
          GOTO      ERLM9999
.
ERLM0800  WRITE     HTMLFILE;PMEHPLID;
          GOTO      ERLM9999
.
ERLM0900  WRITE     HTMLFILE;PMEHBNUM;
          GOTO      ERLM9999
.
ERLM1000  WRITE     HTMLFILE;PMEHBNAM;
          GOTO      ERLM9999
.
ERLM1100  WRITE     HTMLFILE;PMEHBBSB;
          GOTO      ERLM9999
.
ERLM1200  WRITE     HTMLFILE;PMEHPREF;
          GOTO      ERLM9999
.
ERLM1300  UNPACK    PMEHDAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLM9999
.
ERLM1400  WRITE     HTMLFILE;PMEHFTID;
          GOTO      ERLM9999
.
ERLM1500  MATCH     "0",PMEHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "1",PMEHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Partial";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "2",PMEHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "3",PMEHSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Processing";
            GOTO      ERLM9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLM9999
.
ERLM1600  CALL      GCMM0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLM9999
.
ERLM1700  CALL      GCMD0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLM9999
.
ERLM1800  WRITE     HTMLFILE;PMEDRADV;
          GOTO      ERLM9999
.
ERLM1900  WRITE     HTMLFILE;PMEDPNUM;
          GOTO      ERLM9999
.
ERLM2000  WRITE     HTMLFILE;PMEDTRID;
          GOTO      ERLM9999
.
ERLM2100  WRITE     HTMLFILE;PMEDARID;
          GOTO      ERLM9999
.
ERLM2200  UNPACK    PMEDBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLM9999
.
ERLM2300  WRITE     HTMLFILE;PMEDCCOD;
          GOTO      ERLM9999
.
ERLM2400  MATCH     SP70,PMEDLDAT
          GOTO      ERLM9999 IF EQUAL
          UNPACK    PMEDLDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLM9999
.
ERLM2500  WRITE     HTMLFILE;PMEDPARI;
          GOTO      ERLM9999
.
ERLM2600  WRITE     HTMLFILE;PMEDPTID;
          GOTO      ERLM9999
.
ERLM2700  MATCH     "0",PMEDSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "1",PMEDSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "2",PMEDSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLM9999
          ENDIF
.
          MATCH     "3",PMEDSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense";
            GOTO      ERLM9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLM9999
.
ERLM2800  UNPACK    DIM127,D1,DIM1,DIM127
          MOVE      ZERO,FORM1
          MOVE      DIM1,FORM1
          BRANCH    FORM1,ERLM2810
.
          WRITE     HTMLFILE;PARTCODE;
          GOTO      ERLM9999
.
ERLM2810  PACK      KEY3,PARTCODE,SP70
          CALL      RDPTPAR1
          BRANCH    OVRCD,ERLM9999
.
          WRITE     HTMLFILE;PTPRNAME;
          GOTO      ERLM9999
.
ERLM2900  WRITE     HTMLFILE;HOSPCODE,FUNDTRID,ECREADVC,ECREPTNO;
          GOTO      ERLM9999
.
ERLM3000  CALL      SELP0000
          GOTO      ERLM9999
.
ERLM3100  CALL      PRVR0000
          GOTO      ERLM9999
.
ERLM3200  CALL      NXTR0000
          GOTO      ERLM9999
.
ERLM3300  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ERLM9999
.
ERLM3400  WRITE     HTMLFILE;EXDTBLNK;
          GOTO      ERLM9999
.
ERLM3500  CALL      HSPSEL00
          GOTO      ECRL9999
.
ERLM9999  RETURN
+
.***************************************************************************
.*                             ERTM0000                                    *
.*   Display all the remittance batches received from a given participant  *
.***************************************************************************
ERTM0000  MATCH     "1",PTCNUIMC
          GOTO      ERTM9999 IF NOT EQUAL
.
          MOVE      ZERO,LOOPCNTR
.
          PACK      KEY70,FILTHOSP,ERASTATS,Z70
          CALL      RSPMERH3
ERTM1000  CALL      RPPMERH3
          BRANCH    OVRCD,ERTM9999               * end of file
.
          MATCH     FILTHOSP,PMEHHOSP
          GOTO      ERTM9999 IF NOT EQUAL
.
          MATCH     ERASTATS,PMEHSTAT
          GOTO      ERTM9999 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
           ADD       ONE,LOOPCNTR
.
           IF        (LOOPCNTR = 500)
             WRITE     HTMLFILE;"// ",LOOPCNTR
             MOVE      ZERO,LOOPCNTR
           ENDIF
.
. -----------------------------------------------------
.
          PACK      KEY82,PMEHFTID,PMEHRADV,PMEHPNUM,SP70
          CALL      RSPMERD1
          CALL      RKPMERD1
          BRANCH    OVRCD,ERTM1000
.
          MATCH     PMEHFTID,PMEDFTID
          GOTO      ERTM1000 IF NOT EQUAL
.
          MATCH     PMEHRADV,PMEDRADV
          GOTO      ERTM1000 IF NOT EQUAL
.
          MATCH     PMEHPNUM,PMEDPNUM
          GOTO      ERTM1000 IF NOT EQUAL
.
.         A payment for the ERA has been found, so now if it belongs
.         to pmsectaf
.
          PACK      KEY40,PMEDTRID,SP30,SP10
          CALL      RSPRECT6
          CALL      RKPRECT6
          BRANCH    OVRCD,ERTM1000
.
          MATCH     PMEDTRID,PRECTRID            * if its not in pmsectaf
          GOTO      ERTM1000 IF NOT EQUAL        * then its probably an imc
.                                                * claim
.
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
            MATCH     "2",PMEHSTAT
            GOTO      ERTM1000 IF NOT EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,PMEHDATE
              GOTO      ERTM1000 IF LESS
.
              MATCH     PMEHDATE,LASTDATE
              GOTO      ERTM1000 IF LESS
            ENDIF
.
          ELSE
            MATCH     "2",PMEHSTAT
            GOTO      ERTM1000 IF EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,PMEHDATE
              GOTO      ERTM1000 IF LESS
.
              MATCH     PMEHDATE,LASTDATE
              GOTO      ERTM1000 IF LESS
            ENDIF
.
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,PMEHDATE
          IF        !@EQUAL & !@EOS
            UNPACK    PMEHDATE,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",PMEHSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",PMEHSTAT
          IF        @EQUAL
            MOVE      "Partial  ",DIM9
          ENDIF
.
          MATCH     "2",PMEHSTAT
          IF        @EQUAL
            MOVE      "Released ",DIM9
          ENDIF
.
          MATCH     "3",PMEHSTAT
          IF        @EQUAL
            MOVE      "Processng ",DIM9
          ENDIF
.
          UNPACK    PMEHDAMT,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
.
          CALL      GCMM0000
.
          REP       " +",PMEHFTID
          REP       " +",PMEHRADV
          REP       " +",PMEHPNUM
          REP       " +",PMEHHOSP
.
          MOVE      ZERO,LOOPCNTR
.
          IF        IBCNMHOS=1
.
            MATCH     "+++",PMEHHOSP
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"t.addRow(#"",DIM11,"#",";
            ELSE
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
      PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','002');> ",DIM11," ",PMEHNAME,"#",";
            ENDIF
.
          ELSE
.
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
      PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','002');> ",DIM11," ",PMEHNAME,"#",";
          ENDIF
.
          REP       "+ ",PMEHFTID
          REP       "+ ",PMEHRADV
          REP       "+ ",PMEHPNUM
          REP       "+ ",PMEHHOSP
.
          WRITE     HTMLFILE;"#"",PMEHPNUM," of ",PMEHPTOT,"#",":
                             "#"",DIM9,"#",":
                             "#"",FORM7P2C,"#",":
                             "#"",CLAMTOTL,"#",";
.
          REP       " +",PMEHFTID
          REP       " +",PMEHRADV
          REP       " +",PMEHPNUM
          REP       " +",PMEHHOSP
          MOVE      PMEHPREF,DIM30
          MOVE      PMEHDAMT,DIM9
          REP       " +",DIM30
          REP       " +",DIM9
.
          MOVE      FORM7P2C,DIM10A
          MOVE      CLAMTOTL,DIM10B
          REP       " +",DIM10A
          REP       " +",DIM10B
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",PMEHHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",PMEHPREF;
              ELSE
            WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
              PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                               PMEHPREF;
              ENDIF
.
            ELSE
.
            WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
              PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                               PMEHPREF;
            ENDIF
          ELSE
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",PMEHHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",PMEHPREF;
              ELSE
                MATCH     "3",PMEHSTAT
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                            PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                            PMEHPREF,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
                ELSE
                  MATCH     "1",UNRELINQ
                  IF        @EQUAL
                    WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                              " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                              PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                              PMEHPREF;
                  ELSE
                    WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                              " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                              PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                              PMEHPREF,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                  ENDIF
                ENDIF
              ENDIF
.
            ELSE
              MATCH     "3",PMEHSTAT
              IF        @EQUAL
                WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                          " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                          PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                          PMEHPREF,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
              ELSE
                MATCH     "1",UNRELINQ
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                            PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                            PMEHPREF;
                ELSE
                  WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
                            " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
                            PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','003');>&nbsp;":
                            PMEHPREF,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",PMEHFTID,"','",PMEHRADV,"','",PMEHPNUM,"','",PMEHHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",PMEHNAME;
          MOVE      PMEHRADV,DIM30
          REP       "+ ",PMEHRADV
          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",PMEHDATE,"','":
      PMEHFTID,"','",DIM30,"','",PMEHPNUM,"','",PMEHHOSP,"','002');> ",PMEHRADV;
.
          REP       "+ ",PMEHHOSP
.
          WRITE     HTMLFILE;"#",#"",PMEHFTID;
          WRITE     HTMLFILE;"#",#"",DIM11;
.
          MOVE      SP70,DIM50
          MATCH     SP70,PMEHHOSP
          IF        !@EQUAL & !@EOS
            PACK      KEY3,PMEHHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,DIM50
            ELSE
              MOVE      PMEHHOSP,DIM50
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",DIM50;
.
          WRITE     HTMLFILE;"#");"
.
          REP       "+ ",PMEHFTID
          REP       "+ ",PMEHRADV
          REP       "+ ",PMEHPNUM
.
          GOTO      ERTM1000
.
ERTM9999  RETURN
+
.*****************************************************************************
.*                            GCMM0000                                       *
.*              Get the claimed amount total for the ERA                     *
.* Requires:  Valid read on pmserhaf record (ERA Header)                     *
.* Returns:   CLAMTOTL - total claimed amount for the ERA batch              *
.*****************************************************************************
.
GCMM0000  MOVE      ZERO,CLAMTOTL                * initialise total amount
.
          MATCH     "1",PTCNUIMC
          GOTO      GCMM9999 IF NOT EQUAL
.
.         Loop through pmserdaf looking for payments from the selected ERA
.
          PACK      KEY82,PMEHFTID,PMEHRADV,PMEHPNUM,SP30,SP30,SP1
          CALL      RSPMERD1                     * position in file
GCMM1000  CALL      RKPMERD1                     * read next record
          BRANCH    OVRCD,GCMM9999               * end of file
.
          MATCH     PMEHFTID,PMEDFTID            * same participant still ?
          GOTO      GCMM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     PMEHRADV,PMEDRADV            * same remittance advice still?
          GOTO      GCMM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     PMEHPNUM,PMEDPNUM            * same part number still ?
          GOTO      GCMM9999 IF NOT EQUAL        * no - finished ERA
.
.         A payment for the ERA has been found, so now get the claimed amount
.         from priectaf
.
          PACK      KEY40,PMEDTRID,SP30,SP10
          CALL      RSPRECT6                     * position on trans. id
          CALL      RKPRECT6                     * read next record
          BRANCH    OVRCD,GCMM1000               * eof - not found
.
          MATCH     PMEDTRID,PRECTRID            * same transaction id still ?
          GOTO      GCMM1000 IF NOT EQUAL        * no - not found
.
          ADD       PRECAMTC,CLAMTOTL            * update ERA claim total
          GOTO      GCMM1000                     * get next payment
.
GCMM9999  RETURN
+
.------------------------------------------------------------
. Eclipse IMC Remittance Payment Details
.------------------------------------------------------------
ERDM0000  MATCH     "1",PTCNUIMC
          GOTO      ERDM9999 IF NOT EQUAL
.
          CALL      ECRDH000
.
          PACK      KEY82,PMEHFTID,PMEHRADV,PMEHPNUM,SP70
          CALL      RSPMERD1
ERDM1000  CALL      RKPMERD1
          BRANCH    OVRCD,ERDM9999
.
          MATCH     PMEHFTID,PMEDFTID
          GOTO      ERDM9999 IF NOT EQUAL
.
          MATCH     PMEHRADV,PMEDRADV
          GOTO      ERDM9999 IF NOT EQUAL
.
          MATCH     PMEHPNUM,PMEDPNUM
          GOTO      ERDM9999 IF NOT EQUAL
.
          MOVE      SP70,DIFCINDC
          IF        IBCNMHOS=1
            PACK      KEY40,PMEDTRID,SP70
            CALL      RSPRECT6
            CALL      RKPRECT6
            BRANCH    OVRCD,ERDM5000
.
            MATCH     PMEDTRID,PRECTRID
            GOTO      ERDM5000 IF NOT EQUAL
.
            MATCH     SP70,PRECHOSP
            IF        !@EQUAL & !@EOS
              MATCH     PRECHOSP,WBSEHOSP
              IF        !@EQUAL
                PACK      KEY3,PRECHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSLOCN,SAVELOCN
                ELSE
                  MOVE      SP70,SAVELOCN
                ENDIF
.
                PACK      KEY3,WBSEHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SAVELOCN,PTHSLOCN
                  GOTO      ERDM1000 IF NOT EQUAL

                  MOVE      "1",DIFCINDC
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
ERDM5000  CALL      ERDMR000
.
          GOTO      ERDM1000
.
ERDM9999  RETURN
+
.------------------------------------------------------------
. Eclipse IMC Payment Details (Detail Row)
.------------------------------------------------------------
ERDMR000  REP       " +",HOSPCODE
          REP       " +",PMEDFTID
          REP       " +",PMEDRADV
          REP       " +",PMEDPNUM
          REP       " +",PMEDTRID
          WRITE     HTMLFILE;"<tr><td><img src='../images/CommentIcon.gif'":
                             " class=ListIcon onclick=displayRemD('":
  HOSPCODE,"','",PMEDFTID,"','",PMEDRADV,"','",PMEDPNUM,"','",PMEDTRID,"','D');>&nbsp;";
          REP       "+ ",HOSPCODE
          REP       "+ ",PMEDFTID
          REP       "+ ",PMEDRADV
          REP       "+ ",PMEDPNUM
          REP       "+ ",PMEDTRID
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=red>";
          ENDIF
.
          WRITE     HTMLFILE;PMEDARID;
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"</font>";
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
          UNPACK    PMEDBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",FORM7P2C,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
          ENDIF
.
          MOVE      ZERO,CLAMTOTL
          PACK      KEY40,PMEDTRID,SP30,SP10
          CALL      RSPRECT6                     * position on trans. id
          CALL      RKPRECT6                     * read next record
          BRANCH    OVRCD,ERDMR100                * eof - not found
.
          MATCH     PMEDTRID,PRECTRID            * same transaction id still ?
          GOTO      ERDMR100 IF NOT EQUAL        * no - not found
.
          MOVE      PRECAMTC,CLAMTOTL            * update ERA claim total
.
ERDMR100  MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",CLAMTOTL,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",PRECBATN,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CLAMTOTL,"</td>";
.
            WRITE     HTMLFILE;"<td>",PRECBATN,"</td>";
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",PMEDSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",PMEDSTAT
          IF        @EQUAL
            MOVE      "Locked   ",DIM9
          ENDIF
.
          MATCH     "2",PMEDSTAT
          IF        @EQUAL
            MOVE      "Released",DIM9
          ENDIF
.
          MATCH     "3",PMEDSTAT
          IF        @EQUAL
            MOVE      "Released*",DIM9
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM9,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",PMEDCCOD,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM9,"</td>";
.
            WRITE     HTMLFILE;"<td>",PMEDCCOD,"</td>";
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,PMEDLDAT
          IF        !@EQUAL & !@EOS
            UNPACK    PMEDLDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM11,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",PMEDTRID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
            WRITE     HTMLFILE;"<td>",PMEDTRID,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
ERDMR999  RETURN
+
.------------------------------------------------------------
. Get claim amount for a specific transactiom id
.------------------------------------------------------------
GCMD0000  MOVE      ZERO,CLAMTOTL
.
          MATCH     "1",PTCNUIMC
          GOTO      GCMD9999 IF NOT EQUAL
.
          PACK      KEY40,PMEDTRID,SP30,SP10
          CALL      RSPRECT6                     * position on trans. id
          CALL      RKPRECT6                     * read next record
          BRANCH    OVRCD,GCMD9999                * eof - not found
.
          MATCH     PMEDTRID,PRECTRID            * same transaction id still ?
          GOTO      GCMD9999 IF NOT EQUAL        * no - not found
.
          MOVE      PRECAMTC,CLAMTOTL            * update ERA claim total
.
GCMD9999  RETURN
+
.*****************************************************************************
.*                              RPAM0000           Called by: KEYA0000       *
.*           Release all payments for the selected ERA batch                 *
.*****************************************************************************
.
.         Initialise counters
.         ERDCOUNT - is the total number of pmserdaf records associated
.                    with the selected ERA batch.
.         PRLCOUNT - is the number of pmserdaf records associated with the
.                    selected ERA batch, which have previously been "released".
.         RELCOUNT - is the number of pmserdaf records associated with the
.                    selected ERA batch for which payments have been released
.                    in this session.
.
RPAM0000  CALL      CLER0000
          MOVE      SP3,SAVEPART
.
          MOVE      ZERO,EXIT
          MOVE      ZERO,ERDCOUNT
          MOVE      ZERO,PRLCOUNT
          MOVE      ZERO,RELCOUNT
.
.         Start releasing payments for the ERA
.
RPAM0500  REP       "+ ",FUNDTRID
          REP       "+ ",REMITADV
          REP       "+ ",PARTNUMB
          REP       "+ ",HOSPCODE
.
          PACK      KEY61,HOSPCODE,FUNDTRID,REMITADV,PARTNUMB,SP70
          CALL      RDPMERH1
          BRANCH    OVRCD,RPAM9960
.
          MATCH     "3",PMEHSTAT
          GOTO      RPAM9950 IF EQUAL
.
          MOVE      "3",PMEHSTAT
          CALL      UPPMERH1
.
          CALL      LTMM0000
.
.         Start releasing payments for the ERA
.
          MOVE      SP30,KEY27
          CALL      RSTEMP2                      * position in file
RPAM1000  CALL      RKTEMP2                      * read next record
          BRANCH    OVRCD,RPAM9000               * end of file
.
.         Read the pmserdaf record as the record status will need to be
.         updated later
.
          PACK      KEY82,PMEDFTID,PMEDRADV,PMEDPNUM,PMEDTRID
          CALL      RDPMERD1                     * record found ?
          BRANCH    OVRCD,RPAM1000               * no - shouldn't happen
.
          UNPACK    PMEDBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         IF        FORM7P2C = 0 | FORM7P2C < 0
          IF        FORM7P2C = 0
            ADD       ONE,RELCOUNT
            MOVE      TWO,PMEDSTAT                 * set as released
            CALL      UPPMERD1
            GOTO      RPAM1000
          ENDIF
.
.         A payment for the ERA has been found, so check if it needs releasing
.
.         ADD       ONE,ERDCOUNT                 * increment pmserdaf count
          MATCH     "2",PMEDSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAM1000                   * get next payment
          ENDIF
.
          MATCH     "3",PMEDSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAM1000                   * get next payment
          ENDIF
.
.         A claim requiring payment releasing has been found, so
.         get the corresponding priectaf record and check if same hospital
.
          MOVE      ZERO,ERASUSIN
          PACK      KEY40,PMEDTRID,SP70
          CALL      RSPRECT6                     * position on trans. id/invoice
          CALL      RKPRECT6                     * read next record
.         BRANCH    OVRCD,RPAM6000               * eof
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    PMEDARID,SERDIM50
            APPEND    " - priectaf record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAM6000
          ENDIF
.
          MATCH     PMEDTRID,PRECTRID            * same transaction id still ?
.         GOTO      RPAM6000 IF NOT EQUAL        * no
          IF        !@EQUAL
            CLEAR     SERDIM50
            APPEND    PMEDARID,SERDIM50
            APPEND    " - tran id not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAM6000
          ENDIF

.
          MOVE      SP70,SAVELOCN
          IF        IBCNMHOS=1
            MATCH     PMEHHOSP,PRECHOSP
            IF        !@EQUAL
              PACK      KEY3,PRECHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSLOCN,SAVELOCN
              ELSE
                  SUB       ONE,ERDCOUNT
                  GOTO      RPAM1000
              ENDIF
.
              PACK      KEY3,PMEHHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MATCH     SAVELOCN,PTHSLOCN
                IF        !@EQUAL
                  SUB       ONE,ERDCOUNT
                  GOTO      RPAM1000
                ENDIF
              ELSE
                  SUB       ONE,ERDCOUNT
                  GOTO      RPAM1000
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY8,PMEDARID,SP70
          RJUSTIFY  KEY8
          CALL      RDPRIN1
.         IF        OVRCD = 1
.           GOTO      RPAM6000
.         ENDIF
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    PMEDARID,SERDIM50
            APPEND    " - priinvof record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAM6000
          ENDIF

.
          MATCH     "1",PRINCNST
.         GOTO      RPAM6000 IF EQUAL
          IF        @EQUAL
            CLEAR     SERDIM50
            APPEND    PMEDARID,SERDIM50
            APPEND    "invoice is fully credited",SERDIM50
            RESET     SERDIM50
            GOTO      RPAM6000
          ENDIF

.
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAM1500  
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         PACK      KEY8,PMECINVN,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      PMECINVN,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAM8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         Now check the we can lock the invoice record
.
.         MOVE      PMECINVN,KEY8
.         CALL      RLPTINV1
.         IF        OVRCD = 1
..           MOVE      THREE,UNLKFLAG
..           CALL      UNLK0000                   * unlock any locked records
..           GOTO      RPAM8000
.           GOTO      RPAM6100
.         ELSE
.           IF        OVRCD = 2
.             MOVE      THREE,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAM8000
.           ENDIF
.         ENDIF
.
.         Check that we can lock the visit record
.
.         PACK      KEY8,PMECADMN,SP70
.         CALL      RLPTVIS1
.         IF        OVRCD = 1
.           MOVE      TWO,UNLKFLAG
.           CALL      UNLK0000                   * unlock any locked records
.           GOTO      RPAM8000
.         ELSE
.           IF        OVRCD = 2
.             MOVE      TWO,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAM8000
.           ENDIF
.         ENDIF
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
          MATCH     SAVEPART,PARTPANT            * same participant still ?
          IF        !@EQUAL
            CALL      ALLCRC00
.
            MOVE      PARTPANT,SAVEPART          * save new participant code
          ENDIF
.
.         Process the payment
.
          UNPACK    PMEDBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.        
          MATCH     "HIC",PMEHNAME
          IF        @EQUAL
            MOVE      FORM7P2C,PRECAMMP
            ASSIGN    (PRINMAMT-PRECAMMP),PRINMAMT
          ELSE
            MOVE      FORM7P2C,PRECAMFP
            ASSIGN    (PRINHAMT-PRECAMFP),PRINHAMT
          ENDIF
.
          CALL      IBACLOCK                     * get current date
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME
.
.         Check if the invoice now balances
.      
          MOVE      PRINITOT,FORM10P2             * Invoice amount +
          ADD       PRINPAMT,FORM10P2            * Patient payments +
          ADD       PRINHAMT,FORM10P2            * H.F payments +
          ADD       PRINOTHA,FORM10P2            * Other payments +
          ADD       PRINJAMT,FORM10P2            * Journals +
          ADD       PRINGSTJ,FORM10P2            * Journal GST = amt outstanding
.
.         MOVE      "99999999",PINVBLCD          * default to not balancing
.
.         COMPARE   ZERO,FORM10P2                * Does invoice balance ?
.         IF        @EQUAL
.           MOVE      CURRDATE,PINVBLCD          * yes - record balanced date
..          MOVE      TWO,PTDTAPAY               * set A/P flag - balanced
.         ELSE
..          MOVE      ZERO,PTDTAPAY              * set A/P flag - not balanced
.         ENDIF
          MOVE      FORM10P2,PRINPEND
.         CALL      UPINV1                       * update/unlock invoice record
.
.         PROC      FLAGDEBT
.
.         Create the patdtraf cash receipt record.
.              
          MOVE      PRECUNIQ,PRDTUNIQ            * load unique number
.
.         Get the next transaction number.  As we have already locked
.         the visit record, there should be no problem getting the
.         next transaction number.
.
.RPAM3000  MOVE      PMECADMN,KEY8                * get next transaction number
.          CALL      TRVISA1
.
.          PACK      KEY22,PMECADMN,PMECINVN,PVITRAN
.          CALL      RDADTRN1                     * patdtraf record on file ?
.          COMPARE   ZERO,OVRCD
.          GOTO      RPAM3000 IF EQUAL            * yes
.
.          MOVE      PVITRAN,TTRANSN1             * load transaction number
.          MOVE      ANSH,TTYPEDEB                * set to "patient" type of debt
.          MOVE      PMECHFND,TDCODE
.
.          ASSIGN    (PMECAMTP*SEQ),TPATAMTT
.          MOVE      TPATAMTT,TREBATE
.
.          MOVE      ZERO,TPATAMTG                * set $ amounts
.          MOVE      ZERO,TPATAMTH
.          MOVE      ZERO,TPATAMTI
.          MOVE      ZERO,TPATAMTP
.
.          MOVE      CCC,TFCENT                   * set payment date
.          MOVE      CYY,TFYEAR
.          MOVE      CMM,TFMONTH
.          MOVE      CDD,TFDAY
.
.          MOVE      ZERO,TTCENT                  * initialise accomm. to dates
.          MOVE      ZERO,TTYEAR
.          MOVE      ZERO,TTMONTH
.          MOVE      ZERO,TTDAY
.
.          PACK      TTYPE,ANSP,ANSY              * set for payment
.          MOVE      SP9,TITEMNO
.          MOVE      PMECINVN,TREF                * load invoice no.
.          MOVE      SIX,TPAYTYPE                 * direct deposit
.
          MOVE      HRECPT,PRDTRECN
.
.          IF        PMECEETP = 0
.            MOVE      "Unknown Health Fund           ",HFNAME
.            PACK      KEY14,PMECHFND,ZERO4,SP20
.            CALL      RDFUND1                    * HF on file ?
.            MOVE      HFNAME,TDDESC              * load HF description
.          ELSE
.            MOVE      "Unknown Claim Code  ",TDESC
.            PACK      KEY5,ANSC,ANSL,PINVCLM
.            CALL      RDCODE1
.            MOVE      TDESC,TDDESC               * load claim code description
.          ENDIF
.
.          MOVE      ONE,TINVPRT                  * invoice printed
.          MOVE      FIVE,TRECTYPE                * cash receipt
.          MOVE      ZERO,TNODAYS
.          MOVE      ZERO,TCLAIM
..         MOVE      ZERO,PTDTREBT
.          MOVE      SP6,TDOCTA
.          MOVE      ZERO,TSERVS
.          MOVE      SP6,TDOCTO
.          MOVE      SP2,TSESSION
.          MOVE      SP3,TMISGRP
.          MOVE      SP3,TDEPTYP
.          MOVE      SP3,TDWARD
.          MOVE      SP3,TCLMTYP
.          MOVE      SP3,TADMTYP
.          MOVE      PMECBATN,TBATCHN             * load batch number
.          MOVE      ZERO,TNINVS
.          MOVE      SP3,PTDTBTYP
.          MOVE      ZERO,PTDTLSPT
.          MOVE      ZERO,PTDTLSRB
.          MOVE      ZERO,PTDTDTYP
.          PACK      PTDTDES2,SP20,SP20
.          MOVE      ZERO,PTDTEPSD
.          MOVE      ZERO,PTDTCCU
..         MOVE      SP6,PTDTSURG
..         MOVE      SP1,PTDTDEPS
.
.          MOVE      CURRDATE,PTDTEFFD            * load payment date
.
.          MOVE      ZERO,PTDTGSTA
.          MOVE      SP6,PTDTGSTC
.          MOVE      ZERO,PTDTGSTM
.          MOVE      ZERO,PTDTADPT
.          MOVE      ZERO,PTDTADRB
.          MOVE      ZERO,PTDTGSTL
.          MOVE      SP70,PTDTTIME
.          MOVE      SP70,PTDTCRST
.          MOVE      SP70,PTDTUNIQ
.          MOVE      SP70,PTDTCNTR
.          MOVE      SP70,PTDTCPRC
.          MOVE      SP70,PTDTCONT
.          MOVE      SP70,PTDTSUNQ
.          MOVE      SP70,PTDTBTCH
..         MOVE      ANSN,PTDTSSAP
..         MOVE      ZERO,PTDTMVBR
.          MOVE      ZERO,PTDTEPSD
..         MOVE      SP1,PTDTMHDP
.          PACK      TSPARE,SP30,SP30
.
.          CALL      WRDTRN1                     * write patdtraf journal record
.
          ADD       ONE,RELCOUNT
.
. Write to rcpbnkaf
.        
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      PMEHHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
.
            MATCH     "HIC",PMEHNAME
            IF        @EQUAL
              MOVE      "3",RCBNTTYP
              MOVE      SP70,RCBNRCOD
            ELSE
              MOVE      "1",RCBNTTYP               * CAR 227986
              MOVE      PRECHFND,RCBNRCOD
            ENDIF
.
.           MOVE      PRECHFND,RCBNRCOD
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
              MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      PMEHHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
            MATCH     "HIC",PMEHNAME
            IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
            ELSE
              MOVE      PARTPANT,RCBDPAYD
            ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      PMEHNAME,RCBDDRAW
            MOVE      PMEHBNAM,RCBDBANK
            MOVE      PMEHBBSB,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      PMEHPREF,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf
.
RPAM3500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDTM00
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDTM00
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDTM00
              ELSE
                GOTO      RPAM3500
              ENDIF
            ENDIF
          ENDIF
.
.         Now "close" the current claim (providing that a processing report
.         has been received) and update the payment amount and
.         the payment date
.
          MOVE      PMEDARID,DIM20               * CAR 227986
          SQUEEZE   DIM20
.
          PACK      KEY56,PRECTRID,PARTPANT,DIM20,Z70
          CALL      RSPREAH2                     * position on trans. id
RPAM4000  CALL      RPPREAH2                     * read previous record
          BRANCH    OVRCD,RPAM4500               * eof - no proc. report
.
          MATCH     PRECTRID,PRAHFTID            * same claim trans. id ?
          GOTO      RPAM4500 IF NOT EQUAL        * no - no proc. report
.
          MATCH     PARTPANT,PRAHFBID            * same fund brand. id ?
          GOTO      RPAM4500 IF NOT EQUAL        * no - no proc. report
.
          MATCH     DIM20,PRAHARID               * same invoice number ?
          GOTO      RPAM4500 IF NOT EQUAL        * no - no proc. report
.
          MATCH     ANSA,PRAHCFAC                * assessment code "A" ?
          GOTO      RPAM4000 IF NOT EQUAL        * no - get next report
.
.         A processing report was found
.
          UNPACK    PMEDBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.......
          MOVE      PMEDARID,DIM8
          RJUSTIFY  DIM8
.
          PACK      KEY22,DIM8,SP70
          CALL      RSPRDT4
          CALL      RKPRDT4
          BRANCH    OVRCD,RPAM4100
.
          MATCH     DIM8,PRDTINVN
          GOTO      RPAM4100 IF NOT EQUAL
.
          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,RPAM4100
.
          MATCH     SP70,PRHRTACC
          GOTO      RPAM4100 IF EQUAL
.
          MOVE      "ta",CATEGORY
          MOVE      PRHRTACC,CODE
          CALL      GETCOD00     
.
          MATCH     "1",TCINDC1
          GOTO      RPAM4100 IF EQUAL
.
          MATCH     "2",TCINDC1
          GOTO      RPAM4100 IF EQUAL
.
          MATCH     "7",TCINDC1
          GOTO      RPAM4150 IF EQUAL
.
          MATCH     "6",TCINDC1
          IF        @EQUAL
            MATCH     "HIC",PMEHNAME
            IF        @EQUAL          
              MOVE      FORM7P2C,PRECAMMP
              COMPARE   ZERO,PRECAMFP
              GOTO      RPAM4300 IF EQUAL
              GOTO      RPAM4200
            ELSE
              MOVE      FORM7P2C,PRECAMFP
              COMPARE   ZERO,PRECAMMP
              GOTO      RPAM4300 IF EQUAL
              GOTO      RPAM4200
            ENDIF
          ENDIF
......
RPAM4100  MOVE      FORM7P2C,PRECAMFP
          GOTO      RPAM4200
.
RPAM4150  MOVE      FORM7P2C,PRECAMMP
          GOTO      RPAM4200
.
RPAM4200  MOVE      TEN9,PRECFLAG                * set status to closed
.
RPAM4300  PACK      PRECSTAT,SP1,TWO             * set closed with payment
          MOVE      PMEDLDAT,PRECPDAT            * set payment date 
.
          GOTO      RPAM4600
.
RPAM4500  UNPACK    PMEDBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.....
          MOVE      PMEDARID,DIM8
          RJUSTIFY  DIM8
.
          PACK      KEY22,DIM8,SP70
          CALL      RSPRDT4
          CALL      RKPRDT4
          BRANCH    OVRCD,RPAM4550
.
          MATCH     DIM8,PRDTINVN
          GOTO      RPAM4550 IF NOT EQUAL
.
          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
          CALL      RDPRHR1
          BRANCH    OVRCD,RPAM4550
.
          MATCH     SP70,PRHRTACC
          GOTO      RPAM4550 IF EQUAL
.
          MATCH     "1",TCINDC1
          GOTO      RPAM4550 IF EQUAL
.
          MATCH     "2",TCINDC1
          GOTO      RPAM4550 IF EQUAL
.
          MATCH     "7",TCINDC1
          GOTO      RPAM4560 IF EQUAL
.
          MATCH     "6",TCINDC1
          IF        @EQUAL
            MATCH     "HIC",PMEHNAME
            IF        @EQUAL
              MOVE      FORM7P2C,PRECAMMP
.             COMPARE   ZERO,PRECAMFP
.             GOTO      RPAM4600 IF EQUAL
              GOTO      RPAM4570
            ELSE
              MOVE      FORM7P2C,PRECAMFP
.             COMPARE   ZERO,PRECAMMP
.             GOTO      RPAM4600 IF EQUAL
              GOTO      RPAM4570
            ENDIF
          ENDIF
.
RPAM4550  MOVE      FORM7P2C,PRECAMFP
          GOTO      RPAM4570
.
RPAM4560  MOVE      FORM7P2C,PRECAMMP
          GOTO      RPAM4570
.....
RPAM4570  PACK      PRECSTAT,SP1,TWO             * set closed with payment
          MOVE      PMEDLDAT,PRECPDAT            * set payment date
.
RPAM4600  CALL      UPPRECT6                     * update claim
.
.         Finally, write an EDI History record (pmsecaaf)
.         
          MOVE      PRECINVN,PREAINVN
          CALL      IBACLOCK
          PACK      PREADATE,CCC,CYY,CMM,CDD
          REP       " 0",PREADATE
          MOVE      CTIMEIS,PREATIME
          MOVE      PRECBATN,PREABATN
          MOVE      PRECFLAG,PREASTAT
          MOVE      " 5",PREATYPE
          MOVE      WBSEUID,PREAOPER
          MOVE      PRECTRID,PREATRID
          MOVE      SP4,PREAEROR
          MOVE      SP70,PREAEROT
          MOVE      SP30,PREASPAR
.
RPAM5000  PACK      KEY26,PREAINVN,PREADATE,PREATIME,PREATYPE,SP70
          CALL      RAPRECA1
          IF        OVRCD = 1
            CALL      WRPRECA1
          ELSE
            CALL      IBACLOCK
            PACK      PREADATE,CCC,CYY,CMM,CDD
            REP       " 0",PREADATE
            MOVE      CTIMEIS,PREATIME
            GOTO      RPAM5000
          ENDIF
.
.         Update the remittance table (pmserdaf) to indicate that
.         the claim payment has been released to the relevant ibaPAS tables
.
          MOVE      TWO,PMEDSTAT                 * set as released
          CALL      UPPMERD1
.
.         MOVE      ONE,UNLKFLAG
.         CALL      UNLK0000                     * unlock all locked records
.
.         MOVE      PRECINVN,KEY8
.         CALL      CREM0000              * Update Un-reconciled inv.file
.
          GOTO      RPAM1000
.
.*******************************************************************************
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAM6000  
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         MOVE      PMEDARID,DIM8
.         RJUSTIFY  DIM8
.
.         PACK      KEY8,DIM8,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      DIM8,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAM8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
RPAM6100  MATCH     SAVEPART,PARTPANT            * same participant still ?
          IF        !@EQUAL
            CALL      ALLCRC00
.
            MOVE      PARTPANT,SAVEPART          * save new participant code
          ENDIF
.
          MOVE      HRECPT,TRECEIPT
.
          ADD       ONE,RELCOUNT
.
.         MOVE      ONE,PMECEETP
.         MATCH     "DVA",PMEDPART
.         IF        !@EQUAL
.           MOVE      ZERO,PMECEETP
.         ENDIF
.
          UNPACK    PMEDBAMT,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.      
          MATCH     "HIC",PMEHNAME
          IF        @EQUAL
            MOVE      FORM7P2C,PRECAMMP
            ASSIGN    (PRINMAMT-PRECAMMP),PRINMAMT
          ELSE
            MOVE      FORM7P2C,PRECAMFP
            ASSIGN    (PRINHAMT-PRECAMFP),PRINHAMT
          ENDIF
.
. Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      PMEHHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
            MOVE      "1",RCBNTTYP               * CAR 227986
.
.           MOVE      PMECHFND,RCBNRCOD
.
            MOVE      SP70,RCBNRCOD
            MOVE      PMEDARID,DIM8
            RJUSTIFY  DIM8
.
            PACK      KEY22,DIM8,SP70
            CALL      RSPRDT4
            CALL      RKPRDT4
            IF        OVRCD=0
              MATCH     DIM8,PRDTINVN
              IF        @EQUAL
                PACK      KEY8,DPRDTUNQ,SP70
                CALL      RDPRHD2
                IF        OVRCD=0
                  MOVE      PRHDHFND,RCBNRCOD
                ENDIF
              ENDIF
            ENDIF
.        
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
              MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.      
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      PMEHHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
            MATCH     "HIC",PMEHNAME
            IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
            ELSE
              MOVE      PARTPANT,RCBDPAYD
            ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      PMEHNAME,RCBDDRAW
            MOVE      PMEHBNAM,RCBDBANK
            MOVE      PMEHBBSB,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      PMEHPREF,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            UNPACK    PMEDBAMT,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf
. 
RPAM6500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDTS00
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDTS00
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDTS00
              ELSE
                GOTO      RPAM6500
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      THREE,PMEDSTAT          * set as released to suspense acc
          CALL      UPPMERD1
.
.         MOVE      THREE,UNLKFLAG
.         CALL      UNLS0000
.
          GOTO      RPAM1000
.*******************************************************************************
.
.         A record was locked for this claim, so set the status to "locked"
.
RPAM8000  MOVE      "1",PMEDSTAT
          CALL      UPPMERD1
          GOTO      RPAM1000
.
.         Check if all the payment records for the ERA were released and
.         update the ERA header status accordingly.
.
RPAM9000  IF        ERDCOUNT = (PRLCOUNT+RELCOUNT)
            MOVE      "2",PMEHSTAT               * set to "released"
          ELSE
            MOVE      "1",PMEHSTAT               * set to "partial"
          ENDIF
          CALL      UPPMERH1
.
          IF        IBCNMHOS=1
            MATCH     "2",PMEHSTAT
            IF        @EQUAL
              CALL      CDERA000
            ENDIF
          ENDIF
.
.         Unlock general records.
.
          MATCH     "1",MULTLT01
          IF        @EQUAL
            MOVE      "2",DIM1C
            PACK      REMITKEY,PMEHHOSP,PMEHFTID,PMEHRADV,PMEHPNUM,SP70
            CALL      PRNRMM00
          ENDIF
.
          MATCH     "1",PMEHSTAT
          IF        @EQUAL
            MOVE      "Payment record partially released.",WEBTITLE
          ELSE
            MOVE      "Payment record released.",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAM9999
.
RPAM9950  MOVE      "Remittance Currently being processed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAM9999
.
RPAM9960  MOVE      "Cannot find pmserhaf record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAM9999
.
RPAM9999  RETURN
+
.*****************************************************************************
.*                                 LTMM0000        Called by: RPAY0000       *
.*    Load the temp file with the pmserdaf records which correspond to the   *
.*    selected pmserhaf record.                                              *
.*    We need to use the temp file so that we can sort by participant code.  *
.*    Some health fund groups (e.g. BUPA), may send payments in a single     *
.*    remittance, relating to more than one participant (e.g HBA & MBF).     *
.*    When processing the payments, a receipt number needs to be generated   *
.*    for each participant.                                                  *
.* Requires:  Valid read on pmserhaf record                                  *
.*            ERDCOUNT - initialised to zero                                 *
.* Returns:   ERDCOUNT - total number of pmserdaf records related to the     *
.*                       selected remittance.                                *
.*****************************************************************************
.
LTMM0000  PACK      KEY82,PMEHFTID,PMEHRADV,PMEHPNUM,SP30,SP30,SP30
          CALL      RSPMERD1                     * position in file
LTMM0500  CALL      RKPMERD1                     * read next record
          BRANCH    OVRCD,LTMM9999               * end of file
.
          MATCH     PMEHFTID,PMEDFTID            * same fund trans. id still ?
          GOTO      LTMM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     PMEHRADV,PMEDRADV            * same remittance advice still?
          GOTO      LTMM9999 IF NOT EQUAL        * no - finished ERA
.
          MATCH     PMEHPNUM,PMEDPNUM            * same part number still ?
          GOTO      LTMM9999 IF NOT EQUAL        * no - finished ERA
.
          ADD       ONE,ERDCOUNT                 * increment pmserdaf count
.
.         A payment requiring releasing has been found, so get the
.         corresponding priectaf record.
.
          PACK      KEY40,PMEDTRID,SP30,SP10
          CALL      RSPRECT6                     * position on trans. id/invoice
          CALL      RKPRECT6                     * read next record
          BRANCH    OVRCD,LTMM1100               * eof
.
          MATCH     PMEDTRID,PRECTRID            * same transaction id still ?
          GOTO      LTMM1500 IF EQUAL            * yes
.
LTMM1100
.         DISPLAY   *P1:24,*EL,*B,"Missing priectaf record for ":
.                   *V2LON,PMEDTRID,*HOFF,".  ";
.         CALL      HITENTER
          GOTO      LTMM3000
.
.         Get the participant code for the claim
.
LTMM1500  MOVE      SP70,PARTPANT             * default part. to DVA
.         BRANCH    PMECEETP,LTMM5000            * DVA claim
          MATCH     "2",PRECEETP
          GOTO      LTMM5000 IF EQUAL
.
.         This is a Health Fund claim
.
          PACK      KEY14,PRECHFND,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1
          IF        OVRCD = 1
.           DISPLAY   *P1:24,*EL,*B,"Missing patfundf record for ":
.                     *V2LON,PMECHFND,*HOFF,".  ";
.           CALL      HITENTER
            GOTO      LTMM8000
          ENDIF
.
          PACK      KEY6,PRECHFND,SP70
          CALL      RDPTFX11
          IF        OVRCD=1
            GOTO      LTMM2000
          ENDIF
.
          MATCH     SP3,PTFXECLP
          GOTO      LTMM2000 IF EQUAL
          GOTO      LTMM2000 IF EOS
.
          MOVE      PTFXECLP,PARTPANT
          GOTO      LTMM5000
.
.         The health fund group equates to the participant
.
LTMM2000  MATCH     SP3,PTHFHGRP
          IF        @EQUAL
.           DISPLAY   *P1:24,*EL,*B,"Participant code blank for ":
.                     *V2LON,PMECHFND,*HOFF,".  ";
.           CALL      HITENTER
            GOTO      LTMM8000
          ENDIF
          MOVE      PTHFHGRP,PARTPANT            * load participant code
          GOTO      LTMM5000
.
LTMM3000  MOVE      SP70,PRHDHFND
.
          MOVE      PMEDARID,KEY8
          RJUSTIFY  KEY8
          PACK      KEY8,KEY8,SP70
          CALL      RDPRIN1
          COMPARE   OVRCD,ONE
          GOTO      LTMM3500 IF EQUAL
.
          MATCH     SP70,DPRINUNQ
          GOTO      LTMM8000 IF EQUAL
          GOTO      LTMM8000 IF EOS
.
          PACK      KEY8,DPRINUNQ,SP70
          CALL      RDPRHD2
          IF        OVRCD=1
            GOTO      LTMM8000
          ENDIF
.
.         Get the participant code for the claim
.
LTMM3500  
.         MOVE      CVETINS,PARTPANT
.         PACK      KEY5,ANSC,ANSL,ACLAIM
.         CALL      RDCODE1
.         IF        OVRCD=0
.           MOVE      ZERO,FORM1
.           WHILE     FORM1 < 5
.             ADD       ONE,FORM1
.             LOAD      ANS,FORM1,TCINDC1,TCINDC2,TCINDC3,TCINDC4,TCINDC5
.             MATCH     ANSV,ANS
.             IF        @EQUAL
.               GOTO      LTMM5000
.             ENDIF
.           DO
.         ENDIF
.
          MATCH     SP70,PRHDHFND
          GOTO      LTMM8000 IF EQUAL
          GOTO      LTMM8000 IF EOS
.
.         This is a health fund claim
.
          PACK      KEY14,PRHDHFND,ZERO,ZERO,ZERO,ZERO,SP20
          CALL      RDFUND1
          IF        OVRCD=1
            GOTO      LTMM8000
          ENDIF
.
          PACK      KEY6,PRHDHFND,SP70
          CALL      RDPTFX11
          IF        OVRCD=1
            GOTO      LTMM4000
          ENDIF
.
          MATCH     SP3,PTFXECLP
          GOTO      LTMM4000 IF EQUAL
          GOTO      LTMM4000 IF EOS
.
          MOVE      PTFXECLP,PARTPANT
          GOTO      LTMM5000
.
.         The health fund group equates to the participant
.
LTMM4000  MATCH     SP3,PTHFHGRP
          IF        @EQUAL
            GOTO      LTMM8000
          ENDIF
.
          MOVE      PTHFHGRP,PARTPANT
          GOTO      LTMM5000
.
.         Write the pmserdaf details to the temp file
.
LTMM5000  CALL      WRTEMP1
          GOTO      LTMM0500                     * get next payment
.
.         There was a problem processing this record, so set the pmserdaf
.         payment status to "locked"
.
LTMM8000  MOVE      "1",PMEDSTAT
          CALL      UPPMERD1
          GOTO      LTMM0500
.
LTMM9999  RETURN
+
.---------------------------------------------------------------------------
.         WRRDTM00 - Write to rcpdteaf
.---------------------------------------------------------------------------
.
WRRDTM00  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.         MOVE      PMEDARID,RCDTINVN
          PACK      RCDTINVN,PMEDARID,SP70
          RJUSTIFY  RCDTINVN
          MOVE      PRECUNIQ,RCDTVIST
          MOVE      PRECURNO,RCDTURNO
          MOVE      PRECURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD = 0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,RCDTNAME
            MOVE      PADD1,RCDTADD1
            MOVE      PADD2,RCDTADD2
            MOVE      PSUBRB,RCDTADD3
            MOVE      PADD4,RCDTADD4
            MOVE      PPOST,RCDTPOST
          ELSE
            MOVE      SP70,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
          ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      PMEHPREF,RCDTREFR
          MOVE      PMEHHOSP,RCDTMHOS
.
.         MOVE      RCCNERRE,RCDTREGI
.         IF        IBCNMHOS=1
.
.           MATCH     SP70,RCDTMHOS
.           IF        !@EQUAL & !@EOS
.             PACK      KEY3,RCDTMHOS,SP70
.             CALL      RDPTHSP1
.             IF        OVRCD=0
.               MATCH     SP70,PTHSERRE
.               IF        !@EQUAL & !@EOS
.                 MOVE      PTHSERRE,RCDTREGI
.               ENDIF
.             ENDIF
.           ENDIF
.
.           MATCH     SP70,PRECHOSP
.           IF        !@EQUAL & !@EOS
.             PACK      KEY3,PRECHOSP,SP70
.             CALL      RDPTHSP1
.             IF        OVRCD=0
.               MATCH     SP70,PTHSERRE
.               IF        !@EQUAL & !@EOS
.                 MOVE      PTHSERRE,RCDTREGI
.                 MOVE      PRECHOSP,RCDTMHOS
.               ENDIF
.             ENDIF
.           ENDIF
.         ENDIF
.
          MOVE      SP70,RCDTREGI
.
          MOVE      PMEDARID,DIM8
          RJUSTIFY  DIM8
.
          PACK      KEY22,DIM8,SP70
          CALL      RSPRDT4
          CALL      RKPRDT4
          IF        OVRCD=0
            MATCH     DIM8,PRDTINVN
            IF        @EQUAL
              PACK      KEY27,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,Sp70
              CALL      RDPRHR1
              IF        OVRCD=0
                MATCH     SP70,PRHRPRAC
                IF        !@EQUAL
                  PACK      KEY6,PRHRPRAC,SP70
                  CALL      RDPRPR1   
                  IF        OVRCD=0
                    MOVE      PRPRREGI,RCDTREGI
                    MATCH     SP70,PRPRREGI
                    IF        !@EQUAL
                      PACK      KEY3,PRPRREGI,SP70
                      CALL      RDREGA1
                      IF        OVRCD=0
                        MATCH     SP70,REGHOSP
                        IF        !@EQUAL
                          MOVE      REGHOSP,RCDTMHOS
                        ENDIF
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCT00
.
          UNPACK    PMEDBAMT,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      SP70,RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      PRECBATN,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDTM99  RETURN
+
.*******************************************************************************
.                         Reload Page Skip Cache
.*******************************************************************************
RELSKC00  CALL      OPENHTML
          BRANCH    EXIT,RELSKC99
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             "    alert(#" Hello World",WEBTITLE,"#");":
                             "    location.reload(true);":
                             "}":
                             "</script>"
          CALL      CLOSHTML
RELSKC99  RETURN
+
.------------------------------------------------------------------------------
. Close pmsetraf records called by RPAY0000
.------------------------------------------------------------------------------
DELET200  PACK      KEY51,SP1,TTYPEARG,SP70
          CALL      RSPMETR1
DELET210  CALL      RKPMETR1
          BRANCH    OVRCD,DELET299
.
          MATCH     SP70,PMETSTAT
          GOTO      DELET299 IF NOT EQUAL
.
          MATCH     TTYPEARG,PMETTYPE
          GOTO      DELET299 IF NOT EQUAL
.
          MATCH     PMEDTRID,PMETTRID
          GOTO      DELET210 IF NOT EQUAL
.
          MOVE      "1",PMETSTAT
.
          CALL       UPPMETR1
.
DELET299  RETURN
.
. Output Encounter FHIR JSON Response
.
FHRENC00  MOVE      "active",LCSTATUS
          MOVE      "arrived",ENSTATUS
          IF        ASTAT=1
            MOVE      "planned",ENSTATUS
          ENDIF
          IF        ASTAT=3
            MOVE      "finished",ENSTATUS
          ENDIF
          IF        ASTAT=5
            MOVE      "cancelled",ENSTATUS
          ENDIF
          IF        ASTAT=4
            MOVE      "onleave",ENSTATUS
          ENDIF
          IF        STBYFLAG=1
            MOVE      "planned",LCSTATUS
          ENDIF
.
          CALL      GETCON00             
.
          MATCH     SP70,CONDESC
          IF        !@EQUAL
            UNPACK    LPCDATE,CCENT,CYEAR,CMON,CDAY
            PACK      DISPDATE,LBRACKT,CDAY,SLASH,CMON,SP1,LPCTIME,RBRACKT 
            STRIP     CONDESC
          ENDIF
.
          PACK      FHRENCID,URNUMBER,ADMISSNO,SP70
          PACK      FHRPATID,URNUMBER,SP70
          REP       "+-",FHRENCID
          REP       " -",FHRENCID
          REP       "+ ",FHRPATID
          SQUEEZE   FHRPATID
.
          CLEAR     FHRWLOCC
          CLEAR     FHRBLOCC
          MATCH     SP70,AWARD
          IF        !@EQUAL
            APPEND    "Ward-",FHRWLOCC
            APPEND    AWARD,FHRWLOCC
          ENDIF
.
          MATCH     SP70,ABED
          IF        !@EQUAL
            APPEND    "Bed-",FHRBLOCC
            APPEND    AWARD,FHRBLOCC
            APPEND    ABED,FHRBLOCC
          ENDIF
.
          APPEND    SP70,FHRWLOCC
          APPEND    SP70,FHRBLOCC
          RESET     FHRWLOCC
          RESET     FHRBLOCC
          STRIP     FHRWLOCC
          STRIP     FHRBLOCC
          REP       " -",FHRWLOCC
          REP       " -",FHRBLOCC
.
.          CALL      FBED0000
          CALL      FWDNAM00
          CALL      FBDNAM00
.
          MOVE      FRWRDTXT,FHRLOCN
          MOVE      FRBEDTXT,FHRBLOCN
.
          MOVE      ENSTATUS,FHRSTAT     *  Encounter Status
          MOVE      "inpatient",FHRCLAS  *  Encounter Class
          UNPACK    ADATE,CCENT,CYEAR,CMON,CDAY
          MATCH     SP70,ATIME
          IF        @EQUAL
            PACK      FHRSTRDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY
          ELSE
            UNPACK    ATIME,CHOUR,D1,CMIN,D1,KEY2
            REP       " 0",CHOUR
            REP       " 0",CMIN
            REP       " 0",KEY2
            PACK      ATIME,CHOUR,COLON,CMIN,COLON,KEY2
            PACK      FHRSTRDT,CCENT,CYEAR,FHRDASH,CMON,FHRDASH,CDAY,ANST,ATIME,TIMEZONE,SP70
          ENDIF
          MOVE      FORMATNM,FHRPATN  *  Patient Display Name
.
          CALL      GFRDOC00
.
          STRIP     ADIAG1
          STRIP     ADIAG2
          CLEAR     FHRREAS  
          APPEND    ADIAG1,FHRREAS 
          APPEND    SP1,FHRREAS 
          APPEND    ADIAG2,FHRREAS 
          RESET     FHRREAS
.
          MOVE      SP70,FHRUNITC
          MOVE      SP70,FHRUNITD
          MATCH     SP3,ACLSSFT
          IF        !@EQUAL
            MOVE      "AC",KEY2
            PACK      KEY5,KEY2,ACLSSFT
            CALL      RDCODE1
            IF        OVRCD=0
              MOVE      KEY5,FHRUNITC
              MOVE      TDESC,FHRUNITD
            ENDIF
          ENDIF
          STRIP     FHRUNITC
          STRIP     FHRUNITD
.
          IF        RECNUMB>0
            WRITE     HTMLFILE;",";
          ENDIF
          ADD       ONE,RECNUMB
.
          MOVE      "false",FHRVISA
          MATCH     "1",PMVXVALW
          IF        @EQUAL
            MOVE      "true",FHRVISA
          ENDIF
.
          MOVE      "false",FHRPHNA
          MATCH     "1",PMVXPALW
          IF        @EQUAL
            MOVE      "true",FHRPHNA
          ENDIF
.
          WRITE     HTMLFILE;*+,"{ #"fullUrl#" : #"%BASEURL/Encounter/",FHRENCID,"#", ":
..                    " #"extension#": [ {":
..                    "  #"url#" : #"%BASEURL/extension/webPASMetaData#",":
..                    "  #"extension#": [ ":
..                    "   {#"url#" : #"PMWOWDI1#", #"valueString#" : #"",PMWOWDI1,"#" },":
..                    "   {#"url#" : #"PMWOWDI2#", #"valueString#" : #"",PMWOWDI2,"#" },":
..                    "   {#"url#" : #"PMWOWDI3#", #"valueString#" : #"",PMWOWDI3,"#" },":
..                    "   {#"url#" : #"DESTDESC#", #"valueString#" : #"",DESTDESC,"#" },":
..                    "   {#"url#" : #"WORKDESC#", #"valueString#" : #"",WORKDESC,"#" },":
..                    "   {#"url#" : #"CONDESC#",  #"valueString#" : #"",CONDESC,DISPDATE,"#" },":
..                    "   {#"url#" : #"CONDESC1#", #"valueString#" : #"",CONDESC1,"#" },":
..                    "   {#"url#" : #"DIETDESC#", #"valueString#" : #"",DIETDESC,"#" },":
..                    "   {#"url#" : #"SPECDESC#", #"valueString#" : #"",SPECDESC,"#" }":
..                    "   ] }":
..                    "  ],":
                    " #"resource#": ";
          CALL     RESENC00            * FHIR Resource Encounter
          WRITE    HTMLFILE;*+,"}" 
.
          IF       FHRSUBIN=1 
            WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Patient/",FHRPATID,"#", ":
                      " #"resource#" : ";
            CALL     RESPAT00            * FHIR Resource Patient
            WRITE    HTMLFILE;*+,"}" 
          ENDIF
.
          IF       FHRPARIN=1
.
            CALL      FHRDO100
.
            MATCH     SP70,FHRDOCC1
            IF        !@EQUAL
.
              WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC1,"#", ":
                        " #"resource#" : ";
              CALL     RESPRA00         * FHIR Resource Practitioner
              WRITE    HTMLFILE;*+,"}"
.
            ENDIF
.
            CALL      FHRDO200
.
            MATCH     SP70,FHRDOCC2
            IF        !@EQUAL
.
              WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Practitioner/",FHRDOCC2,"#", ":
                        " #"resource#" : ";
              CALL     RESPRA00         * FHIR Resource Practitioner
              WRITE    HTMLFILE;*+,"}"
.
            ENDIF
.
          ENDIF
.
          IF       FHRLOCIN=1
.
            PACK      KEY6,AWARD,ABED,SP70
            CALL      RDWARD1
            IF        OVRCD=0
.
              MATCH     SP70,AWARD
              IF        !@EQUAL
.
                MATCH     SP70,ABED
                IF        !@EQUAL
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",FHRBLOCC,"#", ":
                            " #"resource#" : ";
                  CALL     RESBED00         * FHIR Resource Location Bed
                  WRITE    HTMLFILE;*+,"}"
.
                ELSE
.
                  WRITE     HTMLFILE;*+,",{ #"fullUrl#" : #"%BASEURL/Location/",FHRWLOCC,"#", ":
                            " #"resource#" : ";
                  CALL     RESWRD00         * FHIR Resource Location Ward
                  WRITE    HTMLFILE;*+,"}"
.
                ENDIF
.
              ENDIF
.
            ENDIF
.
          ENDIF
.
          RETURN
+
.--------------------------------------------------------------------------------
. Add Diagnosis Coding to Encounter 
. Not provided for the Encounters Resource Search by Location for performance
.--------------------------------------------------------------------------------
RESDIA00  
RESDIA99  RETURN
.--------------------------------------------
. Add Contacts to FHIR Patient Resource
.--------------------------------------------
FHRCON00  MOVE      ZERO,F3
          PACK      KEY14,URNUMBER,SP20
          CALL      RSPMCEX1
FHRCON10  CALL      RKPMCEX1
          BRANCH    OVRCD,FHRCON99
          MATCH     URNUMBER,PMCEURNO
          GOTO      FHRCON99 IF NOT EQUAL
          MATCH     "0",PMCEACTV
          GOTO      FHRCON10 IF NOT EQUAL
.
          PACK      KEY5,CATTC,PMCETYPE
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      PMCETYPE,TDESC
          ENDIF
.
          PACK      KEY4,PMCETITL
          CALL      RDPMTLE1
          IF        OVRCD=1
            MOVE      PMCETITL,PMTLDESC
          ENDIF
.
          PACK      KEY10,PMCERELP,SP70
          CALL      RDPMREL1
          IF        OVRCD=1
            MOVE      PMCERELP,PMRLDESC
          ENDIF
.
          IF        F3>0
            WRITE     HTMLFILE;*+,",";
          ELSE
            ADD       ONE,F3
            WRITE     HTMLFILE;*+,",#"contact#" : [ ";
          ENDIF
          WRITE     HTMLFILE;*+,"{#"relationship#": [ {":
                                "  #"coding#":  [ {":
                                "   #"code#": #"",PMCERELP,"#",":
                                "   #"display#": #"",PMRLDESC,"#" } ] } ],":
                                " #"name#" : {":
                                "  #"use#" : #"usual#",":
                                "  #"family#": #"",PMCESNAM,"#",":
                                "  #"given#" : [#"",PMCEGNAM,"#"";
          MATCH     SP70,PMCEGNM2
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"",PMCEGNM2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "      #"prefix#" : [#"",PMTLDESC,"#"]":
                      "     }, ";
.
          WRITE     HTMLFILE;*+," #"address#": [ {":
                                " #"use#": #"home#",":
                                " #"line#": [#"",PMCEADD1,"#"";
          MATCH     SP70,PMCEADD2
          IF        !@EQUAL
            STRIP     PMCEADD2
            WRITE     HTMLFILE;*+,",#"",PMCEADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                                " #"city#": #"",PMCEADD3,"#",":
                                " #"state#": #"",PMCEADD4,"#",":
                                " #"postalCode#": #"",PMCEPOST,"#"":
                                " } ],":
                                "#"telecom#": [ ":
                                "{#"system#": #"email#",":
                                " #"value#": #"",PMCEEMAI,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PMCETELP,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"work#",":
                                " #"value#": #"",PMCETELB,"#"},":
                                "{#"system#": #"phone#",":
                                " #"use#": #"mobile#",":
                                " #"value#": #"",PMCETELM,"#"} ] }";
          GOTO      FHRCON10

FHRCON99  IF        F3>0
            WRITE     HTMLFILE;*+,"  ]";
          ENDIF
          MATCH     PMPXRHC1,SP70
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",#"generalPractitioner#": [ { #"reference#": #"Practitioner/HCP-",PMPXRHC1,"#" }";
            MATCH     PMPXVGPC,SP70
            IF        !@EQUAL
              WRITE     HTMLFILE;*+,", { #"reference#": #"Practitioner/HCP-",PMPXVGPC,"#" }";
            ENDIF
            WRITE     HTMLFILE;*+," ]";
          ENDIF
          WRITE     HTMLFILE;*+,",#"telecom#": [ ";
          WRITE     HTMLFILE;*+,"{#"system#": #"phone#",":
                                " #"use#": #"home#",":
                                " #"value#": #"",PTELEP,"#"}";
          MATCH     SP70,PMPXPEML
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"email#",":
                                  " #"value#": #"",PMPXPEML,"#"}";
          ENDIF
          MATCH     SP70,PTELEB
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"work#",":
                                  " #"value#": #"",PTELEB,"#"}";
          ENDIF
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            WRITE     HTMLFILE;*+,",{#"system#": #"phone#",":
                                  " #"use#": #"mobile#",":
                                  " #"value#": #"",PTMXCELL,"#"} ";
          ENDIF
          WRITE     HTMLFILE;*+,"]";
          RETURN
+
.
.------------------------------------------------------------
. Get Doctors for FHIR Response.
.------------------------------------------------------------
GFRDOC00  CLEAR     FHRDOCC1
          APPEND    "HCP-",FHRDOCC1
          APPEND    ADOCTA,FHRDOCC1
          RESET     FHRDOCC1
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
          MOVE      SDOCFNAM,FHRDOCN1
.
          MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
          REP       "+ ",ADMISSNO
          MATCH     SP70,PMVXEDC1
          GOTO      GFRDOC99 IF EQUAL
.
          PACK     KEY24,ADMISSNO,Z70
          CALL     RSPMDTC1
GFRDOC10  CALL     RPPMDTC1
          BRANCH   OVRCD,GFRDOC20
          MATCH    ADMISSNO,PMDTVISN
          GOTO     GFRDOC20 IF NOT EQUAL
          MATCH    PMDTDOCT,PMVXEDC1
          GOTO     GFRDOC10 IF NOT EQUAL
          MATCH    PMDTUNIT,PMVXEDU1
          GOTO     GFRDOC10 IF NOT EQUAL
          MATCH    SP70,PMDTEDAT
          GOTO     GFRDOC20 IF EQUAL
.
          MOVE     SP70,KEY8A
          MOVE     PMDTETIM,KEY8A
          MATCH    SP70,KEY8A
          IF       @EQUAL
            PACK     KEY8A,ZERO,ZERO,COLON,ZERO,ZERO,COLON,ZERO,ZERO
          ENDIF
          PACK     KEY16,PMDTEDAT,KEY8A,SP70
          CALL     IBACLOCK
          PACK     KEY8,CCC,CYY,CMM,CDD
          REP      " 0",KEY8
          PACK     KEY16A,KEY8,CTIMEIS,SP70
          MATCH    KEY16A,KEY16
          GOTO     GFRDOC99 IF LESS
.
GFRDOC20  CLEAR    FHRDOCC2
          APPEND   "HCP-",FHRDOCC2
          APPEND   PMVXEDC1,FHRDOCC2
          RESET    FHRDOCC2
          MOVE     "CON",FHRDOCT2
          MOVE     SECDOCDE,FHRDOCN2
.
GFRDOC99  RETURN
.
.-----------------------------------------------------------
. Format ward/bed text for output 
.-----------------------------------------------------------
FWDBED00  CLEAR     WDBEDTXT
          CALL      STANDP00
          MATCH     SP70,AWARD
          GOTO      FWDBED99 IF EQUAL
.  
          PACK      KEY6,AWARD,SP70
          CALL      RDWARD1
          IF        OVRCD=1
            STRIP     AWARD
            APPEND    AWARD,WDBEDTXT
          ELSE    
            STRIP     PTWDSDES
            APPEND    PTWDSDES,WDBEDTXT
          ENDIF
          MATCH     SP70,ABED
          GOTO      FWDBED99 IF EQUAL
          APPEND    "/",WDBEDTXT
          PACK      KEY6,AWARD,ABED,SP70
          CALL      RDWARD1        
          BRANCH    OVRCD,FWDBED99
          IF        WBEDDESC > 0
            IF        WBEDDESC = 2 
              STRIP     PTWDSDES
              APPEND    PTWDSDES,WDBEDTXT   * use short bed text
            ELSE
              STRIP     WBDESC
              APPEND    WBDESC,WDBEDTXT      * use bed desc, not bed #
            ENDIF   
          ELSE
            STRIP    ABED
            APPEND   ABED,WDBEDTXT
          ENDIF
          MATCH     DWSTBY,ADMISSNO
          GOTO      FWDBED99 IF NOT EQUAL
          APPEND    " (s)",WDBEDTXT       * add standby ind. ' (s)'
          MOVE      "planned",LCSTATUS     * Location Status 
.
FWDBED99  APPEND    SP70,WDBEDTXT
          RESET     WDBEDTXT
          RETURN
.
.------------------------------------------------------------
. Checks for Patient on standby
.------------------------------------------------------------
STANDP00  PACK     KEY13,ABED,SP70
          PACK     KEY6,AWARD,SP70
          MATCH    SP70,AWARD
          IF       @EQUAL
            PACK      KEY14,AADMNO,SP70
            CALL      RDSWARD4
            CALL      RDKWARD4
            BRANCH    OVRCD,STANDP99
            MATCH     WSTBY,AADMNO
            GOTO      STANDP99 IF NOT EQUAL
            MOVE      WWARD,AWARD
            MOVE      WBED,ABED
            CLEAR     KEY10
            APPEND    SP1,KEY10
            APPEND    "(s)",KEY10
            RESET     KEY10
          ENDIF
          GOTO     STANDP99
.
STANDP99  RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource Extra Type Related Data
.------------------------------------------------------------------------------
RESEXT00
RESEXT99  RETURN
.
.-----------------------------------------------------------------------------
.                                                                    *C-0837181
. If current Transfer record in pattranf has a Transfer Reason Cat RB code
. with indicator1="O" then display the parameter variable PTCNBTOD in the 
. overflow descrtiption
.-----------------------------------------------------------------------------
OVFDS000  MOVE      SP70,OVFLDESC
.
          MATCH     "1",PTCNBTRE                    * Collect transfer reason?
          GOTO      OVFDS999 IF NOT EQUAL           * No, exit
.
          MOVE      ADMISSNO,VISITNUM
          REP       "+ ",VISITNUM
.
          PACK      KEY30,VISITNUM,Z70
          CALL      RDSTRAN2                            * Positional Read
          CALL      RDPTRAN2                            * Read previous record
          BRANCH    OVRCD,OVFDS999
.
          MATCH     VISITNUM,DTADMN                     * Same visit?
          GOTO      OVFDS999 IF NOT EQUAL
.
          MATCH     SP70,PTTRTRTY                       * Transfer Reason set?
          GOTO      OVFDS999 IF EQUAL | @EOS
.
          PACK      KEY5,ANSR,ANSB,PTTRTRTY,SP70        * Check Category RB
          CALL      RDCODE1
          BRANCH    OVRCD,OVFDS999
.
          MATCH     ANSO,TCINDC1                        * Overflow ind on?
          GOTO      OVFDS999 IF NOT EQUAL
.
          CLEAR     OVFLDESC
          APPEND    BODMASFT,OVFLDESC
          APPEND    PTCNBTOD,OVFLDESC
          APPEND    ENDFONT,OVFLDESC
          RESET     OVFLDESC
.
OVFDS999  RETURN 
.
.------------------------------------------------------------
. Hospital Selection - List of Hospitals allowed to User
.------------------------------------------------------------
HSPSEL00  PACK      KEY3,SP70
          CALL      RSPTHSP1
HSPSEL10  CALL      RKPTHSP1
          BRANCH    OVRCD,HSPSEL99
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,HSPSEL10
          ENDIF
.
          MOVE      PTHSNAME,KEY50
          PACK      KEY5,QUOTE,PTHSHOSP,QUOTE
          MATCH     FILTHOSP,PTHSHOSP
          IF        @EQUAL
            WRITE     HTMLFILE;"<option value=",KEY5," selected>":
                               KEY50,"</option>"
          ELSE
            WRITE     HTMLFILE;"<option value=",KEY5,">",KEY50,"</option>"
          ENDIF
          GOTO      HSPSEL10
.
HSPSEL99  RETURN
.
+
.------------------------------------------------------------
. Eclipse DBS Payment Report Enquiries
.------------------------------------------------------------
ECRB0000  MATCH     "1",PTCNUEBB
          GOTO      ECRB9300 IF NOT EQUAL
.
          RESET     UPDATETY
          MATCH     SP70,UPDATETY
          GOTO      ECRB5000 IF EQUAL
.
          MATCH     "R",UPDATETY
          GOTO      ECRB4000 IF EQUAL
.
          MATCH     "D",UPDATETY
          GOTO      ECRB3000 IF EQUAL
.
          MATCH     "L",UPDATETY
          GOTO      ECRB2000 IF EQUAL
.
          MATCH     "P",UPDATETY
          GOTO      ECRB1000 IF EQUAL
.
          GOTO      ECRB9000
.
ECRB1000  MOVE      "1",DIM1C
          CALL      PRNRMB00
          MOVE      "Print Payment Report scheduled.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB2000  CALL      RPAB0000
          GOTO      ECRB9999
.
ECRB3000  PACK      KEY53,HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRECLAM:
                          ECRETRID,SP70
          CALL      RDOTERD1
          BRANCH    OVRCD,ECRB9100
.
          GOTO      ECRB6000
.
ECRB4000  REP       "`##",ECRERKEY
.
          PACK      KEY47,HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRERKEY,SP70
          CALL      RDOTERH1
          BRANCH    OVRCD,ECRB9100  
.
          GOTO      ECRB6000
.
ECRB5000  MOVE      TEMPLATE,KEY3
          RJUSTIFY  KEY3
          REP       " 0",KEY3
.
          MATCH     "001",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased DBS Payment Report Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "005",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Released DBS Payment Report Enquiry",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
          MATCH     "007",KEY3
          IF        @EQUAL
.
            CALL      CURPER00
            CALL      CALCDT00
.
            CLEAR     WEBTITLE
            MOVE      "Unreleased DBS Payment Report Enquiry Only",WEBTITLE
            RESET     WEBTITLE
          ENDIF
.
ECRB6000  CALL      WEBHED00
          BRANCH    EXIT,ECRB9999
.
          CALL      WEBBOD00
.
          CALL      WEBEND00
.
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB9000  MOVE      "Invalid Form Action.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB9100  MOVE      "Can't find Payment details.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB9300  MOVE      "Not using Eclipse DBS Module.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      ECRB9999
.
ECRB9999  RETURN
.
.--------------------------------------------------------------------------
.*                             PRNRMB00                                   *
.*               Schedule Eclipse IMC Remittance Report (IBAPRI11)        *
.--------------------------------------------------------------------------
PRNRMB00  MOVE      "IBAOUT12",SCHDPGID
          MOVE      "Eclipse DBS Payment Report",SCHDDESC
          CALL      IBACLOCK
          PACK      SCHDDATE,CCC,CYY,CMM,CDD
          REP       " 0",SCHDDATE
          CLOCK     TIME,SCHDTIME
          MOVE      ONE,SCHDCOPY
          MOVE      "S  ",SCHDPRNT           * initialise to spool
          MATCH     SP70,SELPRINT
          IF        !@EQUAL
            MOVE      SELPRINT,SCHDPRNT      * printer code
          ENDIF
          MOVE      "IBAOUT12",SETDFPRG
          MOVE      "1",SETDFRPT
          CALL      SETDEF00                 * save default printer
.
.         Write Keyin parameters
.
          UNPACK    PAYMTKEY,KEY3,KEY8,KEY4,KEY8A,KEY24
          MOVE      KEY3,KEYSTARR[1]        * key for pmserhaf
          MOVE      KEY8,KEYSTARR[2]
          MOVE      KEY4,KEYSTARR[3]
          MOVE      KEY8A,KEYSTARR[4]
          MOVE      KEY24,KEYSTARR[5]
          MOVE      USERID,KEYSTARR[6]
          MOVE      DIM1C,KEYSTARR[7]
          MOVE      SEVEN,KEYSTCNT            * Number of Keyins
.
          CALL      SCHPRO00   * Schedule Extract
.
PRNRMB99  RETURN
+
.*****************************************************************************
.*                              RPAB0000           Called by: KEYA0000       *
.*           Release all payments for the selected ERA batch                 *
.*****************************************************************************
.
.         Initialise counters
.         ERDCOUNT - is the total number of pmserdaf records associated
.                    with the selected ERA batch.
.         PRLCOUNT - is the number of pmserdaf records associated with the
.                    selected ERA batch, which have previously been "released".
.         RELCOUNT - is the number of pmserdaf records associated with the
.                    selected ERA batch for which payments have been released
.                    in this session.
.
RPAB0000  
.          CALL      CLER0000
.          MOVE      SP3,SAVEPART
.
          MOVE      ZERO,EXIT
          MOVE      ZERO,ERDCOUNT
          MOVE      ZERO,PRLCOUNT
          MOVE      ZERO,RELCOUNT
.
.         Start releasing payments for the ERA
.
RPAB0500  
.          REP       "+ ",FUNDTRID
.          REP       "+ ",REMITADV
.          REP       "+ ",PARTNUMB
.
          REP       "+ ",HOSPCODE
          REP       "+ ",ECREPYPN
          REP       "+ ",ECREPRUN
          REP       "+ ",ECREPDAT
          REP       "+ ",ECRERKEY
.
          PACK      KEY47,HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRERKEY,SP70
          CALL      RDOTERH1
          BRANCH    OVRCD,RPAB9960
.
          MATCH     "3",OTERSTAT
          GOTO      RPAB9950 IF EQUAL
.
          MOVE      "3",OTERSTAT
          CALL      UPOTERH1
.
.          CALL      LTMM0000
..
..         Start releasing payments for the ERA
..
.          MOVE      SP30,KEY27
.          CALL      RSTEMP2                      * position in file
.RPAB1000  CALL      RKTEMP2                      * read next record
.          BRANCH    OVRCD,RPAB9000               * end of file
..
..         Read the pmserdaf record as the record status will need to be
..         updated later
..
.          PACK      KEY82,PMEDFTID,PMEDRADV,PMEDPNUM,PMEDTRID
.          CALL      RDPMERD1                     * record found ?
.          BRANCH    OVRCD,RPAB1000               * no - shouldn't happen
.
          MOVE      SP70,RECPTIND
.
          PACK      KEY77,OTERRKEY,OTERHOSP,OTERPYPN,OTERPRUN,OTERPDAT,SP70
          CALL      RSOTERD3
RPAB1000  CALL      RKOTERD3
          BRANCH    OVRCD,RPAB9000
.
          MATCH     OTERRKEY,OTESRKEY
          GOTO      RPAB9000 IF NOT EQUAL
.
          MATCH     OTERHOSP,OTESHOSP
          GOTO      RPAB9000 IF NOT EQUAL
.
          MATCH     OTERPYPN,OTESPYPN
          GOTO      RPAB9000 IF NOT EQUAL
.
          MATCH     OTERPRUN,OTESPRUN
          GOTO      RPAB9000 IF NOT EQUAL
.
          MATCH     OTERPDAT,OTESPDAT
          GOTO      RPAB9000 IF NOT EQUAL
.

.
          UNPACK    OTESCLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.         IF        FORM7P2C = 0 | FORM7P2C < 0
          IF        FORM7P2C = 0
            ADD       ONE,RELCOUNT
            MOVE      TWO,OTESSTAT                 * set as released
            CALL      UPOTERD3
            GOTO      RPAB1000
          ENDIF
.
.         A payment for the ERA has been found, so check if it needs releasing
.
          ADD       ONE,ERDCOUNT                 * increment pmserdaf count
          MATCH     "2",OTESSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAB1000                   * get next payment
          ENDIF
.
          MATCH     "3",OTESSTAT                 * releasing ?
          IF        @EQUAL
            ADD       ONE,PRLCOUNT               * yes - incr. prev. rel. count
            GOTO      RPAB1000                   * get next payment
          ENDIF
.
.         A claim requiring payment releasing has been found, so
.         get the corresponding priectaf record and check if same hospital
.
          MOVE      ZERO,ERASUSIN
          PACK      KEY40,OTESTRID,SP70
          CALL      RSOTECT6                     * position on trans. id/invoice
          CALL      RKOTECT6                     * read next record
.         BRANCH    OVRCD,RPAB6000               * eof
          IF        OVRCD=ONE
            CLEAR     SERDIM50
            APPEND    OTESTRID,SERDIM50
            APPEND    " - outectaf record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAB6000
          ENDIF
.
          MATCH     OTESTRID,OTECTRID            * same transaction id still ?
.         GOTO      RPAB6000 IF NOT EQUAL        * no
          IF        !@EQUAL
            CLEAR     SERDIM50
            APPEND    OTESTRID,SERDIM50
            APPEND    " - tran id not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAB6000
          ENDIF

.
          MOVE      SP70,SAVELOCN
          IF        IBCNMHOS=1
            MATCH     OTERHOSP,OTECHOSP
            IF        !@EQUAL
              PACK      KEY3,OTECHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MOVE      PTHSLOCN,SAVELOCN
              ELSE
                  SUB       ONE,ERDCOUNT
                  GOTO      RPAB1000
              ENDIF
.
              PACK      KEY3,OTERHOSP,SP70
              CALL      RDPTHSP1
              IF        OVRCD=0
                MATCH     SAVELOCN,PTHSLOCN
                IF        !@EQUAL
                  SUB       ONE,ERDCOUNT
                  GOTO      RPAB1000
                ENDIF
              ELSE
                  SUB       ONE,ERDCOUNT
                  GOTO      RPAB1000
              ENDIF
            ENDIF
          ENDIF
.
.          PACK      KEY8,PMEDARID,SP70
.          RJUSTIFY  KEY8
.          CALL      RDPRIN1
..         IF        OVRCD = 1
..           GOTO      RPAB6000
..         ENDIF
.          IF        OVRCD=ONE
.            CLEAR     SERDIM50
.            APPEND    PMEDARID,SERDIM50
.            APPEND    " - priinvof record not found",SERDIM50
.            RESET     SERDIM50
.            GOTO      RPAB6000
.          ENDIF
.
..
.          MATCH     "1",PRINCNST
..         GOTO      RPAB6000 IF EQUAL
.          IF        @EQUAL
.            CLEAR     SERDIM50
.            APPEND    PMEDARID,SERDIM50
.            APPEND    "invoice is fully credited",SERDIM50
.            RESET     SERDIM50
.            GOTO      RPAB6000
.          ENDIF
.
          MATCH     "2",OTECMODL
          IF        @EQUAL
.
            PACK      KEY8,OTECINVN,SP70
            RJUSTIFY  KEY8
            CALL      RDPRIN1
            IF        OVRCD=ONE
              CLEAR     SERDIM50
              APPEND    OTECINVN,SERDIM50
            APPEND    " - priinvof record not found",SERDIM50
            RESET     SERDIM50
            GOTO      RPAB6000
            ENDIF
.
            MATCH     "1",PRINCNST
            IF        @EQUAL
              CLEAR     SERDIM50
              APPEND    OTECINVN,SERDIM50
              APPEND    "invoice is fully credited",SERDIM50
              RESET     SERDIM50
              GOTO      RPAB6000
            ENDIF
.
          ELSE
.
            PACK      KEY8,OTECINVN,SP70
            RJUSTIFY  KEY8
            CALL      RDPTINV1
            IF        OVRCD=ONE
              CLEAR     SERDIM50
              APPEND    OTECINVN,SERDIM50
              APPEND    " - patinvrf record not found",SERDIM50
              RESET     SERDIM50
              GOTO      RPAB6000
            ENDIF

.
            MATCH     "1",PTINCRST
.           GOTO      RPAY6000 IF EQUAL
            IF        @EQUAL
              CLEAR     SERDIM50
              APPEND    OTECINVN,SERDIM50
              APPEND    "invoice is fully credited",SERDIM50
              RESET     SERDIM50
              GOTO      RPAB6000
            ENDIF
.
          ENDIF
.
.
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAB1500
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         PACK      KEY8,PMECINVN,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      PMECINVN,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAB8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         Now check the we can lock the invoice record
.
.         MOVE      PMECINVN,KEY8
.         CALL      RLPTINV1
.         IF        OVRCD = 1
..           MOVE      THREE,UNLKFLAG
..           CALL      UNLK0000                   * unlock any locked records
..           GOTO      RPAB8000
.           GOTO      RPAB6100
.         ELSE
.           IF        OVRCD = 2
.             MOVE      THREE,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAB8000
.           ENDIF
.         ENDIF
.
.         Check that we can lock the visit record
.
.         PACK      KEY8,PMECADMN,SP70
.         CALL      RLPTVIS1
.         IF        OVRCD = 1
.           MOVE      TWO,UNLKFLAG
.           CALL      UNLK0000                   * unlock any locked records
.           GOTO      RPAB8000
.         ELSE
.           IF        OVRCD = 2
.             MOVE      TWO,UNLKFLAG
.             CALL      UNLK0000                 * unlock any locked records
.             GOTO      RPAB8000
.           ENDIF
.         ENDIF
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
.         MATCH     SAVEPART,PARTPANT            * same participant still ?
..          IF        !@EQUAL
.
            MATCH     "1",RECPTIND
            IF        !@EQUAL
              CALL      ALLCRC00
              MOVE      "1",RECPTIND
            ENDIF
..
.            MOVE      PARTPANT,SAVEPART          * save new participant code
.          ENDIF
.
.         Process the payment
.
          UNPACK    OTESCLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.          MATCH     "HIC",PMEHNAME
.          IF        @EQUAL
.            MOVE      FORM7P2C,PRECAMMP
.            ASSIGN    (PRINMAMT-PRECAMMP),PRINMAMT
.          ELSE
.            MOVE      FORM7P2C,PRECAMFP
.            ASSIGN    (PRINHAMT-PRECAMFP),PRINHAMT
.          ENDIF
.
          MOVE      FORM7P2C,OTECAMTP
.
          MATCH     "2",OTECMODL
          IF        @EQUAL
            ASSIGN    (PRINMAMT-OTECAMTP),PRINMAMT
          ELSE
            ASSIGN    (PINVOTHA-OTECAMTP),PINVOTHA
          ENDIF
.
          CALL      IBACLOCK                     * get current date
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
          MOVE      CTIMEIS,CURRTIME
.
..         Check if the invoice now balances
..
.          MOVE      PRINITOT,FORM10P2             * Invoice amount +
.          ADD       PRINPAMT,FORM10P2            * Patient payments +
.          ADD       PRINHAMT,FORM10P2            * H.F payments +
.          ADD       PRINOTHA,FORM10P2            * Other payments +
.          ADD       PRINJAMT,FORM10P2            * Journals +
.          ADD       PRINGSTJ,FORM10P2            * Journal GST = amt outstanding
..
..         MOVE      "99999999",PINVBLCD          * default to not balancing
..
..         COMPARE   ZERO,FORM10P2                * Does invoice balance ?
..         IF        @EQUAL
..           MOVE      CURRDATE,PINVBLCD          * yes - record balanced date
...          MOVE      TWO,PTDTAPAY               * set A/P flag - balanced
..         ELSE
...          MOVE      ZERO,PTDTAPAY              * set A/P flag - not balanced
..         ENDIF
.          MOVE      FORM10P2,PRINPEND
..         CALL      UPINV1                       * update/unlock invoice record
..
..         PROC      FLAGDEBT
..
..         Create the patdtraf cash receipt record.
..
.          MOVE      PRECUNIQ,PRDTUNIQ            * load unique number
..
..         Get the next transaction number.  As we have already locked
..         the visit record, there should be no problem getting the
..         next transaction number.
..
..RPAB3000  MOVE      PMECADMN,KEY8                * get next transaction number
..          CALL      TRVISA1
..
..          PACK      KEY22,PMECADMN,PMECINVN,PVITRAN
..          CALL      RDADTRN1                     * patdtraf record on file ?
..          COMPARE   ZERO,OVRCD
..          GOTO      RPAB3000 IF EQUAL            * yes
..
..          MOVE      PVITRAN,TTRANSN1             * load transaction number
..          MOVE      ANSH,TTYPEDEB                * set to "patient" type of debt
..          MOVE      PMECHFND,TDCODE
..
..          ASSIGN    (PMECAMTP*SEQ),TPATAMTT
..          MOVE      TPATAMTT,TREBATE
..
..          MOVE      ZERO,TPATAMTG                * set $ amounts
..          MOVE      ZERO,TPATAMTH
..          MOVE      ZERO,TPATAMTI
..          MOVE      ZERO,TPATAMTP
..
..          MOVE      CCC,TFCENT                   * set payment date
..          MOVE      CYY,TFYEAR
..          MOVE      CMM,TFMONTH
..          MOVE      CDD,TFDAY
..
..          MOVE      ZERO,TTCENT                  * initialise accomm. to dates
..          MOVE      ZERO,TTYEAR
..          MOVE      ZERO,TTMONTH
..          MOVE      ZERO,TTDAY
..
..          PACK      TTYPE,ANSP,ANSY              * set for payment
..          MOVE      SP9,TITEMNO
..          MOVE      PMECINVN,TREF                * load invoice no.
..          MOVE      SIX,TPAYTYPE                 * direct deposit
..
.          MOVE      HRECPT,PRDTRECN
..
..          IF        PMECEETP = 0
..            MOVE      "Unknown Health Fund           ",HFNAME
..            PACK      KEY14,PMECHFND,ZERO4,SP20
..            CALL      RDFUND1                    * HF on file ?
..            MOVE      HFNAME,TDDESC              * load HF description
..          ELSE
..            MOVE      "Unknown Claim Code  ",TDESC
..            PACK      KEY5,ANSC,ANSL,PINVCLM
..            CALL      RDCODE1
..            MOVE      TDESC,TDDESC               * load claim code description
..          ENDIF
..
..          MOVE      ONE,TINVPRT                  * invoice printed
..          MOVE      FIVE,TRECTYPE                * cash receipt
..          MOVE      ZERO,TNODAYS
..          MOVE      ZERO,TCLAIM
...         MOVE      ZERO,PTDTREBT
..          MOVE      SP6,TDOCTA
..          MOVE      ZERO,TSERVS
..          MOVE      SP6,TDOCTO
..          MOVE      SP2,TSESSION
..          MOVE      SP3,TMISGRP
..          MOVE      SP3,TDEPTYP
..          MOVE      SP3,TDWARD
..          MOVE      SP3,TCLMTYP
..          MOVE      SP3,TADMTYP
..          MOVE      PMECBATN,TBATCHN             * load batch number
..          MOVE      ZERO,TNINVS
..          MOVE      SP3,PTDTBTYP
..          MOVE      ZERO,PTDTLSPT
..          MOVE      ZERO,PTDTLSRB
..          MOVE      ZERO,PTDTDTYP
..          PACK      PTDTDES2,SP20,SP20
..          MOVE      ZERO,PTDTEPSD
..          MOVE      ZERO,PTDTCCU
...         MOVE      SP6,PTDTSURG
...         MOVE      SP1,PTDTDEPS
..
..          MOVE      CURRDATE,PTDTEFFD            * load payment date
..
..          MOVE      ZERO,PTDTGSTA
..          MOVE      SP6,PTDTGSTC
..          MOVE      ZERO,PTDTGSTM
..          MOVE      ZERO,PTDTADPT
..          MOVE      ZERO,PTDTADRB
..          MOVE      ZERO,PTDTGSTL
..          MOVE      SP70,PTDTTIME
..          MOVE      SP70,PTDTCRST
..          MOVE      SP70,PTDTUNIQ
..          MOVE      SP70,PTDTCNTR
..          MOVE      SP70,PTDTCPRC
..          MOVE      SP70,PTDTCONT
..          MOVE      SP70,PTDTSUNQ
..          MOVE      SP70,PTDTBTCH
...         MOVE      ANSN,PTDTSSAP
...         MOVE      ZERO,PTDTMVBR
..          MOVE      ZERO,PTDTEPSD
...         MOVE      SP1,PTDTMHDP
..          PACK      TSPARE,SP30,SP30
..
..          CALL      WRDTRN1                     * write patdtraf journal record
..
           ADD       ONE,RELCOUNT
.
. Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
            UNPACK    OTESCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      OTERHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
.
.           MATCH     "HIC",PMEHNAME
.           IF        @EQUAL
              MOVE      "3",RCBNTTYP
              MOVE      SP70,RCBNRCOD
.           ELSE
.             MOVE      "1",RCBNTTYP               * CAR 227986
.             MOVE      PRECHFND,RCBNRCOD
.           ENDIF
.
.           MOVE      PRECHFND,RCBNRCOD
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
            MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            UNPACK    OTESCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      OTERHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            UNPACK    OTESCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
.           MATCH     "HIC",PMEHNAME
.           IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
.           ELSE
.             MOVE      PARTPANT,RCBDPAYD
.           ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      "MEDICARE",RCBDDRAW
            MOVE      OTERACNM,RCBDBANK
            MOVE      OTERBSBC,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      OTERPRUN,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            UNPACK    OTESCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf
.
RPAB3500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDB100
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDB100
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDB100
              ELSE
                GOTO      RPAB3500
              ENDIF
            ENDIF
          ENDIF
.
.         Now "close" the current claim (providing that a processing report
.         has been received) and update the payment amount and
.         the payment date
.
.          MOVE      PMEDARID,DIM20               * CAR 227986
.          SQUEEZE   DIM20
.
.          PACK      KEY57,OTESTRID,OTESCLID,Z70
.          CALL      RSOTEAH2                     * position on trans. id
.RPAB4000  CALL      RPOTEAH2                     * read previous record
.          BRANCH    OVRCD,RPAB4500               * eof - no proc. report
..
.          MATCH     OTESTRID,OTEHCTID            * same claim trans. id ?
.          GOTO      RPAB4500 IF NOT EQUAL        * no - no proc. report
..
.          MATCH     OTESCLID,OTEHCLID            * same claim id ?
.          GOTO      RPAB4500 IF NOT EQUAL        * no - no proc. report
.
.         A processing report was found
.
          UNPACK    OTESCLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.......
.          MOVE      PMEDARID,DIM8
.          RJUSTIFY  DIM8
..
.          PACK      KEY22,DIM8,SP70
.          CALL      RSPRDT4
.          CALL      RKPRDT4
.          BRANCH    OVRCD,RPAB4100
..
.          MATCH     DIM8,PRDTINVN
.          GOTO      RPAB4100 IF NOT EQUAL
..
.          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
.          CALL      RDPRHR1
.          BRANCH    OVRCD,RPAB4100
..
.          MATCH     SP70,PRHRTACC
.          GOTO      RPAB4100 IF EQUAL
..
.          MOVE      "ta",CATEGORY
.          MOVE      PRHRTACC,CODE
.          CALL      GETCOD00
..
.          MATCH     "1",TCINDC1
.          GOTO      RPAB4100 IF EQUAL
..
.          MATCH     "2",TCINDC1
.          GOTO      RPAB4100 IF EQUAL
..
.          MATCH     "7",TCINDC1
.          GOTO      RPAB4150 IF EQUAL
..
.          MATCH     "6",TCINDC1
.          IF        @EQUAL
.            MATCH     "HIC",PMEHNAME
.            IF        @EQUAL
.              MOVE      FORM7P2C,PRECAMMP
.              COMPARE   ZERO,PRECAMFP
.              GOTO      RPAB4300 IF EQUAL
.              GOTO      RPAB4200
.            ELSE
.              MOVE      FORM7P2C,PRECAMFP
.              COMPARE   ZERO,PRECAMMP
.              GOTO      RPAB4300 IF EQUAL
.              GOTO      RPAB4200
.            ENDIF
.          ENDIF
.......
.RPAB4100  MOVE      FORM7P2C,PRECAMFP
.          GOTO      RPAB4200
..
.RPAB4150  MOVE      FORM7P2C,PRECAMMP
.          GOTO      RPAB4200
..
          MOVE      FORM7P2C,OTECAMTP
          COMPARE   ZERO,OTECAMTP
          GOTO      RPAB4300 IF EQUAL
.
RPAB4200  MOVE      SEVEN,PRECFLAG               * set status to closed
.
RPAB4300  PACK      OTECSTAT,SP1,TWO             * set closed with payment
          MOVE      OTESPDAT,OTECPDAT            * set payment date
.
          GOTO      RPAB4600
.
.RPAB4500  UNPACK    OTESCLBP,DIM7,DIM2           * set amount paid
.          PACK      DIM10,DIM7,DOT,DIM2
.          MOVE      ZERO,FORM7P2C
..
.          SCAN      "-",DIM10
.          IF        @EQUAL
.            REP        "-0",DIM10
.            MOVE       ZERO,FORM7P2C
.            MOVE       DIM10,FORM7P2C
.            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.          ELSE
.            MOVE       DIM10,FORM7P2C
.          ENDIF
......
.          MOVE      PMEDARID,DIM8
.          RJUSTIFY  DIM8
..
.          PACK      KEY22,DIM8,SP70
.          CALL      RSPRDT4
.          CALL      RKPRDT4
.          BRANCH    OVRCD,RPAB4550
..
.          MATCH     DIM8,PRDTINVN
.          GOTO      RPAB4550 IF NOT EQUAL
..
.          PACK      KEY27,DPRDTUNQ,PRDTPRAC,PRDTDOCT,PRDTCODE,SP70
.          CALL      RDPRHR1
.          BRANCH    OVRCD,RPAB4550
..
.          MATCH     SP70,PRHRTACC
.          GOTO      RPAB4550 IF EQUAL
..
.          MATCH     "1",TCINDC1
.          GOTO      RPAB4550 IF EQUAL
..
.          MATCH     "2",TCINDC1
.          GOTO      RPAB4550 IF EQUAL
..
.          MATCH     "7",TCINDC1
.          GOTO      RPAB4560 IF EQUAL
..
.          MATCH     "6",TCINDC1
.          IF        @EQUAL
.            MATCH     "HIC",PMEHNAME
.            IF        @EQUAL
.              MOVE      FORM7P2C,PRECAMMP
..             COMPARE   ZERO,PRECAMFP
..             GOTO      RPAB4600 IF EQUAL
.              GOTO      RPAB4570
.            ELSE
.              MOVE      FORM7P2C,PRECAMFP
..             COMPARE   ZERO,PRECAMMP
..             GOTO      RPAB4600 IF EQUAL
.              GOTO      RPAB4570
.            ENDIF
.          ENDIF
..
.RPAB4550  MOVE      FORM7P2C,PRECAMFP
.          GOTO      RPAB4570
..
.RPAB4560  MOVE      FORM7P2C,PRECAMMP
.          GOTO      RPAB4570
......
.RPAB4570  PACK      PRECSTAT,SP1,TWO             * set closed with payment
.          MOVE      PMEDLDAT,PRECPDAT            * set payment date
..
RPAB4600  CALL      UPOTECT6                     * update claim
.
.         Finally, write an EDI History record (pmsecaaf)
.
          MOVE      OTECINVN,OTEAINVN
          CALL      IBACLOCK
          PACK      OTEADATE,CCC,CYY,CMM,CDD
          REP       " 0",OTEADATE
          MOVE      CTIMEIS,OTEATIME
          MOVE      OTECBATN,OTEABATN
          MOVE      OTECFLAG,OTEASTAT
          MOVE      " 3",OTEATYPE
          MOVE      WBSEUID,OTEAOPER
          MOVE      OTECTRID,OTEATRID
          MOVE      SP70,OTEAEROR
          PACK      OTEAEROT,SP70
          MOVE      SP70,OTEASPAR
.
RPAB5000  PACK      KEY27,OTEAINVN,OTEADATE,OTEATIME,OTEATYPE,SP70
          CALL      RAOTECA1
          IF        OVRCD = 1
            CALL      WROTECA1
          ELSE
            CALL      IBACLOCK
            PACK      OTEADATE,CCC,CYY,CMM,CDD
            REP       " 0",OTEADATE
            MOVE      CTIMEIS,OTEATIME
            GOTO      RPAB5000
          ENDIF
.
.         Update the payment table (outerdaf) to indicate that
.         the claim payment has been released to the relevant ibaPAS tables
.
          MOVE      TWO,OTESSTAT                 * set as released
          CALL      UPOTERD3
.
.         MOVE      ONE,UNLKFLAG
.         CALL      UNLK0000                     * unlock all locked records
.
.         MOVE      PRECINVN,KEY8
.         CALL      CREM0000              * Update Un-reconciled inv.file
.
          GOTO      RPAB1000
.
.*******************************************************************************
.         Now lock all the relevant records prior to releasing the payment.
.         Check that we can lock the Health Fund receipts record.
.
RPAB6000
.         MOVE      "HFR",PRXCODE   * System Lock Audits
.         CALL      GETSLK00        * Get System Lock Audits
.
.         MOVE      PMEDARID,DIM8
.         RJUSTIFY  DIM8
.
.         PACK      KEY8,DIM8,SP70
.         CALL      RDHFRE1                      * lock record found ?
.         IF        OVRCD = 1
.           MOVE      ONE,HFRSTAT                * no - write one with lock
.           MOVE      DIM8,HFRINVR
.           CALL      WRHFRE1
.         ELSE
.           COMPARE   ZERO,HFRSTAT               * yes - is it already locked ?
.           IF        @EQUAL
.             MOVE      ONE,HFRSTAT              * no - lock now
.             CALL      UPHFRE1
.           ELSE
.             CALL      RELSLK00                 * Release System Lock Audits
.             GOTO      RPAB8000                 * record already locked
.           ENDIF
.         ENDIF
.         CALL      RELSLK00        * Release System Lock Audits
.
.         All the relevant records have been locked.
.         As there may be payments in this remittance for more than one
.         participant, check if the participant code has changed.  If it
.         has, then we need to get a new receipt number.
.
RPAB6100  
.          MATCH     SAVEPART,PARTPANT            * same participant still ?
.          IF        !@EQUAL
.
            MATCH     "1",RECPTIND
            IF        !@EQUAL
              CALL      ALLCRC00
              MOVE      "1",RECPTIND
            ENDIF        
..
.            MOVE      PARTPANT,SAVEPART          * save new participant code
.          ENDIF
.
          MOVE      HRECPT,TRECEIPT
.
          ADD       ONE,RELCOUNT
.
.         MOVE      ONE,PMECEETP
.         MATCH     "DVA",PMEDPART
.         IF        !@EQUAL
.           MOVE      ZERO,PMECEETP
.         ENDIF
.
          UNPACK    OTESCLBP,DIM7,DIM2           * set amount paid
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       ZERO,FORM7P2C
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE       DIM10,FORM7P2C
          ENDIF
.
.          MATCH     "HIC",PMEHNAME
.          IF        @EQUAL
.            MOVE      FORM7P2C,PRECAMMP
.            ASSIGN    (PRINMAMT-PRECAMMP),PRINMAMT
.          ELSE
.            MOVE      FORM7P2C,PRECAMFP
.            ASSIGN    (PRINHAMT-PRECAMFP),PRINHAMT
.          ENDIF
.
           MOVE      FORM7P2C,OTECAMTP
.
. Write to rcpbnkaf
.
          PACK      KEY12,HRECPT,SP70
          CALL      RDRCBNK1
          IF        OVRCD=1
.
            MOVE      HRECPT,RCBNRECN
            CALL      IBACLOCK
            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNTDAT
            UNPACK    OTESCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       ZERO,FORM7P2C
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE       DIM10,FORM7P2C
            ENDIF
.
            MOVE      FORM7P2C,RCBNTOTP
            MOVE      RCCNERCD,RCBNCDRW
            MOVE      RCCNERCA,RCBNCHQA
            MOVE      OTERHOSP,RCBNMHOS
.
            IF        IBCNMHOS=1
              MATCH     SP70,RCBNMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCBNMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERCD
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCD,RCBNCDRW
                  ENDIF
                  MATCH     SP70,PTHSERCA
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERCA,RCBNCHQA
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
            MOVE      CHOSPNUM,RCBNMDHS
            MOVE      "1",RCBNTTYP               * CAR 227986
.
.           MOVE      PMECHFND,RCBNRCOD
.
            MOVE      SP70,RCBNRCOD
.            MOVE      PMEDARID,DIM8
.            RJUSTIFY  DIM8
..
.            PACK      KEY22,DIM8,SP70
.            CALL      RSPRDT4
.            CALL      RKPRDT4
.            IF        OVRCD=0
.              MATCH     DIM8,PRDTINVN
.              IF        @EQUAL
.                PACK      KEY8,DPRDTUNQ,SP70
.                CALL      RDPRHD2
.                IF        OVRCD=0
.                  MOVE      PRHDHFND,RCBNRCOD
.                ENDIF
.              ENDIF
.            ENDIF
.
            MOVE      ZERO,RCBNSTAT
            MOVE      SP70,RCBNBDAT
            MOVE      SP70,RCBNBTIM
            MOVE      SP70,RCBNRDAT
            MOVE      SP70,RCBNRTIM
            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBNCDAT
            CLOCK     TIME,RCBNCTIM
            MOVE      WBSEUID,RCBNCUID
            MOVE      SP70,RCBNUDAT
            MOVE      SP70,RCBNUTIM
            MOVE      SP70,RCBNUUID
            MOVE      SP70,RCBNSPAR
.
            PACK      KEY12,HRECPT,SP70
            CALL      WRRCBNK1
.
          ELSE
.
            UNPACK    OTESCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBNTOTP
            CALL      UPRCBNK1
.
          ENDIF
.
. Write to rcpbdtaf
.
          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
          CALL      RDRCBDT1
          IF        OVRCD = 1
.
            CALL      IBACLOCK
            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDTDAT
            MOVE      HRECPT,RCBDRECN
            MOVE      "  1",RCBDUNIQ
            MOVE      OTERHOSP,RCBDMHOS
            MOVE      CHOSPNUM,RCBDMDHS
            MOVE      "4",RCBDPTYP
            CALL      DDEP0000            * Get payment code for Direct Deposit
.
            UNPACK    OTESCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
            MOVE      FORM7P2C,RCBDPAMT
.
.            MATCH     "HIC",PMEHNAME
.            IF        @EQUAL
              MOVE      "HIC",RCBDPAYD
.            ELSE
.              MOVE      PARTPANT,RCBDPAYD
.            ENDIF
.
            MOVE      SP70,RCBDCHQN
            MOVE      SP70,RCBDDRAW
            MOVE      OTERACNM,RCBDBANK
            MOVE      OTERBSBC,RCBDBRCH
            MOVE      SP70,RCBDCRDT
            MOVE      OTERPRUN,RCBDSTRF
....        MOVE      SP70,RCBDMONM                                   *D-187485
            MOVE      SP70,RCBDEFTT
            CALL      IBACLOCK
            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
            REP       " 0",RCBDCDAT
            CLOCK     TIME,RCBDCTIM
            MOVE      WBSEUID,RCBDCUID
            MOVE      SP70,RCBDUDAT
            MOVE      SP70,RCBDUTIM
            MOVE      SP70,RCBDUUID
            MOVE      SP70,RCBDSPAR
.
            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
            CALL      WRRCBDT1
.
          ELSE
.
            UNPACK    OTESCLBP,DIM7,DIM2
            PACK      DIM10,DIM7,FULLSTOP,DIM2
            MOVE      ZERO,FORM7P2C
.
            SCAN      "-",DIM10
            IF        @EQUAL
              REP        "-0",DIM10
              MOVE       DIM10,FORM7P2C
              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
            ELSE
              MOVE      DIM10,FORM7P2C
            ENDIF
.
            ADD       FORM7P2C,RCBDPAMT
            CALL      UPRCBDT1
.
          ENDIF
.
. Write to rcpdteaf

RPAB6500  PACK      KEY17,HRECPT,Z70
          CALL      RSRCDTE1
          CALL      RPRCDTE1
          IF        OVRCD = 1
            MOVE      "    1",RCDTTCNT
            CALL      WRRDB200
          ELSE
            MOVE      HRECPT,DIM12
            MATCH     DIM12,RCDTRECN
            IF        !@EQUAL
              MOVE      "    1",RCDTTCNT
              CALL      WRRDB200
            ELSE
              MOVE      RCDTTCNT,DIM5
              SQUEEZE   DIM5
              MOVE      ZERO,FORM5
              MOVE      DIM5,FORM5
              ADD       ONE,FORM5
              MOVE      FORM5,RCDTTCNT
.
              PACK      KEY17,HRECPT,RCDTTCNT,SP70
              CALL      RARCDTE1
              IF        OVRCD = 1
                CALL      WRRDB200
              ELSE
                GOTO      RPAB6500
              ENDIF
            ENDIF
          ENDIF
.
          MOVE      THREE,OTESSTAT          * set as released to suspense acc
          CALL      UPOTERD3
.
.         MOVE      THREE,UNLKFLAG
.         CALL      UNLS0000
.
          GOTO      RPAB1000
.*******************************************************************************
.
.         A record was locked for this claim, so set the status to "locked"
.
RPAB8000  MOVE      ONE,OTESSTAT
          CALL      UPOTERD3
          GOTO      RPAB1000
.
.         Check if all the payment records for the ERA were released and
.         update the ERA header status accordingly.
.
RPAB9000  IF        ERDCOUNT = (PRLCOUNT+RELCOUNT)
            MOVE      "2",OTERSTAT               * set to "released"
          ELSE
            MOVE      "1",OTERSTAT               * set to "partial"
          ENDIF
          CALL      UPOTERH1
.
          IF        IBCNMHOS=1
            MATCH     "2",OTERSTAT
            IF        @EQUAL
              CALL      CDERB200
            ENDIF
          ENDIF
.
.         Unlock general records.
.
          MATCH     "1",MULTLT01
          IF        @EQUAL
            MOVE      "2",DIM1C
            PACK      PAYMTKEY,OTERHOSP,OTERPYPN,OTERPRUN,OTERPDAT:
                               OTERRKEY,SP70
            CALL      PRNRMB00
          ENDIF
.
          MATCH     "1",OTERSTAT
          IF        @EQUAL
            MOVE      "Payment record partially released.",WEBTITLE
          ELSE
            MOVE      "Payment record released.",WEBTITLE
          ENDIF
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAB9999
.
RPAB9950  MOVE      "Payment Currently being processed.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAB9999
.
RPAB9960  MOVE      "Cannot find outerhaf record",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      RPAB9999
.
RPAB9999  RETURN
+
.*****************************************************************************
.*                              RPAB0000                                     *
.*           Release all payments for the selected Payment Report            *
.*****************************************************************************
..
..         Initialise counters
..         ERDCOUNT - is the total number of pmserdaf records associated
..                    with the selected ERA batch.
..         PRLCOUNT - is the number of pmserdaf records associated with the
..                    selected ERA batch, which have previously been "released".
..         RELCOUNT - is the number of pmserdaf records associated with the
..                    selected ERA batch for which payments have been released
..                    in this session.
..
.RPAB0000  REP       "+ ",CLMUNIID
.          REP       "+ ",PAYRUNNO
.          REP       "+ ",PAYRUNDT
.          REP       "+ ",REPRETKY
.          REP       "+ ",PROVNUMB
.          REP       "+ ",HOSPCODE
..
.          CALL      ALLCRC00
..
..         PACK      KEY45,HOSPCODE,CLMUNIID,PAYRUNNO,PAYRUNDT,REPRETKY,SP70
..         CALL      RDOTERH1
..         BRANCH    OVRCD,RPAB9960
..
.          PACK      KEY45,HOSPCODE,PAYRUNDT,SP70
.          CALL      RSOTERH2
.RPAB0010  CALL      RKOTERH2
.          BRANCH    OVRCD,RPAB9100
..
.          MATCH     HOSPCODE,OTERHOSP
.          GOTO      RPAB9100 IF NOT EQUAL
..
.          MATCH     PAYRUNDT,OTERPDAT
.          GOTO      RPAB9100 IF NOT EQUAL
..
.          MATCH     PAYRUNNO,OTERPRUN
.          GOTO      RPAB0010 IF NOT EQUAL
..
.          UNPACK    OTERRKEY,DIM8
..
.          MATCH     PROVNUMB,DIM8
.          GOTO      RPAB0010 IF NOT EQUAL
..
.          UNPACK    OTERCLBP,DIM7,DIM2           * set amount paid
.          PACK      DIM10,DIM7,DOT,DIM2
.          MOVE      ZERO,FORM7P2C
..
.          SCAN      "-",DIM10
.          IF        @EQUAL
.            REP        "-0",DIM10
.            MOVE       ZERO,FORM7P2C
.            MOVE       DIM10,FORM7P2C
.            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.          ELSE
.            MOVE       DIM10,FORM7P2C
.          ENDIF
..
..         IF        FORM7P2C = 0 | FORM7P2C < 0
.          IF        FORM7P2C = 0
.            GOTO      RPAB9000
.          ENDIF
..
..         A claim requiring payment releasing has been found, so
..         get the corresponding priectaf record and check if same hospital
..
.          MOVE      ZERO,ERASUSIN
.          PACK      KEY40,OTERTRID,SP70
.          CALL      RSOTECT6                     * position on trans. id/invoice
.          CALL      RKOTECT6                     * read next record
.          IF        OVRCD=ONE
.            CLEAR     SERDIM50
.            APPEND    OTERTRID,SERDIM50
.            APPEND    " - outectaf not found",SERDIM50
.            RESET     SERDIM50
.            GOTO      RPAB6000
.          ENDIF
..
.          MATCH     OTERTRID,OTECTRID            * same transaction id still ?
.          IF        !@EQUAL
.            CLEAR     SERDIM50
.            APPEND    OTERTRID,SERDIM50
.            APPEND    " - tran id not found",SERDIM50
.            RESET     SERDIM50
.            GOTO      RPAB6000
.          ENDIF
..
.          MATCH     "2",OTECMODL
.          IF        @EQUAL
..
.            PACK      KEY8,OTECINVN,SP70
.            RJUSTIFY  KEY8
.            CALL      RDPRIN1
.            IF        OVRCD=ONE
.              CLEAR     SERDIM50
.              APPEND    OTERTRID,SERDIM50
.            APPEND    " - priinvof record not found",SERDIM50
.            RESET     SERDIM50
.            GOTO      RPAB6000
.            ENDIF
..
.            MATCH     "1",PRINCNST
.            IF        @EQUAL
.              CLEAR     SERDIM50
.              APPEND    OTERTRID,SERDIM50
.              APPEND    "invoice is fully credited",SERDIM50
.              RESET     SERDIM50
.              GOTO      RPAB6000
.            ENDIF
..
.          ELSE
..
.            PACK      KEY8,OTECINVN,SP70
.            RJUSTIFY  KEY8
.            CALL      RDPTINV1
.            IF        OVRCD=ONE
.              CLEAR     SERDIM50
.              APPEND    OTERTRID,SERDIM50
.              APPEND    " - patinvrf record not found",SERDIM50
.              RESET     SERDIM50
.              GOTO      RPAB6000
.            ENDIF
.
..
.            MATCH     "1",PTINCRST
..           GOTO      RPAY6000 IF EQUAL
.            IF        @EQUAL
.              CLEAR     SERDIM50
.              APPEND    OTERTRID,SERDIM50
.              APPEND    "invoice is fully credited",SERDIM50
.              RESET     SERDIM50
.              GOTO      RPAB6000
.            ENDIF
..
.          ENDIF
..
..         CALL      ALLCRC00
..
..         Process the payment
..
.          UNPACK    OTERCLBP,DIM7,DIM2           * set amount paid
.          PACK      DIM10,DIM7,DOT,DIM2
.          MOVE      ZERO,FORM7P2C
..
.          SCAN      "-",DIM10
.          IF        @EQUAL
.            REP        "-0",DIM10
.            MOVE       ZERO,FORM7P2C
.            MOVE       DIM10,FORM7P2C
.            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.          ELSE
.            MOVE       DIM10,FORM7P2C
.          ENDIF
..            
.          MOVE      FORM7P2C,OTECAMTP
..
.          CALL      IBACLOCK                     * get current date
.          PACK      CURRDATE,CCC,CYY,CMM,CDD
.          REP       " 0",CURRDATE
.          MOVE      CTIMEIS,CURRTIME
..           
.. Write to rcpbnkaf
..
.          PACK      KEY12,HRECPT,SP70
.          CALL      RDRCBNK1
.          IF        OVRCD=1
..
.            MOVE      HRECPT,RCBNRECN
.            CALL      IBACLOCK
.            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
.            REP       " 0",RCBNTDAT
.            UNPACK    OTERCLBP,DIM7,DIM2
.            PACK      DIM10,DIM7,FULLSTOP,DIM2
.            MOVE      ZERO,FORM7P2C
..
.            SCAN      "-",DIM10
.            IF        @EQUAL
.              REP        "-0",DIM10
.              MOVE       ZERO,FORM7P2C
.              MOVE       DIM10,FORM7P2C
.              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.            ELSE
.              MOVE       DIM10,FORM7P2C
.            ENDIF
..
.            MOVE      FORM7P2C,RCBNTOTP
.            MOVE      RCCNERCD,RCBNCDRW
.            MOVE      RCCNERCA,RCBNCHQA
.            MOVE      OTERHOSP,RCBNMHOS
..
.            IF        IBCNMHOS=1
.              MATCH     SP70,RCBNMHOS
.              IF        !@EQUAL & !@EOS
.                PACK      KEY3,RCBNMHOS,SP70
.                CALL      RDPTHSP1
.                IF        OVRCD=0
.                  MATCH     SP70,PTHSERCD
.                  IF        !@EQUAL & !@EOS
.                    MOVE      PTHSERCD,RCBNCDRW
.                  ENDIF
.                  MATCH     SP70,PTHSERCA
.                  IF        !@EQUAL & !@EOS
.                    MOVE      PTHSERCA,RCBNCHQA
.                  ENDIF
.                ENDIF
.              ENDIF
.            ENDIF
..
.            MOVE      CHOSPNUM,RCBNMDHS
..
.            MOVE      "3",RCBNTTYP
.            MOVE      SP70,RCBNRCOD
..
.            MOVE      ZERO,RCBNSTAT
.            MOVE      SP70,RCBNBDAT
.            MOVE      SP70,RCBNBTIM
.            MOVE      SP70,RCBNRDAT
.            MOVE      SP70,RCBNRTIM
.            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
.            REP       " 0",RCBNCDAT
.            CLOCK     TIME,RCBNCTIM
.            MOVE      WBSEUID,RCBNCUID
.            MOVE      SP70,RCBNUDAT
.            MOVE      SP70,RCBNUTIM
.            MOVE      SP70,RCBNUUID
.            MOVE      SP70,RCBNSPAR
..
.            PACK      KEY12,HRECPT,SP70
.            CALL      WRRCBNK1
..
.          ELSE
..
.            UNPACK    OTERCLBP,DIM7,DIM2
.            PACK      DIM10,DIM7,FULLSTOP,DIM2
.            MOVE      ZERO,FORM7P2C
..
.            SCAN      "-",DIM10
.            IF        @EQUAL
.              REP        "-0",DIM10
.              MOVE       DIM10,FORM7P2C
.              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.            ELSE
.              MOVE      DIM10,FORM7P2C
.            ENDIF
..
.            ADD       FORM7P2C,RCBNTOTP
.            CALL      UPRCBNK1
..
.          ENDIF
..
.. Write to rcpbdtaf
..
.          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
.          CALL      RDRCBDT1
.          IF        OVRCD = 1
..
.            CALL      IBACLOCK
.            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
.            REP       " 0",RCBDTDAT
.            MOVE      HRECPT,RCBDRECN
.            MOVE      "  1",RCBDUNIQ
.            MOVE      OTERHOSP,RCBDMHOS
.            MOVE      CHOSPNUM,RCBDMDHS
.            MOVE      "4",RCBDPTYP
.            CALL      DDEP0000            * Get payment code for Direct Deposit
..
.            UNPACK    OTERCLBP,DIM7,DIM2
.            PACK      DIM10,DIM7,FULLSTOP,DIM2
.            MOVE      ZERO,FORM7P2C
..
.            SCAN      "-",DIM10
.            IF        @EQUAL
.              REP        "-0",DIM10
.              MOVE       DIM10,FORM7P2C
.              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.            ELSE
.              MOVE      DIM10,FORM7P2C
.            ENDIF
.            MOVE      FORM7P2C,RCBDPAMT
..
.            MOVE      "HIC",RCBDPAYD
..         
.            MOVE      SP70,RCBDCHQN
.            MOVE      "MEDICARE",RCBDDRAW
.            MOVE      OTERACNM,RCBDBANK
.            MOVE      OTERBSBC,RCBDBRCH
.            MOVE      SP70,RCBDCRDT
.            MOVE      OTERPRUN,RCBDSTRF
.....        MOVE      SP70,RCBDMONM                                   *D-187485
.            MOVE      SP70,RCBDEFTT
.            CALL      IBACLOCK
.            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
.            REP       " 0",RCBDCDAT
.            CLOCK     TIME,RCBDCTIM
.            MOVE      WBSEUID,RCBDCUID
.            MOVE      SP70,RCBDUDAT
.            MOVE      SP70,RCBDUTIM
.            MOVE      SP70,RCBDUUID
.            MOVE      SP70,RCBDSPAR
..
.            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
.            CALL      WRRCBDT1
..
.          ELSE
..
.            UNPACK    OTERCLBP,DIM7,DIM2
.            PACK      DIM10,DIM7,FULLSTOP,DIM2
.            MOVE      ZERO,FORM7P2C
..
.            SCAN      "-",DIM10
.            IF        @EQUAL
.              REP        "-0",DIM10
.              MOVE       DIM10,FORM7P2C
.              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.            ELSE
.              MOVE      DIM10,FORM7P2C
.            ENDIF
..
.            ADD       FORM7P2C,RCBDPAMT
.            CALL      UPRCBDT1
..
.          ENDIF
..        
.. Write to rcpdteaf
..
.RPAB3500  PACK      KEY17,HRECPT,Z70
.          CALL      RSRCDTE1
.          CALL      RPRCDTE1
.          IF        OVRCD = 1
.            MOVE      "    1",RCDTTCNT
.            CALL      WRRDB100
.          ELSE
.            MOVE      HRECPT,DIM12
.            MATCH     DIM12,RCDTRECN
.            IF        !@EQUAL
.              MOVE      "    1",RCDTTCNT
.              CALL      WRRDB100
.            ELSE
.              MOVE      RCDTTCNT,DIM5
.              SQUEEZE   DIM5
.              MOVE      ZERO,FORM5
.              MOVE      DIM5,FORM5
.              ADD       ONE,FORM5
.              MOVE      FORM5,RCDTTCNT
..
.              PACK      KEY17,HRECPT,RCDTTCNT,SP70
.              CALL      RARCDTE1
.              IF        OVRCD = 1
.                CALL      WRRDB100
.              ELSE
.                GOTO      RPAB3500
.              ENDIF
.            ENDIF
.          ENDIF
..
..         Now "close" the current claim
..
.          UNPACK    OTERCLBP,DIM7,DIM2           * set amount paid
.          PACK      DIM10,DIM7,DOT,DIM2
.          MOVE      ZERO,FORM7P2C
..
.          SCAN      "-",DIM10
.          IF        @EQUAL
.            REP        "-0",DIM10
.            MOVE       ZERO,FORM7P2C
.            MOVE       DIM10,FORM7P2C
.            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.          ELSE
.            MOVE       DIM10,FORM7P2C
.          ENDIF
..
.          MOVE      FORM7P2C,OTECAMTP
.          COMPARE   ZERO,OTECAMTP
.          GOTO      RPAB4300 IF EQUAL
..
.RPAB4200  MOVE      SEVEN,OTECFLAG                * set status to closed
..
.RPAB4300  PACK      OTECSTAT,SP1,TWO             * set closed with payment
.          MOVE      OTERPDAT,OTECPDAT            * set payment date
..
.RPAB4600  CALL      UPOTECT6                     * update claim
..
..         Finally, write an EDI History record (outecaaf)
..           
.          MOVE      OTECINVN,OTEAINVN
.          CALL      IBACLOCK
.          PACK      OTEADATE,CCC,CYY,CMM,CDD
.          REP       " 0",OTEADATE
.          MOVE      CTIMEIS,OTEATIME
.          MOVE      OTECBATN,OTEABATN
.          MOVE      OTECFLAG,OTEASTAT
.          MOVE      " 3",OTEATYPE
.          MOVE      WBSEUID,OTEAOPER
.          MOVE      OTECTRID,OTEATRID
.          MOVE      SP4,OTEAEROR
.          MOVE      SP70,OTEAEROT
.          MOVE      SP30,OTEASPAR
..              
.RPAB5000  PACK      KEY27,OTEAINVN,OTEADATE,OTEATIME,OTEATYPE,SP70
.          CALL      RAOTECA1
.          IF        OVRCD = 1
.            CALL      WROTECA1
.          ELSE
.            CALL      IBACLOCK
.            PACK      OTEADATE,CCC,CYY,CMM,CDD
.            REP       " 0",OTEADATE
.            MOVE      CTIMEIS,OTEATIME
.            GOTO      RPAB5000
.          ENDIF
..
.          GOTO      RPAB9000
..
..*******************************************************************************
..         
..         Suspense Register Receipts
.. 
.RPAB6000
..
.RPAB6100  CALL      ALLCRC00
..
.          MOVE      HRECPT,TRECEIPT
..
.          UNPACK    OTERCLBP,DIM7,DIM2           * set amount paid
.          PACK      DIM10,DIM7,DOT,DIM2
.          MOVE      ZERO,FORM7P2C
..         
.          SCAN      "-",DIM10
.          IF        @EQUAL
.            REP        "-0",DIM10
.            MOVE       ZERO,FORM7P2C
.            MOVE       DIM10,FORM7P2C
.            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.          ELSE
.            MOVE       DIM10,FORM7P2C
.          ENDIF
..
.          MOVE      FORM7P2C,OTECAMTP
..
.. Write to rcpbnkaf
..            
.          PACK      KEY12,HRECPT,SP70
.          CALL      RDRCBNK1
.          IF        OVRCD=1
..
.            MOVE      HRECPT,RCBNRECN
.            CALL      IBACLOCK
.            PACK      RCBNTDAT,CCC,CYY,CMM,CDD
.            REP       " 0",RCBNTDAT
.            UNPACK    OTERCLBP,DIM7,DIM2
.            PACK      DIM10,DIM7,FULLSTOP,DIM2
.            MOVE      ZERO,FORM7P2C
..
.            SCAN      "-",DIM10
.            IF        @EQUAL
.              REP        "-0",DIM10
.              MOVE       ZERO,FORM7P2C
.              MOVE       DIM10,FORM7P2C
.              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.            ELSE
.              MOVE       DIM10,FORM7P2C
.            ENDIF
..          
.            MOVE      FORM7P2C,RCBNTOTP
.            MOVE      RCCNERCD,RCBNCDRW
.            MOVE      RCCNERCA,RCBNCHQA
.            MOVE      OTERHOSP,RCBNMHOS
..
.            IF        IBCNMHOS=1
.              MATCH     SP70,RCBNMHOS
.              IF        !@EQUAL & !@EOS
.                PACK      KEY3,RCBNMHOS,SP70
.                CALL      RDPTHSP1
.                IF        OVRCD=0
.                  MATCH     SP70,PTHSERCD
.                  IF        !@EQUAL & !@EOS
.                    MOVE      PTHSERCD,RCBNCDRW
.                  ENDIF
.                  MATCH     SP70,PTHSERCA
.                  IF        !@EQUAL & !@EOS
.                    MOVE      PTHSERCA,RCBNCHQA
.                  ENDIF
.                ENDIF
.              ENDIF
.            ENDIF
..
.            MOVE      CHOSPNUM,RCBNMDHS
.            MOVE      "1",RCBNTTYP               * CAR 227986
..
.            MOVE      SP70,RCBNRCOD
..
.            MOVE      ZERO,RCBNSTAT
.            MOVE      SP70,RCBNBDAT
.            MOVE      SP70,RCBNBTIM
.            MOVE      SP70,RCBNRDAT
.            MOVE      SP70,RCBNRTIM
.            PACK      RCBNCDAT,CCC,CYY,CMM,CDD
.            REP       " 0",RCBNCDAT
.            CLOCK     TIME,RCBNCTIM
.            MOVE      WBSEUID,RCBNCUID
.            MOVE      SP70,RCBNUDAT
.            MOVE      SP70,RCBNUTIM
.            MOVE      SP70,RCBNUUID
.            MOVE      SP70,RCBNSPAR
..
.            PACK      KEY12,HRECPT,SP70
.            CALL      WRRCBNK1
..
.          ELSE
..            
.            UNPACK    OTERCLBP,DIM7,DIM2
.            PACK      DIM10,DIM7,FULLSTOP,DIM2
.            MOVE      ZERO,FORM7P2C
..
.            SCAN      "-",DIM10
.            IF        @EQUAL
.              REP        "-0",DIM10
.              MOVE       DIM10,FORM7P2C
.              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.            ELSE
.              MOVE      DIM10,FORM7P2C
.            ENDIF
..
.            ADD       FORM7P2C,RCBNTOTP
.            CALL      UPRCBNK1
..
.          ENDIF
..          
.. Write to rcpbdtaf
..
.          PACK      KEY15,HRECPT,SP1,SP1,ONE,SP70
.          CALL      RDRCBDT1
.          IF        OVRCD = 1
..
.            CALL      IBACLOCK
.            PACK      RCBDTDAT,CCC,CYY,CMM,CDD
.            REP       " 0",RCBDTDAT
.            MOVE      HRECPT,RCBDRECN
.            MOVE      "  1",RCBDUNIQ
.            MOVE      OTERHOSP,RCBDMHOS
.            MOVE      CHOSPNUM,RCBDMDHS
.            MOVE      "4",RCBDPTYP
.            CALL      DDEP0000            * Get payment code for Direct Deposit
..
.            UNPACK    OTERCLBP,DIM7,DIM2
.            PACK      DIM10,DIM7,FULLSTOP,DIM2
.            MOVE      ZERO,FORM7P2C
..
.            SCAN      "-",DIM10
.            IF        @EQUAL
.              REP        "-0",DIM10
.              MOVE       DIM10,FORM7P2C
.              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.            ELSE
.              MOVE      DIM10,FORM7P2C
.            ENDIF
.            MOVE      FORM7P2C,RCBDPAMT
..
.            MOVE      "HIC",RCBDPAYD
..
.            MOVE      SP70,RCBDCHQN
.            MOVE      SP70,RCBDDRAW
.            MOVE      OTERACNM,RCBDBANK
.            MOVE      OTERBSBC,RCBDBRCH
.            MOVE      SP70,RCBDCRDT
.            MOVE      OTERPRUN,RCBDSTRF
.....        MOVE      SP70,RCBDMONM                                   *D-187485
.            MOVE      SP70,RCBDEFTT
.            CALL      IBACLOCK
.            PACK      RCBDCDAT,CCC,CYY,CMM,CDD
.            REP       " 0",RCBDCDAT
.            CLOCK     TIME,RCBDCTIM
.            MOVE      WBSEUID,RCBDCUID
.            MOVE      SP70,RCBDUDAT
.            MOVE      SP70,RCBDUTIM
.            MOVE      SP70,RCBDUUID
.            MOVE      SP70,RCBDSPAR
..
.            PACK      KEY15,HRECPT,RCBDUNIQ,SP70
.            CALL      WRRCBDT1
..
.          ELSE
..
.            UNPACK    OTERCLBP,DIM7,DIM2
.            PACK      DIM10,DIM7,FULLSTOP,DIM2
.            MOVE      ZERO,FORM7P2C
..
.            SCAN      "-",DIM10
.            IF        @EQUAL
.              REP        "-0",DIM10
.              MOVE       DIM10,FORM7P2C
.              ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.            ELSE
.              MOVE      DIM10,FORM7P2C
.            ENDIF
..
.            ADD       FORM7P2C,RCBDPAMT
.            CALL      UPRCBDT1
..
.          ENDIF
..          
.. Write to rcpdteaf
..
.RPAB6500  PACK      KEY17,HRECPT,Z70
.          CALL      RSRCDTE1
..          CALL      RPRCDTE1
.          IF        OVRCD = 1
.            MOVE      "    1",RCDTTCNT
.            CALL      WRRDB200
.          ELSE
.            MOVE      HRECPT,DIM12
.            MATCH     DIM12,RCDTRECN
.            IF        !@EQUAL
.              MOVE      "    1",RCDTTCNT
.              CALL      WRRDB200
.            ELSE
.              MOVE      RCDTTCNT,DIM5
.              SQUEEZE   DIM5
.              MOVE      ZERO,FORM5
.              MOVE      DIM5,FORM5
.              ADD       ONE,FORM5
.              MOVE      FORM5,RCDTTCNT
..
.              PACK      KEY17,HRECPT,RCDTTCNT,SP70
.              CALL      RARCDTE1
.              IF        OVRCD = 1
.                CALL      WRRDB200
.              ELSE
.                GOTO      RPAB6500
.              ENDIF
.            ENDIF
.          ENDIF
..
.          MOVE      "3",OTERSTAT                 * Set to released to suspense
.          CALL      UPOTERH2
..
.          IF        IBCNMHOS=1
.            CALL      CDERB100
.          ENDIF
..
.          GOTO      RPAB0010
..
..         Check if all the payment records for the ERA were released and
..         update the ERA header status accordingly.
..         
.RPAB9000  MOVE      "1",OTERSTAT               * set to "released"
.          CALL      UPOTERH2
..
.          IF        IBCNMHOS=1
.            CALL      CDERB200
.          ENDIF
..
.          GOTO      RPAB0010
..
..         Unlock general records.
..          
.RPAB9100  
..         MATCH     "1",MULTLT01
..         IF        @EQUAL
..           MOVE      "2",DIM1C
..           PACK      PAYMTKEY,OTERHOSP,OTERPYPN,OTERPRUN,OTERPDAT:
..                              OTERRKEY,SP70
..           CALL      PRNRMB00
..         ENDIF
..
..         MATCH     "3",OTERSTAT
..         IF        @EQUAL
..           MOVE      "Payment record released to suspense register.",WEBTITLE
..         ELSE
.            MOVE      "Payment record released.",WEBTITLE
..         ENDIF
.          CALL      WEBERR00
.          MOVE      ONE,EXIT
.          GOTO      RPAB9999
..
.RPAB9960  MOVE      "Cannot find outerhaf record",WEBTITLE
.          CALL      WEBERR00
.          MOVE      ONE,EXIT
.          GOTO      RPAB9999
..
.RPAB9999  RETURN
+
.---------------------------------------------------------------------------
.         WRRDB100 - Write to rcpdteaf
.---------------------------------------------------------------------------
.
WRRDB100  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.           
          PACK      RCDTINVN,OTECINVN,SP70
          RJUSTIFY  RCDTINVN
          MOVE      OTECUNIQ,RCDTVIST
          MOVE      OTECURNO,RCDTURNO
          MOVE      OTECURNO,KEY8
          CALL      RDMAST1
          IF        OVRCD = 0
            MOVE      PSNAME,PACSNAME
            MOVE      PGNAME,PACGNAME
            MOVE      PTITL,PACTITLE
            MOVE      TWO,PACFRMT
            CALL      PACNAME
            MOVE      PACFNAME,RCDTNAME
            MOVE      PADD1,RCDTADD1
            MOVE      PADD2,RCDTADD2
            MOVE      PSUBRB,RCDTADD3
            MOVE      PADD4,RCDTADD4
            MOVE      PPOST,RCDTPOST
          ELSE
            MOVE      SP70,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
          ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      OTERPRUN,RCDTREFR
          MOVE      OTECHOSP,RCDTMHOS
.
          MOVE      SP70,RCDTREGI
.
          MATCH     "2",OTECMODL
          IF        @EQUAL
.
            MOVE      OTECINVN,DIM8
            RJUSTIFY  DIM8
.
            PACK      KEY22,DIM8,SP70
            CALL      RSPRDT4
            CALL      RKPRDT4
            IF        OVRCD=0
              MATCH     DIM8,PRDTINVN
              IF        @EQUAL
                PACK      KEY27,PRDTUNIQ,PRDTPRAC,PRDTDOCT,PRDTCODE,Sp70
                CALL      RDPRHR1
                IF        OVRCD=0
                  MATCH     SP70,PRHRPRAC
                  IF        !@EQUAL
                    PACK      KEY6,PRHRPRAC,SP70
                    CALL      RDPRPR1
                    IF        OVRCD=0
                      MOVE      PRPRREGI,RCDTREGI
                      MATCH     SP70,PRPRREGI
                      IF        !@EQUAL
                        PACK      KEY3,PRPRREGI,SP70
                        CALL      RDREGA1
                        IF        OVRCD=0
                          MATCH     SP70,REGHOSP
                          IF        !@EQUAL
                            MOVE      REGHOSP,RCDTMHOS
                          ENDIF
                        ENDIF
                      ENDIF
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
          ELSE
.
            MOVE      RCCNERRE,RCDTREGI
            IF        IBCNMHOS=1
.  
              MATCH     SP70,RCDTMHOS
              IF        !@EQUAL & !@EOS
                PACK      KEY3,RCDTMHOS,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SP70,PTHSERRE
                  IF        !@EQUAL & !@EOS
                    MOVE      PTHSERRE,RCDTREGI
                  ENDIF
                ENDIF
              ENDIF
.
              PACK      KEY8,OTECUNIQ,SP70
              CALL      RDPMVX11
              IF        OVRCD=0
                MATCH     SP70,PMVXMHOS
                IF        !@EQUAL & !@EOS
                  PACK      KEY3,PMVXMHOS,SP70
                  CALL      RDPTHSP1
                  IF        OVRCD=0
                    MATCH     SP70,PTHSERRE
                    IF        !@EQUAL & !@EOS
                      MOVE      PTHSERRE,RCDTREGI
                      MOVE      PMVXMHOS,RCDTMHOS
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
.
          ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCT00
.
          UNPACK    OTESCLBP,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      SP70,RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      OTECBATN,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDB199  RETURN
+
.---------------------------------------------------------------------------
.         WRRDB200 - Write to rcpdteaf suspense account
.---------------------------------------------------------------------------
.
WRRDB200  CALL      IBACLOCK
          PACK      RCDTTDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTTDAT
          MOVE      HRECPT,RCDTRECN
.         MOVE      "    1",RCDTTCNT
.         MOVE      PMEDARID,RCDTINVN
.         PACK      RCDTINVN,PMEDARID,SP70
.         RJUSTIFY  RCDTINVN
          MOVE      SP70,RCDTINVN
          MOVE      SP70,RCDTVIST
          MOVE      SP70,RCDTURNO
.         MOVE      PMECURNO,KEY8
.         CALL      RDMAST1
.         IF        OVRCD = 0
.           MOVE      PSNAME,PACSNAME
.           MOVE      PGNAME,PACGNAME
.           MOVE      PTITL,PACTITLE
.           MOVE      TWO,PACFRMT
.           CALL      PACNAME
.           MOVE      PACFNAME,RCDTNAME
.           MOVE      PADD1,RCDTADD1
.           MOVE      PADD2,RCDTADD2
.           MOVE      PSUBRB,RCDTADD3
.           MOVE      PADD4,RCDTADD4
.           MOVE      PPOST,RCDTPOST
.         ELSE
            REP       "#" ",SERDIM50
            MOVE      SERDIM50,RCDTNAME
            MOVE      SP70,RCDTADD1
            MOVE      SP70,RCDTADD2
            MOVE      SP70,RCDTADD3
            MOVE      SP70,RCDTADD4
            MOVE      SP70,RCDTPOST
.         ENDIF
          MOVE      SP70,RCDTSFLG
          MOVE      OTERPRUN,RCDTREFR
          MOVE      OTERHOSP,RCDTMHOS
.
          MOVE      RCCNERRS,RCDTREGI
.         IF        IBCNMHOS=1
.           MATCH     SP70,RCDTMHOS
.           IF        !@EQUAL & !@EOS
.             PACK      KEY3,RCDTMHOS,SP70
.             CALL      RDPTHSP1
.             IF        OVRCD=0
.               MATCH     SP70,PTHSERRE
.               IF        !@EQUAL & !@EOS
.                 MOVE      PTHSERRE,RCDTREGI
.               ENDIF
.             ENDIF
.           ENDIF
.         ENDIF
.
          MOVE      SP70,RCDTGSTC
          CALL      GTACCT00
.
          MOVE      SP70,DIM2
          MOVE      SP70,DIM7
          MOVE      SP70,DIM10
.
          UNPACK    OTESCLBP,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      ZERO,FORM7P2C
.
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
          MOVE      FORM7P2C,RCDTAMNT
.
          MOVE      ZERO,RCDTDISC
          MOVE      CHOSPNUM,RCDTMDHS
          MOVE      SP70,RCDTGSTA
          MOVE      "2",RCDTALLO
          CALL      IBACLOCK
.         PACK      RCDTRELD,CCC,CYY,CMM,CDD
.         REP       " 0",RCDTRELD
.         MOVE      CTIMEIS,RCDTRELT
          MOVE      SP70,RCDTRELD
          MOVE      SP70,RCDTRELT
          PACK      RCDTCDAT,CCC,CYY,CMM,CDD
          REP       " 0",RCDTCDAT
          MOVE      SP70,RCDTPRAC
          MOVE      CTIMEIS,RCDTCTIM
          MOVE      WBSEUID,RCDTCUID
          MOVE      SP70,RCDTUDAT
          MOVE      SP70,RCDTUTIM
          MOVE      SP70,RCDTUUID
          MOVE      SP70,RCDTDPTY
          MOVE      SP70,RCDTGLEX
          MOVE      SP70,RCDTBATN
          MOVE      SP70,RCDTSPAR
.
          PACK      KEY17,RCDTRECN,RCDTTCNT,SP70
          CALL      WRRCDTE1
.
WRRDB299  RETURN
.
.-------------------------------------------------------------------
.Check for duplicate remittance in multi hospital remittance release
.-------------------------------------------------------------------
.CDERB100  PACK      SAVKEY45,OTERHOSP,OTERPDAT,OTERCLID,OTERPRUN,OTERRKEY,SP70
.
.          PACK      KEY45,SP3,OTERCLID,OTERPRUN,OTERPDAT,OTERRKEY,SP70
.          CALL      RDOTERH1
.          BRANCH    OVRCD,CDERB190
..
.          MOVE      "3",OTERSTAT
..
.          CALL      UPOTERH1
..
.CDERB190  MOVE      SAVKEY45,KEY45
.          CALL      RDOTERH2
..
.CDERB199  RETURN
..
.-------------------------------------------------------------------
.Check for duplicate remittance in multi hospital remittance release
.-------------------------------------------------------------------
CDERB200  PACK      SAVKEY47,OTERHOSP,OTERPYPN,OTERPRUN,OTERPDAT,OTERRKEY,SP70
.
          PACK      KEY47,SP3,OTERPYPN,OTERPRUN,OTERPDAT,OTERRKEY,SP70
          CALL      RDOTERH1
          BRANCH    OVRCD,CDERB290
.
          MOVE      "2",OTERSTAT
.
          CALL      UPOTERH1
.
CDERB290  MOVE      SAVKEY47,KEY47
          CALL      RDOTERH1
.
CDERB299  RETURN
+
.------------------------------------------------------------
. Eclipse DBS Payment Report Enquiry tags
.------------------------------------------------------------
ERLB0000  BRANCH    FLDITMNO,ERLB0100,ERLB0200,ERLB0300,ERLB0400,ERLB0500:
                             ERLB0600,ERLB0700,ERLB0800,ERLB0900,ERLB1000:
                             ERLB1100,ERLB1200,ERLB1300,ERLB1400,ERLB1500:
                             ERLB1600,ERLB1700,ERLB1800,ERLB1900,ERLB2000:
                             ERLB2100,ERLB2200,ERLB2300,ERLB2400,ERLB2500:
                             ERLB2600,ERLB2700,ERLB2800,ERLB2900,ERLB3000:
                             ERLB3100,ERLB3200,ERLB3300,ERLB3400,ERLB3500:
                             ERLB3600,ERLB3700,ERLB3800,ERLB3900,ERLB4000
.
          GOTO      ERLB9999
.
ERLB0100  UNPACK    DIM127,D1,UNRELREM,DIM127
          UNPACK    DIM127,D1,UNRELINQ,DIM127
          UNPACK    DIM127,D1,ERASTATS,DIM127
.
          CALL      ERTB0000
          GOTO      ERLB9999
.
ERLB0200  CALL      ERDD0000
          GOTO      ERLB9999
.
ERLB0300  WRITE     HTMLFILE;OTERPYPN;
          GOTO      ERLB9999
.
ERLB0400  WRITE     HTMLFILE;OTERPRUN;
          GOTO      ERLB9999
.
ERLB0500  MATCH     SP70,OTERPDAT
          GOTO      ERLB9999 IF EQUAL
          UNPACK    OTERPDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLB9999
.
ERLB0600  UNPACK    OTERDAMN,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLB9999
.
ERLB0700  WRITE     HTMLFILE;OTERBSBC;
          GOTO      ERLB9999
.
ERLB0800  WRITE     HTMLFILE;OTERACCN;
          GOTO      ERLB9999
.
ERLB0900  WRITE     HTMLFILE;OTERACNM;
          GOTO      ERLB9999
.
ERLB1000  MATCH     SP70,OTESCDAT
          GOTO      ERLB9999 IF EQUAL
          UNPACK    OTESCDAT,CCENT,CYEAR,CMON,CDAY
          MOVE      CMON,F2
          LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
          WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLB9999
.
ERLB1100  UNPACK    OTESCLBP,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLB9999
.
ERLB1200  UNPACK    OTESCLCA,DIM7,DIM2
          PACK      DIM10,DIM7,FULLSTOP,DIM2
          MOVE      DIM10,FORM7P2C
          WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLB9999
.
ERLB1300  
.         UNPACK    OTERDAMN,DIM7,DIM2
.         PACK      DIM10,DIM7,FULLSTOP,DIM2
.         MOVE      DIM10,FORM7P2C
.         WRITE     HTMLFILE;FORM7P2C;
.         GOTO      ERLB9999
.
ERLB1400  WRITE     HTMLFILE;OTESTRID;
          GOTO      ERLB9999
.
ERLB1500  MATCH     "0",OTERSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "1",OTERSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "2",OTERSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "3",OTERSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense Register";
            GOTO      ERLB9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLB9999
.
ERLB1600  CALL      GCMS0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLB9999
.
ERLB1700  CALL      GCMB0000
          WRITE     HTMLFILE;CLAMTOTL;
          GOTO      ERLB9999
.
ERLB1800  
.         WRITE     HTMLFILE;PMEDRADV;
          GOTO      ERLB9999
.
ERLB1900  
.         WRITE     HTMLFILE;PMEDPNUM;
          GOTO      ERLB9999
.
ERLB2000  
.         WRITE     HTMLFILE;PMEDTRID;
          GOTO      ERLB9999
.
ERLB2100  
.         WRITE     HTMLFILE;PMEDARID;
          GOTO      ERLB9999
.
ERLB2200  
.         UNPACK    PMEDBAMT,DIM7,DIM2
.         PACK      DIM10,DIM7,FULLSTOP,DIM2
..        MOVE      DIM10,FORM7P2C
.         MOVE      ZERO,FORM7P2C
.         SCAN      "-",DIM10
.         IF        @EQUAL
.           REP        "-0",DIM10
.           MOVE       DIM10,FORM7P2C
.           ASSIGN     (FORM7P2C*SEQ),FORM7P2C
.         ELSE
.           MOVE      DIM10,FORM7P2C
.         ENDIF
.         WRITE     HTMLFILE;FORM7P2C;
          GOTO      ERLB9999
.
ERLB2300  
.         WRITE     HTMLFILE;PMEDCCOD;
          GOTO      ERLB9999
.
ERLB2400  
.         MATCH     SP70,PMEDLDAT
.         GOTO      ERLB9999 IF EQUAL
.         UNPACK    PMEDLDAT,CCENT,CYEAR,CMON,CDAY
.         MOVE      CMON,F2
.         LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.         WRITE     HTMLFILE;CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR;
          GOTO      ERLB9999
.
ERLB2500  
.         WRITE     HTMLFILE;PMEDPARI;
          GOTO      ERLB9999
.
ERLB2600  
.         WRITE     HTMLFILE;PMEDPTID;
          GOTO      ERLB9999
.          
ERLB2700  
.         MATCH     "0",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Received";
.           GOTO      ERLB9999
.         ENDIF
.
.         MATCH     "1",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Locked";
.           GOTO      ERLB9999
.         ENDIF
.
.         MATCH     "2",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Released";
.           GOTO      ERLB9999
.         ENDIF
.
.         MATCH     "3",PMEDSTAT
.         IF        @EQUAL
.           WRITE     HTMLFILE;"Released - Suspense";
.           GOTO      ERLB9999
.         ENDIF
.
.          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLB9999
.
ERLB2800  
.         UNPACK    DIM127,D1,DIM1,DIM127
.         MOVE      ZERO,FORM1
.         MOVE      DIM1,FORM1
.         BRANCH    FORM1,ERLB2810
.
.         WRITE     HTMLFILE;PARTCODE;
          GOTO      ERLB9999
.
ERLB2810  
.         PACK      KEY3,PARTCODE,SP70
.         CALL      RDPTPAR1
.         BRANCH    OVRCD,ERLB9999
.
.         WRITE     HTMLFILE;PTPRNAME;
.         GOTO      ERLB9999
.
ERLB2900  WRITE     HTMLFILE;HOSPCODE,ECREPYPN,ECREPRUN,ECREPDAT,ECRERKEY;
          GOTO      ERLB9999
.
ERLB3000  CALL      SELP0000
          GOTO      ERLB9999
.
ERLB3100  CALL      PRVR0000
          GOTO      ERLB9999
.
ERLB3200  CALL      NXTR0000
          GOTO      ERLB9999
.
ERLB3300  WRITE     HTMLFILE;VIEWTYPE;
          GOTO      ERLB9999
.
ERLB3400  WRITE     HTMLFILE;EXDTBLNK;
          GOTO      ERLB9999
.
ERLB3500  CALL      HSPSEL00
          GOTO      ERLB9999
.
ERLB3600  WRITE     HTMLFILE;OTERRKEY;
          GOTO      ERLB9999
.
ERLB3700  WRITE     HTMLFILE;OTESCLID;
          GOTO      ERLB9999
.
ERLB3800  WRITE     HTMLFILE;OTESRKEY;
          GOTO      ERLB9999
.
ERLB3900  MATCH     "0",OTESSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Received";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "1",OTESSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Locked";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "2",OTESSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released";
            GOTO      ERLB9999
          ENDIF
.
          MATCH     "3",OTESSTAT
          IF        @EQUAL
            WRITE     HTMLFILE;"Released - Suspense Register";
            GOTO      ERLB9999
          ENDIF
.
          WRITE     HTMLFILE;"Unknown";
.
          GOTO      ERLB9999
.
ERLB4000  PACK      KEY20,OTERPYPN,SP70
          CALL      RSPMHCP3
          CALL      RKPMHCP3 
          BRANCH    OVRCD,ERLB4100
.
          PACK      DIM10,OTERPYPN,SP70
          MATCH     DIM10,PMHCPRV1
          GOTO      ERLB4100 IF NOT EQUAL
.
          MOVE      PMHCTITL,FMTTITLE             * Got them - set up name flds
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                      * Format name
.
          WRITE     HTMLFILE;DOCFNAME;
          GOTO      ERLB9999
.
ERLB4100  WRITE     HTMLFILE;OTERPYPN;
          GOTO      ERLB9999 
.
ERLB9999  RETURN
+
.------------------------------------------------------------
. Get claim amount for a specific transaction id
.------------------------------------------------------------
GCMB0000  MOVE      ZERO,CLAMTOTL
.
          MATCH     "1",PTCNUEBB
          GOTO      GCMB9999 IF NOT EQUAL
.
          PACK      KEY40,OTESTRID,SP30,SP10
          CALL      RSOTECT6                     * position on trans. id
          CALL      RKOTECT6                     * read next record
          BRANCH    OVRCD,GCMB9999                * eof - not found
.
          MATCH     OTESTRID,OTECTRID            * same transaction id still ?
          GOTO      GCMB9999 IF NOT EQUAL        * no - not found
.
          MOVE      OTECAMTC,CLAMTOTL            * update ERA claim total
.
GCMB9999  RETURN
+
.***************************************************************************
.*                             ERTB0000                                    *
.*   Set the hospital filter and call ERTD0000                             *
.*   If multi hospital call ERTD0000 for each of the users hositals        *
.***************************************************************************
ERTB0000  IF        IBCNMHOS<>1
            MOVE      SP70,FILTHOSP         * Not multi hospital so blank
            CALL      ERTD0000
            GOTO      ERTB9999
          ENDIF
.
.   Multi Hospital
.
          MATCH     SP70,FILTHOSP           * User has selected a hospital
          IF        !@EQUAL
            CALL      ERTD0000
            GOTO      ERTB9999
          ENDIF
.
          PACK      KEY3,SP70               * Show all users available
          CALL      RSPTHSP1                * hospitals
ERTB5000  CALL      RKPTHSP1
          BRANCH    OVRCD,ERTB9000
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,ERTB5000
          ENDIF
.
          MOVE      PTHSHOSP,FILTHOSP
          CALL      ERTD0000
.
          PACK      KEY3,FILTHOSP,SP70               * reposition
          CALL      RSPTHSP1
          GOTO      ERTB5000
.
ERTB9000  MOVE      SP70,FILTHOSP           * Restore all hospitals filter
.
ERTB9999  RETURN
+

.ERTB0000  MATCH     "1",PTCNUEBB
.          GOTO      ERTB9999 IF NOT EQUAL
..
.          MOVE      ZERO,LOOPCNTR
..
.          UNPACK    DIM127,D1,UNRELREM,DIM127
.          UNPACK    DIM127,D1,UNRELINQ,DIM127
.          UNPACK    DIM127,D1,ERASTATS,DIM127
..
.          IF        IBCNMHOS=1
.            MOVE      WBSEHOSP,DIM3
.          ELSE
.            MOVE      SP70,DIM3
.          ENDIF
..
.          PACK      KEY46,DIM3,ERASTATS,Z70
.          CALL      RSOTERH3
.ERTB1000  CALL      RPOTERH3
.          BRANCH    OVRCD,ERTB9999               * end of file
..
.          IF        IBCNMHOS=1
.            MATCH     WBSEHOSP,OTERHOSP
.            GOTO      ERTB9999 IF NOT EQUAL
.          ENDIF
..
.          MATCH     ERASTATS,OTERSTAT
.          GOTO      ERTB9999 IF NOT EQUAL
..
..          PACK      KEY69,Z70
..          CALL      RSPMERH2                     * position in file
..ERTB1000  CALL      RPPMERH2                     * read next record
..          BRANCH    OVRCD,ERTB9999               * end of file
..
..------------------------------------------------------
.. Loop counter to prevent timeout internal server error
..
..          ADD       ONE,LOOPCNTR
..
..          IF        (LOOPCNTR = 500)
..            WRITE     HTMLFILE;"// ",LOOPCNTR
..            MOVE      ZERO,LOOPCNTR
..          ENDIF
..
.. -----------------------------------------------------
..
..         PACK      KEY82,PMEHFTID,PMEHRADV,PMEHPNUM,SP70
..         CALL      RSPMERD1
..         CALL      RKPMERD1
..         BRANCH    OVRCD,ERTB1000
..
..         MATCH     PMEHFTID,PMEDFTID
..         GOTO      ERTB1000 IF NOT EQUAL
..
..         MATCH     PMEHRADV,PMEDRADV
..         GOTO      ERTB1000 IF NOT EQUAL
..
..         MATCH     PMEHPNUM,PMEDPNUM
..         GOTO      ERTB1000 IF NOT EQUAL
..
..         A payment for the ERA has been found, so now if it belongs
..         to outectaf
..
..         PACK      KEY40,OTERTRID,SP30,SP10
..         CALL      RSOTECT6
..         CALL      RKOTECT6
..         BRANCH    OVRCD,ERTB1000
..         
..         MATCH     OTERTRID,OTECTRID            
..         GOTO      ERTB1000 IF NOT EQUAL       
..                                              
..
..
.          MATCH     "1",UNRELREM
.          IF        @EQUAL
.            MATCH     "1",OTERSTAT
.            GOTO      ERTB1000 IF NOT EQUAL
..
.            IF        EXDTBLNK=0
.              MATCH     FRSTDATE,OTERPDAT
.              GOTO      ERTB1000 IF LESS
..
.              MATCH     OTERPDAT,LASTDATE
.              GOTO      ERTB1000 IF LESS
.            ENDIF
..
.          ELSE
.            MATCH     "2",OTERSTAT
.            GOTO      ERTB1000 IF EQUAL
..
.            IF        EXDTBLNK=0
.              MATCH     FRSTDATE,OTERPDAT
.              GOTO      ERTB1000 IF LESS
..
.              MATCH     OTERPDAT,LASTDATE
.              GOTO      ERTB1000 IF LESS
.            ENDIF
..
.          ENDIF
..        
.          MOVE      SP70,DIM11
.          MATCH     SP70,OTERPDAT
.          IF        !@EQUAL & !@EOS
.            UNPACK    OTERPDAT,CCENT,CYEAR,CMON,CDAY
.            MOVE      CMON,F2
.            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
.            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
.          ENDIF
..
.          MOVE      "Unknown  ",DIM9
.          MATCH     "0",OTERSTAT
.          IF        @EQUAL
.            MOVE      "Received ",DIM9
.          ENDIF
..
.          MATCH     "1",OTERSTAT
.          IF        @EQUAL
.            MOVE      "Released ",DIM9
.          ENDIF
..
.          MATCH     "2",OTERSTAT
.          IF        @EQUAL
.            MOVE      "Processing",DIM9
.          ENDIF
..
.          MATCH     "3",OTERSTAT
.          IF        @EQUAL
.            MOVE      "Rel - Sus",DIM9
.          ENDIF
..
.          UNPACK    OTERDAMN,DIM7,DIM2
.          PACK      DIM10,DIM7,DOT,DIM2
.          MOVE      DIM10,FORM7P2C
..          
.          CALL      GCMB0000
..
.          REP       " +",OTERRKEY
.          REP       " +",OTERCLID
.          REP       " +",OTERPRUN
.          REP       " +",OTERPDAT
.          REP       " +",OTERHOSP
..
.          IF        IBCNMHOS=1
..
.            MATCH     "+++",OTERHOSP
.            IF        @EQUAL | @EOS
.              WRITE     HTMLFILE;"t.addRow(#"",DIM11,"#",";
.            ELSE
.        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
.                         " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
.      OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','002');> ",DIM11," - ",OTERCLID,"#",";
.            ENDIF
..
.          ELSE
..
.        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
.                         " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
.      OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','002');> ",DIM11," - ",OTERCLID,"#",";
.          ENDIF
..
.          REP       "+ ",OTERRKEY
.          REP       "+ ",OTERCLID
.          REP       "+ ",OTERPRUN
.          REP       "+ ",OTERPDAT
.          REP       "+ ",OTERHOSP
..
.          WRITE     HTMLFILE;"#"",OTERTRID,"#",":
.                             "#"",DIM9,"#",":
.                             "#"",FORM7P2C,"#",":
.                             "#"",CLAMTOTL,"#",";
..
.          REP       " +",OTERRKEY
.          REP       " +",OTERCLID
.          REP       " +",OTERPRUN
.          REP       " +",OTERPDAT
.          REP       " +",OTERHOSP
..         MOVE      OTERPRUN,DIM30
.          PACK      DIM30,OTERPRUN,SP70
.          MOVE      OTERDAMN,DIM9
.          REP       " +",DIM30
.          REP       " +",DIM9
..
.          MOVE      FORM7P2C,DIM10A
.          MOVE      CLAMTOTL,DIM10B
.          REP       " +",DIM10A
.          REP       " +",DIM10B
..
.          UNPACK    OTERRKEY,DIM8
.          REP       " +",DIM8
..
.          MATCH     "1",UNRELREM
.          IF        @EQUAL
..
.            IF        IBCNMHOS=1
..          
.              MATCH     "+++",OTERHOSP
.              IF        @EQUAL | @EOS
.                WRITE     HTMLFILE;"#"",OTERPRUN;
.              ELSE
..           WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
..                        " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
..             OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','003');>&nbsp;":
..                              OTERPRUN;
.                WRITE     HTMLFILE;"#"",OTERPRUN;
.              ENDIF
..
.            ELSE
..
..           WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
..                        " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
..             OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','003');>&nbsp;":
..                              OTERPRUN;
.                WRITE     HTMLFILE;"#"",OTERPRUN;
.            ENDIF
.          ELSE
..
.            IF        IBCNMHOS=1
..
.              MATCH     "+++",OTERHOSP
.              IF        @EQUAL | @EOS
.                WRITE     HTMLFILE;"#"",OTERPRUN;
.              ELSE
.                MATCH     "2",OTERSTAT
.                IF        @EQUAL
..                 WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
..                           " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
..                           OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','003');>&nbsp;":
..                           OTERPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
.                  WRITE     HTMLFILE;"#"",OTERPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
.                ELSE
.                  MATCH     "1",UNRELINQ
.                  IF        @EQUAL
..                   WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
..                             " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
..                             OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','003');>&nbsp;":
..                             OTERPRUN;
.                    WRITE     HTMLFILE;"#"",OTERPRUN;
.                  ELSE
..                   WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
..                             " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
..                             OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','003');>&nbsp;":
..                             OTERPRUN,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",OTERCLID,"','",OTERPRUN,"','",OTERPDAT,"','",OTERHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"','",OTERRKEY,"','",DIM8,"');>";
.                    WRITE     HTMLFILE;"#"",OTERPRUN,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",OTERCLID,"','",OTERPRUN,"','",OTERPDAT,"','",OTERHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"','",OTERRKEY,"','",DIM8,"');>";
.                  ENDIF
.                ENDIF
.              ENDIF
..         
.            ELSE
.              MATCH     "2",OTERSTAT
.              IF        @EQUAL
..               WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
..                         " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
..                         OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','003');>&nbsp;":
..                         OTERPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
.                WRITE     HTMLFILE;"#"",OTERPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
.              ELSE
.                MATCH     "1",UNRELINQ
.                IF        @EQUAL
..                 WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
..                           " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
..                           OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','003');>&nbsp;":
..                           OTERPRUN;
.                  WRITE     HTMLFILE;"#"",OTERPRUN;
.                ELSE
..                 WRITE     HTMLFILE;"#"","<img src='../images/AppointmentIcon.gif'":
..                           " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
..                           OTERCLID,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','003');>&nbsp;":
..                           OTERPRUN,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",OTERCLID,"','",OTERPRUN,"','",OTERPDAT,"','",OTERHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"','",OTERRKEY,"','",DIM8,"');>";
.                  WRITE     HTMLFILE;"#"",OTERPRUN,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",OTERCLID,"','",OTERPRUN,"','",OTERPDAT,"','",OTERHOSP,"','",DIM30,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"','",OTERRKEY,"','",DIM8,"');>";
.                ENDIF
.              ENDIF
.            ENDIF
.          ENDIF
..          
.          WRITE     HTMLFILE;"#",#"",OTERPRUN;
..         MOVE      OTERPRUN,DIM30
.          PACK      DIM30,OTERPRUN,SP70
.          REP       "+ ",OTERPRUN
.          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
.                         " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
.      OTERCLID,"','",DIM30,"','",OTERRKEY,"','",OTERHOSP,"','002');> ",OTERPRUN;
..
.          REP       "+ ",OTERHOSP
..
.          WRITE     HTMLFILE;"#",#"",OTERTRID;
.          WRITE     HTMLFILE;"#",#"",DIM11;
..          
.          MOVE      SP70,DIM50
.          MATCH     SP70,OTERHOSP
.          IF        !@EQUAL & !@EOS
.            PACK      KEY3,OTERHOSP,SP70
.            CALL      RDPTHSP1
.            IF        OVRCD=0
.              MOVE      PTHSNAME,DIM50
.            ELSE
.              MOVE      OTERHOSP,DIM50
.            ENDIF
.          ENDIF
..
.          WRITE     HTMLFILE;"#",#"",DIM50;
..
.          WRITE     HTMLFILE;"#");"
..
.          REP       "+ ",OTERCLID
.          REP       "+ ",OTERPDAT
.          REP       "+ ",OTERRKEY
..
.          GOTO      ERTB1000
..
.ERTB9999  RETURN
+
.***************************************************************************
.*                             ERTD0000                                    *
.*   Display all the remittance batches received from a given participant  *
.***************************************************************************
ERTD0000  MATCH     "1",PTCNUEBB
          GOTO      ERTD9999 IF NOT EQUAL
.
          MOVE      ZERO,LOOPCNTR
.
          PACK      KEY48,FILTHOSP,ERASTATS,Z70
          CALL      RSOTERH3
ERTD1000  CALL      RPOTERH3
          BRANCH    OVRCD,ERTD9999               * end of file
.
          MATCH     FILTHOSP,OTERHOSP
          GOTO      ERTD9999 IF NOT EQUAL
.
          MATCH     ERASTATS,OTERSTAT
          GOTO      ERTD9999 IF NOT EQUAL
.
.------------------------------------------------------
. Loop counter to prevent timeout internal server error
.
           ADD       ONE,LOOPCNTR
.
           IF        (LOOPCNTR = 500)
             WRITE     HTMLFILE;"// ",LOOPCNTR
             MOVE      ZERO,LOOPCNTR
           ENDIF
.
. -----------------------------------------------------
.
          PACK      KEY77,OTERRKEY,OTERHOSP,OTERPYPN,OTERPRUN,OTERPDAT,SP70
          CALL      RSOTERD3
          CALL      RKOTERD3
          BRANCH    OVRCD,ERTD1000
.
          MATCH     OTERRKEY,OTESRKEY
          GOTO      ERTD1000 IF NOT EQUAL
.
          MATCH     OTERHOSP,OTESHOSP
          GOTO      ERTD1000 IF NOT EQUAL
.
          MATCH     OTERPYPN,OTESPYPN
          GOTO      ERTD1000 IF NOT EQUAL
.
          MATCH     OTERPRUN,OTESPRUN
          GOTO      ERTD1000 IF NOT EQUAL
.
          MATCH     OTERPDAT,OTESPDAT
          GOTO      ERTD1000 IF NOT EQUAL
.
.         A payment for the report has been found, so now if it belongs
.         to outectaf
.
          PACK      KEY40,OTESTRID,SP30,SP10
          CALL      RSOTECT6
          CALL      RKOTECT6
          BRANCH    OVRCD,ERTD1000
.
          MATCH     OTESTRID,OTECTRID            * if its not in outectaf
          GOTO      ERTD1000 IF NOT EQUAL        * then its probably a dbs 
.                                                * claim
.
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
            MATCH     "2",OTERSTAT
            GOTO      ERTD1000 IF NOT EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,OTERPDAT
              GOTO      ERTD1000 IF LESS
.
              MATCH     OTERPDAT,LASTDATE
              GOTO      ERTD1000 IF LESS
            ENDIF
.
          ELSE
            MATCH     "2",OTERSTAT
            GOTO      ERTD1000 IF EQUAL
.
            IF        EXDTBLNK=0
              MATCH     FRSTDATE,OTERPDAT
              GOTO      ERTD1000 IF LESS
.
              MATCH     OTERPDAT,LASTDATE
              GOTO      ERTD1000 IF LESS
            ENDIF
.
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,OTERPDAT
          IF        !@EQUAL & !@EOS
            UNPACK    OTERPDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",OTERSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",OTERSTAT
          IF        @EQUAL
            MOVE      "Partial  ",DIM9
          ENDIF
.
          MATCH     "2",OTERSTAT
          IF        @EQUAL
            MOVE      "Released ",DIM9
          ENDIF
.
          MATCH     "3",OTERSTAT
          IF        @EQUAL
            MOVE      "Processng ",DIM9
          ENDIF
.
          UNPACK    OTERDAMN,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
          MOVE      DIM10,FORM7P2C
.
          CALL      GCMS0000
.
          REP       " +",OTERHOSP
          REP       " +",OTERPYPN
          REP       " +",OTERPRUN
          REP       " +",OTERPDAT
          REP       " +",OTERRKEY
.
          MOVE      ZERO,LOOPCNTR
.
          IF        IBCNMHOS=1
.
            MATCH     "+++",OTERHOSP
            IF        @EQUAL | @EOS
              WRITE     HTMLFILE;"t.addRow(#"",DIM11,"#",";
            ELSE
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
      OTERPYPN,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','002');> ",DIM11,"#",";
            ENDIF
.
          ELSE
.
        WRITE     HTMLFILE;"t.addRow(#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
      OTERPYPN,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','002');> ",DIM11,"#",";
          ENDIF
.
          REP       "+ ",OTERHOSP
          REP       "+ ",OTERPYPN
          REP       "+ ",OTERPRUN
          REP       "+ ",OTERPDAT
          REP       "+ ",OTERRKEY
.
          WRITE     HTMLFILE;"#"",OTERPRUN,"#",":
                             "#"",DIM9,"#",";
.
          REP       " +",OTERHOSP
          REP       " +",OTERPYPN
          REP       " +",OTERPRUN
          REP       " +",OTERPDAT
          REP       " +",OTERRKEY
          MOVE      OTERPRUN,DIM30
          PACK      DIM30,DIM30,SP70
          MOVE      OTERDAMN,DIM9
          REP       " +",DIM30
          REP       " +",DIM9
.
          MOVE      FORM7P2C,DIM10A
          MOVE      CLAMTOTL,DIM10B
          REP       " +",DIM10A
          REP       " +",DIM10B
.
          WRITE     HTMLFILE;"#"",FORM7P2C,"&nbsp;&nbsp;&nbsp;<img src='../images/AppointmentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
              OTERPYPN,"','",OTERPRUN,"','",OTERRKEY,"','",OTERHOSP,"','003');>&nbsp;","#",";
.
          WRITE     HTMLFILE;"#"",CLAMTOTL,"#",";
.
          MATCH     "1",UNRELREM
          IF        @EQUAL
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",OTERHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",OTERPRUN;
              ELSE
                MOVE      OTERPRUN,DIM4
                REP       "+ ",DIM4
                WRITE     HTMLFILE;"#"",DIM4;
              ENDIF
.
            ELSE
              MOVE      OTERPRUN,DIM4
              REP       "+ ",DIM4
              WRITE     HTMLFILE;"#"",DIM4;
              ENDIF
          ELSE
.
            IF        IBCNMHOS=1
.
              MATCH     "+++",OTERHOSP
              IF        @EQUAL | @EOS
                WRITE     HTMLFILE;"#"",OTERPRUN;
              ELSE
                MATCH     "3",OTERSTAT
                IF        @EQUAL
                  WRITE     HTMLFILE;"#"",OTERPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
                ELSE
                  MATCH     "1",UNRELINQ
                  IF        @EQUAL
                    MOVE      OTERPRUN,DIM4
                    REP       "+ ",DIM4
                    WRITE     HTMLFILE;"#"",DIM4;
                  ELSE
                    MOVE      OTERPRUN,DIM4
                    REP       "+ ",DIM4
                    WRITE     HTMLFILE;"#"",DIM4,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",OTERPYPN,"','",OTERPRUN,"','",OTERPDAT,"','",OTERRKEY,"','",OTERHOSP,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                  ENDIF
                ENDIF
              ENDIF
.
            ELSE
              MATCH     "3",OTERSTAT
              IF        @EQUAL
                WRITE     HTMLFILE;"#"",OTERPRUN,"&nbsp;<input type=button value='Processing' class='orangebutton' disabled>";
              ELSE
                MATCH     "1",UNRELINQ
                IF        @EQUAL
                  MOVE      OTERPRUN,DIM4
                  REP       "+ ",DIM4
                  WRITE     HTMLFILE;"#"",DIM4;
                ELSE
                  MOVE      OTERPRUN,DIM4
                  REP       "+ ",DIM4
                  WRITE     HTMLFILE;"#"",DIM4,"&nbsp;<input type=button value='Release' class='button' onclick=releaseRem('",OTERPYPN,"','",OTERPRUN,"','",OTERPDAT,"','",OTERRKEY,"','",OTERHOSP,"','",DIM9,"',this,'",DIM10A,"','",DIM10B,"');>";
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",OTERPRUN;
          MOVE      OTERPRUN,DIM30
          PACK      DIM30,DIM30,SP70
          REP       " +",DIM30
          REP       "+ ",OTERPRUN
          WRITE     HTMLFILE;"#",#"","<img src='../images/CommentIcon.gif'":
                         " class=ListIcon onclick=displayRemH('",OTERPDAT,"','":
      OTERPYPN,"','",DIM30,"','",OTERRKEY,"','",OTERHOSP,"','002');> ",OTERPRUN;
.
          REP       "+ ",OTERHOSP
          REP       "+ ",DIM30
.
          WRITE     HTMLFILE;"#",#"",OTERRKEY;
          WRITE     HTMLFILE;"#",#"",DIM11;
.
          MOVE      SP70,DIM50
          MATCH     SP70,OTERHOSP
          IF        !@EQUAL & !@EOS
            PACK      KEY3,OTERHOSP,SP70
            CALL      RDPTHSP1
            IF        OVRCD=0
              MOVE      PTHSNAME,DIM50
            ELSE
              MOVE      OTERHOSP,DIM50
            ENDIF
          ENDIF
.
          WRITE     HTMLFILE;"#",#"",DIM50;
.
          REP       "+ ",OTERPYPN
          WRITE     HTMLFILE;"#",#"",OTERPYPN;
.
          PACK      KEY20,OTERPYPN,SP70
          CALL      RSPMHCP3
          CALL      RKPMHCP3         
          BRANCH    OVRCD,ERTD8000
.
          PACK      DIM10,OTERPYPN,SP70
          MATCH     DIM10,PMHCPRV1
          GOTO      ERTD8000 IF NOT EQUAL
.
          MOVE      PMHCTITL,FMTTITLE             * Got them - set up name flds
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000                      * Format name
.
          WRITE     HTMLFILE;"#",#"",DOCFNAME;
          GOTO      ERTD9000
.
ERTD8000  WRITE     HTMLFILE;"#",#"","Description Not Found";
          GOTO      ERTD9000
.
ERTD9000  WRITE     HTMLFILE;"#");"
.
          REP       "+ ",OTERHOSP
          REP       "+ ",OTERPYPN
          REP       "+ ",OTERPRUN
          REP       "+ ",OTERPDAT
          REP       "+ ",OTERRKEY
.
          GOTO      ERTD1000
.
ERTD9999  RETURN
+
.***************************************************************************
.*                             ERTH0000                                    *
.*   Set the hospital filter and call ERTM0000                             *
.*   If multi hospital call ERTM0000 for each of the users hositals        *
.***************************************************************************
ERTH0000  IF        IBCNMHOS<>1
            MOVE      SP70,FILTHOSP         * Not multi hospital so blank
            CALL      ERTM0000
            GOTO      ERTH9999
          ENDIF
.
.   Multi Hospital
.
          MATCH     SP70,FILTHOSP           * User has selected a hospital
          IF        !@EQUAL
            CALL      ERTM0000
            GOTO      ERTH9999
          ENDIF
.
          PACK      KEY3,SP70               * Show all users available
          CALL      RSPTHSP1                * hospitals
ERTH5000  CALL      RKPTHSP1
          BRANCH    OVRCD,ERTH9000
.
          PACK      KEY13,USERID,SP70                * All hospital access
          CALL      RDMLSEC1
          IF        OVRCD=1
            PACK      KEY13,USERID,PTHSHOSP,SP70     * This hospital access
            CALL      RDMLSEC1
            BRANCH    OVRCD,ERTH5000
          ENDIF
.
          MOVE      PTHSHOSP,FILTHOSP
          CALL      ERTM0000
.
          PACK      KEY3,FILTHOSP,SP70               * reposition
          CALL      RSPTHSP1
          GOTO      ERTH5000
.
ERTH9000  MOVE      SP70,FILTHOSP           * Restore all hospitals filter
.
ERTH9999  RETURN
+
.------------------------------------------------------------
. Eclipse DBS Payment Details
.------------------------------------------------------------
ERDD0000  MATCH     "1",PTCNUEBB
          GOTO      ERDD9999 IF NOT EQUAL
.
          CALL      ERDDH000
.
          PACK      KEY77,OTERRKEY,OTERHOSP,OTERPYPN,OTERPRUN,OTERPDAT,SP70
          CALL      RSOTERD3
ERDD1000  CALL      RKOTERD3
          BRANCH    OVRCD,ERDD9999
.
          MATCH     OTERRKEY,OTESRKEY
          GOTO      ERDD9999 IF NOT EQUAL
.
          MATCH     OTERHOSP,OTESHOSP
          GOTO      ERDD9999 IF NOT EQUAL
.
          MATCH     OTERPYPN,OTESPYPN
          GOTO      ERDD9999 IF NOT EQUAL
.
          MATCH     OTERPRUN,OTESPRUN
          GOTO      ERDD9999 IF NOT EQUAL
.
          MATCH     OTERPDAT,OTESPDAT
          GOTO      ERDD9999 IF NOT EQUAL
.
          MOVE      SP70,DIFCINDC
          IF        IBCNMHOS=1
            PACK      KEY40,OTESTRID,SP70
            CALL      RSOTECT6
            CALL      RKOTECT6
            BRANCH    OVRCD,ERDD5000
.
            MATCH     OTESTRID,OTECTRID
            GOTO      ERDD5000 IF NOT EQUAL
.
            MATCH     SP70,OTECHOSP
            IF        !@EQUAL & !@EOS
              MATCH     OTECHOSP,WBSEHOSP
              IF        !@EQUAL
                PACK      KEY3,OTECHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MOVE      PTHSLOCN,SAVELOCN
                ELSE
                  MOVE      SP70,SAVELOCN
                ENDIF
.
                PACK      KEY3,WBSEHOSP,SP70
                CALL      RDPTHSP1
                IF        OVRCD=0
                  MATCH     SAVELOCN,PTHSLOCN
                  GOTO      ERDD1000 IF NOT EQUAL

                  MOVE      "1",DIFCINDC
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
ERDD5000  CALL      ERDDR000
.
          GOTO      ERDD1000
.
ERDD9999  RETURN
+
.------------------------------------------------------------
. DBS Payment Details (TABLE HEADING)
.------------------------------------------------------------
ERDDH000  WRITE     HTMLFILE;"<tr>":
                             "<td class=HeadingCell width=15%>":
                             "Claim Tran ID</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Benefit<br>Amount</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Claimed<br>Amount</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Batch<br>Number</td>";
.
          WRITE     HTMLFILE;"<td class=HeadingCell width=10%>":
                             "Status</td>":
                             "<td class=HeadingCell width=10%>":
                             "Claim ID</td>":
                             "<td class=HeadingCell width=15% align=center>":
                             "Lodgement<br>Date</td>":
.                            "<td class=HeadingCell width=15%>":
.                            "Transaction ID<br>&nbsp;</td>":
                             "</tr>"
.
ERDDH999  RETURN
+
.------------------------------------------------------------
. Eclipse DBS Payment Details (Detail Row)
.------------------------------------------------------------
ERDDR000  REP       " +",HOSPCODE
          REP       " +",OTESPYPN
          REP       " +",OTESPRUN
          REP       " +",OTESPDAT
          REP       " +",OTESCLID
          REP       " +",OTESTRID
.
          WRITE     HTMLFILE;"<tr><td><img src='../images/CommentIcon.gif'":
                             " class=ListIcon onclick=displayRemD('":
  HOSPCODE,"','",OTESPYPN,"','",OTESPRUN,"','",OTESPDAT,"','",OTESCLID,"','",OTESTRID,"','D');>&nbsp;";
.
          REP       "+ ",HOSPCODE
          REP       "+ ",OTESPYPN
          REP       "+ ",OTESPRUN
          REP       "+ ",OTESPDAT
          REP       "+ ",OTESCLID
          REP       "+ ",OTESTRID
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<font color=red>";
          ENDIF
.
          WRITE     HTMLFILE;OTESTRID;
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"</font>";
          ENDIF
.
          WRITE     HTMLFILE;"</td>";
.
          UNPACK    OTESCLBP,DIM7,DIM2
          PACK      DIM10,DIM7,DOT,DIM2
.         MOVE      DIM10,FORM7P2C
          MOVE      ZERO,FORM7P2C
          SCAN      "-",DIM10
          IF        @EQUAL
            REP        "-0",DIM10
            MOVE       DIM10,FORM7P2C
            ASSIGN     (FORM7P2C*SEQ),FORM7P2C
          ELSE
            MOVE      DIM10,FORM7P2C
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",FORM7P2C,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",FORM7P2C,"</td>";
          ENDIF
.
          MOVE      ZERO,CLAMTOTL
          PACK      KEY40,OTESTRID,SP30,SP10
          CALL      RSOTECT6                     * position on trans. id
          CALL      RKOTECT6                     * read next record
          BRANCH    OVRCD,ERDDR100                * eof - not found
.
          MATCH     OTESTRID,OTECTRID            * same transaction id still ?
          GOTO      ERDDR100 IF NOT EQUAL        * no - not found
.
          MOVE      OTECAMTC,CLAMTOTL            * update ERA claim total
.
ERDDR100  MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",CLAMTOTL,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",OTECBATN,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",CLAMTOTL,"</td>";
.
            WRITE     HTMLFILE;"<td>",OTECBATN,"</td>";
          ENDIF
.
          MOVE      "Unknown  ",DIM9
          MATCH     "0",OTESSTAT
          IF        @EQUAL
            MOVE      "Received ",DIM9
          ENDIF
.
          MATCH     "1",OTESSTAT
          IF        @EQUAL
            MOVE      "Locked   ",DIM9
          ENDIF
.
          MATCH     "2",OTESSTAT
          IF        @EQUAL
            MOVE      "Released",DIM9
          ENDIF
.
          MATCH     "3",OTESSTAT
          IF        @EQUAL
            MOVE      "Released*",DIM9
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM9,"</font></td>";
.
            WRITE     HTMLFILE;"<td><font color=red>",OTESCLID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM9,"</td>";
.
            WRITE     HTMLFILE;"<td>",OTESCLID,"</td>";
          ENDIF
.
          MOVE      SP70,DIM11
          MATCH     SP70,OTESPDAT
          IF        !@EQUAL & !@EOS
            UNPACK    OTESPDAT,CCENT,CYEAR,CMON,CDAY
            MOVE      CMON,F2
            LOAD      MTHNAM3,F2,JAN,FEB,MAR,APR,MAY,JUN,JUL,AUG,SEP,OCT,NOV,DEC
            PACK      DIM11,CDAY,SP1,MTHNAM3,SP1,CCENT,CYEAR
          ENDIF
.
          MATCH     "1",DIFCINDC
          IF        @EQUAL
            WRITE     HTMLFILE;"<td><font color=red>",DIM11,"</font></td>";
.
.           WRITE     HTMLFILE;"<td><font color=red>",OTESTRID,"</font></td>";
          ELSE
            WRITE     HTMLFILE;"<td>",DIM11,"</td>";
.
.           WRITE     HTMLFILE;"<td>",OTESTRID,"</td>";
          ENDIF
.
          WRITE     HTMLFILE;"</tr>";
.
ERDDR999  RETURN
+
.*****************************************************************************
.*                            GCMS0000                                       *
.*              Get the claimed amount total for the Payment Report          *
.* Requires:  Valid read on outerhaf record (ERA Header)                     *
.* Returns:   CLAMTOTL - total claimed amount for the payment batch          *
.*****************************************************************************
.
GCMS0000  MOVE      ZERO,CLAMTOTL                * initialise total amount
.
          MATCH     "1",PTCNUEBB
          GOTO      GCMS9999 IF NOT EQUAL
.
.         Loop through outerdaf looking for payments from the selected report
.
          PACK      KEY77,OTERRKEY,OTERHOSP,OTERPYPN,OTERPRUN,OTERPDAT,SP70
          CALL      RSOTERD3                     * position in file
GCMS1000  CALL      RKOTERD3                     * read next record
          BRANCH    OVRCD,GCMS9999               * end of file
.
          MATCH     OTERRKEY,OTESRKEY          
          GOTO      GCMS9999 IF NOT EQUAL     
.
          MATCH     OTERHOSP,OTESHOSP        
          GOTO      GCMS9999 IF NOT EQUAL   
.
          MATCH     OTERPYPN,OTESPYPN         
          GOTO      GCMS9999 IF NOT EQUAL    
.
          MATCH     OTERPRUN,OTESPRUN
          GOTO      GCMS9999 IF NOT EQUAL
.
          MATCH     OTERPDAT,OTESPDAT
          GOTO      GCMS9999 IF NOT EQUAL
.
.         A payment has been found, so now get the claimed amount
.         from outectaf
.
          PACK      KEY40,OTESTRID,SP30,SP10
          CALL      RSOTECT6                     * position on trans. id
          CALL      RKOTECT6                     * read next record
          BRANCH    OVRCD,GCMS1000               * eof - not found
.
          MATCH     OTESTRID,OTECTRID            * same transaction id still ?
          GOTO      GCMS1000 IF NOT EQUAL        * no - not found
.
          ADD       OTECAMTC,CLAMTOTL            * update ERA claim total
          GOTO      GCMS1000                     * get next payment
.
GCMS9999  RETURN
+
.------------------------------------------------------------------------------
.  Redirect Parent URL
.------------------------------------------------------------------------------
PAREDR00  CALL      OPENHTML
          BRANCH    EXIT,PAREDR90
.
          WRITE     HTMLFILE;"<script type=#"text/javascript#"> {":
                             " alert(#"",WEBTITLE,"#");":
                             " parent.location.reload();":
                             "}":
                             "</script>"
          CALL      CLOSHTML
          GOTO      PAREDR99
.
PAREDR90  DISPLAY   "*** Fifo Not Found ***"
.
PAREDR99  RETURN
.
.------------------------------------------------------------
. GDSCCM00 - Get emergency discharge comments
.------------------------------------------------------------
GDSCCM00  PREP      COMFILDF,COMFILND
          MOVE      ONE,F3
          WRITE     COMFILDF,SEQ;QRYDATA
.
GDSCCM10  READ      CONFFILE,SEQ;QRYNAME,QRYDATA
          GOTO      GDSCCM90 IF OVER
          MATCH     SP70,QRYNAME
          GOTO      GDSCCM80 IF NOT EQUAL
          ADD       ONE,F3
          WRITE     COMFILDF,SEQ;QRYDATA
          GOTO      GDSCCM10
.
GDSCCM80  MOVE      ONE,TEXTAREA
GDSCCM90  MOVE      F3,LASTITEM
          OPEN      COMFILDF,COMFILND
GDSCCM99  RETURN
+
.------------------------------------------------------------
. Discharge Planning Comments
.------------------------------------------------------------
.         copy the comments back to file
.         first delete existing comments
.
UPDSC000  REP       "+ ",ADMISSNO
          REP       "+ ",URNUMBER
          MOVE      "022",KEY3
UPDSC400  PACK      KEY14,ADMISSNO,KEY3,SP70
          CALL      RSVSCMT1
          CALL      RKVSCMT1
          BRANCH    OVRCD,UPDSC500          * end of file
          MATCH     VSCTVIST,ADMISSNO       * same Admission Number?
          GOTO      UPDSC500 IF NOT EQUAL
          MATCH     VSCTTYPE,KEY3
          GOTO      UPDSC500 IF NOT EQUAL
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      DEVSCMT1
          GOTO      UPDSC400
.
.         now write the new comments back
.
UPDSC500  MOVE      ADMISSNO,VSCTVIST          * set Admission Number
          MOVE      KEY3,VSCTTYPE
          MOVE      ZERO,F3
.
          MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      COMFILDF,COMFILND
          TRAPCLR   IO
          BRANCH    OVRCD,UPDSC999
.
UPDSC510  ADD       ONE,F3
          READ      COMFILDF,SEQ;VSCTDATA
.
          MATCH     SP70,VSCTDATA
          GOTO      UPDSC600 IF NOT EQUAL
.
          IF        F3=1
            IF        F3>=LASTITEM
              GOTO      UPDSC999
            ENDIF
.
            BRANCH    F3,UPDSC510             * If first line blank ignore
          ENDIF
.
          IF        F3>=LASTITEM
            GOTO      UPDSC999
          ELSE
            GOTO      UPDSC510
          ENDIF
.
UPDSC600  MOVE      F3,VSCTLINE
.
          CALL      IBACLOCK
          PACK      DATE,CCC,CYY,CMM,CDD
          REP       " 0",DATE
          PACK      TIME,CTIMEIS
          REP       " 0",TIME
          UNPACK    TIME,HOUR,D1,MIN,D1,SEC
          PACK      DIM6,HOUR,MIN,SEC,SP70
          PACK      VSCTUKEY,DATE,DIM6,WBSEUID,SP70
.
          PACK      KEY14,VSCTVIST,VSCTTYPE,VSCTLINE
          CALL      RAVSCMT1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRVSCMT1
            TRAPCLR   IO
          ENDIF
          IF        F3>=LASTITEM
            GOTO      UPDSC999
          ENDIF
          GOTO      UPDSC510
.
UPDSC999  RETURN
.
.------------------------------------------------------------------------------ 
. Discharge Manage Details
.------------------------------------------------------------------------------ 
DISM0000  MOVE      ZERO,EXIT
.
          MOVE      URNUMBER,KEY8   * Read Master File
          CALL      RDMAST1
          BRANCH    OVRCD,DISM9100
.
          MOVE      PURNO,KEY8
          CALL      RDPMPX21
          IF        OVRCD=1
            CALL      CLPMSPX2
          ENDIF
.
          PACK      KEY8,ADMISSNO,SP70
          MATCH     SP70,KEY8
          IF        !@EQUAL
            CALL      RDMISS1
            IF        OVRCD=1
              CALL      CLPATMIS
            ENDIF
          ENDIF
.
          RESET     UPDATETY
          STRIP     UPDATETY 
          MATCH     SP70,UPDATETY
          IF        @EQUAL | @EOS
            GOTO      DISM5000
          ENDIF
.
          MATCH     "U",UPDATETY
          GOTO      DISM3000 IF EQUAL
.
          GOTO      DISM9000
.
.         ************ UPDATE FORMACTION **********
.
DISM3000  CALL      DISMUP00
          BRANCH    EXIT,DISM9999
.
          MOVE      ZERO,EXIT
          GOTO      DISM9999
.
.         ************ DISPLAY FORMACTION **********
.
DISM5000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
          ENDIF
.
          CLEAR     WEBTITLE
          MOVE      "Discharge Manage Details.",WEBTITLE
          RESET     WEBTITLE
.
          CALL      WEBHED00   * Create Output File and Write HTML Page Header
          BRANCH    EXIT,DISM9999
          CALL      WEBBOD00                * Process Web Body
          CALL      WEBEND00                * Process End of HTML File
.
          MOVE      ONE,EXIT
          GOTO      DISM9999
.
DISM9000  MOVE      "Invalid updttype.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISM9999
.
DISM9100  MOVE      "Can't find patient Master Details. ",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISM9999
.
DISM9999  RETURN
.
.------------------------------------------------------------------------------
. Update Discharge Manage Details
.------------------------------------------------------------------------------
DISMUP00  PACK      KEY8,AADMNO,SP70
          CALL      RDPMWOR1
          IF        OVRCD=1
            CALL      CLPMWO00
            MOVE      AADMNO,PMWOADMN
            CALL      MVPMWO00
            PACK      PMWOCDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMWOCDAT
            CLOCK     TIME,PMWOCTIM
            MOVE      USERID,PMWOCUID
            CALL      WRPMWOR1
          ELSE
            CALL      MVPMWO00
            PACK      PMWOUDAT,CCC,CYY,CMM,CDD
            REP       " 0",PMWOUDAT
            CLOCK     TIME,PMWOUTIM
            MOVE      USERID,PMWOUUID
            CALL      UPPMWOR1
          ENDIF
.
          GOTO      DISMUP99
.
DISMUP90  MOVE      "Invalid updttype.",WEBTITLE
          CALL      WEBERR00
          MOVE      ONE,EXIT
          GOTO      DISM9999
.
DISMUP99  RETURN
.
.----------------------------------------------------------------
. Calculate the outliers, expect patient and confirmed discharge
.----------------------------------------------------------------
CALCA000  MOVE      ZERO,NUMBEXPT
.
          CALL      IBACLOCK
          PACK      CURRDATE,CCC,CYY,CMM,CDD
          REP       " 0",CURRDATE
.
          CALL      EXPTP000
          CALL      BDRQIN00
.
          ADD       BOOKINGS,NUMBEXPT
          ADD       PREADMIS,NUMBEXPT
          ADD       EXPPOSOP,NUMBEXPT
          ADD       EXPDBREQ,NUMBEXPT
.
CALCA999  RETURN
.
.------------------------------------------------------------
. Calculate Number of Patients in a ward for today
.------------------------------------------------------------
EXPTP000  MOVE      ZERO,PREADMIS
          MOVE      ZERO,BOOKINGS
          MOVE      ZERO,EXPPOSOP
. 
          PACK      KEY16,CURRDATE,SP70
          CALL      RSBKREC4
EXPTP500  CALL      RKBKREC4
          BRANCH    OVRCD,EXPTP600
.
          MATCH     BKREEDAT,CURRDATE
          GOTO      EXPTP600 IF NOT EQUAL
.
          COMPARE   ZERO,BKRESTAT                * Booked only
          GOTO      EXPTP500 IF NOT EQUAL
.
EXPTP510  PACK      KEY8,DBKREBOO,SP70
          CALL      RDBKRX11
          BRANCH    OVRCD,EXPTP500
.
          MATCH     SP70,BKRXPOWD                * If Post Op ward is empty
          GOTO      EXPTP550 IF EQUAL            * then check expected ward
.
. Post Op ward is not empty
.
          PACK      KEY8,DBKREBOO,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,EXPTP540
.
          COMPARE   ONE,ASTAT
          GOTO      EXPTP540 IF NOT EQUAL
.
          MATCH     SP70,PTMIXWRD
          GOTO      EXPTP540 IF EQUAL
.
          MATCH     BKRXPOWD,PTMIXWRD
          IF        !@EQUAL
            ADD       ONE,EXPPOSOP
            GOTO      EXPTP500
          ENDIF
.
EXPTP540  MATCH     WARDCODE,BKRXPOWD
          IF        @EQUAL
            ADD       ONE,BOOKINGS
          ENDIF
          GOTO      EXPTP500
.
EXPTP550  MATCH     WARDCODE,BKREWARD            * Check Expected ward
          IF        @EQUAL
            ADD       ONE,BOOKINGS
          ENDIF
          GOTO      EXPTP500
.
. Calculate Preadmissions for Ward for Today
.
EXPTP600  PACK      KEY16,CURRDATE,SP70
          CALL      RDSMISS3
EXPTP700  CALL      RDKMISS3
          BRANCH    OVRCD,EXPTP999
          MATCH     ADATE,CURRDATE
          GOTO      EXPTP999 IF NOT EQUAL
.
          COMPARE   ONE,ASTAT
          GOTO      EXPTP700 IF NOT EQUAL
.
EXPTP710  MATCH     WARDCODE,PTMIXWRD
          GOTO      EXPTP700 IF NOT EQUAL
.
. Check Post Op ward
.
EXPTP720  PACK      KEY8,DAADMNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,EXPTP780
.
          MATCH     SP70,PMVXPOWD
          GOTO      EXPTP780 IF EQUAL
.
          MATCH     PMVXPOWD,PTMIXWRD
          IF        !@EQUAL
            ADD       ONE,EXPPOSOP
            GOTO      EXPTP700
          ENDIF
.
EXPTP780  ADD       ONE,PREADMIS
          GOTO      EXPTP700
.
EXPTP999  RETURN
.
.---------------------------------------------------------------------
. Check for request bed for the patient - allocated
.---------------------------------------------------------------------
BDRQIN00  MOVE      ZERO,EXPDBREQ
          MOVE      "2",DIM1
          PACK      KEY39,WARDCODE,SP3,DIM1,SP70
          CALL      RSPMBRQ4
BDRQIN20  CALL      RKPMBRQ4
          BRANCH    OVRCD,BDRQIN99
.
          MATCH     WARDCODE,PMBREWRD
          GOTO      BDRQIN99 IF NOT EQUAL
.
          MATCH     DIM1,PMBRRSTA
          GOTO      BDRQIN99 IF NOT EQUAL
.
          ADD       ONE,EXPDBREQ
.
          GOTO      BDRQIN20
.
BDRQIN99  RETURN
.
.--------------------------------------------------------------------
. Get discharge direction column
.--------------------------------------------------------------------
DSCHDI00  MOVE      SP70,TDESC
          MATCH     SP70,AUSR2
          GOTO      DSCHDI50 IF EQUAL
.
          MOVE      "U2",CATEGORY  
          PACK      KEY5,CATEGORY,AUSR2,SP70
          CALL      RDCODE1
          IF        OVRCD = 1
            MOVE      AUSR2,TDESC
          ENDIF
.
DSCHDI50  WRITE     HTMLFILE;"<td>",TDESC,"</td>"; 
.
DSCHDI99  RETURN
.
.------------------------------------------------------------
. Get HCP 1 for FHIR Response.
.------------------------------------------------------------
FHRDO100  MOVE      SP70,FHRDOCC1
          MOVE      SP70,FHRDOCT1
          MOVE      SP70,FHRDOCN1
.
          MATCH     SP70,ADOCTA
          GOTO      FHRDO199 IF EQUAL
.
          PACK      KEY10,ADOCTA,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC1
          APPEND    "HCP-",FHRDOCC1
          APPEND    ADOCTA,FHRDOCC1
          RESET     FHRDOCC1
          MOVE      "ADM",FHRDOCT1 *  Doctor Type
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN1,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
FHRDO199  RETURN
+
.------------------------------------------------------------
. Get HCP 2 for FHIR Response.
.------------------------------------------------------------
FHRDO200  MOVE      SP70,FHRDOCC2
          MOVE      SP70,FHRDOCT2
          MOVE      SP70,FHRDOCN2
.
          MATCH     SP70,PMVXEDC1
          GOTO      FHRDO299 IF EQUAL
.
          PACK      KEY10,PMVXEDC1
          CALL      RDPMHCP1
          BRANCH    OVRCD,GFRDOC99
.
          CLEAR     FHRDOCC2
          APPEND    "HCP-",FHRDOCC2
          APPEND    PMVXEDC1,FHRDOCC2
          RESET     FHRDOCC2
          MOVE      "CON",FHRDOCT2
          SQUEEZE   PMHCTITL
          SQUEEZE   PMHCSNAM
          MOVE      PMHCGNAM,DIM1
          PACK      FHRDOCN2,PMHCTITL,SP1,DIM1,DOT,SP1,PMHCSNAM,SP70
.
FHRDO299  RETURN
+
.------------------------------------------------------------------------------
. FHIR Encounter Resource
.------------------------------------------------------------------------------
RESPRA00  MOVE      PMHCADR1,PRACNAME       * use hcp details
          MOVE      PMHCADR2,PRACADD1
          MOVE      SP70,PRACADD2
          MOVE      PMHCADR3,PRACADD3
          MOVE      PMHCADR4,PRACADD4
          MOVE      PMHCPOST,PRACPOST
          MOVE      PMHCSEML,PRACPEML
          MOVE      PMHCSTEL,PRACPTEL
          MOVE      PMHCFAXN,PRACPFAX
          MOVE      PMHCPRV1,PRACPROV
          PACK      DISPPRAC,SP70
          PACK      DISPPNAM,SP70,SP70
          PACK      DISPPCNT,SP70
.
          MOVE      "DT",TCODE
          PACK      KEY5,TCODE,PMHCSPC1,SP70
          CALL      RDCODE1
          IF        OVRCD=1
            MOVE      SP70,TDESC
          ENDIF
          CALL      HCPNAME0
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Practitioner#",":
                    "   #"id#": #"HCP-",PMHCHCPC,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"},":
                    " { #"url#":#"%BASEURL/extension/dxc-hc-speciality#"":
                        " ,#"valueString#":#"",TDESC,"#"}":
                    " ],":
                    " #"identifier#": [ ":
                    "  {#"type#": { #"text#" : #"HCP ID#" },":
                    "   #"value#": #"",PMHCHCPC,"#" },":
                    "  {#"type#": { #"text#" : #"Provider Number#" },":
                    "   #"value#": #"",PRACPROV,"#" }":
                    "    ] ,":
                    " #"name#": [ { ":
                    "  #"use#": #"usual#",":
                    "  #"text#": #"",DOCFNAME,"#" ,":
                    "  #"prefix#":[ #"",PMHCTITL,"#" ],":
                    "  #"given#": [ #"",PMHCGNAM,"#" ],":
                    "  #"family#": #"",PMHCSNAM,"#" } ],":
                    "  #"telecom#": [ ":
                    "   { #"system#": #"phone#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPTEL,"#" },":
                    "   { #"system#": #"email#", #"use#": #"work#", ":
                    "     #"value#": #"",PRACPEML,"#" },":
                    "   { #"system#": #"phone#", #"use#": #"mobile#", ":
                    "     #"value#": #"",PMHCMOBN,"#" },":
                    "   { #"system#": #"fax#",   #"use#": #"work#", ":
                    "     #"value#": #"",PRACPFAX,"#" } ],":
                    " #"address#": [ {":
                    "  #"use#": #"work#",":
                    "  #"line#": [#"",PRACNAME,"#"":
                    ",#"",PRACADD1,"#"";
          MATCH     SP70,PRACADD2
          IF        !@EQUAL
            STRIP     PRACADD2
            WRITE     HTMLFILE;*+,",#"",PRACADD2,"#"";
          ENDIF
          WRITE     HTMLFILE;*+,"],":
                      "       #"city#": #"",PRACADD3,"#",":
                      "       #"state#": #"",PRACADD4,"#",":
                      "       #"postalCode#": #"",PRACPOST,"#"":
                      "      }":
                      "    ]";
          WRITE     HTMLFILE;*+,"  }";
          RETURN
+
.------------------------------------------------------------------------------
. Format HCP Name in Title Text
.------------------------------------------------------------------------------
HCPNAME0  MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          RETURN
.
.------------------------------------------------------------------------------
. FHIR Location Resource for Ward.
.------------------------------------------------------------------------------
RESWRD00  STRIP     WBDESC
          STRIP     PTHSHOSP
          CLEAR     KEY16
          APPEND    "Ward-",KEY16
          APPEND    WWARD,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     WBTPFIL
          WRITE     HTMLFILE;*+," { #"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"wa#",":
                    "   #"display#": #"Ward#"  } ] },";
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "  #"reference#": #"Location/Hospital-",PTWDHOSN,"#"":
                    " } } ";
          RETURN
+
.------------------------------------------------------------------------------
. FHIR Location Resource for Bed
.------------------------------------------------------------------------------
RESBED00  MOVE      "BT",CATEGORY
          MOVE      WEFRBT,CODE
          CALL      GETCOD00
          MOVE      TDESC,BEDTDESC
.
          MOVE      "RT",CATEGORY
          MOVE      WRTYPE,CODE
          CALL      GETCOD00
          MOVE      TDESC,ROOMDESC
.
          MOVE      CATBW,CATEGORY
          MOVE      PTWDIFST,CODE
          CALL      GETCOD00
          MOVE      TDESC,IFSTDESC
.
          COMPARE   ZERO,WACTIVE
          IF        @EQUAL
            MOVE      "true",ACTVDESC
          ELSE
            MOVE      "false",ACTVDESC
          ENDIF
          STRIP     PTHSHOSP
          STRIP     WBTPFIL
.
          CLEAR     KEY16
          APPEND    "Bed-",KEY16
          PACK      WWARD,WWARD,SP70
          APPEND    WWARD,KEY16
          APPEND    WBED,KEY16
          APPEND    SP70,KEY16
          RESET     KEY16
          STRIP     KEY16
          REP       " -",KEY16
          STRIP     WWARD
.
          WRITE     HTMLFILE;*+,"{#"resourceType#": #"Location#",":
                    " #"id#": #"",KEY16,"#",":
                    " #"extension#": [":
                    " { #"url#":#"%BASEURL/extension/webPASService#"":
                        " ,#"valueString#":#"",PRGID,SP1,PRGNAM,SP1,VERSION,"#"},":
                    " { #"url#":#"%BASEURL/extension/webPASTemplate#"":
                        " ,#"valueString#":#"%TEMPLATEHOME/",WBTPFIL," %TEMPLATEVERSION#"}":
                    " ],":
                    " #"identifier#": { #"value#": #"",KEY16,"#"},":
                    " #"name#": #"",WBDESC,"#",":
                    " #"physicalType#": {":
                    "  #"coding#": [ {":
                    "   #"system#": #"http://hl7.org/fhir/location-physical-type#",":
                    "   #"code#": #"bd#",":
                    "   #"display#": #"Bed#"  } ] },";
.
          MATCH     SP70,WEXTN
          IF        !@EQUAL
             WRITE     HTMLFILE;*+," #"telecom#": [":
                       "{ #"system#": #"phone#",":
                       "  #"value#": #"",WEXTN,"#" } ],";
          ENDIF
          WRITE     HTMLFILE;*+," #"partOf#": { ":
                    "       #"reference#": #"Location/Ward-",WWARD,"#"":
                    " } } "
.
          RETURN
.
.------------------------------------------------------------
. Medically Cleared for Discharge 
.------------------------------------------------------------
MEDCLR00  MOVE      SP70,TDESC
          MOVE      SP70,MEDCLRDT
          MOVE      "028",ATRTYPE
          CALL      GPTATR00
          IF        NOTFOUND = 1
            GOTO      MEDCLR99
          ENDIF
.
          MOVE      "z1",CATEGORY
          MATCH     SP70,PTARCOD1
          IF        !@EQUAL
            PACK      KEY5,CATEGORY,PTARCOD1,SP70
            CALL      RDCODE1
          ENDIF
.
          MATCH     SP70,PTARTXT1
          IF        !@EQUAL
            UNPACK    PTARTXT1,CCENT,CYEAR,CMON,CDAY
            UNPACK    PTARTXT2,DIM5,DIM1,DIM2
            MOVE      "Discharge Delay. Cleared ",MEDCLRDT
            PACK      MEDCLRDT,MEDCLRDT,CDAY,SLASH,CMON,SP1,DIM5,SP1,TDESC
          ENDIF
.
MEDCLR99  RETURN
+
.**********************************************************************
. Update visxdcaf type 002 extra discharge details record
.**********************************************************************
UXDC0000  MATCH     Z70,MRFDDATE            * No medically ready for discharge
          GOTO      UXDC9999 IF EQUAL       * date received so exit
.
          MATCH     Z70,VSXDC014            * No reason for discharge
          GOTO      UXDC9999 IF EQUAL       * so exit
.
          MOVE      ADMISSNO,VSXDC001       * Visit Number
          MOVE      TWO,VSTYPIND            * Type of Data
          MOVE      ONE,VSDATIND            * Date Field index (1-10)
          MOVE      MRFDDATE,VSDATVAL       * Date Field value (DIM8)

          CALL      UPDVDT00
.
          MOVE      TWO,VSTYPIND
          MOVE      TWO,VSCODIND
          MOVE      VSXDC014,VSCODVAL
.
          CALL      UPDVCV00
.
UXDC9999  RETURN
+
.------------------------------------------------------------------------------ 
.
          INC       IBAWEBCD
          INC       IBALPCCD
          INC       PATRE1TM
.
          INC       OBSDETIO/INC      * Observations on Ward Map
.
          INC       APSMASIO/INC
          INC       AAEDE1IO/INC
          INC       ALLREFIO/INC
          INC       FMSLMAIO/INC      * Ledger Master Details
          INC       FMSCSAIO/INC
          INC       PATIN1IO/INC
          INC       PATINVIO/INC
          INC       PATITMIO/INC
          INC       BOKDIAIO/INC
          INC       BOKRX1IO/INC
          INC       BOKRC1IO/INC
          INC       CATCOMIO/INC
          INC       EMRVISIO/INC
          INC       IBAPOSIO/INC
          INC       IBALPCIO/INC
          INC       MLTSECIO/INC
          INC       OBSPCOIO/INC
          INC       OPRARDIO/INC
          INC       OPRSRGIO/INC
          INC       OPRDEAIO/INC
          INC       OPROPRIO/INC
          INC       OPRSESIO/INC            * Theatre Sessions Table
          INC       OPRSEMIO/INC            * Theatre Session Master
          INC       OUTECTIO/INC
          INC       OUTEAHIO/INC
          INC       OUTERHIO/INC
          INC       OUTERDIO/INC
          INC       OUTECAIO/INC
          INC       OUTSITIO/INC
          INC       OUTBB1IO/INC
          INC       PATASFIO/INC
          INC       PATALRIO/INC
          INC       PATATRIO/INC
          INC       PATBMDIO/INC
          INC       PATBRDIO/INC
          INC       PATHSPIO/INC
          INC       PATHFRIO/INC
          INC       PATDGWIO/INC
          INC       PATDADIO/INC
          INC       PATDSCIO/INC
          INC       PATDTRIO/INC
          INC       PRIDTRIO/INC
          INC       PRIHDBIO/INC
          INC       PRIHREIO/INC
          INC       PATNIDIO/INC
          INC       PATTRNIO/INC
          INC       PATELGIO/INC
          INC       PATONLIO/INC
          INC       PATMA1IO/INC
          INC       PATRE1IO/INC
          INC       PATREMIO/INC
          INC       PATRGMIO/INC
.
          INC       PMSCCDIO/INC   * Concession Card Details
          INC       PMSBDCIO/INC
          INC       PMSBRQIO/INC
          INC       PMSDTCIO/INC
          INC       PMSREGIO/INC
          INC       PMSHCGIO/INC
          INC       PMSHCPIO/INC
          INC       PMSPX2IO/INC
          INC       PMSCEXIO/INC
          INC       PMSRELIO/INC
          INC       PMSTLEIO/INC
          INC       PATCMCIO/INC
          INC       VISMDTIO/INC
          INC       VISMTXIO/INC
          INC       PATMI1IO/INC
          INC       PATVISIO/INC
          INC       PATUREIO/INC
          INC       PATDO1IO/INC
          INC       PATWR1IO/INC
          INC       PATNOBIO/INC
          INC       PATLOCIO/INC
          INC       PATPR1IO/INC
          INC       MRTLOCIO/INC
          INC       RESLNKIO/INC
          INC       PMSUCHIO/INC
          INC       PMSUCDIO/INC
          INC       PATFN1IO/INC
          INC       PATFX1IO/INC
          INC       PATVADIO/INC
          INC       PATVENIO/INC
          INC       PMSRCBIO/INC
          INC       MRTMASIO/INC
          INC       PATDAYIO/INC            * HPS Code Starts Here
          INC       PATNURIO/INC
          INC       PATPARIO/INC
          INC       PMSEADIO/INC
          INC       PRIEADIO/INC
          INC       PMSEAHIO/INC
          INC       PRIEAHIO/INC
          INC       PMSEBHIO/INC
          INC       PRIIBHIO/INC
          INC       PMSERDIO/INC
          INC       PMSERHIO/INC
          INC       PMSECAIO/INC
          INC       PRIECAIO/INC
          INC       PMSECOIO/INC
          INC       PMSETRIO/INC
          INC       PMSECTIO/INC
          INC       PRIECTIO/INC
          INC       PRIPRAIO/INC
          INC       PRIINVIO/INC
          INC       PMSESHIO/INC
          INC       PRIESHIO/INC
          INC       PMSESDIO/INC
          INC       PRIESDIO/INC
          INC       PMSEVTIO/INC
          INC       PMSMSWIO/INC        * Multiple Specialty Wards
          INC       PMSPDPIO/INC            * HPS Code Ends Here
          INC       PMSWORIO/INC
          INC       RCPBDTIO/INC
          INC       RCPBNKIO/INC
          INC       RCPDTEIO/INC
          INC       RCPREGIO/INC
          INC       NHIMASIO/INC
          INC       NHIETHIO/INC
          INC       VISCMTIO/INC
          INC       WATTR1IO/INC
          INC       VISXDCIO/INC
          INC       CALCBMIN
          INC       CATCOMTM
          INC       PATBRDTM
          INC       PMSOSDTM
          INC       PMSWORTM
          INC       CLNHIMAS                * Clear nhimasaf file variables
          INC       CLPATDSC
          INC       CLPATRE1
          INC       CLPMSPX2
          INC       CLPMSVX1
          INC       CLPATMIS
          INC       CLBOKRC1
          INC       CLPATATR
          INC       CLMRTMAS
          INC       DGCLICAC
          INC       DGCLICCP
          INC       PATNAMCD
          INC       PATDOCTM
          INC       PATDOCCD
          INC       PATMASTM
          INC       PATMISTM
          INC       PATATRTM
          INC       PMIGTNID
          INC       PMSPX2TM
          INC       PMSHCGTM
          INC       PMSHCPTM
          INC       PATMSXTM
          INC       PATWRDTM
          INC       PMSVX1TM
          INC       VISXDCTM
          INC       CALCAGE
          INC       NAMSTRCD
          INC       WEBDATCD
          INC       RSHWEBCD
          INC       DAYOFWEK
          INC       PMSVX1IO/INC
          INC       PMSNUTIO/INC            * v9.02.08
          INC       PMSNUTTM                * v9.02.08
          INC       CLPMSNUT                * v9.02.08
          INC       CLCATCOM
          INC       CLEMRVIS
          INC       CLOPRARD
          INC       CLOPRSRG
          INC       CLBOKRX1
          INC       CLVISXDC
          INC       TFILENAM
          INC       FHRDATCD
          INC       VISCMTCD
          INC       TIMEDIFS
          
          INC       PMSCURIO/INC
.
