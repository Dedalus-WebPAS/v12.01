.*******************************************************************************
.* System   :  BILL                                                           *
.* Program  :  IBAINP08                                                       *
.* Desc     :  EDI DATA EXTRACTION                                            *
.******************************************************************************
.* Date     :  27/07/93                                                       *
.* Author   :  Whirlpool      (GREATLY MODIFIED RUS 26)                       *
.* Mods.    :                                                                 *
.*                                                                            *
.*----------------------------------------------------------------------------*
.* V12.00.01  16/05/2025  Ebon Clements  TSK 0955096                          *
.*            Alphanueric visit number changes                                *
.* V11.05.01  24/03/2025  Davin          TSK 0956210                          *
.*            Add ICD10 Ed.13 - Go-live Date PTCNGDX3 (Sect.130 Pos.86)       *
.* V11.03.02  08/14/2023  Alina Bhari    TSK 0936077                          *
.*            Fixed the error of missing clinical code type field on          *
.*            extracting data -MHHD1200,EXHD1200                              *
.* V11.03.01  08/05/2023  Bella Turco    TSK 0931931                          *
.*            Added ICD10 Edition 12 - HDCODSYS = 16                          *
.* V11.02.02  31/03/2022  Davin          TSK 0917793                          *
.*            Add ICD10 Ed.12 - Go-live Date PTCNGDX2 (Sect.128 Pos.231)      *
.* V11.02.01  10/02/2022  Thanh T          TSK 0889899                        *
.*            Recompiled as WATTR1FD changes                                  *
.* V11.00.01  27/03/2020 Jill Parkinson Task 0879163                          *
.*            Changed to read category G indicator 2 for sex                  *
.* V10.15.02  20/02/2020  Thanh T        TSK 0887600                          *
.*            Increased the length of NMDS Diagnosis/procedure description    *
.*            from 100 to 200                                                 *
.* V10.15.01  08/11/2019  Jill Parkinson Task 0883852                         *
.*            Fixed icd 11 check to use PTCNGDX1 instead of PTCNGDVX          *
.* V10.14.02  22/07/2019  Ken Bell       TSK 0873964                          *
.*            Exclude ACC Flag and Claim Number for Cancelled Claim           *
.* V10.14.01  06/03/2019  Ebon Clements  TSK 0851550                          *
.*            Added ICD10 Edition 11 - HDCODSYS = 15                          *
.* V10.12.02  07/03/2018  Ania P         TSK 0851550                          *
.*            Removed clearing of HELDAYS for mentl health patients           *
.* V10.12.01  05/03/2018  Ania P         TSK 0851550                          *
.*            Removed population of HECOB - field no longer used.             *
.* V10.11.02  19/09/2017  Ebon Clements  TSK  0842548                         *
.*            Set sent flag to yes after processing D1 - change admission     *
.*            date PATUNAFD record - WRET0000                                 *
.* V10.11.01  22/08/2017  Ebon Clements  TSK  0842548                         *
.*            Re read patunaaf record prior to sent flag update - UNAD5000    *
.* V10.10.04  31/05/2017  Richa Phogat   TSK  0837922                         *
.*            1.Ignore records to process when patmi1af.aelig has value 4 or 5*
.*            2.When patmi1af.aelig=3 (Resubmit general), check Inpatient     *
.*            audit file (patunaaf) for matching visit record, and if         *
.*            patunaaf.PTUNTYPE =3, then use values from fields PTUNODTE and  *
.*            PTUNOTTM to populate the D1 record                              *
.* V10.10.03  26/04/2017  Ebon Clements  TSK  0832315                         *
.*            Set the HR records agency code with the district health boards  *
.*            associated number - EXHR0000                                    *
.* V10.10.02  31/03/2017  Jill Parkinson TSK  0836101                         *
.*            Added check for blank patecdaf records in ETPB0000              *
.* V10.10.01  17/03/2017  Davin          TSK 0833093     HDP 2017/2018        *
.*            Add ICD10 Ed.10 - Go-live Date PTCNGDVX (Sect.110 Pos.85)       *
.* V10.09.03  01/02/2017  Ania P         CAR  261630                          * 
.*            Swapped PORT for TFILENAM                                       *
.* V10.09.02  30/01/2017  Jill Parkinson TSK  0831184                         *
.*            Added use of Cat A, ind 10 for birth location                   *
.* V10.09.01  05/01/2017  Don Nguyen      TSK 0814332                         *
.*            Modified to use batch number (BATCHNO) from Associate Field 1   *
.*            of the DHB code (DHBCODE) entered (Cat dh).                     *
.* V10.08.06  04/11/2016  Peter Vela      TSK 0823872                         *
.*            Fixed HDCOUNT comparison in EXHD0000                            *
.* V10.08.05  26/09/2016  Ebon Clements   TSK 0323482                         *
.*            Removed retired event type "ID" intended day case  - EXHE0500   *
.* V10.08.04  22/06/2016  Jill Parkinson  TSK 0821241                         *
.*            Replaced HECSYSID from tempfile as no longer used               *
.* V10.08.03  24/05/2016  Nicole Torrisi    TSK 0809632                       *
.*            Fixed EXHD0000 and MHHD0000 to set HDCODSYS to 14 for ICD10 Ed 8*
.*            and 15 for ICD10 Ed 9                                           *
.* V10.08.02  14/04/2016  Don Nguyen        TSK 0303887                       *
.*            Modified WRET0000 & WRHE0000 to write 'Message Function'        *
.*            (HEMFUNCT) into 'Client System Identifier' (Field 42 - HECSYSID)*
.* V10.08.01  23/03/2016  Don Nguyen        TSK 0303887                       *
.*            Modified EXHE0000 to use new key for record write (WRPMNMD1)    *
.* V10.07.01  19/02/2016  Don Nguyen        TSK 0303887                       *
.*            Modified WRET0000 to make HEDETTXT comma-delimited              *
.* V10.06.07  26/08/2015  Peter Vela     CAR 320318                           *
.*            Added Increment Batch Number switch                             *
.* V10.06.06  14/08/2015  Jill Parkinson CAR 320666                           *
.*            Commented out update of mehdlsafi.mldlsent=Y                    *
.* V10.06.05  11/06/2015  Don Nguyen        CAR 303887                        *
.*            Modifications for CRISP (Sprint) - NMDS (WRPMNM)                *
.* V10.06.04  25/05/2015  Nicole Torrisi    CAR 312772                        *
.*            Changed Occupation variable (HEOCCUP) from 4 to 6 characters    *
.* V10.06.03  21/04/2015  Nicole Torrisi    CAR 312772                        *
.*            Modified to use Assoc Fld 1 (PTCDASC1) instead of HDP Default   *
.*            (THCSCOD) for Cat P1-6 (PTCNEIOC) Occupation                    *
.* V10.06.02  23/03/2015  Jill Parkinson    CAR 303881                        *
.*            Modified to only use first 3 chars of category dh HDP           *
.* V10.06.01  17/03/2015  Davin         CAR 311669      HDP 2015/16           *
.*            Add PTCNGDV9 for ICD10 Ed.9 Go-live Date (Sect.110 Pos.77)      *
.* V10.05.04  07/10/2014  Don Nguyen        CAR 303881                        *
.*            Modified DTFN0000 to call PATCODKY.                             *
.*            Modified prompt for District Health Board in DTFN0000.          *
.* V10.05.03  01/10/2014  Don Nguyen        CAR 305624                        *
.*            Modified EXHC3000 to use Indicator 8 (TCINDC8) of Cat "LS"      *
.*            instead of TCINDC4 (CAR 219350).                                *
.* V10.05.02  29/08/2014  Don Nguyen        CAR 303881                        *
.*            Added CHKDHB00 to validate 'District Health Board' of the       *
.*            patient visit hospital (PMVXMHOS). Added call to CHKDHB00 after *
.*            calls to RDPMVX11.
.*            Modified extract to use the HDP Default of 'District Health     *
.*            Board' (DHBPREFX) instead of site prefix (3 characters) that    *
.*            was used previously.                                            *
.* V10.05.01  19/08/2014  Don Nguyen        CAR 303882                        *
.*            Modified DTFN0000 to use PTCNMDSB for next batch number.        *
.*            Incremented BATCHNO upon successful extract run.                *
.*            Increased size of CMDLINE to cater for longer pathname.         *
.* V10.04.04  09/07/2014  Ebon Clements     CAR 303325                        *
.*            Call ITEN0000 in EXHD0000 and MHHD0000 for coding system 14     *
.*            Include ICD10 ED8 go live date in coding system 14              *
.* V10.04.03  03/04/2014  Ebon Clements     CAR 298039                        *
.*            Fixed date tests for coding system on MH visits - MHHD0000      *
.* V10.04.02  02/04/2014  Ebon Clements     CAR 298039                        *
.*            Set coding system to 14 for ICD ED 8 Mental Health  -  HDCODSYS *
.* V10.04.01  21/03/2014  Ebon Clements     CAR 298039                        *
.*            Set coding system to 14 for ICD ED 8  -  HDCODSYS               *
.* V10.03.11  25/11/2013  Patrick Adair     CAR 199297                        *
.*            Exclude Residential Admissions from extract - NZ only           *
.* V10.03.10  06/05/2013  Nicole Torrisi    CAR 280968                        *
.*            Removed all changes to setting of HDONSET                       *
.* V10.03.09  23/04/2013  Davin         CAR 284420      HDP 2013/14           *
.*            Add PTCNGDV8 for ICD10 Ed.8 Go-live Date (Sect.110 Pos.69)      *
.* V10.03.08  25/03/2013  Nicole Torrisi    CAR 280968                        *
.*            Put change into EXHD0000 as well                                *
.* V10.03.07  14/03/2013  Nicole Torrisi    CAR 280968                        *
.*            July 2013 changes - 9 to HDONSET when PTCDOSET is blank         *
.* V10.03.06  12/03/2013  Nicole Torrisi    CAR 280968                        *
.*            July 2013 changes - 9 to HDONSET when PTCDOSET is blank         *
.* V10.03.05  04/03/2013  Nicole Torrisi    CAR 280968                        *
.*            July 2013 changes - 9 to HDONSET when PTCDOSET is blank         *
.* V10.03.04  07/05/2012  Nicole Torrisi    CAR 260103                        *
.*            Extended testing period to begin 1st May 2012                   *
.* V10.03.03  23/04/2012  Nicole Torrisi    CAR 260103                        *
.*            July 2012 changes                                               *
.* V10.03.02  27/01/2012  Mike Laming       CAR 219350                        *
.*            Added test for CAT "LS" Ind.4 ="X" to exclude record at EXHC3000*
.* V10.03.01  05/12/2011  Jill Parkinson    CAR 254995                        *
.*            Added match of DDATE to MHDLSDAT                                *
.* V10.02.01  28/03/2011  Mike Laming   CAR 240107                            *
.*            Mods to PATECDaf & PATECOaf variables & Keys - file change      *
.*            Remove PATMDSFD/IO & all its bits inc. SDOD0000                 *
.* V10.01.03  08/02/2011  Jill Parkinson    CAR 237492                        *
.*            Mods to clear DTIME                                             *
.* V10.01.02  07/02/2011  Jill Parkinson    CAR 237492                        *
.*            July 2011 changes                                               *
.* V10.01.01  03/02/2011  Jill Parkinson    CAR 237492                        *
.*            July 2011 changes                                               *
.* V10.00.03  12/04/2010  Steve Armstrong   CAR 219111                        *
.*            Recompiled for changes to PATUNAFD.                             *
.*            Mods for change from KEY17 to KEY25 in PATUNAFD.                *
.* V10.00.02  31/03/2010  Mike Laming  CAR 217575                             *
.*            Recompiled for changes to MEHDIAFD                              *
.*            Mike Laming   CAR 208570                                        *
.*            Recompiled for changes to PATCRDFD.                             *
.* V10.00.01  07/04/2010  Mike Laming   CAR 219246      HDP 2010              *
.*            Add PTCNGDV7 for ICD10 Ed.7 Go-live Date (Sect.110 Pos.61)      *
.******************************************************************************
.*  V9.12.08  15/09/2009  Jill Parkinson CAR 197446                           *
.*            Mods to not send tran source codes with ind 11=X for discharge  *
.*  V9.12.07  08/09/2009  Jill Parkinson CAR 197446                           *
.*            Mods to not send transfer source codes with indicator11=X       *
.*  V9.12.06  27/08/2009  Davin         CAR 200881                            *
.*            Added array (savlscod) to check on legal status code/date       *
.*            combinations so as not to send duplicates.                      *
.*  V9.12.05  13/08/2009  Jill Habasque CAR 203320                            *
.*            Mods to check enddate in MHHD000                                *
.*  V9.12.04  30/07/2009  Jill Habasque CAR 201828                            *
.*            Put back set of AELIG to 3 for current MH patients              *
.*  V9.12.03  29/07/2009  Jill Habasque CAR 194836                            *
.*            Mods to check MHDLSENT that was commented out                   *
.*  V9.12.02  28/06/2009  Jill Habasque CAR 194836                            *
.*            Mods to only set MHDLSENT and AELIG if PROD extract             *
.*            Also check current MH admissions were admitted before extract end*
.*  V9.12.01  24/06/2009  Jill Habasque CAR 194836                            *
.*            Mods to send all mehdlsaf records for admission                 *
.*  V9.11.03  16/06/2009  Jill Habasque CAR 198823                            * 
.*            Mods to use PTCNDTRF                                            *
.*  V9.11.02  06/03/2009  Jill Habasque CAR 188944                            * 
.*            July 2009 mods                                                  *
.*  V9.11.01  14/11/2008  Jill Habasque CAR 155565                            *
.*            Added back GOTO EXHC2000 so all records are sent                *
.*  V9.10.05  05/09/2008  Jill Habasque CAR 155565                            * 
.*            Removed check for MHDLSENT in EXHC0000                          *
.*            Commented out GOTO EXHC2000 so only last mehdlsaf record is sent*
.*  V9.10.04  25/07/2008  Jill Habasque CAR 174060 and 174050                 * 
.*            Mods to not zero fill HEICUHRS and zero fill HEADMWGT           *
.*  V9.10.03  15/07/2008  Jill Habasque CAR 173828                            * 
.*            Mods to use FORM3A instead of FORM2A                            *
.*  V9.10.02  14/07/2008  Jill Habasque CAR 173744                            *
.*            Added checks for HDCODSYS=13                                    *
.*  V9.10.01  13/05/2008  Mike Laming   CAR 166095                            *
.*            Re-compiled for PATECDFD & PATECOFD - Increase PTE?DESC to 100  *
.*  V9.09.01  18/04/2008  Jill Habasque CAR 166095                            *
.*            July 2008 changes                                               *
.*  V9.08.03  30/05/2007  Mike Laming   CAR 125991                            *
.*            Re-compiled for PATCRDFD/IO - New fields in file                *
.*  V9.08.02  25/05/2007  Mike Laming   CAR 125991                            *
.*            Re-compiled for PATCRDFD/IO - Record increased                  *
.*  V9.08.01  20/04/2007  Mike Laming   CAR 138935                            *
.*            Change Extract flag to new field MHDLSENT                       *
.*  V9.07.01  30/08/2006  Mike Laming   CAR 109741                            *
.*            NZ Mods to Legal Status - to use "mehdlsaf" (not "mehlegaf")    *
.*            ("mehlegaf" stuff only commented out in case logic needed later)*
.*  V9.04.02  05/10/2005  Jill Habasque CAR 73181                             *
.*            Mods to use pmvxpost if not blank                               *
.*  V9.04.01  09/05/2005  Mike Laming   CAR 60913                             *
.*            Mods for NZ 1 July 2005 requirement                             *
.*            - change version in HRLAYVER                                    *
.*            - remove fields in "HE" - HEREFDTE, HE1STCON, HEDONWL, HESEVRTY *
.*            - remove fields in "HD" - HDBASCAN, HDSTGCAN, HDMELINV,         *
.*                                      HDMELTHK & HDLABCOD                   *
.*  V9.03.02  05/08/2004  Jill Habasque CAR 50611                             *
.*            Mods to use ACC details or EOC details                          *
.*  V9.03.01  16/03/2004  Guomin Fu  CAR 48127                                *
.*            Mods for NZ 1 July 2004 requirement                             *
.*            -- Added read on PTCNGDV3 ( ICD10 Version 3 go live)            *
.*            -- Placed a check on DDATE to see if it's before or after go    *
.*            live of ICD10 V3                                                *
.*  V9.02.01  21/03/2003  Tracey Nguyen          SRF 23950                    *
.*            Changed KEY16 to KEY25 for all references to PATCRDA1           *
.*  V9.02.00  29/10/2002  Lina Vo      SRF 22687                              *
.*            Ported to V9 replaced old PATCRDFD fields with new V9 PATCRDFD. *
.*            Added move extract file to web.                                 *
.******************************************************************************
.*  V5.09.06  18/10/2001  Mike Laming  SRF 13087                              *
.*            Remove statement setting PTCNHSEM to zero (                     *
.*  V5.09.05  21/08/2001  Tonii                                               *
.*            Placed a check on DDATE to see if it's before or after go live  *
.*  V5.09.04  06/07/2001  Steve Downing  SRF 11174                            *
.*            Fixed event local identifier..... again                         *
.*            12/07/2001  Tonii SRF 11145 & 11097                             *
.*            Mods to extract new 'E' codes 6,7,8,P & A, as well as accident  *
.*            dates when processing run                                       *
.*  V5.09.02  14/06/2001  Tonii                                               *
.*            - Put read on PTCNGDV2 for check on go live date                *
.*            - UNPACKed ABWGHT into HEBWGHT instead of move                  *
.******************************************************************************
.*  V5.09.B03 23/04/2001  Tonii                                               *
.*            - Changed version number in Header Record to be "V011.0"        *
.*            - New field added in HE to capture CPAP hours                   *
.*            - included "11" as option if using ICD-10-AM 2nd Edition        *
.*  V5.09.B02 10/04/2001  Steve Downing  SRF 647826                           *
.*            Fixed Setting of AELIG flag                                     *
.*        V5.09.B01 26/02/2001  Jill Habasque                                 *
.*                  Mods for ABWGHT - changed to DIM 6                        *
.******************************************************************************
.*  V5.08.07  26/09/2000  Steve Downing  SRF 647249                           *
.*            Fixed event local identifier in extract                         *
.*  V5.08.06  23/08/2000  Caleb Sharman                                       *
.*            Changed Health Fund variables to be 8 chars                     *
.*  V5.08.05  02/08/2000  Steve Downing                                       *
.*            Fixed extration of occupation, mods to use PTCNBAGE             *
.*  V5.08.04  13/07/2000  Steve Downing  SRF 646967                           *
.*            Fixed event local identifier in extract                         *
.*  V5.08.03  06/07/2000  Greg Horvat                                         *
.*            Moved the parameter PTCNEDID to PTCNNZED                        *
.*  V5.08.02  15/06/2000  Steve Downing                                       *
.*            Version 10 NMDS file layout mods                                *
.*  V5.08.01  23/05/2000  Steve Armstrong                                     *
.*            Mods to default MH diagnoses to use CMDISP for the prefix       *
.*            of the first diagnosis code and CMDISS for the second           *
.*            diagnosis code (MHHD0000).  Previously, PTEDTYPE was not        *
.*            being set.                                                      *
.*            Also replaced harcoded ANSA, ANSB and ANSO with CMDISP,         *
.*            CMDISS and CMOPRT respectively for HDCODTYP.                    *
.*  V5.08.B01 15/03/2000  Greg Horvat                                         *
.*            Changed to get the coding from the episode coding files         *
.******************************************************************************
.*  V5.07.05  27/10/1999  Jill Habasque SRF 646118                     *
.*            Added call to ITEN0000 in MHHD0000                       *
.*  V5.07.04  15/07/1999  Davin                                        *
.*            - More mods for 1999/2000 (Vers 9.2 NMDS File Layout)    *
.*  V5.07.03  08/07/1999  Davin  Jul'99 Mods                           *
.*            - Mods for 1999/2000 (Vers 9.2 NMDS File Layout)         *
.*            - Capture accident flag & acc. claim no. from admission  *
.*              file if ACC/EOC not being used & parameters set        *
.*  V5.07.02  03/05/1999  Steve Armstrong   SRF 645512                 *
.*                  Mods to strip of fifth digit of morphology codes   *
.*  V5.07.01  16/04/1999  Jim Stathopoulos SRF 645451                  *
.*                  Fixed the NMDS extract                             *
.*  V5.07.B02 26/11/1998  Davin                                        *
.*                  Mods for inclusion of ICD10                        *
.*  V5.07.B01 17/11/1998  Davin                                        *
.*                  Mods for 507                                       *
.***********************************************************************
.*  V5.06.01  11/11/1998  J.Tan  SRF 644942                            *
.*                  Mods to check for "D" on the 4th indic for catg "P"*
.*                  for intended day cases                             *
.*  V5.05.02  01/01/1998  Nick   SRF 643968                            *
.*                  Removed stripping of HETESTI in extract file.      *
.*                  Increased COUNT to 48 from 46 so that all 48       *
.*                  extract fields are written now.                    *
.*  V5.05.01  22/09/1997  Steve Armstrong                              *
.*                  Mods for AXIS V to be a free text description.     *
.*                  (MEHRVDIA)                                         *
. **********************************************************************
.*  V5.04.07  17/07/1997  Steve Armstrong    MOH Mods                  *
.*            Mods for ACC M46 Number and Accident Flag.               *
.*            Mods for changes to MEHLEGFD for review status.          *
.*  V5.04.06  07/11/1996  Howellsy                                     *
.*            Added Review Time & Legal Status Time.                   *
.*  V5.04.05    26/08/1996  Howellsy         SRF 641988                *
.*              Set Unadm Mental Health to "IM" = event type           *
.*  V5.04.04    23/08/1996  Howellsy         SRF 641935                *
.*              Removed carriage return at eor                         *
.*  V5.04.03    22/08/1996  Howellsy         SRF 641749                *
.*              Removed PTCNEXBD                                       *
. * V5.04.02 :  13/08/96  Howellsy    SRF 641894                       *
. *          :  Extra HD record for MH patients properly.              *
. * V5.04.01 :  26/06/96  Howellsy    MOH 96 Mods                      *
. *          :  If Melanoma thickness is '00.000' then set to null     *
. **********************************************************************
. * V5.03.B1 :  07/02/95  Whirlpool   Release 5.03                     *
. * V5.03.B2 :  15/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.B3 :  16/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.B4 :  19/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.B5 :  19/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.B6 :  21/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.B7 :  21/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.B8 :  21/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.B9 :  22/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.B10:  23/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.02 :  23/06/95  Whirlpool   Release 5.03 changes             *
. * V5.03.03 :  30/06/95  Whirlpool   Release 5.03 changes             *
. *          :  Changed to use PTCNGEST for Gestation period           *
. * V5.03.04 :  05/07/95  Whirlpool   compliance testing changes       *
. *          :  fixed sending of V codes to use MDTYPE not just "B"    *
. *          :  fixed Problem with event local identifiers             *
. * V5.03.05 :  19/07/95  Whirlpool   compliance testing changes       *
. *          :  added AELIG = 3 for resubmissions                      *
. * V5.03.06 :  19/10/95  Whirlpool   compliance testing changes       *
. *          :  fixed for slight coding changes for ICD9-CM-A          *
. *          :  MHHD routine                                           *
. * V5.03.07 :  20/10/95  Whirlpool   compliance testing changes       *
. *          :  fixed for slight coding changes for ICD9-CM-A (again)  *
. * V5.03.08 :  03/11/95  Whirlpool   srf 612493                       *
. *          :  Changed not to send two birth events for the same      *
. *          :  patient and admission date (uses  HEUNIQUE flag )      *
. * V5.03.09 :  20/12/95  Whirlpool                                    *
. *          :  Changed last change to use indicator 4 of cat P        *
. *          :  If this is a "B" and adm date = birth date then this   *
. *          :  is a birth event                                       *
. * V5.03.10 :  22/12/95  Whirlpool   srf 613301                       *
. *          :  changed to get the undischrge record for unadmit (UNAD)*
. *          :  so it can set up discharge date correctly              *
. *          :  they must have been discharged to be sent              *
. * V5.03.11 :  05/01/96  Greg Horvat srf 641128                       *
. *          :  The read of the nhi master file was commented out for  *
. *          :  the loop on the discharge date range. Changed to read  *
. *          :  the nhi master file.                                   *
. * V5.03.12 :  16/01/96  Whirlpool   srf 613301                       *
. *          :  modified prog to use new hospital field from patunaaf  *
. *          :  for undischarged/unadmitted patients                   *
. * V5.03.13 :  30/01/96  Whirlpool   srf 613301                       *
. *          :  modified prog to use new hospital field from patunaaf  *
. * V5.03.14 :  06/02/96  MATT                                         *
. *          :  Added the extraction of undischarged MEH patients      *
. *          :  08/02/1996 Whirlpool                                   *
. *          :  fixed flagging of cancer patients in CHAN0000          *
. *          :  Commented out MHAD0000 fo Rfor this version only       *
. * V5.03.15 :  08/02/96  Whirlpool                                    *
. *          :  Uncommented out MHAD0000 routine so Matts stuff can    *
. *          :  be tested                                              *
. **********************************************************************
. *          :                                                         *
. *          :  V5.01.02  Steve O'Gorman  12/08/93                     *
. *          :  fixed bugs                                             *
. *          :  V5.01.03  Whirlpool       17/08/93                     *
. *          :  Added use of file number and path from control file    *
. *          :  Changed to extract no medical data if patient is dead  *
. *          :  V5.01.04  Whirlpool       25/08/93                     *
. *          :  Changed postion if directory path in control file      *
. *          :  V5.01.05  Rob             25/10/93                     *
. *          :  A2 records are no longer sent, and are replaced by     *
. *          :  sending a D1 and A1 record. Also delete all patodc file*
. *          :  records after they have been sent.                     *
. *          :  V5.01.06  Steve O'Gorman  03/11/93                     *
. *          :  Remove MOVE ZER0,AELIG before BRANCH                   *
. *          :  V5.01.07  Steve O'Gorman  22/11/93                     *
. *          :  Made Coding Indicator conform to NMDS Data Dictonary   *
. *          :  V5.01.08  S.Barcham                                    *
. *          :  Remove DMON                                            *
. *          :  V5.01.09  Matt Surridge  Quote.                        *
. *          :  Upgraded for EDI File Format 4.5a.                     *
. *          :  Added the extraction of Mental Health Details.         *
. *          :  V5.01.10  Matt Surridge  Extended Quote 8022.          *
. *          :  Upgraded EDI extraction due to revised specifications. *
. *          :            Whirlpool      quote 8022                    *
. *          :  added mental health leave end codes (mehleraf)         *
. *          :  V5.01.11  whirlpool      Extended Quote 8022.          *
. *          :  Fixed unique transaction number for d1 - a1 combos     *
. *          :  V5.01.12  Rob Leonard                                  *
. *          :  Bug fixes                                              *
. *          :  V5.01.13  whirlpool      Extended Quote 8022.          *
. *          :  Fixed Calculation of leave days                        *
. *          :  Fixed sending of accident date HDEXTDAT                *
. * 20/07/94 :  V5.01.14  whirlpool      Extended Quote 8022.          *
. *          :  FIXED Leave calculation for multiple leave days.       *
. *          :  Fixed sending of date on list.                         *
. * 25/07/94 :  V5.01.15  whirlpool      Extended Quote 8022.          *
. *          :  Modified for Warning Re-submits  (AELIG = 2)           *
. *          :  Warning Re-submits send A2 records always              *
. * 03/10/94    V5.01.16  whirlpool      Extended Quote 8022.          *
. *          :  Modified for PATODC file sent flag                     *
. * 17/10/94 :  V5.01.17  matt                                         *
. *          :  Fixed writing of HEAGENCY.                             *
. * 28/10/94 :  V5.01.18  ROD                          SRF 133136      *
. *          :  Fixed blank admission source                           *
. * 23/11/94 :  V5.01.19  Whirlpool                                    *
. *          :  changed to send deceased patients ?!!!                 *
. * V5.01.20 :  24/22/94  Whirlpool                                    *
. *          :  Changed HEAGENCY to work on ward from transfer file    *
. * V5.01.21 :  24/22/94  Whirlpool                                    *
. *          :  Fixed so IBCNMHOS Read in from correct position MAT    *
. *          :  YOU COMPLETE NUFFY !!!!                                *
. * V5.01.22 :  29/11/94  Whirlpool                                    *
. *          :  Changed sending nmp number to test pararmeter PTCNNZUR *
. * V5.01.23 :  07/12/94  Whirlpool                                    *
. *          :  fixed sending of event type for HD records             *
. * V5.02.00 :  17/11/94  5.02                                         *
. * V5.02.01 :  12/12/94  Whirlpool                                    *
. *          :  Changed for 5.02 added use of NHIMAS                   *
. * V5.02.02 :  07/02/95  Whirlpool                                    *
. *          :  Added code for Maternity, Severity code,event info     *
. *          :  and cleared leave days if zero.                        *
. *          :  Fixed sending of HESUPPI                               *
. **********************************************************************
.
          INC       STD001FD
.
          INC       EOCAFCFD/INC           * ACC Flag changes file
          INC       EOCLNKFD/INC           * Link file
          INC       EOCREFFD/INC           * Referral File
          INC       MEHCONFD/INC
          INC       MEHDIAFD/INC           * Mental Health Diagnosis File
          INC       MEHDS1FD/INC           * Mental Health Discharge File
          INC       MEHDLSFD/INC           * Mental Health Legal Status Details
          INC       MEHLERFD/INC           * Mental Health Leave end codes
          INC       MEHVI1FD/INC           * Mental Health Visit File
          INC       NHIMASFD/INC           * NHI master file
          INC       OUTRF1FD/INC           * O/P referral Letter File
          INC       PATCODFD/INC           * codes file
          INC       PATCONFD/INC           * control file
          INC       PATCRGFD/INC           * cancer reg header
          INC       PATCRDFD/INC           * cancer reg details
          INC       PATDADFD/INC           * adm/disc transfer dest. file
          INC       PATDO1FD/INC           * doctor file
          INC       PATDSCFD/INC           * discharge file
          INC       PATECDFD/INC
          INC       PATECOFD/INC
          INC       PATHSPFD/INC           * Hospital File
          INC       PATICDFD/INC           * icd-9cm diseases file
          INC       PATICOFD/INC           * icd-9cm operations file
          INC       PATICUFD/INC           * ICU file
          INC       PATLINFD/INC           * link file 
          INC       PATMA1FD/INC           * master file
          INC       PATMI1FD/INC           * admission file
          INC       PMSVX1FD/INC           * visit extension
          INC       PMSNMDFD/INC           * NMDS Extract Records
          INC       PMSNMHFD/INC           * NMDS Transmission File Batches
          INC       PATNIDFD/INC           * nmpi file
          INC       PATODCFD/INC           * Pat Oper/Dis changes file
          INC       PATTRNFD/INC           * transfer file
          INC       PATUNAFD/INC
          INC       PATVADFD/INC
          INC       PATVISFD/INC           * visit file
          INC       PATWR1FD/INC           * ward file
          INC       PATWC1FD/INC
          INC       PMSWX1FD/INC
          INC       WATTR1FD/INC
          INC       IBASEQFD/INC
          INC       TFILEVAR/INC
          INC       WEBERRFD/INC
          INC       PATCALAG/INC
          INC       PATDHEAD/INC
+
.**********************************************************************
.*                           VARIABLES                                *
.**********************************************************************
.
DIM4A     DIM       4
.
BJDAY     FORM      3            * julian birth day
BMNT      FORM      2            * birth date month
BDPC      INIT      "BD"         * 1st half of board postcode
BABYDOB   DIM       8            * babies date of birth work variable to
.                                  calculate mothers age at birth
BATCHNO   DIM       5            * batch number for filename
.
CJDAY     FORM      3            * julian discharge day
CODE      DIM       3
COUNT     FORM      2            * counter
CALDAYS   FORM      4            * number of days
CODEA     INIT      "A "         * admission type
CODEC     INIT      "C "         * nation
CODECC    INIT      "CC"         * admission care
CODED     INIT      "D "         * discharge status
CODED1    INIT      "D1"         * user defined field 1
CODEM     INIT      "M "         * marital status
CODEP     INIT      "P "         * admission class/patient category
CODELE    INIT      "LE"         * Category for Mental Health Leave End Code
CODEP1    INIT      "P1"         * race 
CODEPO    INIT      "PO"         * place of occurance
CODES     INIT      "S "         * admission source
CODET     INIT      "T "         * resident status
CODEU1    INIT      "U1"         * users define field 1
CODEU2    INIT      "U2"         * user define field 2
CODEU4    INIT      "U4"         * user define field 4
CODEU6    INIT      "U6"         * user define field 6
CATdh     INIT      "dh"
.
SP100     INIT      "                                                  ":
                    "                                                  "
.
DHBPREFX  DIM       3        * HDP Default of 'District Health Board' (Cat dh)
DHBCODE   DIM       3        * District Health Board Code (Cat dh)
IBCNMHOS  FORM      1
INCRBATN  DIM       1
.
.-----  Variables for Calcdays ------
.
CDYSDAYS  FORM      6
CDYSFDTE  DIM       8
CDYSTDTE  DIM       8
CDYSYEAR  FORM      2
CMDLINE   DIM       100
.
CANCERPT  FORM      1
CANCCODE  FORM      1
.
DAYS      FORM      2            * days in month
.                                * Unpack Diag & Oper Codes
DIM2A     DIM       2
DIM2B     DIM       2
DIM3      DIM       3
DIM4      DIM       4
DIM5      DIM       5
DIM6      DIM       6
DIM8      DIM       8
DIM8A     DIM       8
DIM9      DIM       9
DIM13     DIM       13
DIM30     DIM       30           * I5 Description
DIM50     DIM       50
DIM70     DIM       70
DIM90     DIM       90
DIM200    DIM       200
DDOB      DIM       8            * date of birth
DMNT      FORM      2            * discharge date month
DIM7      DIM       7            * last 7 characters of u/r number
DIOPFLAG  FORM      1            * 1 = Diseases , 2 = Operations
DLFLAG    FORM      1            * discharge to leave flag
DOYR2013  FORM      1
.
ENDDATE   DIM       8            * to date keyed in (ccyymmdd)
.
FNAME     DIM       8            * name of the tempfile
FORM3A    FORM      3
FORM3     FORM      3
FORM5     FORM      5
FORM6     FORM      6
FORM8     FORM      8
FORM14    FORM      14
FILEEXTN  INIT      ".ndm"       * hardcoded filename extension
FILENAME  DIM       13           * name of the file created
FROMDATE  DIM       8            * ccyymmdd
.
HEDETTXT  DIM       500          * Extract record HE Details Text
HOSPITAL  DIM       3            * Hospital for undischarged patients
.
JYEAR     FORM      2            * used in nhospday
JDAYS     FORM      3            * used in nhospday
.
LSCOUNT   FORM      2            * legal status counter
.
NBRDAYS   FORM      4            * number of days
NODFLAG   FORM      1            * Flag for Non-Discharged MEH Patients
.
OLDCPAP   DIM       5
OPDATE    DIM       8            * operation date
OYEAR     FORM      "365"
.
PADDR     DIM      59            * patients address (paddr1,paddr2,psubrb)
PATHNAME  DIM      60            * full path name of extract file
PNAME     DIM      38            * patients name (psname,pgname)
POST1     DIM       2            * first half of postcode
POST2     DIM       2            * second half of postcode
PROCENV   DIM       4            * processing environment
.
QUOTE     INIT      "#""
.
RFLAG     FORM      1
.
SAVDOC    DIM       6            * saved doctor code
SAVAGE    FORM      3            * saved age
SAVKEY25  DIM      25
SAVLSCOD  DIM      10[50]        * save legal status date/code combo
SITEPREF  DIM       3            * site prefix for filename
STRTDATE  DIM       8            * from date keyed in (ccyymmdd)
SURGEON   DIM       5
SAVDATE   DIM       8
SAVRECNO  FORM      2
.
SP90      INIT      "                                             ":
                    "                                             "
.
TODAY     DIM       8            * current date (ccyymmdd)
TODATE    DIM       8            * ccyymmdd
TOTALREC  FORM      5            * total records sent
TPBASCAN  DIM       1            * Temporary var for basis of cancer
TPMELTHK  DIM       6            * Temporary var for melanoma thickness
TPMELINV  DIM       1            * Temporary var for melanoma invasion level
TPLABCOD  DIM       4            * Temporary var for laboratory code    
TPSTGCAN  DIM       1            * Temporary var for stage of cancer    
.
VARIABLE  DIM       127
.
UNADFLAG  FORM      1
.
WDATE1    DIM       8            * date used in calculating the number of days
WDATE2    DIM       8            * date used in calculating the number of days
.
XXTRACT1  FILE      ASCII, FIXED=256        * extract file
XXTRTMP1  FILE      ASCII, FIXED=256        * extract tempfile
.
.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
.      HR (Header) Record Layout
.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
.
HRRTYPE   DIM       2                       * record type
HRHAGNCY  DIM       4                       * health agency code
HRFILNAM  DIM       13                      * extract filename
HRNORECS  DIM       5                       * no. of records sent
HRSNDDTE  DIM       8                       * date sent
HRPROENV  DIM       4                       * NZHIS processing environment
VERS2012  INIT      "V015.0"                * version (after 01/07/12)
VERS2013  INIT      "V015.0"                * version (after 01/07/13)
.
.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
.      HE (Health Event) Record Layout
.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
.
HERTYPE   DIM       2
HEHCUID   DIM       7
HEEVTCOD  DIM       2
HEEVTSTD  DIM       8
HEEVTSDT  DIM      12
HEAGENCY  DIM       4
HEUNIQUE  DIM       1
HEMFUNCT  DIM       2
HEDOMIC   DIM       4
HESEX     DIM       1
HEDOB     DIM       8
HEETHNIC  DIM       2
HEETHNI2  DIM       2
HEETHNI3  DIM       2
HERESI    DIM       1
HEASRCE   DIM       2
HEDEPT    DIM       3
HECARE    DIM       2
HEETYPE   DIM       2
HEEDATE   DIM       8
HEEDATTM  DIM      12
HECOB     DIM       3
HEOCCUP   DIM       6
HEOCCDES  DIM       72           * 2 extra chars for quotes
HEBDLOC   DIM       1
HEBWGHT   DIM       4
HEGESTAT  DIM       2
HEBSTAT   DIM       1
HEMUMAGE  DIM       2
HELDAYS   DIM       3
HESUPPI   DIM       92           * 2 extra chars for quotes
HESUPPRS  DIM       1
HEPLVEND  DIM       8
HEPLVEC   DIM       1
HEPHSPUR  DIM       2
HEHLAGNC  DIM       4
HEADMWGT  DIM       4
HEACCFLG  DIM       1
HEACCCLM  DIM       12
HEHRSMEC  DIM       5            * hrs on mech. ventilator
HEHRCPAP  DIM       5            * hrs on CPAP
HESENDER  DIM       35
HERECVER  DIM       35           * Set to "MINISTRYOFHEALTH"
HEPREPDT  DIM       8
HEPREPTM  DIM       4
HEADMISS  DIM       14
HECONTRL  DIM       14
HETESTI   DIM       1
HEMTHNHI  DIM       7
HEICUHRS  DIM       5
HETRNFRM  DIM       4
HETRNTO   DIM       4
HEFUNDAG  DIM       4
+
.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
.      HD (Event) Record Layout
.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
.
HDRTYPE   DIM       2            * Set to "HD"
HDHCUID   DIM       7
HDEVTCOD  DIM       2
HDEVTSTD  DIM       8
HDEVTSDT  DIM      12
HDAGENCY  DIM       4
HDUNIQUE  DIM       1
HDCOUNT   DIM       2
HDCODSYS  DIM       2            * Clinical coding system id
HDCODTYP  DIM       1 
HDTABTYP  DIM       1
HDDOCODE  DIM       8
HDDODESC  DIM       52           * 2 extra chars for quotes
HDDOLDES  DIM       202
HDOPDATE  DIM       8
HDEXTDAT  DIM       8
HDONSET   DIM       1
.     
.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
.      HC (Psychiatric Status) Record Layout
.>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
.
HCFLAG    FORM      1         * Flag to check if HC to be written
HCRTYPE   DIM       2         * Set to "HC"
HCHCUID   DIM       7         * National Number
HCEVCOD   DIM       2         * Event type Code
HCEVSTD   DIM       8         * Event Start Date
HCEVSDT   DIM      12         * Event Start Date
HCAGENT   DIM       4         * Health Agency Facility
HCUNIQE   DIM       1         * Unique record counter
HCLSTDT   DIM       8         * Event legal status date
HCLSTCD   DIM       2         * Legal Status Code
.
.---------------------------------------------------------------------- 
ZEDS      INIT      "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzz"
.
PRGID     INIT      "IBAINP08"
PRGNAM    INIT      "EDI INTERFACE DATA EXTRACTION"
VERSION   INIT      "V12.01.00"
+
.**********************************************************************
.*                           MAINLINE                                 *
.**********************************************************************
.
ML0000    CALL      INIT0000                  * initialization 
.
ML1000    CALL      SCRN0000                  * display screen
          BRANCH    EXIT,ML9999
.
ML2000    CALL      DTFN0000                  * keyin date/filename
          BRANCH    EXIT,ML1000,ML1000
.
          CALL      CONTQST                   * ok to continue
          BRANCH    CEXIT,ML2500,ML2000,ML1000
.
ML2500    CALL      MAKE0000                  * create the file
. -----   MOVE      ZERO,PTCNHSEM 
          BRANCH    PTCNHSEM,ML4000
.
.         PTCNHSEM = 0 -> Date of Coding
.
ML3000    
          CALL      LOOP0000                  * loop over admission file
          CALL      CHAN0000                  * check for operation changes
          CALL      CHGF0000                  * check for ACC flag changes
          CALL      UNAD0000                  * send unadmitted patients
          CALL      MHAD0000                  * Check Mental Health Admissions
          CALL      ENDE0000                  * finished extraction     
          GOTO      ML1000
.
.         PTCNHSEM = 1 -> Discharge Date/Coding
.
ML4000    CALL      ETPB0000                  * loop over discharge file
          CALL      CHAN0000                  * check for changes
          CALL      CHGF0000                  * check for ACC flag changes
          CALL      UNAD0000                  * send unadmitted patients
          CALL      MHAD0000                  * Check Mental Health Admissions
          CALL      ENDE0000                  * finished extraction     
          GOTO      ML1000
.
ML9999    CHAIN     PGM
+
.**********************************************************************
.*                           INIT0000                                 *
.*                     Initialise variables                           *
.*                     Called : ML0000                                *
.**********************************************************************
.
INIT0000  CALL      DISPHEAD
.
          DISPLAY   *P57:24,"Opening controlf"
          OPEN      CONTROLF,"controlf"
.
          DISPLAY   *P65:24,"patcodes"
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P65:24,"patdadaf"
          OPEN      PATDADA1,"patdadaf"
.
          DISPLAY   *P65:24,"patdo1af"
          OPEN      PATDO1A1,"patdo1af"
.
          DISPLAY   *P65:24,"patwrdaf"
          OPEN      PATWR1A1,"patwr1af"
.
          DISPLAY   *P65:24,"patwc1af"
          OPEN      PATWC1A1,"patwc1af"
.
          DISPLAY   *P65:24,"pmswx1af"
          OPEN      PMSWX1A1,"pmswx1af"
.
          DISPLAY   *P65:24,"pathspaf"
          OPEN      PATHSPA1,"pathspaf"
.
          DISPLAY   *P65:24,"mehvi1af"
          OPEN      MEHVI1A1,"mehvi1af"
          OPEN      MEHVI1A2,"mehvi1af"
.
          DISPLAY   *P65:24,"mehds1af"
          OPEN      MEHDS1A1,"mehds1af"
.
          DISPLAY   *P65:24,"mehdlsaf" 
          OPEN      MEHDLSA1,"mehdlsaf" 
.
          DISPLAY   *P65:24,"mehdiaaf"
          OPEN      MEHDIAA1,"mehdiaaf"
.
          DISPLAY   *P65:24,"mehleraf"
          OPEN      MEHLERA1,"mehleraf"
.
          DISPLAY   *P65:24,"patcrgaf"
          OPEN      PATCRGA1,"patcrgaf"
.
          DISPLAY   *P65:24,"patcrdaf"
          OPEN      PATCRDA1,"patcrdaf"
.
          DISPLAY   *P65:24,"patdschf"
          OPEN      PATDSCH1,"patdschf"
          OPEN      PATDSCH2,"patdschf"
.
          DISPLAY   *P65:24,"patecdaf"
          OPEN      PATECDA2,"patecdaf"
.
          DISPLAY   *P65:24,"patecoaf"
          OPEN      PATECOA2,"patecoaf"
.
          DISPLAY   *P65:24,"paticuaf"
          OPEN      PATICUA1,"paticuaf"
.
          DISPLAY   *P65:24,"paticddf"
          OPEN      PATICDD1,"paticddf"
.
          DISPLAY   *P65:24,"pati10df"
          OPEN      PATI10D1,"pati10df"
.
          DISPLAY   *P65:24,"paticdof"
          OPEN      PATICDO1,"paticdof"
.
          DISPLAY   *P65:24,"pati10of"
          OPEN      PATI10O1,"pati10of"
.
          CALL      OPICO1
          CALL      OPICO2
          CALL      OPICD1
          CALL      OPICD2
.
          DISPLAY   *P65:24,"patma1af"
          OPEN      PATMA1A1,"patma1af"
          DISPLAY   *P65:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P65:24,"patmi1af"
          OPEN      PATMI1A1,"patmi1af"
          OPEN      PATMI1A4,"patmi1af"
.
          DISPLAY   *P65:24,"pmsvx1af"
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P65:24,"patodcaf"
          OPEN      PATODCA1,"patodcaf"
          OPEN      PATODCA2,"patodcaf"
.
          DISPLAY   *P65:24,"pattranf"
          OPEN      PATTRAN2,"pattranf"
.
          DISPLAY   *P65:24,"patunanf"
          OPEN      PATUNAA2,"patunaaf"
          OPEN      PATUNAA1,"patunaaf"
.
          DISPLAY   *P65:24,"patvisaf"
          OPEN      PATVISA1,"patvisaf"
          OPEN      PATVISA2,"patvisaf"
.
          DISPLAY   *P65:24,"patdadaf"
          OPEN      PATDADA1,"patdadaf"
.
          DISPLAY   *P65:24,"patvadaf"
          OPEN      PATVADA1,"patvadaf"
.
          OPEN      WATTR1A1,"wattr1af"
.
INIT2000  PACK      TODAY,CCC,CYY,CMM,CDD     * todays date
          REP       " 0",TODAY
.
          MOVE      ZERO,TOTALREC             * total records sent
.
          READ      CONTROLF,ZERO;*43,IBCNMHOS
          READ      CONTROLF,TWENTY1;*216,PTCNDTRF 
          READ      CONTROLF,TEN;*37,CMOPRT,*54,CFILENO
          READ      CONTROLF,TEN;*235,CMDISP,CMDISS,CMDISC,CMDISA,*244,CHOSPNUM
          READ      CONTROLF,TWENTY;*91,PTCNHSEM
          READ      CONTROLF,TWENTY1;*46,PTCNBAGE,*138,PTCNNHII:
                                     *223,PTCNEIAS,PTCNEIOC,PTCNEIMO
          READ      CONTROLF,FIFTY9;*234,PTCNNMPI
          READ      CONTROLF,SIXTY9;*69,MHCNUSE
          READ      CONTROLF,SEVENTY7;*45,PTCNNZED,*195,PTCNDLKR
          READ      CONTROLF,SEVENTY9;*33,PTCNSEND,*81,PTCNGEST,*120,PTCNUEOC:
                                      *121,PTCNUACC
          READ      CONTROLF,EIGHTY;*138,PTCNNZUR
          READ      CONTROLF,EIGHTY8;*43,PTCNACCF,*59,PTCNI10D
          READ      CONTROLF,NINTY8;*71,PTCNAFLG,*76,PTCNCLNO,*149,PTCNGDV2
          READ      CONTROLF,HUND05;*225,PTCNACCD
          READ      CONTROLF,HUND09;*151,PTCNGDV3
          READ      CONTROLF,HUND17;*220,PTCNGDX1
          READ      CONTROLF,EIGHTY;*250,PTCNHDPS
          READ      CONTROLF,HUND20;*161,PTCNMDSB
          READ      CONTROLF,HUND28;*231,PTCNGDX2                     *I-0917793
          READ      CONTROLF,HUND30;*86,PTCNGDX3                      *I-0956210
.
.         Open EOC/ACC files
.
          IF        PTCNUEOC = 1 & PTCNUACC = 1
            DISPLAY   *P65:24,"eoclnkaf";
            OPEN      EOCLNKA2,"eoclnkaf"
.
            DISPLAY   *P65:24,"eocrefaf";
            OPEN      EOCREFA1,"eocrefaf"
.
            DISPLAY   *P65:24,"eocafcaf";
            OPEN      EOCAFCA1,"eocafcaf"
            OPEN      EOCAFCA2,"eocafcaf"
.
            DISPLAY   *P65:24,"outrf1af";
            OPEN      OUTRF1A1,"outrf1af"
          ENDIF
.
          IF        PTCNNHII = 1
            DISPLAY   *P65:24,"nhimasaf"
            OPEN      NHIMASA1,"nhimasaf"
            OPEN      NHIMASA2,"nhimasaf"
          ELSE
            DISPLAY   *P65:24,"patnidaf"
            OPEN      PATNIDA1,"patnidaf"
          ENDIF
.
          DISPLAY   *P65:24,"pmsnmhaf"
          OPEN      PMSNMHA1,"pmsnmhaf"
.
          DISPLAY   *P65:24,"pmsnmdaf"
          OPEN      PMSNMDA1,"pmsnmdaf"
.
          CALL      TFILENAM
          MOVE      TFILNAME,FNAME
.
INIT9999  RETURN
.
.************************************************************************
.*                             MAKE0000                                 *
.*                      Make the file for Extract                       *
.************************************************************************
MAKE0000  PACK      FILENAME,DHBPREFX,BATCHNO,FILEEXTN     * from keyins
.         PACK      FILENAME,SITEPREF,BATCHNO,FILEEXTN     * from keyins
          RESET     FILENAME
          STRIP     PTCNNZED
          CLEAR     PATHNAME
          MOVE      PTCNNZED,PATHNAME
          ENDSET    PATHNAME
          APPEND    FILENAME,PATHNAME
          RESET     PATHNAME
.
          PREP      XXTRACT1,PATHNAME
          PREP      XXTRTMP1,FNAME
          MOVE      ZERO,TOTALREC             * total records sent
.
MAKE9999  RETURN
+
.********************************************************************** 
.*                             SCRN0000                               *
.*                        Main Option Screen                          *
.*                        Called : ML0000                             *
.**********************************************************************
+
SCRN0000  DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,ZERO,*HOFF," = Exit":
                    *P1:5,*V2LON,ONE,*HOFF:
                          " = Run Data Extraction "
.
SCRN1000  KEYIN     *P1:7,"Select Option : ",*EF,*DV,UNDLN1:
                    *P17:7,*V2LON,OPTION;
.
          BRANCH    OPTION,SCRN8000
.
          COMPARE   ZERO,OPTION
          GOTO      SCRN9000 IF EQUAL
.
          BEEP
          GOTO      SCRN1000
.
SCRN8000  MOVE      FALSE,EXIT
          GOTO      SCRN9999
.
SCRN9000  MOVE      TRUE,EXIT
.
SCRN9999  RETURN
+
.********************************************************************** 
.*                             DTFN0000                               *
.*              Keyin Date & Filename for Data Extraction             *
.*                        Called : ML0000                             *
.**********************************************************************
.
DTFN0000  DISPLAY   *P1:10,*EF,"Extract data for the period from : ";
.
          UNPACK    SP30,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      TEN,CVERT
          MOVE      "36",CCOL
          MOVE      ZERO,CHIGHLT
          MOVE      ZERO,CDEFDTE
          CALL      KEYDATE                      * keyin from date
          BRANCH    CQUEST,DTFN0000              * "?" entered
          BRANCH    OVRCD,DTFN9100
.
          PACK      STRTDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STRTDATE
.
.         Check if from date is > todays date
.
          MATCH     STRTDATE,TODAY                    
          GOTO      DTFN1000 IF NOT LESS
. 
          DISPLAY   *P1:24,*B,"From Date is Greater than Todays Date - ";
          CALL      HITENTER
          GOTO      DTFN0000
.
DTFN1000  DISPLAY   *P1:12,*EL,SP30,"to : ";
.
          UNPACK    SP30,CCENT,CYEAR,CMON,CDAY
          MOVE      TEN2,CVERT
          MOVE      "36",CCOL
          MOVE      ZERO,CHIGHLT
          MOVE      ZERO,CDEFDTE
          CALL      KEYDATE                   * keyin to date
          BRANCH    CQUEST,DTFN1000           * "?" entered
          BRANCH    OVRCD,DTFN9100
.
          PACK      ENDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDATE
.
.         Check if to date is > todays date
.
          MATCH     ENDDATE,TODAY                    
          GOTO      DTFN2000 IF NOT LESS
.
          DISPLAY   *P1:24,*B,"To Date is Greater than Todays Date - ";
          CALL      HITENTER
          GOTO      DTFN1000
.
.         Check if the to date is < from date
.
DTFN2000  MATCH     STRTDATE,ENDDATE
          GOTO      DTFN3000 IF NOT LESS
.
          DISPLAY   *P1:24,*EL,"To Date Must be Less than From Date - ";
          CALL      HITENTER
          GOTO      DTFN1000
.
DTFN3000  MOVE      SP3,SITEPREF                 * site prefix for filename
.         KEYIN     *P1:14,*EF,"Enter three character site prefix : ":
.                   *V2LON,SITEPREF
.         TYPE      SITEPREF
.         GOTO      DTFN3000 IF EQUAL
.
.         RESET     SITEPREF
.         PACK      SITEPREF,SITEPREF,SP3
.         SCAN      SP1,SITEPREF                 * must be 3 chars long
.         IF        @EQUAL
.           DISPLAY   *P1:24,"Must be 3 characters long.     ";
.           CALL      HITENTER
.           GOTO      DTFN3000
.         ENDIF
.
.         MOVE      ZERO,FORM5
.         KEYIN     *P1:16,*EF,"Enter five digit batch number : ":
.                   *V2LON,FORM5
.         MOVE      FORM5,BATCHNO                * batch number for filename
.         REP       " 0",BATCHNO
.
          MOVE      SP4,DHBPREFX
          MOVE      ZERO,EXIT
          DISPLAY   *P1:14,*EF,"Enter District Health Board : ",SP30
          MOVE      "31",ECOL
          MOVE      "14",EVERT
          MOVE      ZERO,CKYIMAND
          MOVE      SP70,CKYIDEF3
          PACK      CODE,CATdh
          DISPLAY   *PECOL:EVERT,SP6
.
          CALL      PATCODKY
          BRANCH    EXIT,DTFN9100,DTFN9200
.
          PACK      DHBPREFX,THCSCOD,SP70
          DISPLAY   *PECOL:EVERT,*V2LON,DHBPREFX,*HOFF,*P36:EVERT,TDESC
.
.         KEYIN     *P1:14,*EF,"Enter District Health Board : ":
.                   *V2LON,DHBPREFX
.
.         RESET     DHBPREFX
.         PACK      DHBPREFX,DHBPREFX,SP4
.         SCAN      SP1,DHBPREFX                 * must be 4 chars long
.         IF        @EQUAL
.           DISPLAY   *P1:24,"Must be 4 characters long.     ";
.           CALL      HITENTER
.           GOTO      DTFN3000
.         ENDIF
.
.         MOVE      PTCNMDSB,BATCHNO             * batch number for filename
          MOVE      SP70,BATCHNO
          MOVE      ACODE,DHBCODE
          PACK      KEY5,CATdh,DHBCODE,SP70
          CALL      RDCODE1
          IF        OVRCD=0
            MATCH     SP70,PTCDASC1
            IF        !@EQUAL
              SQUEEZE   PTCDASC1
              MOVE      PTCDASC1,BATCHNO  * Batch number from Associate Field 1
              RJUSTIFY  BATCHNO
            ENDIF
          ENDIF
.
          REP       " 0",BATCHNO
          MATCH     "00000",BATCHNO
          IF        @EQUAL
            MOVE      ONE,BATCHNO
            RJUSTIFY  BATCHNO
            REP       " 0",BATCHNO
          ENDIF
.
          DISPLAY   *P1:16,*EF,"Next five digit batch number : ":
                    *V2LON,BATCHNO,*HOFF
.
DTFN3500  MOVE      SP70,INCRBATN
          DISPLAY   *P1:18,*EF,"Increment Batch Number 1=YES : ";
          KEYIN     *V2LON,*RV,INCRBATN;
.
DTFN4000  MOVE      ANSP,KEY1
          DISPLAY   *P1:20,*EF,"Enter processing environment - (":
                    *V2LON,ANSP,*HOFF,")rod or (",*V2LON,ANST,*HOFF,")est : ";
          KEYIN     *V2LON,*RV,KEY1;
          REP       UPPLOW,KEY1
          DISPLAY   *P51:20,KEY1
          MATCH     ANSP,KEY1
          IF        @EQUAL
            MOVE      "PROD",PROCENV             * proc. environment is PROD
            GOTO      DTFN8000
          ENDIF
          MATCH     ANST,KEY1
          IF        @EQUAL
            MOVE      "TEST",PROCENV             * proc. environment is TEST
            GOTO      DTFN8000
          ENDIF
          GOTO      DTFN4000
.
DTFN8000  MOVE      FALSE,EXIT
          MOVE      ZERO,DOYR2013
          MATCH     "PROD",PROCENV
          IF        @EQUAL
            MATCH     "20130701",STRTDATE
            IF        !@LESS
              MOVE      ONE,DOYR2013
            ENDIF
          ENDIF
          MATCH     "TEST",PROCENV
          IF        @EQUAL
            MATCH     "20130301",STRTDATE
            IF        !@LESS
              MOVE      ONE,DOYR2013
            ENDIF
          ENDIF
.
DTFN9000  MOVE      ZERO,EXIT
          GOTO      DTFN9999
.
DTFN9100  MOVE      ONE,EXIT
          GOTO      DTFN9999
.
DTFN9200  MOVE      TWO,EXIT
          GOTO      DTFN9999
.
DTFN9999  RETURN
+
.********************************************************************** 
.*                            LOOP0000                                *
.*                     Loop Over Admission File                       *
.*                     Called : ML0000                                *
.********************************************************************** 
.
LOOP0000  DISPLAY   *P1:24,*EL,"Extracting Data for UR ":
                    SP10,"On ";
.
.         Loop through the admission file on the 4th index, which has the
.         date coding was completed and the admission number as its key
.
          PACK      KEY16,STRTDATE,SP10
          CALL      RDSMISS4
LOOP1000  CALL      RDKMISS4
          BRANCH    OVRCD,LOOP9999
          MOVE      FALSE,HCFLAG
          MOVE      ZERO,CANCERPT 
.
          MATCH     ACODDTE,ENDDATE           * coding date in date range
          GOTO      LOOP9999 IF LESS
.
.         Coding should always be completed after the patient is 
.         discharged, so check the astat value is equal to 3 
.
          COMPARE   THREE,ASTAT               * patient discharged ?
          GOTO      LOOP1000 IF NOT EQUAL
.                                         * Ignore Residential Care NZ only
          IF        PTCNHDPS<>1
            GOTO      LOOP1025
          ENDIF
.
          MATCH     SP20,ACLSS
          GOTO      LOOP1025 IF EQUAL
.
          PACK      KEY5,ANSP,SP1,ACLSS,SP20
          CALL      RDCODE1
          BRANCH    OVRCD,LOOP1025
.
          MATCH     ANSR,TCINDC7
          GOTO      LOOP1000 IF EQUAL
.
.         If patient data has already been set then don't send again
.
LOOP1025  BRANCH    AELIG,LOOP1000
.
          PACK      KEY8,AADMNO
          CALL      RDMHVIS1                  * Mental Health Patients
.
          IF        OVRCD=0
            MOVE      TRUE,HCFLAG
          ENDIF
.
          PACK      KEY8,AADMNO
          CALL      RDPTCRG1
          BRANCH    OVRCD,LOOP1050
          MOVE      ONE,CANCERPT              * cancer patient
.
LOOP1050  PACK      KEY8,AURNO                * read the master file
          CALL      RDMAST1                   * if no record found ignore
          BRANCH    OVRCD,LOOP1000
.
          CALL      NATN0000                  * Get the national number
          BRANCH    EXIT,LOOP1000
.
          PACK      KEY8,AADMNO
          CALL      RDDSCH1                   * read the discharge file
          BRANCH    OVRCD,LOOP1000            * if no record found ignore
.
          COMPARE   TRUE,HCFLAG
          GOTO      LOOP1100 IF NOT EQUAL
.
          CALL      RDMHDSC1                  * Read the MH Discharge File
          BRANCH    OVRCD,LOOP1000            * if no record found ignore
.
LOOP1100  PACK      KEY8,AADMNO
          CALL      RDVISA1                   * read the visit file
          BRANCH    OVRCD,LOOP1000            * if no record found ignore
          CALL      RDPMVX11
          BRANCH    OVRCD,LOOP1000            * if no record found ignore
.
          CALL      CHKDHB00
          BRANCH    EXIT,LOOP1000             * if hospital DHB doesn't match
.
          CALL      EXHE0000                  * extract data for HE record
          BRANCH    EXIT,LOOP2000             * Patient is dead so don't
.                                               extract medical data
          CALL      EXHD0000                  * extract data for HD record
          PERFORM   HCFLAG,EXHC0000           * extract data for HC record
.
.         update the status on the admission file to say data has 
.         been sent.
.
LOOP2000  PACK      KEY8,AADMNO
          CALL      RDMISS1
          MOVE      ONE,AELIG
          MATCH     "PROD",PROCENV
          IF        @EQUAL
            CALL      UPMISS1
          ENDIF
.
.         Flag operation changes data so we don't send it twice
.
          PACK      KEY8,AADMNO
          CALL      RDODCA1
          BRANCH    OVRCD,LOOP2200
.
          MOVE      ONE,PTODSENT
          CALL      UPODCA1
.
.         Flag ACC Flag changes data so we don't send it twice
.
LOOP2200  IF        PTCNUEOC = 1 & PTCNUACC = 1
            PACK      KEY8,AADMNO
            CALL      RDECAFC1
            BRANCH    OVRCD,LOOP2500
.
            MOVE      ONE,ECAFSENT
            CALL      UPECAFC1
          ENDIF
.
LOOP2500  DISPLAY   *P25:24,*V2LON,AURNO;
.
          UNPACK    ACODDTE,CCENT,CYEAR,CMON,CDAY    * date coding completed
          MOVE      "38",CCOL
          MOVE      "24",CVERT
          MOVE      ZERO,CHIGHLT
          CALL      DSPDATE                   * display date coding completed
.
          GOTO      LOOP1000
.
LOOP9999  RETURN
+
.********************************************************************** 
.*                  ETPB0000                    Called by : ML4000    *
.*        Loop Over Discharge file and if on that for the date range  *
.*        see if on patecdaf File -> if on both a valid patient       *
.********************************************************************** 
.
ETPB0000  DISPLAY   *P1:24,*EL,"Extracting Data for UR ":
                    SP10,"On ";
.
.         Loop through the discharge file on the 2nd index, which has the
.         date of discharge and the admission number as its key
.
          MOVE      STRTDATE,FROMDATE
          MOVE      ENDDATE,TODATE
.
          PACK      KEY16,FROMDATE,SP20
          CALL      RDSDSCH2
.
. ------- loop over discharge file -------
.
ETPB1000  CALL      RDKDSCH2
          BRANCH    OVRCD,ETPB9999          * end of file
.
          MOVE      FALSE,HCFLAG
          MOVE      ZERO,CANCERPT
.
          MATCH     DDATE,TODATE 
          GOTO      ETPB9999 IF LESS        * finished the range 
.
. ------- on the discharge file, now check patecdaf for a record
.
          PACK      KEY16,DADMNO,SP20       * position at visit num   *C-240107
          CALL      RSPTECD2                * positional read
ETPB2000  CALL      RKPTECD2                * get next record
          BRANCH    OVRCD,ETPB1000          * no data for the patient
.
          MATCH     DADMNO,PTEDADMN
          GOTO      ETPB1000 IF NOT EQUAL   * different patient
.
          MATCH     SP70,PTEDCODE
          GOTO      ETPB2000 IF EQUAL       * ignore blank episode records
.
          PACK      KEY8,DADMNO,SP8         * visit number is key
          CALL      RDMISS1                 * read admission file
          BRANCH    OVRCD,ETPB1000
.
          BRANCH    AELIG,ETPB1000
.                                         * Ignore Residential Care NZ only
          IF        PTCNHDPS<>1
            GOTO      ETPD2050
          ENDIF
.
          IF        AELIG = 4 | AELIG = 5
            GOTO      ETPB1000
          ENDIF
. 
          MATCH     SP20,ACLSS
          GOTO      ETPD2050 IF EQUAL
.
          PACK      KEY5,ANSP,SP1,ACLSS,SP20
          CALL      RDCODE1
          BRANCH    OVRCD,ETPD2050
.
          MATCH     ANSR,TCINDC7
          GOTO      ETPB1000 IF EQUAL
.
ETPD2050  PACK      KEY8,AADMNO
          CALL      RDMHVIS1                  * Mental Health Patients
          BRANCH    OVRCD,ETPB2100
.
          PACK      KEY8,AADMNO
          MOVE      TRUE,HCFLAG
          CALL      RDMHDSC1
          BRANCH    OVRCD,ETPB1000
         
ETPB2100  PACK      KEY8,AADMNO
          CALL      RDPTCRG1
          BRANCH    OVRCD,ETPB2300
          MOVE      ONE,CANCERPT            * cancer patient

ETPB2300  PACK      KEY8,DURNO,SP8          * read the master file
          CALL      RDMAST1                 * if no record found ignore
.
          BRANCH    OVRCD,ETPB1000
.
          CALL      NATN0000                  * Get the national number
          BRANCH    EXIT,ETPB1000
.
          PACK      KEY8,DADMNO,SP8
          CALL      RDVISA1                 * read the visit file
          BRANCH    OVRCD,ETPB1000          * if no record found ignore
          CALL      RDPMVX11
          BRANCH    OVRCD,ETPB1000            * if no record found ignore
.
          CALL      CHKDHB00
          BRANCH    EXIT,ETPB1000             * if hospital DHB doesn't match
.
          CALL      EXHE0000                  * extract data for HE record
          BRANCH    EXIT,ETPB3000             * Patient is dead so don't
.                                               extract medical data
          CALL      EXHD0000                  * extract data for HD record
          PERFORM   HCFLAG,EXHC0000       * extract data for HC record
.
.         update the status on the admission file to say data has 
.         been sent.
.
ETPB3000  PACK      KEY8,DADMNO,SP8         * visit number is key
          CALL      RDMISS1 
          BRANCH    OVRCD,ETPB1000
          MOVE      ONE,AELIG
          MATCH     "PROD",PROCENV
          IF        @EQUAL
            CALL      UPMISS1
          ENDIF
.
.         Flag operation changes data so we don't send it twice
.
          PACK      KEY8,DADMNO
          CALL      RDODCA1
          BRANCH    OVRCD,ETPB3200
.
          MOVE      ONE,PTODSENT
          CALL      UPODCA1
.
.         Flag ACC Flag changes data so we don't send it twice
.
ETPB3200  IF        PTCNUEOC = 1 & PTCNUACC = 1
            PACK      KEY8,DADMNO
            CALL      RDECAFC1
            BRANCH    OVRCD,ETPB3500
.
            MOVE      ONE,ECAFSENT
            CALL      UPECAFC1
          ENDIF
.
ETPB3500  DISPLAY   *P25:24,*V2LON,AURNO;
.
          UNPACK    PTEDDTCD,CCENT,CYEAR,CMON,CDAY    * date coding completed
          MOVE      "38",CCOL
          MOVE      "24",CVERT
          MOVE      ZERO,CHIGHLT
          CALL      DSPDATE                 * display date coding completed
          GOTO      ETPB1000
.
ETPB9999  RETURN
+
.********************************************************************** 
.*                            UNAD0000                                *
.*            Send patients that are unadmitted in the date range     *
.********************************************************************** 
.
UNAD0000  DISPLAY   *P1:24,*EL,"Extracting Unadmitted Data for UR "
.
          MOVE      SP3,DSTAT
          MOVE      ONE,UNADFLAG
          PACK      KEY25,ONE,STRTDATE,SP30
          CALL      RDSUNAA2
UNAD1000  CALL      RDKUNAA2
          BRANCH    OVRCD,UNAD9999
.
          MATCH     PTUNDATE,ENDDATE        * Within the date range ?
          GOTO      UNAD9999 IF LESS
.
          MATCH     "1",PTUNTYPE            * Unadmit record ?
          GOTO      UNAD9999 IF NOT EQUAL
.
          BRANCH    PTUNSENT,UNAD1000       * Already sent
.
          PACK      KEY8,PTUNADMN
          CALL      RDMISS1
          BRANCH    OVRCD,UNAD1000
.
          BRANCH    AELIG,UNAD2000,UNAD2000,UNAD2000 * Already sent ?,
          GOTO      UNAD1000
.
.-------  SRF 613301 - get unadischarge record for discharge date ------
.
UNAD2000  PACK      SAVKEY25,ONE,PTUNDATE,PTUNTIME,PTUNADMN
      
          MOVE      SP8,DDATE
          MOVE      SP8,DTIME
          MOVE      SP3,HOSPITAL
.
          PACK      KEY25,PTUNADMN,SP30
          CALL      RDSUNAA1
UNAD3000  CALL      RDKUNAA1
          BRANCH    OVRCD,UNAD5000
.
          MATCH     AADMNO,PTUNADMN
          GOTO      UNAD5000 IF NOT EQUAL
.
          MATCH     "2",PTUNTYPE            * Unadmit record ?
          GOTO      UNAD3000 IF NOT EQUAL
.
          MOVE      PTUNODTE,DDATE          * set up discharge date
          MOVE      PTUNTIME,DTIME          * set up discharge time
          MOVE      PTUNHOSP,HOSPITAL
.
UNAD5000  MOVE      ONE,AELIG
 
          MOVE      SAVKEY25,KEY25
          CALL      RDUNAA2                 * re-position on 2nd index
.
          PACK      KEY8,AURNO
          CALL      RDMAST1
          BRANCH    OVRCD,UNAD1000
.
          CALL      NATN0000                * Get the national number
          BRANCH    EXIT,UNAD1000
.
          PACK      KEY8,AADMNO
          CALL      RDVISA1
          BRANCH    OVRCD,UNAD1000
          CALL      RDPMVX11
          BRANCH    OVRCD,UNAD1000          * if no record found ignore
.
          CALL      CHKDHB00
          BRANCH    EXIT,UNAD1000           * if hospital DHB doesn't match
.
          CALL      EXHE0000                * extract data for HE record
.
          MOVE      ONE,AELIG
          MATCH     "PROD",PROCENV
          IF        @EQUAL
            CALL      UPMISS1
          ENDIF
          DISPLAY   *P35:24,*V2LON,AURNO
.
          MOVE      SAVKEY25,KEY25
          CALL      RDUNAA2                * re-position on 2nd index as it can
          BRANCH    OVRCD,UNAD1000         * be changed in EXED0000 - WRET0000
.
          MOVE      ONE,PTUNSENT
          MATCH     "PROD",PROCENV
          IF        @EQUAL
            CALL      UPUNAA2
          ENDIF
.
          GOTO      UNAD1000
.
UNAD9999  MOVE      ZERO,UNADFLAG
          RETURN
.
.********************************************************************** 
.*                            CHAN0000                                *
.*                 Loop Over operation changes file                   *
.*                     Called : ML0000                                *
.********************************************************************** 
.
CHAN0000  DISPLAY   *P1:24,*EL,"Extracting Data for UR ":
                    SP10,"On ";
.
.         Loop through the operation changes file, 
.         date changed and the admission number as its key
.
          MOVE      TWO,UNADFLAG            * set to say a re-submission
          PACK      KEY16,STRTDATE,SP10
          CALL      RDSODCA2
CHAN1000  CALL      RDKODCA2
          BRANCH    OVRCD,CHAN9999
.
          MOVE      ZERO,HCFLAG
          MOVE      ZERO,CANCERPT
          MATCH     PTODDATE,ENDDATE
          GOTO      CHAN9999 IF LESS
.
          MATCH     "1",PTODSENT
          GOTO      CHAN1000 IF EQUAL       * already sent
.
          PACK      KEY8,PTODADMN,SP10
          CALL      RDMISS1
          BRANCH    OVRCD,CHAN1000
.
.         Coding should always be completed after the patient is 
.         discharged, so check the astat value is equal to 3 
.
          COMPARE   THREE,ASTAT               * patient discharged ?
          GOTO      CHAN1000 IF NOT EQUAL
.
          PACK      KEY8,AURNO                * read the master file
          CALL      RDMAST1                   * if no record found ignore
          BRANCH    OVRCD,CHAN1000
.
          CALL      NATN0000                  * Get the national number
          BRANCH    EXIT,CHAN1000
.
          PACK      KEY8,AADMNO
          DISPLAY   *P25:24,*V2LON,AURNO;
.
          CALL      RDDSCH1                   * read the discharge file
          BRANCH    OVRCD,CHAN1000            * if no record found ignore
.
          PACK      KEY8,AADMNO
          CALL      RDVISA1                   * read the visit file
          BRANCH    OVRCD,CHAN1000            * if no record found ignore
          CALL      RDPMVX11
          BRANCH    OVRCD,CHAN1000            * if no record found ignore
.
          CALL      CHKDHB00
          BRANCH    EXIT,CHAN1000             * if hospital DHB doesn't match
.
          PACK      KEY8,AADMNO
          CALL      RDPTCRG1
          BRANCH    OVRCD,CHAN1050
          MOVE      ONE,CANCERPT              * cancer patient
.
CHAN1050  PACK      KEY8,AADMNO
          CALL      RDMHVIS1                  * Mental Health Patients
          BRANCH    OVRCD,CHAN1100
.
          MOVE      TRUE,HCFLAG
.
CHAN1100  CALL      EXHE0000                  * extract data for HE record
          BRANCH    EXIT,CHAN3000
.
          CALL      EXHD0000                  * extract data for HD record
          PERFORM   HCFLAG,EXHC0000
.
CHAN3000  UNPACK    ACODDTE,CCENT,CYEAR,CMON,CDAY    * date coding completed
          MOVE      "38",CCOL
          MOVE      "24",CVERT
          MOVE      ZERO,CHIGHLT
          CALL      DSPDATE                   * display date coding completed
.            
          PACK      KEY8,PTODADMN
          CALL      RDODCA1                     
          BRANCH    OVRCD,CHAN1000
.
          MOVE      ONE,PTODSENT              * Flag as sent
          CALL      UPODCA1 
          GOTO      CHAN1000
.
CHAN9999  MOVE      ZERO,UNADFLAG
          RETURN
+
.********************************************************************** 
.*                            CHGF0000                                *
.*                 Loop Over ACC Flag changes file                    *
.*                     Called : ML0000                                *
.********************************************************************** 
.
CHGF0000  IF        PTCNUEOC <> 1 | PTCNUACC <> 1
            GOTO      CHGF9999
          ENDIF
.
          DISPLAY   *P1:24,*EL,"Extracting Data for UR ":
                    SP10,"On ";
.
.         Loop through the ACC Flag changes file, 
.         date changed and the admission number as its key
.
          MOVE      TWO,UNADFLAG            * set to say a re-submission
          PACK      KEY16,STRTDATE,SP10
          CALL      RSECAFC2
CHGF1000  CALL      RKECAFC2
          BRANCH    OVRCD,CHGF9000
.
          MOVE      ZERO,HCFLAG
          MOVE      ZERO,CANCERPT
          MATCH     ECAFDATE,ENDDATE
          GOTO      CHGF9000 IF LESS
.
          MATCH     "1",ECAFSENT            * already sent ?
          GOTO      CHGF1000 IF EQUAL       * yes - ignore
.
          MOVE      ECAFADMN,KEY8
          CALL      RDMISS1                 * admission record on file ?
          BRANCH    OVRCD,CHGF1000          * no - ignore
.
          MOVE      AURNO,KEY8
          CALL      RDMAST1                 * master record on file ?
          BRANCH    OVRCD,CHGF1000          * no - ignore
.
          CALL      NATN0000                * national number on file ?
          BRANCH    EXIT,CHGF1000           * no - ignore
.
          DISPLAY   *P25:24,*V2LON,AURNO;
.
          MOVE      AADMNO,KEY8
          CALL      RDDSCH1                 * discharge record on file ?
          BRANCH    OVRCD,CHGF1000          * no - ignore
.
          MOVE      AADMNO,KEY8
          CALL      RDVISA1                 * visit record on file ?
          BRANCH    OVRCD,CHGF1000          * no - ignore
          CALL      RDPMVX11
          BRANCH    OVRCD,CHGF1000            * if no record found ignore
.
          CALL      CHKDHB00
          BRANCH    EXIT,CHGF1000             * if hospital DHB doesn't match
.
          MOVE      AADMNO,KEY8
          CALL      RDPTCRG1                * cancer patient ?
          BRANCH    OVRCD,CHGF1050          * no
          MOVE      ONE,CANCERPT            * yes - set flag
.
CHGF1050  MOVE      AADMNO,KEY8
          CALL      RDMHVIS1                * Mental Health patient ?
          BRANCH    OVRCD,CHGF1100          * no
.
          MOVE      TRUE,HCFLAG             * yes - set flag
.
CHGF1100  CALL      EXHE0000                * extract data for HE record
          BRANCH    EXIT,CHGF3000
.
          CALL      EXHD0000                * extract data for HD record
          PERFORM   HCFLAG,EXHC0000
.
CHGF3000  MOVE      ECAFADMN,KEY8
          CALL      RDECAFC1                     
          BRANCH    OVRCD,CHGF1000
.
          MOVE      ONE,ECAFSENT            * set flag as sent
          CALL      UPECAFC1 
          GOTO      CHGF1000
.
CHGF9000  MOVE      ZERO,UNADFLAG
.
CHGF9999  RETURN
+
.**********************************************************************
.*                           CDOD0000                                 *
.*                   Check for disease or oper code                   *
.**********************************************************************
.
CDOD0000  MOVE      ONE,EXIT
          PACK      KEY16,PVIBILL,SP20 
          CALL      RSPTECD2
          CALL      RKPTECD2
          BRANCH    OVRCD,CDOD5000
.
          MATCH     PVIBILL,PTEDADMN
          GOTO      CDOD5000 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
          GOTO      CDOD9999
.
CDOD5000  PACK      KEY16,PVIBILL,SP20 
          CALL      RSPTECO2
          CALL      RKPTECO2
          BRANCH    OVRCD,CDOD9999
.
          MATCH     PVIBILL,PTEOADMN
          GOTO      CDOD9999 IF NOT EQUAL
.
          MOVE      ZERO,EXIT
.     
CDOD9999  RETURN
.
+
.**************************************************************************
.*                          CLHE0000                                      *
.*                     Clear the HE record details                        *
.**************************************************************************
CLHE0000  UNPACK    SP30,HERTYPE,HEHCUID,HEEVTCOD,HEEVTSTD,HEAGENCY  
          UNPACK    SP70,HEEVTSDT
          UNPACK    SP30,HEUNIQUE,HEMFUNCT,HEDOMIC,HESEX,HEDOB     
          UNPACK    SP30,HEETHNIC,HERESI,HEASRCE,HEDEPT,HECARE    
          UNPACK    SP30,HEETHNI2,HEETHNI3
          UNPACK    SP30,HEETYPE,HEEDATE,HECOB,HEOCCUP,HEBDLOC   
          UNPACK    SP70,HEEDATTM
          PACK      HEOCCDES,SP30,SP30,SP30
          UNPACK    SP30,HEBWGHT,HEGESTAT,HEBSTAT,HEMUMAGE,HELDAYS
          PACK      HEACCCLM,SP10,SP2
          MOVE      ANSN,HEACCFLG
          PACK      HESUPPI,SP30,SP30,SP30
          UNPACK    SP30,HESUPPRS,HEPLVEND
          UNPACK    SP30,HEPLVEC
          UNPACK    SP30,HEPHSPUR,HEHLAGNC,HEADMWGT
          UNPACK    SP30,HEADMISS,HECONTRL,HETESTI   
          UNPACK    SP70,HEMTHNHI,HEICUHRS,HETRNFRM,HETRNTO
          PACK      HEHRSMEC,SP10
          PACK      HEHRCPAP,SP10
          PACK      OLDCPAP,SP10
          UNPACK    SP70,HEFUNDAG
CLHE9999  RETURN
+
.**************************************************************************
.*                          CLHD0000                                      *
.*                     Clear the HD record details                        *
.**************************************************************************

CLHD0000  UNPACK    SP30,HDCODTYP,HDTABTYP,HDDOCODE  
          UNPACK    SP70,HDDODESC,HDOPDATE 
          PACK      HDDOLDES,SP70,SP70,SP70
          UNPACK    SP30,HDEXTDAT,HDONSET 
CLHD9999  RETURN
+
.**************************************************************************
.*                          CLHR0000                                      *
.*                     Clear the HR record details                        *
.**************************************************************************

CLHR0000  UNPACK    SP30,HRRTYPE,HRHAGNCY,HRFILNAM
          UNPACK    SP30,HRNORECS,HRSNDDTE,HRPROENV
CLHR9999  RETURN
+
.********************************************************************** 
.*                            EXHR0000                                *
.*                     Get Data for HR record                         *
.********************************************************************** 
EXHR0000  MOVE      "HR",HRRTYPE                 * record type
.
          MOVE      ZERO,TCFORM6
          PACK      KEY5,CATdh,DHBCODE,SP70      * DHB of the extract run
          CALL      RDCODE1
          MOVE      TCFORM6,FORM4
          MOVE      FORM4,HRHAGNCY               * health agency
.
          PACK      HRFILNAM,DHBPREFX,BATCHNO,FILEEXTN   * extract filename
.
          ADD       ONE,TOTALREC                 * HR record
          MOVE      TOTALREC,HRNORECS            * no. of records sent
          REP       " 0",HRNORECS
.
          MOVE      TODAY,HRSNDDTE               * send date
.
          MOVE      PROCENV,HRPROENV             * processing environment
.
          CALL      WRHR0000                     * write an HR record
.
          MATCH     "PROD",PROCENV
          GOTO      EXHR9000 IF NOT EQUAL
.
          CALL      CLPMSNMH
          MOVE      HRSNDDTE,PMNHXDAT     * Extract date
          MOVE      DHBPREFX,PMNHDHBC     * DHB code
          MOVE      BATCHNO,PMNHBTCH      * Batch no.
          MOVE      HRHAGNCY,PMNHAGEN     * Health Agency code
          MOVE      PROCENV,PMNHPENV      * Processing Environment
          IF        DOYR2013=1
            MOVE      VERS2013,PMNHFVER
          ELSE
            MOVE      VERS2012,PMNHFVER
          ENDIF
          MOVE      ONE,PMNHSTAT          * Processing Status = 'Sent'
          MOVE      HRNORECS,PMNHRECS     * No. records sent
          MOVE      STRTDATE,PMNHFDAT     * From Date
          MOVE      ENDDATE,PMNHTDAT      * To Date
          MOVE      HRFILNAM,PMNHFNAM     * NMDS File Name (DHBNNNNN.ndm)
.
          PACK      KEY17,PMNHXDAT,PMNHDHBC,PMNHBTCH,PMNHSTAT,SP70
          CALL      RAPMNMH1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPMNMH1
            TRAPCLR   IO
          ENDIF
.
EXHR9000  CALL      UPBTCH00                     * update & store next batch no.
.
EXHR9999  RETURN
+
.**********************************************************************
.*                             UPBTCH00                               *
.*         Update and store the next extract batch number             *
.*                        Called : EXHR0000                           *
.**********************************************************************
UPBTCH00  MATCH     "1",INCRBATN
          GOTO      UPBTCH99 IF NOT EQUAL
.
          MOVE      ZERO,FORM5
          MOVE      BATCHNO,FORM5
          ADD       ONE,FORM5
.         MOVE      FORM5,PTCNMDSB
.         RJUSTIFY  PTCNMDSB
.         REP       " 0",PTCNMDSB
.         WRITAB    CONTROLF,HUND20;*161,PTCNMDSB
.
.         Save new batch number in Associate Field 1 for DHB Code (DHBCODE)
.
          PACK      KEY5,CATdh,DHBCODE,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,UPBTCH99
.
          MOVE      FORM5,DIM5
          REP       " 0",DIM5
          MOVE      DIM5,PTCDASC1
          RJUSTIFY  PTCDASC1
          CALL      UPCODE1
.
UPBTCH99  RETURN
+
.**********************************************************************
.*                           WRHR0000                                 *
.*            Routine to Write HR Data Records to the Temp File       *
.**********************************************************************
WRHR0000  CALL      STHR0000                * remove trailing spaces
.
.-----   Write the record to sequential file, leaving blank fields as null ----
.-----   and all fields without trailing spaces                            ----
.
          MOVE      ONE,COUNT
          REPEAT
            IF        DOYR2013=1
              LOAD      VARIABLE,COUNT,HRRTYPE,HRHAGNCY,HRFILNAM:
                                 HRNORECS,HRSNDDTE,HRPROENV,VERS2013
            ELSE
              LOAD      VARIABLE,COUNT,HRRTYPE,HRHAGNCY,HRFILNAM:
                                 HRNORECS,HRSNDDTE,HRPROENV,VERS2012
            ENDIF
            MOVELPTR  VARIABLE,FORM3A
            IF        FORM3A <> 0
              SFORMAT   VARIABLE,FORM3A
              IF        DOYR2013=1
                LOAD      VARIABLE,COUNT,HRRTYPE,HRHAGNCY,HRFILNAM:
                                   HRNORECS,HRSNDDTE,HRPROENV,VERS2013
              ELSE
                LOAD      VARIABLE,COUNT,HRRTYPE,HRHAGNCY,HRFILNAM:
                                   HRNORECS,HRSNDDTE,HRPROENV,VERS2012
              ENDIF
              IF        COUNT = 7
                WRITE     XXTRACT1,SEQ;VARIABLE
              ELSE
                WRITE     XXTRACT1,SEQ;VARIABLE;
              ENDIF
            ELSE
              IF        COUNT=7
                WRITE     XXTRACT1,SEQ;012;
              ENDIF
            ENDIF
            IF        COUNT < 7
              WRITE     XXTRACT1,SEQ;COMMA;
            ENDIF
            SFORMAT   VARIABLE,127
            ADD       ONE,COUNT
          UNTIL     COUNT = 8
WRHR9999  RETURN
+
.********************************************************************** 
.*                            EXHE0000                                *
.*                   Get Extraction data for EDI HE Record            *
.********************************************************************** 
.
EXHE0000  MOVE      ZERO,EXIT
.
.-------  Set up the HE record details ------
.
          CALL      CLHE0000                * Clear the record details
.
.------   National Number -------
.
          MOVE      "HE",HERTYPE            * Record type
          UNPACK    NHMANMPI,HEHCUID        * Last 7 chars of UR
.
.------   Admission weight ------
.
          PACK      AGEDATE,ADATE
          REP       " 0",AGEDATE
          CALL      CALCAGE
          IF        PSAGEDAY > PTCNBAGE
            GOTO      EXHE0500
          ELSE
            UNPACK    ABWGHT,DIM2,HEADMWGT       * set admission weight if age <
            REP       " 0",HEADMWGT
.                                             a certain number of days
          ENDIF
.
EXHE0500  CALL      NADM0000                * get admission for this date
.       
.------   Maternity  Details if a Birth event --------
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DIM8
.
          MOVE      HEUNIQUE,FORM1          * only want first event on same day
          MOVE      "IP",HEEVTCOD           * Default
.
.------   Check admission type (cat P) for Birth event -----
.
          MOVE      SP10,TCINDC4
          PACK      KEY5,ANSP,SP1,ACLSS
          CALL      RDCODE1                      * Cat "P "
          MATCH     ANSB,TCINDC4
          IF        @EQUAL
            MATCH     ADATE,DIM8
            IF        @EQUAL 
              MOVE      "BT",HEEVTCOD
              MATCH     SP70,TCINDC10
              IF        !@EQUAL
                MOVE      TCINDC10,HEBDLOC
              ELSE
                MOVE      ONE,HEBDLOC
              ENDIF
              MOVE      ANSL,HEBSTAT          * default to live birth as still
.                                               births are notified manually
              PACK      BABYDOB,DIM8          * baby dob work variable
.                                               to calculate mothers age
              REP       " 0",BABYDOB
              UNPACK    ABWGHT,DIM2B,HEBWGHT        * ABWGHT is right justified 
              REP       " 0",HEBWGHT 
.
.   If we are using extra baby details then set the information
.      captured in IBAHOS73
              CALL      GSPE0000            * Load gestation period 
              CALL      GMUR0000            * get mothers UR from patlink
              IF        EXIT = 0
                MOVE      LINKTUR,DIM8
                UNPACK    LINKTUR,DIM1,HEMTHNHI
                CALL      MAGE0000          * calculate the mothers age
              ENDIF
              MOVE      ZERO,EXIT
            ENDIF  
          ENDIF
.
.>>>>  23/1//94  Removed check for patient discharged deceased as now they want
.>>>>  these to be sent. It just read the codes file for category D and DSTAT
.>>>>  and if tcindc1 was D then the patients were not sent. (just in case
.>>>>  they change it again!!!)
.
.------   Set for Mental event (HCFLAG set previously) -----
.
          IF        HCFLAG=TRUE
            MOVE      "IM",HEEVTCOD
          ENDIF
.
.------   Event start date -----
.
          MOVE      PVIDATE,HEEVTSTD             * event start date
          UNPACK    ATIME,DIM2,DIM1,DIM2A
          PACK      HEEVTSDT,ADATE,DIM2,DIM2A    * event start date & time
.
.------   Event suplementary information ------
.
          STRIP     ACOMM1
          PACK      HESUPPI,ACOMM1,SP1,ACOMM2    * Event supp. Info.
.
.------   Health Agency Facility code ------
.
          MOVE      CFILENO,HEAGENCY
          COMPARE   ZERO,IBCNMHOS           * Check for MULTI Hospitals
          GOTO      EXHE1500 IF EQUAL
.
          BRANCH    UNADFLAG,EXHE1000       * Hospital already read for unad/dis
.                                             patients
.
          PACK      KEY30,AADMNO,ZEDS
          CALL      RDSTRAN2                * Position after last pat record 
          CALL      RDPTRAN2                * read pat previous record
          BRANCH    OVRCD,EXHE1500
.
          MATCH     AADMNO,TADMN
          GOTO      EXHE1500 IF NOT EQUAL
          
          PACK      KEY6,TWARD,SP10         * Multiple hospitals.
          CALL      RDWARD1                 * Get hospital number from
          BRANCH    OVRCD,EXHE1500
.                                             ward file.
          PACK      KEY3,PTWDHOSN
.  If we have a patient that is unadmitted then we need to test for the
.     hospital recorded when the were un discharged

EXHE1000  IF        UNADFLAG = 1
            PACK      HOSPITAL,HOSPITAL,SP3
            MATCH     SP3,HOSPITAL
            IF        !@EQUAL
              MOVE      HOSPITAL,KEY3
            ELSE
              GOTO      EXHE1500            * will use cfileno as default
            ENDIF
          ENDIF
          CALL      RDPTHSP1                * Get HDP equiv. for hospital
          BRANCH    OVRCD,EXHE1500
.
          MOVE      PTHSHDPC,HEAGENCY       * and set it to agency.
.
.------   Set message function for this record -----
.
EXHE1500  MOVE      ZERO,RFLAG
          IF        UNADFLAG = 1
            MOVE      "D1",HEMFUNCT
          ELSE
            IF        UNADFLAG = 2
              MOVE      "D1",HEMFUNCT
            ELSE
              IF        AELIG = 2
                MOVE      "A2",HEMFUNCT           * Warning resubmission
              ELSE
                IF        AELIG = 3
                  MOVE      "D1",HEMFUNCT         * Resubmission 
                  MOVE      ONE,RFLAG
                ELSE
                  MOVE      "A1",HEMFUNCT
                ENDIF
              ENDIF
            ENDIF
          ENDIF
.
.------   Domocile code -----
.
          MOVE      PPOST,HEDOMIC
          MATCH     SP70,PMVXPOST
          IF        !@EQUAL
            MOVE      PMVXPOST,HEDOMIC
          ENDIF
.
.------   Sex ------
.
          PACK      HESEX,SP70
          PACK      KEY5,ANSG,SP1,PSEX,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      HESEX,TCINDC2,SP70
          ENDIF
.
.------   Date of birth ------
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      HEDOB,CCENT,CYEAR,CMON,CDAY
          REP       " 0",HEDOB
.
.------   Resident status and ethnicity ------
.
          IF       PTCNNHII = 1
            MOVE      NHMAETH,HEETHNIC        
            MOVE      NHMAETH2,HEETHNI2        
            MOVE      NHMAETH3,HEETHNI3        
            MOVE      NHMARES,HERESI
          ELSE
            MOVE      SP10,THCSCOD
            PACK      KEY5,ANSP,ONE,PUSR1
            CALL      RDCODE1                      * Cat "P1"
            MOVE      THCSCOD,HEETHNIC
.
            MOVE      SP10,THCSCOD
            PACK      KEY5,ANSP,FIVE,PUSR5
            CALL      RDCODE1                      * Cat "P5"
            MOVE      THCSCOD,HEETHNI2
.
            MOVE      SP10,THCSCOD
            PACK      KEY5,ANSP,SIX,PUSR6
            CALL      RDCODE1                      * Cat "P6"
            MOVE      THCSCOD,HEETHNI3
.
            MOVE      SP10,THCSCOD
            PACK      KEY5,ANST,SP1,PVIRESI
            CALL      RDCODE1                      * Cat "T "
            MOVE      THCSCOD,HERESI
          ENDIF
.
.------   Admission source Code ------
.
          IF        PTCNEIAS = 0
            MOVE      ASRCE,DIM3
            PACK      DIM2,ANSS,SP1
          ELSE
            LOAD      DIM3,PTCNEIAS,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5,AUSR6,AUSR7
            LOAD      DIM1,PTCNEIAS,ONE,TWO,THREE,FOUR,FIVE,SIX,SEVEN
            PACK      DIM2,ANSU,DIM1
          ENDIF
          MOVE      SP10,THCSCOD
          
          PACK      KEY5,DIM2,DIM3
          CALL      RDCODE1                      * Cat "S " or "U*"
          MOVE      THCSCOD,HEASRCE

.
.------   Health Service Code ------
.
          MOVE      SP10,THCSCOD
          PACK      KEY5,ANSA,SP1,ATYPE
          CALL      RDCODE1                      * Cat "A "
          MOVE      THCSCOD,HEDEPT
.
.------   Admission type code ------
.
          MOVE      SP10,THCSCOD
          PACK      KEY5,ANSC,ANSC,ACARE
          CALL      RDCODE1                      * Cat "CC"
          MOVE      THCSCOD,HECARE
.
.------   Event end type code -----
.------   We don't have this for unadmitted/undischarged patients ------
.------   (UNADFLAG = 1)                                          ------
.
          MOVE      SP10,HEETYPE
          IF        UNADFLAG <> 1
            MATCH     SP3,DSTAT
            IF        !@EQUAL
              MOVE      SP10,THCSCOD
              PACK      KEY5,ANSD,SP1,DSTAT
              CALL      RDCODE1                      * Cat "D "
              MOVE      THCSCOD,HEETYPE
            ENDIF
          ENDIF
.
.------   If this is a mental health patient then we desire to test if ------
.------   they were discharged to leave (HDP equivalent = "DL").       ------
.------   If they are discharged to leave then we need to set a flag   ------
.------   to tell the LEAV0000 routine to set the event end date to    ------
.------   the date they went on leave and not the discharge date.      ------
.------   The leave end date will remain as the day they returned      ------
.------   from leave therefore this date will be after the event end date !
.
          MOVE      ZERO,DLFLAG             * clear dischage to leave flag
          IF        HCFLAG = 1
            MATCH     "DL",HEETYPE
            IF        @EQUAL
              MOVE      ONE,DLFLAG          * set flag to say returned from
.                                             leave used in LEAV0000
            ENDIF
          ENDIF
.
.------   Event End date ------
.
          PACK      HEEDATE,DDATE
          UNPACK    DTIME,DIM2,DIM1,DIM2A
          PACK      HEEDATTM,DDATE,DIM2,DIM2A
.
.------   Transfer From/To ------
.
          PACK      KEY8,AADMNO
          CALL      RDPTDAD1                 * Read PATDADFD
          BRANCH    OVRCD,EXHE1900
.
          IF        PTCNEIAS = 0
            PACK      KEY5,ANSS,SP1,ASRCE,SP70
            CALL      RDCODE1                      * Cat "S "
            MATCH     "1",TCINDC2
            GOTO      EXHE1800 IF NOT EQUAL
            MATCH     "X",TCINDC11
            GOTO      EXHE1800 IF EQUAL
          ENDIF
.
          PACK      KEY5,PTDAADTS,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            GOTO     EXHE1800
          ENDIF
          MATCH     SP70,PTVANHSC
          IF        !@EQUAL & !@EOS
            MOVE      PTVANHSC,HETRNFRM     * Valid transfer source
          ENDIF
.
EXHE1800 IF        PTCNDTRF=1
            PACK      KEY3,DSTAT
            PACK      KEY5,ANSD,SP1,DSTAT,SP5
            CALL      RDCODE1                      * Cat "D "
          ELSE
            PACK      KEY3,DDEST
            PACK      KEY5,ANSD,ANSD,DDEST
            CALL      RDCODE1                      * Cat "DD"
          ENDIF
          MATCH     "1",TCINDC2
          GOTO      EXHE1900 IF NOT EQUAL
          MATCH     "X",TCINDC11
          GOTO      EXHE1900 IF EQUAL
.
          PACK      KEY5,PTDADCTS,SP70
          CALL      RDPTVAD1
          IF        OVRCD=1
            GOTO     EXHE1900
          ENDIF
          MATCH     SP70,PTVANHSC
          IF        !@EQUAL & !@EOS
            MOVE      PTVANHSC,HETRNTO      * Valid transfer source
          ENDIF
.
.------   Country of Birth (no longer used) -----
.
EXHE1900  PACK      HECOB,SP70
.
.------   Occupation (only required for cancer patients) -----
.
          
          MOVE      SP10,HEOCCUP
          PACK      HEOCCDES,SP30,SP30,SP30
          IF        PTCNEIOC > 0
            LOAD      DIM3,PTCNEIOC,PUSR1,PUSR2,PUSR3,PUSR4,PUSR5,PUSR6
            LOAD      DIM1,PTCNEIOC,ONE,TWO,THREE,FOUR,FIVE,SIX
            MOVE      SP10,THCSCOD
            MOVE      SP10,PTCDASC1
            MOVE      SP20,TDESC
            PACK      KEY5,ANSP,DIM1,DIM3
            CALL      RDCODE1                      * Cat "P1" - "P6"
            MOVE      PTCDASC1,HEOCCUP
            MATCH     SP6,PTCDASC1
            IF        !@EQUAL
              PACK      HEOCCDES,TDESC,SP30,SP30   * occup. desc.
            ELSE
              PACK      HEOCCDES,POCCUP,SP30,SP30  * from master file
            ENDIF
          ELSE
            PACK      HEOCCDES,POCCUP,SP30,SP30  * from master file
          ENDIF
.
.-------  Waiting list details -------
.
          PACK      KEY19,PVIURNO,SP30
          CALL      RDSTREA1
EXHE2000  CALL      RDKTREA1
          BRANCH    OVRCD,EXHE2500
.
          MATCH     PVIURNO,WMURNO
          GOTO      EXHE2500 IF NOT EQUAL
.
          MATCH     PVIBILL,WMBOOK
          GOTO      EXHE2000 IF NOT EQUAL
.
.------   Date on the waiting List -----
.
          REP       " 0",WMDATE1
.
.-------  Calculate Leave days -----
.
EXHE2500  CALL      LEAV0000                * Calculate the number of leave day
          SQUEEZE   HELDAYS
.
.------   Hrs on mech. ventilation ------
.
          MOVE      ZERO,FORM5
          PACK      KEY8,AADMNO
          CALL      RDPTICU1
          IF        OVRCD <> 1
            MOVE      PTICUMEC,FORM5             * 5 chars for extract
            MOVE      FORM5,HEHRSMEC
            REP       " 0",HEHRSMEC
.
.------   Hrs in ICU ------
.
            MOVE      PTICUINT,FORM5             * 5 chars for extract
            MOVE      FORM5,HEICUHRS
            MATCH     "    0",HEICUHRS
            IF        @EQUAL
              PACK      HEICUHRS,SP70
            ELSE
              REP       " 0",HEICUHRS
            ENDIF
.
.------   Hrs on CPAP - Continuous Positive Airways Pressure ------
.
            MOVE      PTICCPAP,FORM5             * 5 chars for extract
            MOVE      FORM5,HEHRCPAP
            MATCH     "    0",HEHRCPAP
            IF        @EQUAL
              PACK      HEHRCPAP,SP70
            ELSE
              REP       " 0",HEHRCPAP
            ENDIF
          ENDIF
.
.------   Sender ID ------
.
.EXHE2700  MOVE      PTCNSEND,HESENDER
.
.------   Receiver ------
.
.          MOVE      "MINISTRYOFHEALTH",HERECVER
.
.------   Current date and Time ------
.
.          CALL      IBACLOCK
.          PACK      HEPREPDT,CCC,CYY,CMM,CDD
.          REP       " 0",HEPREPDT
.          UNPACK    CTIMEIS,DIM2,DIM1,DIM2A
.          PACK      HEPREPTM,DIM2,DIM2A
.
.------   Transaction number -------
.
          PACK      HEADMISS,SP6,AADMNO
          REP       " 0",HEADMISS
.
.------   Test indicator ------
.
.          MOVE      SP1,HETESTI
.          MATCH     "TEST",PROCENV
.          IF        @EQUAL
.            MOVE      ONE,HETESTI           * set to 1 if 'TEST'
.          ENDIF
.
.------   Event Summary Suppress flag -----
.
          MOVE      PTMIESSF,HESUPPRS       * event summary suppress flag
.
.------   Refferal Date -----
.
.....     MOVE      PTMIREFD,HEREFDTE       * Referral Date             D-60913
.
.------   Date of first consultation -----
.
.....     MOVE      PTMIDFCN,HE1STCON       * Date of first consul'tion D-60913
.
.------   Principle Health Service Purchaser -----
.
          MOVE      SP10,THCSCOD
          PACK      KEY5,ANSH,ANSP,PTMIPHPU
          CALL      RDCODE1                      * Cat "HP"
          MOVE      THCSCOD,HEPHSPUR       * Principle Health Service Purchaser
          MOVE      PTCDNHCP,HEFUNDAG      * Funding Agency
.
.------   Health Agency -----
.
          MOVE      SP10,THCSCOD
          PACK      KEY5,ANSH,ANSA,PTMIAGNC
          CALL      RDCODE1                      * Cat "HA"
          MOVE      THCSCOD,HEHLAGNC       * Health Agency
.
.------   Batch Number ------
.
          PACK      HECONTRL,SP9,BATCHNO
          REP       " 0",HECONTRL
.
          IF        (PTCNUACC = 1 & PTCNACCD = 1)
            CALL      GETWC000
            GOTO      EXHE3000
          ENDIF
.
.         Check if we are using EOC & ACC and if so set the ACC Accident
.         Flag and the ACC M46 Number
.
          IF        (PTCNUEOC = 1 & PTCNUACC = 1)
            PACK      KEY10,CHOSPNUM,AADMNO
            CALL      RDECLNK2              * link record on file ?
            BRANCH    OVRCD,EXHE3000        * no - finish
.
.           A link record has been found, so now get the EOC referral record
.
            PACK      KEY13,ECLNURNO,ECLNEPNO
            CALL      RDECREF1              * referral record on file ?
            BRANCH    OVRCD,EXHE3000        * no - finish
.
            UNPACK    ECRFACCN,HEACCCLM,DIM8
.
.           The EOC referral record has been found, so now get the accident flag
.           from the relevant UDF.
.
            MOVE      ECRFREFN,KEY8
            CALL      RDOTRFL1
            IF        OVRCD = 0
              LOAD      DIM3,PTCNACCF,OTRLUSD1,OTRLUSD2,OTRLUSD3,OTRLUSD4
              MATCH     SP3,DIM3
              IF        !@EQUAL
                PACK      KEY5,ANSL,PTCNACCF,DIM3
                CALL      RDCODE1                      * Cat "L*"
                IF        OVRCD = 0
                  MOVE      TCINDC1,HEACCFLG
                ENDIF
              ENDIF
            ENDIF
          ELSE
            IF        PTCNAFLG <> 0
              CALL      GAFL0000              * get accident flag from PTCNAFLG
            ENDIF
            IF        PTCNCLNO <> 0
              CALL      GCLN0000              * get claim number from PTCNCLNO
            ENDIF
          ENDIF
.
EXHE3000  MOVE      ZERO,EXIT
.
          CALL      WRET0000
.
          MATCH     "PROD",PROCENV
          IF        @EQUAL
            CALL      WRPMND00              * write a pmsnmdaf record
          ENDIF
.
.
          IF        UNADFLAG = 2 | RFLAG = 1
.
. ------- Write D1 then A1 ------
. 
            UNPACK    ATIME,DIM2,DIM1,DIM2A
            PACK      HEEVTSDT,ADATE,DIM2,DIM2A        * event start date
. 
            PACK      HEADMISS,SP6,AADMNO
            REP       " 0",HEADMISS
            MOVE      "A1",HEMFUNCT
            CALL      WRET0000
.
            MATCH     "PROD",PROCENV
            IF        @EQUAL
              CALL      WRPMND00            * write a pmsnmdaf record
            ENDIF
.
          ENDIF
.
EXHE9000  MOVE      ZERO,EXIT
.
EXHE9999  RETURN
+
.**********************************************************************
.*                           WRPMND00                                 *
.*                  Writes away a record in pmsnmdaf                  *
.**********************************************************************
WRPMND00  CALL      CLPMSNMD
.
          MOVE      AADMNO,PMNDADMN       * Admission no.
          MOVE      HEHCUID,PMNDPNHI      * Patient NHI number
          RJUSTIFY  PMNDPNHI
          MOVE      BATCHNO,PMNDBTCH      * Batch no.
          MOVE      ONE,PMNDSTAT          * Default Processing Status to 'Sent'
          MOVE      HEEVTCOD,PMNDETYP     * NMDS Event Type (IP, BT, IM etc)
          MOVE      HEEVTSTD,PMNDEDAT     * Event Admission Date
          MOVE      ATIME,PMNDETIM        * Event Admission Time
          MOVE      HEAGENCY,PMNDFACI     * Event Facility Code
          MOVE      TODAY,PMNDXDAT        * Extract Date
          MOVE      HEUNIQUE,PMNDELID     * Event Local Identifier (9,8,7...)
          MOVE      HEDETTXT,PMNDREDT     * Extract record HE details text
          MOVE      HEMFUNCT,PMNDDIAG     * Diag No (D1,A1,A2 for HE record)
          MOVE      "00",PMNDERRC
.
          PACK      KEY19,PMNDADMN,PMNDETYP,PMNDDIAG,PMNDBTCH,PMNDERRC,SP70
          CALL      RAPMNMD1
          IF        OVRCD=1
            MOVE      ZERO,OVRCD
            TRAP      OVERCOND IF IO
            CALL      WRPMNMD1
            TRAPCLR   IO
          ENDIF
.
WRPMND99  RETURN
+ 
.**********************************************************************
.*                           GETWC000                                 *
.*                 Get ACC details from pmswx1af                      *
.**********************************************************************
GETWC000  MOVE      ANSN,HEACCFLG              * set accident flag
          MOVE      SP70,HEACCCLM
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDWCOM1
          BRANCH    OVRCD,GETWC999
.
          PACK      KEY8,AADMNO,SP70
          CALL      RDPMWX11
          BRANCH    OVRCD,GETWC999
.
          MATCH     "3",PMWXCSTA               * Claim Cancelled
          GOTO      GETWC999 IF EQUAL
.
          PACK      HEACCCLM,WCCLMNO,SP70
.
          MATCH     SP70,PMWXACCF
          GOTO      GETWC999 IF EQUAL
.
          PACK      KEY5,ANSI,ANSQ,PMWXACCF,SP70
          CALL      RDCODE1                    * Cat "IQ"
          BRANCH    OVRCD,GETWC999
.
          MOVE      THCSCOD,HEACCFLG
.
GETWC999  RETURN
+
.**********************************************************************
.*                           WRET0000                                 *
.*                 Write an HE record to tempfile                     *
.**********************************************************************
WRET0000  MATCH     "D1",HEMFUNCT
          GOTO      WRET0100 IF NOT EQUAL
.
          PACK      KEY25,AADMNO,Z70
          CALL      RDSUNAA1
WRET0050  CALL      RDPUNAA1
          BRANCH    OVRCD,WRET0100
.
          MATCH     PTUNADMN,AADMNO
          GOTO      WRET0100 IF NOT EQUAL
.
          MATCH     "3",PTUNTYPE
          GOTO      WRET0050 IF NOT EQUAL
.
          BRANCH    PTUNSENT,WRET0100
.
          MOVE      ONE,PTUNSENT
          MATCH     "PROD",PROCENV
          IF        @EQUAL
            CALL      UPUNAA1
          ENDIF
.
          UNPACK    PTUNOTTM,DIM2,DIM1,DIM2A
          PACK      HEEVTSDT,PTUNODTE,DIM2,DIM2A        * event start date
.
WRET0100  WRITE     XXTRTMP1,SEQ;HERTYPE,HEHCUID,HEEVTCOD,HEEVTSDT,HEAGENCY:
                             HEUNIQUE,HEMFUNCT,HEDOMIC,HESEX,HEDOB:
                             HEETHNIC,HEETHNI2,HEETHNI3,HERESI,HEASRCE:
                             HEDEPT,HECARE,HEETYPE,HEEDATTM,HECOB:
                             HEOCCUP,HEOCCDES,HEBDLOC,HEBWGHT,HEGESTAT:
                             HEBSTAT,HEMUMAGE,HELDAYS,HESUPPI,HESUPPRS:
                             HEPLVEND,HEPLVEC,HEPHSPUR,HEHLAGNC,HEADMWGT:
                             HEACCFLG,HEACCCLM,HEHRSMEC,OLDCPAP,HEADMISS:
                             HECONTRL,HEMFUNCT,HEMTHNHI,HEICUHRS,HETRNFRM:
                             HETRNTO,HEHRCPAP,HEFUNDAG
.
          PACK      HEDETTXT,HERTYPE,COMMA,HEHCUID,COMMA,HEEVTCOD,COMMA:
                             HEEVTSDT,COMMA,HEAGENCY,COMMA,HEUNIQUE,COMMA:
                             HEMFUNCT,COMMA,HEDOMIC,COMMA,HESEX,COMMA:
                             HEDOB,COMMA,HEETHNIC,COMMA,HEETHNI2,COMMA:
                             HEETHNI3,COMMA,HERESI,COMMA,HEASRCE,COMMA:
                             HEDEPT,COMMA,HECARE,COMMA,HEETYPE,COMMA:
                             HEEDATTM,COMMA,HECOB,COMMA,HEOCCUP,COMMA:
                             HEOCCDES,COMMA,HEBDLOC,COMMA,HEBWGHT,COMMA:
                             HEGESTAT,COMMA,HEBSTAT,COMMA,HEMUMAGE,COMMA:
                             HELDAYS,COMMA,HESUPPI,COMMA,HESUPPRS,COMMA:
                             HEPLVEND,COMMA,HEPLVEC,COMMA,HEPHSPUR,COMMA:
                             HEHLAGNC,COMMA,HEADMWGT,COMMA,HEACCFLG,COMMA:
                             HEACCCLM,COMMA,HEHRSMEC,COMMA,OLDCPAP,COMMA:
                             HEADMISS,COMMA,HECONTRL,COMMA,HEMFUNCT,COMMA:
                             HEMTHNHI,COMMA,HEICUHRS,COMMA,HETRNFRM,COMMA:
                             HETRNTO,COMMA,HEHRCPAP,COMMA,HEFUNDAG,SP100
.
          ADD       ONE,TOTALREC                 * record counter
WRET9999  RETURN
+
.**********************************************************************
.*                           WRHE0000                                 *
.*                     Write an HE record to the Extract file         *
.**********************************************************************
WRHE0000  MATCH     "0000",HEBWGHT
          IF        @EQUAL
            MOVE      SP4,HEBWGHT
          ENDIF
.
          MOVE      HEOCCDES,DIM70
          MATCH     SP90,DIM70
          IF        !@EQUAL
            STRIP     DIM70
            PACK      HEOCCDES,QUOTE,DIM70,QUOTE   * put quotes around desc.
          ENDIF
          MOVE      HESUPPI,DIM90
          MATCH     SP90,DIM90
          IF        !@EQUAL
            STRIP     DIM90
            PACK      HESUPPI,QUOTE,DIM90,QUOTE    * put quotes around desc.
          ENDIF
.
          CALL      STHE0000                * remove trailing spaces
.
.-----   Write the record to sequential file, leaving blank fields as null ----
.-----   and all fields without trailing spaces, except HETESTI            ----
.
          MOVE      ONE,COUNT
          REPEAT
            LOAD      VARIABLE,COUNT,HERTYPE,HEHCUID,HEEVTCOD,HEEVTSDT,HEAGENCY:
                             HEUNIQUE,HEMFUNCT,HEDOMIC,HESEX,HEDOB:
                             HEETHNIC,HEETHNI2,HEETHNI3,HERESI,HEASRCE:
                             HEDEPT,HECARE:
                             HEETYPE,HEEDATTM,HECOB,HEOCCUP,HEOCCDES,HEBDLOC:
                             HEBWGHT,HEGESTAT,HEBSTAT,HEMUMAGE:
                             HELDAYS,HESUPPI,HESUPPRS:
                             HEPLVEND,HEPLVEC,HEPHSPUR,HEHLAGNC:
                             HEADMWGT,HEACCFLG,HEACCCLM:
                             HEHRSMEC,OLDCPAP,HEADMISS,HECONTRL,DIM2:
                             HEMTHNHI,HEICUHRS,HETRNFRM,HETRNTO,HEHRCPAP:
                             HEFUNDAG
.
            MOVELPTR  VARIABLE,FORM3A
            IF        FORM3A <> 0
              SFORMAT   VARIABLE,FORM3A
                LOAD      VARIABLE,COUNT,HERTYPE,HEHCUID,HEEVTCOD,HEEVTSDT:
                               HEAGENCY:
                               HEUNIQUE,HEMFUNCT,HEDOMIC,HESEX,HEDOB:
                               HEETHNIC,HEETHNI2,HEETHNI3,HERESI,HEASRCE:
                               HEDEPT,HECARE:
                               HEETYPE,HEEDATTM,HECOB,HEOCCUP,HEOCCDES,HEBDLOC:
                               HEBWGHT,HEGESTAT,HEBSTAT,HEMUMAGE:
                               HELDAYS,HESUPPI,HESUPPRS:
                               HEPLVEND,HEPLVEC,HEPHSPUR,HEHLAGNC:
                               HEADMWGT,HEACCFLG,HEACCCLM:
                               HEHRSMEC,OLDCPAP,HEADMISS,HECONTRL,DIM2:
                               HEMTHNHI,HEICUHRS,HETRNFRM,HETRNTO,HEHRCPAP:
                               HEFUNDAG
              IF        COUNT = 48
                WRITE     XXTRACT1,SEQ;VARIABLE
              ELSE
                WRITE     XXTRACT1,SEQ;VARIABLE;
              ENDIF
            ELSE
              IF        COUNT = 48
                WRITE     XXTRACT1,SEQ;012;
              ENDIF
            ENDIF
            IF        COUNT < 48
              WRITE     XXTRACT1,SEQ;COMMA;
            ENDIF
            SFORMAT   VARIABLE,127
            ADD       ONE,COUNT
          UNTIL     COUNT = 49
.
WRHE9999  RETURN
+
.**********************************************************************
.*                           GSPE0000                                 *
.*             Get Gestation period using PTCNGEST                    *
.**********************************************************************
.
GSPE0000  MOVE     ZERO,DIM1
          LOAD     DIM1,PTCNGEST,ONE,TWO,THREE,FOUR,FIVE,SIX,SEVEN,EIGHT,NINE
          PACK     DIM2,ANSU,DIM1
.
.      Get the correct gestation period code
.
          MOVE     PTMIUSR0,DIM3
          LOAD     DIM3,PTCNGEST,AUSR1,AUSR2,AUSR3,AUSR4,AUSR5:
                            AUSR6,AUSR7,PTMIUSR8,PTMIUSR9
.
.      Only send a valid code
.
          MOVE     SP3,ACODE
          PACK     KEY5,DIM2,DIM3
          CALL     RDCODE1                      * Cat "U1" - "U9"
          MOVE     ACODE,HEGESTAT
          REP      " 0",HEGESTAT
          MATCH    "00",HEGESTAT
          IF       @EQUAL
            MOVE     "XX",HEGESTAT
          ENDIF
GSPE9999  RETURN
+
.**********************************************************************
.*                           NADM0000                                 *
.*             Get admission number sequence for this ADATE           *
.**********************************************************************
.
NADM0000  PACK      DIM8,ADATE
          MOVE      SP1,PVIUNQE
.
          PACK      KEY8,AADMNO
          CALL      RDVISA1
          TYPE      PVIUNQE
          IF        @EQUAL
            MOVE      PVIUNQE,HEUNIQUE    * This is a resubmission
            GOTO      NADM9999
          ENDIF
.
          MOVE      NINE,FORM1
          PACK      KEY24,AURNO,ADATE,SP10
          CALL      RDSVISA2
NADM1000  CALL      RDKVISA2
          BRANCH    OVRCD,NADM9000
.
          MATCH     AURNO,PVIURNO
          GOTO      NADM9000 IF NOT EQUAL
.
          MATCH     PVIDATE,DIM8
          GOTO      NADM9000 IF NOT EQUAL

          MATCH     SP1,PVIUNQE
          GOTO      NADM1000 IF EQUAL
.
          SUB       ONE,FORM1
          GOTO      NADM1000
.
.----- Read in the original visit record -----
.
NADM9000  PACK      KEY8,AADMNO
          CALL      RDVISA1
          MOVE      FORM1,HEUNIQUE
.
          MOVE      FORM1,PVIUNQE
          CALL      UPVISA1             * Update Visit file with Unique Number
.
NADM9999  RETURN
+
.**********************************************************************
.*                           GAFL0000                                 *
.*     Get accident flag from PATMI1 according to PAT98 item no.      *
.**********************************************************************
GAFL0000  MOVE      SP1,KEY1
          IF        PTCNAFLG = 34
            MOVE      AUSR1,KEY1
          ENDIF
          IF        PTCNAFLG = 36
            MOVE      AUSR2,KEY1
          ENDIF
          IF        PTCNAFLG = 38
            MOVE      AUSR3,KEY1
          ENDIF
          IF        PTCNAFLG = 40
            MOVE      AUSR4,KEY1
          ENDIF
          IF        PTCNAFLG = 42
            MOVE      AUSR5,KEY1
          ENDIF
          IF        PTCNAFLG = 44
            MOVE      AUSR6,KEY1
          ENDIF
          IF        PTCNAFLG = 46
            MOVE      AUSR7,KEY1
          ENDIF
          IF        PTCNAFLG = 99
            MOVE      PTMIUSR8,KEY1
          ENDIF
          IF        PTCNAFLG = 101
           MOVE      PTMIUSR9,KEY1 
          ENDIF
          IF        PTCNAFLG = 103
            MOVE      PTMIUSR0,KEY1
          ENDIF
          IF        PTCNAFLG = 118
            MOVE      PTMIUYN1,KEY1
          ENDIF
          IF        PTCNAFLG = 119
            MOVE      PTMIUYN2,KEY1
          ENDIF
          REP       "0N1Y",KEY1                  * only want Yes/No
          MATCH     ANSY,KEY1
          IF        @EQUAL
            MOVE      KEY1,HEACCFLG              * set accident flag
          ENDIF
GAFL9999  RETURN
+
.**********************************************************************
.*                           GCLN0000                                 *
.*      Get claim number from PATMI1 according to PAT98 item no.      *
.**********************************************************************
GCLN0000  IF        PTCNCLNO = 68
            MOVE      PTMSFHAN,HEACCCLM
          ENDIF
          IF        PTCNCLNO = 69
            MOVE      PTMSECRA,HEACCCLM
          ENDIF
GCLN9999  RETURN
+
.**********************************************************************
.*                           EXHD0000                                 *
.*             extract disease & operation for HD record              *
.**********************************************************************
.
EXHD0000  MOVE      "HD",HDRTYPE
          UNPACK    NHMANMPI,HDHCUID
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DIM8
.
          MOVE      HEEVTCOD,HDEVTCOD
          MOVE      PVIDATE,HDEVTSTD
          UNPACK    ATIME,DIM2,DIM1,DIM2A
          PACK      HDEVTSDT,ADATE,DIM2,DIM2A        * event start date
          MOVE      HEAGENCY,HDAGENCY
          MOVE      HEUNIQUE,HDUNIQUE
.
          MOVE      DDATE,ICDRDDTE          * prepare ICDRDDTE for RDPTICD1
          MOVE      ZERO,CANCCODE
          MOVE      ZERO,FORM2
          PACK      KEY16,PVIBILL,SP20 
          CALL      RSPTECD2
EXHD1000  CALL      RKPTECD2
          BRANCH    OVRCD,EXHD5000
.
          MATCH     PVIBILL,PTEDADMN
          GOTO      EXHD5000 IF NOT EQUAL
.
          MATCH     PTCNI10D,PTEDDTCD
          IF        @LESS
            MOVE      "06",HDCODSYS         * Coded in ICD9
            GOTO      EXHD1200
          ENDIF
          MATCH     SP70,DDATE
          IF        @EQUAL
            MOVE      "13",HDCODSYS
            GOTO        EXHD1200
          ENDIF
.
          MATCH     PTCNGDX2,DDATE          * ICD10 Ed.12 
          IF        !@LESS
            MOVE      "16",HDCODSYS         * ???
            GOTO      EXHD1200
          ENDIF
.
          MATCH     PTCNGDX1,DDATE          * ICD10 Ed.11 
          IF        !@LESS
            MOVE      "15",HDCODSYS         * ???
            GOTO      EXHD1200
          ENDIF
.
          MATCH     PTCNGDVX,DDATE          * ICD10 Ed.10 
          IF        !@LESS
            MOVE      "15",HDCODSYS         * ???
            GOTO      EXHD1200
          ENDIF
.
          MATCH     PTCNGDV9,DDATE          * ICD10 Ed.9 
          IF        !@LESS
            MOVE      "15",HDCODSYS         * ???
            GOTO      EXHD1200
          ENDIF
.
          MATCH     PTCNGDV8,DDATE          * ICD10 Ed.8 
          IF        !@LESS
            MOVE      "14",HDCODSYS         * ???
            GOTO      EXHD1200
          ENDIF
.
          MATCH     DDATE,PTCNGDV7          * ICD10 Ed.7
          IF        @LESS
            MOVE      "14",HDCODSYS         * ???
            GOTO      EXHD1200
          ENDIF
.
          MATCH     DDATE,PTCNGDV6 
          IF        @LESS
            MOVE      "13",HDCODSYS
            GOTO      EXHD1200
          ENDIF
.
          MATCH     DDATE,PTCNGDV3          * is go live date less than start?
          IF        @LESS
            MOVE      "12",HDCODSYS         * CAR 48127 - ICD10 Version 3
          ELSE
            MATCH     DDATE,PTCNGDV2
              IF        @LESS
              MOVE      "11",HDCODSYS
            ELSE
              MOVE      "10",HDCODSYS       * Coded in ICD10
             ENDIF
          ENDIF
.
EXHD1200  CALL      CLHD0000                * clear HD record details
          MOVE      ONE,DIOPFLAG
.
          ADD       ONE,FORM2
.         COMPARE   "100",FORM2
          COMPARE   ZERO,FORM2
          GOTO      EXHD9999 IF EQUAL       * limit of 99 diseases & operations
.
.       * CAR 280968 - hard code 9 in HDONSET when PTEDOSET blank ** change removed **
.
.          MATCH     SP70,PTEDOSET
.          IF        @EQUAL
.            MOVE      "9",HDONSET
.          ELSE
            MOVE      PTEDOSET,HDONSET
.          ENDIF
.
          MOVE      FORM2,HDCOUNT
          SQUEEZE   HDCOUNT
.
          MOVE      PTEDCODE,DIM9
...       MOVE      PTEDUNQN,RECORDN
          MOVE      PTEDDESC,HDDODESC
          MOVE      PTEDDESC,HDDOLDES
.
          MATCH     "10",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      EXHD1900
          ENDIF
.
          MATCH     "11",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      EXHD1900
          ENDIF
.
.... CAR 48127
          MATCH     "12",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      EXHD1900
          ENDIF
....
.
          MATCH     "13",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      EXHD1900
          ENDIF
.
          MATCH     "14",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      EXHD1900
          ENDIF
.
          MATCH     "15",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      EXHD1900
          ENDIF
.
          MATCH     "16",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      EXHD1900
          ENDIF
.
          MOVE      PTEDCODE,DIM1
          TYPE      DIM1                  * numeric ?
          GOTO      EXHD1500 IF EQUAL
.
          MOVE      DIM1,ANS
          REP       "V1M2E3",ANS
          TYPE      ANS                   * Test for V,M or E codes
          IF        !@EQUAL
            UNPACK    PTEDCODE,DIM1,PTEDCODE * Unknown code process as numeric
            PACK      PTEDCODE,PTEDCODE,SP30
            GOTO      EXHD1500
          ENDIF
.
.------   Load the extract code type ------
.
          MOVE      ANS,FORM1
          BRANCH    FORM1,EXHD1500         * Handle normally if a V but don't
.                                            strip off letter
          LOAD      HDCODTYP,FORM1,PTEDTYPE,ANSM,ANSE
.
.         If "E code or "M" code, then strip off leading letter.
.
          UNPACK    PTEDCODE,DIM1,PTEDCODE
          PACK      PTEDCODE,PTEDCODE,SP30
.
.------ Set external cause date if E code ------
.
          IF        FORM1 = 3
            MATCH     SP8,PTEDACDT
            IF        @EQUAL
              MOVE      AOCCDTE,HDEXTDAT
            ELSE
              MOVE      PTEDACDT,HDEXTDAT
            ENDIF
          ENDIF
          GOTO       EXHD1800
.
EXHD1500  MOVE       PTEDTYPE,HDCODTYP
          MATCH      CMDISP,HDCODTYP      * Send A's as A's
          IF         !@EQUAL
            MOVE       CMDISS,HDCODTYP    * Send all B,C,D records as B's
          ENDIF
. 
.------   Format the code to specifications -----
.
EXHD1800  MOVE      PTEDCODE,DIM9
          REP       ". ",DIM9
          SQUEEZE   DIM9
          MOVE      DIM9,HDDOCODE
. 
.------   Set code and table type -----
.
          TYPE      DIM1
          IF        @EQUAL
            PACK      DIM9,DIM9,SP9         * Reset length
            UNPACK    DIM9,DIM4,DIM5
            REP       " 0",DIM4             * make sure string is numeric 
            MOVE      DIM4,FORM4
            COMPARE   "8000",FORM4
            IF        @LESS
              MOVE      ANSA,HDTABTYP
            ELSE
              MOVE      ANSB,HDTABTYP
            ENDIF
          ELSE
            MOVE      DIM1,HDTABTYP
          ENDIF
.
.-------  Cancer Patient details - if A or B type diagnosis ------
.
EXHD1900  IF        CANCERPT = 1 
            CALL      CANC0000
          ENDIF
.
EXHD2000  CALL      WRDT0000              * Write HD record
          GOTO      EXHD1000

EXHD5000  MOVE      TWO,DIOPFLAG
.
          PACK      KEY16,PVIBILL,SP20 
          CALL      RSPTECO2
EXHD6000  CALL      RKPTECO2
          BRANCH    OVRCD,EXHD9999
.
          MATCH     PVIBILL,PTEOADMN
          GOTO      EXHD9999 IF NOT EQUAL
.
          CALL      CLHD0000              * Clear HD details
.
          ADD       ONE,FORM2  
.         COMPARE   "100",FORM2
          COMPARE   ZERO,FORM2
          GOTO      EXHD9999 IF EQUAL
.
          MOVE      FORM2,HDCOUNT
          SQUEEZE   HDCOUNT
          MOVE      CMOPRT,HDCODTYP
          MOVE      ANSO,HDTABTYP
.
          MOVE      PTEOCODE,DIM9
          REP       ". ",DIM9
          REP       "- ",DIM9
          SQUEEZE   DIM9
          MOVE      DIM9,HDDOCODE
.
          MOVE        PTEOCODE,DIM9
....      MOVE        PTEOUNQN,RECORDN
          MOVE        PTEODESC,HDDODESC
          MOVE        PTEODESC,HDDOLDES
.
EXHD7000  MOVE        SP10,HDOPDATE 
          MATCH       CMOPRT,HDCODTYP
          IF          @EQUAL 
            MOVE        PTEODATE,HDOPDATE
          ENDIF
.
          CALL        WRDT0000
          GOTO        EXHD6000
          
EXHD9999  RETURN
.
.**********************************************************************
.*                           ITEN0000                                 *
.*                   Extract Coding in ICD10                          *
.**********************************************************************
ITEN0000  PACK      KEY9,PTEDCODE,SP10
.... CAR 48127
          CALL      RDPTICD1
....
.
          MOVE      PTEDTYPE,HDCODTYP     * default to disease type
          MATCH     CMDISP,HDCODTYP
          IF        !@EQUAL
            MOVE      CMDISS,HDCODTYP       * send all other types as 'B'
          ENDIF
.
. ---- Set up clinical code table type ----
.
          MOVE      ANSA,HDTABTYP         * default to A
.
          MATCH     ANSS,PTEDCODE         * set to 'B' if S-code
          IF        @EQUAL
            MOVE      ANSB,HDTABTYP
          ENDIF
.
          MATCH     ANST,PTEDCODE         * set to 'B' if T-code
          IF        @EQUAL
            MOVE      ANSB,HDTABTYP
          ENDIF
.
          MATCH     ANSZ,PTEDCODE         * set to 'V' if 'health factor'
          IF        @EQUAL
            MOVE      ANSV,HDTABTYP
          ENDIF
.
          MATCH     "4",PT0DACRQ
          IF        @EQUAL
            MOVE      ANSM,HDCODTYP       * morphology
            MOVE      ANSM,HDTABTYP
          ENDIF
.
          MATCH     "2",PT0DACRQ
          GOTO      ITEN2000 IF EQUAL
.
          MATCH     "6",PT0DACRQ
          GOTO      ITEN2000 IF EQUAL
.
          MATCH     "7",PT0DACRQ
          GOTO      ITEN2000 IF EQUAL
.
          MATCH     "8",PT0DACRQ
          GOTO      ITEN2000 IF EQUAL
.
          MATCH     ANSP,PT0DACRQ
          GOTO      ITEN2000 IF EQUAL
.
          MATCH     ANSA,PT0DACRQ
          GOTO      ITEN2000 IF EQUAL
.
          GOTO      ITEN8000
.
ITEN2000  MOVE      ANSE,HDCODTYP       * external cause
          MOVE      ANSE,HDTABTYP
          MATCH     SP8,PTEDACDT        * set external cause date
          IF        @EQUAL
            MOVE      AOCCDTE,HDEXTDAT
          ELSE
            MOVE      PTEDACDT,HDEXTDAT
          ENDIF
.
.------   Format the code to specifications -----
.
ITEN8000  MOVE      PTEDCODE,DIM9
          REP       ". ",DIM9
          REP       "/ ",DIM9
          REP       "- ",DIM9
          SQUEEZE   DIM9
.
.         If this is a morphology code, then strip the leading "M" and the
.         fifth digit
.
          MATCH     ANSM,HDCODTYP
          IF        @EQUAL
            UNPACK    DIM9,DIM1,DIM4,DIM4A
            PACK      DIM9,DIM4,SP9
          ENDIF
.
          MOVE      DIM9,HDDOCODE
.
ITEN9999  RETURN
.**********************************************************************
.*                           EXHC0000                                 *
.*                   Extract Mental Health Data.                      *
.**********************************************************************
EXHC0000  MOVE      "HC",HCRTYPE
          MOVE      ZERO,FORM2
          UNPACK    NHMANMPI,HCHCUID
          MOVE      HEEVTCOD,HCEVCOD
          MOVE      PVIDATE,HCEVSTD
          UNPACK    ATIME,DIM2,DIM1,DIM2A
          PACK      HCEVSDT,ADATE,DIM2,DIM2A        * event start date
          MOVE      HEAGENCY,HCAGENT
          MOVE      HEUNIQUE,HCUNIQE
.
          MOVE      ONE,LSCOUNT
          WHILE     LSCOUNT <= 50
            MOVE      SP70,SAVLSCOD[LSCOUNT]  * Clear legal status code/date
            ADD       ONE,LSCOUNT
          DO
.
.******************************************** start of changes 
....      PACK      KEY21,PVIBILL,SP20
....      CALL      RSMHLEG1                * Read legal status file
....1000  CALL      RKMHLEG1
....      BRANCH    OVRCD,EXHC9999
.
....      MATCH     MHLEADMN,PVIBILL
....      GOTO      EXHC1000 IF NOT EQUAL
.
.         Make sure the record is not a review status change
.
....      MATCH     ANSR,MHLEFLAG                * review status change ?
....      GOTO      EXHC1000 IF EQUAL            * yes - ignore
.
....      COMPARE   "99",FORM2
....      GOTO      EXHC9999 IF NOT LESS
.
....      MOVE      MHLEDATE,HCLSTDT
....      PACK      KEY5,ANSL,ANSS,MHLESTAT
....      CALL      RDCODE1                      * Cat "LS"
....      BRANCH    OVRCD,EXHC1000
....      SQUEEZE   THCSCOD
....      MOVE      THCSCOD,HCLSTCD
.
.         ********* at this point, Master recd., Admiss.recd., and Disch.recd
.         ********* have all been read - use ADATE & DDATE to determine if
.         ********* the correct "mehdlsaf" record has been read
.
EXHC1000  PACK      KEY32,AURNO,ZEDS
          CALL      RSMHDLS1
.
EXHC2000  CALL      RPMHDLS1
          BRANCH    OVRCD,EXHC9999
.
          MATCH     MHDLURNO,AURNO
          GOTO      EXHC9999 IF NOT EQUAL
.
          MATCH     MHDLSDAT,ENDDATE
          GOTO      EXHC2000 IF LESS
.
          MATCH     SP70,DDATE
          IF        !@EQUAL
            MATCH     MHDLSDAT,DDATE
            GOTO      EXHC2000 IF LESS
          ENDIF
.
          MATCH     SP70,MHDLEDAT
          GOTO      EXHC3000 IF EQUAL
.
          COMPARE   "3",ASTAT
          IF        @EQUAL
            MATCH     MHDLSDAT,DDATE
            GOTO      EXHC2000 IF LESS      * after Disch.Date - get prior one
          ENDIF
.
          MATCH     ADATE,MHDLEDAT
          GOTO      EXHC2000 IF LESS
.
EXHC3000  MATCH     "0",MHDLACTV
          GOTO      EXHC2000 IF NOT EQUAL   * if not active, get prior one
.
....      CMATCH    "Y",MHDLSENT 
....      GOTO      EXHC2000 IF EQUAL       * already sent (really needed ??)
.
          MOVE      MHDLSDAT,HCLSTDT
          PACK      KEY5,ANSL,ANSS,MHDLSCOD
          CALL      RDCODE1                      * Cat "LS"
          BRANCH    OVRCD,EXHC2000
          MATCH     "X",TCINDC8             * exclude if Ind.4 = "X" 
          GOTO      EXHC2000 IF EQUAL 
          BRANCH    OVRCD,EXHC2000
          SQUEEZE   THCSCOD
          MOVE      THCSCOD,HCLSTCD
.********************************************   end of changes 
.
.>>>> Don't send duplicate code/date combo for legal status
.
          PACK      KEY10,MHDLSDAT,THCSCOD,SP10       * current date/code combo
          MOVE      ONE,LSCOUNT
EXHC4000  MATCH     KEY10,SAVLSCOD[LSCOUNT]           * check with saved combos
          GOTO      EXHC2000 IF EQUAL
.
          MATCH     SP70,SAVLSCOD[LSCOUNT]            * end of array ?
          GOTO      EXHC5000 IF EQUAL
.
          COMPARE   FIFTY,LSCOUNT
          GOTO      EXHC2000 IF NOT LESS              * 50 record limit
.
          ADD       ONE,LSCOUNT                       * check all array combos
          GOTO      EXHC4000
.
EXHC5000  PACK      SAVLSCOD[LSCOUNT],MHDLSDAT,THCSCOD,SP10    * save code/date
.>>>>
          CALL      WRCT0000
.
          ADD       ONE,FORM2
....      IF        NODFLAG = 1
....        MOVE      ANSY,MHLESENT
....        CALL      UPMHLEG1
....        MATCH     "PROD",PROCENV
....        IF        @EQUAL
....          MOVE      "Y",MHDLSENT
....          CALL      UPMHDLS1   
....        ENDIF
....      ENDIF
.
          GOTO      EXHC2000 
.
EXHC9999  RETURN
.
.**********************************************************************
.*                           MHHD0000                                 *
.*             extract disease & operation for HD record              *
.**********************************************************************
.
MHHD0000  MOVE      "HD",HDRTYPE
          UNPACK    NHMANMPI,HDHCUID
.
          UNPACK    PBDATE,CCENT,CYEAR,CMON,CDAY
          PACK      DIM8,CCENT,CYEAR,CMON,CDAY
          REP       " 0",DIM8
.
          MOVE      HEEVTCOD,HDEVTCOD
          MOVE      PVIDATE,HDEVTSTD
          UNPACK    ATIME,DIM2,DIM1,DIM2A
          PACK      HDEVTSDT,ADATE,DIM2,DIM2A        * event start date
          MOVE      HEAGENCY,HDAGENCY
          MOVE      HEUNIQUE,HDUNIQUE
.
          MATCH     SP70,MHDIDATE
          IF        @EQUAL
            MOVE      "13",HDCODSYS
            GOTO       MHHD0500
          ENDIF
.
          MATCH     PTCNI10D,MHDIDATE
          IF        @LESS
            MOVE      "06",HDCODSYS         * Coded in ICD9
            GOTO      MHHD0500
          ENDIF
.
          MATCH     PTCNGDX2,MHDIDATE       * ICD10 Ed.12 
          IF        !@LESS
            MOVE      "16",HDCODSYS
            GOTO      MHHD0500
          ENDIF
.
          MATCH     PTCNGDX1,MHDIDATE       * ICD10 Ed.11 
          IF        !@LESS
            MOVE      "15",HDCODSYS
            GOTO      MHHD0500
          ENDIF
.
          MATCH     PTCNGDVX,MHDIDATE       * ICD10 Ed.10 
          IF        !@LESS
            MOVE      "15",HDCODSYS
            GOTO      MHHD0500
          ENDIF
.
          MATCH     PTCNGDV9,MHDIDATE       * ICD10 Ed.9 
          IF        !@LESS
            MOVE      "15",HDCODSYS
            GOTO      MHHD0500
          ENDIF
.
          MATCH     PTCNGDV8,MHDIDATE       * ICD10 Ed.8 
          IF        !@LESS
            MOVE      "14",HDCODSYS
            GOTO      MHHD0500
          ENDIF
.
          MATCH     MHDIDATE,PTCNGDV7       * ICD10 Ed.7 
          IF        @LESS
            MOVE      "14",HDCODSYS
            GOTO      MHHD0500
          ENDIF
.
          MATCH     MHDIDATE,PTCNGDV6
          IF        @LESS
            MOVE      "13",HDCODSYS
            GOTO      MHHD0500
          ENDIF
.
          MATCH     MHDIDATE,PTCNGDV3       * is go live date less than start?
          IF        @LESS
            MOVE      "12",HDCODSYS         * ICD10 Version 3
          ELSE
            MATCH     MHDIDATE,PTCNGDV2
              IF        @LESS
              MOVE      "11",HDCODSYS
            ELSE
              MOVE      "10",HDCODSYS       * Coded in ICD10
             ENDIF
          ENDIF
.
MHHD0500  MOVE      ZERO,FORM2
          PACK      KEY16,PVIBILL,ZEDS
          CALL      RSMHDIA1
          CALL      RPMHDIA1
          BRANCH    OVRCD,MHHD9999
.
          MATCH     PVIBILL,MHDIADMN
          GOTO      MHHD9999 IF NOT EQUAL
.
MHHD1000  CALL      CLHD0000                * clear HD record details
          MOVE      ONE,DIOPFLAG
.
          ADD       ONE,FORM2
          COMPARE   THREE,FORM2
          GOTO      MHHD9999 IF EQUAL       * only want 1st 25 diseases
.                                             & Operations
.
.       * CAR 280968 - hard code 9 in HDONSET when PTEDOSET blank ** change removed **
.
          PACK      KEY14,PVIBILL,SP70
          CALL      RSPTECD2
          CALL      RKPTECD2
.          BRANCH    OVRCD,MHHD1100
          BRANCH    OVRCD,MHHD1200
.
          MATCH     PVIBILL,PTEDADMN
.          GOTO      MHHD1100 IF NOT EQUAL
          GOTO      MHHD1200 IF NOT EQUAL
.
.          MATCH     SP70,PTEDOSET
.          GOTO      MHHD1100 IF EQUAL
.
          MOVE      PTEDOSET,HDONSET
          GOTO      MHHD1200
.
.MHHD1100  MOVE      "9",HDONSET
.
MHHD1200  MOVE      FORM2,HDCOUNT
          SQUEEZE   HDCOUNT
.
          LOAD      PTEDTYPE,FORM2,CMDISP,CMDISS
          LOAD      DIM9,FORM2,MHDIICD1,MHDIICD2
          LOAD      PTEDCODE,FORM2,MHDIICD1,MHDIICD2
          LOAD      HDDODESC,FORM2,MHDIDES1,MHDIDES2
          LOAD      HDDOLDES,FORM2,MHDIDES1,MHDIDES2
.
          MATCH     SP9,DIM9
          GOTO      MHHD1000 IF EQUAL
.
          MOVE      MHDIDATE,ICDRDDTE
          MATCH     "10",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      MHHD2000
          ENDIF
.
          MATCH     "11",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      MHHD2000
          ENDIF
.
          MATCH     "12",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      MHHD2000
          ENDIF
.
          MATCH     "13",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      MHHD2000
          ENDIF
.
          MATCH     "14",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      MHHD2000
          ENDIF
.
          MATCH     "15",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      MHHD2000
          ENDIF
.
          MATCH     "16",HDCODSYS
          IF        @EQUAL
            CALL      ITEN0000              * Coding is in ICD10
            GOTO      MHHD2000
          ENDIF
.
          LOAD      PTEDTYPE,FORM2,ANSA,ANSB
          MOVE      PTEDCODE,DIM1
          TYPE      DIM1                  * numeric ?
          GOTO      MHHD1500 IF EQUAL
.
          MOVE      DIM1,ANS
          REP       "V1M2E3",ANS
          TYPE      ANS                   * Test for V,M or E codes
          IF        !@EQUAL
            UNPACK    PTEDCODE,DIM1,PTEDCODE * Unknown code process as numeric
            PACK      PTEDCODE,PTEDCODE,SP30
            GOTO      MHHD1500
          ENDIF
.
.------   Load the extract code type ------
.
          MOVE      ANS,FORM1
          BRANCH    FORM1,MHHD1500         * Handle normally if a V but don't
.                                            strip off letter
          LOAD      HDCODTYP,FORM1,PTEDTYPE,ANSM,ANSE
.
          UNPACK    PTEDCODE,DIM1,PTEDCODE * strip letter from code if M or E
          PACK      PTEDCODE,PTEDCODE,SP30
          
.
.------ Set external cause date if E code ------
.
          IF        FORM1 = 3
            MATCH     SP8,PTEDACDT
            IF        @EQUAL
              MOVE      AOCCDTE,HDEXTDAT
            ELSE
              MOVE      PTEDACDT,HDEXTDAT
            ENDIF
          ENDIF
          GOTO       MHHD1800
.
MHHD1500  MOVE       PTEDTYPE,HDCODTYP
          MATCH      CMDISP,HDCODTYP      * Send A's as A's
          IF         !@EQUAL
            MOVE       CMDISS,HDCODTYP    * Send all B,C,D records as B's
          ENDIF
. 
.------   Format the code to specifications -----
.
MHHD1800  MOVE      PTEDCODE,DIM9
          REP       ". ",DIM9
          SQUEEZE   DIM9
          MOVE      DIM9,HDDOCODE
. 
.------   Set code and table type -----
.
          TYPE      DIM1
          IF        @EQUAL
            PACK      DIM9,DIM9,SP9         * Reset length
            UNPACK    DIM9,DIM4,DIM5
            REP       " 0",DIM4             * make sure string is numeric 
            MOVE      DIM4,FORM4
            COMPARE   "8000",FORM4
            IF        @LESS
               MOVE      ANSA,HDTABTYP
            ELSE
               MOVE      ANSB,HDTABTYP
            ENDIF
          ELSE
            MOVE      DIM1,HDTABTYP
          ENDIF
.
MHHD2000  CALL      WRDT0000              * Write HD record
          GOTO      MHHD1000

MHHD9999  RETURN
.
.********************************************************************** 
.*                           CANC0000                                 *
.*         Get the Cancer Register Details if registered              *
.**********************************************************************
.
CANC0000  MATCH     ANSM,HDTABTYP           * we have an M code
          GOTO      CANC5000 IF EQUAL
.
          PACK      KEY25,AADMNO,SP20             
          CALL      RSPTCRD1
          CALL      RKPTCRD1
          BRANCH    OVRCD,CANC9999 
.
          MOVE      ONE,CANCCODE
.
.------   These codes are stored in temporay variables because they are ------
.------   sent with M codes (Morphology codes) which are sent with each ------
.------   cancer code.
.
.------   Basis of cancer diagnosis code ------
.
          MOVE      SP10,THCSCOD
          PACK      KEY5,ANSB,ANSD,PTCDBSDG
          CALL      RDCODE1                      * Cat "BD"
          MOVE      THCSCOD,TPBASCAN
.
.------   Stage of cancer disease code -----
.
          MOVE      SP10,THCSCOD
          PACK      KEY5,ANSS,ANSG,PTCDSTAG
          CALL      RDCODE1                      * Cat "SG"
          MOVE      THCSCOD,TPSTGCAN
.
.------   Breslow Thickness ------
.
          MOVE       PTCDBRLW,TPMELTHK
.
.------   Melanoma Invasion Level ------
.
          MOVE       SP10,THCSCOD
          PACK       KEY5,ANSI,ANSL,PTCDMLIN
          CALL       RDCODE1                      * Cat "IL"
          MOVE       THCSCOD,TPMELINV
.
.------   Reporting Laboratory Code -----
.         
          MOVE       SP10,THCSCOD
          PACK       KEY5,ANSL,ANSB,PTCDRPLB
          CALL       RDCODE1                      * Cat "LB"
          MOVE       THCSCOD,TPLABCOD
          GOTO       CANC9999
.
CANC5000  COMPARE    ZERO,CANCCODE          * was previous code a registered
          GOTO       CANC9999 IF EQUAL        cancer code
.
          MOVE       ZERO,CANCCODE
.
CANC9999  RETURN
.
+
.********************************************************************** 
.*                           LEAV0000                                 *
.*         Calculate the number of days a patient was on leave        *
.**********************************************************************
.
LEAV0000  MOVE      ZERO,FORM3
          MOVE      SP3,HELDAYS
          SQUEEZE   HELDAYS
          PACK      KEY30,PVIBILL,SP30
          CALL      RDSTRAN2
LEAV1000  CALL      RDKTRAN2
          BRANCH    OVRCD,LEAV9000
.
          MATCH     PVIBILL,TADMN
          GOTO      LEAV9000 IF NOT EQUAL
.
          MATCH     ANSD,TMOVE
          GOTO      LEAV9000 IF EQUAL
.
          MATCH     ANSL,TMOVE
          GOTO      LEAV1000 IF NOT EQUAL
.
          PACK      CDYSFDTE,TDATE
          REP       " 0",CDYSFDTE
.
LEAV2000  CALL      RDKTRAN2
          BRANCH    OVRCD,LEAV5000          * If over use todays date
.
          MATCH     PVIBILL,TADMN
          GOTO      LEAV5000 IF NOT EQUAL
.
          MATCH     ANSR,TMOVE
          GOTO      LEAV2000 IF NOT EQUAL
.
          PACK      CDYSTDTE,TDATE
          REP       " 0",CDYSTDTE
.
          CALL      CALCDAYS
          IF        CDYSDAYS > 0
            SUB       ONE,CDYSDAYS
          ENDIF
          ADD       CDYSDAYS,FORM3
.
.       Get the leave end code if this is a Mental Health Patient
.       that was discharged to leave (DLFLAG = 1)
.
          COMPARE   ONE,HCFLAG
          GOTO      LEAV1000 IF NOT EQUAL
.
          COMPARE   ONE,DLFLAG
          GOTO      LEAV1000 IF NOT EQUAL
.
          PACK      DIM8A,TDATE
          REP       " 0",DIM8A
.
.------   For mental health patients that were discharged to leave ------
.------   (DLFLAG = 1) we need to re-set the event end date to the ------
.------   day that they went on leave.                             ------
.
          MOVE      CDYSFDTE,HEEDATE
          UNPACK    TTIME,DIM2,DIM1,DIM2A
          PACK      HEEDATTM,HEEDATE,DIM2,DIM2A
.
          PACK      KEY24,TADMN,DIM8A,TTIME
          CALL      RDMHLER1
          BRANCH    OVRCD,LEAV1000
.
          PACK      KEY5,CODELE,MHLRCODE
          CALL      RDCODE1                      * Cat "LE"
          BRANCH    OVRCD,LEAV1000
.
          PACK      THCSCOD,THCSCOD,SP4
          MATCH     THCSCOD,SP4
          GOTO      LEAV1000 IF EQUAL

          SQUEEZE   THCSCOD
          MOVE      THCSCOD,HEPLVEC
          PACK      HEPLVEND,TDATE
          REP       " 0",HEPLVEND
          GOTO      LEAV1000
.
LEAV5000  MOVE      TODAY,CDYSTDTE
          CALL      CALCDAYS
          IF        CDYSDAYS > 0
            SUB       ONE,CDYSDAYS
          ENDIF
          ADD       CDYSDAYS,FORM3
.
.-----  Only set up the leave days value if it is not zero ------
.
LEAV9000  IF        FORM3 > 0
            MOVE      FORM3,HELDAYS
          ENDIF
.
LEAV9999  RETURN
+
.*****************************************************************************
.                            NATN0000 
.                     Get the national number
.*****************************************************************************
NATN0000  MOVE      ZERO,EXIT
.
          IF        PTCNNHII = 1
            PACK      KEY8,PURNO             * NHI is on so read NHIMAS
            CALL      RDNHMAS2
            BRANCH    OVRCD,NATN9000
          ELSE
            PACK      KEY10,CHOSINDX,PURNO   * NHI is off so use PATNID
            CALL      RDPTNID1
            BRANCH    OVRCD,NATN9000         
            UNPACK    PTNINMPI,DIM13,NHMANMPI
          ENDIF
          GOTO      NATN9999
.
NATN9000  MOVE      ONE,EXIT
.
NATN9999  RETURN
+
.*****************************************************************************
.                            CHKDHB00
.         Validates that 'District Health Board' of the patient's visit
.         hospital (PMVXMHOS) matches the HDP Default entered (DHBPREFX).
.
.*****************************************************************************
CHKDHB00  MOVE      ZERO,EXIT
          MATCH     SP70,PMVXMHOS           * Hospital for visit filled in?
          GOTO      CHKDHB91 IF EQUAL       * no; invalid
.
          PACK      KEY3,PMVXMHOS,SP70
          CALL      RDPTHSP1
          BRANCH    OVRCD,CHKDHB91
.
          MATCH     SP70,PTHSHDHB           * District Health Board setup?
          GOTO      CHKDHB91 IF EQUAL       * no; invalid
.
          PACK      KEY5,CATdh,PTHSHDHB,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,CHKDHB91
.
          MATCH     DHBPREFX,THCSCOD        * matching HDP Default?
          GOTO      CHKDHB91 IF NOT EQUAL   * no; invalid
.
          GOTO      CHKDHB99
.
CHKDHB91  MOVE      ONE,EXIT                * doesn't match
CHKDHB99  RETURN
+
.********************************************************************** 
.*                           MAGE0000                                 *
.*                   calculate the mothers age                        *
.**********************************************************************
.
MAGE0000  PACK      KEY8,DIM8               * DIM8 contains mother U/R
          CALL      RDMAST1
          BRANCH    OVRCD,MAGE9999
.
.>>>>>  Calculate the mothers age  <<<<<<
.
          MOVE      BABYDOB,AGEDATE         * we want mothers age at time of 
.                                             birth i.e. babies date of birth
          CALL      CALCAGE
          MOVE      PSAGEYRS,FORM2
          MOVE      FORM2,HEMUMAGE
          REP       " 0",HEMUMAGE
.
.>>>>  Restore the babies records <<<<<<.
.
          PACK      KEY8,AADMNO
          CALL      RDVISA1
          
          PACK      KEY8,AURNO
          CALL      RDMAST1
. 
MAGE9999  RETURN
.
.
.********************************************************************** 
.*                           GMUR0000                                 *
.*                   get mothers UR number from the link file         *
.**********************************************************************
.
GMUR0000  OPEN      PATLINK1,"patlinkf"
          MOVE      ZERO,EXIT
.
          PACK      KEY16,PURNO,SP10        * us ebabies U/R
          CALL      RDSLINK1
GMUR1000  CALL      RDKLINK1
          BRANCH    OVRCD,GMUR9000
.
          MATCH     LINKFUR,PURNO
          GOTO      GMUR9000 IF NOT EQUAL
.
          MATCH     PTCNDLKR,LINKREA        * Is this the correct link reason
          GOTO      GMUR1000 IF NOT EQUAL
.
          GOTO      GMUR9999
.
GMUR9000  MOVE      ONE,EXIT
GMUR9999  RETURN
.
.********************************************************************** 
.*                           MHAD0000                                 *
.* Get The Non-Discharge Data To Extract For Mental Health Patients   * 
.**********************************************************************
MHAD0000  COMPARE   ZERO,MHCNUSE            * Check if using Mental Health
          GOTO      MHAD9999 IF EQUAL
.
          MOVE      TRUE,HCFLAG
.
          DISPLAY   *P1:24,*EL,"Extracting for Admitted Mental Health ":
                    "U/R : ";
          MOVE      STRTDATE,FROMDATE
          MOVE      ENDDATE,TODATE
.
          PACK      KEY9,ONE,SP10
          CALL      RSMHVIS2
MHAD1000  CALL      RKMHVIS2
          BRANCH    OVRCD,MHAD9999
.
.-------  Check the visit status  -------
.
          COMPARE   SIX,MHVISTAT
          GOTO      MHAD9999 IF NOT LESS
.
          PACK      KEY8,MHVIADMN,SP70
          CALL      RDMISS1
          BRANCH    OVRCD,MHAD1000
.
          MATCH     ADATE,FROMDATE    * ignore if admitted before the start
          GOTO      MHAD1000 IF NOT LESS
.
          MATCH     ADATE,TODATE      * ignore if admitted after end of extract
          GOTO      MHAD1000 IF LESS
.
          COMPARE   TWO,ASTAT
          GOTO      MHAD1500 IF EQUAL
.
          COMPARE   FOUR,ASTAT
          GOTO      MHAD1000 IF NOT EQUAL
.
.-------  Check the diagnosis file  -------
.
MHAD1500  PACK      KEY16,MHVIADMN,SP10
          CALL      RSMHDIA1
          CALL      RKMHDIA1
          BRANCH    OVRCD,MHAD1000
          MATCH     MHVIADMN,MHDIADMN
          GOTO      MHAD1000 IF NOT EQUAL
.
.-------  Check the legal status history file  -------
.
. ******************************************* start of changes        *C-109741
....      PACK      KEY21,MHVIADMN,STRTDATE,SP20
....      CALL      RSMHLEG1
....2000  CALL      RKMHLEG1
....      BRANCH    OVRCD,MHAD1000
....
....      MATCH     MHVIADMN,MHLEADMN          * Check Admission Number
....      GOTO      MHAD1000 IF NOT EQUAL
....
....      MATCH     MHLEDATE,ENDDATE           * Check Change Date
....      GOTO      MHAD1000 IF LESS
....
....      MATCH     ANSR,MHLEFLAG              * review status change ?
....      GOTO      MHAD2000 IF EQUAL          * yes - ignore
....
....      MATCH     ANSY,MHLESENT
....      GOTO      MHAD3000 IF NOT EQUAL
....      GOTO      MHAD2000
.
....      PACK      KEY32,MHVIURNO,ZEDS,SP30
....      CALL      RSMHDLS1
....MHAD2000  CALL      RPMHDLS1
....      BRANCH    OVRCD,MHAD1000
.
....      MATCH     MHDLURNO,MHVIURNO
....      GOTO      MHAD1000 IF NOT EQUAL
.
....      MATCH     STRTDATE,MHDLSDAT
....      GOTO      MHAD1000 IF LESS
.
....      CMATCH    "Y",MHDLSENT 
....      GOTO      MHAD3000 IF NOT EQUAL
....      GOTO      MHAD2000
. *******************************************   end of changes        *C-109741
. 
MHAD3000  CALL      EXMH0000
          GOTO      MHAD1000 
.
MHAD9999  RETURN
.
.********************************************************************** 
.*                           EXMH0000                                 *
.*        Extract The Non-Discharged MEH Data                         *
.**********************************************************************
.
EXMH0000  PACK      KEY8,MHVIADMN
          CALL      RDMISS1
          BRANCH    OVRCD,EXMH9999
.
          COMPARE   TWO,ASTAT
          GOTO      EXMH1000 IF EQUAL
.
          COMPARE   FOUR,ASTAT
          GOTO      EXMH1000 IF EQUAL
.
          GOTO      EXMH9999
.
EXMH1000  DISPLAY   *P45:24,*V2LON,AURNO
.
          PACK      KEY8,AADMNO
          CALL      RDVISA1
          BRANCH    OVRCD,EXMH9999
          CALL      RDPMVX11
          BRANCH    OVRCD,EXMH9999            * if no record found ignore
.
          CALL      CHKDHB00
          BRANCH    EXIT,EXMH9999             * if hospital DHB doesn't match
.
          PACK      KEY8,PVIURNO
          CALL      RDMAST1
          BRANCH    OVRCD,EXMH9999
.
          CALL      NATN0000
          BRANCH    EXIT,EXMH9999
.
          MOVE      ONE,NODFLAG
          UNPACK    SP20,DDATE,DSTAT
          UNPACK    SP20,DTIME
          CALL      EXHE0000
          CALL      MHHD0000
          CALL      EXHC0000
.
          MATCH     "PROD",PROCENV
          IF        @EQUAL
            MOVE      THREE,AELIG
            CALL      UPMISS1
          ENDIF
.
EXMH9999  RETURN
.
.********************************************************************** 
.*                           ENDE0000                                 *
.*                   Finished the extraction of data                  *
.**********************************************************************
.
ENDE0000  CALL      CLHR0000                     * clear HR variables
          CALL      EXHR0000                     * extract HR (header) record
.
          CLOSE     XXTRTMP1                     * close tempfile
          CALL      WREX0000                     * write to extract file
          CALL      MVEXT000                     * move extract to web   
.
          DISPLAY   *P1:24,*EL,"Extraction Completed. ";
          CALL      HITENTER
ENDE9999  RETURN
+
.********************************************************************** 
.*                           WREX0000                                 *
.*     Routine to move data from the tempfile to the extract file     *
.**********************************************************************
WREX0000  MOVE      ZERO,OVRCD
          TRAP      OVERCOND IF IO
          OPEN      XXTRTMP1,FNAME               * open tempfile
          TRAPCLR   IO
          BRANCH    OVRCD,WREX9999               * no data to extract
.
WREX0500  READ      XXTRTMP1,SEQ;KEY2;           * check record type
          GOTO      WREX9000 IF OVER             * end of file
.
          UNPACK    KEY2,KEY1,ANS
          REP       "E1D2C3",ANS
          MOVE      ANS,FORM1
          BRANCH    FORM1,WREX1000,WREX2000,WREX3000
.                            HE       HD       HC
          GOTO      WREX0500
.
.------   HE Record ------
.
WREX1000  MOVE      KEY2,HERTYPE
          READ      XXTRTMP1,SEQ;HEHCUID,HEEVTCOD,HEEVTSDT,HEAGENCY:
                             HEUNIQUE,HEMFUNCT,HEDOMIC,HESEX,HEDOB:
                             HEETHNIC,HEETHNI2,HEETHNI3,HERESI,HEASRCE:
                             HEDEPT,HECARE:
                             HEETYPE,HEEDATTM,HECOB,HEOCCUP:
                             HEOCCDES,HEBDLOC:
                             HEBWGHT,HEGESTAT,HEBSTAT,HEMUMAGE:
                             HELDAYS,HESUPPI,HESUPPRS:
                             HEPLVEND,HEPLVEC,HEPHSPUR,HEHLAGNC:
                             HEADMWGT,HEACCFLG,HEACCCLM:
                             HEHRSMEC,OLDCPAP,HEADMISS,HECONTRL,DIM2:
                             HEMTHNHI,HEICUHRS,HETRNFRM,HETRNTO,HEHRCPAP:
                             HEFUNDAG
.
          CALL      WRHE0000                * write an HE record to extract
.
          GOTO      WREX0500
.
.------   HD Record ------
.
WREX2000  MOVE      KEY2,HDRTYPE
          READ      XXTRTMP1,SEQ;HDHCUID,HDEVTCOD,HDEVTSDT,HDAGENCY:
                             HDUNIQUE,HDCOUNT,HDCODSYS,HDCODTYP,HDTABTYP:
                             HDDOCODE,HDDOLDES,HDOPDATE:
                             HDEXTDAT,HDONSET
.
          CALL      WRHD0000                * write an HD record to extract
.
          GOTO      WREX0500
.
.------   HC Record ------
.
WREX3000  MOVE      KEY2,HCRTYPE
          READ      XXTRTMP1,SEQ;HCHCUID,HCEVCOD,HCEVSDT,HCAGENT:
                                   HCUNIQE,HCLSTDT,HCLSTCD
.
          CALL      WRHC0000                * write an HC record to extract
          GOTO      WREX0500
.
WREX9000  CLOSE     XXTRTMP1,DELETE         * delete ASCII tempfile
WREX9999  RETURN
+
.********************************************************************** 
.*                           WRDT0000                                 *
.*            Routine to Write Data Records to the Temp File          *
.**********************************************************************
WRDT0000  WRITE     XXTRTMP1,SEQ;HDRTYPE,HDHCUID,HDEVTCOD,HDEVTSDT,HDAGENCY:
                             HDUNIQUE,HDCOUNT,HDCODSYS,HDCODTYP,HDTABTYP:
                             HDDOCODE,HDDOLDES,HDOPDATE:
                             HDEXTDAT,HDONSET
.
          ADD       ONE,TOTALREC                 * record counter
WRDT9999  RETURN
+
.********************************************************************** 
.*                           WRHD0000                                 *
.*            Routine to Write Data Records to the Extract File       *
.**********************************************************************
WRHD0000  MATCH     ANSE,HDTABTYP
          GOTO      WRHD0500 IF NOT EQUAL
.
          MATCH     ANSE,HDCODTYP
          GOTO      WRHD1000 IF EQUAL
.
WRHD0500  MOVE      SP8,HDEXTDAT
.
WRHD1000  MOVE      HDDODESC,DIM50
          MATCH     SP90,DIM50
          IF        !@EQUAL
            STRIP     DIM50
            PACK      HDDODESC,QUOTE,DIM50,QUOTE     * put quotes around desc.
          ENDIF
.
          MOVE      HDDOLDES,DIM200
          MATCH     SP90,DIM200
          IF        !@EQUAL
            STRIP     DIM200
            PACK      HDDOLDES,QUOTE,DIM200,QUOTE     * put quotes around desc.
          ENDIF
.
          CALL      STHD0000                * remove trailing spaces
.
.-----   Write the record to sequential file, leaving blank fields as null ----
.-----   and all fields without trailing spaces                            ----
.
          MOVE      ONE,COUNT
          REPEAT
            LOAD    VARIABLE,COUNT,HDRTYPE,HDHCUID,HDEVTCOD,HDEVTSDT,HDAGENCY:
                             HDUNIQUE,HDCOUNT,HDCODSYS,HDCODTYP,HDTABTYP:
                             HDDOCODE,HDDOLDES,HDOPDATE:
                             HDEXTDAT,HDONSET
.
. HDDOLDES length = 202 and it is > 127 so SFORMAT cannot work
.
            IF        COUNT = 12
              STRIP     HDDOLDES
              WRITE     XXTRACT1,SEQ;*+,HDDOLDES;
              WRITE     XXTRACT1,SEQ;COMMA;
              GOTO      WRHD8000
            ENDIF
.
            MOVELPTR  VARIABLE,FORM3A
            IF        FORM3A <> 0
              SFORMAT   VARIABLE,FORM3A
              LOAD  VARIABLE,COUNT,HDRTYPE,HDHCUID,HDEVTCOD,HDEVTSDT,HDAGENCY:
                             HDUNIQUE,HDCOUNT,HDCODSYS,HDCODTYP,HDTABTYP:
                             HDDOCODE,HDDOLDES,HDOPDATE:
                             HDEXTDAT,HDONSET
.
              IF         COUNT = 15
               WRITE     XXTRACT1,SEQ;VARIABLE
              ELSE
               WRITE     XXTRACT1,SEQ;VARIABLE;
              ENDIF
            ELSE
              IF         COUNT = 15
                WRITE    XXTRACT1,SEQ;012;
              ENDIF
            ENDIF
            IF        COUNT < 15
              WRITE     XXTRACT1,SEQ;COMMA;
            ENDIF
            SFORMAT   VARIABLE,127
.
WRHD8000    ADD       ONE,COUNT
          UNTIL     COUNT = 16
.
WRHD9999  RETURN
+
.********************************************************************** 
.*                           WRCT0000                                 *
.*            Routine to Write HC Data Records to the Temp File       *
.**********************************************************************
WRCT0000  WRITE     XXTRTMP1,SEQ;HCRTYPE,HCHCUID,HCEVCOD,HCEVSDT,HCAGENT:
                                 HCUNIQE,HCLSTDT,HCLSTCD
          ADD       ONE,TOTALREC                 * record counter
WRCT9999  RETURN
+
.********************************************************************** 
.*                           WRHC0000                                 *
.*            Routine to Write HC Data Records to the Extract File    *
.**********************************************************************
WRHC0000  CALL      STHC0000                * remove trailing spaces
.
.-----   Write the record to sequential file, leaving blank fields as null ----
.-----   and all fields without trailing spaces                            ----
.
          MOVE      ONE,COUNT
          REPEAT                  
            LOAD      VARIABLE,COUNT,HCRTYPE,HCHCUID,HCEVCOD,HCEVSDT,HCAGENT:
                                 HCUNIQE,HCLSTDT,HCLSTCD
            MOVELPTR  VARIABLE,FORM3A
            IF        FORM3A <> 0
              SFORMAT   VARIABLE,FORM3A
              LOAD     VARIABLE,COUNT,HCRTYPE,HCHCUID,HCEVCOD,HCEVSDT,HCAGENT:
                                 HCUNIQE,HCLSTDT,HCLSTCD
              IF        COUNT = 8
                WRITE     XXTRACT1,SEQ;VARIABLE
              ELSE
                WRITE     XXTRACT1,SEQ;VARIABLE;
              ENDIF
            ELSE
              IF        COUNT=8
                WRITE     XXTRACT1,SEQ;012;     
              ENDIF
            ENDIF
            IF        COUNT < 8
              WRITE     XXTRACT1,SEQ;COMMA;     
            ENDIF
            SFORMAT   VARIABLE,127
            ADD       ONE,COUNT
          UNTIL     COUNT = 9
WRHC9999  RETURN
+
.------------------------------------------------------------
. Move Extract to Web Directory
.------------------------------------------------------------
MVEXT000  CLEAR     CMDLINE                                 
          APPEND    "ibainp08.us1 ",CMDLINE
          APPEND    PATHNAME,CMDLINE        * pass full path of file to do mv
          APPEND    SP1,CMDLINE
          APPEND    FILENAME,CMDLINE        * pass filename for display on web
          RESET     CMDLINE
          EXECUTE   CMDLINE,TASKID
.
MVEXT999  RETURN
+
.**************************************************************************
.*                          STHE0000                                      *
.*                  Remove trailing spaces from HE variables              *
.**************************************************************************
STHE0000  STRIP   HERTYPE
          STRIP   HEHCUID
          STRIP   HEEVTCOD
          STRIP   HEEVTSTD
          STRIP   HEEVTSDT
          STRIP   HEAGENCY  
          STRIP   HEUNIQUE
          STRIP   HEMFUNCT
          STRIP   HEDOMIC
          STRIP   HESEX
          STRIP   HEDOB     
          STRIP   HEETHNIC
          STRIP   HEETHNI2
          STRIP   HEETHNI3
          STRIP   HERESI
          STRIP   HEASRCE
          STRIP   HEDEPT
          STRIP   HECARE    
          STRIP   HEETYPE
          STRIP   HEEDATE
          STRIP   HEEDATTM
          STRIP   HECOB
          STRIP   HEOCCUP
          STRIP   HEOCCDES
          STRIP   HEBDLOC   
          STRIP   HEBWGHT
          STRIP   HEGESTAT
          STRIP   HEBSTAT
          STRIP   HEMUMAGE
          STRIP   HELDAYS   
          STRIP   HESUPPI
          STRIP   HESUPPRS
          STRIP   HEPLVEND
          STRIP   HEPLVEC
          STRIP   HEPHSPUR
          STRIP   HEHLAGNC
          STRIP   HEADMWGT
          STRIP   HEACCFLG
          STRIP   HEACCCLM
          STRIP   HEPREPDT
          STRIP   HEPREPTM  
          STRIP   HECONTRL
          STRIP   HEADMISS
          STRIP   HEHRSMEC
          STRIP   HEHRCPAP
          STRIP   OLDCPAP
          STRIP   HESENDER
          STRIP   HERECVER
          STRIP   HEMTHNHI
          STRIP   HEICUHRS
          STRIP   HETRNFRM
          STRIP   HETRNTO
          STRIP   HEFUNDAG
.
STHE9999  RETURN

+
.**************************************************************************
.*                          STHD0000                                      *
.*                  Remove trailing spaces from HD variables              *
.**************************************************************************
STHD0000  STRIP   HDRTYPE
          STRIP   HDHCUID
          STRIP   HDEVTCOD
          STRIP   HDEVTSTD
          STRIP   HDEVTSDT
          STRIP   HDAGENCY
          STRIP   HDUNIQUE
          STRIP   HDCOUNT
          STRIP   HDCODSYS
          STRIP   HDCODTYP
          STRIP   HDTABTYP
          STRIP   HDDOCODE  
          STRIP   HDDODESC
          STRIP   HDDOLDES
          STRIP   HDOPDATE
          STRIP   HDEXTDAT
          STRIP   HDONSET
STHD9999  RETURN
+
.**************************************************************************
.*                          STHC0000                                      *
.*                  Remove trailing spaces from HC variables              *
.**************************************************************************
STHC0000  STRIP   HCRTYPE
          STRIP   HCHCUID
          STRIP   HCEVCOD
          STRIP   HCEVSTD
          STRIP   HCEVSDT
          STRIP   HCAGENT
          STRIP   HCUNIQE
          STRIP   HCLSTDT
          STRIP   HCLSTCD
STHC9999  RETURN
+
.**************************************************************************
.*                          STHR0000                                      *
.*                  Remove trailing spaces from HR variables              *
.**************************************************************************
STHR0000  STRIP   HRRTYPE
          STRIP   HRHAGNCY
          STRIP   HRFILNAM
          STRIP   HRNORECS
          STRIP   HRSNDDTE
          STRIP   HRPROENV
STHR9999  RETURN
+
.********************************************************************** 
.*              I/O INCLUDES FOR FILES AND GENERAL ROUTINES           *
.**********************************************************************
.
          INC       STD001IO
          INC       NHOSPDAY                  * bed day calculating routine
          INC       CALCDAYS
          INC       CALCAGE
          INC       PATCODKY
          INC       CLPMSNMH                  * Clear file vars for pmsnmhaf
          INC       CLPMSNMD                  * Clear file vars for pmsnmdaf
          INC       TFILENAM
.
          INC       EOCAFCIO/INC
          INC       EOCLNKIO/INC
          INC       EOCREFIO/INC
          INC       MEHDIAIO/INC              * Mental Health Diagnosis IO 
          INC       MEHDS1IO/INC              * MH Discharge File IO
          INC       MEHDLSIO/INC              * MH Legal Status Details
          INC       MEHLERIO/INC              * MH Leave End Codes
          INC       MEHVI1IO/INC              * MH Visit File IO
          INC       NHIMASIO/INC              * NHI Master
          INC       OUTRF1IO/INC              * O/P Referral Letter File
          INC       PATDADIO/INC              * adm/disc transfer dest. file
          INC       PATCODIO/INC              * code file
          INC       PATDO1IO/INC              * doctor file
          INC       PATDSCIO/INC              * discharge file
          INC       PATECDIO/INC
          INC       PATECOIO/INC
          INC       PATICDIO/INC              * icd-9cm diseases file
          INC       PATICOIO/INC              * icd-9cm operations file
          INC       PATICUIO/INC              * ICU file
          INC       PATLINIO/INC
          INC       PATMA1IO/INC              * master file
          INC       PATMI1IO/INC              * admission file
          INC       PMSVX1IO/INC              * visit extension file
          INC       PMSNMDIO/INC              * NMDS Extract Records
          INC       PMSNMHIO/INC              * NMDS Transmission File Batches
          INC       PATTRNIO/INC              * transfer file
          INC       PATVISIO/INC              * visit file
          INC       PATWR1IO/INC              * Ward file
          INC       PATWC1IO/INC
          INC       PMSWX1IO/INC
          INC       PATCRDIO/INC
          INC       PATCRGIO/INC
          INC       PATHSPIO/INC              * Hospital file
          INC       PATNIDIO/INC              * nmpi file
          INC       PATODCIO/INC              * Pat Oper/Dis changes file
          INC       PATUNAIO/INC              * Unadmit file
          INC       PATVADIO/INC
          INC       WATTR1IO/INC
          INC       IBASEQIO/INC
          INC       WEBERRIO/INC

.
................................................................................
