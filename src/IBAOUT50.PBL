.******************************************************************************
.* System         : Outpatient                                                *
.* Program        : IBAOUT50.PBL                                              *
.* Name           : WA Consolidated Outpatients Extract                       *
.******************************************************************************
.* Date           : 09/12/2011                                                *
.* Author         : Ebon Clements                                             *
.* Function       : Extract outpatient activity for a hospital and date range *
.*                  to a fixed length text file.                              *
.* Modifications  :                                                           *
.******************************************************************************
.* V11.02.01  09/02/2022  Thanh T       TSK 0905641                           *
.*            Recompiled as OUTMA1FD changes                                  *
.* V10.13.01  05/12/2018  Don Nguyen        TSK 0838558                       *
.*            Deleted temp file (EXTRFILE) on program exit.                   *
.*            Removed PORT from temp filename (FILENAME).                     *
.* V10.08.01  07/06/2016  Jill Parkinson TSK 0820003                          *
.*            Recompiled for PMSCEXCD - allow patmx1af/patma1af details       *
.* V10.06.01  21/09/2015  Davin             CAR 313906                        *
.*            Recompiled for PMSCEXCD - allow patmx1af/patma1af details       *
.* V10.05.01  17/07/2014 Ebon Clements      CAR 251384                        *
.*            Added tier 2 code functionality                                 *
.* V10.03.08  25/02/2013 Ania P             CAR 281021                        *
.*            Removed unnecessary modification of constants.                  *
.* V10.03.07  18/03/2012 Peter McMulleb     CAR 259587                        *
.*            Remove all references to redunadant file patyears               *
.* V10.03.06  18/01/2012 Ebon Clements      CAR 244332                        *
.*            Added from and to date to us1 script call                       *
.*            Added update of extract run dates to pmsweaaf                   *
.* V10.03.05  16/01/2012 Ebon Clements      CAR 244332                        *
.*            Removed all option from hospital filter                         *
.* V10.03.04  16/01/2012 Ebon Clements      CAR 244332                        *
.*            Updated lengths of care type and service delivery               *
.* V10.03.03  12/01/2012 Ebon Clements      CAR 244332                        *
.*            Fixed reporting of multiple cancelled/rescheduled appointments  *
.*            Added print of report header with selection criteria            *
.* V10.03.02  04/01/2012 Ebon Clements      CAR 244332                        *
.*            Fixed visit extn record in context after admission file read    *
.* V10.03.01  23/12/2011 Ebon Clements      CAR 244332                        *
.*            Changed field (91) NHCDC Clinic to use HDP                      *
.* V10.03.00  09/12/2011 Ebon Clements      CAR 244332                        *
.*            Created extract                                                 *
.******************************************************************************
.
          INC       STD001FD
.
          INC       ALLCONFD/INC
          INC       ALLLNKFD/INC
          INC       ALLREFFD/INC
          INC       IBACONFD/INC
          INC       OUTARTFD/INC
          INC       OUTBOAFD/INC
          INC       OUTBB1FD/INC
          INC       OUTCANFD/INC
          INC       OUTCLIFD/INC
          INC       OUTMA1FD/INC
          INC       OUTRSHFD/INC
          INC       OUTSITFD/INC
          INC       PATCODFD/INC
          INC       PATHSPFD/INC
          INC       PATMA1FD/INC
          INC       PATMI1FD/INC
          INC       PMSCEXFD/INC
          INC       PMSEXTFD/INC
          INC       PMSCCDFD/INC
          INC       PMSHCPFD/INC
          INC       PMSPX2FD/INC
          INC       PMSVX1FD/INC
          INC       PMSWAEFD/INC
          INC       WEBSECFD/INC
.
          INC       IBASEQFD/INC
          INC       TFILEVAR/INC
          INC       WEBERRFD/INC
.
. out50tXX.txt - Where xx is the port number
.
EXTRFILE  FILE      ASCII, FIXED=1334
.
.Name     Type    Length    Start  Description                    Field Number
.-------  ----    ------    -----  -----------                    ------------
XXXXHOSP  DIM     4         1      Establishment/Facility Code        (1)
XXXXURNO  DIM     8         5      U/R Number                         (2)
XXXXRVIS  DIM     8         13     Referral Visit Number              (3)
XXXXRDAT  DIM     8         21     Referral Date                      (4)
XXXXRUDT  DIM     8         29     Referral Update Date               (5)
XXXXRDEP  DIM     3         37     Referral Department Code           (6)
XXXXRSRC  DIM     3         40     Referral Source Code               (7)
XXXXRECD  DIM     8         43     Referral Received Date             (8)
XXXXRDDT  DIM     8         51     Referral Closed Date               (9)
XXXXPRIO  DIM     3         59     Referral Priority                  (10)
XXXXRREA  DIM     9         62     Referral Reason                    (11)
XXXXRHCP  DIM     35        71     Referring HCP Name                 (12)
XXXXRHPN  DIM     18        106    Referring HCP Phone                (13)
XXXXRHA1  DIM     35        124    Referring HCP Address 1            (14)
XXXXRHA2  DIM     30        159    Referring HCP Address 2            (15)
XXXXRHPC  DIM     4         189    Referring HCP Post Code            (16)
XXXXRSUB  DIM     50        193    Referral Suburb                    (17)
XXXXAUDT  DIM     8         243    Appointment Update Date            (18)
XXXXACTY  DIM     6         251    Appointmnet Clinic Type            (19)
XXXXAOUT  DIM     3         257    Appointmnet Outcome                (20)
XXXXAVTY  DIM     3         260    Appointment Visit Type             (21)
XXXXACLN  DIM     6         263    Appointment Clinic Code            (22)
XXXXACTL  DIM     30        269    Appoinment Clinic Title            (23)
XXXXAPDT  DIM     8         299    Appointment Date                   (24)
XXXXAPTM  DIM     5         307    Appointment Time                   (25)
XXXXASTA  DIM     2         312    Appointment Status                 (26)
XXXXARDT  DIM     8         314    Appointment Request Date           (27)
XXXXARPD  DIM     8         322    Appointment Request Preferred Date (28)
XXXXARVT  DIM     3         330    Appointment Request Visit Type     (29)
XXXXARRS  DIM     3         333    Appointment Request Reason         (30)
XXXXARUR  DIM     3         336    Appointment Request Urgency        (31)
XXXXDIAG  DIM     9         339    Diagnosis                          (32)
XXXXFNAM  DIM     40        348    Patient First Name                 (33)
XXXXSNAM  DIM     40        388    Patient Surname                    (34)
XXXXADD1  DIM     35        428    Patient Address 1                  (35)
XXXXADD2  DIM     35        463    Patient Address 2                  (36)
XXXXSUBR  DIM     50        498    Patient Suburb                     (37)
XXXXPOST  DIM     4         548    Patient Post Code                  (38)
XXXXTELH  DIM     20        552    Patient Home Phone                 (39)
XXXXTELA  DIM     20        572    Patient Alternate Phone            (40)
XXXXMAD1  DIM     35        592    Patient Mailing Address 1          (41)
XXXXMAD2  DIM     35        627    Patient Mailing Address 2          (42)
XXXXMSUB  DIM     50        662    Patient Mailing Suburb             (43)
XXXXMPOS  DIM     4         712    Patient Mailing Post Code          (44)
XXXXDDAT  DIM     8         716    Date of Death                      (45)
XXXXDTYP  DIM     3         724    Death Type                         (46)
XXXXBDAT  DIM     8         727    Date of Birth                      (47)
XXXXGEND  DIM     1         735    Gender                             (48)
XXXXNKGN  DIM     30        736    Next of Kin Given Name             (49)
XXXXNKSN  DIM     40        766    Next of Kin Surnam                 (50)
XXXXNKA1  DIM     35        806    Next of Kin Address 1              (51)
XXXXNKA2  DIM     35        841    Next of Kin Address 2              (52)
XXXXNKSU  DIM     50        876    Next of Kin Suburb                 (53)
XXXXNKPC  DIM     4         926    Next of Kin Post Code              (54)
XXXXNKHP  DIM     20        930    Next of Kin Home Phone             (55)
XXXXNKAP  DIM     20        950    Next of Kin Alternate Phone        (56)
XXXXAVIS  DIM     8         970    Appointment Visit Number           (57)
XXXXINDG  DIM     3         978    Indigenous Status                  (58)
XXXXCONT  DIM     4         981    Country of Birth                   (59)
XXXXMARI  DIM     1         985    Marital Status                     (60)
XXXXCLAM  DIM     3         986    Claim Code                         (61)
XXXXIPAT  DIM     1         989    Inpatient Indicator                (62)
XXXXSGNM  DIM     40        990    Patient Second Given Name          (63)
XXXXATIM  DIM     5         1030   Arrival Time                       (64)
XXXXSTIM  DIM     5         1035   Seen Time                          (65)
XXXXUTIM  DIM     13        1040   Appointment Update Date and Time   (66)
XXXXEDTM  DIM     16        1053   Extracted Date and Time            (67)
XXXXNKRL  DIM     10        1069   Next of Kin Relationship           (68)
XXXXNKTY  DIM     3         1079   Next of Kin Type                   (69)
XXXXEXTA  DIM     1         1082   Extended Appointment Indicator     (70)
XXXXEXGN  DIM     3         1083   Extended Appointment Group Number  (71)
XXXXDVAN  DIM     20        1086   DVA Number                         (72)
XXXXDVAC  DIM     3         1106   DVA Colour                         (73)
XXXXDVAA  DIM     20        1109   DVA Authorisation Number           (74)
XXXXDVAD  DIM     8         1129   DVA Authorisation Date             (75)
XXXXRAPT  DIM     50        1137   Reason For Appointment             (76)
XXXXCATD  DIM     20        1187   Category/Department Description    (77)
XXXXREVA  DIM     1         1207   Reversal Indicator Appointment     (78)
XXXXREVR  DIM     1         1208   Reversal Indicator Referral        (79)
XXXXSITE  DIM     6         1209   Outpatient Site Code               (80)
XXXXDATT  DIM     1         1215   Doctor Attended Flag               (81)
XXXXNMDS  DIM     10        1216   NMDS Clinic Type                   (82)
XXXXCANR  DIM     3         1226   Cancellation Reasonn               (83)
XXXXCAND  DIM     8         1229   Cancellation Date                  (84)
XXXXATDS  DIM     20        1237   Appointment Type Description       (85)
XXXXPRDS  DIM     20        1257   Priority Description               (86)
XXXXCLDS  DIM     30        1277   Clinic ID Description              (87)
XXXXRFDS  DIM     10        1307   Referral Source Description        (88)
XXXXCART  DIM     3         1317   Care Type Description              (89)
XXXXSERD  DIM     4         1320   Service Delivery                   (90)
XXXXNHCD  DIM     10        1324   NHCDC Clinic                       (91)
.
. End of Record             1334
.
. ----- Program Variables -----
.
ADMISSNO  DIM       8
ADHOCEXT  FORM      1
CFILEPRE  DIM       3
CMDLINE   DIM       127
CLAMCODE  DIM       3
CWEBDNAI  DIM       1
CWEBDNAM  DIM       2 
CLINCODE  DIM       6
CONTTYPE  DIM       1
DISPNAME  DIM       60
DOCFNAME  DIM       50
ENDDDATE  DIM       8
FILENAME  DIM       8
FMTGNAME  DIM       35
FMTTITLE  DIM       10
FMTSNAME  DIM       35
HOSPCODE  DIM       3
NAME35    DIM       35
REFNUMBR  DIM       8
PRTODATE  DIM       10
PRFRDATE  DIM       10
PRNTHOSP  DIM       50
SITECODE  DIM       6
STARTDAT  DIM       8
TOTALREC  FORM      8
URNUMBER  DIM       8
WEBUSRID  DIM       10
.
.
. ----- Constant Variables -----
.
CATTC     INIT      "tc"
CATCT     INIT      "ct"
CATSD     INIT      "sd"
DOWNCASE  INIT      "AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz"
FNAME     INIT      "out50t" 
.
PRGID     INIT      "IBAOUT50"
PRGNAM    INIT      "WA Consolidated Outpatient Extraction"
VERSION   INIT      "V12.01.00"
.
.******************************************************************************
.*                                   ML0000                                   *
.*                                 Main Module                                *
.****************************************************************************** 
.
ML0000    CALL      INIT0000                * Initialise variables & open files 
.
ML1000    CALL      OPTN0000                * Choose main option
          BRANCH    OPTION,ML2000
          BRANCH    EXIT,ML9999
.
ML2000    CALL      KADH0000                * Keyin Adhoc extraction     
          BRANCH    EXIT,ML1000
.
          CALL      KHOS0000                * Keyin hospital id  
          BRANCH    EXIT,ML1000
.
          CALL      KDAT0000                * Keyin the end date
          BRANCH    EXIT,ML1000
.
          CALL      KUSR0000                * Keyin web user id   
          BRANCH    EXIT,ML1000
.
          CALL      CONTQST                 * Ok to Continue (Y/N/C) ?
          BRANCH    CEXIT,ML4000,ML2000,ML1000
.
ML4000    CALL      CREX0000                * Create extract text file
.
          CALL      HEAD0000                * Print Report Header
.
          CALL      PROC0000                * Process extract
.
          CALL      EDAT0000                * Update extract run dates
.
          CALL      TOTL0000                * Print totals
.
          CALL      MVEX0000                * Move extract for web index
.
          GOTO      ML1000
.
ML9999    CLOSE     EXTRFILE,DELETE
          CHAIN     PGM
.
.******************************************************************************
.* Initialise Variable & Open Files                                           *
.******************************************************************************
INIT0000  CALL      DISPHEAD                * Display screen heading
.
          DISPLAY   *P64:24,"alllnkaf";
          OPEN      ALLLNKA2,"alllnkaf"
.
          DISPLAY   *P64:24,"allrefaf";
          OPEN      ALLREFA1,"allrefaf"
.
          DISPLAY   *P64:24,"pathspaf";
          OPEN      PATHSPA1,"pathspaf"
.
          DISPLAY   *P64:24,"patma1af";
          OPEN      PATMA1A1,"patma1af"
.
          DISPLAY   *P64:24,"patmx1af";
          OPEN      PATMX1A1,"patmx1af"
.
          DISPLAY   *P64:24,"patmi1af";
          OPEN      PATMI1A8,"patmi1af"
.
          DISPLAY   *P64:24,"pmsextaf";
          OPEN      PMSEXTA1,"pmsextaf"
.
          DISPLAY   *P64:24,"pmspx2af";
          OPEN      PMSPX2A1,"pmspx2af"
.
          DISPLAY   *P64:24,"patcodes";
          OPEN      PATCODE1,"patcodes"
.
          DISPLAY   *P64:24,"pmscexaf";
          OPEN      PMSCEXA1,"pmscexaf"
.
          DISPLAY   *P64:24,"pmsccdaf";
          OPEN      PMSCCDA1,"pmsccdaf"
.
          DISPLAY   *P64:24,"pmshcpaf";
          OPEN      PMSHCPA1,"pmshcpaf"
.
          DISPLAY   *P64:24,"pmsvx1af";
          OPEN      PMSVX1A1,"pmsvx1af"
.
          DISPLAY   *P64:24,"pmswaeaf";
          OPEN      PMSWAEA1,"pmswaeaf"
.
          DISPLAY   *P64:24,"websecaf";
          OPEN      WEBSECA1,"websecaf"
.
          DISPLAY   *P64:24,"outartaf";
          OPEN      OUTARTA1,"outartaf"
.
          DISPLAY   *P64:24,"outsitaf";
          OPEN      OUTSITA3,"outsitaf"
.
          DISPLAY   *P56:24,"Opening controlf"
          OPEN      CONTROLF,"controlf"
.
          READ      CONTROLF,HUND06;*27,ALCNRAUD
.
.         PACK      FILENAME,FNAME,PORT
.         REP       " 0",FILENAME
.
          CALL      TFILENAM
          MOVE      TFILNAME,FILENAME
.
          CALL      IBACLOCK
.
INIT9000  MOVE      ZERO,EXIT
.
INIT9999  RETURN
.
.*******************************************************************************
. Open Outpatient Files
.*******************************************************************************
OPNOUT00  PACK      CFNAME,CFILEPRE,FILBOKA1
          CLOSE     OUTBOKA1
          OPEN      OUTBOKA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILBOKA6
          CLOSE     OUTBOKA6
          OPEN      OUTBOKA6,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILBB1A1
          CLOSE     OUTBB1A1
          OPEN      OUTBB1A1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCANA1
          CLOSE     OUTCANA1
          OPEN      OUTCANA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCANA3
          CLOSE     OUTCANA3
          OPEN      OUTCANA3,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILCLIA1
          CLOSE     OUTCLIA1
          OPEN      OUTCLIA1,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILRSHA2
          CLOSE     OUTRSHA2
          OPEN      OUTRSHA2,CFNAME
.
          PACK      CFNAME,CFILEPRE,FILMA1A1
          CLOSE     OUTMA1A1
          OPEN      OUTMA1A1,CFNAME
.
OPNOUT99  RETURN
.
.******************************************************************************
.* Select Option                                                              *
.******************************************************************************
OPTN0000  MOVE      ZERO,EXIT
          MOVE      ZERO,OPTION
          DISPLAY   *P1:3,*EF:
                    *P1:4,*V2LON,"0",*HOFF," = Exit":
                    *P1:5,*V2LON,"1",*HOFF," = Run":
                    *P1:8,"Select Option : ";
OPTN1000  KEYIN     *P17:8,*V2LON,*DV,UNDLN2,*P17:8,OPTION;
.
          COMPARE   ZERO,OPTION
          GOTO      OPTN9500 IF EQUAL
.
          BRANCH    OPTION,OPTN9000
.
          BEEP
          GOTO      OPTN1000
.
OPTN9000  MOVE      ZERO,EXIT
          GOTO      OPTN9999
.
OPTN9500  MOVE      ONE,EXIT
OPTN9999  RETURN
.
.******************************************************************************
.* Input date range                                                           *
.******************************************************************************
KDAT0000  DISPLAY   *P1:14,*EL,"Start Date : ":
                    *P1:15,*EL,"End   Date : ";
.
          MOVE      "14",CVERT
          MOVE      "15",CCOL
          UNPACK    SP6,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          MOVE      ZERO,CHIGHLT
          MOVE      ZERO,CDEFDTE
          CALL      KEYDATE
          BRANCH    OVRCD,KDAT9500
          PACK      STARTDAT,CCENT,CYEAR,CMON,CDAY
          REP       " 0",STARTDAT
.
          MOVE      ZERO,EXIT
.
.         set up input requirements for KEYDATE
.
          MOVE      ZERO,CDEFDTE
          MOVE      ZERO,CHIGHLT
          MOVE      "15",CCOL
          MOVE      "15",CVERT
.
.         input ending date
.
KDAT1000  UNPACK    SP6,CYEAR,CMON,CDAY
          MOVE      CCC,CCENT
          CALL      KEYDATE
          BRANCH    OVRCD,KDAT9500
.
          PACK      ENDDDATE,CCENT,CYEAR,CMON,CDAY
          REP       " 0",ENDDDATE
.
          MOVE      ZERO,EXIT
.
          MATCH     ENDDDATE,STARTDAT
          GOTO      KDAT9999 IF EQUAL
          GOTO      KDAT9999 IF LESS
.
          UNPACK    STARTDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          DISPLAY   *P1:24,*EL,*B,*V2LON,"End Date must be greater than ":
                    "Start date ",CPCDATE,".  ";
          CALL      HITENTER
          GOTO      KDAT0000
.
KDAT9500  MOVE      ONE,EXIT
.
KDAT9999  RETURN
.
.******************************************************************************
.* Run the extract                                                            *
.******************************************************************************
PROC0000  MOVE      SP70,CFILEPRE           * Clear current file prefix
          MOVE      ZERO,TOTALREC
.
          PACK      KEY9,SP70
          CALL      RDSSITA3
PROC1000  CALL      RDKSITA3
          BRANCH    OVRCD,PROC9999
.
          MATCH     OSTFILE,CFILEPRE        * Same as Current File Prefix
          IF        !@EQUAL
            MOVE      OSTFILE,CFILEPRE      * Save Current File Prefix
            CALL      OPNOUT00              * Open Files
          ENDIF
.
          MOVE      OSTSITE,SITECODE        * Current site being processed
          MOVE      SP70,CLINCODE           * Current clinic being processed
.
          PACK      KEY18,SITECODE,SP70
          CALL      RDSMASA1
PROC4000  CALL      RDKMASA1                * Read clinic id of site code
          BRANCH    OVRCD,PROC1000
.
          MATCH     SITECODE,OMASITE
          GOTO      PROC1000 IF NOT EQUAL
.
          MOVE      OMACLIN,CLINCODE        * Current clinic being processed
.
          CALL      BOOK0000                     * Process bookings
          CALL      RESC0000                     * Process reschedules
          CALL      CANC0000                     * Process cancellations
.
          PACK      KEY18,SITECODE,CLINCODE,Z70  * Position at end of current
          CALL      RDSMASA1                     * clinic id ready to get next
.                                                * clinic id to precess
          GOTO      PROC4000
.
PROC9999  RETURN
.
.******************************************************************************
.* Process bookings for the site and clinic for the date range                *
.******************************************************************************
BOOK0000  PACK      KEY28,SITECODE,CLINCODE,STARTDAT,SP70
          CALL      RDSBOKA1
BOOK1000  CALL      RDKBOKA1
          BRANCH    OVRCD,BOOK9999
.
          MATCH     SITECODE,OBASITE         * Same site code
          GOTO      BOOK9999 IF NOT EQUAL
.
          MATCH     CLINCODE,OBACLIN         * Same site code
          GOTO      BOOK9999 IF NOT EQUAL
.
          MATCH     OBADATE,ENDDDATE         * After selected date range
          GOTO      BOOK9999 IF LESS
.
          PACK      KEY20,OBASITE,OBACLIN,OBADATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OBASITE,OBACLIN,OBADATE,Z70
            CALL      RDSCLIA1
            CALL      RDPCLIA1
            BRANCH    OVRCD,BOOK1000
.
            MATCH     OBASITE,OCASITE
            GOTO      BOOK1000 IF NOT EQUAL
.
            MATCH     OBACLIN,OCACLIN
            GOTO      BOOK1000 IF NOT EQUAL
          ENDIF
.
          UNPACK    OBADATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
.
          PACK      KEY18,OBASITE,OBACLIN,WEEKDAY,OBASTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,BOOK1000
.
          PACK      KEY3,OTMAHOSP,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            CALL      CLPATHSP
          ENDIF
.
          MATCH     SP70,HOSPCODE
          IF        !@EQUAL
            MATCH     HOSPCODE,OTMAHOSP     * Only process selected hospital
            GOTO      BOOK1000 IF NOT EQUAL
          ENDIF
.
          COMPARE   "1",OBASTAT             * Booked
          GOTO      BOOK2000 IF EQUAL
.
          COMPARE   "4",OBASTAT             * Attended
          GOTO      BOOK2000 IF EQUAL
.
          COMPARE   "5",OBASTAT             * Non attended
          GOTO      BOOK2000 IF EQUAL
.
          COMPARE   "6",OBASTAT             * Suspended
          GOTO      BOOK2000 IF EQUAL
.
          GOTO      BOOK1000
.
BOOK2000  PACK      KEY8,OBAOUTNO,SP70
          CALL      RDBOKB1
          BRANCH    OVRCD,BOOK1000
.
          CALL      CLRV0000                * Clear extract fields
.
          MOVE      OBAOUTNO,ADMISSNO       * OP visit being processed
          MOVE      OBAURNO,URNUMBER        * Set U/R number to read
.
          CALL      PMIF0000                * Set PMI & general fields
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,BOOK1000
.
          CALL      REQF0000                * Set appointment request fields
.
          CALL      OUTF0000                * Set OP booking fields
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,BOOK8000
.
          MATCH     ADMISSNO,ALLNLNKV       * same visit no?
          GOTO      BOOK8000 IF NOT EQUAL
.
          MOVE      ALLNVISN,REFNUMBR       * Set linked referral to read
          CALL      REFF0000                * Set referral fields
.
BOOK8000  CALL      WRIT0000                * Write to extract flat file
.
          GOTO      BOOK1000
.
BOOK9999 RETURN
.
.******************************************************************************
.* Process reschedules for the site and clinic for the date range             *
.******************************************************************************
RESC0000  PACK      KEY36,SITECODE,CLINCODE,STARTDAT,SP70
          CALL      RDSRSHA2
RESC1000  CALL      RDKRSHA2
          BRANCH    OVRCD,RESC9999
.
          MATCH     SITECODE,OPRSSITE        * Same site code
          GOTO      RESC9999 IF NOT EQUAL
.
          MATCH     CLINCODE,OPRSCLIN        * Same site code
          GOTO      RESC9999 IF NOT EQUAL
.
          MATCH     OPRSDATE,ENDDDATE        * After selected date range
          GOTO      RESC9999 IF LESS
.
          PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OPRSSITE,OPRSCLIN,OPRSDATE,Z70
            CALL      RDSCLIA1
            CALL      RDPCLIA1
            BRANCH    OVRCD,RESC1000
.
            MATCH     OPRSSITE,OCASITE
            GOTO      RESC1000 IF NOT EQUAL
.
            MATCH     OPRSCLIN,OCACLIN
            GOTO      RESC1000 IF NOT EQUAL
          ENDIF
.
          UNPACK    OPRSDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
.
          PACK      KEY18,OPRSSITE,OPRSCLIN,WEEKDAY,OPRSSTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,RESC1000
.
          PACK      KEY3,OTMAHOSP,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            CALL      CLPATHSP
          ENDIF

          MATCH     SP70,HOSPCODE
          IF        !@EQUAL
            MATCH     HOSPCODE,OTMAHOSP     * Only process selected hospital
            GOTO      RESC1000 IF NOT EQUAL
          ENDIF
.
          MOVE      DOPRSOUT,ADMISSNO       * OP visit being processed
.
          PACK      KEY36,ADMISSNO,SP70
          CALL      RDSBOKA6
          CALL      RDKBOKA6
          BRANCH    OVRCD,RESC2000
.
          MATCH     ADMISSNO,DOBAOUTN
          GOTO      RESC2000 IF NOT EQUAL
.
          MOVE      OBAURNO,URNUMBER        * Set U/R number to read
          GOTO      RESC4000
.
RESC2000  PACK      KEY8,ADMISSNO,SP70
          CALL      RDOTCAN1 
          BRANCH    OVRCD,RESC1000
.
          MOVE      OPCNURNO,URNUMBER        * Set U/R number to read
.
RESC4000  CALL      CLRV0000                * Clear extract fields
.
          CALL      PMIF0000                * Set PMI & general fields
.
          PACK      KEY8,ADMISSNO,SP70
          CALL      RDPMVX11
          BRANCH    OVRCD,RESC1000
.
          CALL      REQF0000                * Set appointment request fields
.
          CALL      RSHF0000                * Set rescheduled OP booking fields
.
          PACK      KEY16,ADMISSNO,SP70
          CALL      RSALLNK2
          CALL      RKALLNK2
          BRANCH    OVRCD,RESC8000
.
          MATCH     ADMISSNO,ALLNLNKV       * same visit no?
          GOTO      RESC8000 IF NOT EQUAL
.
          MOVE      ALLNVISN,REFNUMBR       * Set linked referral to read
          CALL      REFF0000                * Set referral fields
.
RESC8000  CALL      WRIT0000                * Write to extract flat file
.
          GOTO      RESC1000
.
RESC9999 RETURN
.
.******************************************************************************
.* Process cancellations for the site and clinic for the date range           *
.******************************************************************************
CANC0000  PACK      KEY33,SITECODE,CLINCODE,STARTDAT,SP70
          CALL      RSOTCAN3
CANC1000  CALL      RKOTCAN3
          BRANCH    OVRCD,CANC9999
.
          MATCH     SITECODE,OPCNSITE       * Same site code
          GOTO      CANC9999 IF NOT EQUAL
.
          MATCH     CLINCODE,OPCNCLIN       * Same site code
          GOTO      CANC9999 IF NOT EQUAL
.
          MATCH     OPCNDATE,ENDDDATE        * After selected date range
          GOTO      CANC9999 IF LESS
.
          PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,SP70
          CALL      RDCLIA1
          IF        OVRCD=1
            PACK      KEY20,OPCNSITE,OPCNCLIN,OPCNDATE,Z70
            CALL      RDSCLIA1
            CALL      RDPCLIA1
            BRANCH    OVRCD,CANC1000
.
            MATCH     OPCNSITE,OCASITE
            GOTO      CANC1000 IF NOT EQUAL
.
            MATCH     OPCNCLIN,OCACLIN
            GOTO      CANC1000 IF NOT EQUAL
          ENDIF
.
          UNPACK    OPCNDATE,CCENT,CYEAR,CMON,CDAY
          CALL      DAYOFWEK
.
          PACK      KEY18,OPCNSITE,OPCNCLIN,WEEKDAY,OPCNSTRT,SP70
          CALL      RDMASA1
          BRANCH    OVRCD,CANC1000
.
          PACK      KEY3,OTMAHOSP,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            CALL      CLPATHSP
          ENDIF

          MATCH     SP70,HOSPCODE
          IF        !@EQUAL
            MATCH     HOSPCODE,OTMAHOSP     * Only process selected hospital
            GOTO      CANC1000 IF NOT EQUAL
          ENDIF
.
          CALL      CLRV0000                * Clear extract fields
.
          MOVE      OPCNOUTN,ADMISSNO       * OP visit being processed
          MOVE      OPCNURNO,URNUMBER       * Set U/R number to read
.
          CALL      PMIF0000                * Set PMI & general fields
.
          CALL      REQF0000                * Set appointment request fields
.
          CALL      CANF0000                * Set cancelled OP booking fields
.
          MOVE      OPCNREFN,REFNUMBR       * Set linked referral to read
          CALL      REFF0000                * Set referral fields
.
          CALL      WRIT0000                * Write to extract flat file
          GOTO      CANC1000
.
CANC9999 RETURN
.
.******************************************************************************
. Create extract text file           
.******************************************************************************
CREX0000  CLOSE     EXTRFILE,DELETE
          PREP      EXTRFILE,FILENAME
.
CREX9999  RETURN
.
.******************************************************************************
. Move Extract to Web Directory
.******************************************************************************
MVEX0000  PACK      KEY3,HOSPCODE,SP70
          CALL      RDPTHSP1
          IF        OVRCD=1
            CALL      CLPATHSP
          ENDIF
.
          CLEAR     CMDLINE
          APPEND    "ibaout50.us1 '",CMDLINE
          APPEND    FILENAME,CMDLINE          * Report .txt file
.
          APPEND    "' '",CMDLINE
          APPEND    PTHSHOSP,CMDLINE          * Hospital Id
.
          APPEND    "' '",CMDLINE
.
          MATCH     SP70,PTHSHSID
          IF        @EQUAL
            PACK      KEY4,PTHSHOSP,SP70        
          ELSE
            MOVE      PTHSHSID,KEY4           * Health service identifier
          ENDIF
          APPEND    KEY4,CMDLINE
.
          APPEND    "' '",CMDLINE
          APPEND    PRFRDATE,CMDLINE          * From Date
.
          APPEND    "' '",CMDLINE
          APPEND    PRTODATE,CMDLINE          * To Date
.
          APPEND    "' '",CMDLINE
          APPEND    WEBUSRID,CMDLINE          * User Id
.
          APPEND    "'",CMDLINE
.
          RESET     CMDLINE
.
          EXECUTE   CMDLINE,TASKID
.
MVEX9999  RETURN
.
.******************************************************************************
.* Clear the extract variables                                                *
.******************************************************************************
CLRV0000  MOVE      SP70,XXXXHOSP
          MOVE      SP70,XXXXURNO
          MOVE      SP70,XXXXRVIS
          MOVE      SP70,XXXXRDAT
          MOVE      SP70,XXXXRUDT
          MOVE      SP70,XXXXRDEP
          MOVE      SP70,XXXXRSRC
          MOVE      SP70,XXXXRECD
          MOVE      SP70,XXXXRDDT
          MOVE      SP70,XXXXPRIO
          MOVE      SP70,XXXXRREA
          MOVE      SP70,XXXXRHCP
          MOVE      SP70,XXXXRHPN
          MOVE      SP70,XXXXRHA1
          MOVE      SP70,XXXXRHA2
          MOVE      SP70,XXXXAUDT
          MOVE      SP70,XXXXACTY
          MOVE      SP70,XXXXAOUT
          MOVE      SP70,XXXXAVTY
          MOVE      SP70,XXXXACLN
          MOVE      SP70,XXXXACTL
          MOVE      SP70,XXXXAPDT
          MOVE      SP70,XXXXAPTM
          MOVE      SP70,XXXXASTA
          MOVE      SP70,XXXXARDT
          MOVE      SP70,XXXXARPD
          MOVE      SP70,XXXXARVT
          MOVE      SP70,XXXXARRS
          MOVE      SP70,XXXXARUR
          MOVE      SP70,XXXXDIAG
          MOVE      SP70,XXXXFNAM
          MOVE      SP70,XXXXSNAM
          MOVE      SP70,XXXXADD1
          MOVE      SP70,XXXXADD2
          MOVE      SP70,XXXXSUBR
          MOVE      SP70,XXXXPOST
          MOVE      SP70,XXXXTELH
          MOVE      SP70,XXXXTELA
          MOVE      SP70,XXXXMAD1
          MOVE      SP70,XXXXMAD2
          MOVE      SP70,XXXXMSUB
          MOVE      SP70,XXXXMPOS
          MOVE      SP70,XXXXDDAT
          MOVE      SP70,XXXXDTYP
          MOVE      SP70,XXXXBDAT
          MOVE      SP70,XXXXGEND
          MOVE      SP70,XXXXNKGN
          MOVE      SP70,XXXXNKSN
          MOVE      SP70,XXXXNKA1
          MOVE      SP70,XXXXNKA2
          MOVE      SP70,XXXXNKSU
          MOVE      SP70,XXXXNKPC
          MOVE      SP70,XXXXNKHP
          MOVE      SP70,XXXXNKAP
          MOVE      SP70,XXXXAVIS
          MOVE      SP70,XXXXINDG
          MOVE      SP70,XXXXCONT
          MOVE      SP70,XXXXMARI
          MOVE      SP70,XXXXCLAM
          MOVE      SP70,XXXXIPAT
          MOVE      SP70,XXXXSGNM
          MOVE      SP70,XXXXATIM
          MOVE      SP70,XXXXSTIM
          MOVE      SP70,XXXXUTIM
          MOVE      SP70,XXXXEDTM
          MOVE      SP70,XXXXNKRL
          MOVE      SP70,XXXXNKTY
          MOVE      SP70,XXXXEXTA
          MOVE      SP70,XXXXEXGN
          MOVE      SP70,XXXXDVAN
          MOVE      SP70,XXXXDVAC
          MOVE      SP70,XXXXDVAA
          MOVE      SP70,XXXXDVAD
          MOVE      SP70,XXXXRAPT
          MOVE      SP70,XXXXCATD
          MOVE      SP70,XXXXREVA
          MOVE      SP70,XXXXREVR
          MOVE      SP70,XXXXSITE
          MOVE      SP70,XXXXDATT
          MOVE      SP70,XXXXNMDS
          MOVE      SP70,XXXXCANR
          MOVE      SP70,XXXXCAND
          MOVE      SP70,XXXXATDS
          MOVE      SP70,XXXXPRDS
          MOVE      SP70,XXXXCLDS
          MOVE      SP70,XXXXRFDS
          MOVE      SP70,XXXXCART
          MOVE      SP70,XXXXSERD
          MOVE      SP70,XXXXNHCD
.
CLRV9999  RETURN
.
.******************************************************************************
.*                                  KHOS0000                                  *
.*                      Keyin hospital ID                                     *
.******************************************************************************
KHOS0000  MOVE       ZERO,EXIT
.
          MOVE       SP70,HOSPCODE
          MOVE       SP70,PTHSHOSP
          DISPLAY    *P1:12,*EL,"Hospital Id : ";
          MOVE       TEN5,ECOL
          MOVE       TEN2,EVERT
          MOVE       SP3,CKYIDEF3
          MOVE       ZERO,CKYIMAND           * Mandatory
          OPEN       PATHSPA1,"pathspaf"
.
          CALL       PATHSPKY
          BRANCH     EXIT,KHOS9000,KHOS9000
.
          PACK       HOSPCODE,KEY3,SP70          * Hospital Code
          PACK       PRNTHOSP,PTHSNAME,SP70
.
KHOS3000  DISPLAY   *P20:12,*V2LON,PTHSNAME;
          MOVE       ZERO,EXIT
          GOTO       KHOS9999
.
KHOS9000  MOVE       ONE,EXIT
KHOS9999  RETURN
.
.******************************************************************************
.*  Set PMI based extract fields                                              *
.******************************************************************************
PMIF0000  PACK      KEY8,URNUMBER,SP70
          CALL      RDMAST1
          BRANCH    OVRCD,PMIF9999
.
          PACK      KEY8,PURNO,SP70
          CALL      RDPMPX21
          BRANCH    OVRCD,PMIF9999
.
          PACK      XXXXFNAM,PMPXFNAM,SP70                          * (33)
          PACK      XXXXSNAM,PSNAME,SP70                            * (34)
.
          PACK      XXXXADD1,PADD1,SP70                             * (35)
          PACK      XXXXADD2,PADD2,SP70                             * (36)
          STRIP     PSUBRB
          PACK      XXXXSUBR,PSUBRB,SP1,PADD4,SP70                  * (37)
          RESET     PSUBRB
          PACK      XXXXPOST,PPOST,SP70                             * (38)
.
          PACK      XXXXTELH,PTELEP,SP70                            * (39)
          MATCH     SP70,PTMXCELL
          IF        !@EQUAL
            PACK      XXXXTELA,PTMXCELL,SP70                        * (40)
          ELSE
            PACK      XXXXTELA,PTELEB,SP70                          * (40)
          ENDIF
.
          MOVE      "2",CONTTYPE
          CALL      XCON0000                     * Get postal address       
          PACK      XXXXMAD1,PMCEADD1,SP70                          * (41)
          PACK      XXXXMAD2,PMCEADD2,SP70                          * (42)
          STRIP     PMCEADD3
          PACK      XXXXMSUB,PMCEADD3,SP1,PMCEADD4,SP70             * (43)
          RESET     PMCEADD3
          PACK      XXXXMPOS,PMCEPOST,SP70                          * (44)
.
          UNPACK    PDECDTE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXDDAT,XDAY,XMON,XCENT,XYEAR,SP70             * (45)
          PACK      XXXXDTYP,PMPXDETY,SP70                          * (46)
.
          UNPACK    PBDATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXBDAT,XDAY,XMON,XCENT,XYEAR,SP70             * (47)
.
          MATCH     ANSR,PSEX
          IF        @EQUAL
            PACK      XXXXGEND,ANSU,SP70                            * (48)
          ELSE
            PACK      XXXXGEND,PSEX,SP70                            * (48)
          ENDIF
.
          MOVE      "1",CONTTYPE
          CALL      XCON0000                     * Get NOK details
.
          STRIP     PMCEGNAM
          STRIP     PMCEGNM2
          PACK      XXXXNKGN,PMCEGNAM,SP1,PMCEGNM2,SP70             * (49)
          RESET     PMCEGNAM
          RESET     PMCEGNM2
          PACK      XXXXNKSN,PMCESNAM,SP70                          * (50)
.
          PACK      XXXXNKA1,PMCEADD1,SP70                          * (51)
          PACK      XXXXNKA2,PMCEADD2,SP70                          * (52)
          STRIP     PMCEADD3
          PACK      XXXXNKSU,PMCEADD3,SP1,PMCEADD4,SP70             * (53)
          RESET     PMCEADD3
          PACK      XXXXNKPC,PMCEPOST,SP70                          * (54)
          PACK      XXXXNKHP,PMCETELP,SP70                          * (55)
          MATCH     SP70,PMCETELM
          IF        !@EQUAL
            PACK      XXXXNKAP,PMCETELM,SP70                        * (56)
          ELSE
            PACK      XXXXNKAP,PMCETELP,SP70                        * (56)
          ENDIF
          PACK      XXXXNKRL,PMCERELP,SP70                          * (68)
          PACK      XXXXNKTY,PMCETYPE,SP70                          * (69)
.
          MATCH     SP70,PCONT
          IF        !@EQUAL
            PACK      KEY5,ANSC,SP1,PCONT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXXXCONT,THCSCOD,SP70                       * (59)
            ENDIF
          ENDIF
.
          MATCH     SP70,PMSTAT
          IF        !@EQUAL
            PACK      KEY5,ANSM,SP1,PMSTAT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              UNPACK    THCSCOD,KEY1,KEY3
              PACK      XXXXMARI,KEY1,SP70                          * (60)
            ENDIF
          ENDIF
.
          PACK      XXXXIPAT,ANSN,SP70                              * (62)
          PACK      KEY17,PURNO,TWO,SP70
          CALL      RSPTMI18
          CALL      RKPTMI18                       
          BRANCH    OVRCD,PMIF2000
.
          MATCH     PURNO,AURNO
          GOTO      PMIF2000 IF NOT EQUAL
.
          COMPARE   TWO,ASTAT
          GOTO      PMIF2000 IF NOT EQUAL
.
          PACK      XXXXIPAT,ANSY,SP70                              * (62)
.
PMIF2000  PACK      XXXXSGNM,PMPXSNAM,SP70                          * (63)
.
          CALL      IBACLOCK
          PACK      KEY8,CDD,CMM,CCC,CYY
          REP       " 0",KEY8
          PACK      XXXXEDTM,KEY8,CTIMEIS                           * (67)
.
PMIF9999  RETURN
.
.******************************************************************************
.*  Set referral based extract fields                                         *
.******************************************************************************
REFF0000  PACK      KEY8,REFNUMBR,SP70
          CALL      RDALREF1
          BRANCH    OVRCD,REFF9999
.
          PACK      XXXXRVIS,ALREVISN,SP70                          * (3)
.
          UNPACK    ALRERDAT,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXRDAT,XDAY,XMON,XCENT,XYEAR,SP70             * (4)
.
          UNPACK    ALREUDAT,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXRUDT,XDAY,XMON,XCENT,XYEAR,SP70             * (5)
.
          PACK      XXXXRDEP,ALREDEPT,SP70                          * (6)
          PACK      XXXXRSRC,ALRESRCE,SP70                          * (7)
.
          UNPACK    ALREDREC,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXRECD,XDAY,XMON,XCENT,XYEAR,SP70             * (8)
.
          UNPACK    ALREDCLO,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXRDDT,XDAY,XMON,XCENT,XYEAR,SP70             * (9)
.
          PACK      XXXXPRIO,ALREPRTY,SP70                          * (10)
          PACK      XXXXRREA,ALREPRO1,SP70                          * (11)
.
          MATCH     SP70,ALRERHCP
          GOTO      REFF2000 IF EQUAL
.
          PACK      KEY10,ALRERHCP,SP70
          CALL      RDPMHCP1
          BRANCH    OVRCD,REFF2000
.
          MOVE      PMHCTITL,FMTTITLE
          MOVE      PMHCGNAM,FMTGNAME
          MOVE      PMHCSNAM,FMTSNAME
          CALL      DOCNM000
          PACK      XXXXRHCP,DOCFNAME,SP70                          * (12)
          PACK      XXXXRHPN,PMHCSTEL,SP70                          * (13)
          PACK      XXXXRHA1,PMHCADR1,SP70                          * (14)
          PACK      XXXXRHA2,PMHCADR2,SP70                          * (15)
          PACK      XXXXRHPC,PMHCPOST,SP70                          * (16)
          PACK      XXXXRSUB,PMHCADR3,SP70                          * (17)
.
REFF2000  PACK      XXXXDIAG,ALREDIA1,SP70                          * (32)
.
          MATCH     SP70,ALREDEPT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSG,ALREDEPT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXXXCATD,TDESC,SP70                         * (77)
            ENDIF
          ENDIF
.
          MATCH     SP70,ALREPRTY
          IF        !@EQUAL
            PACK      KEY5,ANSP,ANSR,ALREPRTY,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXXXPRDS,TDESC,SP70                         * (86)
            ENDIF
          ENDIF
.
          PACK      KEY5,OSTCATG,ALRESRCE,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      XXXXRFDS,TDESC,SP70                           * (88)
          ENDIF
.
REFF9999  RETURN
.
.******************************************************************************
.*  Set appointment request extract fields                                    *
.******************************************************************************
REQF0000  PACK      KEY32,URNUMBER,SP70
          CALL      RSOTART1
REQF1000  CALL      RKOTART1
          BRANCH    OVRCD,REQF9999
.
          MATCH     URNUMBER,OTARURNO
          GOTO      REQF9999 IF NOT EQUAL
.
          MATCH     ADMISSNO,OTARBKNO
          GOTO      REQF1000 IF NOT EQUAL
.
          UNPACK    OTARRQDT,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXARDT,XDAY,XMON,XCENT,XYEAR,SP70             * (27)
.
          UNPACK    OTARPRDT,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXARPD,XDAY,XMON,XCENT,XYEAR,SP70             * (28)
.
          PACK      XXXXARVT,OTARVIST,SP70                          * (29)
.
          PACK      XXXXARRS,OTARRREQ,SP70                          * (30)
          PACK      XXXXARUR,OTARPRIO,SP70                          * (31)
.
REQF9999  RETURN
.
.******************************************************************************
.*  Set OP booking fields                                                     *
.******************************************************************************
OUTF0000  MOVE      PTHSHSID,KEY4
          PACK      XXXXHOSP,KEY4,SP70                               * (1)
.
          PACK      XXXXURNO,OBAURNO,SP70                            * (2)
.
          UNPACK    OBADATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXAUDT,XDAY,XMON,XCENT,XYEAR,SP70              * (18)
          PACK      XXXXACTY,OBACTYP,SP70                            * (19)
          PACK      XXXXAOUT,OTBBOUTC,SP70                           * (20)
          PACK      XXXXAVTY,OBAVISIT,SP70                           * (21)
          PACK      XXXXACLN,OBACLIN,SP70                            * (22)
.
          PACK      XXXXACTL,OCADESC,SP70                            * (23)
.
          UNPACK    OBADATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXAPDT,XDAY,XMON,XCENT,XYEAR,SP70              * (24)
          PACK      XXXXAPTM,OBATIME,SP70                            * (25)
.
          IF        OBASTAT=4
            PACK      XXXXASTA,ANSP,ANSR,SP70                        * (26)
            MATCH     SP70,OTBBOUTC
            IF        @EQUAL
              PACK      XXXXASTA,ANSP,ANSP,SP70                      * (26)
            ENDIF
          ENDIF
.
          IF        OBASTAT=5
            PACK      XXXXASTA,ANSU,ANSN,SP70                        * (26)
          ENDIF
.
          IF        OBASTAT=1 | OBASTAT=6
            PACK      XXXXASTA,ANSF,ANSU,SP70                        * (26)
          ENDIF
.
          PACK      XXXXAVIS,OBAOUTNO,SP70                           * (57)
          PACK      XXXXINDG,PMVXABRG,SP70                           * (58)
          PACK      XXXXCLAM,OBACOMP,SP70                            * (61)
          PACK      XXXXATIM,OTBBCITM,SP70                           * (64)
          PACK      XXXXSTIM,OTBBASTM,SP70                           * (65)
.
          UNPACK    OBADATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXUTIM,XDAY,XMON,XCENT,XYEAR,OBATIME,SP70      * (66)
          MATCH     SP70,OTBBDPTM
          IF        !@EQUAL
            PACK      XXXXUTIM,XDAY,XMON,XCENT,XYEAR,OTBBDPTM,SP70   * (66)
          ELSE
            MATCH     SP70,OTBBASTM
            IF        !@EQUAL
              PACK      XXXXUTIM,XDAY,XMON,XCENT,XYEAR,OTBBASTM,SP70     * (66)
            ELSE
              MATCH     SP70,OTBBCITM
              IF        !@EQUAL
                PACK      XXXXUTIM,XDAY,XMON,XCENT,XYEAR,OTBBCITM,SP70   * (66)
              ENDIF
            ENDIF
          ENDIF
.
          PACK      XXXXEXTA,ANSN,SP70                               * (70)
          MATCH     SP70,OBAVISIT
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              IF        TCFORM6>1
                PACK      XXXXEXTA,ANSY,SP70                         * (70)
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,OBACOMP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,OUTF3000
.
          MATCH     ANSV,TCINDC1                 * DVA claim code
          GOTO      OUTF3000 IF NOT EQUAL
.
          MOVE      "3",DIM1
          CALL      GCRD0000                     * Get DVA details
.
          PACK      XXXXDVAN,PMCDCNUM,SP70                           * (72)
          PACK      XXXXDVAC,PMCDDVAC,SP70                           * (73)
.
          PACK      KEY11,OBAOUTNO,OBACOMP,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,OUTF3000
.
          PACK      XXXXDVAA,PMEXAUTH,SP70        Number             * (74)
          UNPACK    PMEXAUDA,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXDVAD,XDAY,XMON,XCENT,XYEAR,SP70              * (75)
.
OUTF3000  PACK      XXXXSITE,OBASITE,SP70                            * (80)
.
          MATCH     "5",OCADOCT
          IF        @EQUAL
            PACK      XXXXDATT,ANSY,SP70                             * (81)
          ELSE
            PACK      XXXXDATT,ANSN,SP70                             * (81)
          ENDIF
.
          MATCH     SP70,OTBBNMDS
          IF        !@EQUAL
            PACK      KEY5,ANSN,ANSM,OTBBNMDS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              SQUEEZE   THCSCOD
              PACK      XXXXNMDS,THCSCOD,SP70                        * (82)
              RESET     THCSCOD
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSC,ANSV,OBAVISIT,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      XXXXATDS,TDESC,SP70                            * (85)
          ENDIF
.
          PACK      XXXXCLDS,OCADESC,SP70                            * (87)
.
          MATCH     SP70,OTBBCART
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSC,OTBBCART,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXXXCART,TCINDC14,SP70                       * (89)
            ENDIF
          ENDIF
.
          MATCH     SP70,OTBBSRVD
          IF        !@EQUAL
            PACK      KEY5,CATSD,OTBBSRVD,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      THCSCOD,KEY2
              PACK      XXXXSERD,KEY2,SP70                           * (90)
            ENDIF
          ENDIF
.
          MATCH     SP70,OTBBTCOD
          IF        !@EQUAL
            PACK      KEY5,ANSN,ANSC,OTBBTCOD,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      THCSCOD,KEY4
              PACK      XXXXNHCD,KEY4,SP70                           * (91)
            ENDIF
          ENDIF
.
OUTF9999  RETURN
.
.******************************************************************************
.*  Set cancelled OP booking fields                                           *
.******************************************************************************
CANF0000  MOVE      PTHSHSID,KEY4
          PACK      XXXXHOSP,KEY4,SP70                               * (1)
.
          PACK      XXXXURNO,OPCNURNO,SP70                           * (2)
.
          UNPACK    OPCNRDTE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXAUDT,XDAY,XMON,XCENT,XYEAR,SP70              * (18)
          PACK      XXXXACTY,OPCNCTYP,SP70                           * (19)
          PACK      XXXXAVTY,OPCNVTYP,SP70                           * (21)
          PACK      XXXXACLN,OPCNCLIN,SP70                           * (22)
.
          PACK      XXXXACTL,OCADESC,SP70                            * (23)
.
          UNPACK    OPCNDATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXAPDT,XDAY,XMON,XCENT,XYEAR,SP70              * (24)
          PACK      XXXXAPTM,OPCNTIME,SP70                           * (25)
          PACK      XXXXASTA,ANSC,ANSA,SP70                          * (26)
          PACK      XXXXAVIS,OPCNOUTN,SP70                           * (57)
.
          PACK      XXXXCLAM,OPCNCOMP,SP70                           * (61)
.
          UNPACK    OPCNRDTE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXUTIM,XDAY,XMON,XCENT,XYEAR,OPCNRTIM,SP70     * (66)
.
          PACK      XXXXEXTA,ANSN,SP70                               * (70)
          MATCH     SP70,OPCNVTYP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OPCNVTYP,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              IF        TCFORM6>1
                PACK      XXXXEXTA,ANSY,SP70                         * (70)
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,OPCNCOMP,SP70
          CALL      RDCODE1 
          BRANCH    OVRCD,CANF3000
.
          MATCH     ANSV,TCINDC1                 * DVA claim code
          GOTO      CANF3000 IF NOT EQUAL
.
          MOVE      "3",DIM1            
          CALL      GCRD0000                     * Get DVA details
.
          PACK      XXXXDVAN,PMCDCNUM,SP70                           * (72)
          PACK      XXXXDVAC,PMCDDVAC,SP70                           * (73)
.
          PACK      KEY11,OPCNOUTN,OPCNCOMP,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,CANF3000
.
          PACK      XXXXDVAA,PMEXAUTH,SP70        Number             * (74)
          UNPACK    PMEXAUDA,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXDVAD,XDAY,XMON,XCENT,XYEAR,SP70              * (75)
.
CANF3000  PACK      XXXXSITE,OPCNSITE,SP70                           * (80)
.
          MATCH     "5",OCADOCT
          IF        @EQUAL
            PACK      XXXXDATT,ANSY,SP70                             * (81)
          ELSE
            PACK      XXXXDATT,ANSN,SP70                             * (81)
          ENDIF
.
          MATCH     SP70,OPCNNMDS
          IF        !@EQUAL
            PACK      KEY5,ANSN,ANSM,OPCNNMDS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              SQUEEZE   THCSCOD
              PACK      XXXXNMDS,THCSCOD,SP70                        * (82)
              RESET     THCSCOD
            ENDIF
          ENDIF
.
          PACK      XXXXCANR,OPCNREAS,SP70                           * (83)
          UNPACK    OPCNRDTE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXCAND,XDAY,XMON,XCENT,XYEAR,SP70              * (84)
.
          PACK      KEY5,ANSC,ANSV,OPCNVTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      XXXXATDS,TDESC,SP70                            * (85)
          ENDIF
.
          PACK      XXXXCLDS,OCADESC,SP70                            * (87)
.
          MATCH     SP70,OPCNCART
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSC,OPCNCART,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXXXCART,TCINDC14,SP70                       * (89)
            ENDIF
          ENDIF
.
          MATCH     SP70,OPCNSRVC
          IF        !@EQUAL
            PACK      KEY5,CATSD,OPCNSRVC,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      THCSCOD,KEY2
              PACK      XXXXSERD,KEY2,SP70                           * (90)
            ENDIF
          ENDIF
.
          MATCH     SP70,OPCNTCOD
          IF        !@EQUAL
            PACK      KEY5,ANSN,ANSC,OPCNTCOD,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      THCSCOD,KEY4
              PACK      XXXXNHCD,KEY4,SP70                           * (91)
            ENDIF
          ENDIF
.
CANF9999  RETURN
.
.******************************************************************************
.*  Set rescheduled OP booking fields                                         *
.******************************************************************************
RSHF0000  MOVE      PTHSHSID,KEY4
          PACK      XXXXHOSP,KEY4,SP70                               * (1)
.
          PACK      XXXXURNO,OBAURNO,SP70                            * (2)
.
          UNPACK    OPRSRDTE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXAUDT,XDAY,XMON,XCENT,XYEAR,SP70              * (18)
.
          PACK      XXXXACTY,OPRSCLTY,SP70                           * (19)
          PACK      XXXXAVTY,OPRSVTYP,SP70                           * (21)
          PACK      XXXXACLN,OPRSCLIN,SP70                           * (22)
.
          PACK      XXXXACTL,OCADESC,SP70                            * (23)
.
          UNPACK    OPRSDATE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXAPDT,XDAY,XMON,XCENT,XYEAR,SP70              * (24)
          PACK      XXXXAPTM,OPRSTIME,SP70                           * (25)
.
          PACK      XXXXASTA,ANSR,ANSS,SP70                          * (26)
.
          PACK      XXXXAVIS,OPRSOUTN,SP70                           * (57)
          PACK      XXXXINDG,PMVXABRG,SP70                           * (58)
.
          PACK      XXXXCLAM,OPRSCOMP,SP70                           * (61)
.
          UNPACK    OPRSRDTE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXUTIM,XDAY,XMON,XCENT,XYEAR,OPRSRTIM,SP70     * (66)
.
          PACK      XXXXEXTA,ANSN,SP70                               * (70)
          MATCH     SP70,OPRSVTYP
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSV,OPRSVTYP,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              IF        TCFORM6>1
                PACK      XXXXEXTA,ANSY,SP70                         * (70)
              ENDIF
            ENDIF
          ENDIF
.
          PACK      KEY5,ANSC,ANSL,OPRSCOMP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,RSHF3000
.
          MATCH     ANSV,TCINDC1                 * DVA claim code
          GOTO      RSHF3000 IF NOT EQUAL
.
          MOVE      "3",DIM1
          CALL      GCRD0000                     * Get DVA details
.
          PACK      XXXXDVAN,PMCDCNUM,SP70                           * (72)
          PACK      XXXXDVAC,PMCDDVAC,SP70                           * (73)
.
          PACK      KEY11,OPRSOUTN,OPRSCOMP,SP70
          CALL      RDPMEXT1
          BRANCH    OVRCD,RSHF3000
.
          PACK      XXXXDVAA,PMEXAUTH,SP70        Number             * (74)
          UNPACK    PMEXAUDA,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXDVAD,XDAY,XMON,XCENT,XYEAR,SP70              * (75)
.
RSHF3000  PACK      XXXXSITE,OPRSSITE,SP70                           * (80)
.
          MATCH     "5",OCADOCT
          IF        @EQUAL
            PACK      XXXXDATT,ANSY,SP70                             * (81)
          ELSE
            PACK      XXXXDATT,ANSN,SP70                             * (81)
          ENDIF
.
          MATCH     SP70,OPRSNMDS
          IF        !@EQUAL
            PACK      KEY5,ANSN,ANSM,OPRSNMDS,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              SQUEEZE   THCSCOD
              PACK      XXXXNMDS,THCSCOD,SP70                        * (82)
              RESET     THCSCOD
            ENDIF
          ENDIF
.
          PACK      XXXXCANR,OPRSREAS,SP70                           * (83)
          UNPACK    OPRSRDTE,XCENT,XYEAR,XMON,XDAY
          PACK      XXXXCAND,XDAY,XMON,XCENT,XYEAR,SP70              * (84)
.
          PACK      KEY5,ANSC,ANSV,OPRSVTYP,SP70
          CALL      RDCODE1
          IF        OVRCD<>1
            PACK      XXXXATDS,TDESC,SP70                            * (85)
          ENDIF
.
          PACK      XXXXCLDS,OCADESC,SP70                            * (87)
.
          MATCH     SP70,OPRSCARE
          IF        !@EQUAL
            PACK      KEY5,ANSC,ANSC,OPRSCARE,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              PACK      XXXXCART,TCINDC14,SP70                       * (89)
            ENDIF
          ENDIF
.
          MATCH     SP70,OPRSSRVD
          IF        !@EQUAL
            PACK      KEY5,CATSD,OPRSSRVD,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      THCSCOD,KEY2
              PACK      XXXXSERD,KEY2,SP70                           * (90)
            ENDIF
          ENDIF
.
          MATCH     SP70,OPRSTCOD
          IF        !@EQUAL
            PACK      KEY5,ANSN,ANSC,OPRSTCOD,SP70
            CALL      RDCODE1
            IF        OVRCD<>1
              MOVE      THCSCOD,KEY4
              PACK      XXXXNHCD,KEY4,SP70                           * (91)
            ENDIF
          ENDIF
.
RSHF9999  RETURN
.
.--------------------------------------------------------------------
. Get concession card details
. DIM1 = 1 - Concession Card
.        2 - Safety Net Card
.        3 - DVA Card
.        4 - Pension Card
.--------------------------------------------------------------------
GCRD0000  PACK      KEY19,URNUMBER,SP70
          CALL      RSPMCCD1
GCRD1000  CALL      RKPMCCD1
          BRANCH    OVRCD,GCRD8000
.
          MATCH     URNUMBER,PMCDURNO
          GOTO      GCRD8000 IF NOT EQUAL
.
          PACK      KEY5,CATCT,PMCDCTYP,SP70
          CALL      RDCODE1
          BRANCH    OVRCD,GCRD1000
.
          MATCH     DIM1,TCINDC1
          GOTO      GCRD9999 IF EQUAL
.
          GOTO      GCRD1000
.
GCRD8000  MOVE      SP70,PMCDCNUM
          MOVE      SP70,PMCDCTYP
          MOVE      SP70,PMCDEXDT
          MOVE      SP70,PMCDDVAC
          GOTO      GCRD9999
.
GCRD9999  RETURN
.
.******************************************************************************
.* Write the extract variables                                                *
.******************************************************************************
WRIT0000  WRITE     EXTRFILE,SEQ;XXXXHOSP,XXXXURNO,XXXXRVIS,XXXXRDAT,XXXXRUDT:
                         XXXXRDEP,XXXXRSRC,XXXXRECD,XXXXRDDT,XXXXPRIO:    * 10
                         XXXXRREA,XXXXRHCP,XXXXRHPN,XXXXRHA1,XXXXRHA2:
                         XXXXRHPC,XXXXRSUB,XXXXAUDT,XXXXACTY,XXXXAOUT:    * 20
                         XXXXAVTY,XXXXACLN,XXXXACTL,XXXXAPDT,XXXXAPTM:
                         XXXXASTA,XXXXARDT,XXXXARPD,XXXXARVT,XXXXARRS:    * 30
                         XXXXARUR,XXXXDIAG,XXXXFNAM,XXXXSNAM,XXXXADD1:   
                         XXXXADD2,XXXXSUBR,XXXXPOST,XXXXTELH,XXXXTELA:    * 40
                         XXXXMAD1,XXXXMAD2,XXXXMSUB,XXXXMPOS,XXXXDDAT:
                         XXXXDTYP,XXXXBDAT,XXXXGEND,XXXXNKGN,XXXXNKSN:    * 50
                         XXXXNKA1,XXXXNKA2,XXXXNKSU,XXXXNKPC,XXXXNKHP:
                         XXXXNKAP,XXXXAVIS,XXXXINDG,XXXXCONT,XXXXMARI:    * 60
                         XXXXCLAM,XXXXIPAT,XXXXSGNM,XXXXATIM,XXXXSTIM:
                         XXXXUTIM,XXXXEDTM,XXXXNKRL,XXXXNKTY,XXXXEXTA:    * 70
                         XXXXEXGN,XXXXDVAN,XXXXDVAC,XXXXDVAA,XXXXDVAD:
                         XXXXRAPT,XXXXCATD,XXXXREVA,XXXXREVR,XXXXSITE:    * 80
                         XXXXDATT,XXXXNMDS,XXXXCANR,XXXXCAND,XXXXATDS:
                         XXXXPRDS,XXXXCLDS,XXXXRFDS,XXXXCART,XXXXSERD:    * 90
                         XXXXNHCD
.
          ADD       ONE,TOTALREC
.
WRIT9999  RETURN
.
.*********************************************************************
.         print a new page
.*********************************************************************
HEAD0000  CALL      HEAD80
.
          UNPACK    STARTDAT,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,PRFRDATE         * formatted start date
.
          UNPACK    ENDDDATE,CCENT,CYEAR,CMON,CDAY
          CALL      PACDATE
          MOVE      CPCDATE,PRTODATE         * formatted start date

          PRINT     *20,"Date From : ",PRFRDATE," to ",PRTODATE
          PRINT     *20,"Hospital : ",PRNTHOSP
.
          IF        ADHOCEXT=1
            MOVE      "Yes",KEY3
          ELSE
            MOVE      "No ",KEY3
          ENDIF
.
          PRINT     *20,"Adhoc Extraction : ",KEY3
          PRINT     *20,"User Id : ",WEBUSRID
.
          CALL      UND80
.
HEAD9999  RETURN
.
.
.*********************************************************************
. Print totals                  
.*********************************************************************
TOTL0000  PRINT     *20,"Total Records Extracted : ",TOTALREC
.
          CALL      UND80
.
TOTL9999  RETURN
.
.**********************************************************************
.* Keyin Adhoc extraction yes or no                           
.**********************************************************************
KADH0000    MOVE       ZERO,ADHOCEXT
            MOVE       "N",ANS
.
            KEYIN      *P1:10,*EL,"Adhoc Extraction (Y/N) : ":
                       *P26:10,*V2LON,*RV,ANS;
            RESET      ANS
            REP        UPPLOW,ANS
.
            MATCH     "Y",ANS
            IF         @EQUAL
              MOVE       ONE,ADHOCEXT
              GOTO       KADH8000
            ENDIF
.
            MATCH     "N",ANS
            IF         @EQUAL
              MOVE       ZERO,ADHOCEXT
              GOTO       KADH8000
            ENDIF
.
            GOTO    KADH9100
.
KADH8000    MOVE    ZERO,EXIT
            GOTO    KADH9999
.
KADH9100    MOVE    ONE,EXIT
            GOTO    KADH9999
.
KADH9999    RETURN
.
.**********************************************************************
.* Keyin web user id                                          
.**********************************************************************
KUSR0000  MOVE      SP70,WEBUSRID
          KEYIN     *P1:17,*EF:
                    *P1:17,"Web User Id : ",*V2LON,WEBUSRID
.
          PACK      WEBUSRID,WEBUSRID,SP70
          MATCH     SP70,WEBUSRID 
          GOTO      KUSR9100 IF EQUAL   
.
          PACK      KEY10,WEBUSRID,SP70
          CALL      RDWBSE1            
          BRANCH    OVRCD,KUSR9100    
.
          MOVE      ZERO,EXIT
          GOTO      KUSR9999
.
KUSR9100  MOVE      ONE,EXIT
.
KUSR9999  RETURN
.
.**********************************************************************
.* Update extract run dates if not an adhoc extraction        
.**********************************************************************
EDAT0000  BRANCH     ADHOCEXT,EDAT9999
.
          MOVE       HOSPCODE,PMWAHOSP 
          MOVE       "IBAOUT50",PMWAPROG
          MOVE       STARTDAT,PMWASDAT
          MOVE       ENDDDATE,PMWAEDAT

          PACK      PMWACDAT,CCC,CYY,CMM,CDD
          REP       " 0",PMWACDAT
          CLOCK     TIME,PMWACTIM
          MOVE      WEBUSRID,PMWAWEBC
.
          PACK      PMWASPARR,SP70,SP70 
.
          PACK      KEY27,PMWAHOSP,PMWAPROG,PMWASDAT,PMWAEDAT,SP70 
          CALL      RAPMWAE1
          IF        OVRCD=1
            CALL      WRPMWAE1
          ENDIF
.
EDAT9999  RETURN
.
.==============================================================================
.
          INC       STD001IO
.
          INC       CLPATHSP
          INC       CLPMSCEX
          INC       DAYOFWEK
          INC       NAMSTRCD
          INC       PATDOCCD
          INC       PATHSPKY
          INC       PMSCEXCD
.
          INC       ALLREFIO/INC
          INC       ALLLNKIO/INC
          INC       OUTARTIO/INC
          INC       OUTBOAIO/INC
          INC       OUTBB1IO/INC
          INC       OUTCANIO/INC
          INC       OUTCLIIO/INC
          INC       OUTMA1IO/INC
          INC       PATMI1IO/INC
          INC       OUTRSHIO/INC
          INC       OUTSITIO/INC
          INC       PATCODIO/INC
          INC       PATHSPIO/INC
          INC       PATMA1IO/INC
          INC       PMSCEXIO/INC
          INC       PMSCCDIO/INC
          INC       PMSEXTIO/INC
          INC       PMSHCPIO/INC
          INC       PMSPX2IO/INC
          INC       PMSVX1IO/INC
          INC       PMSWAEIO/INC
          INC       WEBSECIO/INC
.
          INC       IBASEQIO/INC
          INC       WEBERRIO/INC
          INC       TFILENAM
.
